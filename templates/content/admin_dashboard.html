{% extends 'base.html' %}
{% load static %}

{% block title %}管理员仪表盘 - QAToolBox{% endblock %}

{% block content %}
<style>
/* 现代化管理员仪表盘样式 */
.admin-dashboard {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 20px 0;
}

.dashboard-header {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.dashboard-title {
    color: #2c3e50;
    font-weight: 700;
    margin-bottom: 10px;
    font-size: 2.5rem;
}

.dashboard-subtitle {
    color: #7f8c8d;
    font-size: 1.1rem;
    margin-bottom: 0;
}

.stats-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
    border: 1px solid rgba(255, 255, 255, 0.2);
    overflow: hidden;
    position: relative;
}

.stats-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #667eea, #764ba2);
}

.stats-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
}

.stats-icon {
    width: 60px;
    height: 60px;
    border-radius: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: white;
    margin-bottom: 15px;
    background: linear-gradient(135deg, #667eea, #764ba2);
}

.stats-number {
    font-size: 2.5rem;
    font-weight: 700;
    color: #2c3e50;
    margin-bottom: 5px;
    line-height: 1;
}

.stats-label {
    color: #7f8c8d;
    font-size: 1rem;
    font-weight: 500;
    margin-bottom: 15px;
}

.stats-footer {
    border-top: 1px solid #ecf0f1;
    padding-top: 15px;
    margin-top: 15px;
}

.stats-link {
    color: #667eea;
    text-decoration: none;
    font-weight: 500;
    transition: color 0.3s ease;
}

.stats-link:hover {
    color: #764ba2;
    text-decoration: none;
}

.quick-actions {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.action-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.action-card {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 15px;
    padding: 25px;
    text-align: center;
    transition: all 0.3s ease;
    border: 1px solid #dee2e6;
    text-decoration: none;
    color: inherit;
    position: relative;
    overflow: hidden;
}

.action-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    transition: left 0.5s ease;
}

.action-card:hover::before {
    left: 100%;
}

.action-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
    text-decoration: none;
    color: inherit;
}

.action-icon {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    margin: 0 auto 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
    color: white;
    background: linear-gradient(135deg, #667eea, #764ba2);
}

.action-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 8px;
}

.action-desc {
    color: #7f8c8d;
    font-size: 0.9rem;
}

.activity-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    height: 100%;
}

.card-header-modern {
    border-bottom: 2px solid #ecf0f1;
    padding-bottom: 15px;
    margin-bottom: 20px;
}

.card-title-modern {
    color: #2c3e50;
    font-weight: 600;
    font-size: 1.3rem;
    margin-bottom: 0;
}

.activity-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 0;
    border-bottom: 1px solid #f8f9fa;
    transition: background-color 0.3s ease;
}

.activity-item:last-child {
    border-bottom: none;
}

.activity-item:hover {
    background-color: rgba(102, 126, 234, 0.05);
    border-radius: 8px;
    padding-left: 10px;
    padding-right: 10px;
}

.activity-user {
    font-weight: 600;
    color: #2c3e50;
}

.activity-action {
    color: #7f8c8d;
    font-size: 0.9rem;
    margin-top: 2px;
}

.activity-time {
    color: #95a5a6;
    font-size: 0.85rem;
}

.stat-mini {
    text-align: center;
    padding: 15px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 10px;
    margin-bottom: 15px;
    transition: all 0.3s ease;
}

.stat-mini:hover {
    transform: scale(1.02);
}

.stat-mini-number {
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: 5px;
}

.stat-mini-label {
    color: #7f8c8d;
    font-size: 0.85rem;
}

.refresh-btn {
    background: linear-gradient(135deg, #667eea, #764ba2);
    border: none;
    color: white;
    padding: 10px 20px;
    border-radius: 25px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.refresh-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    color: white;
}

.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #7f8c8d;
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 15px;
    opacity: 0.5;
}

/* 动画效果 */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.stats-card {
    animation: fadeInUp 0.6s ease forwards;
}

.stats-card:nth-child(1) { animation-delay: 0.1s; }
.stats-card:nth-child(2) { animation-delay: 0.2s; }
.stats-card:nth-child(3) { animation-delay: 0.3s; }
.stats-card:nth-child(4) { animation-delay: 0.4s; }

/* 响应式设计 */
@media (max-width: 768px) {
    .dashboard-title {
        font-size: 2rem;
    }
    
    .action-grid {
        grid-template-columns: 1fr;
    }
    
    .stats-number {
        font-size: 2rem;
    }
    
    .dashboard-header {
        padding: 20px;
    }
    
    .quick-actions,
    .activity-card {
        padding: 20px;
    }
}
</style>

<div class="admin-dashboard">
    <div class="container-fluid">
        <!-- 仪表盘头部 -->
        <div class="dashboard-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="dashboard-title">
                        <i class="fas fa-tachometer-alt"></i>
                        管理员仪表盘
                    </h1>
                    <p class="dashboard-subtitle">
                        欢迎回来，{{ user.username }}！掌控全局，高效管理
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="d-flex justify-content-end gap-2 flex-wrap">
                        <a href="{% url 'admin_user_management' %}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-users"></i> 用户管理
                        </a>
                                                    <a href="{% url 'content:admin_announcements' %}" class="btn btn-outline-success btn-sm">
                            <i class="fas fa-bullhorn"></i> 公告管理
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- 统计卡片 -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="stats-card">
                    <div class="stats-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stats-number" id="totalUsers">{{ total_users }}</div>
                    <div class="stats-label">总用户数</div>
                    <div class="stats-footer">
                        <a href="{% url 'admin_user_management' %}" class="stats-link">
                            <i class="fas fa-arrow-right"></i> 管理用户
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="stats-card">
                    <div class="stats-icon">
                        <i class="fas fa-lightbulb"></i>
                    </div>
                    <div class="stats-number" id="pendingSuggestions">{{ pending_suggestions }}</div>
                    <div class="stats-label">待处理建议</div>
                    <div class="stats-footer">
                                                    <a href="{% url 'content:admin_suggestions' %}" class="stats-link">
                            <i class="fas fa-arrow-right"></i> 查看建议
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="stats-card">
                    <div class="stats-icon">
                        <i class="fas fa-comments"></i>
                    </div>
                    <div class="stats-number" id="pendingFeedbacks">{{ pending_feedbacks }}</div>
                    <div class="stats-label">待处理反馈</div>
                    <div class="stats-footer">
                                                    <a href="{% url 'content:admin_feedback' %}" class="stats-link">
                            <i class="fas fa-arrow-right"></i> 查看反馈
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="stats-card">
                    <div class="stats-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="stats-number" id="activeUsers">{{ active_users }}</div>
                    <div class="stats-label">今日活跃用户</div>
                    <div class="stats-footer">
                        <a href="{% url 'admin_user_monitoring' %}" class="stats-link">
                            <i class="fas fa-arrow-right"></i> 实时监控
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- 快速操作 -->
        <div class="quick-actions">
            <div class="card-header-modern">
                <h2 class="card-title-modern">
                    <i class="fas fa-bolt text-warning"></i> 快速操作
                </h2>
            </div>
            <div class="action-grid">
                <a href="{% url 'content:admin_suggestions' %}" class="action-card">
                    <div class="action-icon">
                        <i class="fas fa-lightbulb"></i>
                    </div>
                    <div class="action-title">建议管理</div>
                    <div class="action-desc">处理用户建议与反馈</div>
                </a>
                
                <a href="{% url 'content:admin_feedback' %}" class="action-card">
                    <div class="action-icon">
                        <i class="fas fa-comments"></i>
                    </div>
                    <div class="action-title">反馈管理</div>
                    <div class="action-desc">回复用户问题与意见</div>
                </a>
                
                <a href="{% url 'admin_user_management' %}" class="action-card">
                    <div class="action-icon">
                        <i class="fas fa-users-cog"></i>
                    </div>
                    <div class="action-title">用户管理</div>
                    <div class="action-desc">管理用户账户与权限</div>
                </a>
                
                <a href="{% url 'admin_user_monitoring' %}" class="action-card">
                    <div class="action-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="action-title">用户监控</div>
                    <div class="action-desc">实时监控用户活动</div>
                </a>
                
                <a href="{% url 'users:admin_user_logs' %}" class="action-card">
                    <div class="action-icon">
                        <i class="fas fa-history"></i>
                    </div>
                    <div class="action-title">操作日志</div>
                    <div class="action-desc">查看系统操作记录</div>
                </a>
                
                <a href="{% url 'content:admin_announcements' %}" class="action-card">
                    <div class="action-icon">
                        <i class="fas fa-bullhorn"></i>
                    </div>
                    <div class="action-title">公告管理</div>
                    <div class="action-desc">发布与管理系统公告</div>
                </a>
                
                <a href="/tools/food_photo_binding/" class="action-card">
                    <div class="action-icon">
                        <i class="fas fa-link"></i>
                    </div>
                    <div class="action-title">食物照片绑定</div>
                    <div class="action-desc">管理食物与照片的绑定关系</div>
                </a>
                
                <a href="/tools/food_image_correction/" class="action-card">
                    <div class="action-icon">
                        <i class="fas fa-camera-retro"></i>
                    </div>
                    <div class="action-title">食物图片矫正</div>
                    <div class="action-desc">优化和矫正食物图片质量</div>
                </a>
                
                <a href="{% url 'content:admin_feature_management' %}" class="action-card">
                    <div class="action-icon">
                        <i class="fas fa-cogs"></i>
                    </div>
                    <div class="action-title">功能入口管理</div>
                    <div class="action-desc">控制用户可见的功能模块</div>
                </a>
            </div>
        </div>

        <!-- 最近活动和系统状态 -->
        <div class="row">
            <div class="col-lg-8 mb-4">
                <div class="activity-card">
                    <div class="card-header-modern">
                        <h3 class="card-title-modern">
                            <i class="fas fa-clock text-info"></i> 最近活动
                        </h3>
                    </div>
                    <div id="recentActivities">
                        {% for log in recent_logs %}
                        <div class="activity-item">
                            <div>
                                <div class="activity-user">{{ log.admin_user.username }}</div>
                                <div class="activity-action">{{ log.action }}</div>
                            </div>
                            <div class="activity-time">{{ log.created_at|date:"m-d H:i" }}</div>
                        </div>
                        {% empty %}
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <p>暂无最近活动</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4 mb-4">
                <div class="activity-card">
                    <div class="card-header-modern">
                        <h3 class="card-title-modern">
                            <i class="fas fa-chart-pie text-success"></i> 系统概览
                        </h3>
                    </div>
                    <div class="stat-mini">
                        <div class="stat-mini-number text-primary">{{ total_users }}</div>
                        <div class="stat-mini-label">注册用户</div>
                    </div>
                    <div class="stat-mini">
                        <div class="stat-mini-number text-success">{{ active_users }}</div>
                        <div class="stat-mini-label">活跃用户</div>
                    </div>
                    <div class="stat-mini">
                        <div class="stat-mini-number text-warning">{{ pending_suggestions }}</div>
                        <div class="stat-mini-label">待处理建议</div>
                    </div>
                    <div class="stat-mini">
                        <div class="stat-mini-number text-info">{{ pending_feedbacks }}</div>
                        <div class="stat-mini-label">待处理反馈</div>
                    </div>
                    <div class="text-center mt-3">
                        <button class="refresh-btn" onclick="refreshDashboard()">
                            <i class="fas fa-sync-alt"></i> 刷新数据
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 实时通知 -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1050;">
    <div id="notificationToast" class="toast" role="alert">
        <div class="toast-header">
            <i class="fas fa-bell text-primary"></i>
            <strong class="me-auto ms-2">系统通知</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="notificationMessage">
        </div>
    </div>
</div>

<script>
// 页面加载完成后启动实时更新
document.addEventListener('DOMContentLoaded', function() {
    startDashboardUpdates();
    initializeAnimations();
});

// 初始化动画效果
function initializeAnimations() {
    // 为统计卡片添加计数动画
    animateNumbers();
}

// 数字动画效果
function animateNumbers() {
    const numbers = document.querySelectorAll('.stats-number');
    numbers.forEach(number => {
        const target = parseInt(number.textContent);
        let current = 0;
        const increment = target / 30;
        const timer = setInterval(() => {
            current += increment;
            if (current >= target) {
                current = target;
                clearInterval(timer);
            }
            number.textContent = Math.floor(current);
        }, 50);
    });
}

// 启动仪表板更新
function startDashboardUpdates() {
    // 每60秒自动刷新一次数据
    setInterval(refreshDashboard, 60000);
}

// 刷新仪表板数据
function refreshDashboard() {
    const refreshBtn = document.querySelector('.refresh-btn');
    const originalContent = refreshBtn.innerHTML;
    
    // 显示加载状态
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 刷新中...';
    refreshBtn.disabled = true;
    
    fetch('/content/api/admin/dashboard-stats/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateDashboardStats(data.stats);
                showNotification('数据已更新', 'success');
            }
        })
        .catch(error => {
            console.error('刷新数据失败:', error);
            showNotification('数据刷新失败', 'error');
        })
        .finally(() => {
            // 恢复按钮状态
            refreshBtn.innerHTML = originalContent;
            refreshBtn.disabled = false;
        });
}

// 更新仪表板统计
function updateDashboardStats(stats) {
    // 更新数字时带动画效果
    updateNumberWithAnimation('totalUsers', stats.total_users);
    updateNumberWithAnimation('pendingSuggestions', stats.pending_suggestions);
    updateNumberWithAnimation('pendingFeedbacks', stats.pending_feedbacks);
    updateNumberWithAnimation('activeUsers', stats.active_users);
    
    // 更新迷你统计
    document.querySelectorAll('.stat-mini-number')[0].textContent = stats.total_users;
    document.querySelectorAll('.stat-mini-number')[1].textContent = stats.active_users;
    document.querySelectorAll('.stat-mini-number')[2].textContent = stats.pending_suggestions;
    document.querySelectorAll('.stat-mini-number')[3].textContent = stats.pending_feedbacks;
    
    // 更新最近活动
    if (stats.recent_logs) {
        updateRecentActivities(stats.recent_logs);
    }
}

// 带动画的数字更新
function updateNumberWithAnimation(elementId, newValue) {
    const element = document.getElementById(elementId);
    const currentValue = parseInt(element.textContent);
    
    if (currentValue !== newValue) {
        let current = currentValue;
        const increment = (newValue - currentValue) / 20;
        const timer = setInterval(() => {
            current += increment;
            if ((increment > 0 && current >= newValue) || (increment < 0 && current <= newValue)) {
                current = newValue;
                clearInterval(timer);
            }
            element.textContent = Math.floor(current);
        }, 50);
    }
}

// 更新最近活动
function updateRecentActivities(logs) {
    const container = document.getElementById('recentActivities');
    if (!logs || logs.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <p>暂无最近活动</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    logs.forEach(log => {
        html += `
            <div class="activity-item">
                <div>
                    <div class="activity-user">${log.admin_user}</div>
                    <div class="activity-action">${log.action}</div>
                </div>
                <div class="activity-time">${log.created_at}</div>
            </div>
        `;
    });
    container.innerHTML = html;
}

// 显示通知
function showNotification(message, type = 'info') {
    const toast = document.getElementById('notificationToast');
    const messageElement = document.getElementById('notificationMessage');
    
    messageElement.textContent = message;
    
    // 设置通知类型样式
    toast.className = `toast ${type === 'success' ? 'bg-success text-white' : type === 'error' ? 'bg-danger text-white' : 'bg-info text-white'}`;
    
    // 显示通知
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
}

// 添加键盘快捷键
document.addEventListener('keydown', function(e) {
    // Ctrl+R 刷新仪表板
    if (e.ctrlKey && e.key === 'r') {
        e.preventDefault();
        refreshDashboard();
    }
    
    // Ctrl+1-6 快速导航
    if (e.ctrlKey && e.key >= '1' && e.key <= '6') {
        e.preventDefault();
        const links = document.querySelectorAll('.action-card');
        const index = parseInt(e.key) - 1;
        if (links[index]) {
            links[index].click();
        }
    }
});
</script>
{% endblock %}