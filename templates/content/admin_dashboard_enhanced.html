{% extends 'base.html' %}
{% load static %}

{% block title %}管理员仪表盘 - QAToolBox{% endblock %}

{% block content %}
<style>
/* 现代化仪表盘样式 */
.admin-dashboard {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 20px 0;
}

.dashboard-header {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
}

.dashboard-title {
    color: #2c3e50;
    font-weight: 700;
    margin-bottom: 10px;
}

.dashboard-subtitle {
    color: #7f8c8d;
    font-size: 1.1rem;
}

.stats-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
    border: none;
}

.stats-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
}

.stats-icon {
    width: 60px;
    height: 60px;
    border-radius: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: white;
    margin-bottom: 15px;
}

.stats-number {
    font-size: 2.5rem;
    font-weight: 700;
    color: #2c3e50;
    margin-bottom: 5px;
}

.stats-label {
    color: #7f8c8d;
    font-size: 1rem;
    font-weight: 500;
}

.stats-change {
    font-size: 0.9rem;
    margin-top: 10px;
}

.stats-change.positive {
    color: #27ae60;
}

.stats-change.negative {
    color: #e74c3c;
}

.quick-actions {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
}

.action-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.action-card {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 15px;
    padding: 25px;
    text-align: center;
    transition: all 0.3s ease;
    border: 2px solid transparent;
    cursor: pointer;
}

.action-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    border-color: #667eea;
}

.action-icon {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    color: white;
    margin: 0 auto 15px;
}

.action-title {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 8px;
}

.action-desc {
    color: #7f8c8d;
    font-size: 0.9rem;
    line-height: 1.4;
}

.recent-activity {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
}

.activity-item {
    display: flex;
    align-items: center;
    padding: 15px 0;
    border-bottom: 1px solid #f1f3f4;
    transition: background-color 0.2s ease;
}

.activity-item:hover {
    background-color: #f8f9fa;
    border-radius: 10px;
    padding-left: 15px;
    padding-right: 15px;
}

.activity-icon {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    color: white;
    margin-right: 15px;
    flex-shrink: 0;
}

.activity-content {
    flex: 1;
}

.activity-title {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 5px;
}

.activity-time {
    color: #7f8c8d;
    font-size: 0.85rem;
}

.status-badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
}

.status-pending { background: #fff3cd; color: #856404; }
.status-processing { background: #d1ecf1; color: #0c5460; }
.status-resolved { background: #d4edda; color: #155724; }
.status-closed { background: #f8d7da; color: #721c24; }

/* 响应式设计 */
@media (max-width: 768px) {
    .dashboard-header {
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .stats-card {
        padding: 20px;
        margin-bottom: 15px;
    }
    
    .action-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .quick-actions {
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .recent-activity {
        padding: 20px;
    }
}

/* 动画效果 */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.stats-card, .action-card {
    animation: fadeInUp 0.6s ease forwards;
}

.stats-card:nth-child(1) { animation-delay: 0.1s; }
.stats-card:nth-child(2) { animation-delay: 0.2s; }
.stats-card:nth-child(3) { animation-delay: 0.3s; }
.stats-card:nth-child(4) { animation-delay: 0.4s; }
</style>

<div class="admin-dashboard">
    <div class="container-fluid">
        <!-- 仪表盘头部 -->
        <div class="dashboard-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="dashboard-title">
                        <i class="fas fa-tachometer-alt text-primary"></i>
                        管理员仪表盘
                    </h1>
                    <p class="dashboard-subtitle">
                        欢迎回来，{{ user.username }}！这里是您的管理控制中心
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="d-flex justify-content-end gap-2">
                        <a href="{% url 'admin_user_management' %}" class="btn btn-outline-primary">
                            <i class="fas fa-users"></i> 用户管理
                        </a>
                        <a href="{% url 'content:admin_suggestions' %}" class="btn btn-outline-warning">
                            <i class="fas fa-lightbulb"></i> 建议管理
                        </a>
                        <a href="{% url 'content:admin_feedback' %}" class="btn btn-outline-info">
                            <i class="fas fa-comments"></i> 反馈管理
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- 统计卡片 -->
        <div class="row">
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <div class="stats-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stats-number" id="totalUsers">{{ total_users|default:"0" }}</div>
                    <div class="stats-label">总用户数</div>
                    <div class="stats-change positive">
                        <i class="fas fa-arrow-up"></i> +12% 本月
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <div class="stats-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <i class="fas fa-lightbulb"></i>
                    </div>
                    <div class="stats-number" id="totalSuggestions">{{ total_suggestions|default:"0" }}</div>
                    <div class="stats-label">待处理建议</div>
                    <div class="stats-change negative">
                        <i class="fas fa-arrow-down"></i> -5% 本周
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <div class="stats-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <i class="fas fa-comments"></i>
                    </div>
                    <div class="stats-number" id="totalFeedbacks">{{ total_feedbacks|default:"0" }}</div>
                    <div class="stats-label">待处理反馈</div>
                    <div class="stats-change positive">
                        <i class="fas fa-arrow-up"></i> +8% 本周
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <div class="stats-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="stats-number" id="activeUsers">{{ active_users|default:"0" }}</div>
                    <div class="stats-label">活跃用户</div>
                    <div class="stats-change positive">
                        <i class="fas fa-arrow-up"></i> +15% 今日
                    </div>
                </div>
            </div>
        </div>

        <!-- 快速操作 -->
        <div class="quick-actions">
            <h3 class="mb-4">
                <i class="fas fa-bolt text-warning"></i>
                快速操作
            </h3>
            <div class="action-grid">
                <div class="action-card" onclick="window.location.href='{% url 'users:admin_user_management' %}'">
                    <div class="action-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <i class="fas fa-user-cog"></i>
                    </div>
                    <div class="action-title">用户管理</div>
                    <div class="action-desc">管理用户账户、权限和状态</div>
                </div>
                
                <div class="action-card" onclick="window.location.href='{% url 'content:admin_suggestions' %}'">
                    <div class="action-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <i class="fas fa-lightbulb"></i>
                    </div>
                    <div class="action-title">建议管理</div>
                    <div class="action-desc">查看和处理用户建议</div>
                </div>
                
                <div class="action-card" onclick="window.location.href='{% url 'content:admin_feedback' %}'">
                    <div class="action-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <i class="fas fa-comments"></i>
                    </div>
                    <div class="action-title">反馈管理</div>
                    <div class="action-desc">处理用户反馈和问题</div>
                </div>
                
                <div class="action-card" onclick="window.location.href='{% url 'content:admin_announcements' %}'">
                    <div class="action-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <i class="fas fa-bullhorn"></i>
                    </div>
                    <div class="action-title">公告管理</div>
                    <div class="action-desc">发布和管理系统公告</div>
                </div>
                
                <div class="action-card" onclick="window.location.href='/tools/food_photo_binding/'">
                    <div class="action-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                        <i class="fas fa-link"></i>
                    </div>
                    <div class="action-title">食物照片绑定</div>
                    <div class="action-desc">管理食物与照片的绑定关系</div>
                </div>
                
                <div class="action-card" onclick="window.location.href='/tools/food_image_correction/'">
                    <div class="action-icon" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                        <i class="fas fa-camera-retro"></i>
                    </div>
                    <div class="action-title">食物图片矫正</div>
                    <div class="action-desc">优化和矫正食物图片质量</div>
                </div>
                
                <div class="action-card" onclick="window.location.href='{% url 'users:admin_user_logs' %}'">
                    <div class="action-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                        <i class="fas fa-history"></i>
                    </div>
                    <div class="action-title">操作日志</div>
                    <div class="action-desc">查看用户操作记录</div>
                </div>
                
                <div class="action-card" onclick="window.location.href='{% url 'admin_user_detail' user_id=1 %}'">
                    <div class="action-icon" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <div class="action-title">数据统计</div>
                    <div class="action-desc">查看详细的数据分析</div>
                </div>
            </div>
        </div>

        <!-- 最近活动 -->
        <div class="recent-activity">
            <h3 class="mb-4">
                <i class="fas fa-clock text-info"></i>
                最近活动
            </h3>
            <div id="recentActivities">
                <!-- 动态加载最近活动 -->
                <div class="activity-item">
                    <div class="activity-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <i class="fas fa-user-plus"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-title">新用户注册</div>
                        <div class="activity-time">2分钟前</div>
                    </div>
                    <span class="status-badge status-pending">新</span>
                </div>
                
                <div class="activity-item">
                    <div class="activity-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <i class="fas fa-lightbulb"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-title">新建议提交</div>
                        <div class="activity-time">5分钟前</div>
                    </div>
                    <span class="status-badge status-processing">处理中</span>
                </div>
                
                <div class="activity-item">
                    <div class="activity-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <i class="fas fa-comments"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-title">用户反馈</div>
                        <div class="activity-time">10分钟前</div>
                    </div>
                    <span class="status-badge status-pending">待处理</span>
                </div>
                
                <div class="activity-item">
                    <div class="activity-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-title">问题已解决</div>
                        <div class="activity-time">15分钟前</div>
                    </div>
                    <span class="status-badge status-resolved">已解决</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardStats();
    loadRecentActivities();
    
    // 每30秒自动刷新数据
    setInterval(function() {
        loadDashboardStats();
        loadRecentActivities();
    }, 30000);
});

// 加载仪表盘统计数据
function loadDashboardStats() {
    fetch('/content/api/admin/dashboard-stats/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateStats(data.stats);
            }
        })
        .catch(error => {
            console.error('加载统计数据失败:', error);
        });
}

// 更新统计数据
function updateStats(stats) {
    if (stats.total_users !== undefined) {
        document.getElementById('totalUsers').textContent = stats.total_users;
    }
    if (stats.total_suggestions !== undefined) {
        document.getElementById('totalSuggestions').textContent = stats.total_suggestions;
    }
    if (stats.total_feedbacks !== undefined) {
        document.getElementById('totalFeedbacks').textContent = stats.total_feedbacks;
    }
    if (stats.active_users !== undefined) {
        document.getElementById('activeUsers').textContent = stats.active_users;
    }
}

// 加载最近活动
function loadRecentActivities() {
    fetch('/content/api/admin/recent-activities/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateRecentActivities(data.activities);
            }
        })
        .catch(error => {
            console.error('加载最近活动失败:', error);
        });
}

// 更新最近活动
function updateRecentActivities(activities) {
    const container = document.getElementById('recentActivities');
    if (!container || !activities) return;
    
    container.innerHTML = '';
    
    activities.forEach(activity => {
        const activityHtml = `
            <div class="activity-item">
                <div class="activity-icon" style="background: linear-gradient(135deg, ${activity.icon_color || '#667eea'} 0%, ${activity.icon_color_secondary || '#764ba2'} 100%);">
                    <i class="fas ${activity.icon}"></i>
                </div>
                <div class="activity-content">
                    <div class="activity-title">${activity.title}</div>
                    <div class="activity-time">${activity.time}</div>
                </div>
                <span class="status-badge status-${activity.status}">${activity.status_text}</span>
            </div>
        `;
        container.innerHTML += activityHtml;
    });
}

// 添加点击效果
document.querySelectorAll('.action-card').forEach(card => {
    card.addEventListener('click', function() {
        this.style.transform = 'scale(0.95)';
        setTimeout(() => {
            this.style.transform = '';
        }, 150);
    });
});
</script>
{% endblock %} 