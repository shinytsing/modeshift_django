{% extends 'base.html' %}
{% load static %}

{% block title %}å…¬å‘Šç®¡ç† - QAToolBox{% endblock %}

{% block content %}
<style>
/* ä¿®å¤è’™å±‚é—®é¢˜ - å®Œå…¨è§£å†³é»‘è‰²é®ç½©è¦†ç›–é—®é¢˜ */
.modal-backdrop {
    z-index: 1040 !important;
    pointer-events: none !important; /* å…è®¸ç‚¹å‡»ç©¿é€åˆ°ä¸‹å±‚ */
}

.modal-backdrop.show {
    opacity: 0.5 !important;
    pointer-events: none !important; /* é˜²æ­¢é®ç½©é˜»æ­¢ç‚¹å‡» */
}

.modal {
    z-index: 1050 !important;
    pointer-events: auto !important; /* ç¡®ä¿æ¨¡æ€æ¡†æœ¬èº«å¯ä»¥ç‚¹å‡» */
}

.modal-dialog {
    margin: 1.75rem auto !important;
    max-height: calc(100vh - 3.5rem) !important;
    overflow-y: auto !important;
    pointer-events: auto !important; /* ç¡®ä¿å¯¹è¯æ¡†å¯ä»¥ç‚¹å‡» */
}

.modal-content {
    max-height: calc(100vh - 3.5rem) !important;
    overflow-y: auto !important;
    pointer-events: auto !important; /* ç¡®ä¿å†…å®¹åŒºåŸŸå¯ä»¥ç‚¹å‡» */
    position: relative !important;
    z-index: 1051 !important; /* ç¡®ä¿åœ¨é®ç½©ä¹‹ä¸Š */
}

/* ç¡®ä¿æ‰€æœ‰äº¤äº’å…ƒç´ éƒ½å¯ä»¥ç‚¹å‡» */
button, a, input, select, textarea {
    position: relative !important;
    z-index: 3 !important;
    pointer-events: auto !important;
}

/* ç°ä»£åŒ–å…¬å‘Šç®¡ç†ç•Œé¢æ ·å¼ */
.announcement-management {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 20px 0;
    position: relative !important;
    z-index: 1 !important;
}

.management-header {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
}

.management-title {
    color: #2c3e50;
    font-weight: 700;
    margin-bottom: 10px;
}

.management-subtitle {
    color: #7f8c8d;
    font-size: 1.1rem;
}

.announcement-controls {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
}

.control-group {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    align-items: center;
}

.search-box {
    flex: 1;
    min-width: 250px;
    position: relative;
}

.search-input {
    width: 100%;
    padding: 12px 20px 12px 45px;
    border: 2px solid #e9ecef;
    border-radius: 25px;
    font-size: 1rem;
    transition: all 0.3s ease;
    background: white;
}

.search-input:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    outline: none;
}

.search-icon {
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: #7f8c8d;
}

.filter-group {
    display: flex;
    gap: 10px;
    align-items: center;
}

.filter-select {
    padding: 10px 15px;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    background: white;
    font-size: 0.95rem;
    transition: border-color 0.3s ease;
}

.filter-select:focus {
    border-color: #667eea;
    outline: none;
}

.btn-modern {
    padding: 12px 24px;
    border-radius: 12px;
    font-weight: 600;
    transition: all 0.3s ease;
    border: none;
    position: relative;
    overflow: hidden;
}

.btn-modern::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
}

.btn-modern:hover::before {
    left: 100%;
}

.btn-primary-modern {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.btn-success-modern {
    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    color: white;
}

.btn-warning-modern {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
}

.btn-danger-modern {
    background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
    color: #e74c3c;
}

.announcements-grid {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
}

.announcement-card {
    background: white;
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
    border-left: 4px solid transparent;
}

.announcement-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
}

.announcement-card.active {
    border-left-color: #43e97b;
}

.announcement-card.inactive {
    border-left-color: #e74c3c;
    opacity: 0.7;
}

.announcement-header {
    display: flex;
    justify-content: between;
    align-items: flex-start;
    margin-bottom: 15px;
    gap: 15px;
}

.announcement-title {
    flex: 1;
    font-size: 1.25rem;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 5px;
}

.announcement-meta {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
}

.meta-badge {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 500;
}

.status-active {
    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    color: white;
}

.status-inactive {
    background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
    color: #e74c3c;
}

.priority-high {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
}

.priority-normal {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
}

.priority-low {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.announcement-content {
    color: #7f8c8d;
    line-height: 1.6;
    margin-bottom: 20px;
}

.announcement-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    flex-wrap: wrap;
}

.action-btn {
    padding: 8px 16px;
    border-radius: 8px;
    border: none;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 5px;
}

.action-btn:hover {
    transform: translateY(-2px);
}

.btn-edit {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
}

.btn-delete {
    background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
    color: #e74c3c;
}

.btn-toggle {
    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    color: white;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #7f8c8d;
}

.empty-icon {
    font-size: 4rem;
    margin-bottom: 20px;
    opacity: 0.5;
}

.modal-modern .modal-content {
    border: none;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.modal-modern .modal-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 20px 20px 0 0;
    padding: 25px 30px;
}

.modal-modern .modal-body {
    padding: 30px;
}

.form-group-modern {
    margin-bottom: 25px;
}

.form-label-modern {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #2c3e50;
}

.form-input-modern {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    font-size: 1rem;
    transition: all 0.3s ease;
}

.form-input-modern:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    outline: none;
}

.form-textarea-modern {
    resize: vertical;
    min-height: 120px;
}

.loading-spinner {
    display: none;
    text-align: center;
    padding: 40px;
}

.spinner {
    display: inline-block;
    width: 40px;
    height: 40px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .management-header {
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .control-group {
        flex-direction: column;
        align-items: stretch;
    }
    
    .search-box {
        min-width: auto;
    }
    
    .filter-group {
        justify-content: center;
    }
    
    .announcement-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .announcement-actions {
        justify-content: center;
    }
    
    .modal-modern .modal-header,
    .modal-modern .modal-body {
        padding: 20px;
    }
}

/* åŠ¨ç”»æ•ˆæœ */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.announcement-card {
    animation: fadeInUp 0.6s ease forwards;
}

.fade-in {
    opacity: 0;
    animation: fadeInUp 0.6s ease forwards;
}

.fade-in:nth-child(1) { animation-delay: 0.1s; }
.fade-in:nth-child(2) { animation-delay: 0.2s; }
.fade-in:nth-child(3) { animation-delay: 0.3s; }
.fade-in:nth-child(4) { animation-delay: 0.4s; }
</style>

<div class="announcement-management">
    <div class="container-fluid">
        <!-- ç®¡ç†å¤´éƒ¨ -->
        <div class="management-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="management-title">
                        <i class="fas fa-bullhorn text-primary"></i>
                        å…¬å‘Šç®¡ç†ç³»ç»Ÿ
                    </h1>
                    <p class="management-subtitle">
                        åˆ›å»ºã€ç¼–è¾‘å’Œç®¡ç†ç³»ç»Ÿå…¬å‘Šï¼Œç¡®ä¿é‡è¦ä¿¡æ¯åŠæ—¶ä¼ è¾¾ç»™ç”¨æˆ·
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <button type="button" class="btn btn-modern btn-primary-modern" data-bs-toggle="modal" data-bs-target="#addAnnouncementModal">
                        <i class="fas fa-plus"></i> åˆ›å»ºæ–°å…¬å‘Š
                    </button>
                </div>
            </div>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="announcement-controls">
            <div class="control-group">
                <div class="search-box">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢å…¬å‘Šæ ‡é¢˜æˆ–å†…å®¹...">
                </div>
                <div class="filter-group">
                    <select class="filter-select" id="statusFilter">
                        <option value="">å…¨éƒ¨çŠ¶æ€</option>
                        <option value="active">æ¿€æ´»</option>
                        <option value="inactive">éæ¿€æ´»</option>
                    </select>
                    <select class="filter-select" id="priorityFilter">
                        <option value="">å…¨éƒ¨ä¼˜å…ˆçº§</option>
                        <option value="high">é«˜</option>
                        <option value="normal">æ™®é€š</option>
                        <option value="low">ä½</option>
                    </select>
                    <button class="btn btn-modern btn-success-modern" onclick="refreshAnnouncements()">
                        <i class="fas fa-sync-alt"></i> åˆ·æ–°
                    </button>
                </div>
            </div>
        </div>

        <!-- å…¬å‘Šç½‘æ ¼ -->
        <div class="announcements-grid">
            <div class="loading-spinner" id="loadingSpinner">
                <div class="spinner"></div>
                <p class="mt-3">åŠ è½½ä¸­...</p>
            </div>
            <div id="announcementsContainer">
                <!-- å…¬å‘Šåˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
            </div>
        </div>
    </div>
</div>

<!-- æ·»åŠ å…¬å‘Šæ¨¡æ€æ¡† -->
<div class="modal fade modal-modern" id="addAnnouncementModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus-circle"></i>
                    åˆ›å»ºæ–°å…¬å‘Š
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addAnnouncementForm">
                    <div class="form-group-modern">
                        <label for="title" class="form-label-modern">
                            <i class="fas fa-heading"></i> å…¬å‘Šæ ‡é¢˜
                        </label>
                        <input type="text" class="form-input-modern" id="title" name="title" placeholder="è¯·è¾“å…¥å…¬å‘Šæ ‡é¢˜..." required>
                    </div>
                    <div class="form-group-modern">
                        <label for="content" class="form-label-modern">
                            <i class="fas fa-align-left"></i> å…¬å‘Šå†…å®¹
                        </label>
                        <textarea class="form-input-modern form-textarea-modern" id="content" name="content" placeholder="è¯·è¾“å…¥å…¬å‘Šå†…å®¹..." required></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group-modern">
                                <label for="status" class="form-label-modern">
                                    <i class="fas fa-toggle-on"></i> çŠ¶æ€
                                </label>
                                <select class="form-input-modern" id="status" name="status">
                                    <option value="active">âœ… æ¿€æ´»</option>
                                    <option value="inactive">âŒ éæ¿€æ´»</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group-modern">
                                <label for="priority" class="form-label-modern">
                                    <i class="fas fa-flag"></i> ä¼˜å…ˆçº§
                                </label>
                                <select class="form-input-modern" id="priority" name="priority">
                                    <option value="normal">ğŸ”µ æ™®é€š</option>
                                    <option value="high">ğŸ”´ é«˜</option>
                                    <option value="low">âšª ä½</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group-modern">
                                <label for="startTime" class="form-label-modern">
                                    <i class="fas fa-calendar-alt"></i> å¼€å§‹æ—¶é—´
                                </label>
                                <input type="datetime-local" class="form-input-modern" id="startTime" name="start_time">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group-modern">
                                <label for="endTime" class="form-label-modern">
                                    <i class="fas fa-calendar-times"></i> ç»“æŸæ—¶é—´
                                </label>
                                <input type="datetime-local" class="form-input-modern" id="endTime" name="end_time">
                            </div>
                        </div>
                    </div>
                    <div class="form-group-modern">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="isPopup" name="is_popup">
                            <label for="isPopup" class="form-check-label">
                                <i class="fas fa-window-restore"></i> æ˜¾ç¤ºä¸ºå¼¹çª—
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-modern btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> å–æ¶ˆ
                </button>
                <button type="button" class="btn btn-modern btn-primary-modern" onclick="addAnnouncement()">
                    <i class="fas fa-save"></i> ä¿å­˜å…¬å‘Š
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ç¼–è¾‘å…¬å‘Šæ¨¡æ€æ¡† -->
<div class="modal fade modal-modern" id="editAnnouncementModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit"></i>
                    ç¼–è¾‘å…¬å‘Š
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editAnnouncementForm">
                    <input type="hidden" id="editId" name="id">
                    <div class="form-group-modern">
                        <label for="editTitle" class="form-label-modern">
                            <i class="fas fa-heading"></i> å…¬å‘Šæ ‡é¢˜
                        </label>
                        <input type="text" class="form-input-modern" id="editTitle" name="title" required>
                    </div>
                    <div class="form-group-modern">
                        <label for="editContent" class="form-label-modern">
                            <i class="fas fa-align-left"></i> å…¬å‘Šå†…å®¹
                        </label>
                        <textarea class="form-input-modern form-textarea-modern" id="editContent" name="content" required></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group-modern">
                                <label for="editStatus" class="form-label-modern">
                                    <i class="fas fa-toggle-on"></i> çŠ¶æ€
                                </label>
                                <select class="form-input-modern" id="editStatus" name="status">
                                    <option value="active">âœ… æ¿€æ´»</option>
                                    <option value="inactive">âŒ éæ¿€æ´»</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group-modern">
                                <label for="editPriority" class="form-label-modern">
                                    <i class="fas fa-flag"></i> ä¼˜å…ˆçº§
                                </label>
                                <select class="form-input-modern" id="editPriority" name="priority">
                                    <option value="normal">ğŸ”µ æ™®é€š</option>
                                    <option value="high">ğŸ”´ é«˜</option>
                                    <option value="low">âšª ä½</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group-modern">
                                <label for="editStartTime" class="form-label-modern">
                                    <i class="fas fa-calendar-alt"></i> å¼€å§‹æ—¶é—´
                                </label>
                                <input type="datetime-local" class="form-input-modern" id="editStartTime" name="start_time">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group-modern">
                                <label for="editEndTime" class="form-label-modern">
                                    <i class="fas fa-calendar-times"></i> ç»“æŸæ—¶é—´
                                </label>
                                <input type="datetime-local" class="form-input-modern" id="editEndTime" name="end_time">
                            </div>
                        </div>
                    </div>
                    <div class="form-group-modern">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="editIsPopup" name="is_popup">
                            <label for="editIsPopup" class="form-check-label">
                                <i class="fas fa-window-restore"></i> æ˜¾ç¤ºä¸ºå¼¹çª—
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-modern btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> å–æ¶ˆ
                </button>
                <button type="button" class="btn btn-modern btn-primary-modern" onclick="updateAnnouncement()">
                    <i class="fas fa-save"></i> æ›´æ–°å…¬å‘Š
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// å…¨å±€å˜é‡
let allAnnouncements = [];
let filteredAnnouncements = [];

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    initializeEventListeners();
    loadAnnouncements();
    
    // æ·»åŠ æœç´¢å’Œè¿‡æ»¤åŠŸèƒ½
    document.getElementById('searchInput').addEventListener('input', filterAnnouncements);
    document.getElementById('statusFilter').addEventListener('change', filterAnnouncements);
    document.getElementById('priorityFilter').addEventListener('change', filterAnnouncements);
});

// åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
function initializeEventListeners() {
    // æ¨¡æ€æ¡†äº‹ä»¶
    const addModal = document.getElementById('addAnnouncementModal');
    const editModal = document.getElementById('editAnnouncementModal');
    
    // é‡ç½®è¡¨å•å½“æ¨¡æ€æ¡†å…³é—­æ—¶
    if (addModal) {
        addModal.addEventListener('hidden.bs.modal', function() {
            document.getElementById('addAnnouncementForm').reset();
        });
    }
    
    // æ·»åŠ æŒ‰é’®åŠ¨ç”»æ•ˆæœ
    document.querySelectorAll('.btn-modern').forEach(btn => {
        btn.addEventListener('click', function() {
            this.style.transform = 'scale(0.95)';
            setTimeout(() => {
                this.style.transform = '';
            }, 150);
        });
    });
}

// åŠ è½½å…¬å‘Šåˆ—è¡¨
function loadAnnouncements() {
    showLoading(true);
    
    fetch('/content/api/admin/announcements/')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                allAnnouncements = data.announcements || [];
                filteredAnnouncements = [...allAnnouncements];
                displayAnnouncements(filteredAnnouncements);
                showMessage('å…¬å‘ŠåŠ è½½æˆåŠŸ', 'success');
            } else {
                showMessage('åŠ è½½å…¬å‘Šå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                displayEmptyState();
            }
        })
        .catch(error => {
            console.error('è¯·æ±‚å¤±è´¥:', error);
            showMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥', 'error');
            displayEmptyState();
        })
        .finally(() => {
            showLoading(false);
        });
}

// æ˜¾ç¤ºå…¬å‘Šåˆ—è¡¨ï¼ˆå¡ç‰‡å¼å¸ƒå±€ï¼‰
function displayAnnouncements(announcements) {
    const container = document.getElementById('announcementsContainer');
    
    if (!announcements || announcements.length === 0) {
        displayEmptyState();
        return;
    }
    
    container.innerHTML = '';
    
    announcements.forEach((announcement, index) => {
        const card = createAnnouncementCard(announcement, index);
        container.appendChild(card);
    });
    
    // æ·»åŠ æ¸å…¥åŠ¨ç”»
    setTimeout(() => {
        document.querySelectorAll('.announcement-card').forEach((card, index) => {
            card.style.animationDelay = `${index * 0.1}s`;
            card.classList.add('fade-in');
        });
    }, 100);
}

// åˆ›å»ºå…¬å‘Šå¡ç‰‡
function createAnnouncementCard(announcement, index) {
    const card = document.createElement('div');
    card.className = `announcement-card ${announcement.status === 'active' ? 'active' : 'inactive'}`;
    
    const statusIcon = announcement.status === 'active' ? 'âœ…' : 'âŒ';
    const priorityIcon = getPriorityIcon(announcement.priority);
    const priorityClass = `priority-${announcement.priority || 'normal'}`;
    
    card.innerHTML = `
        <div class="announcement-header">
            <div class="announcement-title">${escapeHtml(announcement.title || 'æœªå‘½åå…¬å‘Š')}</div>
            <div class="announcement-meta">
                <span class="meta-badge status-${announcement.status}">${statusIcon} ${announcement.status === 'active' ? 'æ¿€æ´»' : 'éæ¿€æ´»'}</span>
                <span class="meta-badge ${priorityClass}">${priorityIcon} ${getPriorityText(announcement.priority)}</span>
                ${announcement.is_popup ? '<span class="meta-badge" style="background: #f093fb; color: white;">ğŸªŸ å¼¹çª—</span>' : ''}
            </div>
        </div>
        <div class="announcement-content">
            ${escapeHtml(announcement.content ? announcement.content.substring(0, 200) : 'æ— å†…å®¹')}
            ${announcement.content && announcement.content.length > 200 ? '...' : ''}
        </div>
        <div class="announcement-meta">
            <small style="color: #95a5a6;">
                <i class="fas fa-user"></i> ${escapeHtml(announcement.created_by || 'ç³»ç»Ÿ')} | 
                <i class="fas fa-clock"></i> ${formatDateTime(announcement.created_at)}
                ${announcement.start_time ? ` | <i class="fas fa-calendar-alt"></i> ${formatDateTime(announcement.start_time)}` : ''}
                ${announcement.end_time ? ` - ${formatDateTime(announcement.end_time)}` : ''}
            </small>
        </div>
        <div class="announcement-actions">
            <button class="action-btn btn-edit" onclick="editAnnouncement(${announcement.id})" title="ç¼–è¾‘å…¬å‘Š">
                <i class="fas fa-edit"></i> ç¼–è¾‘
            </button>
            <button class="action-btn btn-toggle" onclick="toggleAnnouncementStatus(${announcement.id})" title="åˆ‡æ¢çŠ¶æ€">
                <i class="fas fa-toggle-${announcement.status === 'active' ? 'off' : 'on'}"></i> 
                ${announcement.status === 'active' ? 'åœç”¨' : 'å¯ç”¨'}
            </button>
            <button class="action-btn btn-delete" onclick="deleteAnnouncement(${announcement.id})" title="åˆ é™¤å…¬å‘Š">
                <i class="fas fa-trash"></i> åˆ é™¤
            </button>
        </div>
    `;
    
    return card;
}

// æ˜¾ç¤ºç©ºçŠ¶æ€
function displayEmptyState() {
    const container = document.getElementById('announcementsContainer');
    container.innerHTML = `
        <div class="empty-state">
            <div class="empty-icon">
                <i class="fas fa-bullhorn"></i>
            </div>
            <h4>æš‚æ— å…¬å‘Š</h4>
            <p>ç‚¹å‡»"åˆ›å»ºæ–°å…¬å‘Š"æŒ‰é’®æ¥æ·»åŠ ç¬¬ä¸€ä¸ªå…¬å‘Š</p>
            <button class="btn btn-modern btn-primary-modern" data-bs-toggle="modal" data-bs-target="#addAnnouncementModal">
                <i class="fas fa-plus"></i> åˆ›å»ºæ–°å…¬å‘Š
            </button>
        </div>
    `;
}

// æœç´¢å’Œè¿‡æ»¤åŠŸèƒ½
function filterAnnouncements() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const priorityFilter = document.getElementById('priorityFilter').value;
    
    filteredAnnouncements = allAnnouncements.filter(announcement => {
        const matchesSearch = !searchTerm || 
            announcement.title.toLowerCase().includes(searchTerm) ||
            announcement.content.toLowerCase().includes(searchTerm);
        
        const matchesStatus = !statusFilter || announcement.status === statusFilter;
        const matchesPriority = !priorityFilter || announcement.priority === priorityFilter;
        
        return matchesSearch && matchesStatus && matchesPriority;
    });
    
    displayAnnouncements(filteredAnnouncements);
}

// åˆ·æ–°å…¬å‘Šåˆ—è¡¨
function refreshAnnouncements() {
    showMessage('æ­£åœ¨åˆ·æ–°...', 'info');
    loadAnnouncements();
}

// æ·»åŠ å…¬å‘Š
function addAnnouncement() {
    const form = document.getElementById('addAnnouncementForm');
    if (!validateForm(form)) return;
    
    const formData = new FormData(form);
    const data = {
        title: formData.get('title'),
        content: formData.get('content'),
        status: formData.get('status'),
        priority: formData.get('priority'),
        start_time: formData.get('start_time'),
        end_time: formData.get('end_time'),
        is_popup: formData.get('is_popup') === 'on'
    };
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const submitBtn = document.querySelector('#addAnnouncementModal .btn-primary-modern');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ä¿å­˜ä¸­...';
    submitBtn.disabled = true;
    
    fetch('/content/api/admin/announcements/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            closeModal('addAnnouncementModal');
            form.reset();
            loadAnnouncements();
            showMessage('å…¬å‘Šåˆ›å»ºæˆåŠŸï¼', 'success');
        } else {
            showMessage('å…¬å‘Šåˆ›å»ºå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
    })
    .catch(error => {
        console.error('è¯·æ±‚å¤±è´¥:', error);
        showMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

// ç¼–è¾‘å…¬å‘Š
function editAnnouncement(id) {
    // å…ˆè·å–å…¬å‘Šè¯¦æƒ…
    const announcement = allAnnouncements.find(a => a.id === id);
    if (!announcement) {
        showMessage('æ‰¾ä¸åˆ°è¯¥å…¬å‘Š', 'error');
        return;
    }
    
    // å¡«å……ç¼–è¾‘è¡¨å•
    document.getElementById('editId').value = announcement.id;
    document.getElementById('editTitle').value = announcement.title || '';
    document.getElementById('editContent').value = announcement.content || '';
    document.getElementById('editStatus').value = announcement.status || 'active';
    document.getElementById('editPriority').value = announcement.priority || 'normal';
    
    // å¤„ç†æ—¶é—´å­—æ®µ
    if (announcement.start_time) {
        document.getElementById('editStartTime').value = formatDateTimeLocal(announcement.start_time);
    }
    if (announcement.end_time) {
        document.getElementById('editEndTime').value = formatDateTimeLocal(announcement.end_time);
    }
    
    document.getElementById('editIsPopup').checked = announcement.is_popup || false;
    
    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    showModal('editAnnouncementModal');
}

// æ›´æ–°å…¬å‘Š
function updateAnnouncement() {
    const form = document.getElementById('editAnnouncementForm');
    if (!validateForm(form)) return;
    
    const formData = new FormData(form);
    const id = formData.get('id');
    const data = {
        title: formData.get('title'),
        content: formData.get('content'),
        status: formData.get('status'),
        priority: formData.get('priority'),
        start_time: formData.get('start_time'),
        end_time: formData.get('end_time'),
        is_popup: formData.get('is_popup') === 'on'
    };
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const submitBtn = document.querySelector('#editAnnouncementModal .btn-primary-modern');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ›´æ–°ä¸­...';
    submitBtn.disabled = true;
    
    fetch(`/content/api/admin/announcements/${id}/`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            closeModal('editAnnouncementModal');
            loadAnnouncements();
            showMessage('å…¬å‘Šæ›´æ–°æˆåŠŸï¼', 'success');
        } else {
            showMessage('å…¬å‘Šæ›´æ–°å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
    })
    .catch(error => {
        console.error('è¯·æ±‚å¤±è´¥:', error);
        showMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

// åˆ‡æ¢å…¬å‘ŠçŠ¶æ€
function toggleAnnouncementStatus(id) {
    const announcement = allAnnouncements.find(a => a.id === id);
    if (!announcement) return;
    
    const newStatus = announcement.status === 'active' ? 'inactive' : 'active';
    const actionText = newStatus === 'active' ? 'å¯ç”¨' : 'åœç”¨';
    
    if (!confirm(`ç¡®å®šè¦${actionText}è¿™ä¸ªå…¬å‘Šå—ï¼Ÿ`)) return;
    
    fetch(`/content/api/admin/announcements/${id}/`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({ status: newStatus })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadAnnouncements();
            showMessage(`å…¬å‘Šå·²${actionText}`, 'success');
        } else {
            showMessage(`${actionText}å¤±è´¥: ` + (data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
    })
    .catch(error => {
        console.error('è¯·æ±‚å¤±è´¥:', error);
        showMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
    });
}

// åˆ é™¤å…¬å‘Š
function deleteAnnouncement(id) {
    if (!confirm('âš ï¸ ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå…¬å‘Šå—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) return;
    
    fetch(`/content/api/admin/announcements/${id}/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            loadAnnouncements();
            showMessage('å…¬å‘Šåˆ é™¤æˆåŠŸï¼', 'success');
        } else {
            showMessage('å…¬å‘Šåˆ é™¤å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
    })
    .catch(error => {
        console.error('è¯·æ±‚å¤±è´¥:', error);
        showMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
    });
}

// ===== å·¥å…·å‡½æ•° =====

// æ˜¾ç¤ºåŠ è½½çŠ¶æ€
function showLoading(show) {
    const spinner = document.getElementById('loadingSpinner');
    const container = document.getElementById('announcementsContainer');
    
    if (show) {
        spinner.style.display = 'block';
        container.style.display = 'none';
    } else {
        spinner.style.display = 'none';
        container.style.display = 'block';
    }
}

// æ˜¾ç¤ºæ¶ˆæ¯æç¤º
function showMessage(message, type = 'info') {
    // ç§»é™¤æ—§çš„æ¶ˆæ¯
    const oldMessages = document.querySelectorAll('.message-toast');
    oldMessages.forEach(msg => msg.remove());
    
    const toast = document.createElement('div');
    toast.className = `message-toast alert alert-${type} alert-dismissible fade show`;
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        border-radius: 10px;
        animation: slideInRight 0.3s ease;
    `;
    
    const icon = {
        'success': 'fas fa-check-circle',
        'error': 'fas fa-exclamation-triangle',
        'warning': 'fas fa-exclamation-circle',
        'info': 'fas fa-info-circle'
    }[type] || 'fas fa-info-circle';
    
    toast.innerHTML = `
        <i class="${icon}"></i> ${message}
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;
    
    document.body.appendChild(toast);
    
    // è‡ªåŠ¨æ¶ˆå¤±
    setTimeout(() => {
        if (toast.parentElement) {
            toast.style.animation = 'slideOutRight 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }
    }, 4000);
}

// è¡¨å•éªŒè¯
function validateForm(form) {
    const title = form.querySelector('[name="title"]').value.trim();
    const content = form.querySelector('[name="content"]').value.trim();
    
    if (!title) {
        showMessage('è¯·è¾“å…¥å…¬å‘Šæ ‡é¢˜', 'warning');
        form.querySelector('[name="title"]').focus();
        return false;
    }
    
    if (title.length > 100) {
        showMessage('å…¬å‘Šæ ‡é¢˜ä¸èƒ½è¶…è¿‡100ä¸ªå­—ç¬¦', 'warning');
        form.querySelector('[name="title"]').focus();
        return false;
    }
    
    if (!content) {
        showMessage('è¯·è¾“å…¥å…¬å‘Šå†…å®¹', 'warning');
        form.querySelector('[name="content"]').focus();
        return false;
    }
    
    if (content.length > 2000) {
        showMessage('å…¬å‘Šå†…å®¹ä¸èƒ½è¶…è¿‡2000ä¸ªå­—ç¬¦', 'warning');
        form.querySelector('[name="content"]').focus();
        return false;
    }
    
    return true;
}

// è·å–CSRFä»¤ç‰Œ
function getCsrfToken() {
    const token = document.querySelector('[name=csrfmiddlewaretoken]');
    return token ? token.value : '';
}

// æ¨¡æ€æ¡†æ“ä½œ
function showModal(modalId) {
    const modal = new bootstrap.Modal(document.getElementById(modalId));
    modal.show();
}

function closeModal(modalId) {
    const modal = bootstrap.Modal.getInstance(document.getElementById(modalId));
    if (modal) modal.hide();
}

// è½¬ä¹‰HTML
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
function formatDateTime(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´ä¸ºæœ¬åœ°è¾“å…¥æ ¼å¼
function formatDateTimeLocal(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${year}-${month}-${day}T${hours}:${minutes}`;
}

// è·å–ä¼˜å…ˆçº§å›¾æ ‡
function getPriorityIcon(priority) {
    switch (priority) {
        case 'high': return 'ğŸ”´';
        case 'low': return 'âšª';
        default: return 'ğŸ”µ';
    }
}

// è·å–ä¼˜å…ˆçº§æ–‡æœ¬
function getPriorityText(priority) {
    switch (priority) {
        case 'high': return 'é«˜';
        case 'low': return 'ä½';
        default: return 'æ™®é€š';
    }
}

// æ·»åŠ CSSåŠ¨ç”»æ ·å¼
const animationStyles = document.createElement('style');
animationStyles.textContent = `
    @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOutRight {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(animationStyles);

// ä¿®å¤è’™å±‚é—®é¢˜çš„JavaScriptä»£ç 
document.addEventListener('DOMContentLoaded', function() {
    // ç›‘å¬æ‰€æœ‰æ¨¡æ€æ¡†çš„éšè—äº‹ä»¶
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('hidden.bs.modal', function() {
            // å¼ºåˆ¶ç§»é™¤æ‰€æœ‰è’™å±‚
            document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
            document.body.classList.remove('modal-open');
            
            // æ¢å¤é¡µé¢æ»šåŠ¨
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
        });
        
        modal.addEventListener('shown.bs.modal', function() {
            // ç¡®ä¿æ¨¡æ€æ¡†åœ¨æœ€ä¸Šå±‚
            this.style.zIndex = '1050';
            
            // ç¡®ä¿èƒŒæ™¯é®ç½©è®¾ç½®æ­£ç¡®
            document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
                backdrop.style.zIndex = '1040';
                backdrop.style.pointerEvents = 'none';
            });
        });
    });
    
    // ç‚¹å‡»é®ç½©å…³é—­æ¨¡æ€æ¡†
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal-backdrop')) {
            const activeModal = document.querySelector('.modal.show');
            if (activeModal) {
                const modal = bootstrap.Modal.getInstance(activeModal);
                if (modal) modal.hide();
            }
        }
    });
    
    // ç¡®ä¿é¡µé¢åŠ è½½æ—¶æ²¡æœ‰æ®‹ç•™çš„è’™å±‚
    document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
    document.body.classList.remove('modal-open');
});

// æ·»åŠ å…¨å±€é”™è¯¯å¤„ç†ï¼Œé˜²æ­¢JavaScripté”™è¯¯å¯¼è‡´è’™å±‚å¡ä½
window.addEventListener('error', function() {
    document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
    document.body.classList.remove('modal-open');
});
</script>
{% endblock %} 