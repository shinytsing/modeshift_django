{% extends "base.html" %}
{% load static %}

{% block content %}
{% if user.is_authenticated %}
<div id="tool-container" style="min-height: 100vh; padding: 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
  
  <!-- ææ€ªçš„æ ‡é¢˜åŒºåŸŸ -->
  <div id="tool-title" style="text-align: center; margin-bottom: 3rem; animation: bounce 2s infinite;">
    <h1 style="font-size: 3.5rem; font-weight: bold; color: white; text-shadow: 3px 3px 6px rgba(0,0,0,0.3); margin-bottom: 1rem;">
      ğŸ¤” ä½ æƒ³è¯·æ±‚å“ªé‡Œå‘¢ï¼ŸğŸ˜‚
    </h1>
    <p style="font-size: 1.5rem; color: #f0f0f0; font-style: italic; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
      é€‰æ‹©ä½ çš„å†’é™©ä¹‹æ—…å§ï¼âœ¨
    </p>
  </div>

  <!-- æ¨¡å¼é€‰æ‹©åŒºåŸŸ -->
  <div class="mode-selection" style="margin-bottom: 4rem;">
    <h2 style="text-align: center; color: white; font-size: 2rem; margin-bottom: 2rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
      ğŸ­ é€‰æ‹©ä½ çš„æ¨¡å¼
    </h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem; max-width: 1000px; margin: 0 auto;">
      
      <!-- æå®¢æ¨¡å¼ -->
      <div class="mode-card" onclick="selectMode('work')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; padding: 2rem; text-align: center; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 3px solid transparent;">
        <div style="font-size: 4rem; margin-bottom: 1rem;">ğŸ’»</div>
        <h3 style="color: white; font-size: 1.5rem; margin-bottom: 0.5rem;">æå®¢æ¨¡å¼</h3>
        <p style="color: #e0e0e0; font-size: 1rem;">ä»£ç ã€æµ‹è¯•ã€PDFè½¬æ¢...æŠ€æœ¯å®…çš„å¤©å ‚ï¼</p>
      </div>

      <!-- ç”Ÿæ´»æ¨¡å¼ -->
      <div class="mode-card" onclick="selectMode('life')" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 20px; padding: 2rem; text-align: center; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 3px solid transparent;">
        <div style="font-size: 4rem; margin-bottom: 1rem;">ğŸŒ±</div>
        <h3 style="color: white; font-size: 1.5rem; margin-bottom: 0.5rem;">ç”Ÿæ´»æ¨¡å¼</h3>
        <p style="color: #e0e0e0; font-size: 1rem;">æ—¥è®°ã€å¥èº«ã€å†¥æƒ³...è®©ç”Ÿæ´»æ›´ç¾å¥½ï¼</p>
      </div>

      <!-- ç‹‚æš´æ¨¡å¼ -->
      <div class="mode-card" onclick="selectMode('training')" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border-radius: 20px; padding: 2rem; text-align: center; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 3px solid transparent;">
        <div style="font-size: 4rem; margin-bottom: 1rem;">âš¡</div>
        <h3 style="color: white; font-size: 1.5rem; margin-bottom: 0.5rem;">ç‹‚æš´æ¨¡å¼</h3>
        <p style="color: #e0e0e0; font-size: 1rem;">é«˜å¼ºåº¦è®­ç»ƒã€æé™æŒ‘æˆ˜...é‡Šæ”¾ä½ çš„èƒ½é‡ï¼</p>
      </div>

      <!-- Emoæ¨¡å¼ -->
      <div class="mode-card" onclick="selectMode('emo')" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); border-radius: 20px; padding: 2rem; text-align: center; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 3px solid transparent;">
        <div style="font-size: 4rem; margin-bottom: 1rem;">ğŸ­</div>
        <h3 style="color: white; font-size: 1.5rem; margin-bottom: 0.5rem;">Emoæ¨¡å¼</h3>
        <p style="color: #e0e0e0; font-size: 1rem;">æƒ…æ„Ÿåˆ†æã€åˆ›æ„å†™ä½œ...æ¢ç´¢å†…å¿ƒçš„ä¸–ç•Œï¼</p>
      </div>

    </div>
  </div>

  <!-- å·¥å…·é€‰æ‹©åŒºåŸŸ -->
  <div id="tool-selection" style="display: none;">
    <h2 id="mode-title" style="text-align: center; color: white; font-size: 2rem; margin-bottom: 2rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
      ğŸ› ï¸ é€‰æ‹©ä½ çš„å·¥å…·
    </h2>
    <div id="tool-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; max-width: 1200px; margin: 0 auto;">
      <!-- å·¥å…·å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
    </div>
    
    <!-- è¿”å›æŒ‰é’® -->
    <div style="text-align: center; margin-top: 3rem;">
      <button onclick="showModeSelection()" style="background: rgba(255,255,255,0.2); border: 2px solid white; color: white; padding: 1rem 2rem; border-radius: 50px; font-size: 1.2rem; cursor: pointer; transition: all 0.3s ease; backdrop-filter: blur(10px);">
        ğŸ”™ è¿”å›æ¨¡å¼é€‰æ‹©
      </button>
    </div>
  </div>

  <!-- éšæœºæç¤ºåŒºåŸŸ -->
  <div id="random-tip" style="position: fixed; bottom: 2rem; right: 2rem; background: rgba(255,255,255,0.9); padding: 1rem; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); max-width: 300px; display: none;">
    <p style="margin: 0; font-size: 0.9rem; color: #333;">ğŸ’¡ <span id="tip-text">ç‚¹å‡»æ¨¡å¼å¡ç‰‡å¼€å§‹ä½ çš„å†’é™©ï¼</span></p>
  </div>

</div>

<style>
@keyframes bounce {
  0%, 20%, 50%, 80%, 100% {
    transform: translateY(0);
  }
  40% {
    transform: translateY(-10px);
  }
  60% {
    transform: translateY(-5px);
  }
}

@keyframes pulse {
  0% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.05);
  }
  100% {
    transform: scale(1);
  }
}

@keyframes slideInRight {
  0% {
    transform: translateX(100%);
    opacity: 0;
  }
  100% {
    transform: translateX(0);
    opacity: 1;
  }
}

@keyframes slideOutRight {
  0% {
    transform: translateX(0);
    opacity: 1;
  }
  100% {
    transform: translateX(100%);
    opacity: 0;
  }
}

@keyframes shake {
  0%, 100% {
    transform: translateX(0);
  }
  10%, 30%, 50%, 70%, 90% {
    transform: translateX(-5px);
  }
  20%, 40%, 60%, 80% {
    transform: translateX(5px);
  }
}

.mode-card:hover {
  transform: translateY(-10px) scale(1.05);
  border-color: rgba(255,255,255,0.5) !important;
  box-shadow: 0 20px 40px rgba(0,0,0,0.4) !important;
}

.mode-card:active {
  animation: shake 0.5s ease-in-out;
}

.tool-card {
  background: rgba(255,255,255,0.1);
  border-radius: 15px;
  padding: 1.5rem;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
  border: 2px solid rgba(255,255,255,0.2);
  color: white;
}

.tool-card:hover {
  background: rgba(255,255,255,0.2);
  transform: translateY(-5px);
  border-color: rgba(255,255,255,0.5);
  box-shadow: 0 10px 25px rgba(0,0,0,0.3);
}

.tool-card:active {
  animation: pulse 0.3s ease-in-out;
}
</style>

<script>
// å·¥å…·æ•°æ®
const toolsData = {
  work: [
    { name: 'æµ‹è¯•ç”¨ä¾‹ç”Ÿæˆå™¨', url: '/tools/test_case_generator/', icon: 'ğŸ§ª', desc: 'è‡ªåŠ¨ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹ï¼Œè®©ä»£ç æ›´å¯é ï¼' },
    { name: 'PDFè½¬æ¢å™¨', url: '/tools/pdf_converter/', icon: 'ğŸ“„', desc: 'PDFè½¬Wordï¼Œæ–‡æ¡£å¤„ç†ç¥å™¨ï¼' },
    { name: 'ç½‘é¡µçˆ¬è™«', url: '/tools/web_crawler/', icon: 'ğŸ•·ï¸', desc: 'æ™ºèƒ½çˆ¬å–ç½‘é¡µæ•°æ®ï¼' },
    { name: 'ZIPæ–‡ä»¶å¤„ç†', url: '/tools/zip-tool/', icon: 'ğŸ“¦', desc: 'å¤šæ–‡ä»¶æ‰“åŒ…ã€å•æ–‡ä»¶å‹ç¼©ï¼Œæ–‡ä»¶å¤„ç†åˆ©å™¨ï¼' }
  ],
  life: [
    { name: 'ç”Ÿæ´»æ—¥è®°', url: '/tools/simple-diary/', icon: 'ğŸ“–', desc: 'è®°å½•ç¾å¥½ç”Ÿæ´»ï¼Œé™ä½è®°å½•é—¨æ§›ï¼Œè®©è®°å½•æœ¬èº«æˆä¸ºä¸€ç§ä¹è¶£ï¼' },
    { name: 'FitMatrix', url: '/tools/fitness/', icon: 'ğŸ’ª', desc: 'æ™ºèƒ½å¥èº«çŸ©é˜µï¼Œé‡å¡‘èº«ä½“è¾¹ç•Œï¼' },
    { name: 'å†¥æƒ³æŒ‡å—', url: '/tools/meditation_guide/', icon: 'ğŸ§˜', desc: 'é™å¿ƒå†¥æƒ³ï¼Œæ‰¾å›å†…å¿ƒçš„å¹³é™ï¼' },
    { name: 'éŸ³ä¹ç–—æ„ˆ', url: '/tools/music_healing/', icon: 'ğŸµ', desc: 'ç”¨éŸ³ä¹æ²»æ„ˆå¿ƒçµï¼' },
{ name: 'ç¾é£Ÿé€‰æ‹©å™¨', url: '/tools/food_randomizer/', icon: 'ğŸ½ï¸', desc: 'æ™ºèƒ½ç¾é£Ÿæ¨èï¼Œè§£å†³é€‰æ‹©å›°éš¾ï¼' },
{ name: 'æœ¬åœ°ç¾é£Ÿå›¾åº“', url: '/tools/local_food_display/', icon: 'ğŸœ', desc: 'ç²¾ç¾é£Ÿç‰©å›¾ç‰‡å±•ç¤ºï¼Œé£Ÿç‰©ä¸å›¾ç‰‡å®Œç¾åŒ¹é…ï¼' }
  ],
  training: [
    { name: 'è‡ªæˆ‘åˆ†æ', url: '/tools/self_analysis/', icon: 'ğŸ”', desc: 'æ·±åº¦åˆ†æè‡ªæˆ‘ï¼Œå‘ç°æ½œèƒ½ï¼' },
    { name: 'æ•…äº‹æ¿', url: '/tools/storyboard/', icon: 'ğŸ¬', desc: 'åˆ›æ„æ•…äº‹æ¿ï¼Œæ¿€å‘çµæ„Ÿï¼' },
    { name: 'å‘½è¿åˆ†æ', url: '/tools/fortune_analyzer/', icon: 'ğŸ”®', desc: 'æ¢ç´¢å‘½è¿çš„å¥¥ç§˜ï¼' }
  ],
  emo: [
    { name: 'æƒ…æ„Ÿæ—¥è®°', url: '/tools/emo_diary/', icon: 'ğŸ’­', desc: 'è®°å½•æƒ…æ„Ÿæ³¢åŠ¨ï¼Œäº†è§£è‡ªå·±ï¼' },
{ name: 'åˆ›æ„å†™ä½œ', url: '/tools/creative_writer/', icon: 'âœï¸', desc: 'AIåŠ©ä½ åˆ›ä½œï¼Œé‡Šæ”¾åˆ›æ„ï¼' }
  ]
};

// éšæœºæç¤º
const randomTips = [
  'ğŸ’¡ ç‚¹å‡»æ¨¡å¼å¡ç‰‡å¼€å§‹ä½ çš„å†’é™©ï¼',
  'ğŸ¯ æ¯ä¸ªæ¨¡å¼éƒ½æœ‰ç‹¬ç‰¹çš„å·¥å…·ç­‰ä½ å‘ç°ï¼',
  'ğŸš€ é€‰æ‹©ä½ æ„Ÿå…´è¶£çš„æ¨¡å¼ï¼Œå¼€å§‹æ¢ç´¢å§ï¼',
  'âœ¨ å·¥å…·è™½å¤šï¼Œä½†æ€»æœ‰ä¸€æ¬¾é€‚åˆä½ ï¼',
  'ğŸ¨ ä¸åŒçš„æ¨¡å¼ï¼Œä¸åŒçš„ä½“éªŒï¼',
  'ğŸŒŸ è®©AIåŠ©æ‰‹å¸®ä½ å®Œæˆå„ç§ä»»åŠ¡ï¼',
  'ğŸª è¿™é‡Œæ˜¯ä¸€ä¸ªç¥å¥‡çš„å·¥å…·é©¬æˆå›¢ï¼',
  'ğŸ­ é€‰æ‹©ä½ çš„è§’è‰²ï¼Œå¼€å§‹è¡¨æ¼”å§ï¼'
];

let currentMode = null;
let preferredMode = '{{ preferred_mode|default:"work" }}';
let modeNames = {
  work: 'æå®¢æ¨¡å¼',
  life: 'ç”Ÿæ´»æ¨¡å¼',
  training: 'ç‹‚æš´æ¨¡å¼',
  emo: 'Emoæ¨¡å¼'
};

// è®°å½•æ¨¡å¼ç‚¹å‡»åˆ°æœåŠ¡å™¨
async function recordModeClick(mode) {
  try {
    const response = await fetch('/tools/api/mode/record_click/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({ mode: mode })
    });
    
    const data = await response.json();
    if (data.success) {

    } else {
      console.error('æ¨¡å¼ç‚¹å‡»è®°å½•å¤±è´¥:', data.error);
    }
  } catch (error) {
    console.error('è®°å½•æ¨¡å¼ç‚¹å‡»æ—¶å‡ºé”™:', error);
  }
}

// è·å–CSRF Token
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

// é€‰æ‹©æ¨¡å¼
async function selectMode(mode) {
  currentMode = mode;
  
  // è®°å½•æ¨¡å¼ç‚¹å‡»
  await recordModeClick(mode);
  
  showToolSelection();
  showRandomTip();
  
  // æ·»åŠ ç‚¹å‡»åŠ¨ç”»
  event.target.closest('.mode-card').style.animation = 'pulse 0.5s ease-in-out';
  setTimeout(() => {
    event.target.closest('.mode-card').style.animation = '';
  }, 500);
}

// æ˜¾ç¤ºå·¥å…·é€‰æ‹©
function showToolSelection() {
  document.querySelector('.mode-selection').style.display = 'none';
  document.getElementById('tool-selection').style.display = 'block';
  
  document.getElementById('mode-title').innerHTML = `ğŸ› ï¸ ${modeNames[currentMode]} - é€‰æ‹©ä½ çš„å·¥å…·`;
  
  const toolGrid = document.getElementById('tool-grid');
  toolGrid.innerHTML = '';
  
  toolsData[currentMode].forEach(tool => {
    const toolCard = document.createElement('div');
    toolCard.className = 'tool-card';
    toolCard.innerHTML = `
      <div style="font-size: 3rem; margin-bottom: 1rem;">${tool.icon}</div>
      <h3 style="font-size: 1.3rem; margin-bottom: 0.5rem;">${tool.name}</h3>
      <p style="font-size: 0.9rem; opacity: 0.9;">${tool.desc}</p>
    `;
    toolCard.onclick = () => {
      toolCard.style.animation = 'pulse 0.3s ease-in-out';
      setTimeout(() => {
        window.location.href = tool.url;
      }, 300);
    };
    toolGrid.appendChild(toolCard);
  });
}

// æ˜¾ç¤ºæ¨¡å¼é€‰æ‹©
function showModeSelection() {
  document.querySelector('.mode-selection').style.display = 'block';
  document.getElementById('tool-selection').style.display = 'none';
  currentMode = null;
  showRandomTip();
}

// æ˜¾ç¤ºéšæœºæç¤º
function showRandomTip() {
  const tipElement = document.getElementById('random-tip');
  const tipText = document.getElementById('tip-text');
  tipText.textContent = randomTips[Math.floor(Math.random() * randomTips.length)];
  
  tipElement.style.display = 'block';
  tipElement.style.animation = 'bounce 1s ease-in-out';
  
  setTimeout(() => {
    tipElement.style.display = 'none';
  }, 5000);
}

// è·å–ç”¨æˆ·åå¥½æ¨¡å¼
async function getUserPreferredMode() {
  try {
    const response = await fetch('/tools/api/mode/preferred/', {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    if (data.success) {
      return data.preferred_mode;
    } else {
      console.error('è·å–ç”¨æˆ·åå¥½æ¨¡å¼å¤±è´¥:', data.error);
      return 'work'; // é»˜è®¤æå®¢æ¨¡å¼
    }
  } catch (error) {
    console.error('è·å–ç”¨æˆ·åå¥½æ¨¡å¼æ—¶å‡ºé”™:', error);
    return 'work'; // é»˜è®¤æå®¢æ¨¡å¼
  }
}

// è‡ªåŠ¨é€‰æ‹©ç”¨æˆ·åå¥½æ¨¡å¼
async function autoSelectPreferredMode() {
  // æ£€æŸ¥æ˜¯å¦æœ‰æ¨¡å¼ç‚¹å‡»è®°å½•
  try {
    const response = await fetch('/tools/api/mode/preferred/', {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    if (data.success && data.mode_stats) {
      // æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•æ¨¡å¼è¢«ç‚¹å‡»è¿‡
      const hasAnyClicks = data.mode_stats.some(stat => stat.click_count > 0);
      
      if (hasAnyClicks) {
        // è‡ªåŠ¨é€‰æ‹©æœ€åå¥½çš„æ¨¡å¼
        currentMode = preferredMode;
        showToolSelection();
        
        // åˆ›å»ºæç¤ºå…ƒç´ 
        const autoSelectTip = document.createElement('div');
        autoSelectTip.id = 'auto-select-tip';
        autoSelectTip.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: rgba(76, 175, 80, 0.9);
          color: white;
          padding: 15px 20px;
          border-radius: 10px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.2);
          z-index: 1000;
          font-size: 14px;
          max-width: 300px;
          animation: slideInRight 0.5s ease-out;
        `;
        autoSelectTip.innerHTML = `
          ğŸ¯ æ ¹æ®æ‚¨çš„ä½¿ç”¨ä¹ æƒ¯ï¼Œå·²è‡ªåŠ¨é€‰æ‹© <strong>${modeNames[preferredMode]}</strong>
          <br><small>æ‚¨å¯ä»¥ç‚¹å‡»"è¿”å›æ¨¡å¼é€‰æ‹©"æ¥åˆ‡æ¢å…¶ä»–æ¨¡å¼</small>
        `;
        
        document.body.appendChild(autoSelectTip);
        
        // 3ç§’åè‡ªåŠ¨éšè—æç¤º
        setTimeout(() => {
          if (autoSelectTip.parentNode) {
            autoSelectTip.style.animation = 'slideOutRight 0.5s ease-in';
            setTimeout(() => {
              if (autoSelectTip.parentNode) {
                autoSelectTip.parentNode.removeChild(autoSelectTip);
              }
            }, 500);
          }
        }, 3000);
      }
    }
  } catch (error) {
    console.error('æ£€æŸ¥æ¨¡å¼ç»Ÿè®¡æ—¶å‡ºé”™:', error);
  }
}

// é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºæç¤º
document.addEventListener('DOMContentLoaded', function() {
  // è‡ªåŠ¨é€‰æ‹©ç”¨æˆ·åå¥½æ¨¡å¼
  autoSelectPreferredMode();
  
  setTimeout(() => {
    showRandomTip();
  }, 1000);
  
  // å®šæœŸæ›´æ¢æç¤º
  setInterval(() => {
    if (document.getElementById('random-tip').style.display === 'none') {
      showRandomTip();
    }
  }, 8000);
});
</script>

{% else %}
<div style="min-height: 100vh; padding: 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center;">
  <div style="text-align: center; background: rgba(255,255,255,0.9); padding: 3rem; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); backdrop-filter: blur(10px);">
    <h2 style="color: #333; margin-bottom: 1rem; font-size: 2rem;">ğŸ”’ éœ€è¦ç™»å½•</h2>
    <p style="color: #666; margin-bottom: 2rem; font-size: 1.1rem;">è¯·å…ˆç™»å½•ä»¥ä½¿ç”¨æˆ‘ä»¬çš„ç¥å¥‡å·¥å…·ï¼âœ¨</p>
    <div>
      <a href="{% url 'users:login' %}" style="display: inline-block; padding: 1rem 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; border-radius: 50px; margin-right: 1rem; transition: all 0.3s ease; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
        <i class="fas fa-sign-in-alt"></i> ç™»å½•
      </a>
      <a href="{% url 'users:register' %}" style="display: inline-block; padding: 1rem 2rem; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; text-decoration: none; border-radius: 50px; transition: all 0.3s ease; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
        <i class="fas fa-user-plus"></i> æ³¨å†Œ
      </a>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}