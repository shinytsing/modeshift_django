{% extends "base.html" %}
{% load static %}

{% block tool_title_inner %}FitMatrix - 健身矩阵{% endblock %}
{% block tool_title_display %}FitMatrix - 健身矩阵{% endblock %}

{% block content %}
{% csrf_token %}
<!-- 强制清除所有缓存 -->
<script>
// 检测是否存在旧函数，如果存在则强制清除所有缓存
if (typeof renderActivePlan !== 'undefined' || typeof initCurrentPlan !== 'undefined') {

  // 清除localStorage
  localStorage.clear();
  
  // 清除sessionStorage
  sessionStorage.clear();
  
  // 清除所有缓存
  if ('caches' in window) {
    caches.keys().then(function(names) {
      return Promise.all(names.map(function(name) {
        return caches.delete(name);
      }));
    }).then(function() {

      // 强制重新加载，不使用缓存
      window.location.reload(true);
    });
  } else {
    // 如果不支持caches API，直接重新加载
    window.location.reload(true);
  }
}
</script>
<div class="fitness-container">


  <!-- 快捷键提示 -->
  <button class="shortcuts-help-btn" id="showShortcutsHelp" title="快捷键帮助">
    <i class="fas fa-keyboard"></i>
  </button>

  <!-- 快捷键帮助面板 -->
  <div class="shortcuts-help-panel" id="shortcutsHelpPanel">
    <div class="help-panel-header">
      <h3><i class="fas fa-keyboard"></i> 快捷键帮助</h3>
      <button class="close-help-btn" id="closeShortcutsHelp">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="help-panel-content">
      <div class="shortcuts-section">
        <h4><i class="fas fa-palette"></i> 主题切换</h4>
        <div class="shortcut-item">
          <span class="shortcut-key">Ctrl + 1</span>
          <span class="shortcut-desc">生活模式</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Ctrl + 2</span>
          <span class="shortcut-desc">极客模式</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Ctrl + 3</span>
          <span class="shortcut-desc">狂暴模式</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Ctrl + 4</span>
          <span class="shortcut-desc">Emo模式</span>
        </div>
      </div>
      <div class="shortcuts-section">
        <h4><i class="fas fa-tools"></i> 工具跳转</h4>
        <div class="shortcut-item">
          <span class="shortcut-key">Alt + E</span>
          <span class="shortcut-desc">情感日记</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Alt + L</span>
          <span class="shortcut-desc">生活日记</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Alt + F</span>
          <span class="shortcut-desc">FitMatrix</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Alt + C</span>
          <span class="shortcut-desc">创意写作</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Alt + P</span>
          <span class="shortcut-desc">PDF转换器</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Alt + R</span>
          <span class="shortcut-desc">小红书生成器</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Alt + T</span>
          <span class="shortcut-desc">测试用例生成器</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Alt + W</span>
          <span class="shortcut-desc">网页爬虫</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Alt + S</span>
          <span class="shortcut-desc">自我分析</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Alt + B</span>
          <span class="shortcut-desc">故事板</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Alt + M</span>
          <span class="shortcut-desc">音乐疗愈</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Alt + D</span>
          <span class="shortcut-desc">冥想指南</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Alt + A</span>
          <span class="shortcut-desc">运势分析</span>
        </div>
      </div>
    </div>
  </div>

  <!-- 遮罩层 -->
  <div class="help-overlay" id="helpOverlay"></div>

  <!-- 头部区域 -->
  <div class="fitness-header">
    <div class="fitness-title">
      <i class="fas fa-dumbbell"></i>
      <span data-zh="FitMatrix" data-en="FitMatrix">FitMatrix</span>
    </div>
    <div class="fitness-subtitle" data-zh="智能健身矩阵，重塑身体边界" data-en="Intelligent Fitness Matrix, Reshape Physical Boundaries">智能健身矩阵，重塑身体边界</div>
  </div>

  <!-- 主要功能区域 -->
  <div class="fitness-main">
    <div class="fitness-grid">
      <!-- 训练计划 -->
      <div class="fitness-card">
        <div class="fitness-card-header">
          <i class="fas fa-calendar-alt"></i>
          <h3 data-zh="训练计划" data-en="Training Plan">训练计划</h3>
          <button class="edit-plan-btn" onclick="editActivePlan()" data-zh="编辑计划" data-en="Edit Plan">
            <i class="fas fa-edit"></i> 编辑计划
          </button>
          <button class="library-plan-btn" onclick="openPlanLibrary()" data-zh="计划库" data-en="Plan Library" style="
            background: var(--rage-secondary, #2196F3);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            margin-left: 8px;
          ">
            <i class="fas fa-book"></i> 计划库
          </button>
          <button class="fullscreen-plan-btn" onclick="togglePlanFullscreen()" data-zh="全屏" data-en="Fullscreen" style="
            background: var(--rage-accent, #9C27B0);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            margin-left: 8px;
          ">
            <i class="fas fa-expand"></i> 全屏
          </button>
          <button class="export-plan-btn" onclick="exportPlanAsImage()" data-zh="导出图片" data-en="Export Image" style="
            background: var(--success-color, #4CAF50);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            margin-left: 8px;
          ">
            <i class="fas fa-download"></i> 导出图片
          </button>
        </div>
        <div class="fitness-card-content">
          <div class="current-plan-preview">
            <div class="plan-info">
              <h4>当前计划：增肌分化训练</h4>
              <p>5天分化 • 胸背肩腿臂循环</p>
            </div>
            <div class="workout-plan" id="workoutPlan">
              <div class="plan-day active" data-day="1">
                <span data-zh="周一" data-en="Mon">周一</span>
                <span class="plan-type" data-zh="胸部" data-en="Chest">胸部</span>
                <span class="plan-exercises">4个动作</span>
              </div>
              <div class="plan-day" data-day="2">
                <span data-zh="周二" data-en="Tue">周二</span>
                <span class="plan-type" data-zh="背部" data-en="Back">背部</span>
                <span class="plan-exercises">5个动作</span>
              </div>
              <div class="plan-day" data-day="3">
                <span data-zh="周三" data-en="Wed">周三</span>
                <span class="plan-type" data-zh="休息" data-en="Rest">休息</span>
                <span class="plan-exercises">恢复日</span>
              </div>
              <div class="plan-day" data-day="4">
                <span data-zh="周四" data-en="Thu">周四</span>
                <span class="plan-type" data-zh="肩部" data-en="Shoulders">肩部</span>
                <span class="plan-exercises">4个动作</span>
              </div>
              <div class="plan-day" data-day="5">
                <span data-zh="周五" data-en="Fri">周五</span>
                <span class="plan-type" data-zh="腿部" data-en="Legs">腿部</span>
                <span class="plan-exercises">5个动作</span>
              </div>
              <div class="plan-day" data-day="6">
                <span data-zh="周六" data-en="Sat">周六</span>
                <span class="plan-type" data-zh="手臂" data-en="Arms">手臂</span>
                <span class="plan-exercises">4个动作</span>
              </div>
              <div class="plan-day" data-day="7">
                <span data-zh="周日" data-en="Sun">周日</span>
                <span class="plan-type" data-zh="休息" data-en="Rest">休息</span>
                <span class="plan-exercises">恢复日</span>
              </div>
            </div>
            <div class="plan-actions">
              <button class="action-btn primary" onclick="openPlanEditor()">
                <i class="fas fa-plus"></i> 创建新计划
              </button>
              <button class="action-btn secondary" onclick="openPlanLibrary()">
                <i class="fas fa-book"></i> 计划库
              </button>
              <button class="action-btn secondary" onclick="openPlanTemplates()">
                <i class="fas fa-star"></i> 模板推荐
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- 训练计时器 -->
      <div class="fitness-card">
        <div class="fitness-card-header">
          <i class="fas fa-stopwatch"></i>
          <h3 data-zh="训练计时器" data-en="Workout Timer">训练计时器</h3>
        </div>
        <div class="fitness-card-content">
          <div class="timer-display">
            <div class="timer-time" id="timerDisplay">00:00</div>
            <div class="timer-input">
              <label for="timerSeconds" data-zh="输入秒数:" data-en="Enter seconds:">输入秒数:</label>
              <input type="number" id="timerSeconds" placeholder="例如: 300" min="1" max="7200">
              <button id="setTimer" data-zh="设置" data-en="Set">设置</button>
            </div>
            <div class="timer-controls">
              <button class="timer-btn" id="startTimer" data-zh="开始" data-en="Start">开始</button>
              <button class="timer-btn" id="pauseTimer" data-zh="暂停" data-en="Pause">暂停</button>
              <button class="timer-btn" id="resetTimer" data-zh="重置" data-en="Reset">重置</button>
            </div>
            <div class="timer-presets">
              <button class="preset-btn" data-time="300" data-zh="5分钟" data-en="5min">5分钟</button>
              <button class="preset-btn" data-time="600" data-zh="10分钟" data-en="10min">10分钟</button>
              <button class="preset-btn" data-time="1800" data-zh="30分钟" data-en="30min">30分钟</button>
            </div>
          </div>
        </div>
      </div>



      <!-- 营养计算器 -->
      <div class="fitness-card">
        <div class="fitness-card-header">
          <i class="fas fa-calculator"></i>
          <h3 data-zh="营养计算器" data-en="Nutrition Calculator">营养计算器</h3>
        </div>
        <div class="fitness-card-content">
          <div class="nutrition-calc">
            <div class="calc-input">
              <label data-zh="体重 (kg)" data-en="Weight (kg)">体重 (kg)</label>
              <input type="number" id="weight" placeholder="70">
            </div>
            <div class="calc-input">
              <label data-zh="身高 (cm)" data-en="Height (cm)">身高 (cm)</label>
              <input type="number" id="height" placeholder="175">
            </div>
            <div class="calc-input">
              <label data-zh="年龄" data-en="Age">年龄</label>
              <input type="number" id="age" placeholder="25">
            </div>
            <div class="calc-input">
              <label data-zh="活动水平" data-en="Activity Level">活动水平</label>
              <select id="activity">
                <option value="1.2" data-zh="久坐不动" data-en="Sedentary">久坐不动</option>
                <option value="1.375" data-zh="轻度活动" data-en="Lightly Active">轻度活动</option>
                <option value="1.55" data-zh="中度活动" data-en="Moderately Active">中度活动</option>
                <option value="1.725" data-zh="高度活动" data-en="Very Active">高度活动</option>
                <option value="1.9" data-zh="极高活动" data-en="Extremely Active">极高活动</option>
              </select>
            </div>
            <button class="calc-btn" id="calculateBMR" data-zh="计算基础代谢率" data-en="Calculate BMR">计算基础代谢率</button>
            <div class="calc-result" id="bmrResult"></div>
          </div>
        </div>
      </div>

      

      <!-- 打卡日历 -->
      <div class="fitness-card checkin-calendar-card">
        <div class="fitness-card-header">
          <i class="fas fa-calendar-check"></i>
          <h3 data-zh="打卡日历" data-en="Check-in Calendar">打卡日历</h3>
        </div>
        <div class="fitness-card-content">
          <div class="checkin-calendar-container">
            <!-- 日历导航 -->
            <div class="calendar-nav">
              <button class="nav-btn" id="prevMonth"><i class="fas fa-chevron-left"></i></button>
              <div class="current-month" id="currentMonth">2024年1月</div>
              <button class="nav-btn" id="nextMonth"><i class="fas fa-chevron-right"></i></button>
              <button class="nav-btn today-btn" id="goToday">今天</button>
            </div>
            
            <!-- 连续打卡信息 -->
            <div class="streak-info">
              <div class="streak-item">
                <i class="fas fa-fire"></i>
                <span>连续 <span id="currentStreak">0</span> 天</span>
              </div>
              <div class="streak-item">
                <i class="fas fa-trophy"></i>
                <span>最长 <span id="longestStreak">0</span> 天</span>
              </div>
            </div>
            
            <!-- 日历网格 -->
            <div class="calendar-grid">
              <div class="calendar-header">
                <div>日</div>
                <div>一</div>
                <div>二</div>
                <div>三</div>
                <div>四</div>
                <div>五</div>
                <div>六</div>
              </div>
              <div class="calendar-body" id="calendarBody">
                <!-- 日历日期将通过JavaScript动态生成 -->
              </div>
            </div>
            
            <!-- 月度统计 -->
            <div class="monthly-stats">
              <div class="stat-item">
                <div class="stat-value" id="completionRate">0%</div>
                <div class="stat-label">完成率</div>
              </div>
              <div class="stat-item">
                <div class="stat-value" id="totalDuration">0</div>
                <div class="stat-label">总时长(分钟)</div>
              </div>
              <div class="stat-item">
                <div class="stat-value" id="completedDays">0</div>
                <div class="stat-label">完成天数</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 训练计划管理 -->
      <div class="fitness-card">
        <div class="fitness-card-header">
          <i class="fas fa-clipboard-list"></i>
          <h3>训练计划管理</h3>
          <button class="plan-action-btn" onclick="openTrainingPlanEditor()" title="创建新计划">
            <i class="fas fa-plus"></i>
          </button>
        </div>
        <div class="fitness-card-content">
          <div class="plan-management-section">
            <div class="plan-library-header">
              <h4>我的计划库</h4>
              <button class="refresh-plans-btn" onclick="refreshPlanLibrary()" title="刷新计划库">
                <i class="fas fa-sync-alt"></i>
              </button>
            </div>
            <div class="plan-library-container" id="planLibraryContainer">
              <div class="loading-message">正在加载计划库...</div>
            </div>
          </div>
          
          <div class="plan-stats" id="planStats">
            <div class="stat-item">
              <span class="stat-label">保存的计划:</span>
              <span class="stat-value" id="totalPlansCount">0</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">激活计划:</span>
              <span class="stat-value" id="activePlanName">无</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">计划完成度:</span>
              <span class="stat-value" id="planCompletionRate">0%</span>
            </div>
          </div>
        </div>
      </div>

      <!-- 健身社区 -->
      <div class="fitness-card">
        <div class="fitness-card-header">
          <i class="fas fa-users"></i>
          <h3 data-zh="健身社区" data-en="Fitness Community">健身社区</h3>
          <button class="community-btn" onclick="openFitnessCommunity()" data-zh="进入社区" data-en="Join Community">
            <i class="fas fa-arrow-right"></i> 进入社区
          </button>
        </div>
        <div class="fitness-card-content">
          <div class="community-preview">
            <div class="community-stats">
              <div class="stat-item">
                <div class="stat-value" id="communityMembers">0</div>
                <div class="stat-label">社区成员</div>
              </div>
              <div class="stat-item">
                <div class="stat-value" id="communityPosts">0</div>
                <div class="stat-label">今日动态</div>
              </div>
              <div class="stat-item">
                <div class="stat-value" id="communityLikes">0</div>
                <div class="stat-label">今日点赞</div>
              </div>
            </div>
            <div class="community-features">
              <div class="feature-item">
                <i class="fas fa-share-alt"></i>
                <span>分享训练成果</span>
              </div>
              <div class="feature-item">
                <i class="fas fa-trophy"></i>
                <span>展示成就徽章</span>
              </div>
              <div class="feature-item">
                <i class="fas fa-users"></i>
                <span>关注健身达人</span>
              </div>
              <div class="feature-item">
                <i class="fas fa-comments"></i>
                <span>交流训练心得</span>
              </div>
            </div>
            <div class="community-actions">
              <button class="action-btn primary" onclick="openFitnessCommunity()">
                <i class="fas fa-users"></i> 浏览社区
              </button>
              <button class="action-btn secondary" onclick="openFitnessProfile()">
                <i class="fas fa-user"></i> 个人档案
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- 健身工具 -->
      <div class="fitness-card">
        <div class="fitness-card-header">
          <i class="fas fa-tools"></i>
          <h3 data-zh="健身工具" data-en="Fitness Tools">健身工具</h3>
          <button class="tools-btn" onclick="openFitnessTools()" data-zh="更多工具" data-en="More Tools">
            <i class="fas fa-arrow-right"></i> 更多工具
          </button>
        </div>
        <div class="fitness-card-content">
          <div class="tools-grid">
            <div class="tool-item" onclick="openFitnessTools()">
              <i class="fas fa-stopwatch"></i>
              <span>训练计时器</span>
            </div>
            <div class="tool-item" onclick="openFitnessTools()">
              <i class="fas fa-calculator"></i>
              <span>营养计算器</span>
            </div>
            <div class="tool-item" onclick="openFitnessTools()">
              <i class="fas fa-chart-line"></i>
              <span>进度追踪</span>
            </div>
            <div class="tool-item" onclick="openFitnessTools()">
              <i class="fas fa-dumbbell"></i>
              <span>动作库</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.fitness-container {
  min-height: 100vh;
  background: var(--rage-bg, linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%));
  padding: 20px;
  position: relative;
}

.fitness-header {
  text-align: center;
  margin-bottom: 40px;
  padding: 40px 0;
}

.fitness-title {
  font-size: 3rem;
  font-weight: 900;
  color: var(--rage-primary, #ff6b35);
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 20px;
  text-shadow: 0 0 20px rgba(255, 107, 53, 0.5);
}

.fitness-title i {
  font-size: 2.5rem;
  animation: pulse 2s infinite;
}

.fitness-subtitle {
  font-size: 1.2rem;
  color: var(--rage-text-muted, #a8a8a8);
  font-family: var(--rage-font-mono, 'JetBrains Mono', monospace);
  text-transform: uppercase;
  letter-spacing: 2px;
}

.fitness-main {
  max-width: 1400px;
  margin: 0 auto;
}

.fitness-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 30px;
}

.fitness-card {
  background: var(--rage-gradient-card, linear-gradient(135deg, rgba(26,26,46,0.9) 0%, rgba(22,33,62,0.9) 100%));
  border: 2px solid var(--rage-border, rgba(255, 107, 53, 0.3));
  border-radius: 16px;
  overflow: hidden;
  transition: all 0.3s ease;
  position: relative;
}

.fitness-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 15px 35px rgba(255, 107, 53, 0.3);
  border-color: var(--rage-primary, #ff6b35);
}

.fitness-card-header {
  background: var(--rage-gradient, linear-gradient(135deg, #ff6b35 0%, #f7931e 100%));
  color: #000;
  padding: 20px;
  display: flex;
  align-items: center;
  gap: 15px;
}

.fitness-card-header i {
  font-size: 1.5rem;
}

.fitness-card-header h3 {
  margin: 0;
  font-weight: 700;
  font-size: 1.3rem;
}

.fitness-card-content {
  padding: 25px;
}

/* 训练计划样式 */
.workout-plan {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.plan-day {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 15px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 8px;
  border: 1px solid rgba(255, 107, 53, 0.2);
  transition: all 0.3s ease;
  cursor: pointer;
}

.plan-day:hover {
  background: rgba(255, 107, 53, 0.1);
  border-color: var(--rage-primary, #ff6b35);
}

.plan-day.active {
  background: var(--rage-primary, #ff6b35);
  color: #000;
  font-weight: 600;
}

.plan-day.today {
  border: 2px solid #4CAF50;
  background: linear-gradient(45deg, rgba(76, 175, 80, 0.1), rgba(76, 175, 80, 0.2));
  animation: todayPulse 2s ease-in-out infinite;
}

.plan-day.today.active {
  background: linear-gradient(45deg, #4CAF50, #66BB6A);
  color: white;
  border: 2px solid #388E3C;
}

@keyframes todayPulse {
  0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.4); }
  70% { box-shadow: 0 0 0 8px rgba(76, 175, 80, 0); }
  100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
}

.plan-type {
  font-size: 0.9rem;
  opacity: 0.8;
  font-weight: 600;
  flex: 1;
  text-align: center;
}

/* 新增的训练计划样式 */
.current-plan-preview {
  width: 100%;
}

.plan-info {
  text-align: center;
  margin-bottom: 20px;
  padding: 15px;
  background: rgba(255, 107, 53, 0.1);
  border-radius: 8px;
  border: 1px solid rgba(255, 107, 53, 0.3);
}

.plan-info h4 {
  color: var(--rage-primary, #ff6b35);
  margin: 0 0 5px 0;
  font-size: 1.1rem;
}

.plan-info p {
  color: var(--rage-text-muted, #a8a8a8);
  margin: 0;
  font-size: 0.9rem;
}

.edit-plan-btn {
  background: var(--rage-primary, #ff6b35);
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.9rem;
  font-weight: 600;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 6px;
}

.edit-plan-btn:hover {
  background: var(--rage-secondary, #ff5722);
  transform: translateY(-2px);
}

.fitness-card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.plan-exercises {
  font-size: 0.8rem;
  color: var(--rage-text-muted, #a8a8a8);
  font-style: italic;
}

.plan-actions {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.action-btn {
  flex: 1;
  min-width: 120px;
  padding: 10px 15px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.9rem;
  font-weight: 600;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}

.action-btn.primary {
  background: var(--rage-primary, #ff6b35);
  color: white;
}

.action-btn.primary:hover {
  background: var(--rage-secondary, #ff5722);
  transform: translateY(-2px);
}

.action-btn.enhanced {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  font-weight: bold;
}

.action-btn.enhanced:hover {
  background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}

.action-btn.secondary {
  background: rgba(255, 255, 255, 0.1);
  color: var(--rage-text, #e6e6e6);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.action-btn.secondary:hover {
  background: rgba(255, 255, 255, 0.2);
  border-color: rgba(255, 255, 255, 0.3);
}

/* 计时器样式 */
.timer-display {
  text-align: center;
}

.timer-time {
  font-size: 3rem;
  font-weight: 900;
  color: var(--rage-primary, #ff6b35);
  font-family: var(--rage-font-mono, 'JetBrains Mono', monospace);
  margin-bottom: 20px;
  text-shadow: 0 0 10px rgba(255, 107, 53, 0.5);
}

.timer-controls {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin-bottom: 20px;
}

.timer-btn {
  padding: 12px 24px;
  border: 2px solid var(--rage-primary, #ff6b35);
  background: transparent;
  color: var(--rage-primary, #ff6b35);
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
  font-family: var(--rage-font-mono, 'JetBrains Mono', monospace);
}

.timer-btn:hover {
  background: var(--rage-primary, #ff6b35);
  color: #000;
  transform: translateY(-2px);
}

.timer-presets {
  display: flex;
  gap: 10px;
  justify-content: center;
  flex-wrap: wrap;
}

.preset-btn {
  padding: 8px 16px;
  border: 1px solid rgba(255, 107, 53, 0.3);
  background: rgba(255, 107, 53, 0.1);
  color: var(--rage-text, #e6e6e6);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 0.9rem;
}

.preset-btn:hover {
  background: var(--rage-primary, #ff6b35);
  color: #000;
}

/* 运动记录样式 */
.workout-log {
  margin-bottom: 20px;
}

.log-entry {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
  border-bottom: 1px solid rgba(255, 107, 53, 0.2);
}

.log-entry:last-child {
  border-bottom: none;
}

.log-date {
  color: var(--rage-text-muted, #a8a8a8);
  font-size: 0.9rem;
}

.log-workout {
  color: var(--rage-primary, #ff6b35);
  font-weight: 600;
}

.log-duration {
  color: var(--rage-text, #e6e6e6);
  font-size: 0.9rem;
}

.add-log-btn {
  width: 100%;
  padding: 12px;
  background: var(--rage-primary, #ff6b35);
  color: #000;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
}

.add-log-btn:hover {
  background: #e55a2b;
  transform: translateY(-2px);
}

/* 营养计算器样式 */
.nutrition-calc {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.calc-input {
  display: flex;
  flex-direction: column;
  gap: 5px;
}

.calc-input label {
  color: var(--rage-text, #e6e6e6);
  font-weight: 600;
  font-size: 0.9rem;
}

.calc-input input,
.calc-input select {
  padding: 10px;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 107, 53, 0.3);
  border-radius: 6px;
  color: var(--rage-text, #e6e6e6);
  font-family: var(--rage-font-mono, 'JetBrains Mono', monospace);
}

.calc-input input:focus,
.calc-input select:focus {
  outline: none;
  border-color: var(--rage-primary, #ff6b35);
}

.calc-btn {
  padding: 12px;
  background: var(--rage-primary, #ff6b35);
  color: #000;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
}

.calc-btn:hover {
  background: #e55a2b;
  transform: translateY(-2px);
}

.calc-result {
  padding: 15px;
  background: rgba(255, 107, 53, 0.1);
  border: 1px solid rgba(255, 107, 53, 0.3);
  border-radius: 8px;
  color: var(--rage-primary, #ff6b35);
  font-weight: 600;
  text-align: center;
  display: none;
}

/* 视频网格样式 */
 

/* 成就系统样式 */
.achievements {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.achievement {
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 15px;
  border-radius: 8px;
  transition: all 0.3s ease;
}

.achievement.unlocked {
  background: rgba(255, 107, 53, 0.1);
  border: 1px solid rgba(255, 107, 53, 0.3);
}

.achievement.locked {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  opacity: 0.5;
}

.achievement i {
  font-size: 1.5rem;
  color: var(--rage-primary, #ff6b35);
}

.achievement.locked i {
  color: var(--rage-text-muted, #a8a8a8);
}

.achievement-info {
  flex: 1;
}

.achievement-title {
  color: var(--rage-text, #e6e6e6);
  font-weight: 600;
  margin-bottom: 3px;
}

.achievement-desc {
  color: var(--rage-text-muted, #a8a8a8);
  font-size: 0.9rem;
}

.achievement-progress {
  margin-top: 8px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 4px;
  height: 6px;
  overflow: hidden;
}

.achievement-progress-bar {
  height: 100%;
  background: var(--rage-primary, #ff6b35);
  transition: width 0.3s ease;
}

.achievement-meta {
  text-align: right;
  font-size: 0.8rem;
  color: var(--rage-text-muted, #a8a8a8);
}

.loading-message {
  text-align: center;
  color: var(--rage-text-muted, #a8a8a8);
  padding: 20px;
}

.achievement-stats {
  display: flex;
  justify-content: space-between;
  margin-top: 20px;
  padding: 15px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 8px;
}

.stat-item {
  text-align: center;
}

.stat-label {
  display: block;
  color: var(--rage-text-muted, #a8a8a8);
  font-size: 0.8rem;
  margin-bottom: 5px;
}

.stat-value {
  color: var(--rage-primary, #ff6b35);
  font-weight: 600;
  font-size: 1.1rem;
}

.timer-input {
  margin-bottom: 15px;
  text-align: center;
}

.timer-input label {
  display: block;
  color: var(--rage-text-muted, #a8a8a8);
  margin-bottom: 8px;
  font-size: 0.9rem;
}

.timer-input input {
  width: 120px;
  padding: 8px 12px;
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 6px;
  background: rgba(255, 255, 255, 0.1);
  color: var(--rage-text, #e6e6e6);
  text-align: center;
  margin-right: 10px;
}

.timer-input button {
  padding: 8px 16px;
  background: var(--rage-primary, #ff6b35);
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
}

.timer-input button:hover {
  background: var(--rage-secondary, #ff5722);
}



/* 动画 */
@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

/* 响应式设计 - 优化按钮显示 */
@media (max-width: 768px) {
  .fitness-grid {
    grid-template-columns: 1fr;
  }
  
  .fitness-title {
    font-size: 2rem;
  }
  
  .timer-time {
    font-size: 2rem;
  }
  
  .timer-controls {
    flex-direction: column;
    gap: 8px;
  }
  
  .timer-btn {
    padding: 10px 20px;
    font-size: 0.9rem;
  }
  
  .timer-presets {
    gap: 6px;
  }
  
  .preset-btn {
    padding: 6px 12px;
    font-size: 0.8rem;
  }
  
  
}

@media (max-width: 480px) {
  .timer-controls {
    gap: 6px;
  }
  
  .timer-btn {
    padding: 8px 16px;
    font-size: 0.85rem;
  }
  
  .timer-presets {
    gap: 4px;
  }
  
  .preset-btn {
    padding: 5px 10px;
    font-size: 0.75rem;
  }
  
  .fitness-container {
    padding: 10px;
  }
  
  .fitness-card-content {
    padding: 15px;
  }
}

@media (max-width: 360px) {
  .timer-controls {
    gap: 4px;
  }
  
  .timer-btn {
    padding: 6px 12px;
    font-size: 0.8rem;
  }
  
  .timer-presets {
    gap: 3px;
  }
  
  .preset-btn {
    padding: 4px 8px;
    font-size: 0.7rem;
  }
  
  .fitness-container {
    padding: 5px;
  }
  
  .fitness-card-content {
    padding: 10px;
  }
}

/* 快捷键提示样式 */
.theme-switch-hint {
  position: fixed;
  top: 20px;
  left: 20px;
  z-index: 1000;
  background: rgba(255,255,255,0.95);
  padding: 12px 16px;
  border-radius: 8px;
  border: 1px solid rgba(102, 126, 234, 0.3);
  backdrop-filter: blur(10px);
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
}

.theme-switch-hint:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(0,0,0,0.15);
}

.hint-content {
  display: flex;
  align-items: center;
  gap: 8px;
  font-family: 'Arial', sans-serif;
  font-size: 0.9rem;
  color: #667eea;
  font-weight: 600;
}

.hint-content i {
  font-size: 1rem;
  color: #764ba2;
}

.hint-content span {
  white-space: nowrap;
}

.help-btn {
  background: rgba(102, 126, 234, 0.1);
  border: 1px solid rgba(102, 126, 234, 0.3);
  color: #667eea;
  border-radius: 4px;
  padding: 4px 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  margin-left: 8px;
}

.help-btn:hover {
  background: rgba(102, 126, 234, 0.2);
  transform: scale(1.1);
}

/* 快捷键帮助按钮样式 */
.shortcuts-help-btn {
  position: fixed;
  top: 20px;
  right: 20px;
  background: var(--rage-gradient, linear-gradient(135deg, #ff6b35 0%, #f7931e 100%));
  border: none;
  color: #000;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2rem;
  box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
  transition: all 0.3s ease;
  z-index: 1000;
}

.shortcuts-help-btn:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
}

/* 快捷键帮助面板样式 */
.shortcuts-help-panel {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.8);
  background: rgba(255,255,255,0.98);
  border-radius: 16px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  backdrop-filter: blur(20px);
  border: 1px solid rgba(102, 126, 234, 0.2);
  z-index: 10000;
  max-width: 500px;
  width: 90%;
  max-height: 80vh;
  overflow: hidden;
  opacity: 0;
  visibility: hidden;
  transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.shortcuts-help-panel.show {
  opacity: 1;
  visibility: visible;
  transform: translate(-50%, -50%) scale(1);
}

.help-panel-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-radius: 16px 16px 0 0;
}

.help-panel-header h3 {
  margin: 0;
  font-size: 1.2rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 10px;
}

.close-help-btn {
  background: rgba(255,255,255,0.2);
  border: none;
  color: white;
  border-radius: 50%;
  width: 32px;
  height: 32px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.close-help-btn:hover {
  background: rgba(255,255,255,0.3);
  transform: scale(1.1);
}

.help-panel-content {
  padding: 20px;
  max-height: 60vh;
  overflow-y: auto;
}

.shortcuts-section {
  margin-bottom: 25px;
}

.shortcuts-section h4 {
  color: #667eea;
  font-size: 1rem;
  font-weight: 600;
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  gap: 8px;
  border-bottom: 2px solid rgba(102, 126, 234, 0.2);
  padding-bottom: 8px;
}

.shortcut-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 0;
  border-bottom: 1px solid rgba(0,0,0,0.05);
  transition: all 0.3s ease;
}

.shortcut-item:hover {
  background: rgba(102, 126, 234, 0.05);
  padding-left: 10px;
  border-radius: 6px;
}

.shortcut-key {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 6px 12px;
  border-radius: 6px;
  font-family: 'Courier New', monospace;
  font-weight: 600;
  font-size: 0.85rem;
  min-width: 80px;
  text-align: center;
  box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
}

.shortcut-desc {
  color: #333;
  font-weight: 500;
  flex: 1;
  margin-left: 15px;
}

/* 遮罩层 */
.help-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 9999;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
}

.help-overlay.show {
  opacity: 1;
  visibility: visible;
}

/* 打卡日历样式 */
.checkin-calendar-container {
  padding: 20px;
}

.calendar-nav {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 20px;
  gap: 10px;
}

.nav-btn {
  background: var(--rage-gradient, linear-gradient(135deg, #ff6b35 0%, #f7931e 100%));
  border: none;
  color: #000;
  padding: 8px 12px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  transition: all 0.3s ease;
}

.nav-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(255, 107, 53, 0.4);
}

.today-btn {
  background: var(--rage-primary, #ff6b35);
  color: white;
}

.current-month {
  font-size: 1.2rem;
  font-weight: bold;
  color: var(--rage-primary, #ff6b35);
  text-align: center;
  flex: 1;
}

.streak-info {
  display: flex;
  justify-content: space-around;
  margin-bottom: 20px;
  padding: 15px;
  background: rgba(255, 107, 53, 0.1);
  border-radius: 10px;
  border: 1px solid rgba(255, 107, 53, 0.3);
}

.streak-item {
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--rage-primary, #ff6b35);
  font-weight: bold;
}

.streak-item i {
  font-size: 1.2rem;
  animation: flame 1.5s ease-in-out infinite alternate;
}

@keyframes flame {
  0% { transform: scale(1); }
  100% { transform: scale(1.1); }
}

.calendar-grid {
  margin-bottom: 20px;
}

.calendar-header {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 2px;
  margin-bottom: 10px;
}

.calendar-header > div {
  text-align: center;
  font-weight: bold;
  color: var(--rage-primary, #ff6b35);
  padding: 10px;
  font-size: 0.9rem;
}

.calendar-body {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 2px;
}

.calendar-day {
  aspect-ratio: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 107, 53, 0.2);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-weight: bold;
  position: relative;
  overflow: hidden;
}

.calendar-day:hover {
  background: rgba(255, 107, 53, 0.2);
  transform: scale(1.05);
  z-index: 2;
}

.calendar-day.other-month {
  opacity: 0.3;
  background: rgba(255, 255, 255, 0.02);
}

.calendar-day.today {
  background: var(--rage-gradient, linear-gradient(135deg, #ff6b35 0%, #f7931e 100%));
  color: #000;
  border-color: var(--rage-primary, #ff6b35);
  box-shadow: 0 0 15px rgba(255, 107, 53, 0.5);
}

.calendar-day.completed {
  background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
  color: white;
  border-color: #28a745;
}

.calendar-day.completed::after {
  content: '✓';
  position: absolute;
  top: 2px;
  right: 2px;
  font-size: 0.8rem;
  color: white;
}

.calendar-day.rest {
  background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
  color: white;
  border-color: #6c757d;
}

.calendar-day.rest::after {
  content: '😴';
  position: absolute;
  top: 2px;
  right: 2px;
  font-size: 0.8rem;
}

.monthly-stats {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 15px;
  margin-top: 20px;
}

.stat-item {
  text-align: center;
  padding: 15px;
  background: rgba(255, 107, 53, 0.1);
  border-radius: 10px;
  border: 1px solid rgba(255, 107, 53, 0.3);
}

.stat-value {
  font-size: 1.5rem;
  font-weight: bold;
  color: var(--rage-primary, #ff6b35);
  margin-bottom: 5px;
}

.stat-label {
  font-size: 0.9rem;
  color: var(--rage-text-muted, #a8a8a8);
}

/* 打卡模态框样式 */
.checkin-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  backdrop-filter: blur(5px);
}

.checkin-modal-content {
  background: var(--rage-gradient-card, linear-gradient(135deg, rgba(26,26,46,0.95) 0%, rgba(22,33,62,0.95) 100%));
  border: 2px solid var(--rage-border, rgba(255, 107, 53, 0.3));
  border-radius: 16px;
  padding: 30px;
  max-width: 500px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  color: white;
}

.checkin-modal-content h3 {
  color: var(--rage-primary, #ff6b35);
  margin-bottom: 20px;
  text-align: center;
  font-size: 1.5rem;
}

.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  color: var(--rage-text-muted, #a8a8a8);
  font-weight: bold;
}

.form-group input,
.form-group select,
.form-group textarea {
  width: 100%;
  padding: 12px;
  border: 1px solid rgba(255, 107, 53, 0.3);
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.1);
  color: white;
  font-size: 14px;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
  outline: none;
  border-color: var(--rage-primary, #ff6b35);
  box-shadow: 0 0 10px rgba(255, 107, 53, 0.3);
}

.form-group input::placeholder,
.form-group textarea::placeholder {
  color: rgba(255, 255, 255, 0.5);
}

/* 训练部位选择样式 */
.training-parts-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
  gap: 10px;
  margin-top: 8px;
}

.checkbox-label {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  border: 1px solid rgba(255, 107, 53, 0.3);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 14px;
  background: rgba(255, 255, 255, 0.05);
  color: white;
}

.checkbox-label:hover {
  border-color: var(--rage-primary, #ff6b35);
  background: rgba(255, 107, 53, 0.1);
}

.checkbox-label input[type="checkbox"]:checked + span {
  color: var(--rage-primary, #ff6b35);
  font-weight: 600;
}

.checkbox-label input[type="checkbox"] {
  margin: 0;
  accent-color: var(--rage-primary, #ff6b35);
}

/* 星级评分样式 */
.rating-container {
  margin-top: 8px;
}

.star-rating {
  display: flex;
  flex-direction: row-reverse;
  gap: 2px;
}

.star-rating input[type="radio"] {
  display: none;
}

.star-rating label {
  font-size: 24px;
  color: rgba(255, 255, 255, 0.3);
  cursor: pointer;
  transition: color 0.3s ease;
}

.star-rating label:hover,
.star-rating label:hover ~ label,
.star-rating input[type="radio"]:checked ~ label {
  color: #ffd700;
}

.star-rating input[type="radio"]:checked ~ label {
  color: #ffd700;
}

.checkin-detail {
  background: rgba(255, 255, 255, 0.05);
  padding: 20px;
  border-radius: 10px;
  margin-bottom: 20px;
}

.checkin-detail p {
  margin-bottom: 10px;
  line-height: 1.6;
}

.checkin-detail strong {
  color: var(--rage-primary, #ff6b35);
}

.form-actions {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
  margin-top: 20px;
}

.btn-cancel,
.btn-submit,
.btn-edit,
.btn-delete {
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  transition: all 0.3s ease;
}

.btn-cancel {
  background: rgba(255, 255, 255, 0.1);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.3);
}

.btn-submit,
.btn-edit {
  background: var(--rage-gradient, linear-gradient(135deg, #ff6b35 0%, #f7931e 100%));
  color: #000;
}

.btn-delete {
  background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
  color: white;
}

.btn-cancel:hover,
.btn-submit:hover,
.btn-edit:hover,
.btn-delete:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

/* 响应式设计 */
@media (max-width: 768px) {
  .calendar-nav {
    flex-wrap: wrap;
    gap: 5px;
  }
  
  .nav-btn {
    padding: 6px 10px;
    font-size: 0.9rem;
  }
  
  .current-month {
    font-size: 1rem;
    order: -1;
    width: 100%;
    margin-bottom: 10px;
  }
  
  .streak-info {
    flex-direction: column;
    gap: 10px;
  }
  
  .monthly-stats {
    grid-template-columns: 1fr;
  }
  
  .checkin-modal-content {
    padding: 20px;
    margin: 20px;
  }
  
  .form-actions {
    flex-direction: column;
  }
}

.community-preview {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.community-stats {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 15px;
}

.community-features {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 15px;
}

.feature-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px;
  background: rgba(255, 107, 53, 0.1);
  border-radius: 8px;
  border: 1px solid rgba(255, 107, 53, 0.3);
}

.feature-item i {
  color: var(--rage-primary, #ff6b35);
  font-size: 1.2rem;
}

.feature-item span {
  color: var(--rage-text, #e6e6e6);
  font-size: 0.9rem;
}

.community-actions {
  display: flex;
  gap: 10px;
  justify-content: center;
}

/* 健身工具样式 */
.tools-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 15px;
}

.tool-item {
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
  padding: 20px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 8px;
  border: 1px solid rgba(255, 107, 53, 0.2);
}

.tool-item:hover {
  transform: translateY(-3px);
  background: rgba(255, 107, 53, 0.1);
  border-color: var(--rage-primary, #ff6b35);
}

.tool-item i {
  font-size: 2rem;
  color: var(--rage-primary, #ff6b35);
  margin-bottom: 10px;
  display: block;
}

.tool-item span {
  font-size: 0.9rem;
  color: var(--rage-text, #e6e6e6);
  font-weight: 600;
}

/* 按钮样式 */
.community-btn,
.tools-btn {
  background: var(--rage-primary, #ff6b35);
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.9rem;
  font-weight: 600;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 6px;
}

.community-btn:hover,
.tools-btn:hover {
  background: var(--rage-secondary, #ff5722);
  transform: translateY(-2px);
}

/* 训练计划管理样式 */
.plan-management-section {
  margin-bottom: 20px;
}

.plan-library-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  padding-bottom: 10px;
  border-bottom: 1px solid #eee;
}

.plan-library-header h4 {
  margin: 0;
  color: var(--rage-text, #fff);
  font-size: 1.1rem;
}

.refresh-plans-btn, .plan-action-btn {
  background: var(--rage-primary, #ff6b35);
  color: white;
  border: none;
  border-radius: 6px;
  padding: 8px 12px;
  cursor: pointer;
  font-size: 0.9rem;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 5px;
}

.refresh-plans-btn:hover, .plan-action-btn:hover {
  background: var(--rage-secondary, #e55a2b);
  transform: translateY(-1px);
}

.plan-library-container {
  max-height: 300px;
  overflow-y: auto;
  border: 1px solid var(--rage-border, #333);
  border-radius: 8px;
  padding: 10px;
  background: var(--rage-surface, rgba(255, 255, 255, 0.05));
}

.plan-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  margin-bottom: 8px;
  border-radius: 8px;
  background: var(--rage-card-bg, rgba(255, 255, 255, 0.1));
  border-left: 4px solid var(--rage-border, #666);
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
}

.plan-item.active {
  background: linear-gradient(135deg, rgba(40, 167, 69, 0.2), rgba(40, 167, 69, 0.1));
  border-left-color: var(--rage-success, #28a745);
  box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
}

.plan-item:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 8px var(--rage-glow, rgba(255, 107, 53, 0.2));
  background: var(--rage-hover, rgba(255, 255, 255, 0.15));
}

.plan-info {
  flex: 1;
}

.plan-name {
  font-weight: 600;
  margin-bottom: 4px;
  color: var(--rage-text, #fff);
}

.plan-details {
  font-size: 0.9rem;
  color: var(--rage-text-muted, #ccc);
  display: flex;
  gap: 15px;
}

.plan-actions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.plan-btn {
  padding: 6px 12px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.8rem;
  transition: all 0.3s ease;
  font-weight: 500;
}

.plan-btn.edit {
  background: var(--rage-info, #17a2b8);
  color: white;
}

.plan-btn.edit:hover {
  background: var(--rage-info-dark, #138496);
}

.plan-btn.apply {
  background: var(--rage-success, #28a745);
  color: white;
}

.plan-btn.apply:hover {
  background: var(--rage-success-dark, #218838);
}

.plan-btn.preview {
  background: var(--rage-secondary-alt, #6c757d);
  color: white;
}

.plan-btn.preview:hover {
  background: var(--rage-secondary-alt-dark, #545b62);
}

.plan-btn.delete {
  background: var(--rage-danger, #dc3545);
  color: white;
}

.plan-btn.delete:hover {
  background: var(--rage-danger-dark, #c82333);
}

.no-plans-message {
  text-align: center;
  color: var(--rage-text-muted, #ccc);
  font-style: italic;
  padding: 20px;
}
</style>

<script>
// 快捷键支持
document.addEventListener('keydown', function(e) {
  // 只在非输入框中响应快捷键
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
    return;
  }
  
  // Ctrl/Cmd + 数字键切换主题
  if ((e.ctrlKey || e.metaKey) && !e.shiftKey && !e.altKey) {
    switch(e.key) {
      case '1':
        e.preventDefault();
        window.location.href = '/tools/life_diary/';
        break;
      case '2':
        e.preventDefault();
        window.location.href = '/tools/creative_writer/';
        break;
      case '3':
        e.preventDefault();
        window.location.href = '/tools/fitness/';
        break;
      case '4':
        e.preventDefault();
        window.location.href = '/tools/emo_diary/';
        break;
    }
  }
  
  // Alt + 字母键跳转到工具页面
  if (e.altKey && !e.ctrlKey && !e.metaKey && !e.shiftKey) {
    switch(e.key.toLowerCase()) {
      case 'e':
        e.preventDefault();
        window.location.href = '/tools/emo_diary/';
        break;
      case 'l':
        e.preventDefault();
        window.location.href = '/tools/life_diary/';
        break;
      case 'f':
        e.preventDefault();
        window.location.href = '/tools/fitness/';
        break;
      case 'c':
        e.preventDefault();
        window.location.href = '/tools/creative_writer/';
        break;
      case 'p':
        e.preventDefault();
        window.location.href = '/tools/pdf_converter/';
        break;
      case 'r':
        e.preventDefault();
        // window.location.href = '/tools/redbook_generator/'; // 已隐藏
        break;
      case 't':
        e.preventDefault();
        window.location.href = '/tools/test_case_generator/';
        break;
      case 'w':
        e.preventDefault();
        window.location.href = '/tools/web_crawler/';
        break;
      case 's':
        e.preventDefault();
        window.location.href = '{% url "tools:self_analysis" %}';
        break;
      case 'b':
        e.preventDefault();
        window.location.href = '/tools/storyboard/';
        break;
      case 'm':
        e.preventDefault();
        window.location.href = '/tools/music_healing/';
        break;
      case 'd':
        e.preventDefault();
        window.location.href = '/tools/meditation_guide/';
        break;
      case 'a':
        e.preventDefault();
        window.location.href = '/tools/fortune_analyzer/';
        break;
    }
  }
});

// 初始化快捷键帮助面板
function initShortcutsHelp() {
  const helpBtn = document.getElementById('showShortcutsHelp');
  const helpPanel = document.getElementById('shortcutsHelpPanel');
  const closeBtn = document.getElementById('closeShortcutsHelp');
  const overlay = document.getElementById('helpOverlay');
  
  // 检查元素是否存在
  if (!helpBtn || !helpPanel || !closeBtn || !overlay) {
    console.warn('快捷键帮助面板元素未找到，跳过初始化');
    return;
  }
  
  // 显示帮助面板
  helpBtn.addEventListener('click', function() {
    helpPanel.classList.add('show');
    overlay.classList.add('show');
    document.body.style.overflow = 'hidden'; // 防止背景滚动
  });
  
  // 关闭帮助面板
  function closeHelpPanel() {
    helpPanel.classList.remove('show');
    overlay.classList.remove('show');
    document.body.style.overflow = ''; // 恢复滚动
  }
  
  closeBtn.addEventListener('click', closeHelpPanel);
  overlay.addEventListener('click', closeHelpPanel);
  
  // ESC键关闭帮助面板
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && helpPanel.classList.contains('show')) {
      closeHelpPanel();
    }
  });
}

// 初始化当前训练计划
async function initCurrentPlan() {
  try {
    const response = await fetch('/tools/api/training_plans/active/');
    const data = await response.json();
    
    if (data.success && data.has_plan) {
      renderActivePlan(data.plan);
    } else {
      renderNoPlan();
    }
  } catch (error) {
    console.error('加载当前计划失败:', error);
    renderNoPlan();
  }
}

// 渲染激活的训练计划
function renderActivePlan(plan) {
  const planContainer = document.getElementById('workoutPlan');
  if (!planContainer) return;
  
  const planPreview = document.querySelector('.current-plan-preview');
  if (planPreview) {
    planPreview.innerHTML = `
      <h4>当前计划：${plan.name}</h4>
      <p>${plan.mode} • ${plan.cycle_weeks}周周期</p>
    `;
  }
  
  // 渲染周计划 - 只显示今天的训练
  if (plan.week_schedule && Array.isArray(plan.week_schedule)) {
    // 获取当前星期几（0=周日, 1=周一, ..., 6=周六）
    const today = new Date();
    const currentDayOfWeek = today.getDay();
    const weekdays = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
    const currentWeekday = weekdays[currentDayOfWeek];
    
    // 找到今天的训练计划
    let todaysPlan = null;
    let todaysIndex = -1;
    
    for (let i = 0; i < plan.week_schedule.length; i++) {
      const day = plan.week_schedule[i];
      const dayWeekday = day.weekday || weekdays[i] || `第${i + 1}天`;
      if (dayWeekday === currentWeekday) {
        todaysPlan = day;
        todaysIndex = i;
        break;
      }
    }
    
    if (todaysPlan) {
      // 安全地获取day的属性
      const safeDay = {
        weekday: todaysPlan.weekday || currentWeekday,
        body_parts: Array.isArray(todaysPlan.body_parts) ? todaysPlan.body_parts : ['未设置'],
        exercises: todaysPlan.exercises || [],
        modules: todaysPlan.modules || {}
      };
      
      // 计算动作数量
      let exerciseCount = 0;
      if (safeDay.exercises && Array.isArray(safeDay.exercises)) {
        exerciseCount = safeDay.exercises.length;
      } else if (safeDay.modules) {
        exerciseCount = Object.values(safeDay.modules).reduce((sum, module) => sum + (Array.isArray(module) ? module.length : 0), 0);
      }
      
      const exerciseText = exerciseCount > 0 ? `${exerciseCount}个动作` : 
        (safeDay.body_parts.includes('休息') ? '恢复日' : '待添加');
      
      // 生成今天的详细动作列表
      let todaysExercisesList = '';
      if (safeDay.exercises && Array.isArray(safeDay.exercises) && safeDay.exercises.length > 0) {
        todaysExercisesList = safeDay.exercises.map((exercise, index) => {
          return `
            <div class="exercise-item" data-exercise-index="${index}" data-day-index="0" style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              padding: 15px;
              margin: 10px 0;
              background: linear-gradient(135deg, rgba(76, 175, 80, 0.05) 0%, rgba(76, 175, 80, 0.02) 100%);
              border: 1px solid rgba(76, 175, 80, 0.2);
              border-radius: 12px;
              border-left: 4px solid #4CAF50;
              box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
              transition: all 0.3s ease;
            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0, 0, 0, 0.12)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.08)'">
              <div class="exercise-info" style="flex: 1;">
                <div class="exercise-header" style="display: flex; align-items: center; margin-bottom: 8px;">
                  <div class="exercise-number" style="
                    background: #4CAF50;
                    color: white;
                    width: 24px;
                    height: 24px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 12px;
                    font-weight: bold;
                    margin-right: 12px;
                  ">${index + 1}</div>
                  <div class="exercise-name" style="font-weight: bold; color: white; font-size: 16px; line-height: 1.2; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">
                    ${exercise.name}
                  </div>
                </div>
                <div class="exercise-details" style="
                  color: #666;
                  font-size: 14px;
                  line-height: 1.4;
                  margin-left: 36px;
                  display: flex;
                  flex-wrap: wrap;
                  gap: 12px;
                ">
                  <span style="
                    background: rgba(76, 175, 80, 0.1);
                    padding: 4px 8px;
                    border-radius: 6px;
                    font-weight: 500;
                    color: #2E7D32;
                  ">
                    <i class="fas fa-repeat" style="margin-right: 4px;"></i>
                    ${exercise.sets || 3}组
                  </span>
                  <span style="
                    background: rgba(33, 150, 243, 0.1);
                    padding: 4px 8px;
                    border-radius: 6px;
                    font-weight: 500;
                    color: #1565C0;
                  ">
                    <i class="fas fa-times" style="margin-right: 4px;"></i>
                    ${exercise.reps || '10-12'}次
                  </span>
                  ${exercise.weight ? `
                    <span style="
                      background: rgba(255, 152, 0, 0.1);
                      padding: 4px 8px;
                      border-radius: 6px;
                      font-weight: 500;
                      color: #E65100;
                    ">
                      <i class="fas fa-dumbbell" style="margin-right: 4px;"></i>
                      ${exercise.weight}${(exercise.weight && (exercise.weight.toString().includes('kg') || /^(自重|空杆)$/.test(exercise.weight.toString()) || exercise.weight.toString().includes('杆'))) ? '' : 'kg'}
                    </span>
                  ` : ''}
                  ${exercise.rest ? `
                    <span style="
                      background: rgba(156, 39, 176, 0.1);
                      padding: 4px 8px;
                      border-radius: 6px;
                      font-weight: 500;
                      color: #7B1FA2;
                    ">
                      <i class="fas fa-clock" style="margin-right: 4px;"></i>
                      休息${exercise.rest}
                    </span>
                  ` : ''}
                </div>
              </div>
              <div class="exercise-actions" style="margin-left: 15px;">
                <button class="complete-btn" onclick="markExerciseDone(${index}, 0)" style="
                  background: linear-gradient(135deg, #4CAF50 0%, #45A049 100%);
                  color: white;
                  border: none;
                  padding: 8px 16px;
                  border-radius: 8px;
                  cursor: pointer;
                  font-size: 13px;
                  font-weight: 500;
                  box-shadow: 0 2px 6px rgba(76, 175, 80, 0.3);
                  transition: all 0.3s ease;
                  display: flex;
                  align-items: center;
                  gap: 6px;
                  min-width: 80px;
                  justify-content: center;
                " onmouseover="if(!this.classList.contains('completed')) { this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(76, 175, 80, 0.4)'; }" onmouseout="if(!this.classList.contains('completed')) { this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px rgba(76, 175, 80, 0.3)'; }">
                  <i class="fas fa-check"></i> 完成
                </button>
              </div>
            </div>
          `;
        }).join('');
      } else if (safeDay.body_parts.includes('休息')) {
        todaysExercisesList = `
          <div class="rest-day-message" style="
            text-align: center;
            padding: 30px 20px;
            background: linear-gradient(135deg, rgba(156, 39, 176, 0.05) 0%, rgba(156, 39, 176, 0.02) 100%);
            border: 1px solid rgba(156, 39, 176, 0.2);
            border-radius: 12px;
            color: #7B1FA2;
            font-style: italic;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
          ">
            <div style="font-size: 48px; margin-bottom: 15px;">😴</div>
            <div style="font-size: 18px; font-weight: 500; margin-bottom: 8px;">休息日</div>
            <div style="font-size: 14px; color: #999;">好好恢复体力，为明天的训练做准备</div>
          </div>
        `;
      } else {
        todaysExercisesList = `
          <div class="no-exercises-message" style="
            text-align: center;
            padding: 30px 20px;
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.05) 0%, rgba(255, 193, 7, 0.02) 100%);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 12px;
            color: #F57C00;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
          ">
            <div style="font-size: 48px; margin-bottom: 15px;">📝</div>
            <div style="font-size: 18px; font-weight: 500; margin-bottom: 8px;">待添加动作</div>
            <div style="font-size: 14px; color: #999; margin-bottom: 15px;">暂未安排具体训练动作</div>
            <button onclick="window.location.href='/tools/fitness/plan-editor/'" 
                    style="
                      padding: 10px 20px;
                      background: linear-gradient(135deg, #4CAF50 0%, #45A049 100%);
                      color: white;
                      border: none;
                      border-radius: 8px;
                      cursor: pointer;
                      font-size: 14px;
                      font-weight: 500;
                      box-shadow: 0 2px 6px rgba(76, 175, 80, 0.3);
                      transition: all 0.3s ease;
                    "
                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(76, 175, 80, 0.4)'"
                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px rgba(76, 175, 80, 0.3)'">
              <i class="fas fa-edit" style="margin-right: 6px;"></i> 编辑计划
            </button>
          </div>
        `;
      }
      
      planContainer.innerHTML = `
        <div class="today-plan-container">
          <div class="plan-day active today" data-day="${todaysIndex + 1}" onclick="showDayDetails(${todaysIndex})" style="margin-bottom: 15px;">
            <span>${safeDay.weekday} 🌟</span>
            <span class="plan-type">${safeDay.body_parts.join(' + ')}</span>
            <span class="plan-exercises">${exerciseText}</span>
          </div>
          
          <div class="today-exercises-details" style="margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin: 10px 0;">
              <h5 style="color: #333; margin: 0; font-size: 14px; font-weight: bold;">
                <i class="fas fa-dumbbell"></i> 今日训练详情
              </h5>
              <div class="training-progress" style="
                background: rgba(76, 175, 80, 0.1);
                padding: 4px 12px;
                border-radius: 12px;
                font-size: 12px;
                color: #4CAF50;
                font-weight: 500;
              ">
                训练进度: 0% (0/0)
              </div>
            </div>
            ${todaysExercisesList}
          </div>
          
          <div class="action-buttons" style="display: flex; gap: 10px;">
            <div class="view-full-plan-btn" onclick="showFullWeekPlan()" style="
              flex: 1;
              text-align: center;
              padding: 12px;
              background: rgba(76, 175, 80, 0.1);
              border: 1px dashed #4CAF50;
              border-radius: 8px;
              cursor: pointer;
              color: #4CAF50;
              font-size: 13px;
              transition: all 0.3s ease;
            ">
              <i class="fas fa-eye"></i> 查看完整周计划
            </div>
            <div class="export-today-btn" onclick="exportTodayPlan()" style="
              flex: 1;
              text-align: center;
              padding: 12px;
              background: rgba(33, 150, 243, 0.1);
              border: 1px dashed #2196F3;
              border-radius: 8px;
              cursor: pointer;
              color: #2196F3;
              font-size: 13px;
              transition: all 0.3s ease;
            ">
              <i class="fas fa-download"></i> 导出今日计划
            </div>
          </div>
        </div>
      `;
      
      // 延迟恢复完成状态
      setTimeout(() => {
        restoreExerciseCompletions();
      }, 100);
    } else {
      // 如果没有找到今天的计划，显示提示
      planContainer.innerHTML = `
        <div class="no-plan-today" style="
          text-align: center;
          padding: 20px;
          color: #666;
          background: rgba(0, 0, 0, 0.05);
          border-radius: 8px;
        ">
          <i class="fas fa-calendar-times" style="font-size: 24px; margin-bottom: 10px; color: #999;"></i>
          <p>今天没有安排训练</p>
          <button onclick="showFullWeekPlan()" class="btn-secondary" style="margin-top: 10px;">
            <i class="fas fa-eye"></i> 查看完整周计划
          </button>
        </div>
      `;
    }
  }
  
  // 重新绑定点击事件
  bindPlanDayEvents();
}

// 渲染无计划状态
function renderNoPlan() {
  const planContainer = document.getElementById('workoutPlan');
  if (!planContainer) return;
  
  const planPreview = document.querySelector('.current-plan-preview');
  if (planPreview) {
    planPreview.innerHTML = `
      <h4>暂无激活计划</h4>
      <p>选择模板或创建新计划开始训练</p>
    `;
  }
  
  // 显示默认的周计划布局
  planContainer.innerHTML = `
    <div class="plan-day" data-day="1">
      <span>周一</span>
      <span class="plan-type">待安排</span>
      <span class="plan-exercises">选择计划</span>
    </div>
    <div class="plan-day" data-day="2">
      <span>周二</span>
      <span class="plan-type">待安排</span>
      <span class="plan-exercises">选择计划</span>
    </div>
    <div class="plan-day" data-day="3">
      <span>周三</span>
      <span class="plan-type">待安排</span>
      <span class="plan-exercises">选择计划</span>
    </div>
    <div class="plan-day" data-day="4">
      <span>周四</span>
      <span class="plan-type">待安排</span>
      <span class="plan-exercises">选择计划</span>
    </div>
    <div class="plan-day" data-day="5">
      <span>周五</span>
      <span class="plan-type">待安排</span>
      <span class="plan-exercises">选择计划</span>
    </div>
    <div class="plan-day" data-day="6">
      <span>周六</span>
      <span class="plan-type">待安排</span>
      <span class="plan-exercises">选择计划</span>
    </div>
    <div class="plan-day" data-day="7">
      <span>周日</span>
      <span class="plan-type">待安排</span>
      <span class="plan-exercises">选择计划</span>
    </div>
  `;
  
  bindPlanDayEvents();
}

// 绑定计划天点击事件
function bindPlanDayEvents() {
  document.querySelectorAll('.plan-day').forEach(day => {
    day.addEventListener('click', function() {
      // 移除其他活动状态
      document.querySelectorAll('.plan-day').forEach(d => d.classList.remove('active'));
      // 添加当前活动状态
      this.classList.add('active');
    });
  });
}

// 显示某天的训练详情
async function showDayDetails(dayIndex) {
  try {
    const response = await fetch('/tools/api/training_plans/active/');
    const data = await response.json();
    
    if (data.success && data.has_plan && data.plan.week_schedule) {
      const dayData = data.plan.week_schedule[dayIndex];
      if (dayData) {
        showDayDetailsModal(dayData, dayIndex + 1);
      }
    } else {
      showNoPlanModal();
    }
  } catch (error) {
    console.error('获取训练详情失败:', error);
    alert('获取训练详情失败，请重试');
  }
}

// 显示完整周计划
async function showFullWeekPlan() {
  try {
    const response = await fetch('/tools/api/training_plans/active/');
    const data = await response.json();
    
    if (data.success && data.has_plan && data.plan) {
      showFullWeekPlanModal(data.plan);
    } else {
      showNoPlanModal();
    }
  } catch (error) {
    console.error('获取训练计划失败:', error);
    alert('获取训练计划失败，请重试');
  }
}

// 显示完整周计划模态框
function showFullWeekPlanModal(plan) {
  const modal = document.createElement('div');
  modal.className = 'checkin-modal';
  
  const weekdays = ['周一', '周二', '周三', '周四', '周五', '周六', '周日'];
  const today = new Date();
  const currentDayOfWeek = today.getDay();
  const currentWeekday = weekdays[currentDayOfWeek === 0 ? 6 : currentDayOfWeek - 1]; // 转换为周一开始
  
  let weekPlanHTML = '';
  if (plan.week_schedule && Array.isArray(plan.week_schedule)) {
    weekPlanHTML = plan.week_schedule.map((dayData, index) => {
      const dayName = weekdays[index] || dayData.weekday || `第${index + 1}天`;
      const isToday = dayName === currentWeekday;
      
      // 安全地获取训练部位
      let bodyParts = '未设置';
      if (dayData.body_parts && Array.isArray(dayData.body_parts)) {
        bodyParts = dayData.body_parts.join(' + ');
      } else if (dayData.type) {
        bodyParts = dayData.type;
      }
      
      // 计算动作数量
      let exerciseCount = 0;
      let exerciseText = '待添加';
      if (dayData.exercises && Array.isArray(dayData.exercises) && dayData.exercises.length > 0) {
        exerciseCount = dayData.exercises.length;
        exerciseText = `${exerciseCount}个动作`;
      } else if (bodyParts.includes('休息')) {
        exerciseText = '恢复日';
      }
      
      return `
        <div class="week-plan-day ${isToday ? 'current-day' : ''}" 
             style="
               display: flex;
               align-items: center;
               padding: 15px;
               margin: 8px 0;
               background: ${isToday ? 'rgba(76, 175, 80, 0.1)' : 'rgba(255, 255, 255, 0.05)'};
               border-radius: 8px;
               border-left: 4px solid ${isToday ? '#4CAF50' : '#ddd'};
               cursor: pointer;
               transition: all 0.3s ease;
             "
             onclick="showDayDetails(${index}); document.querySelector('.checkin-modal').remove();">
          <div style="width: 80px; font-weight: bold; color: ${isToday ? '#4CAF50' : '#333'};">
            ${dayName}${isToday ? ' 🌟' : ''}
          </div>
          <div style="width: 150px; color: #666; font-size: 14px;">
            ${bodyParts}
          </div>
          <div style="flex: 1; color: #333; font-size: 14px;">
            ${exerciseText}
          </div>
          <div style="color: #999; font-size: 12px;">
            <i class="fas fa-chevron-right"></i>
          </div>
        </div>
      `;
    }).join('');
  } else {
    weekPlanHTML = '<div style="text-align: center; color: #999; padding: 20px;">暂无训练安排</div>';
  }
  
  modal.innerHTML = `
    <div class="checkin-modal-content" style="max-width: 600px;">
      <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3><i class="fas fa-calendar-week"></i> 完整周训练计划</h3>
        <div style="display: flex; gap: 10px; align-items: center;">
          <button onclick="exportFullWeekPlan()" style="
            background: #2196F3;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
          ">
            <i class="fas fa-download"></i> 导出完整计划
          </button>
          <button class="btn-cancel" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
        </div>
      </div>
      
      <div class="plan-info" style="background: rgba(76, 175, 80, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <h4 style="margin: 0 0 5px 0; color: #4CAF50;">${plan.name}</h4>
        <p style="margin: 0; color: #666; font-size: 14px;">${plan.mode} • ${plan.cycle_weeks}周周期</p>
      </div>
      
      <div class="week-schedule">
        ${weekPlanHTML}
      </div>
      
      <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; color: #888; font-size: 12px; text-align: center;">
        点击任意一天查看详细训练安排
      </div>
    </div>
  `;
  
  // 添加关闭事件
  modal.querySelector('.btn-cancel').addEventListener('click', () => {
    modal.remove();
  });
  
  // 点击背景关闭
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.remove();
    }
  });
  
  document.body.appendChild(modal);
}

// 导出今日训练计划
async function exportTodayPlan() {
  try {
    showNotification('正在生成今日训练图片...', 'info');
    
    // 获取今天的训练计划数据
    const todayPlanData = await getTodayPlanData();
    if (!todayPlanData) {
      showNotification('没有今日训练计划可导出', 'warning');
      return;
    }
    
    // 创建今日计划的导出容器
    const exportContainer = createTodayExportContainer(todayPlanData);
    document.body.appendChild(exportContainer);
    
    // 使用html2canvas生成图片
    try {
      if (!window.html2canvas) {
        await loadHtml2Canvas();
      }
      
      const canvas = await html2canvas(exportContainer, {
        backgroundColor: '#ffffff',
        scale: 2,
        scrollX: 0,
        scrollY: 0,
        useCORS: true,
        allowTaint: true,
        height: exportContainer.scrollHeight,
        width: exportContainer.scrollWidth
      });
      
      // 清理临时容器
      document.body.removeChild(exportContainer);
      
      // 下载图片
      const today = new Date();
      const dateStr = today.toISOString().split('T')[0];
      const weekdays = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
      const todayName = weekdays[today.getDay()];
      
      const link = document.createElement('a');
      link.download = `今日训练计划_${todayName}_${dateStr}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
      
      showNotification('今日训练计划导出成功！', 'success');
      
    } catch (error) {
      document.body.removeChild(exportContainer);
      throw error;
    }
    
  } catch (error) {
    console.error('导出今日计划失败:', error);
    showNotification('导出失败: ' + error.message, 'error');
  }
}

// 获取今日训练计划数据
async function getTodayPlanData() {
  try {
    const response = await fetch('/tools/api/training_plans/active/');
    const data = await response.json();
    
    if (data.success && data.has_plan && data.plan && data.plan.week_schedule) {
      const plan = data.plan;
      const today = new Date();
      const currentDayOfWeek = today.getDay();
      const weekdays = ['周一', '周二', '周三', '周四', '周五', '周六', '周日'];
      const currentWeekday = weekdays[currentDayOfWeek === 0 ? 6 : currentDayOfWeek - 1];
      
      // 找到今天的训练计划
      for (let i = 0; i < plan.week_schedule.length; i++) {
        const dayData = plan.week_schedule[i];
        const dayName = weekdays[i] || dayData.weekday || `第${i + 1}天`;
        if (dayName === currentWeekday) {
          // 安全地获取训练部位
          let bodyParts = '未设置';
          if (dayData.body_parts && Array.isArray(dayData.body_parts)) {
            bodyParts = dayData.body_parts.join(' + ');
          } else if (dayData.type) {
            bodyParts = dayData.type;
          }
          
          return {
            planName: plan.name || '训练计划',
            planMode: plan.mode || '自定义',
            dayName: currentWeekday,
            bodyParts: bodyParts,
            exercises: dayData.exercises || [],
            isRestDay: bodyParts.includes('休息') || (dayData.exercises && dayData.exercises.length === 0)
          };
        }
      }
    }
    
    return null;
  } catch (error) {
    console.error('获取今日计划数据失败:', error);
    return null;
  }
}

// 创建今日计划导出容器
function createTodayExportContainer(todayPlan) {
  const container = document.createElement('div');
  container.style.cssText = `
    position: absolute;
    top: -10000px;
    left: -10000px;
    width: 600px;
    background: white;
    padding: 30px;
    font-family: 'Microsoft YaHei', Arial, sans-serif;
    color: #333;
    box-sizing: border-box;
  `;
  
  // 生成动作列表HTML
  let exercisesHTML = '';
  if (todayPlan.exercises && todayPlan.exercises.length > 0) {
    exercisesHTML = todayPlan.exercises.map((exercise, index) => {
      return `
        <div style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 12px;
          margin: 8px 0;
          background: rgba(76, 175, 80, 0.05);
          border-radius: 6px;
          border-left: 3px solid #4CAF50;
        ">
          <div>
            <div style="font-weight: bold; color: #333; font-size: 15px; margin-bottom: 4px;">
              ${index + 1}. ${exercise.name}
            </div>
            <div style="color: #666; font-size: 13px;">
              ${exercise.sets || 3}组 × ${exercise.reps || '10-12'}次
              ${exercise.weight ? ` @ ${exercise.weight}${(exercise.weight && (exercise.weight.toString().includes('kg') || /^(自重|空杆)$/.test(exercise.weight.toString()) || exercise.weight.toString().includes('杆'))) ? '' : 'kg'}` : ''}
              ${exercise.rest ? ` | 休息${exercise.rest}` : ''}
            </div>
          </div>
        </div>
      `;
    }).join('');
  } else if (todayPlan.isRestDay) {
    exercisesHTML = `
      <div style="
        text-align: center;
        padding: 40px 20px;
        background: rgba(0, 0, 0, 0.05);
        border-radius: 8px;
        color: #999;
        font-style: italic;
      ">
        <div style="font-size: 48px; margin-bottom: 15px;">😴</div>
        <div style="font-size: 18px;">休息日，好好恢复体力</div>
      </div>
    `;
  } else {
    exercisesHTML = `
      <div style="
        text-align: center;
        padding: 40px 20px;
        background: rgba(0, 0, 0, 0.05);
        border-radius: 8px;
        color: #999;
      ">
        <div style="font-size: 48px; margin-bottom: 15px;">📝</div>
        <div style="font-size: 16px;">暂未安排具体动作</div>
      </div>
    `;
  }
  
  container.innerHTML = `
    <div style="text-align: center; margin-bottom: 25px; border-bottom: 3px solid #4CAF50; padding-bottom: 15px;">
      <h1 style="color: #4CAF50; margin: 0; font-size: 24px;">今日训练计划</h1>
      <p style="color: #666; margin: 8px 0 0 0; font-size: 13px;">导出日期: ${new Date().toLocaleDateString('zh-CN')}</p>
    </div>
    
    <div style="margin-bottom: 25px;">
      <div style="background: rgba(76, 175, 80, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #4CAF50;">
        <h2 style="color: #4CAF50; font-size: 18px; margin: 0 0 8px 0;">${todayPlan.dayName}</h2>
        <div style="color: #333; font-size: 14px; margin-bottom: 4px;">
          <strong>计划:</strong> ${todayPlan.planName}
        </div>
        <div style="color: #333; font-size: 14px; margin-bottom: 4px;">
          <strong>模式:</strong> ${todayPlan.planMode}
        </div>
        <div style="color: #333; font-size: 14px;">
          <strong>训练部位:</strong> ${todayPlan.bodyParts}
        </div>
      </div>
    </div>
    
    <div>
      <h2 style="color: #333; font-size: 18px; margin-bottom: 15px;">🏋️ 训练动作</h2>
      ${exercisesHTML}
    </div>
    
    <div style="margin-top: 30px; text-align: center; color: #999; font-size: 11px; border-top: 1px solid #eee; padding-top: 15px;">
      <p>由 FitMatrix 健身矩阵生成 | ${new Date().toLocaleString('zh-CN')}</p>
      <p style="margin-top: 6px; color: #4CAF50; font-weight: bold;">🌐 shenyiqing.xin</p>
    </div>
  `;
  
  return container;
}

// 导出完整周训练计划
async function exportFullWeekPlan() {
  try {
    showNotification('正在生成完整周训练图片...', 'info');
    
    // 获取完整的训练计划数据
    const fullWeekData = await getActivePlanData();
    if (!fullWeekData) {
      showNotification('没有训练计划可导出', 'warning');
      return;
    }
    
    // 创建完整周计划的导出容器，使用和网页一致的样式
    const exportContainer = createFullWeekExportContainer(fullWeekData);
    document.body.appendChild(exportContainer);
    
    // 使用html2canvas生成图片
    try {
      if (!window.html2canvas) {
        await loadHtml2Canvas();
      }
      
      const canvas = await html2canvas(exportContainer, {
        backgroundColor: '#ffffff',
        scale: 2,
        scrollX: 0,
        scrollY: 0,
        useCORS: true,
        allowTaint: true,
        height: exportContainer.scrollHeight,
        width: exportContainer.scrollWidth
      });
      
      // 清理临时容器
      document.body.removeChild(exportContainer);
      
      // 下载图片
      const dateStr = new Date().toISOString().split('T')[0];
      const link = document.createElement('a');
      link.download = `完整周训练计划_${fullWeekData.name}_${dateStr}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
      
      showNotification('完整周训练计划导出成功！', 'success');
      
    } catch (error) {
      document.body.removeChild(exportContainer);
      throw error;
    }
    
  } catch (error) {
    console.error('导出完整周计划失败:', error);
    showNotification('导出失败: ' + error.message, 'error');
  }
}

// 创建完整周计划导出容器，样式与网页保持一致
function createFullWeekExportContainer(planData) {
  const container = document.createElement('div');
  container.style.cssText = `
    position: absolute;
    top: -10000px;
    left: -10000px;
    width: 800px;
    background: white;
    padding: 40px;
    font-family: 'Microsoft YaHei', Arial, sans-serif;
    color: #333;
    box-sizing: border-box;
  `;
  
  const today = new Date();
  const currentDayOfWeek = today.getDay();
  const weekdays = ['周一', '周二', '周三', '周四', '周五', '周六', '周日'];
  const currentWeekday = weekdays[currentDayOfWeek === 0 ? 6 : currentDayOfWeek - 1];
  
  // 生成周计划HTML，样式与网页保持一致
  let weekPlanHTML = '';
  if (planData.weeklyPlan && planData.weeklyPlan.length > 0) {
    weekPlanHTML = planData.weeklyPlan.map((day, index) => {
      const isToday = day.day === currentWeekday;
      
      // 格式化详细动作信息
      const exerciseLines = day.exercises.split('\n');
      const hasDetailedExercises = exerciseLines.length > 1 && exerciseLines[0] !== '待添加' && exerciseLines[0] !== '休息日，好好恢复体力';
      
      let exercisesDetailHTML = '';
      if (hasDetailedExercises) {
        exercisesDetailHTML = exerciseLines.map((line, idx) => 
          `<div style="color: #666; font-size: 12px; margin: 3px 0; padding-left: 15px;">• ${line}</div>`
        ).join('');
      } else {
        exercisesDetailHTML = `<div style="color: #999; font-size: 13px; text-align: center; font-style: italic; padding: 10px;">${day.exercises}</div>`;
      }
      
      return `
        <div style="
          margin-bottom: 20px;
          padding: 20px;
          background: ${isToday ? 'rgba(76, 175, 80, 0.1)' : 'rgba(248, 249, 250, 1)'};
          border-radius: 8px;
          border-left: 4px solid ${isToday ? '#4CAF50' : '#ddd'};
          border: ${isToday ? '1px solid rgba(76, 175, 80, 0.3)' : '1px solid #eee'};
        ">
          <div style="display: flex; align-items: center; margin-bottom: 15px;">
            <div style="font-weight: bold; color: ${isToday ? '#4CAF50' : '#333'}; font-size: 18px; margin-right: 15px;">
              ${day.day}${isToday ? ' 🌟' : ''}
            </div>
            <div style="color: #666; font-size: 14px; background: white; padding: 6px 12px; border-radius: 4px; border: 1px solid #eee;">
              ${day.bodyParts}
            </div>
            ${day.exerciseCount > 0 ? `<div style="margin-left: 15px; color: #888; font-size: 12px; background: rgba(76, 175, 80, 0.1); padding: 3px 8px; border-radius: 12px;">${day.exerciseCount}个动作</div>` : ''}
          </div>
          <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #eee;">
            <div style="font-weight: bold; color: #333; font-size: 14px; margin-bottom: 10px;">🏋️ 训练详情</div>
            ${exercisesDetailHTML}
          </div>
        </div>
      `;
    }).join('');
  } else {
    weekPlanHTML = '<div style="text-align: center; color: #999; padding: 40px;">暂无训练安排</div>';
  }
  
  container.innerHTML = `
    <div style="text-align: center; margin-bottom: 30px; border-bottom: 3px solid #4CAF50; padding-bottom: 20px;">
      <h1 style="color: #4CAF50; margin: 0; font-size: 28px;">${planData.name}</h1>
      <p style="color: #666; margin: 10px 0 0 0; font-size: 14px;">
        ${planData.mode} • ${planData.cycle_weeks}周周期 | 导出日期: ${new Date().toLocaleDateString('zh-CN')}
      </p>
    </div>
    
    <div style="margin-bottom: 30px;">
      <h2 style="color: #333; font-size: 22px; margin-bottom: 20px; display: flex; align-items: center;">
        <i class="fas fa-calendar-week" style="margin-right: 10px; color: #4CAF50;"></i>
        完整周训练安排
      </h2>
      ${weekPlanHTML}
    </div>
    
    <div style="margin-top: 40px; text-align: center; color: #999; font-size: 12px; border-top: 1px solid #eee; padding-top: 20px;">
      <p>由 FitMatrix 健身矩阵生成 | ${new Date().toLocaleString('zh-CN')}</p>
      <p style="margin-top: 8px; color: #4CAF50; font-weight: bold;">🌐 shenyiqing.xin</p>
    </div>
  `;
  
  return container;
}

// 标记动作完成
function markExerciseDone(exerciseIndex, dayIndex) {
  const exerciseElement = document.querySelector(`[data-exercise-index="${exerciseIndex}"][data-day-index="${dayIndex}"]`);
  if (!exerciseElement) return;
  
  const button = exerciseElement.querySelector('.complete-btn');
  const exerciseItem = exerciseElement.closest('.exercise-item');
  
  if (button && exerciseItem) {
    // 切换完成状态
    const isCompleted = button.classList.contains('completed');
    const exerciseName = exerciseItem.querySelector('.exercise-name').textContent;
    
    if (isCompleted) {
      // 取消完成状态
      button.classList.remove('completed');
      button.innerHTML = '<i class="fas fa-check"></i> 完成';
      button.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45A049 100%)';
      exerciseItem.classList.remove('completed');
      exerciseItem.style.opacity = '1';
      exerciseItem.style.background = 'linear-gradient(135deg, rgba(76, 175, 80, 0.05) 0%, rgba(76, 175, 80, 0.02) 100%)';
      
      // 从本地存储中移除完成状态
      removeExerciseCompletion(exerciseName, dayIndex);
    } else {
      // 标记为完成
      button.classList.add('completed');
      button.innerHTML = '<i class="fas fa-check-circle"></i> 已完成';
      button.style.background = 'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)';
      exerciseItem.classList.add('completed');
      exerciseItem.style.opacity = '0.7';
      exerciseItem.style.background = 'linear-gradient(135deg, rgba(76, 175, 80, 0.15) 0%, rgba(76, 175, 80, 0.08) 100%)';
      
      // 保存完成状态到本地存储
      saveExerciseCompletion(exerciseName, dayIndex);
      
      // 显示完成提示
      showNotification(`动作"${exerciseName}"已完成！`, 'success');
    }
    
    // 更新训练进度
    updateTrainingProgress();
  }
}

// 保存动作完成状态到本地存储
function saveExerciseCompletion(exerciseName, dayIndex) {
  const today = new Date().toISOString().split('T')[0]; // 格式: YYYY-MM-DD
  const storageKey = `exercise_completion_${today}`;
  
  let completions = JSON.parse(localStorage.getItem(storageKey) || '{}');
  
  if (!completions[dayIndex]) {
    completions[dayIndex] = [];
  }
  
  if (!completions[dayIndex].includes(exerciseName)) {
    completions[dayIndex].push(exerciseName);
  }
  
  localStorage.setItem(storageKey, JSON.stringify(completions));
}

// 从本地存储中移除动作完成状态
function removeExerciseCompletion(exerciseName, dayIndex) {
  const today = new Date().toISOString().split('T')[0];
  const storageKey = `exercise_completion_${today}`;
  
  let completions = JSON.parse(localStorage.getItem(storageKey) || '{}');
  
  if (completions[dayIndex]) {
    const index = completions[dayIndex].indexOf(exerciseName);
    if (index > -1) {
      completions[dayIndex].splice(index, 1);
    }
  }
  
  localStorage.setItem(storageKey, JSON.stringify(completions));
}

// 检查动作是否已完成
function isExerciseCompleted(exerciseName, dayIndex) {
  const today = new Date().toISOString().split('T')[0];
  const storageKey = `exercise_completion_${today}`;
  
  const completions = JSON.parse(localStorage.getItem(storageKey) || '{}');
  
  return completions[dayIndex] && completions[dayIndex].includes(exerciseName);
}

// 恢复动作完成状态
function restoreExerciseCompletions() {
  const exerciseItems = document.querySelectorAll('.exercise-item');
  
  exerciseItems.forEach(item => {
    const exerciseName = item.querySelector('.exercise-name')?.textContent;
    const dayIndex = parseInt(item.getAttribute('data-day-index') || '0');
    const button = item.querySelector('.complete-btn');
    
    if (exerciseName && button && isExerciseCompleted(exerciseName, dayIndex)) {
      // 恢复完成状态
      button.classList.add('completed');
      button.innerHTML = '<i class="fas fa-check-circle"></i> 已完成';
      button.style.background = 'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)';
      item.classList.add('completed');
      item.style.opacity = '0.7';
      item.style.background = 'linear-gradient(135deg, rgba(76, 175, 80, 0.15) 0%, rgba(76, 175, 80, 0.08) 100%)';
    }
  });
  
  // 更新训练进度
  updateTrainingProgress();
}

// 更新训练进度
function updateTrainingProgress() {
  const allExercises = document.querySelectorAll('.exercise-item');
  const completedExercises = document.querySelectorAll('.exercise-item.completed');
  
  if (allExercises.length > 0) {
    const progress = Math.round((completedExercises.length / allExercises.length) * 100);
    
    // 更新页面上的进度显示
    const progressElement = document.querySelector('.training-progress');
    if (progressElement) {
      progressElement.textContent = `训练进度: ${progress}% (${completedExercises.length}/${allExercises.length})`;
    }
    
    // 如果全部完成，显示恭喜信息
    if (progress === 100) {
      setTimeout(() => {
        showNotification('🎉 恭喜！今日训练全部完成！', 'success');
      }, 500);
    }
  }
}

// 显示训练日详情模态框
function showDayDetailsModal(dayData, dayNumber) {
  const modal = document.createElement('div');
  modal.className = 'checkin-modal';
  
  // 计算总动作数
  let totalExercises = 0;
  
  // 生成动作列表HTML
  let exercisesHTML = '';
  
  if (dayData.exercises && Array.isArray(dayData.exercises)) {
    // 新格式：exercises数组
    totalExercises = dayData.exercises.length;
    
    if (totalExercises > 0) {
      exercisesHTML = dayData.exercises.map((exercise, index) => {
        const weight = exercise.weight ? `${exercise.weight}${(exercise.weight && (exercise.weight.toString().includes('kg') || /^(自重|空杆)$/.test(exercise.weight.toString()) || exercise.weight.toString().includes('杆'))) ? '' : 'kg'}` : '自重';
        const reps = exercise.reps || '10-12';
        const sets = exercise.sets || 3;
        const rest = exercise.rest || '90秒';
        
        return `
          <div class="exercise-item" style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            border-left: 4px solid var(--rage-primary, #ff6b35);
          ">
            <div class="exercise-info">
              <div class="exercise-name" style="font-weight: 500; color: #e6e6e6; margin-bottom: 4px;">
                ${exercise.name}
              </div>
              <div class="exercise-params" style="font-size: 0.9rem; color: #a8a8a8;">
                ${sets}组 × ${reps}次 × ${weight} | 休息: ${rest}
              </div>
            </div>
            <div class="exercise-actions">
              <button class="exercise-done-btn" onclick="markExerciseDone(${index})" style="
                background: var(--rage-primary, #ff6b35);
                color: white;
                border: none;
                padding: 6px 12px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 0.85rem;
              ">
                <i class="fas fa-check"></i> 完成
              </button>
            </div>
          </div>
        `;
      }).join('');
    } else {
      exercisesHTML = `
        <div class="no-exercises" style="
          text-align: center;
          padding: 40px 20px;
          color: #a8a8a8;
        ">
          <i class="fas fa-dumbbell" style="font-size: 2rem; margin-bottom: 16px; opacity: 0.5;"></i>
          <p>今天是休息日</p>
          <p style="font-size: 0.9rem;">好好休息，为下次训练做准备！</p>
        </div>
      `;
    }
  } else if (dayData.modules) {
    // 旧格式：modules对象
    totalExercises = Object.values(dayData.modules).reduce((sum, module) => sum + (module?.length || 0), 0);
    
    if (dayData.modules && totalExercises > 0) {
      const moduleNames = { warmup: '热身', main: '主训', accessory: '辅助', cooldown: '拉伸' };
      
      Object.entries(dayData.modules).forEach(([moduleType, exercises]) => {
        if (exercises && Array.isArray(exercises) && exercises.length > 0) {
          exercisesHTML += `
            <div class="exercise-module">
              <h5>${moduleNames[moduleType] || moduleType}</h5>
              <div class="exercise-list">
                ${exercises.map(exercise => `
                  <div class="exercise-item-detail">
                    <div class="exercise-name">${exercise.name || '未知动作'}</div>
                    <div class="exercise-params">
                      ${exercise.sets ? `${exercise.sets}组` : ''}
                      ${exercise.reps ? ` × ${exercise.reps}次` : ''}
                      ${exercise.weight ? ` @ ${exercise.weight}${(exercise.weight && (exercise.weight.toString().includes('kg') || /^(自重|空杆)$/.test(exercise.weight.toString()) || exercise.weight.toString().includes('杆'))) ? '' : 'kg'}` : ''}
                      ${exercise.rest ? ` (休息${exercise.rest})` : ''}
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        }
      });
    } else {
      exercisesHTML = `
        <div class="no-exercises" style="
          text-align: center;
          padding: 40px 20px;
          color: #a8a8a8;
        ">
          <i class="fas fa-dumbbell" style="font-size: 2rem; margin-bottom: 16px; opacity: 0.5;"></i>
          <p>今天是休息日</p>
          <p style="font-size: 0.9rem;">好好休息，为下次训练做准备！</p>
        </div>
      `;
    }
  }
  
  if (!exercisesHTML) {
    if (dayData.body_parts.includes('休息')) {
      exercisesHTML = '<div class="rest-day-info"><i class="fas fa-bed"></i> 今天是休息日，让身体恢复吧！</div>';
    } else {
      exercisesHTML = '<div class="no-exercises-info">暂未安排具体动作，可以前往计划编辑器添加</div>';
    }
  }
  
  modal.innerHTML = `
    <div class="checkin-modal-content">
      <h3>${dayData.weekday || '训练日'} - ${dayData.body_parts ? dayData.body_parts.join(' + ') : (dayData.type || '训练')}</h3>
      <div class="day-details-content">
        ${exercisesHTML}
      </div>
      <div class="form-actions" style="justify-content: center; margin-top: 20px;">
        <button class="btn-secondary" onclick="window.location.href='/tools/fitness/plan-editor/'">
          <i class="fas fa-edit"></i> 编辑计划
        </button>
        <button class="btn-cancel">关闭</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  modal.querySelector('.btn-cancel').addEventListener('click', () => modal.remove());
  modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
}

// 显示无计划模态框
function showNoPlanModal() {
  const modal = document.createElement('div');
  modal.className = 'checkin-modal';
  modal.innerHTML = `
    <div class="checkin-modal-content">
      <h3>暂无训练计划</h3>
      <div style="text-align: center; padding: 20px;">
        <p>您还没有激活的训练计划</p>
        <p>选择一个模板开始您的健身之旅吧！</p>
      </div>
      <div class="form-actions" style="justify-content: center; margin-top: 20px;">
        <button class="btn-primary" onclick="this.closest('.checkin-modal').remove(); openPlanTemplates();">
          <i class="fas fa-star"></i> 选择模板
        </button>
        <button class="btn-secondary" onclick="this.closest('.checkin-modal').remove(); openPlanLibrary();">
          <i class="fas fa-book"></i> 计划库
        </button>
        <button class="btn-cancel">关闭</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  modal.querySelector('.btn-cancel').addEventListener('click', () => modal.remove());
  modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
  initShortcutsHelp();
  try { initCurrentPlan(); } catch (e) { console.warn('初始化当前计划失败', e); }
});



// 训练计划交互
document.querySelectorAll('.plan-day').forEach(day => {
  day.addEventListener('click', function() {
    document.querySelectorAll('.plan-day').forEach(d => d.classList.remove('active'));
    this.classList.add('active');
  });
});

// 计时器功能
let timerInterval;
let timeLeft = 0;
let isRunning = false;

// 设置计时器按钮事件
const setTimerBtn = document.getElementById('setTimer');
if (setTimerBtn) {
  setTimerBtn.addEventListener('click', function() {
    const timerSecondsEl = document.getElementById('timerSeconds');
    if (!timerSecondsEl) return;
    
    const seconds = parseInt(timerSecondsEl.value);
    if (seconds && seconds > 0 && seconds <= 7200) {
      timeLeft = seconds;
      updateTimerDisplay();
      const startTimerEl = document.getElementById('startTimer');
      if (startTimerEl) {
        startTimerEl.textContent = '开始';
      }
      if (isRunning) {
        isRunning = false;
        clearInterval(timerInterval);
      }
    } else {
      alert('请输入1-7200之间的秒数');
    }
  });
}

const startTimerBtn = document.getElementById('startTimer');
if (startTimerBtn) {
  startTimerBtn.addEventListener('click', function() {
    if (!isRunning && timeLeft > 0) {
      isRunning = true;
      timerInterval = setInterval(updateTimer, 1000);
      this.textContent = '暂停';
    } else if (isRunning) {
      isRunning = false;
      clearInterval(timerInterval);
      this.textContent = '继续';
    }
  });
}

const pauseTimerBtn = document.getElementById('pauseTimer');
if (pauseTimerBtn) {
  pauseTimerBtn.addEventListener('click', function() {
    if (isRunning) {
      isRunning = false;
      clearInterval(timerInterval);
      const startTimerEl = document.getElementById('startTimer');
      if (startTimerEl) {
        startTimerEl.textContent = '继续';
      }
    }
  });
}

const resetTimerBtn = document.getElementById('resetTimer');
if (resetTimerBtn) {
  resetTimerBtn.addEventListener('click', function() {
    isRunning = false;
    clearInterval(timerInterval);
    timeLeft = 0;
    updateTimerDisplay();
    const startTimerEl = document.getElementById('startTimer');
    if (startTimerEl) {
      startTimerEl.textContent = '开始';
    }
  });
}

document.querySelectorAll('.preset-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    timeLeft = parseInt(this.getAttribute('data-time'));
    updateTimerDisplay();
  });
});

function updateTimer() {
  if (timeLeft > 0) {
    timeLeft--;
    updateTimerDisplay();
  } else {
    isRunning = false;
    clearInterval(timerInterval);
    alert('训练完成！');
  }
}

function updateTimerDisplay() {
  const minutes = Math.floor(timeLeft / 60);
  const seconds = timeLeft % 60;
  // 将秒数格式化为小数点后两位
  const formattedSeconds = seconds.toFixed(2);
  document.getElementById('timerDisplay').textContent = 
    `${minutes.toString().padStart(2, '0')}:${formattedSeconds}`;
}

// 显示计划详情（简单模态）
function showPlanDetails(dayIndex) {
  const modal = document.createElement('div');
  modal.className = 'checkin-modal';
  modal.innerHTML = `
    <div class="checkin-modal-content">
      <h3>计划详情 - 第${dayIndex}天</h3>
      <div>该功能将展示该天的详细动作清单（待与计划库联动）</div>
      <div class="form-actions" style="justify-content:center; margin-top: 20px;">
        <button class="btn-cancel">关闭</button>
      </div>
    </div>`;
  document.body.appendChild(modal);
  modal.querySelector('.btn-cancel').addEventListener('click', () => modal.remove());
  modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
}

// 营养计算器功能
document.getElementById('calculateBMR').addEventListener('click', function() {
  const weight = parseFloat(document.getElementById('weight').value);
  const height = parseFloat(document.getElementById('height').value);
  const age = parseFloat(document.getElementById('age').value);
  const activity = parseFloat(document.getElementById('activity').value);
  
  if (weight && height && age) {
    // 使用Mifflin-St Jeor公式计算BMR
    const bmr = (10 * weight) + (6.25 * height) - (5 * age) + 5;
    const tdee = bmr * activity;
    
    const resultText = `基础代谢率: ${Math.round(bmr)} 千卡/天\n每日总消耗: ${Math.round(tdee)} 千卡/天`;
    
    document.getElementById('bmrResult').textContent = resultText;
    document.getElementById('bmrResult').style.display = 'block';
  }
});

// 视频点击事件


// 打卡日历功能
class CheckInCalendar {
  constructor() {
    this.currentDate = new Date();
    this.currentYear = this.currentDate.getFullYear();
    this.currentMonth = this.currentDate.getMonth();
    this.calendarData = {};
    this.streak = { current: 0, longest: 0 };
    this.monthlyStats = {};
    
    this.init();
  }
  
  async init() {
    await this.loadCalendarData();
    this.renderCalendar();
    this.bindEvents();
    this.updateStats();
    await this.loadPlanLibrary();
  }
  
  async loadCalendarData() {
    try {
      const response = await fetch(`/tools/api/checkin/calendar/?type=fitness&year=${this.currentYear}&month=${this.currentMonth + 1}`);
      const data = await response.json();
      
      if (data.success) {
        this.calendarData = data.calendar_data || {};
        this.streak = data.streak || { current: 0, longest: 0 };
        this.monthlyStats = data.monthly_stats || {};
      }
    } catch (error) {
      console.error('加载日历数据失败:', error);
      // 设置默认值
      this.calendarData = {};
      this.streak = { current: 0, longest: 0 };
      this.monthlyStats = {};
    }
  }
  
  renderCalendar() {
    const firstDay = new Date(this.currentYear, this.currentMonth, 1);
    const lastDay = new Date(this.currentYear, this.currentMonth + 1, 0);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay());
    
    const calendarBody = document.getElementById('calendarBody');
    if (!calendarBody) return;
    
    calendarBody.innerHTML = '';
    
    // 更新月份显示
    const currentMonthEl = document.getElementById('currentMonth');
    if (currentMonthEl) {
      currentMonthEl.textContent = `${this.currentYear}年${this.currentMonth + 1}月`;
    }
    
    // 更新连续打卡信息
    const currentStreakEl = document.getElementById('currentStreak');
    const longestStreakEl = document.getElementById('longestStreak');
    
    if (currentStreakEl) {
      currentStreakEl.textContent = this.streak.current || 0;
    }
    if (longestStreakEl) {
      longestStreakEl.textContent = this.streak.longest || 0;
    }
    
    // 生成日历网格
    for (let i = 0; i < 42; i++) {
      const date = new Date(startDate);
      date.setDate(startDate.getDate() + i);
      
      const dayElement = document.createElement('div');
      dayElement.className = 'calendar-day';
      
      // 使用本地时区生成日期字符串，避免时区问题
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const dateStr = `${year}-${month}-${day}`;
      
      const isCurrentMonth = date.getMonth() === this.currentMonth;
      const isToday = date.toDateString() === new Date().toDateString();
      const checkinData = this.calendarData[dateStr];
      
      if (!isCurrentMonth) {
        dayElement.classList.add('other-month');
      }
      
      if (isToday) {
        dayElement.classList.add('today');
      }
      
      if (checkinData) {
        dayElement.classList.add('has-checkin');
        if (checkinData.status === 'completed') {
          dayElement.classList.add('completed');
        } else if (checkinData.status === 'rest') {
          dayElement.classList.add('rest');
        }
      }
      
      dayElement.textContent = date.getDate();
      dayElement.setAttribute('data-date', dateStr);
      
      dayElement.addEventListener('click', () => this.handleDayClick(dateStr, checkinData));
      
      calendarBody.appendChild(dayElement);
    }
  }
  
  async handleDayClick(dateStr, checkinData) {
    const clickedDate = new Date(dateStr);
    const today = new Date();
    
    // 设置时间为0点，便于比较
    clickedDate.setHours(0, 0, 0, 0);
    today.setHours(0, 0, 0, 0);
    
    // 检查是否为未来日期
    if (clickedDate > today) {
      this.showNotification('不能为未来日期打卡', 'error');
      return;
    }
    
    if (checkinData) {
      // 显示打卡详情
      this.showCheckinDetail(dateStr, checkinData);
    } else {
      // 检查是否为过去的日期
      if (clickedDate < today) {
        // 显示二次确认对话框
        this.showPastDateConfirmation(dateStr);
      } else {
        // 今天的日期，直接显示打卡表单
        this.showCheckinForm(dateStr);
      }
    }
  }

  showPastDateConfirmation(dateStr) {
    const confirmation = `
      <div class="checkin-modal">
        <div class="checkin-modal-content">
          <h3>确认补打卡</h3>
          <div class="confirmation-message">
            <i class="fas fa-exclamation-triangle" style="color: #ff6b35; font-size: 2rem; margin-bottom: 15px;"></i>
            <p>您正在为 <strong>${dateStr}</strong> 补打卡，这是一个过去的日期。</p>
            <p>请确认您确实在这一天进行了健身活动。</p>
          </div>
          <div class="form-actions">
            <button class="btn-cancel">取消</button>
            <button class="btn-confirm">确认补打卡</button>
          </div>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', confirmation);
    
    const modal = document.querySelector('.checkin-modal');
    
    modal.querySelector('.btn-cancel').addEventListener('click', () => {
      modal.remove();
    });
    
    modal.querySelector('.btn-confirm').addEventListener('click', () => {
      modal.remove();
      this.showCheckinForm(dateStr);
    });
    
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.remove();
      }
    });
  }

  showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
      <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
      <span>${message}</span>
    `;
    
    Object.assign(notification.style, {
      position: 'fixed',
      top: '20px',
      right: '20px',
      padding: '12px 20px',
      borderRadius: '6px',
      color: 'white',
      fontSize: '14px',
      fontWeight: '500',
      zIndex: '10000',
      display: 'flex',
      alignItems: 'center',
      gap: '8px',
      minWidth: '250px',
      boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
      backgroundColor: type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3',
      animation: 'slideInRight 0.3s ease-out'
    });
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.style.animation = 'slideOutRight 0.3s ease-in';
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 300);
    }, 3000);
  }
  
  showCheckinForm(dateStr) {
    const form = `
      <div class="checkin-modal">
        <div class="checkin-modal-content">
          <h3>添加健身打卡 - ${dateStr}</h3>
          <form id="checkinForm">
            <div class="form-group">
              <label>运动类型</label>
              <select name="workout_type" required>
                <option value="strength">力量训练</option>
                <option value="cardio">有氧训练</option>
                <option value="yoga">瑜伽</option>
                <option value="hiit">高强度间歇</option>
                <option value="flexibility">柔韧性训练</option>
                <option value="other">其他</option>
              </select>
            </div>
            <div class="form-group">
              <label>💪 训练部位</label>
              <div class="training-parts-container">
                <label class="checkbox-label">
                  <input type="checkbox" name="training_parts" value="胸"> 胸
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" name="training_parts" value="背"> 背
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" name="training_parts" value="腿"> 腿
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" name="training_parts" value="肩"> 肩
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" name="training_parts" value="手臂"> 手臂
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" name="training_parts" value="核心"> 核心
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" name="training_parts" value="全身"> 全身
                </label>
              </div>
            </div>
            <div class="form-group">
              <label>持续时间（分钟）</label>
              <input type="number" name="duration" min="1" max="300" required>
            </div>
            <div class="form-group">
              <label>强度</label>
              <select name="intensity" required>
                <option value="low">低</option>
                <option value="medium">中</option>
                <option value="high">高</option>
              </select>
            </div>
            <div class="form-group">
              <label>🔥 感受评分</label>
              <div class="rating-container">
                <div class="star-rating">
                  <input type="radio" name="feeling_rating" value="1" id="star1">
                  <label for="star1">⭐</label>
                  <input type="radio" name="feeling_rating" value="2" id="star2">
                  <label for="star2">⭐</label>
                  <input type="radio" name="feeling_rating" value="3" id="star3">
                  <label for="star3">⭐</label>
                  <input type="radio" name="feeling_rating" value="4" id="star4">
                  <label for="star4">⭐</label>
                  <input type="radio" name="feeling_rating" value="5" id="star5">
                  <label for="star5">⭐</label>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label>备注</label>
              <textarea name="notes" rows="3"></textarea>
            </div>
            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" name="is_shared_to_community" value="true">
                📢 一键分享到社区
              </label>
            </div>
            <div class="form-actions">
              <button type="button" class="btn-cancel">取消</button>
              <button type="submit" class="btn-submit">保存</button>
            </div>
          </form>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', form);
    
    const modal = document.querySelector('.checkin-modal');
    const formElement = document.getElementById('checkinForm');
    
    formElement.addEventListener('submit', (e) => {
      e.preventDefault();
      this.submitCheckin(dateStr, formElement);
    });
    
    modal.querySelector('.btn-cancel').addEventListener('click', () => {
      modal.remove();
    });
    
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.remove();
      }
    });
  }
  
  showCheckinDetail(dateStr, checkinData) {
    const detail = `
      <div class="checkin-modal">
        <div class="checkin-modal-content">
          <h3>打卡详情 - ${dateStr}</h3>
          <div class="checkin-detail">
            <p><strong>状态:</strong> ${checkinData.status === 'completed' ? '已完成' : '休息日'}</p>
            ${checkinData.detail ? `
              <p><strong>运动类型:</strong> ${this.getWorkoutTypeName(checkinData.detail.workout_type)}</p>
              <p><strong>持续时间:</strong> ${checkinData.detail.duration} 分钟</p>
              <p><strong>强度:</strong> ${this.getIntensityName(checkinData.detail.intensity)}</p>
              <p><strong>备注:</strong> ${checkinData.detail.notes || '无'}</p>
            ` : ''}
          </div>
          <div class="form-actions">
            <button class="btn-edit">编辑</button>
            <button class="btn-delete">删除</button>
            <button class="btn-cancel">关闭</button>
          </div>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', detail);
    
    const modal = document.querySelector('.checkin-modal');
    
    modal.querySelector('.btn-cancel').addEventListener('click', () => {
      modal.remove();
    });
    
    modal.querySelector('.btn-delete').addEventListener('click', () => {
      if (confirm('确定要删除这条打卡记录吗？')) {
        this.deleteCheckin(dateStr);
        modal.remove();
      }
    });
    
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.remove();
      }
    });
  }
  
  async submitCheckin(dateStr, form) {
    const formData = new FormData(form);
    
    // 获取训练部位（多选）
    const trainingParts = [];
    form.querySelectorAll('input[name="training_parts"]:checked').forEach(checkbox => {
      trainingParts.push(checkbox.value);
    });
    
    // 获取感受评分
    const feelingRating = form.querySelector('input[name="feeling_rating"]:checked');
    const rating = feelingRating ? parseInt(feelingRating.value) : null;
    
    // 获取是否分享到社区
    const isSharedToCommunity = form.querySelector('input[name="is_shared_to_community"]').checked;
    
    const data = {
      type: 'fitness',
      date: dateStr,
      status: 'completed',
      detail: {
        workout_type: formData.get('workout_type'),
        duration: parseInt(formData.get('duration')),
        intensity: formData.get('intensity'),
        training_parts: trainingParts,
        feeling_rating: rating,
        is_shared_to_community: isSharedToCommunity,
        notes: formData.get('notes')
      }
    };
    
    try {
      const response = await fetch('/tools/api/checkin/add/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(data)
      });
      
      const result = await response.json();
      
      if (result.success) {
        // 如果选择分享到社区，创建社区帖子
        if (isSharedToCommunity) {
          await this.createCommunityPost(dateStr, data.detail);
        }
        
        await this.loadCalendarData();
        this.renderCalendar();
        this.updateStats();
        document.querySelector('.checkin-modal').remove();
        alert('打卡成功！');
      } else {
        alert('打卡失败: ' + result.error);
      }
    } catch (error) {
      console.error('提交打卡失败:', error);
      alert('打卡失败，请重试');
    }
  }
  
  async createCommunityPost(dateStr, detailData) {
    try {
      const workoutTypeNames = {
        'strength': '力量训练',
        'cardio': '有氧训练',
        'yoga': '瑜伽',
        'hiit': '高强度间歇',
        'flexibility': '柔韧性训练',
        'other': '其他'
      };
      
      const intensityNames = {
        'low': '低强度',
        'medium': '中等强度',
        'high': '高强度'
      };
      
      const title = `今日健身打卡 - ${workoutTypeNames[detailData.workout_type]}`;
      const content = `💪 训练部位：${detailData.training_parts.join('、') || '全身'}
🔥 感受：${'⭐'.repeat(detailData.feeling_rating || 0)}
⏱️ 时长：${detailData.duration}分钟
💪 强度：${intensityNames[detailData.intensity]}
📝 备注：${detailData.notes || '无'}

继续加油！💪`;
      
      const response = await fetch('/tools/api/fitness_community/create_post/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
          post_type: 'checkin',
          title: title,
          content: content,
          training_parts: detailData.training_parts,
          difficulty_level: detailData.intensity === 'high' ? 'advanced' : detailData.intensity === 'medium' ? 'intermediate' : 'beginner',
          tags: ['健身打卡', workoutTypeNames[detailData.workout_type]]
        })
      });
      
      const data = await response.json();
      if (data.success) {
        alert('已成功分享到社区！');
      }
    } catch (error) {
      console.error('创建社区帖子失败:', error);
      alert('分享到社区失败，但打卡已保存');
    }
  }
  
  async deleteCheckin(dateStr) {
    try {
      const response = await fetch(`/tools/api/checkin/delete/${this.getCheckinId(dateStr)}/`, {
        method: 'DELETE',
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
      });
      
      const result = await response.json();
      
      if (result.success) {
        await this.loadCalendarData();
        this.renderCalendar();
        this.updateStats();
        alert('删除成功');
      } else {
        alert('删除失败: ' + result.error);
      }
    } catch (error) {
      console.error('删除打卡失败:', error);
      alert('删除失败，请重试');
    }
  }
  
  getCheckinId(dateStr) {
    // 这里需要根据实际情况获取checkin_id
    return 1; // 临时返回
  }
  
  getWorkoutTypeName(type) {
    const types = {
      'strength': '力量训练',
      'cardio': '有氧训练',
      'yoga': '瑜伽',
      'hiit': '高强度间歇',
      'flexibility': '柔韧性训练',
      'other': '其他'
    };
    return types[type] || type;
  }
  
  getIntensityName(intensity) {
    const intensities = {
      'low': '低',
      'medium': '中',
      'high': '高'
    };
    return intensities[intensity] || intensity;
  }
  
  updateStats() {
    const completionRateEl = document.getElementById('completionRate');
    const totalDurationEl = document.getElementById('totalDuration');
    const completedDaysEl = document.getElementById('completedDays');
    
    if (completionRateEl) {
      completionRateEl.textContent = `${this.monthlyStats.completion_rate || 0}%`;
    }
    if (totalDurationEl) {
      totalDurationEl.textContent = this.monthlyStats.total_duration || 0;
    }
    if (completedDaysEl) {
      completedDaysEl.textContent = this.monthlyStats.completed_days || 0;
    }
  }
  
  bindEvents() {
    const prevMonthBtn = document.getElementById('prevMonth');
    const nextMonthBtn = document.getElementById('nextMonth');
    const goTodayBtn = document.getElementById('goToday');
    
    if (prevMonthBtn) {
      prevMonthBtn.addEventListener('click', () => {
        this.currentMonth--;
        if (this.currentMonth < 0) {
          this.currentMonth = 11;
          this.currentYear--;
        }
        this.loadCalendarData().then(() => this.renderCalendar());
      });
    }
    
    if (nextMonthBtn) {
      nextMonthBtn.addEventListener('click', () => {
        this.currentMonth++;
        if (this.currentMonth > 11) {
          this.currentMonth = 0;
          this.currentYear++;
        }
        this.loadCalendarData().then(() => this.renderCalendar());
      });
    }
    
    if (goTodayBtn) {
      goTodayBtn.addEventListener('click', () => {
        this.currentDate = new Date();
        this.currentYear = this.currentDate.getFullYear();
        this.currentMonth = this.currentDate.getMonth();
        this.loadCalendarData().then(() => this.renderCalendar());
      });
    }
  }
  
  async loadPlanLibrary() {
    try {

      const response = await fetch('/tools/api/training_plans/list/');

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const data = await response.json();

      if (data.success) {

        this.renderPlanLibrary(data.plans || []);
        this.updatePlanStats(data.plans || []);
      } else {
        console.error('加载计划库失败:', data.error);
        this.showPlanLibraryError();
      }
    } catch (error) {
      console.error('加载计划库数据失败:', error);
      this.showPlanLibraryError();
    }
  }
  
  renderPlanLibrary(plans) {
    const container = document.getElementById('planLibraryContainer');
    if (!container) return;
    
    if (plans.length === 0) {
      container.innerHTML = `
        <div class="no-plans-message">
          <i class="fas fa-clipboard-list" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
          还没有保存的训练计划
          <br>
          <small>点击上方"+"按钮创建您的第一个计划</small>
        </div>
      `;
      return;
    }
    
    const planHTML = plans.map(plan => {
      const statusClass = plan.is_active ? 'active' : '';
      const statusBadge = plan.is_active ? '<i class="fas fa-check-circle" style="color: #28a745; margin-left: 5px;"></i>' : '';
      
      return `
        <div class="plan-item ${statusClass}">
          <div class="plan-info">
            <div class="plan-name">${plan.name}${statusBadge}</div>
            <div class="plan-details">
              <span><i class="fas fa-dumbbell"></i> ${plan.mode}</span>
              <span><i class="fas fa-calendar"></i> ${plan.cycle_weeks}周</span>
              <span><i class="fas fa-list"></i> ${plan.week_schedule ? plan.week_schedule.length : 0}天安排</span>
            </div>
          </div>
          <div class="plan-actions">
            <button class="plan-btn edit" onclick="editPlan(${plan.id})" title="编辑计划">
              <i class="fas fa-edit"></i>
            </button>
            <button class="plan-btn preview" onclick="previewPlanFromLibrary(${plan.id})" title="预览计划">
              <i class="fas fa-eye"></i>
            </button>
            ${!plan.is_active ? `
              <button class="plan-btn apply" onclick="applyPlan(${plan.id}, '${plan.name}')" title="应用计划">
                <i class="fas fa-play"></i>
              </button>
            ` : ''}
            <button class="plan-btn delete" onclick="deletePlan(${plan.id}, '${plan.name}')" title="删除计划">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      `;
    }).join('');
    
    container.innerHTML = planHTML;
  }
  
  updatePlanStats(plans) {
    const elements = {
      totalPlansCount: document.getElementById('totalPlansCount'),
      activePlanName: document.getElementById('activePlanName'),
      planCompletionRate: document.getElementById('planCompletionRate')
    };
    
    if (elements.totalPlansCount) {
      elements.totalPlansCount.textContent = plans.length;
    }
    
    const activePlan = plans.find(plan => plan.is_active);
    if (elements.activePlanName) {
      elements.activePlanName.textContent = activePlan ? activePlan.name : '无';
    }
    
    if (elements.planCompletionRate) {
      // 计算计划完成度 (这里可以根据实际需要调整计算逻辑)
      const completionRate = activePlan ? this.calculatePlanCompletion(activePlan) : 0;
      elements.planCompletionRate.textContent = `${completionRate}%`;
    }
  }
  
  calculatePlanCompletion(plan) {
    // 简单的完成度计算：基于当前月份的打卡情况
    const currentMonth = new Date().getMonth() + 1;
    const currentYear = new Date().getFullYear();
    const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
    
    let completedDays = 0;
    for (let day = 1; day <= daysInMonth; day++) {
      const dateStr = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      if (this.calendarData[dateStr]) {
        completedDays++;
      }
    }
    
    return Math.round((completedDays / daysInMonth) * 100);
  }
  
  showPlanLibraryError() {
    const container = document.getElementById('planLibraryContainer');
    if (container) {
      container.innerHTML = `
        <div class="no-plans-message" style="color: #ff6b6b;">
          <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
          加载计划库失败，请稍后重试
        </div>
      `;
    }
  }
}

// 强制清除缓存的函数（已禁用，避免无限刷新）
function forceClearCache() {
  // 暂时禁用自动刷新功能
  return false;
}

// 覆盖任何可能存在的旧函数
window.renderActivePlan = undefined;
// 注意：不要将initCurrentPlan设置为undefined，因为页面初始化时需要调用它

// 全屏训练计划功能
function togglePlanFullscreen() {
  const trainingCard = document.querySelector('.fitness-card');
  const fullscreenBtn = document.querySelector('.fullscreen-plan-btn');
  const fullscreenIcon = fullscreenBtn.querySelector('i');
  
  if (trainingCard.classList.contains('fullscreen')) {
    // 退出全屏
    trainingCard.classList.remove('fullscreen');
    document.body.classList.remove('fullscreen-active');
    fullscreenIcon.className = 'fas fa-expand';
    fullscreenBtn.setAttribute('data-zh', '全屏');
    fullscreenBtn.setAttribute('data-en', 'Fullscreen');
    fullscreenBtn.title = '全屏';
  } else {
    // 进入全屏
    trainingCard.classList.add('fullscreen');
    document.body.classList.add('fullscreen-active');
    fullscreenIcon.className = 'fas fa-compress';
    fullscreenBtn.setAttribute('data-zh', '退出全屏');
    fullscreenBtn.setAttribute('data-en', 'Exit Fullscreen');
    fullscreenBtn.title = '退出全屏';
  }
}

// ESC键退出全屏
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    const trainingCard = document.querySelector('.fitness-card');
    if (trainingCard && trainingCard.classList.contains('fullscreen')) {
      togglePlanFullscreen();
    }
  }
});

// 初始化打卡日历
document.addEventListener('DOMContentLoaded', function() {
  // 再次确保没有旧函数
  if (typeof renderActivePlan !== 'undefined') {
    console.error('仍然检测到旧函数 renderActivePlan，请清除浏览器缓存');
    return;
  }
  if (typeof initCurrentPlan !== 'undefined') {
    console.error('仍然检测到旧函数 initCurrentPlan，请清除浏览器缓存');
    return;
  }

  try {
    window.checkInCalendar = new CheckInCalendar();

    // 绑定点击查看计划详情
    document.querySelectorAll('.plan-day').forEach(day => {
      day.addEventListener('click', () => showDayDetails(parseInt(day.getAttribute('data-day')) - 1));
    });
    
    // 加载当前激活的训练计划
    loadActivePlan();
    
    // 延迟恢复完成状态，确保DOM已加载
    setTimeout(() => {
      restoreExerciseCompletions();
    }, 1000);
  } catch (error) {
    console.error('初始化失败:', error);
  }
});

// 加载当前激活的训练计划
async function loadActivePlan() {
  try {

    const response = await fetch('/tools/api/training_plans/active/');
    const data = await response.json();

    if (data.success && data.has_plan) {

      updatePlanDisplay(data.plan);
    } else {

      showNoPlanDisplay();
    }
  } catch (error) {
    console.error('加载训练计划失败:', error);
    showNoPlanDisplay();
  }
}

// 更新计划显示
function updatePlanDisplay(plan) {


  // 更新计划信息
  const planInfo = document.querySelector('.plan-info h4');
  const planDescription = document.querySelector('.plan-info p');
  
  if (planInfo) {
    planInfo.textContent = `当前计划：${plan.name}`;
  }
  if (planDescription) {
    planDescription.textContent = `${plan.mode} • ${plan.cycle_weeks}周计划`;
  }
  
  // 更新训练日显示 - 只显示今天的训练
  const workoutPlan = document.getElementById('workoutPlan');


  if (workoutPlan && plan.week_schedule) {
    const weekDays = ['周一', '周二', '周三', '周四', '周五', '周六', '周日'];
    
    // 获取当前星期几
    const today = new Date();
    const currentDayOfWeek = today.getDay();
    const currentWeekday = weekDays[currentDayOfWeek === 0 ? 6 : currentDayOfWeek - 1]; // 转换为周一开始
    
    // 找到今天的训练计划
    let todaysPlan = null;
    let todaysIndex = -1;
    
    for (let i = 0; i < plan.week_schedule.length; i++) {
      const dayData = plan.week_schedule[i];
      const dayName = weekDays[i] || dayData.weekday || `第${i + 1}天`;
      if (dayName === currentWeekday) {
        todaysPlan = dayData;
        todaysIndex = i;
        break;
      }
    }
    
    if (todaysPlan) {

      const exerciseCount = todaysPlan.exercises ? todaysPlan.exercises.length : 0;
      const dayType = todaysPlan.type || todaysPlan.name || '训练';

      // 安全地获取训练部位
      let bodyParts = '未设置';
      if (todaysPlan.body_parts && Array.isArray(todaysPlan.body_parts)) {
        bodyParts = todaysPlan.body_parts.join(' + ');
      } else if (dayType) {
        bodyParts = dayType;
      }
      
      // 更安全的休息日判断
      let isRestDay = false;
      if (exerciseCount === 0) {
        isRestDay = true;
      } else if (dayType && typeof dayType === 'string') {
        isRestDay = dayType.includes('休息');
      }

      const exerciseText = exerciseCount > 0 ? `${exerciseCount}个动作` : 
        (isRestDay ? '恢复日' : '待添加');
      
      // 生成今天的详细动作列表
      let todaysExercisesList = '';
      if (todaysPlan.exercises && Array.isArray(todaysPlan.exercises) && todaysPlan.exercises.length > 0) {
        todaysExercisesList = todaysPlan.exercises.map((exercise, index) => {
          return `
            <div class="exercise-item" data-exercise-index="${index}" data-day-index="0" style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              padding: 15px;
              margin: 10px 0;
              background: linear-gradient(135deg, rgba(76, 175, 80, 0.05) 0%, rgba(76, 175, 80, 0.02) 100%);
              border: 1px solid rgba(76, 175, 80, 0.2);
              border-radius: 12px;
              border-left: 4px solid #4CAF50;
              box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
              transition: all 0.3s ease;
            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0, 0, 0, 0.12)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.08)'">
              <div class="exercise-info" style="flex: 1;">
                <div class="exercise-header" style="display: flex; align-items: center; margin-bottom: 8px;">
                  <div class="exercise-number" style="
                    background: #4CAF50;
                    color: white;
                    width: 24px;
                    height: 24px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 12px;
                    font-weight: bold;
                    margin-right: 12px;
                  ">${index + 1}</div>
                  <div class="exercise-name" style="font-weight: bold; color: white; font-size: 16px; line-height: 1.2; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">
                    ${exercise.name}
                  </div>
                </div>
                <div class="exercise-details" style="
                  color: #666;
                  font-size: 14px;
                  line-height: 1.4;
                  margin-left: 36px;
                  display: flex;
                  flex-wrap: wrap;
                  gap: 12px;
                ">
                  <span style="
                    background: rgba(76, 175, 80, 0.1);
                    padding: 4px 8px;
                    border-radius: 6px;
                    font-weight: 500;
                    color: #2E7D32;
                  ">
                    <i class="fas fa-repeat" style="margin-right: 4px;"></i>
                    ${exercise.sets || 3}组
                  </span>
                  <span style="
                    background: rgba(33, 150, 243, 0.1);
                    padding: 4px 8px;
                    border-radius: 6px;
                    font-weight: 500;
                    color: #1565C0;
                  ">
                    <i class="fas fa-times" style="margin-right: 4px;"></i>
                    ${exercise.reps || '10-12'}次
                  </span>
                  ${exercise.weight ? `
                    <span style="
                      background: rgba(255, 152, 0, 0.1);
                      padding: 4px 8px;
                      border-radius: 6px;
                      font-weight: 500;
                      color: #E65100;
                    ">
                      <i class="fas fa-dumbbell" style="margin-right: 4px;"></i>
                      ${exercise.weight}${(exercise.weight && (exercise.weight.toString().includes('kg') || /^(自重|空杆)$/.test(exercise.weight.toString()) || exercise.weight.toString().includes('杆'))) ? '' : 'kg'}
                    </span>
                  ` : ''}
                  ${exercise.rest ? `
                    <span style="
                      background: rgba(156, 39, 176, 0.1);
                      padding: 4px 8px;
                      border-radius: 6px;
                      font-weight: 500;
                      color: #7B1FA2;
                    ">
                      <i class="fas fa-clock" style="margin-right: 4px;"></i>
                      休息${exercise.rest}
                    </span>
                  ` : ''}
                </div>
              </div>
              <div class="exercise-actions" style="margin-left: 15px;">
                <button class="complete-btn" onclick="markExerciseDone(${index}, 0)" style="
                  background: linear-gradient(135deg, #4CAF50 0%, #45A049 100%);
                  color: white;
                  border: none;
                  padding: 8px 16px;
                  border-radius: 8px;
                  cursor: pointer;
                  font-size: 13px;
                  font-weight: 500;
                  box-shadow: 0 2px 6px rgba(76, 175, 80, 0.3);
                  transition: all 0.3s ease;
                  display: flex;
                  align-items: center;
                  gap: 6px;
                  min-width: 80px;
                  justify-content: center;
                " onmouseover="if(!this.classList.contains('completed')) { this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(76, 175, 80, 0.4)'; }" onmouseout="if(!this.classList.contains('completed')) { this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px rgba(76, 175, 80, 0.3)'; }">
                  <i class="fas fa-check"></i> 完成
                </button>
              </div>
            </div>
          `;
        }).join('');
      } else if (isRestDay) {
        todaysExercisesList = `
          <div class="rest-day-message" style="
            text-align: center;
            padding: 30px 20px;
            background: linear-gradient(135deg, rgba(156, 39, 176, 0.05) 0%, rgba(156, 39, 176, 0.02) 100%);
            border: 1px solid rgba(156, 39, 176, 0.2);
            border-radius: 12px;
            color: #7B1FA2;
            font-style: italic;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
          ">
            <div style="font-size: 48px; margin-bottom: 15px;">😴</div>
            <div style="font-size: 18px; font-weight: 500; margin-bottom: 8px;">休息日</div>
            <div style="font-size: 14px; color: #999;">好好恢复体力，为明天的训练做准备</div>
          </div>
        `;
      } else {
        todaysExercisesList = `
          <div class="no-exercises-message" style="
            text-align: center;
            padding: 30px 20px;
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.05) 0%, rgba(255, 193, 7, 0.02) 100%);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 12px;
            color: #F57C00;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
          ">
            <div style="font-size: 48px; margin-bottom: 15px;">📝</div>
            <div style="font-size: 18px; font-weight: 500; margin-bottom: 8px;">待添加动作</div>
            <div style="font-size: 14px; color: #999; margin-bottom: 15px;">暂未安排具体训练动作</div>
            <button onclick="window.location.href='/tools/fitness/plan-editor/'" 
                    style="
                      padding: 10px 20px;
                      background: linear-gradient(135deg, #4CAF50 0%, #45A049 100%);
                      color: white;
                      border: none;
                      border-radius: 8px;
                      cursor: pointer;
                      font-size: 14px;
                      font-weight: 500;
                      box-shadow: 0 2px 6px rgba(76, 175, 80, 0.3);
                      transition: all 0.3s ease;
                    "
                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(76, 175, 80, 0.4)'"
                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px rgba(76, 175, 80, 0.3)'">
              <i class="fas fa-edit" style="margin-right: 6px;"></i> 编辑计划
            </button>
          </div>
        `;
      }
      
      workoutPlan.innerHTML = `
        <div class="today-plan-container">
          <div class="plan-day active today" data-day="${todaysIndex + 1}" onclick="showDayDetails(${todaysIndex})" style="margin-bottom: 15px;">
            <span>${currentWeekday} 🌟</span>
            <span class="plan-type">${bodyParts}</span>
            <span class="plan-exercises">${exerciseText}</span>
          </div>
          
          <div class="today-exercises-details" style="margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin: 10px 0;">
              <h5 style="color: #333; margin: 0; font-size: 14px; font-weight: bold;">
                <i class="fas fa-dumbbell"></i> 今日训练详情
              </h5>
              <div class="training-progress" style="
                background: rgba(76, 175, 80, 0.1);
                padding: 4px 12px;
                border-radius: 12px;
                font-size: 12px;
                color: #4CAF50;
                font-weight: 500;
              ">
                训练进度: 0% (0/0)
              </div>
            </div>
            ${todaysExercisesList}
          </div>
          
          <div class="action-buttons" style="display: flex; gap: 10px;">
            <div class="view-full-plan-btn" onclick="showFullWeekPlan()" style="
              flex: 1;
              text-align: center;
              padding: 12px;
              background: rgba(76, 175, 80, 0.1);
              border: 1px dashed #4CAF50;
              border-radius: 8px;
              cursor: pointer;
              color: #4CAF50;
              font-size: 13px;
              transition: all 0.3s ease;
            ">
              <i class="fas fa-eye"></i> 查看完整周计划
            </div>
            <div class="export-today-btn" onclick="exportTodayPlan()" style="
              flex: 1;
              text-align: center;
              padding: 12px;
              background: rgba(33, 150, 243, 0.1);
              border: 1px dashed #2196F3;
              border-radius: 8px;
              cursor: pointer;
              color: #2196F3;
              font-size: 13px;
              transition: all 0.3s ease;
            ">
              <i class="fas fa-download"></i> 导出今日计划
            </div>
          </div>
        </div>
      `;
      
      // 延迟恢复完成状态
      setTimeout(() => {
        restoreExerciseCompletions();
      }, 100);
    } else {
      // 如果没有找到今天的计划，显示提示
      workoutPlan.innerHTML = `
        <div class="no-plan-today" style="
          text-align: center;
          padding: 20px;
          color: #666;
          background: rgba(0, 0, 0, 0.05);
          border-radius: 8px;
        ">
          <i class="fas fa-calendar-times" style="font-size: 24px; margin-bottom: 10px; color: #999;"></i>
          <p>今天没有安排训练</p>
          <button onclick="showFullWeekPlan()" class="btn-secondary" style="margin-top: 10px;">
            <i class="fas fa-eye"></i> 查看完整周计划
          </button>
        </div>
      `;
    }
  }
}

// 显示无计划状态
function showNoPlanDisplay() {
  const planInfo = document.querySelector('.plan-info h4');
  const planDescription = document.querySelector('.plan-info p');
  
  if (planInfo) {
    planInfo.textContent = '暂无训练计划';
  }
  if (planDescription) {
    planDescription.textContent = '点击"编辑计划"开始创建你的训练计划';
  }
  
  const workoutPlan = document.getElementById('workoutPlan');
  if (workoutPlan) {
    workoutPlan.innerHTML = `
      <div class="no-plan-message" style="
        text-align: center;
        padding: 40px 20px;
        color: #a8a8a8;
        border: 2px dashed rgba(255, 255, 255, 0.2);
        border-radius: 8px;
      ">
        <i class="fas fa-plus-circle" style="font-size: 2rem; margin-bottom: 16px; opacity: 0.5;"></i>
        <p>还没有训练计划</p>
        <p style="font-size: 0.9rem;">点击上方"编辑计划"按钮开始创建</p>
      </div>
    `;
  }
}

// 训练计划编辑器相关函数
function openPlanEditor() {
  window.location.href = '/tools/fitness/plan-editor/';
}

// 编辑当前激活的训练计划
async function editActivePlan() {
  try {
    const response = await fetch('/tools/api/training_plans/active/');
    const data = await response.json();
    
    if (data.success && data.has_plan) {
      // 跳转到编辑器并传递计划ID
      window.location.href = `/tools/fitness/plan-editor/?plan_id=${data.plan.id}`;
    } else {
      // 没有激活的计划，创建新计划
      openPlanEditor();
    }
  } catch (error) {
    console.error('获取激活计划失败:', error);
    // 出错时也跳转到编辑器
    openPlanEditor();
  }
}

// 打开计划库
async function openPlanLibrary() {
  try {
    const response = await fetch('/tools/api/training_plans/list/');
    const data = await response.json();
    
    if (data.success) {
      showPlanLibraryModal(data.plans || []);
    } else {
      alert('加载计划库失败: ' + data.error);
    }
  } catch (error) {
    console.error('加载计划库失败:', error);
    alert('加载计划库失败，请重试');
  }
}

// 显示计划库模态框
function showPlanLibraryModal(plans) {
  const modal = document.createElement('div');
  modal.className = 'checkin-modal';
  
  let plansHTML = '';
  if (plans.length === 0) {
    plansHTML = '<div class="no-plans-message">您还没有保存的训练计划，快去创建一个吧！</div>';
  } else {
    plansHTML = plans.map(plan => `
      <div class="plan-library-item" data-plan-id="${plan.id}">
        <div class="plan-info">
          <div class="plan-name">${plan.name}</div>
          <div class="plan-meta">${plan.mode} • ${plan.cycle_weeks}周 • 更新于 ${new Date(plan.updated_at).toLocaleDateString()}</div>
        </div>
        <div class="plan-actions">
          <button class="btn-apply" onclick="applyPlan(${plan.id}, '${plan.name}')">
            <i class="fas fa-play"></i> 应用
          </button>
          <button class="btn-preview" onclick="previewPlan(${plan.id})">
            <i class="fas fa-eye"></i> 预览
          </button>
        </div>
      </div>
    `).join('');
  }
  
  modal.innerHTML = `
    <div class="checkin-modal-content" style="max-width: 600px;">
      <h3><i class="fas fa-book"></i> 我的计划库</h3>
      <div class="plan-library-content">
        ${plansHTML}
      </div>
      <div class="form-actions" style="justify-content: center; margin-top: 20px;">
        <button class="btn-primary" onclick="window.location.href='/tools/fitness/plan-editor/'">
          <i class="fas fa-plus"></i> 创建新计划
        </button>
        <button class="btn-cancel">关闭</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  modal.querySelector('.btn-cancel').addEventListener('click', () => modal.remove());
  modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
}

// 打开模板推荐
async function openPlanTemplates() {
  try {
    const response = await fetch('/tools/api/training_plans/templates/');
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();

    if (data.success) {
      let templates = data.templates || data.data || [];
      
      // 如果templates是对象，转换为数组
      if (typeof templates === 'object' && !Array.isArray(templates)) {
        templates = Object.keys(templates).map(key => ({
          id: key,
          ...templates[key]
        }));
      }

      showPlanTemplatesModal(templates);
    } else {
      console.error('API返回错误:', data);
      alert('加载模板失败: ' + (data.error || '未知错误'));
    }
  } catch (error) {
    console.error('加载模板失败:', error);
    alert('加载模板失败: ' + error.message);
  }
}

// 显示模板推荐模态框
function showPlanTemplatesModal(templates) {
  const modal = document.createElement('div');
  modal.className = 'checkin-modal';
  
  // 确保templates是数组
  if (!Array.isArray(templates)) {
    console.warn('templates不是数组:', templates);
    templates = [];
  }
  
  // 处理空模板的情况
  if (templates.length === 0) {
    templates = [{
      id: 'no_templates',
      name: '暂无模板',
      description: '当前没有可用的训练计划模板',
      difficulty: 'beginner',
      target_goals: [],
      mode: 'custom'
    }];
  }
  
  const templatesHTML = templates.map(template => {
    const difficultyColors = {
      'beginner': '#4CAF50',
      'intermediate': '#FF9800', 
      'advanced': '#f44336',
      'expert': '#9C27B0'
    };
    
    const difficultyNames = {
      'beginner': '初学者',
      'intermediate': '中级',
      'advanced': '高级',
      'expert': '专家'
    };
    
    // 确保模板数据安全
    const safeTemplate = {
      id: template.id || 'unknown',
      name: template.name || '未知模板',
      description: template.description || '暂无描述',
      difficulty: template.difficulty || 'beginner',
      target_goals: Array.isArray(template.target_goals) ? template.target_goals : [],
      mode: template.mode || 'custom'
    };
    
    return `
      <div class="template-item" data-template-id="${safeTemplate.id}">
        <div class="template-header">
          <div class="template-name">${safeTemplate.name}</div>
          <div class="template-difficulty" style="background: ${difficultyColors[safeTemplate.difficulty] || '#666'}">
            ${difficultyNames[safeTemplate.difficulty] || safeTemplate.difficulty}
          </div>
        </div>
        <div class="template-description">${safeTemplate.description}</div>
        <div class="template-meta">
          <span><i class="fas fa-calendar"></i> ${template.cycle_weeks || 4}周</span>
          <span><i class="fas fa-dumbbell"></i> ${safeTemplate.mode}</span>
          <span><i class="fas fa-target"></i> ${safeTemplate.target_goals.join(', ')}</span>
        </div>
        <div class="template-actions">
          <button class="btn-apply" onclick="applyTemplate('${safeTemplate.id}', '${safeTemplate.name}')"
            <i class="fas fa-rocket"></i> 立即应用
          </button>
          <button class="btn-preview" onclick="previewTemplate('${safeTemplate.id}')">
            <i class="fas fa-eye"></i> 预览
          </button>
        </div>
      </div>
    `;
  }).join('');
  
  modal.innerHTML = `
    <div class="checkin-modal-content" style="max-width: 700px;">
      <h3><i class="fas fa-star"></i> 模板推荐</h3>
      <div class="templates-content">
        ${templatesHTML}
      </div>
      <div class="form-actions" style="justify-content: center; margin-top: 20px;">
        <button class="btn-cancel">关闭</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  modal.querySelector('.btn-cancel').addEventListener('click', () => modal.remove());
  modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
}

// 应用训练计划
async function applyPlan(planId, planName) {
  if (!confirm(`确定要应用计划"${planName}"吗？这将替换当前的激活计划。`)) {
    return;
  }
  
  try {
    const response = await fetch('/tools/api/training_plans/apply/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: JSON.stringify({ plan_id: planId })
    });
    
    const data = await response.json();
    
    if (data.success) {
      // 关闭模态框
      document.querySelector('.checkin-modal').remove();
      
      // 刷新当前计划显示
      await initCurrentPlan();
      
      // 显示成功消息
      showNotification(data.message, 'success');
    } else {
      alert('应用计划失败: ' + data.error);
    }
  } catch (error) {
    console.error('应用计划失败:', error);
    alert('应用计划失败，请重试');
  }
}

// 应用模板
async function applyTemplate(templateId, templateName) {
  const customName = prompt(`为新计划命名（留空使用默认名称"${templateName}"）:`, templateName);
  
  if (customName === null) return; // 用户取消
  
  try {

    // 获取CSRF令牌
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                      document.querySelector('meta[name=csrf-token]')?.content || 
                      getCookie('csrftoken') || '';

    const requestData = { 
      template_id: templateId,
      custom_name: customName.trim() || templateName
    };

    const response = await fetch('/tools/api/training_plans/templates/apply/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      },
      body: JSON.stringify(requestData)
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error('响应错误:', errorText);
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();

    if (data.success) {
      // 关闭模态框
      document.querySelector('.checkin-modal').remove();
      
      // 刷新当前计划显示
      await loadActivePlan();
      
      // 显示成功消息
      showNotification(data.message, 'success');
    } else {
      alert('应用模板失败: ' + data.error);
    }
  } catch (error) {
    console.error('应用模板失败:', error);
    alert('应用模板失败，请重试');
  }
}

// 预览计划
async function previewPlan(planId) {
  try {
    const response = await fetch(`/tools/api/training_plans/${planId}/`);
    const data = await response.json();
    
    if (data.success) {
      showPlanPreviewModal(data.plan);
    } else {
      alert('加载计划详情失败: ' + data.error);
    }
  } catch (error) {
    console.error('加载计划详情失败:', error);
    alert('加载计划详情失败，请重试');
  }
}

// 预览模板
async function previewTemplate(templateId) {
  try {

    const response = await fetch('/tools/api/training_plans/templates/');
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();

    if (data.success) {
      let template = null;
      const templates = data.templates || {};
      
      // 处理字典格式的templates
      if (typeof templates === 'object' && !Array.isArray(templates)) {
        template = templates[templateId];
        if (template) {
          template.id = templateId; // 确保包含id
        }
      } else if (Array.isArray(templates)) {
        // 处理数组格式的templates
        template = templates.find(t => t.id === templateId);
      }

      if (template) {
        showPlanPreviewModal(template);
      } else {
        console.error('未找到模板:', templateId, '可用模板:', Object.keys(templates));
        alert('未找到模板数据');
      }
    } else {
      console.error('API错误:', data.error);
      alert('获取模板数据失败: ' + (data.error || '未知错误'));
    }
  } catch (error) {
    console.error('预览模板失败:', error);
    alert('预览模板失败: ' + error.message);
  }
}

// 显示计划预览模态框
function showPlanPreviewModal(plan) {
  const modal = document.createElement('div');
  modal.className = 'checkin-modal';
  
  const weekScheduleHTML = plan.week_schedule.map((day, index) => {
    const exerciseCount = day.modules ? 
      Object.values(day.modules).reduce((sum, module) => sum + (module?.length || 0), 0) : 0;
    const exerciseText = exerciseCount > 0 ? `${exerciseCount}个动作` : 
      (day.body_parts.includes('休息') ? '恢复日' : '待添加');
    
    return `
      <div class="preview-day">
        <span class="day-name">${day.weekday}</span>
        <span class="day-parts">${day.body_parts.join(' + ')}</span>
        <span class="day-exercises">${exerciseText}</span>
      </div>
    `;
  }).join('');
  
  modal.innerHTML = `
    <div class="checkin-modal-content" style="max-width: 500px;">
      <h3><i class="fas fa-eye"></i> 计划预览 - ${plan.name}</h3>
      <div class="plan-preview-content">
        <div class="preview-meta">
          <div><strong>训练模式:</strong> ${plan.mode}</div>
          <div><strong>训练周期:</strong> ${plan.cycle_weeks}周</div>
        </div>
        <div class="preview-schedule">
          <h4>周安排:</h4>
          ${weekScheduleHTML}
        </div>
      </div>
      <div class="form-actions" style="justify-content: center; margin-top: 20px;">
        <button class="btn-cancel">关闭</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  modal.querySelector('.btn-cancel').addEventListener('click', () => modal.remove());
  modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
}

// 显示通知消息
function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.className = `notification notification-${type}`;
  notification.innerHTML = `
    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
    <span>${message}</span>
  `;
  
  Object.assign(notification.style, {
    position: 'fixed',
    top: '20px',
    right: '20px',
    padding: '12px 20px',
    borderRadius: '6px',
    color: 'white',
    fontSize: '14px',
    fontWeight: '500',
    zIndex: '10000',
    display: 'flex',
    alignItems: 'center',
    gap: '8px',
    minWidth: '250px',
    boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
    backgroundColor: type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3',
    animation: 'slideInRight 0.3s ease-out'
  });
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.animation = 'slideOutRight 0.3s ease-in';
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 300);
  }, 3000);
}

// 页面加载完成后的其他初始化

// 添加新的样式
const additionalStyles = `
/* 计划库和模板样式 */
.plan-library-content, .templates-content {
  max-height: 400px;
  overflow-y: auto;
  margin: 20px 0;
}

.plan-library-item, .template-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px;
  margin: 10px 0;
  border: 1px solid rgba(255, 107, 53, 0.3);
  border-radius: 8px;
  background: rgba(255, 107, 53, 0.05);
  transition: all 0.3s ease;
}

.plan-library-item:hover, .template-item:hover {
  background: rgba(255, 107, 53, 0.1);
  border-color: var(--rage-primary, #ff6b35);
}

.plan-info, .template-header {
  flex: 1;
}

.plan-name, .template-name {
  font-size: 16px;
  font-weight: 600;
  color: var(--rage-primary, #ff6b35);
  margin-bottom: 5px;
}

.plan-meta, .template-description, .template-meta {
  font-size: 14px;
  color: #ccc;
  margin-bottom: 5px;
}

.template-item {
  flex-direction: column;
  align-items: stretch;
}

.template-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.template-difficulty {
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 500;
  color: white;
}

.template-meta {
  display: flex;
  gap: 15px;
  margin-bottom: 10px;
}

.template-meta span {
  display: flex;
  align-items: center;
  gap: 5px;
  font-size: 13px;
}

.plan-actions, .template-actions {
  display: flex;
  gap: 10px;
}

.btn-apply, .btn-preview {
  padding: 8px 12px;
  border: none;
  border-radius: 4px;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 5px;
}

.btn-apply {
  background: var(--rage-primary, #ff6b35);
  color: white;
}

.btn-apply:hover {
  background: #e55a2b;
  transform: translateY(-1px);
}

.btn-preview {
  background: transparent;
  color: var(--rage-primary, #ff6b35);
  border: 1px solid var(--rage-primary, #ff6b35);
}

.btn-preview:hover {
  background: var(--rage-primary, #ff6b35);
  color: white;
  transform: translateY(-1px);
}

.no-plans-message {
  text-align: center;
  padding: 40px 20px;
  color: #888;
  font-style: italic;
}

/* 训练日详情样式 */
.day-details-content {
  max-height: 400px;
  overflow-y: auto;
  margin: 20px 0;
}

.exercise-module {
  margin-bottom: 20px;
}

.exercise-module h5 {
  color: var(--rage-primary, #ff6b35);
  margin-bottom: 10px;
  padding-bottom: 5px;
  border-bottom: 1px solid rgba(255, 107, 53, 0.3);
}

.exercise-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.exercise-item-detail {
  padding: 10px;
  background: rgba(255, 107, 53, 0.05);
  border-radius: 6px;
  border-left: 3px solid var(--rage-primary, #ff6b35);
}

.exercise-name {
  font-weight: 600;
  margin-bottom: 4px;
}

.exercise-params {
  font-size: 14px;
  color: #ccc;
}

.rest-day-info, .no-exercises-info {
  text-align: center;
  padding: 40px 20px;
  color: #888;
  font-size: 16px;
}

.rest-day-info i {
  font-size: 2em;
  margin-bottom: 10px;
  color: var(--rage-primary, #ff6b35);
}

/* 预览样式 */
.plan-preview-content {
  margin: 20px 0;
}

.preview-meta {
  margin-bottom: 20px;
  padding: 15px;
  background: rgba(255, 107, 53, 0.05);
  border-radius: 6px;
}

.preview-meta div {
  margin-bottom: 8px;
}

.preview-schedule h4 {
  color: var(--rage-primary, #ff6b35);
  margin-bottom: 15px;
}

.preview-day {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px;
  margin: 5px 0;
  background: rgba(255, 107, 53, 0.05);
  border-radius: 6px;
  border-left: 3px solid var(--rage-primary, #ff6b35);
}

.day-name {
  font-weight: 600;
  min-width: 60px;
}

.day-parts {
  flex: 1;
  text-align: center;
  color: var(--rage-primary, #ff6b35);
}

.day-exercises {
  font-size: 14px;
  color: #ccc;
  min-width: 80px;
  text-align: right;
}

/* 全屏训练计划样式 */
.fitness-card.fullscreen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  z-index: 9999;
  background: var(--rage-bg, #0a0a0a);
  border-radius: 0;
  box-shadow: none;
  overflow-y: auto;
  padding: 20px;
  box-sizing: border-box;
}

.fitness-card.fullscreen .fitness-card-header {
  position: sticky;
  top: 0;
  background: var(--rage-bg, #0a0a0a);
  z-index: 10000;
  padding: 10px 0;
  margin-bottom: 20px;
  border-bottom: 1px solid var(--rage-border, #333);
}

.fitness-card.fullscreen .fitness-card-content {
  max-height: none;
  overflow: visible;
}

.fitness-card.fullscreen .current-plan-preview {
  margin-bottom: 30px;
}

.fitness-card.fullscreen .detailed-plan-day {
  margin-bottom: 25px;
  padding: 20px;
  border-radius: 12px;
  background: rgba(255, 255, 255, 0.05);
}

.fitness-card.fullscreen .day-header {
  font-size: 1.3rem;
  margin-bottom: 15px;
}

.fitness-card.fullscreen .exercise-item {
  padding: 15px;
  margin-bottom: 12px;
  font-size: 1.1rem;
}

/* 全屏按钮图标切换 */
.fitness-card.fullscreen .fullscreen-plan-btn i {
  transform: rotate(45deg);
}

/* 防止页面滚动 */
body.fullscreen-active {
  overflow: hidden;
}
`;

// 添加样式到页面
const styleSheet = document.createElement('style');
styleSheet.textContent = additionalStyles + `
  @keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  
  @keyframes slideOutRight {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
  }
  
  /* 确认对话框样式 */
  .confirmation-message {
    text-align: center;
    margin: 20px 0;
    padding: 20px;
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 8px;
  }
  
  .confirmation-message p {
    margin: 10px 0;
    color: #856404;
    line-height: 1.5;
  }
  
  .confirmation-message strong {
    color: #ff6b35;
  }
  
  .btn-confirm {
    background: #ff6b35;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
  }
  
  .btn-confirm:hover {
    background: #e55a2b;
    transform: translateY(-2px);
  }
  
  /* 通知样式 */
  .notification {
    animation: slideInRight 0.3s ease-out;
  }
  
  .notification.notification-error {
    background-color: #f44336;
  }
  
  .notification.notification-success {
    background-color: #4CAF50;
  }
  
  .notification.notification-info {
    background-color: #2196F3;
  }
  
  /* 应用计划对话框样式 */
  .apply-plan-info {
    margin-bottom: 25px;
  }
  
  .plan-warning {
    background: rgba(255, 193, 7, 0.1);
    border: 1px solid rgba(255, 193, 7, 0.3);
    border-radius: 6px;
    padding: 15px;
    margin-top: 15px;
    display: flex;
    align-items: flex-start;
    gap: 12px;
  }
  
  .plan-warning i {
    color: #ffc107;
    font-size: 1.2rem;
    margin-top: 2px;
  }
  
  .plan-warning p {
    margin: 0;
    color: #ffc107;
    font-size: 0.9rem;
    line-height: 1.4;
  }
  
  .week-schedule-preview {
    margin: 20px 0;
  }
  
  .week-schedule-preview h4 {
    color: var(--rage-primary, #ff6b35);
    margin-bottom: 15px;
    font-size: 1.1rem;
  }
  
  .apply-plan-day {
    border: 1px solid rgba(255, 107, 53, 0.3);
    border-radius: 8px;
    margin-bottom: 10px;
    background: rgba(255, 107, 53, 0.05);
    overflow: hidden;
  }
  
  .day-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  
  .day-header:hover {
    background: rgba(255, 107, 53, 0.1);
  }
  
  .day-info {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  
  .day-name {
    font-weight: 600;
    color: var(--rage-text, #e6e6e6);
    font-size: 1rem;
  }
  
  .day-type {
    color: var(--rage-primary, #ff6b35);
    font-size: 0.9rem;
  }
  
  .day-summary {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #a8a8a8;
    font-size: 0.9rem;
  }
  
  .toggle-icon {
    transition: transform 0.3s ease;
  }
  
  .day-content {
    border-top: 1px solid rgba(255, 107, 53, 0.2);
    padding: 20px;
    background: rgba(0, 0, 0, 0.2);
  }
  
  .exercise-module {
    margin-bottom: 20px;
  }
  
  .exercise-module:last-child {
    margin-bottom: 0;
  }
  
  .exercise-module h5 {
    color: var(--rage-primary, #ff6b35);
    margin-bottom: 12px;
    font-size: 1rem;
    font-weight: 600;
    padding-bottom: 6px;
    border-bottom: 1px solid rgba(255, 107, 53, 0.3);
  }
  
  .exercise-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  
  .exercise-item-detail {
    background: rgba(255, 255, 255, 0.05);
    padding: 12px;
    border-radius: 6px;
    border-left: 3px solid var(--rage-primary, #ff6b35);
  }
  
  .exercise-item-detail .exercise-name {
    font-weight: 600;
    margin-bottom: 6px;
    color: var(--rage-text, #e6e6e6);
  }
  
  .exercise-item-detail .exercise-params {
    font-size: 0.9rem;
    color: #a8a8a8;
    line-height: 1.4;
  }
  
  .rest-day-info {
    text-align: center;
    padding: 30px 20px;
    color: #888;
    font-size: 1rem;
  }
  
  .rest-day-info i {
    font-size: 2rem;
    margin-bottom: 10px;
    color: var(--rage-primary, #ff6b35);
    display: block;
  }
  
  /* 详细训练计划显示样式 */
  .detailed-plan-day {
    background: rgba(255, 255, 255, 0.05);
    border: 2px solid rgba(255, 107, 53, 0.3);
    border-radius: 12px;
    margin-bottom: 15px;
    padding: 20px;
    transition: all 0.3s ease;
    cursor: pointer;
  }
  
  .detailed-plan-day:hover {
    background: rgba(255, 107, 53, 0.1);
    border-color: rgba(255, 107, 53, 0.5);
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(255, 107, 53, 0.2);
  }
  
  .detailed-plan-day.active {
    background: rgba(255, 107, 53, 0.15);
    border-color: var(--rage-primary, #ff6b35);
    box-shadow: 0 0 20px rgba(255, 107, 53, 0.3);
  }
  
  .detailed-plan-day.rest-day {
    background: rgba(108, 117, 125, 0.1);
    border-color: rgba(108, 117, 125, 0.3);
  }
  
  .detailed-plan-day.rest-day:hover {
    background: rgba(108, 117, 125, 0.2);
    border-color: rgba(108, 117, 125, 0.5);
  }
  
  .day-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid rgba(255, 107, 53, 0.2);
  }
  
  .detailed-plan-day.rest-day .day-header {
    border-bottom-color: rgba(108, 117, 125, 0.3);
  }
  
  .day-name {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--rage-text, #e6e6e6);
  }
  
  .day-type {
    font-size: 1rem;
    font-weight: 600;
    color: var(--rage-primary, #ff6b35);
    background: rgba(255, 107, 53, 0.1);
    padding: 4px 12px;
    border-radius: 15px;
    border: 1px solid rgba(255, 107, 53, 0.3);
  }
  
  .detailed-plan-day.rest-day .day-type {
    color: #6c757d;
    background: rgba(108, 117, 125, 0.1);
    border-color: rgba(108, 117, 125, 0.3);
  }
  
  .day-exercises {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  
  .exercise-item {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 107, 53, 0.2);
    border-radius: 8px;
    padding: 12px 15px;
    transition: all 0.3s ease;
  }
  
  .exercise-item:hover {
    background: rgba(255, 107, 53, 0.1);
    border-color: rgba(255, 107, 53, 0.4);
  }
  
  .exercise-name {
    font-size: 1rem;
    font-weight: 600;
    color: var(--rage-text, #e6e6e6);
    margin-bottom: 4px;
  }
  
  .exercise-details {
    font-size: 0.9rem;
    color: #a8a8a8;
    font-weight: 500;
  }
  
  .rest-day-message {
    text-align: center;
    padding: 30px 20px;
    color: #6c757d;
    font-size: 1.1rem;
    font-style: italic;
    background: rgba(108, 117, 125, 0.1);
    border: 2px dashed rgba(108, 117, 125, 0.3);
    border-radius: 8px;
  }
  
  /* 响应式设计 */
  @media (max-width: 768px) {
    .detailed-plan-day {
      padding: 15px;
      margin-bottom: 12px;
    }
    
    .day-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
    }
    
    .day-name {
      font-size: 1.1rem;
    }
    
    .day-type {
      font-size: 0.9rem;
      padding: 3px 10px;
    }
    
    .exercise-item {
      padding: 10px 12px;
    }
    
    .exercise-name {
      font-size: 0.95rem;
    }
    
    .exercise-details {
      font-size: 0.85rem;
    }
  }
`;
document.head.appendChild(styleSheet);

// 进入社区功能
function openFitnessCommunity() {
  window.location.href = '/tools/fitness/community/';
}

// 个人档案功能
function openFitnessProfile() {
  window.location.href = '/tools/fitness/profile/';
}

// 应用训练计划
async function applyPlan(planId, planName) {
  try {
    if (!confirm(`确定要应用训练计划"${planName}"吗？这将替换当前的激活计划。`)) {
      return;
    }
    
    const response = await fetch('/tools/api/training_plans/apply/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
      },
      body: JSON.stringify({ plan_id: planId })
    });
    
    const data = await response.json();
    
    if (data.success) {
      // 关闭模态框
      document.querySelector('.checkin-modal')?.remove();
      
      // 显示成功消息
      showNotification(`已应用训练计划"${planName}"！`, 'success');
      
      // 重新加载训练计划显示
      setTimeout(() => {
        loadActivePlan();
      }, 1000);
    } else {
      alert('应用计划失败: ' + data.error);
    }
  } catch (error) {
    console.error('应用计划失败:', error);
    alert('应用计划失败，请重试');
  }
}

// 预览训练计划
async function previewPlan(planId) {
  try {
    const response = await fetch(`/tools/api/training_plans/${planId}/`);
    const data = await response.json();
    
    if (data.success) {
      showPlanPreviewModal(data.plan);
    } else {
      alert('加载计划详情失败: ' + data.error);
    }
  } catch (error) {
    console.error('加载计划详情失败:', error);
    alert('加载计划详情失败，请重试');
  }
}

// 安全的字符串转小写函数
function safeToLowerCase(str) {
  if (str === null || str === undefined) return '';
  try {
    return String(str).toLowerCase();
  } catch (error) {
    console.warn('toLowerCase转换失败:', str, error);
    return '';
  }
}

// 全局搜索安全处理
document.addEventListener('DOMContentLoaded', function() {
  // 监听所有可能的搜索输入框
  document.addEventListener('input', function(e) {
    if (e.target.type === 'search' || e.target.type === 'text') {
      try {
        // 确保输入值是安全的
        if (e.target.value && typeof e.target.value !== 'string') {
          e.target.value = String(e.target.value);
        }
      } catch (error) {
        console.warn('输入值处理错误:', error);
        e.target.value = '';
      }
    }
  });
  
  // 监听键盘事件
  document.addEventListener('keyup', function(e) {
    if (e.target.type === 'search' || e.target.type === 'text') {
      try {
        if (e.target.value && typeof e.target.value !== 'string') {
          e.target.value = String(e.target.value);
        }
      } catch (error) {
        console.warn('键盘输入处理错误:', error);
        e.target.value = '';
      }
    }
  });
});

// 格式化时间显示
function formatDateTime(dateString) {
  if (!dateString) return '未知';
  try {
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return '未知';
    return date.toLocaleDateString('zh-CN', {
      year: 'numeric',
      month: '2-digit', 
      day: '2-digit'
    }) + ' ' + date.toLocaleTimeString('zh-CN', {
      hour: '2-digit',
      minute: '2-digit'
    });
  } catch (error) {
    console.error('时间格式化错误:', error);
    return '未知';
  }
}

// 切换动作详情显示
function toggleExerciseDetails(element) {
  try {
    const detailsEl = element.querySelector('.exercise-details');
    if (detailsEl) {
      const isHidden = detailsEl.style.display === 'none' || detailsEl.style.display === '';
      detailsEl.style.display = isHidden ? 'block' : 'none';
      
      // 切换展开图标
      const chevronIcon = element.querySelector('.fa-chevron-down');
      if (chevronIcon) {
        chevronIcon.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
      }
    } else {
      console.warn('未找到.exercise-details元素，可能这一天没有训练内容');
    }
  } catch (error) {
    console.error('切换动作详情失败:', error);
  }
}

// 显示计划预览模态框
function showPlanPreviewModal(plan) {
  const modal = document.createElement('div');
  modal.className = 'checkin-modal';
  
  let scheduleHTML = '';
  if (plan.week_schedule && plan.week_schedule.length > 0) {
    scheduleHTML = plan.week_schedule.map((dayData, index) => {
      const dayName = dayData.weekday || dayData.name || `第${index + 1}天`;
      
      // 计算动作数量
      let exerciseCount = 0;
      if (dayData.modules) {
        exerciseCount = Object.values(dayData.modules).reduce((sum, module) => {
          return sum + (Array.isArray(module) ? module.length : 0);
        }, 0);
      } else if (dayData.exercises) {
        exerciseCount = dayData.exercises.length;
      }
      
      const bodyParts = dayData.body_parts || dayData.type || '';
      const isRestDay = exerciseCount === 0 || (Array.isArray(bodyParts) ? bodyParts.includes('休息') : bodyParts.includes('休息'));
      
      // 生成详细的动作列表
      let exerciseDetails = '';
      if (dayData.modules && exerciseCount > 0) {
        const moduleNames = {
          warmup: '热身',
          main: '主训练', 
          accessory: '辅助训练',
          cooldown: '拉伸放松'
        };
        
        Object.entries(dayData.modules).forEach(([moduleKey, exercises]) => {
          if (Array.isArray(exercises) && exercises.length > 0) {
            exerciseDetails += `
              <div class="module-section" style="margin: 8px 0; padding-left: 15px;">
                <div style="font-weight: bold; color: #ff6b35; font-size: 0.85rem; margin-bottom: 4px;">
                  ${moduleNames[moduleKey] || moduleKey}
                </div>
                <div class="exercise-list">
                  ${exercises.map(ex => `
                    <div style="font-size: 0.8rem; color: #999; margin: 2px 0;">
                      • ${ex.name} ${ex.sets ? `${ex.sets}组` : ''} ${ex.reps ? `×${ex.reps}` : ''}
                    </div>
                  `).join('')}
                </div>
              </div>
            `;
          }
        });
      }
      
      return `
        <div class="preview-day" style="
          margin: 10px 0;
          padding: 12px;
          background: rgba(255, 255, 255, 0.05);
          border-radius: 6px;
          border-left: 4px solid ${isRestDay ? '#666' : 'var(--rage-primary, #ff6b35)'};
          cursor: pointer;
          transition: all 0.3s ease;
        " onclick="toggleExerciseDetails(this)">
          <div class="day-header" style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <strong>${dayName}</strong>
              ${bodyParts ? `<div style="color: #a8a8a8; font-size: 0.8rem; margin-top: 2px;">${Array.isArray(bodyParts) ? bodyParts.join(' + ') : bodyParts}</div>` : ''}
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="color: #a8a8a8; font-size: 0.9rem;">
                ${isRestDay ? '休息日' : `${exerciseCount}个动作`}
              </span>
              ${exerciseCount > 0 ? '<i class="fas fa-chevron-down" style="color: #999; font-size: 0.8rem; transition: transform 0.3s ease;"></i>' : ''}
            </div>
          </div>
          <div class="exercise-details" style="display: none; margin-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 8px;">
            ${exerciseDetails || '<div style="text-align: center; color: #999; padding: 10px;">暂无详细动作信息</div>'}
          </div>
        </div>
      `;
    }).join('');
  } else {
    scheduleHTML = '<div style="text-align: center; color: #a8a8a8; padding: 20px;">暂无训练安排</div>';
  }
  
  modal.innerHTML = `
    <div class="checkin-modal-content" style="max-width: 500px;">
      <h3><i class="fas fa-eye"></i> ${plan.name}</h3>
      <div class="plan-preview-content">
        <div class="plan-meta" style="margin-bottom: 20px; padding: 10px; background: rgba(255, 255, 255, 0.05); border-radius: 6px;">
          <div><strong>训练模式：</strong>${plan.mode}</div>
          <div><strong>计划周期：</strong>${plan.cycle_weeks}周</div>
          <div><strong>创建时间：</strong>${formatDateTime(plan.created_at)}</div>
          <div><strong>更新时间：</strong>${formatDateTime(plan.updated_at)}</div>
          <div><strong>状态：</strong>${plan.is_active ? '已激活' : '未激活'}</div>
        </div>
        <div class="plan-schedule">
          <h4 style="margin-bottom: 10px;">周安排 <span style="font-size: 0.7rem; color: #999; font-weight: normal;">(点击展开动作详情)</span></h4>
          ${scheduleHTML}
        </div>
      </div>
      <div class="form-actions" style="justify-content: center; margin-top: 20px;">
        <button class="btn-primary" onclick="applyPlan(${plan.id}, '${plan.name}')">
          <i class="fas fa-play"></i> 应用此计划
        </button>
        <button class="btn-secondary" onclick="window.location.href='/tools/fitness/plan-editor/?plan_id=${plan.id}'">
          <i class="fas fa-edit"></i> 编辑计划
        </button>
        <button class="btn-cancel">关闭</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  modal.querySelector('.btn-cancel').addEventListener('click', () => modal.remove());
  modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
}

// 显示通知消息
function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.className = `notification notification-${type}`;
  notification.innerHTML = `
    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
    <span>${message}</span>
  `;
  
  Object.assign(notification.style, {
    position: 'fixed',
    top: '20px',
    right: '20px',
    padding: '12px 20px',
    borderRadius: '6px',
    color: 'white',
    fontSize: '14px',
    fontWeight: '500',
    zIndex: '10000',
    display: 'flex',
    alignItems: 'center',
    gap: '8px',
    minWidth: '250px',
    boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
    backgroundColor: type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3',
    animation: 'slideInRight 0.3s ease-out'
  });
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.animation = 'slideOutRight 0.3s ease-in';
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 300);
  }, 3000);
}

// 更多工具功能
function openFitnessTools() {
  window.location.href = '/tools/fitness/tools/';
}

// 全局函数：计划管理
function openTrainingPlanEditor() {
  window.open('/tools/training_plan_editor/', '_blank');
}

function refreshPlanLibrary() {
  const calendar = window.checkInCalendar;
  if (calendar) {
    calendar.loadPlanLibrary();
    showNotification('计划库已刷新', 'success');
  }
}

function editPlan(planId) {
  window.open(`/tools/training_plan_editor/?plan_id=${planId}`, '_blank');
}

async function previewPlanFromLibrary(planId) {
  try {
    const response = await fetch(`/tools/api/training_plans/${planId}/`);
    const data = await response.json();
    
    if (data.success) {
      showPlanPreviewModal(data.plan);
    } else {
      showNotification('预览失败: ' + data.error, 'error');
    }
  } catch (error) {
    console.error('预览计划失败:', error);
    showNotification('预览失败，请重试', 'error');
  }
}

// 显示应用计划确认对话框（带详细内容）
async function showApplyPlanModal(planId, planName) {
  try {
    const response = await fetch(`/tools/api/training_plans/${planId}/`);
    const data = await response.json();
    
    if (!data.success) {
      showNotification('获取计划详情失败: ' + data.error, 'error');
      return;
    }
    
    const plan = data.plan;
    const modal = document.createElement('div');
    modal.className = 'checkin-modal';
    
    // 生成每日训练详情
    const weekScheduleHTML = plan.week_schedule.map((dayData, index) => {
      const dayNumber = index + 1;
      const dayName = ['周一', '周二', '周三', '周四', '周五', '周六', '周日'][index] || `第${dayNumber}天`;
      
      let exercisesHTML = '';
      if (dayData.exercises && dayData.exercises.length > 0) {
        // 按模块分组显示动作
        const moduleGroups = {
          warmup: [],
          main: [],
          accessory: [],
          cooldown: []
        };
        
        dayData.exercises.forEach(exercise => {
          const module = exercise.module || 'main';
          if (moduleGroups[module]) {
            moduleGroups[module].push(exercise);
          } else {
            moduleGroups.main.push(exercise);
          }
        });
        
        const moduleNames = {
          warmup: '热身',
          main: '主训',
          accessory: '辅助',
          cooldown: '放松'
        };
        
        Object.keys(moduleGroups).forEach(moduleKey => {
          const exercises = moduleGroups[moduleKey];
          if (exercises.length > 0) {
            exercisesHTML += `
              <div class="exercise-module">
                <h5>${moduleNames[moduleKey]}</h5>
                <div class="exercise-list">
                  ${exercises.map(exercise => `
                    <div class="exercise-item-detail">
                      <div class="exercise-name">${exercise.name}</div>
                      <div class="exercise-params">
                        ${exercise.sets}组 × ${exercise.reps}次
                        ${exercise.weight ? ` 重量@ ${exercise.weight}` : ''}
                        ${exercise.rest ? ` | 休息${exercise.rest}` : ''}
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>
            `;
          }
        });
      } else {
        exercisesHTML = '<div class="rest-day-info"><i class="fas fa-bed"></i><br>休息日</div>';
      }
      
      return `
        <div class="apply-plan-day" data-day="${dayNumber}">
          <div class="day-header" onclick="toggleDayContent(${dayNumber})">
            <div class="day-info">
              <span class="day-name">${dayName}</span>
              <span class="day-type">${dayData.type || dayData.name || '训练'}</span>
            </div>
            <div class="day-summary">
              ${dayData.exercises ? dayData.exercises.length : 0}个动作
              <i class="fas fa-chevron-down toggle-icon"></i>
            </div>
          </div>
          <div class="day-content" style="display: none;">
            ${exercisesHTML}
          </div>
        </div>
      `;
    }).join('');
    
    modal.innerHTML = `
      <div class="checkin-modal-content" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
        <div class="modal-header">
          <h3>应用训练计划</h3>
          <button class="modal-close" onclick="this.closest('.checkin-modal').remove()">×</button>
        </div>
        
        <div class="apply-plan-info">
          <div class="plan-meta">
            <h4>${plan.name}</h4>
            <div class="plan-details">
              <span><i class="fas fa-dumbbell"></i> ${plan.mode}</span>
              <span><i class="fas fa-calendar"></i> ${plan.cycle_weeks}周</span>
              <span><i class="fas fa-list"></i> ${plan.week_schedule.length}天安排</span>
            </div>
          </div>
          
          <div class="plan-warning">
            <i class="fas fa-exclamation-triangle"></i>
            <p>应用此计划将替换当前的激活计划。点击下方每一天可以查看详细训练内容。</p>
          </div>
        </div>
        
        <div class="week-schedule-preview">
          <h4>训练安排预览</h4>
          ${weekScheduleHTML}
        </div>
        
        <div class="form-actions" style="justify-content: center; margin-top: 30px; gap: 15px;">
          <button class="btn-cancel" onclick="this.closest('.checkin-modal').remove()">取消</button>
          <button class="btn-confirm" onclick="confirmApplyPlan(${planId}, '${planName}')">
            <i class="fas fa-check"></i> 确认应用
          </button>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    // 点击模态框外部关闭
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.remove();
    });
    
  } catch (error) {
    console.error('显示应用计划对话框失败:', error);
    showNotification('显示计划详情失败，请重试', 'error');
  }
}

// 切换每日内容显示
function toggleDayContent(dayNumber) {
  const dayElement = document.querySelector(`[data-day="${dayNumber}"]`);
  const content = dayElement.querySelector('.day-content');
  const icon = dayElement.querySelector('.toggle-icon');
  
  if (content.style.display === 'none') {
    content.style.display = 'block';
    icon.style.transform = 'rotate(180deg)';
  } else {
    content.style.display = 'none';
    icon.style.transform = 'rotate(0deg)';
  }
}

// 确认应用计划
async function confirmApplyPlan(planId, planName) {
  try {
    const response = await fetch('/tools/api/training_plans/apply/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: JSON.stringify({ plan_id: planId })
    });
    
    const data = await response.json();
    
    if (data.success) {
      showNotification(`已将"${planName}"设为激活计划`, 'success');
      // 关闭模态框
      document.querySelector('.checkin-modal').remove();
      // 刷新计划库和激活计划显示
      const calendar = window.checkInCalendar;
      if (calendar) {
        await calendar.loadPlanLibrary();
      }
      await loadActivePlan();
    } else {
      showNotification('应用失败: ' + data.error, 'error');
    }
  } catch (error) {
    console.error('应用计划失败:', error);
    showNotification('应用失败，请重试', 'error');
  }
}

async function applyPlan(planId, planName) {
  // 显示详细的应用计划对话框
  await showApplyPlanModal(planId, planName);
}

async function deletePlan(planId, planName) {
  if (!confirm(`确定要删除训练计划"${planName}"吗？此操作不可恢复。`)) {
    return;
  }
  
  try {
    const response = await fetch(`/tools/api/training_plans/${planId}/delete/`, {
      method: 'DELETE',
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      }
    });
    
    const data = await response.json();
    
    if (data.success) {
      showNotification(`已删除训练计划"${planName}"`, 'success');
      // 刷新计划库
      const calendar = window.checkInCalendar;
      if (calendar) {
        calendar.loadPlanLibrary();
      }
    } else {
      showNotification('删除失败: ' + data.error, 'error');
    }
  } catch (error) {
    console.error('删除计划失败:', error);
    showNotification('删除失败，请重试', 'error');
  }
}

// 保存全局引用以便其他函数访问
window.checkInCalendar = null;

// 获取Cookie的辅助函数
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

// 训练计划导出为图片功能
async function exportPlanAsImage() {
  // 现在只导出今日计划，与主页面的"导出今日计划"功能一致
  await exportTodayPlan();
}

// 获取当前激活的训练计划数据
async function getActivePlanData() {
  try {
    // 直接从API获取最新的训练计划数据
    const response = await fetch('/tools/api/training_plans/active/');
    const data = await response.json();
    
    if (data.success && data.has_plan && data.plan) {
      const plan = data.plan;
      const weeklyPlan = [];
      
      if (plan.week_schedule && Array.isArray(plan.week_schedule)) {
        const weekdays = ['周一', '周二', '周三', '周四', '周五', '周六', '周日'];
        
        plan.week_schedule.forEach((dayData, index) => {
          const dayName = weekdays[index] || dayData.weekday || `第${index + 1}天`;
          
          // 安全地获取训练部位
          let bodyParts = '未设置';
          if (dayData.body_parts && Array.isArray(dayData.body_parts)) {
            bodyParts = dayData.body_parts.join(' + ');
          } else if (dayData.type) {
            bodyParts = dayData.type;
          }
          
          // 获取详细的动作信息
          let detailedExercises = '待添加';
          if (dayData.exercises && Array.isArray(dayData.exercises) && dayData.exercises.length > 0) {
            detailedExercises = dayData.exercises.map(exercise => {
              return `${exercise.name} (${exercise.sets || 3}组 × ${exercise.reps || '10-12'}次${exercise.weight ? ` @ ${exercise.weight}${(exercise.weight && (exercise.weight.toString().includes('kg') || /^(自重|空杆)$/.test(exercise.weight.toString()) || exercise.weight.toString().includes('杆'))) ? '' : 'kg'}` : ''})`;
            }).join('\n');
          } else if (bodyParts.includes('休息')) {
            detailedExercises = '休息日，好好恢复体力';
          }
          
          weeklyPlan.push({
            week: 1,
            day: dayName,
            bodyParts: bodyParts,
            exercises: detailedExercises,
            exerciseCount: dayData.exercises ? dayData.exercises.length : 0
          });
        });
      }
      
      return {
        name: plan.name || '训练计划',
        mode: plan.mode || '自定义',
        cycle_weeks: plan.cycle_weeks || 4,
        weeklyPlan: weeklyPlan
      };
    }
    
    // 备用方案：从页面DOM获取数据
    const planElement = document.querySelector('.current-plan-preview');
    if (!planElement) return null;
    
    const planName = planElement.querySelector('h4')?.textContent || '训练计划';
    const weeklyPlan = [];
    
    // 从当前显示的计划天数数据中获取
    const planDays = document.querySelectorAll('.plan-day');
    
    if (planDays.length > 0) {
      planDays.forEach((dayElement, index) => {
        const dayName = dayElement.querySelector('span:first-child')?.textContent || `第${index + 1}天`;
        const bodyParts = dayElement.querySelector('.plan-type')?.textContent || '未设置';
        const exercises = dayElement.querySelector('.plan-exercises')?.textContent || '待添加';
        
        weeklyPlan.push({
          week: 1,
          day: dayName,
          bodyParts: bodyParts,
          exercises: exercises,
          exerciseCount: exercises.includes('个动作') ? parseInt(exercises) || 0 : 0
        });
      });
    } else {
      // 如果没有找到计划天数，使用全局的activePlan数据
      if (window.activePlan && window.activePlan.week_schedule) {
        window.activePlan.week_schedule.forEach((day, index) => {
          const safeDay = {
            weekday: day.weekday || `第${index + 1}天`,
            body_parts: Array.isArray(day.body_parts) ? day.body_parts : ['未设置'],
            modules: day.modules || {}
          };
          
          const exerciseCount = Object.values(safeDay.modules).reduce((sum, module) => sum + (Array.isArray(module) ? module.length : 0), 0);
          const exerciseText = exerciseCount > 0 ? `${exerciseCount}个动作` : 
            (safeDay.body_parts.includes('休息') ? '恢复日' : '待添加');
          
          weeklyPlan.push({
            week: 1,
            day: safeDay.weekday,
            bodyParts: safeDay.body_parts.join(' + '),
            exercises: exerciseText,
            detailedModules: safeDay.modules
          });
        });
      }
    }
    
    return {
      name: planName.replace('当前计划：', '').trim(),
      details: planDetails,
      weeklyPlan: weeklyPlan,
      exportDate: new Date().toLocaleDateString('zh-CN')
    };
  } catch (error) {
    console.error('获取计划数据失败:', error);
    return null;
  }
}

// 创建导出用的容器
function createExportContainer(planData) {
  const container = document.createElement('div');
  container.style.cssText = `
    position: absolute;
    top: -10000px;
    left: -10000px;
    width: 800px;
    background: white;
    padding: 40px;
    font-family: 'Microsoft YaHei', Arial, sans-serif;
    color: #333;
    box-sizing: border-box;
  `;
  
  container.innerHTML = `
    <div style="text-align: center; margin-bottom: 30px; border-bottom: 3px solid #4CAF50; padding-bottom: 20px;">
      <h1 style="color: #4CAF50; margin: 0; font-size: 28px;">${planData.name}</h1>
      <p style="color: #666; margin: 10px 0 0 0; font-size: 14px;">导出日期: ${planData.exportDate}</p>
    </div>
    
    <div style="margin-bottom: 30px;">
      <h2 style="color: #333; font-size: 20px; margin-bottom: 15px;">📋 计划详情</h2>
      <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #4CAF50;">
        ${planData.details || '暂无详细信息'}
      </div>
    </div>
    
    <div>
      <h2 style="color: #333; font-size: 20px; margin-bottom: 20px;">📅 训练安排</h2>
      ${generateWeeklyPlanHTML(planData.weeklyPlan)}
    </div>
    
    <div style="margin-top: 40px; text-align: center; color: #999; font-size: 12px; border-top: 1px solid #eee; padding-top: 20px;">
      <p>由 FitMatrix 健身矩阵生成 | ${new Date().toLocaleString('zh-CN')}</p>
      <p style="margin-top: 8px; color: #4CAF50; font-weight: bold;">🌐 shenyiqing.xin</p>
    </div>
  `;
  
  return container;
}

// 生成周计划HTML
function generateWeeklyPlanHTML(weeklyPlan) {
  if (!weeklyPlan || weeklyPlan.length === 0) {
    return '<p style="color: #999; text-align: center;">暂无训练安排</p>';
  }
  
  return `
    <div style="margin-bottom: 25px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">
      <div style="background: #4CAF50; color: white; padding: 10px 15px; font-weight: bold;">
        训练计划详情
      </div>
      <div style="padding: 15px;">
        ${weeklyPlan.map(day => {
          // 格式化详细动作信息
          const exerciseLines = day.exercises.split('\n');
          const formattedExercises = exerciseLines.length > 1 && exerciseLines[0] !== '待添加' && exerciseLines[0] !== '休息日，好好恢复体力'
            ? exerciseLines.map(line => `• ${line}`).join('<br>')
            : day.exercises;
          
          return `
            <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #4CAF50;">
              <div style="display: flex; align-items: center; margin-bottom: 10px;">
                <div style="font-weight: bold; color: #4CAF50; font-size: 16px; margin-right: 15px;">${day.day}</div>
                <div style="color: #666; font-size: 14px; background: white; padding: 4px 8px; border-radius: 4px;">${day.bodyParts}</div>
                ${day.exerciseCount > 0 ? `<div style="margin-left: 10px; color: #888; font-size: 12px;">${day.exerciseCount}个动作</div>` : ''}
              </div>
              <div style="color: #333; font-size: 13px; line-height: 1.5; margin-left: 0;">
                ${formattedExercises}
              </div>
            </div>
          `;
        }).join('')}
      </div>
    </div>
  `;
}

// 动态加载html2canvas库
function loadHtml2Canvas() {
  return new Promise((resolve, reject) => {
    if (window.html2canvas) {
      resolve();
      return;
    }
    
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
    script.onload = () => resolve();
    script.onerror = () => reject(new Error('html2canvas库加载失败'));
    document.head.appendChild(script);
  });
}

</script>
{% endblock %} 