{% extends "base.html" %}
{% load static %}

{% block tool_title_inner %}FitMatrix - å¥èº«çŸ©é˜µ{% endblock %}
{% block tool_title_display %}FitMatrix - å¥èº«çŸ©é˜µ{% endblock %}

{% block content %}
{% csrf_token %}
<!-- å¼ºåˆ¶æ¸…é™¤æ‰€æœ‰ç¼“å­˜ -->
<script>
// æ£€æµ‹æ˜¯å¦å­˜åœ¨æ—§å‡½æ•°ï¼Œå¦‚æœå­˜åœ¨åˆ™å¼ºåˆ¶æ¸…é™¤æ‰€æœ‰ç¼“å­˜
if (typeof renderActivePlan !== 'undefined' || typeof initCurrentPlan !== 'undefined') {

  // æ¸…é™¤localStorage
  localStorage.clear();
  
  // æ¸…é™¤sessionStorage
  sessionStorage.clear();
  
  // æ¸…é™¤æ‰€æœ‰ç¼“å­˜
  if ('caches' in window) {
    caches.keys().then(function(names) {
      return Promise.all(names.map(function(name) {
        return caches.delete(name);
      }));
    }).then(function() {

      // å¼ºåˆ¶é‡æ–°åŠ è½½ï¼Œä¸ä½¿ç”¨ç¼“å­˜
      window.location.reload(true);
    });
  } else {
    // å¦‚æœä¸æ”¯æŒcaches APIï¼Œç›´æ¥é‡æ–°åŠ è½½
    window.location.reload(true);
  }
}
</script>
<div class="fitness-container">


  <!-- å¿«æ·é”®æç¤º -->
  <button class="shortcuts-help-btn" id="showShortcutsHelp" title="å¿«æ·é”®å¸®åŠ©">
    <i class="fas fa-keyboard"></i>
  </button>

  <!-- å¿«æ·é”®å¸®åŠ©é¢æ¿ -->
  <div class="shortcuts-help-panel" id="shortcutsHelpPanel">
    <div class="help-panel-header">
      <h3><i class="fas fa-keyboard"></i> å¿«æ·é”®å¸®åŠ©</h3>
      <button class="close-help-btn" id="closeShortcutsHelp">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="help-panel-content">
      <div class="shortcuts-section">
        <h4><i class="fas fa-palette"></i> ä¸»é¢˜åˆ‡æ¢</h4>
        <div class="shortcut-item">
          <span class="shortcut-key">Ctrl + 1</span>
          <span class="shortcut-desc">ç”Ÿæ´»æ¨¡å¼</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Ctrl + 2</span>
          <span class="shortcut-desc">æå®¢æ¨¡å¼</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Ctrl + 3</span>
          <span class="shortcut-desc">ç‹‚æš´æ¨¡å¼</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Ctrl + 4</span>
          <span class="shortcut-desc">Emoæ¨¡å¼</span>
        </div>
      </div>
      <div class="shortcuts-section">
        <h4><i class="fas fa-tools"></i> å·¥å…·è·³è½¬</h4>
        <div class="shortcut-item">
          <span class="shortcut-key">Alt + E</span>
          <span class="shortcut-desc">æƒ…æ„Ÿæ—¥è®°</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Alt + L</span>
          <span class="shortcut-desc">ç”Ÿæ´»æ—¥è®°</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Alt + F</span>
          <span class="shortcut-desc">FitMatrix</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Alt + C</span>
          <span class="shortcut-desc">åˆ›æ„å†™ä½œ</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Alt + P</span>
          <span class="shortcut-desc">PDFè½¬æ¢å™¨</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Alt + R</span>
          <span class="shortcut-desc">å°çº¢ä¹¦ç”Ÿæˆå™¨</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Alt + T</span>
          <span class="shortcut-desc">æµ‹è¯•ç”¨ä¾‹ç”Ÿæˆå™¨</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Alt + W</span>
          <span class="shortcut-desc">ç½‘é¡µçˆ¬è™«</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Alt + S</span>
          <span class="shortcut-desc">è‡ªæˆ‘åˆ†æ</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Alt + B</span>
          <span class="shortcut-desc">æ•…äº‹æ¿</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Alt + M</span>
          <span class="shortcut-desc">éŸ³ä¹ç–—æ„ˆ</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Alt + D</span>
          <span class="shortcut-desc">å†¥æƒ³æŒ‡å—</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Alt + A</span>
          <span class="shortcut-desc">è¿åŠ¿åˆ†æ</span>
        </div>
      </div>
    </div>
  </div>

  <!-- é®ç½©å±‚ -->
  <div class="help-overlay" id="helpOverlay"></div>

  <!-- å¤´éƒ¨åŒºåŸŸ -->
  <div class="fitness-header">
    <div class="fitness-title">
      <i class="fas fa-dumbbell"></i>
      <span data-zh="FitMatrix" data-en="FitMatrix">FitMatrix</span>
    </div>
    <div class="fitness-subtitle" data-zh="æ™ºèƒ½å¥èº«çŸ©é˜µï¼Œé‡å¡‘èº«ä½“è¾¹ç•Œ" data-en="Intelligent Fitness Matrix, Reshape Physical Boundaries">æ™ºèƒ½å¥èº«çŸ©é˜µï¼Œé‡å¡‘èº«ä½“è¾¹ç•Œ</div>
  </div>

  <!-- ä¸»è¦åŠŸèƒ½åŒºåŸŸ -->
  <div class="fitness-main">
    <div class="fitness-grid">
      <!-- è®­ç»ƒè®¡åˆ’ -->
      <div class="fitness-card">
        <div class="fitness-card-header">
          <i class="fas fa-calendar-alt"></i>
          <h3 data-zh="è®­ç»ƒè®¡åˆ’" data-en="Training Plan">è®­ç»ƒè®¡åˆ’</h3>
          <button class="edit-plan-btn" onclick="editActivePlan()" data-zh="ç¼–è¾‘è®¡åˆ’" data-en="Edit Plan">
            <i class="fas fa-edit"></i> ç¼–è¾‘è®¡åˆ’
          </button>
          <button class="library-plan-btn" onclick="openPlanLibrary()" data-zh="è®¡åˆ’åº“" data-en="Plan Library" style="
            background: var(--rage-secondary, #2196F3);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            margin-left: 8px;
          ">
            <i class="fas fa-book"></i> è®¡åˆ’åº“
          </button>
          <button class="fullscreen-plan-btn" onclick="togglePlanFullscreen()" data-zh="å…¨å±" data-en="Fullscreen" style="
            background: var(--rage-accent, #9C27B0);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            margin-left: 8px;
          ">
            <i class="fas fa-expand"></i> å…¨å±
          </button>
          <button class="export-plan-btn" onclick="exportPlanAsImage()" data-zh="å¯¼å‡ºå›¾ç‰‡" data-en="Export Image" style="
            background: var(--success-color, #4CAF50);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            margin-left: 8px;
          ">
            <i class="fas fa-download"></i> å¯¼å‡ºå›¾ç‰‡
          </button>
        </div>
        <div class="fitness-card-content">
          <div class="current-plan-preview">
            <div class="plan-info">
              <h4>å½“å‰è®¡åˆ’ï¼šå¢è‚Œåˆ†åŒ–è®­ç»ƒ</h4>
              <p>5å¤©åˆ†åŒ– â€¢ èƒ¸èƒŒè‚©è…¿è‡‚å¾ªç¯</p>
            </div>
            <div class="workout-plan" id="workoutPlan">
              <div class="plan-day active" data-day="1">
                <span data-zh="å‘¨ä¸€" data-en="Mon">å‘¨ä¸€</span>
                <span class="plan-type" data-zh="èƒ¸éƒ¨" data-en="Chest">èƒ¸éƒ¨</span>
                <span class="plan-exercises">4ä¸ªåŠ¨ä½œ</span>
              </div>
              <div class="plan-day" data-day="2">
                <span data-zh="å‘¨äºŒ" data-en="Tue">å‘¨äºŒ</span>
                <span class="plan-type" data-zh="èƒŒéƒ¨" data-en="Back">èƒŒéƒ¨</span>
                <span class="plan-exercises">5ä¸ªåŠ¨ä½œ</span>
              </div>
              <div class="plan-day" data-day="3">
                <span data-zh="å‘¨ä¸‰" data-en="Wed">å‘¨ä¸‰</span>
                <span class="plan-type" data-zh="ä¼‘æ¯" data-en="Rest">ä¼‘æ¯</span>
                <span class="plan-exercises">æ¢å¤æ—¥</span>
              </div>
              <div class="plan-day" data-day="4">
                <span data-zh="å‘¨å››" data-en="Thu">å‘¨å››</span>
                <span class="plan-type" data-zh="è‚©éƒ¨" data-en="Shoulders">è‚©éƒ¨</span>
                <span class="plan-exercises">4ä¸ªåŠ¨ä½œ</span>
              </div>
              <div class="plan-day" data-day="5">
                <span data-zh="å‘¨äº”" data-en="Fri">å‘¨äº”</span>
                <span class="plan-type" data-zh="è…¿éƒ¨" data-en="Legs">è…¿éƒ¨</span>
                <span class="plan-exercises">5ä¸ªåŠ¨ä½œ</span>
              </div>
              <div class="plan-day" data-day="6">
                <span data-zh="å‘¨å…­" data-en="Sat">å‘¨å…­</span>
                <span class="plan-type" data-zh="æ‰‹è‡‚" data-en="Arms">æ‰‹è‡‚</span>
                <span class="plan-exercises">4ä¸ªåŠ¨ä½œ</span>
              </div>
              <div class="plan-day" data-day="7">
                <span data-zh="å‘¨æ—¥" data-en="Sun">å‘¨æ—¥</span>
                <span class="plan-type" data-zh="ä¼‘æ¯" data-en="Rest">ä¼‘æ¯</span>
                <span class="plan-exercises">æ¢å¤æ—¥</span>
              </div>
            </div>
            <div class="plan-actions">
              <button class="action-btn primary" onclick="openPlanEditor()">
                <i class="fas fa-plus"></i> åˆ›å»ºæ–°è®¡åˆ’
              </button>
              <button class="action-btn secondary" onclick="openPlanLibrary()">
                <i class="fas fa-book"></i> è®¡åˆ’åº“
              </button>
              <button class="action-btn secondary" onclick="openPlanTemplates()">
                <i class="fas fa-star"></i> æ¨¡æ¿æ¨è
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- è®­ç»ƒè®¡æ—¶å™¨ -->
      <div class="fitness-card">
        <div class="fitness-card-header">
          <i class="fas fa-stopwatch"></i>
          <h3 data-zh="è®­ç»ƒè®¡æ—¶å™¨" data-en="Workout Timer">è®­ç»ƒè®¡æ—¶å™¨</h3>
        </div>
        <div class="fitness-card-content">
          <div class="timer-display">
            <div class="timer-time" id="timerDisplay">00:00</div>
            <div class="timer-input">
              <label for="timerSeconds" data-zh="è¾“å…¥ç§’æ•°:" data-en="Enter seconds:">è¾“å…¥ç§’æ•°:</label>
              <input type="number" id="timerSeconds" placeholder="ä¾‹å¦‚: 300" min="1" max="7200">
              <button id="setTimer" data-zh="è®¾ç½®" data-en="Set">è®¾ç½®</button>
            </div>
            <div class="timer-controls">
              <button class="timer-btn" id="startTimer" data-zh="å¼€å§‹" data-en="Start">å¼€å§‹</button>
              <button class="timer-btn" id="pauseTimer" data-zh="æš‚åœ" data-en="Pause">æš‚åœ</button>
              <button class="timer-btn" id="resetTimer" data-zh="é‡ç½®" data-en="Reset">é‡ç½®</button>
            </div>
            <div class="timer-presets">
              <button class="preset-btn" data-time="300" data-zh="5åˆ†é’Ÿ" data-en="5min">5åˆ†é’Ÿ</button>
              <button class="preset-btn" data-time="600" data-zh="10åˆ†é’Ÿ" data-en="10min">10åˆ†é’Ÿ</button>
              <button class="preset-btn" data-time="1800" data-zh="30åˆ†é’Ÿ" data-en="30min">30åˆ†é’Ÿ</button>
            </div>
          </div>
        </div>
      </div>



      <!-- è¥å…»è®¡ç®—å™¨ -->
      <div class="fitness-card">
        <div class="fitness-card-header">
          <i class="fas fa-calculator"></i>
          <h3 data-zh="è¥å…»è®¡ç®—å™¨" data-en="Nutrition Calculator">è¥å…»è®¡ç®—å™¨</h3>
        </div>
        <div class="fitness-card-content">
          <div class="nutrition-calc">
            <div class="calc-input">
              <label data-zh="ä½“é‡ (kg)" data-en="Weight (kg)">ä½“é‡ (kg)</label>
              <input type="number" id="weight" placeholder="70">
            </div>
            <div class="calc-input">
              <label data-zh="èº«é«˜ (cm)" data-en="Height (cm)">èº«é«˜ (cm)</label>
              <input type="number" id="height" placeholder="175">
            </div>
            <div class="calc-input">
              <label data-zh="å¹´é¾„" data-en="Age">å¹´é¾„</label>
              <input type="number" id="age" placeholder="25">
            </div>
            <div class="calc-input">
              <label data-zh="æ´»åŠ¨æ°´å¹³" data-en="Activity Level">æ´»åŠ¨æ°´å¹³</label>
              <select id="activity">
                <option value="1.2" data-zh="ä¹…åä¸åŠ¨" data-en="Sedentary">ä¹…åä¸åŠ¨</option>
                <option value="1.375" data-zh="è½»åº¦æ´»åŠ¨" data-en="Lightly Active">è½»åº¦æ´»åŠ¨</option>
                <option value="1.55" data-zh="ä¸­åº¦æ´»åŠ¨" data-en="Moderately Active">ä¸­åº¦æ´»åŠ¨</option>
                <option value="1.725" data-zh="é«˜åº¦æ´»åŠ¨" data-en="Very Active">é«˜åº¦æ´»åŠ¨</option>
                <option value="1.9" data-zh="æé«˜æ´»åŠ¨" data-en="Extremely Active">æé«˜æ´»åŠ¨</option>
              </select>
            </div>
            <button class="calc-btn" id="calculateBMR" data-zh="è®¡ç®—åŸºç¡€ä»£è°¢ç‡" data-en="Calculate BMR">è®¡ç®—åŸºç¡€ä»£è°¢ç‡</button>
            <div class="calc-result" id="bmrResult"></div>
          </div>
        </div>
      </div>

      

      <!-- æ‰“å¡æ—¥å† -->
      <div class="fitness-card checkin-calendar-card">
        <div class="fitness-card-header">
          <i class="fas fa-calendar-check"></i>
          <h3 data-zh="æ‰“å¡æ—¥å†" data-en="Check-in Calendar">æ‰“å¡æ—¥å†</h3>
        </div>
        <div class="fitness-card-content">
          <div class="checkin-calendar-container">
            <!-- æ—¥å†å¯¼èˆª -->
            <div class="calendar-nav">
              <button class="nav-btn" id="prevMonth"><i class="fas fa-chevron-left"></i></button>
              <div class="current-month" id="currentMonth">2024å¹´1æœˆ</div>
              <button class="nav-btn" id="nextMonth"><i class="fas fa-chevron-right"></i></button>
              <button class="nav-btn today-btn" id="goToday">ä»Šå¤©</button>
            </div>
            
            <!-- è¿ç»­æ‰“å¡ä¿¡æ¯ -->
            <div class="streak-info">
              <div class="streak-item">
                <i class="fas fa-fire"></i>
                <span>è¿ç»­ <span id="currentStreak">0</span> å¤©</span>
              </div>
              <div class="streak-item">
                <i class="fas fa-trophy"></i>
                <span>æœ€é•¿ <span id="longestStreak">0</span> å¤©</span>
              </div>
            </div>
            
            <!-- æ—¥å†ç½‘æ ¼ -->
            <div class="calendar-grid">
              <div class="calendar-header">
                <div>æ—¥</div>
                <div>ä¸€</div>
                <div>äºŒ</div>
                <div>ä¸‰</div>
                <div>å››</div>
                <div>äº”</div>
                <div>å…­</div>
              </div>
              <div class="calendar-body" id="calendarBody">
                <!-- æ—¥å†æ—¥æœŸå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
              </div>
            </div>
            
            <!-- æœˆåº¦ç»Ÿè®¡ -->
            <div class="monthly-stats">
              <div class="stat-item">
                <div class="stat-value" id="completionRate">0%</div>
                <div class="stat-label">å®Œæˆç‡</div>
              </div>
              <div class="stat-item">
                <div class="stat-value" id="totalDuration">0</div>
                <div class="stat-label">æ€»æ—¶é•¿(åˆ†é’Ÿ)</div>
              </div>
              <div class="stat-item">
                <div class="stat-value" id="completedDays">0</div>
                <div class="stat-label">å®Œæˆå¤©æ•°</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- è®­ç»ƒè®¡åˆ’ç®¡ç† -->
      <div class="fitness-card">
        <div class="fitness-card-header">
          <i class="fas fa-clipboard-list"></i>
          <h3>è®­ç»ƒè®¡åˆ’ç®¡ç†</h3>
          <button class="plan-action-btn" onclick="openTrainingPlanEditor()" title="åˆ›å»ºæ–°è®¡åˆ’">
            <i class="fas fa-plus"></i>
          </button>
        </div>
        <div class="fitness-card-content">
          <div class="plan-management-section">
            <div class="plan-library-header">
              <h4>æˆ‘çš„è®¡åˆ’åº“</h4>
              <button class="refresh-plans-btn" onclick="refreshPlanLibrary()" title="åˆ·æ–°è®¡åˆ’åº“">
                <i class="fas fa-sync-alt"></i>
              </button>
            </div>
            <div class="plan-library-container" id="planLibraryContainer">
              <div class="loading-message">æ­£åœ¨åŠ è½½è®¡åˆ’åº“...</div>
            </div>
          </div>
          
          <div class="plan-stats" id="planStats">
            <div class="stat-item">
              <span class="stat-label">ä¿å­˜çš„è®¡åˆ’:</span>
              <span class="stat-value" id="totalPlansCount">0</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">æ¿€æ´»è®¡åˆ’:</span>
              <span class="stat-value" id="activePlanName">æ— </span>
            </div>
            <div class="stat-item">
              <span class="stat-label">è®¡åˆ’å®Œæˆåº¦:</span>
              <span class="stat-value" id="planCompletionRate">0%</span>
            </div>
          </div>
        </div>
      </div>

      <!-- å¥èº«ç¤¾åŒº -->
      <div class="fitness-card">
        <div class="fitness-card-header">
          <i class="fas fa-users"></i>
          <h3 data-zh="å¥èº«ç¤¾åŒº" data-en="Fitness Community">å¥èº«ç¤¾åŒº</h3>
          <button class="community-btn" onclick="openFitnessCommunity()" data-zh="è¿›å…¥ç¤¾åŒº" data-en="Join Community">
            <i class="fas fa-arrow-right"></i> è¿›å…¥ç¤¾åŒº
          </button>
        </div>
        <div class="fitness-card-content">
          <div class="community-preview">
            <div class="community-stats">
              <div class="stat-item">
                <div class="stat-value" id="communityMembers">0</div>
                <div class="stat-label">ç¤¾åŒºæˆå‘˜</div>
              </div>
              <div class="stat-item">
                <div class="stat-value" id="communityPosts">0</div>
                <div class="stat-label">ä»Šæ—¥åŠ¨æ€</div>
              </div>
              <div class="stat-item">
                <div class="stat-value" id="communityLikes">0</div>
                <div class="stat-label">ä»Šæ—¥ç‚¹èµ</div>
              </div>
            </div>
            <div class="community-features">
              <div class="feature-item">
                <i class="fas fa-share-alt"></i>
                <span>åˆ†äº«è®­ç»ƒæˆæœ</span>
              </div>
              <div class="feature-item">
                <i class="fas fa-trophy"></i>
                <span>å±•ç¤ºæˆå°±å¾½ç« </span>
              </div>
              <div class="feature-item">
                <i class="fas fa-users"></i>
                <span>å…³æ³¨å¥èº«è¾¾äºº</span>
              </div>
              <div class="feature-item">
                <i class="fas fa-comments"></i>
                <span>äº¤æµè®­ç»ƒå¿ƒå¾—</span>
              </div>
            </div>
            <div class="community-actions">
              <button class="action-btn primary" onclick="openFitnessCommunity()">
                <i class="fas fa-users"></i> æµè§ˆç¤¾åŒº
              </button>
              <button class="action-btn secondary" onclick="openFitnessProfile()">
                <i class="fas fa-user"></i> ä¸ªäººæ¡£æ¡ˆ
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- å¥èº«å·¥å…· -->
      <div class="fitness-card">
        <div class="fitness-card-header">
          <i class="fas fa-tools"></i>
          <h3 data-zh="å¥èº«å·¥å…·" data-en="Fitness Tools">å¥èº«å·¥å…·</h3>
          <button class="tools-btn" onclick="openFitnessTools()" data-zh="æ›´å¤šå·¥å…·" data-en="More Tools">
            <i class="fas fa-arrow-right"></i> æ›´å¤šå·¥å…·
          </button>
        </div>
        <div class="fitness-card-content">
          <div class="tools-grid">
            <div class="tool-item" onclick="openFitnessTools()">
              <i class="fas fa-stopwatch"></i>
              <span>è®­ç»ƒè®¡æ—¶å™¨</span>
            </div>
            <div class="tool-item" onclick="openFitnessTools()">
              <i class="fas fa-calculator"></i>
              <span>è¥å…»è®¡ç®—å™¨</span>
            </div>
            <div class="tool-item" onclick="openFitnessTools()">
              <i class="fas fa-chart-line"></i>
              <span>è¿›åº¦è¿½è¸ª</span>
            </div>
            <div class="tool-item" onclick="openFitnessTools()">
              <i class="fas fa-dumbbell"></i>
              <span>åŠ¨ä½œåº“</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.fitness-container {
  min-height: 100vh;
  background: var(--rage-bg, linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%));
  padding: 20px;
  position: relative;
}

.fitness-header {
  text-align: center;
  margin-bottom: 40px;
  padding: 40px 0;
}

.fitness-title {
  font-size: 3rem;
  font-weight: 900;
  color: var(--rage-primary, #ff6b35);
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 20px;
  text-shadow: 0 0 20px rgba(255, 107, 53, 0.5);
}

.fitness-title i {
  font-size: 2.5rem;
  animation: pulse 2s infinite;
}

.fitness-subtitle {
  font-size: 1.2rem;
  color: var(--rage-text-muted, #a8a8a8);
  font-family: var(--rage-font-mono, 'JetBrains Mono', monospace);
  text-transform: uppercase;
  letter-spacing: 2px;
}

.fitness-main {
  max-width: 1400px;
  margin: 0 auto;
}

.fitness-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 30px;
}

.fitness-card {
  background: var(--rage-gradient-card, linear-gradient(135deg, rgba(26,26,46,0.9) 0%, rgba(22,33,62,0.9) 100%));
  border: 2px solid var(--rage-border, rgba(255, 107, 53, 0.3));
  border-radius: 16px;
  overflow: hidden;
  transition: all 0.3s ease;
  position: relative;
}

.fitness-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 15px 35px rgba(255, 107, 53, 0.3);
  border-color: var(--rage-primary, #ff6b35);
}

.fitness-card-header {
  background: var(--rage-gradient, linear-gradient(135deg, #ff6b35 0%, #f7931e 100%));
  color: #000;
  padding: 20px;
  display: flex;
  align-items: center;
  gap: 15px;
}

.fitness-card-header i {
  font-size: 1.5rem;
}

.fitness-card-header h3 {
  margin: 0;
  font-weight: 700;
  font-size: 1.3rem;
}

.fitness-card-content {
  padding: 25px;
}

/* è®­ç»ƒè®¡åˆ’æ ·å¼ */
.workout-plan {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.plan-day {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 15px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 8px;
  border: 1px solid rgba(255, 107, 53, 0.2);
  transition: all 0.3s ease;
  cursor: pointer;
}

.plan-day:hover {
  background: rgba(255, 107, 53, 0.1);
  border-color: var(--rage-primary, #ff6b35);
}

.plan-day.active {
  background: var(--rage-primary, #ff6b35);
  color: #000;
  font-weight: 600;
}

.plan-day.today {
  border: 2px solid #4CAF50;
  background: linear-gradient(45deg, rgba(76, 175, 80, 0.1), rgba(76, 175, 80, 0.2));
  animation: todayPulse 2s ease-in-out infinite;
}

.plan-day.today.active {
  background: linear-gradient(45deg, #4CAF50, #66BB6A);
  color: white;
  border: 2px solid #388E3C;
}

@keyframes todayPulse {
  0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.4); }
  70% { box-shadow: 0 0 0 8px rgba(76, 175, 80, 0); }
  100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
}

.plan-type {
  font-size: 0.9rem;
  opacity: 0.8;
  font-weight: 600;
  flex: 1;
  text-align: center;
}

/* æ–°å¢çš„è®­ç»ƒè®¡åˆ’æ ·å¼ */
.current-plan-preview {
  width: 100%;
}

.plan-info {
  text-align: center;
  margin-bottom: 20px;
  padding: 15px;
  background: rgba(255, 107, 53, 0.1);
  border-radius: 8px;
  border: 1px solid rgba(255, 107, 53, 0.3);
}

.plan-info h4 {
  color: var(--rage-primary, #ff6b35);
  margin: 0 0 5px 0;
  font-size: 1.1rem;
}

.plan-info p {
  color: var(--rage-text-muted, #a8a8a8);
  margin: 0;
  font-size: 0.9rem;
}

.edit-plan-btn {
  background: var(--rage-primary, #ff6b35);
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.9rem;
  font-weight: 600;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 6px;
}

.edit-plan-btn:hover {
  background: var(--rage-secondary, #ff5722);
  transform: translateY(-2px);
}

.fitness-card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.plan-exercises {
  font-size: 0.8rem;
  color: var(--rage-text-muted, #a8a8a8);
  font-style: italic;
}

.plan-actions {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.action-btn {
  flex: 1;
  min-width: 120px;
  padding: 10px 15px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.9rem;
  font-weight: 600;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}

.action-btn.primary {
  background: var(--rage-primary, #ff6b35);
  color: white;
}

.action-btn.primary:hover {
  background: var(--rage-secondary, #ff5722);
  transform: translateY(-2px);
}

.action-btn.enhanced {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  font-weight: bold;
}

.action-btn.enhanced:hover {
  background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}

.action-btn.secondary {
  background: rgba(255, 255, 255, 0.1);
  color: var(--rage-text, #e6e6e6);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.action-btn.secondary:hover {
  background: rgba(255, 255, 255, 0.2);
  border-color: rgba(255, 255, 255, 0.3);
}

/* è®¡æ—¶å™¨æ ·å¼ */
.timer-display {
  text-align: center;
}

.timer-time {
  font-size: 3rem;
  font-weight: 900;
  color: var(--rage-primary, #ff6b35);
  font-family: var(--rage-font-mono, 'JetBrains Mono', monospace);
  margin-bottom: 20px;
  text-shadow: 0 0 10px rgba(255, 107, 53, 0.5);
}

.timer-controls {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin-bottom: 20px;
}

.timer-btn {
  padding: 12px 24px;
  border: 2px solid var(--rage-primary, #ff6b35);
  background: transparent;
  color: var(--rage-primary, #ff6b35);
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
  font-family: var(--rage-font-mono, 'JetBrains Mono', monospace);
}

.timer-btn:hover {
  background: var(--rage-primary, #ff6b35);
  color: #000;
  transform: translateY(-2px);
}

.timer-presets {
  display: flex;
  gap: 10px;
  justify-content: center;
  flex-wrap: wrap;
}

.preset-btn {
  padding: 8px 16px;
  border: 1px solid rgba(255, 107, 53, 0.3);
  background: rgba(255, 107, 53, 0.1);
  color: var(--rage-text, #e6e6e6);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 0.9rem;
}

.preset-btn:hover {
  background: var(--rage-primary, #ff6b35);
  color: #000;
}

/* è¿åŠ¨è®°å½•æ ·å¼ */
.workout-log {
  margin-bottom: 20px;
}

.log-entry {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
  border-bottom: 1px solid rgba(255, 107, 53, 0.2);
}

.log-entry:last-child {
  border-bottom: none;
}

.log-date {
  color: var(--rage-text-muted, #a8a8a8);
  font-size: 0.9rem;
}

.log-workout {
  color: var(--rage-primary, #ff6b35);
  font-weight: 600;
}

.log-duration {
  color: var(--rage-text, #e6e6e6);
  font-size: 0.9rem;
}

.add-log-btn {
  width: 100%;
  padding: 12px;
  background: var(--rage-primary, #ff6b35);
  color: #000;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
}

.add-log-btn:hover {
  background: #e55a2b;
  transform: translateY(-2px);
}

/* è¥å…»è®¡ç®—å™¨æ ·å¼ */
.nutrition-calc {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.calc-input {
  display: flex;
  flex-direction: column;
  gap: 5px;
}

.calc-input label {
  color: var(--rage-text, #e6e6e6);
  font-weight: 600;
  font-size: 0.9rem;
}

.calc-input input,
.calc-input select {
  padding: 10px;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 107, 53, 0.3);
  border-radius: 6px;
  color: var(--rage-text, #e6e6e6);
  font-family: var(--rage-font-mono, 'JetBrains Mono', monospace);
}

.calc-input input:focus,
.calc-input select:focus {
  outline: none;
  border-color: var(--rage-primary, #ff6b35);
}

.calc-btn {
  padding: 12px;
  background: var(--rage-primary, #ff6b35);
  color: #000;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
}

.calc-btn:hover {
  background: #e55a2b;
  transform: translateY(-2px);
}

.calc-result {
  padding: 15px;
  background: rgba(255, 107, 53, 0.1);
  border: 1px solid rgba(255, 107, 53, 0.3);
  border-radius: 8px;
  color: var(--rage-primary, #ff6b35);
  font-weight: 600;
  text-align: center;
  display: none;
}

/* è§†é¢‘ç½‘æ ¼æ ·å¼ */
 

/* æˆå°±ç³»ç»Ÿæ ·å¼ */
.achievements {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.achievement {
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 15px;
  border-radius: 8px;
  transition: all 0.3s ease;
}

.achievement.unlocked {
  background: rgba(255, 107, 53, 0.1);
  border: 1px solid rgba(255, 107, 53, 0.3);
}

.achievement.locked {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  opacity: 0.5;
}

.achievement i {
  font-size: 1.5rem;
  color: var(--rage-primary, #ff6b35);
}

.achievement.locked i {
  color: var(--rage-text-muted, #a8a8a8);
}

.achievement-info {
  flex: 1;
}

.achievement-title {
  color: var(--rage-text, #e6e6e6);
  font-weight: 600;
  margin-bottom: 3px;
}

.achievement-desc {
  color: var(--rage-text-muted, #a8a8a8);
  font-size: 0.9rem;
}

.achievement-progress {
  margin-top: 8px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 4px;
  height: 6px;
  overflow: hidden;
}

.achievement-progress-bar {
  height: 100%;
  background: var(--rage-primary, #ff6b35);
  transition: width 0.3s ease;
}

.achievement-meta {
  text-align: right;
  font-size: 0.8rem;
  color: var(--rage-text-muted, #a8a8a8);
}

.loading-message {
  text-align: center;
  color: var(--rage-text-muted, #a8a8a8);
  padding: 20px;
}

.achievement-stats {
  display: flex;
  justify-content: space-between;
  margin-top: 20px;
  padding: 15px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 8px;
}

.stat-item {
  text-align: center;
}

.stat-label {
  display: block;
  color: var(--rage-text-muted, #a8a8a8);
  font-size: 0.8rem;
  margin-bottom: 5px;
}

.stat-value {
  color: var(--rage-primary, #ff6b35);
  font-weight: 600;
  font-size: 1.1rem;
}

.timer-input {
  margin-bottom: 15px;
  text-align: center;
}

.timer-input label {
  display: block;
  color: var(--rage-text-muted, #a8a8a8);
  margin-bottom: 8px;
  font-size: 0.9rem;
}

.timer-input input {
  width: 120px;
  padding: 8px 12px;
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 6px;
  background: rgba(255, 255, 255, 0.1);
  color: var(--rage-text, #e6e6e6);
  text-align: center;
  margin-right: 10px;
}

.timer-input button {
  padding: 8px 16px;
  background: var(--rage-primary, #ff6b35);
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
}

.timer-input button:hover {
  background: var(--rage-secondary, #ff5722);
}



/* åŠ¨ç”» */
@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

/* å“åº”å¼è®¾è®¡ - ä¼˜åŒ–æŒ‰é’®æ˜¾ç¤º */
@media (max-width: 768px) {
  .fitness-grid {
    grid-template-columns: 1fr;
  }
  
  .fitness-title {
    font-size: 2rem;
  }
  
  .timer-time {
    font-size: 2rem;
  }
  
  .timer-controls {
    flex-direction: column;
    gap: 8px;
  }
  
  .timer-btn {
    padding: 10px 20px;
    font-size: 0.9rem;
  }
  
  .timer-presets {
    gap: 6px;
  }
  
  .preset-btn {
    padding: 6px 12px;
    font-size: 0.8rem;
  }
  
  
}

@media (max-width: 480px) {
  .timer-controls {
    gap: 6px;
  }
  
  .timer-btn {
    padding: 8px 16px;
    font-size: 0.85rem;
  }
  
  .timer-presets {
    gap: 4px;
  }
  
  .preset-btn {
    padding: 5px 10px;
    font-size: 0.75rem;
  }
  
  .fitness-container {
    padding: 10px;
  }
  
  .fitness-card-content {
    padding: 15px;
  }
}

@media (max-width: 360px) {
  .timer-controls {
    gap: 4px;
  }
  
  .timer-btn {
    padding: 6px 12px;
    font-size: 0.8rem;
  }
  
  .timer-presets {
    gap: 3px;
  }
  
  .preset-btn {
    padding: 4px 8px;
    font-size: 0.7rem;
  }
  
  .fitness-container {
    padding: 5px;
  }
  
  .fitness-card-content {
    padding: 10px;
  }
}

/* å¿«æ·é”®æç¤ºæ ·å¼ */
.theme-switch-hint {
  position: fixed;
  top: 20px;
  left: 20px;
  z-index: 1000;
  background: rgba(255,255,255,0.95);
  padding: 12px 16px;
  border-radius: 8px;
  border: 1px solid rgba(102, 126, 234, 0.3);
  backdrop-filter: blur(10px);
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
}

.theme-switch-hint:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(0,0,0,0.15);
}

.hint-content {
  display: flex;
  align-items: center;
  gap: 8px;
  font-family: 'Arial', sans-serif;
  font-size: 0.9rem;
  color: #667eea;
  font-weight: 600;
}

.hint-content i {
  font-size: 1rem;
  color: #764ba2;
}

.hint-content span {
  white-space: nowrap;
}

.help-btn {
  background: rgba(102, 126, 234, 0.1);
  border: 1px solid rgba(102, 126, 234, 0.3);
  color: #667eea;
  border-radius: 4px;
  padding: 4px 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  margin-left: 8px;
}

.help-btn:hover {
  background: rgba(102, 126, 234, 0.2);
  transform: scale(1.1);
}

/* å¿«æ·é”®å¸®åŠ©æŒ‰é’®æ ·å¼ */
.shortcuts-help-btn {
  position: fixed;
  top: 20px;
  right: 20px;
  background: var(--rage-gradient, linear-gradient(135deg, #ff6b35 0%, #f7931e 100%));
  border: none;
  color: #000;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2rem;
  box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
  transition: all 0.3s ease;
  z-index: 1000;
}

.shortcuts-help-btn:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
}

/* å¿«æ·é”®å¸®åŠ©é¢æ¿æ ·å¼ */
.shortcuts-help-panel {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.8);
  background: rgba(255,255,255,0.98);
  border-radius: 16px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  backdrop-filter: blur(20px);
  border: 1px solid rgba(102, 126, 234, 0.2);
  z-index: 10000;
  max-width: 500px;
  width: 90%;
  max-height: 80vh;
  overflow: hidden;
  opacity: 0;
  visibility: hidden;
  transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.shortcuts-help-panel.show {
  opacity: 1;
  visibility: visible;
  transform: translate(-50%, -50%) scale(1);
}

.help-panel-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-radius: 16px 16px 0 0;
}

.help-panel-header h3 {
  margin: 0;
  font-size: 1.2rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 10px;
}

.close-help-btn {
  background: rgba(255,255,255,0.2);
  border: none;
  color: white;
  border-radius: 50%;
  width: 32px;
  height: 32px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.close-help-btn:hover {
  background: rgba(255,255,255,0.3);
  transform: scale(1.1);
}

.help-panel-content {
  padding: 20px;
  max-height: 60vh;
  overflow-y: auto;
}

.shortcuts-section {
  margin-bottom: 25px;
}

.shortcuts-section h4 {
  color: #667eea;
  font-size: 1rem;
  font-weight: 600;
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  gap: 8px;
  border-bottom: 2px solid rgba(102, 126, 234, 0.2);
  padding-bottom: 8px;
}

.shortcut-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 0;
  border-bottom: 1px solid rgba(0,0,0,0.05);
  transition: all 0.3s ease;
}

.shortcut-item:hover {
  background: rgba(102, 126, 234, 0.05);
  padding-left: 10px;
  border-radius: 6px;
}

.shortcut-key {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 6px 12px;
  border-radius: 6px;
  font-family: 'Courier New', monospace;
  font-weight: 600;
  font-size: 0.85rem;
  min-width: 80px;
  text-align: center;
  box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
}

.shortcut-desc {
  color: #333;
  font-weight: 500;
  flex: 1;
  margin-left: 15px;
}

/* é®ç½©å±‚ */
.help-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 9999;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
}

.help-overlay.show {
  opacity: 1;
  visibility: visible;
}

/* æ‰“å¡æ—¥å†æ ·å¼ */
.checkin-calendar-container {
  padding: 20px;
}

.calendar-nav {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 20px;
  gap: 10px;
}

.nav-btn {
  background: var(--rage-gradient, linear-gradient(135deg, #ff6b35 0%, #f7931e 100%));
  border: none;
  color: #000;
  padding: 8px 12px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  transition: all 0.3s ease;
}

.nav-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(255, 107, 53, 0.4);
}

.today-btn {
  background: var(--rage-primary, #ff6b35);
  color: white;
}

.current-month {
  font-size: 1.2rem;
  font-weight: bold;
  color: var(--rage-primary, #ff6b35);
  text-align: center;
  flex: 1;
}

.streak-info {
  display: flex;
  justify-content: space-around;
  margin-bottom: 20px;
  padding: 15px;
  background: rgba(255, 107, 53, 0.1);
  border-radius: 10px;
  border: 1px solid rgba(255, 107, 53, 0.3);
}

.streak-item {
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--rage-primary, #ff6b35);
  font-weight: bold;
}

.streak-item i {
  font-size: 1.2rem;
  animation: flame 1.5s ease-in-out infinite alternate;
}

@keyframes flame {
  0% { transform: scale(1); }
  100% { transform: scale(1.1); }
}

.calendar-grid {
  margin-bottom: 20px;
}

.calendar-header {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 2px;
  margin-bottom: 10px;
}

.calendar-header > div {
  text-align: center;
  font-weight: bold;
  color: var(--rage-primary, #ff6b35);
  padding: 10px;
  font-size: 0.9rem;
}

.calendar-body {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 2px;
}

.calendar-day {
  aspect-ratio: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 107, 53, 0.2);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-weight: bold;
  position: relative;
  overflow: hidden;
}

.calendar-day:hover {
  background: rgba(255, 107, 53, 0.2);
  transform: scale(1.05);
  z-index: 2;
}

.calendar-day.other-month {
  opacity: 0.3;
  background: rgba(255, 255, 255, 0.02);
}

.calendar-day.today {
  background: var(--rage-gradient, linear-gradient(135deg, #ff6b35 0%, #f7931e 100%));
  color: #000;
  border-color: var(--rage-primary, #ff6b35);
  box-shadow: 0 0 15px rgba(255, 107, 53, 0.5);
}

.calendar-day.completed {
  background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
  color: white;
  border-color: #28a745;
}

.calendar-day.completed::after {
  content: 'âœ“';
  position: absolute;
  top: 2px;
  right: 2px;
  font-size: 0.8rem;
  color: white;
}

.calendar-day.rest {
  background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
  color: white;
  border-color: #6c757d;
}

.calendar-day.rest::after {
  content: 'ğŸ˜´';
  position: absolute;
  top: 2px;
  right: 2px;
  font-size: 0.8rem;
}

.monthly-stats {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 15px;
  margin-top: 20px;
}

.stat-item {
  text-align: center;
  padding: 15px;
  background: rgba(255, 107, 53, 0.1);
  border-radius: 10px;
  border: 1px solid rgba(255, 107, 53, 0.3);
}

.stat-value {
  font-size: 1.5rem;
  font-weight: bold;
  color: var(--rage-primary, #ff6b35);
  margin-bottom: 5px;
}

.stat-label {
  font-size: 0.9rem;
  color: var(--rage-text-muted, #a8a8a8);
}

/* æ‰“å¡æ¨¡æ€æ¡†æ ·å¼ */
.checkin-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  backdrop-filter: blur(5px);
}

.checkin-modal-content {
  background: var(--rage-gradient-card, linear-gradient(135deg, rgba(26,26,46,0.95) 0%, rgba(22,33,62,0.95) 100%));
  border: 2px solid var(--rage-border, rgba(255, 107, 53, 0.3));
  border-radius: 16px;
  padding: 30px;
  max-width: 500px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  color: white;
}

.checkin-modal-content h3 {
  color: var(--rage-primary, #ff6b35);
  margin-bottom: 20px;
  text-align: center;
  font-size: 1.5rem;
}

.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  color: var(--rage-text-muted, #a8a8a8);
  font-weight: bold;
}

.form-group input,
.form-group select,
.form-group textarea {
  width: 100%;
  padding: 12px;
  border: 1px solid rgba(255, 107, 53, 0.3);
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.1);
  color: white;
  font-size: 14px;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
  outline: none;
  border-color: var(--rage-primary, #ff6b35);
  box-shadow: 0 0 10px rgba(255, 107, 53, 0.3);
}

.form-group input::placeholder,
.form-group textarea::placeholder {
  color: rgba(255, 255, 255, 0.5);
}

/* è®­ç»ƒéƒ¨ä½é€‰æ‹©æ ·å¼ */
.training-parts-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
  gap: 10px;
  margin-top: 8px;
}

.checkbox-label {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  border: 1px solid rgba(255, 107, 53, 0.3);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 14px;
  background: rgba(255, 255, 255, 0.05);
  color: white;
}

.checkbox-label:hover {
  border-color: var(--rage-primary, #ff6b35);
  background: rgba(255, 107, 53, 0.1);
}

.checkbox-label input[type="checkbox"]:checked + span {
  color: var(--rage-primary, #ff6b35);
  font-weight: 600;
}

.checkbox-label input[type="checkbox"] {
  margin: 0;
  accent-color: var(--rage-primary, #ff6b35);
}

/* æ˜Ÿçº§è¯„åˆ†æ ·å¼ */
.rating-container {
  margin-top: 8px;
}

.star-rating {
  display: flex;
  flex-direction: row-reverse;
  gap: 2px;
}

.star-rating input[type="radio"] {
  display: none;
}

.star-rating label {
  font-size: 24px;
  color: rgba(255, 255, 255, 0.3);
  cursor: pointer;
  transition: color 0.3s ease;
}

.star-rating label:hover,
.star-rating label:hover ~ label,
.star-rating input[type="radio"]:checked ~ label {
  color: #ffd700;
}

.star-rating input[type="radio"]:checked ~ label {
  color: #ffd700;
}

.checkin-detail {
  background: rgba(255, 255, 255, 0.05);
  padding: 20px;
  border-radius: 10px;
  margin-bottom: 20px;
}

.checkin-detail p {
  margin-bottom: 10px;
  line-height: 1.6;
}

.checkin-detail strong {
  color: var(--rage-primary, #ff6b35);
}

.form-actions {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
  margin-top: 20px;
}

.btn-cancel,
.btn-submit,
.btn-edit,
.btn-delete {
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  transition: all 0.3s ease;
}

.btn-cancel {
  background: rgba(255, 255, 255, 0.1);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.3);
}

.btn-submit,
.btn-edit {
  background: var(--rage-gradient, linear-gradient(135deg, #ff6b35 0%, #f7931e 100%));
  color: #000;
}

.btn-delete {
  background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
  color: white;
}

.btn-cancel:hover,
.btn-submit:hover,
.btn-edit:hover,
.btn-delete:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .calendar-nav {
    flex-wrap: wrap;
    gap: 5px;
  }
  
  .nav-btn {
    padding: 6px 10px;
    font-size: 0.9rem;
  }
  
  .current-month {
    font-size: 1rem;
    order: -1;
    width: 100%;
    margin-bottom: 10px;
  }
  
  .streak-info {
    flex-direction: column;
    gap: 10px;
  }
  
  .monthly-stats {
    grid-template-columns: 1fr;
  }
  
  .checkin-modal-content {
    padding: 20px;
    margin: 20px;
  }
  
  .form-actions {
    flex-direction: column;
  }
}

.community-preview {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.community-stats {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 15px;
}

.community-features {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 15px;
}

.feature-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px;
  background: rgba(255, 107, 53, 0.1);
  border-radius: 8px;
  border: 1px solid rgba(255, 107, 53, 0.3);
}

.feature-item i {
  color: var(--rage-primary, #ff6b35);
  font-size: 1.2rem;
}

.feature-item span {
  color: var(--rage-text, #e6e6e6);
  font-size: 0.9rem;
}

.community-actions {
  display: flex;
  gap: 10px;
  justify-content: center;
}

/* å¥èº«å·¥å…·æ ·å¼ */
.tools-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 15px;
}

.tool-item {
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
  padding: 20px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 8px;
  border: 1px solid rgba(255, 107, 53, 0.2);
}

.tool-item:hover {
  transform: translateY(-3px);
  background: rgba(255, 107, 53, 0.1);
  border-color: var(--rage-primary, #ff6b35);
}

.tool-item i {
  font-size: 2rem;
  color: var(--rage-primary, #ff6b35);
  margin-bottom: 10px;
  display: block;
}

.tool-item span {
  font-size: 0.9rem;
  color: var(--rage-text, #e6e6e6);
  font-weight: 600;
}

/* æŒ‰é’®æ ·å¼ */
.community-btn,
.tools-btn {
  background: var(--rage-primary, #ff6b35);
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.9rem;
  font-weight: 600;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 6px;
}

.community-btn:hover,
.tools-btn:hover {
  background: var(--rage-secondary, #ff5722);
  transform: translateY(-2px);
}

/* è®­ç»ƒè®¡åˆ’ç®¡ç†æ ·å¼ */
.plan-management-section {
  margin-bottom: 20px;
}

.plan-library-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  padding-bottom: 10px;
  border-bottom: 1px solid #eee;
}

.plan-library-header h4 {
  margin: 0;
  color: var(--rage-text, #fff);
  font-size: 1.1rem;
}

.refresh-plans-btn, .plan-action-btn {
  background: var(--rage-primary, #ff6b35);
  color: white;
  border: none;
  border-radius: 6px;
  padding: 8px 12px;
  cursor: pointer;
  font-size: 0.9rem;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 5px;
}

.refresh-plans-btn:hover, .plan-action-btn:hover {
  background: var(--rage-secondary, #e55a2b);
  transform: translateY(-1px);
}

.plan-library-container {
  max-height: 300px;
  overflow-y: auto;
  border: 1px solid var(--rage-border, #333);
  border-radius: 8px;
  padding: 10px;
  background: var(--rage-surface, rgba(255, 255, 255, 0.05));
}

.plan-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  margin-bottom: 8px;
  border-radius: 8px;
  background: var(--rage-card-bg, rgba(255, 255, 255, 0.1));
  border-left: 4px solid var(--rage-border, #666);
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
}

.plan-item.active {
  background: linear-gradient(135deg, rgba(40, 167, 69, 0.2), rgba(40, 167, 69, 0.1));
  border-left-color: var(--rage-success, #28a745);
  box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
}

.plan-item:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 8px var(--rage-glow, rgba(255, 107, 53, 0.2));
  background: var(--rage-hover, rgba(255, 255, 255, 0.15));
}

.plan-info {
  flex: 1;
}

.plan-name {
  font-weight: 600;
  margin-bottom: 4px;
  color: var(--rage-text, #fff);
}

.plan-details {
  font-size: 0.9rem;
  color: var(--rage-text-muted, #ccc);
  display: flex;
  gap: 15px;
}

.plan-actions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.plan-btn {
  padding: 6px 12px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.8rem;
  transition: all 0.3s ease;
  font-weight: 500;
}

.plan-btn.edit {
  background: var(--rage-info, #17a2b8);
  color: white;
}

.plan-btn.edit:hover {
  background: var(--rage-info-dark, #138496);
}

.plan-btn.apply {
  background: var(--rage-success, #28a745);
  color: white;
}

.plan-btn.apply:hover {
  background: var(--rage-success-dark, #218838);
}

.plan-btn.preview {
  background: var(--rage-secondary-alt, #6c757d);
  color: white;
}

.plan-btn.preview:hover {
  background: var(--rage-secondary-alt-dark, #545b62);
}

.plan-btn.delete {
  background: var(--rage-danger, #dc3545);
  color: white;
}

.plan-btn.delete:hover {
  background: var(--rage-danger-dark, #c82333);
}

.no-plans-message {
  text-align: center;
  color: var(--rage-text-muted, #ccc);
  font-style: italic;
  padding: 20px;
}
</style>

<script>
// å¿«æ·é”®æ”¯æŒ
document.addEventListener('keydown', function(e) {
  // åªåœ¨éè¾“å…¥æ¡†ä¸­å“åº”å¿«æ·é”®
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
    return;
  }
  
  // Ctrl/Cmd + æ•°å­—é”®åˆ‡æ¢ä¸»é¢˜
  if ((e.ctrlKey || e.metaKey) && !e.shiftKey && !e.altKey) {
    switch(e.key) {
      case '1':
        e.preventDefault();
        window.location.href = '/tools/life_diary/';
        break;
      case '2':
        e.preventDefault();
        window.location.href = '/tools/creative_writer/';
        break;
      case '3':
        e.preventDefault();
        window.location.href = '/tools/fitness/';
        break;
      case '4':
        e.preventDefault();
        window.location.href = '/tools/emo_diary/';
        break;
    }
  }
  
  // Alt + å­—æ¯é”®è·³è½¬åˆ°å·¥å…·é¡µé¢
  if (e.altKey && !e.ctrlKey && !e.metaKey && !e.shiftKey) {
    switch(e.key.toLowerCase()) {
      case 'e':
        e.preventDefault();
        window.location.href = '/tools/emo_diary/';
        break;
      case 'l':
        e.preventDefault();
        window.location.href = '/tools/life_diary/';
        break;
      case 'f':
        e.preventDefault();
        window.location.href = '/tools/fitness/';
        break;
      case 'c':
        e.preventDefault();
        window.location.href = '/tools/creative_writer/';
        break;
      case 'p':
        e.preventDefault();
        window.location.href = '/tools/pdf_converter/';
        break;
      case 'r':
        e.preventDefault();
        // window.location.href = '/tools/redbook_generator/'; // å·²éšè—
        break;
      case 't':
        e.preventDefault();
        window.location.href = '/tools/test_case_generator/';
        break;
      case 'w':
        e.preventDefault();
        window.location.href = '/tools/web_crawler/';
        break;
      case 's':
        e.preventDefault();
        window.location.href = '{% url "tools:self_analysis" %}';
        break;
      case 'b':
        e.preventDefault();
        window.location.href = '/tools/storyboard/';
        break;
      case 'm':
        e.preventDefault();
        window.location.href = '/tools/music_healing/';
        break;
      case 'd':
        e.preventDefault();
        window.location.href = '/tools/meditation_guide/';
        break;
      case 'a':
        e.preventDefault();
        window.location.href = '/tools/fortune_analyzer/';
        break;
    }
  }
});

// åˆå§‹åŒ–å¿«æ·é”®å¸®åŠ©é¢æ¿
function initShortcutsHelp() {
  const helpBtn = document.getElementById('showShortcutsHelp');
  const helpPanel = document.getElementById('shortcutsHelpPanel');
  const closeBtn = document.getElementById('closeShortcutsHelp');
  const overlay = document.getElementById('helpOverlay');
  
  // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
  if (!helpBtn || !helpPanel || !closeBtn || !overlay) {
    console.warn('å¿«æ·é”®å¸®åŠ©é¢æ¿å…ƒç´ æœªæ‰¾åˆ°ï¼Œè·³è¿‡åˆå§‹åŒ–');
    return;
  }
  
  // æ˜¾ç¤ºå¸®åŠ©é¢æ¿
  helpBtn.addEventListener('click', function() {
    helpPanel.classList.add('show');
    overlay.classList.add('show');
    document.body.style.overflow = 'hidden'; // é˜²æ­¢èƒŒæ™¯æ»šåŠ¨
  });
  
  // å…³é—­å¸®åŠ©é¢æ¿
  function closeHelpPanel() {
    helpPanel.classList.remove('show');
    overlay.classList.remove('show');
    document.body.style.overflow = ''; // æ¢å¤æ»šåŠ¨
  }
  
  closeBtn.addEventListener('click', closeHelpPanel);
  overlay.addEventListener('click', closeHelpPanel);
  
  // ESCé”®å…³é—­å¸®åŠ©é¢æ¿
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && helpPanel.classList.contains('show')) {
      closeHelpPanel();
    }
  });
}

// åˆå§‹åŒ–å½“å‰è®­ç»ƒè®¡åˆ’
async function initCurrentPlan() {
  try {
    const response = await fetch('/tools/api/training_plans/active/');
    const data = await response.json();
    
    if (data.success && data.has_plan) {
      renderActivePlan(data.plan);
    } else {
      renderNoPlan();
    }
  } catch (error) {
    console.error('åŠ è½½å½“å‰è®¡åˆ’å¤±è´¥:', error);
    renderNoPlan();
  }
}

// æ¸²æŸ“æ¿€æ´»çš„è®­ç»ƒè®¡åˆ’
function renderActivePlan(plan) {
  const planContainer = document.getElementById('workoutPlan');
  if (!planContainer) return;
  
  const planPreview = document.querySelector('.current-plan-preview');
  if (planPreview) {
    planPreview.innerHTML = `
      <h4>å½“å‰è®¡åˆ’ï¼š${plan.name}</h4>
      <p>${plan.mode} â€¢ ${plan.cycle_weeks}å‘¨å‘¨æœŸ</p>
    `;
  }
  
  // æ¸²æŸ“å‘¨è®¡åˆ’ - åªæ˜¾ç¤ºä»Šå¤©çš„è®­ç»ƒ
  if (plan.week_schedule && Array.isArray(plan.week_schedule)) {
    // è·å–å½“å‰æ˜ŸæœŸå‡ ï¼ˆ0=å‘¨æ—¥, 1=å‘¨ä¸€, ..., 6=å‘¨å…­ï¼‰
    const today = new Date();
    const currentDayOfWeek = today.getDay();
    const weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
    const currentWeekday = weekdays[currentDayOfWeek];
    
    // æ‰¾åˆ°ä»Šå¤©çš„è®­ç»ƒè®¡åˆ’
    let todaysPlan = null;
    let todaysIndex = -1;
    
    for (let i = 0; i < plan.week_schedule.length; i++) {
      const day = plan.week_schedule[i];
      const dayWeekday = day.weekday || weekdays[i] || `ç¬¬${i + 1}å¤©`;
      if (dayWeekday === currentWeekday) {
        todaysPlan = day;
        todaysIndex = i;
        break;
      }
    }
    
    if (todaysPlan) {
      // å®‰å…¨åœ°è·å–dayçš„å±æ€§
      const safeDay = {
        weekday: todaysPlan.weekday || currentWeekday,
        body_parts: Array.isArray(todaysPlan.body_parts) ? todaysPlan.body_parts : ['æœªè®¾ç½®'],
        exercises: todaysPlan.exercises || [],
        modules: todaysPlan.modules || {}
      };
      
      // è®¡ç®—åŠ¨ä½œæ•°é‡
      let exerciseCount = 0;
      if (safeDay.exercises && Array.isArray(safeDay.exercises)) {
        exerciseCount = safeDay.exercises.length;
      } else if (safeDay.modules) {
        exerciseCount = Object.values(safeDay.modules).reduce((sum, module) => sum + (Array.isArray(module) ? module.length : 0), 0);
      }
      
      const exerciseText = exerciseCount > 0 ? `${exerciseCount}ä¸ªåŠ¨ä½œ` : 
        (safeDay.body_parts.includes('ä¼‘æ¯') ? 'æ¢å¤æ—¥' : 'å¾…æ·»åŠ ');
      
      // ç”Ÿæˆä»Šå¤©çš„è¯¦ç»†åŠ¨ä½œåˆ—è¡¨
      let todaysExercisesList = '';
      if (safeDay.exercises && Array.isArray(safeDay.exercises) && safeDay.exercises.length > 0) {
        todaysExercisesList = safeDay.exercises.map((exercise, index) => {
          return `
            <div class="exercise-item" data-exercise-index="${index}" data-day-index="0" style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              padding: 15px;
              margin: 10px 0;
              background: linear-gradient(135deg, rgba(76, 175, 80, 0.05) 0%, rgba(76, 175, 80, 0.02) 100%);
              border: 1px solid rgba(76, 175, 80, 0.2);
              border-radius: 12px;
              border-left: 4px solid #4CAF50;
              box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
              transition: all 0.3s ease;
            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0, 0, 0, 0.12)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.08)'">
              <div class="exercise-info" style="flex: 1;">
                <div class="exercise-header" style="display: flex; align-items: center; margin-bottom: 8px;">
                  <div class="exercise-number" style="
                    background: #4CAF50;
                    color: white;
                    width: 24px;
                    height: 24px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 12px;
                    font-weight: bold;
                    margin-right: 12px;
                  ">${index + 1}</div>
                  <div class="exercise-name" style="font-weight: bold; color: white; font-size: 16px; line-height: 1.2; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">
                    ${exercise.name}
                  </div>
                </div>
                <div class="exercise-details" style="
                  color: #666;
                  font-size: 14px;
                  line-height: 1.4;
                  margin-left: 36px;
                  display: flex;
                  flex-wrap: wrap;
                  gap: 12px;
                ">
                  <span style="
                    background: rgba(76, 175, 80, 0.1);
                    padding: 4px 8px;
                    border-radius: 6px;
                    font-weight: 500;
                    color: #2E7D32;
                  ">
                    <i class="fas fa-repeat" style="margin-right: 4px;"></i>
                    ${exercise.sets || 3}ç»„
                  </span>
                  <span style="
                    background: rgba(33, 150, 243, 0.1);
                    padding: 4px 8px;
                    border-radius: 6px;
                    font-weight: 500;
                    color: #1565C0;
                  ">
                    <i class="fas fa-times" style="margin-right: 4px;"></i>
                    ${exercise.reps || '10-12'}æ¬¡
                  </span>
                  ${exercise.weight ? `
                    <span style="
                      background: rgba(255, 152, 0, 0.1);
                      padding: 4px 8px;
                      border-radius: 6px;
                      font-weight: 500;
                      color: #E65100;
                    ">
                      <i class="fas fa-dumbbell" style="margin-right: 4px;"></i>
                      ${exercise.weight}${(exercise.weight && (exercise.weight.toString().includes('kg') || /^(è‡ªé‡|ç©ºæ†)$/.test(exercise.weight.toString()) || exercise.weight.toString().includes('æ†'))) ? '' : 'kg'}
                    </span>
                  ` : ''}
                  ${exercise.rest ? `
                    <span style="
                      background: rgba(156, 39, 176, 0.1);
                      padding: 4px 8px;
                      border-radius: 6px;
                      font-weight: 500;
                      color: #7B1FA2;
                    ">
                      <i class="fas fa-clock" style="margin-right: 4px;"></i>
                      ä¼‘æ¯${exercise.rest}
                    </span>
                  ` : ''}
                </div>
              </div>
              <div class="exercise-actions" style="margin-left: 15px;">
                <button class="complete-btn" onclick="markExerciseDone(${index}, 0)" style="
                  background: linear-gradient(135deg, #4CAF50 0%, #45A049 100%);
                  color: white;
                  border: none;
                  padding: 8px 16px;
                  border-radius: 8px;
                  cursor: pointer;
                  font-size: 13px;
                  font-weight: 500;
                  box-shadow: 0 2px 6px rgba(76, 175, 80, 0.3);
                  transition: all 0.3s ease;
                  display: flex;
                  align-items: center;
                  gap: 6px;
                  min-width: 80px;
                  justify-content: center;
                " onmouseover="if(!this.classList.contains('completed')) { this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(76, 175, 80, 0.4)'; }" onmouseout="if(!this.classList.contains('completed')) { this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px rgba(76, 175, 80, 0.3)'; }">
                  <i class="fas fa-check"></i> å®Œæˆ
                </button>
              </div>
            </div>
          `;
        }).join('');
      } else if (safeDay.body_parts.includes('ä¼‘æ¯')) {
        todaysExercisesList = `
          <div class="rest-day-message" style="
            text-align: center;
            padding: 30px 20px;
            background: linear-gradient(135deg, rgba(156, 39, 176, 0.05) 0%, rgba(156, 39, 176, 0.02) 100%);
            border: 1px solid rgba(156, 39, 176, 0.2);
            border-radius: 12px;
            color: #7B1FA2;
            font-style: italic;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
          ">
            <div style="font-size: 48px; margin-bottom: 15px;">ğŸ˜´</div>
            <div style="font-size: 18px; font-weight: 500; margin-bottom: 8px;">ä¼‘æ¯æ—¥</div>
            <div style="font-size: 14px; color: #999;">å¥½å¥½æ¢å¤ä½“åŠ›ï¼Œä¸ºæ˜å¤©çš„è®­ç»ƒåšå‡†å¤‡</div>
          </div>
        `;
      } else {
        todaysExercisesList = `
          <div class="no-exercises-message" style="
            text-align: center;
            padding: 30px 20px;
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.05) 0%, rgba(255, 193, 7, 0.02) 100%);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 12px;
            color: #F57C00;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
          ">
            <div style="font-size: 48px; margin-bottom: 15px;">ğŸ“</div>
            <div style="font-size: 18px; font-weight: 500; margin-bottom: 8px;">å¾…æ·»åŠ åŠ¨ä½œ</div>
            <div style="font-size: 14px; color: #999; margin-bottom: 15px;">æš‚æœªå®‰æ’å…·ä½“è®­ç»ƒåŠ¨ä½œ</div>
            <button onclick="window.location.href='/tools/fitness/plan-editor/'" 
                    style="
                      padding: 10px 20px;
                      background: linear-gradient(135deg, #4CAF50 0%, #45A049 100%);
                      color: white;
                      border: none;
                      border-radius: 8px;
                      cursor: pointer;
                      font-size: 14px;
                      font-weight: 500;
                      box-shadow: 0 2px 6px rgba(76, 175, 80, 0.3);
                      transition: all 0.3s ease;
                    "
                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(76, 175, 80, 0.4)'"
                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px rgba(76, 175, 80, 0.3)'">
              <i class="fas fa-edit" style="margin-right: 6px;"></i> ç¼–è¾‘è®¡åˆ’
            </button>
          </div>
        `;
      }
      
      planContainer.innerHTML = `
        <div class="today-plan-container">
          <div class="plan-day active today" data-day="${todaysIndex + 1}" onclick="showDayDetails(${todaysIndex})" style="margin-bottom: 15px;">
            <span>${safeDay.weekday} ğŸŒŸ</span>
            <span class="plan-type">${safeDay.body_parts.join(' + ')}</span>
            <span class="plan-exercises">${exerciseText}</span>
          </div>
          
          <div class="today-exercises-details" style="margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin: 10px 0;">
              <h5 style="color: #333; margin: 0; font-size: 14px; font-weight: bold;">
                <i class="fas fa-dumbbell"></i> ä»Šæ—¥è®­ç»ƒè¯¦æƒ…
              </h5>
              <div class="training-progress" style="
                background: rgba(76, 175, 80, 0.1);
                padding: 4px 12px;
                border-radius: 12px;
                font-size: 12px;
                color: #4CAF50;
                font-weight: 500;
              ">
                è®­ç»ƒè¿›åº¦: 0% (0/0)
              </div>
            </div>
            ${todaysExercisesList}
          </div>
          
          <div class="action-buttons" style="display: flex; gap: 10px;">
            <div class="view-full-plan-btn" onclick="showFullWeekPlan()" style="
              flex: 1;
              text-align: center;
              padding: 12px;
              background: rgba(76, 175, 80, 0.1);
              border: 1px dashed #4CAF50;
              border-radius: 8px;
              cursor: pointer;
              color: #4CAF50;
              font-size: 13px;
              transition: all 0.3s ease;
            ">
              <i class="fas fa-eye"></i> æŸ¥çœ‹å®Œæ•´å‘¨è®¡åˆ’
            </div>
            <div class="export-today-btn" onclick="exportTodayPlan()" style="
              flex: 1;
              text-align: center;
              padding: 12px;
              background: rgba(33, 150, 243, 0.1);
              border: 1px dashed #2196F3;
              border-radius: 8px;
              cursor: pointer;
              color: #2196F3;
              font-size: 13px;
              transition: all 0.3s ease;
            ">
              <i class="fas fa-download"></i> å¯¼å‡ºä»Šæ—¥è®¡åˆ’
            </div>
          </div>
        </div>
      `;
      
      // å»¶è¿Ÿæ¢å¤å®ŒæˆçŠ¶æ€
      setTimeout(() => {
        restoreExerciseCompletions();
      }, 100);
    } else {
      // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä»Šå¤©çš„è®¡åˆ’ï¼Œæ˜¾ç¤ºæç¤º
      planContainer.innerHTML = `
        <div class="no-plan-today" style="
          text-align: center;
          padding: 20px;
          color: #666;
          background: rgba(0, 0, 0, 0.05);
          border-radius: 8px;
        ">
          <i class="fas fa-calendar-times" style="font-size: 24px; margin-bottom: 10px; color: #999;"></i>
          <p>ä»Šå¤©æ²¡æœ‰å®‰æ’è®­ç»ƒ</p>
          <button onclick="showFullWeekPlan()" class="btn-secondary" style="margin-top: 10px;">
            <i class="fas fa-eye"></i> æŸ¥çœ‹å®Œæ•´å‘¨è®¡åˆ’
          </button>
        </div>
      `;
    }
  }
  
  // é‡æ–°ç»‘å®šç‚¹å‡»äº‹ä»¶
  bindPlanDayEvents();
}

// æ¸²æŸ“æ— è®¡åˆ’çŠ¶æ€
function renderNoPlan() {
  const planContainer = document.getElementById('workoutPlan');
  if (!planContainer) return;
  
  const planPreview = document.querySelector('.current-plan-preview');
  if (planPreview) {
    planPreview.innerHTML = `
      <h4>æš‚æ— æ¿€æ´»è®¡åˆ’</h4>
      <p>é€‰æ‹©æ¨¡æ¿æˆ–åˆ›å»ºæ–°è®¡åˆ’å¼€å§‹è®­ç»ƒ</p>
    `;
  }
  
  // æ˜¾ç¤ºé»˜è®¤çš„å‘¨è®¡åˆ’å¸ƒå±€
  planContainer.innerHTML = `
    <div class="plan-day" data-day="1">
      <span>å‘¨ä¸€</span>
      <span class="plan-type">å¾…å®‰æ’</span>
      <span class="plan-exercises">é€‰æ‹©è®¡åˆ’</span>
    </div>
    <div class="plan-day" data-day="2">
      <span>å‘¨äºŒ</span>
      <span class="plan-type">å¾…å®‰æ’</span>
      <span class="plan-exercises">é€‰æ‹©è®¡åˆ’</span>
    </div>
    <div class="plan-day" data-day="3">
      <span>å‘¨ä¸‰</span>
      <span class="plan-type">å¾…å®‰æ’</span>
      <span class="plan-exercises">é€‰æ‹©è®¡åˆ’</span>
    </div>
    <div class="plan-day" data-day="4">
      <span>å‘¨å››</span>
      <span class="plan-type">å¾…å®‰æ’</span>
      <span class="plan-exercises">é€‰æ‹©è®¡åˆ’</span>
    </div>
    <div class="plan-day" data-day="5">
      <span>å‘¨äº”</span>
      <span class="plan-type">å¾…å®‰æ’</span>
      <span class="plan-exercises">é€‰æ‹©è®¡åˆ’</span>
    </div>
    <div class="plan-day" data-day="6">
      <span>å‘¨å…­</span>
      <span class="plan-type">å¾…å®‰æ’</span>
      <span class="plan-exercises">é€‰æ‹©è®¡åˆ’</span>
    </div>
    <div class="plan-day" data-day="7">
      <span>å‘¨æ—¥</span>
      <span class="plan-type">å¾…å®‰æ’</span>
      <span class="plan-exercises">é€‰æ‹©è®¡åˆ’</span>
    </div>
  `;
  
  bindPlanDayEvents();
}

// ç»‘å®šè®¡åˆ’å¤©ç‚¹å‡»äº‹ä»¶
function bindPlanDayEvents() {
  document.querySelectorAll('.plan-day').forEach(day => {
    day.addEventListener('click', function() {
      // ç§»é™¤å…¶ä»–æ´»åŠ¨çŠ¶æ€
      document.querySelectorAll('.plan-day').forEach(d => d.classList.remove('active'));
      // æ·»åŠ å½“å‰æ´»åŠ¨çŠ¶æ€
      this.classList.add('active');
    });
  });
}

// æ˜¾ç¤ºæŸå¤©çš„è®­ç»ƒè¯¦æƒ…
async function showDayDetails(dayIndex) {
  try {
    const response = await fetch('/tools/api/training_plans/active/');
    const data = await response.json();
    
    if (data.success && data.has_plan && data.plan.week_schedule) {
      const dayData = data.plan.week_schedule[dayIndex];
      if (dayData) {
        showDayDetailsModal(dayData, dayIndex + 1);
      }
    } else {
      showNoPlanModal();
    }
  } catch (error) {
    console.error('è·å–è®­ç»ƒè¯¦æƒ…å¤±è´¥:', error);
    alert('è·å–è®­ç»ƒè¯¦æƒ…å¤±è´¥ï¼Œè¯·é‡è¯•');
  }
}

// æ˜¾ç¤ºå®Œæ•´å‘¨è®¡åˆ’
async function showFullWeekPlan() {
  try {
    const response = await fetch('/tools/api/training_plans/active/');
    const data = await response.json();
    
    if (data.success && data.has_plan && data.plan) {
      showFullWeekPlanModal(data.plan);
    } else {
      showNoPlanModal();
    }
  } catch (error) {
    console.error('è·å–è®­ç»ƒè®¡åˆ’å¤±è´¥:', error);
    alert('è·å–è®­ç»ƒè®¡åˆ’å¤±è´¥ï¼Œè¯·é‡è¯•');
  }
}

// æ˜¾ç¤ºå®Œæ•´å‘¨è®¡åˆ’æ¨¡æ€æ¡†
function showFullWeekPlanModal(plan) {
  const modal = document.createElement('div');
  modal.className = 'checkin-modal';
  
  const weekdays = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];
  const today = new Date();
  const currentDayOfWeek = today.getDay();
  const currentWeekday = weekdays[currentDayOfWeek === 0 ? 6 : currentDayOfWeek - 1]; // è½¬æ¢ä¸ºå‘¨ä¸€å¼€å§‹
  
  let weekPlanHTML = '';
  if (plan.week_schedule && Array.isArray(plan.week_schedule)) {
    weekPlanHTML = plan.week_schedule.map((dayData, index) => {
      const dayName = weekdays[index] || dayData.weekday || `ç¬¬${index + 1}å¤©`;
      const isToday = dayName === currentWeekday;
      
      // å®‰å…¨åœ°è·å–è®­ç»ƒéƒ¨ä½
      let bodyParts = 'æœªè®¾ç½®';
      if (dayData.body_parts && Array.isArray(dayData.body_parts)) {
        bodyParts = dayData.body_parts.join(' + ');
      } else if (dayData.type) {
        bodyParts = dayData.type;
      }
      
      // è®¡ç®—åŠ¨ä½œæ•°é‡
      let exerciseCount = 0;
      let exerciseText = 'å¾…æ·»åŠ ';
      if (dayData.exercises && Array.isArray(dayData.exercises) && dayData.exercises.length > 0) {
        exerciseCount = dayData.exercises.length;
        exerciseText = `${exerciseCount}ä¸ªåŠ¨ä½œ`;
      } else if (bodyParts.includes('ä¼‘æ¯')) {
        exerciseText = 'æ¢å¤æ—¥';
      }
      
      return `
        <div class="week-plan-day ${isToday ? 'current-day' : ''}" 
             style="
               display: flex;
               align-items: center;
               padding: 15px;
               margin: 8px 0;
               background: ${isToday ? 'rgba(76, 175, 80, 0.1)' : 'rgba(255, 255, 255, 0.05)'};
               border-radius: 8px;
               border-left: 4px solid ${isToday ? '#4CAF50' : '#ddd'};
               cursor: pointer;
               transition: all 0.3s ease;
             "
             onclick="showDayDetails(${index}); document.querySelector('.checkin-modal').remove();">
          <div style="width: 80px; font-weight: bold; color: ${isToday ? '#4CAF50' : '#333'};">
            ${dayName}${isToday ? ' ğŸŒŸ' : ''}
          </div>
          <div style="width: 150px; color: #666; font-size: 14px;">
            ${bodyParts}
          </div>
          <div style="flex: 1; color: #333; font-size: 14px;">
            ${exerciseText}
          </div>
          <div style="color: #999; font-size: 12px;">
            <i class="fas fa-chevron-right"></i>
          </div>
        </div>
      `;
    }).join('');
  } else {
    weekPlanHTML = '<div style="text-align: center; color: #999; padding: 20px;">æš‚æ— è®­ç»ƒå®‰æ’</div>';
  }
  
  modal.innerHTML = `
    <div class="checkin-modal-content" style="max-width: 600px;">
      <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3><i class="fas fa-calendar-week"></i> å®Œæ•´å‘¨è®­ç»ƒè®¡åˆ’</h3>
        <div style="display: flex; gap: 10px; align-items: center;">
          <button onclick="exportFullWeekPlan()" style="
            background: #2196F3;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
          ">
            <i class="fas fa-download"></i> å¯¼å‡ºå®Œæ•´è®¡åˆ’
          </button>
          <button class="btn-cancel" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
        </div>
      </div>
      
      <div class="plan-info" style="background: rgba(76, 175, 80, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <h4 style="margin: 0 0 5px 0; color: #4CAF50;">${plan.name}</h4>
        <p style="margin: 0; color: #666; font-size: 14px;">${plan.mode} â€¢ ${plan.cycle_weeks}å‘¨å‘¨æœŸ</p>
      </div>
      
      <div class="week-schedule">
        ${weekPlanHTML}
      </div>
      
      <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; color: #888; font-size: 12px; text-align: center;">
        ç‚¹å‡»ä»»æ„ä¸€å¤©æŸ¥çœ‹è¯¦ç»†è®­ç»ƒå®‰æ’
      </div>
    </div>
  `;
  
  // æ·»åŠ å…³é—­äº‹ä»¶
  modal.querySelector('.btn-cancel').addEventListener('click', () => {
    modal.remove();
  });
  
  // ç‚¹å‡»èƒŒæ™¯å…³é—­
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.remove();
    }
  });
  
  document.body.appendChild(modal);
}

// å¯¼å‡ºä»Šæ—¥è®­ç»ƒè®¡åˆ’
async function exportTodayPlan() {
  try {
    showNotification('æ­£åœ¨ç”Ÿæˆä»Šæ—¥è®­ç»ƒå›¾ç‰‡...', 'info');
    
    // è·å–ä»Šå¤©çš„è®­ç»ƒè®¡åˆ’æ•°æ®
    const todayPlanData = await getTodayPlanData();
    if (!todayPlanData) {
      showNotification('æ²¡æœ‰ä»Šæ—¥è®­ç»ƒè®¡åˆ’å¯å¯¼å‡º', 'warning');
      return;
    }
    
    // åˆ›å»ºä»Šæ—¥è®¡åˆ’çš„å¯¼å‡ºå®¹å™¨
    const exportContainer = createTodayExportContainer(todayPlanData);
    document.body.appendChild(exportContainer);
    
    // ä½¿ç”¨html2canvasç”Ÿæˆå›¾ç‰‡
    try {
      if (!window.html2canvas) {
        await loadHtml2Canvas();
      }
      
      const canvas = await html2canvas(exportContainer, {
        backgroundColor: '#ffffff',
        scale: 2,
        scrollX: 0,
        scrollY: 0,
        useCORS: true,
        allowTaint: true,
        height: exportContainer.scrollHeight,
        width: exportContainer.scrollWidth
      });
      
      // æ¸…ç†ä¸´æ—¶å®¹å™¨
      document.body.removeChild(exportContainer);
      
      // ä¸‹è½½å›¾ç‰‡
      const today = new Date();
      const dateStr = today.toISOString().split('T')[0];
      const weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
      const todayName = weekdays[today.getDay()];
      
      const link = document.createElement('a');
      link.download = `ä»Šæ—¥è®­ç»ƒè®¡åˆ’_${todayName}_${dateStr}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
      
      showNotification('ä»Šæ—¥è®­ç»ƒè®¡åˆ’å¯¼å‡ºæˆåŠŸï¼', 'success');
      
    } catch (error) {
      document.body.removeChild(exportContainer);
      throw error;
    }
    
  } catch (error) {
    console.error('å¯¼å‡ºä»Šæ—¥è®¡åˆ’å¤±è´¥:', error);
    showNotification('å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
  }
}

// è·å–ä»Šæ—¥è®­ç»ƒè®¡åˆ’æ•°æ®
async function getTodayPlanData() {
  try {
    const response = await fetch('/tools/api/training_plans/active/');
    const data = await response.json();
    
    if (data.success && data.has_plan && data.plan && data.plan.week_schedule) {
      const plan = data.plan;
      const today = new Date();
      const currentDayOfWeek = today.getDay();
      const weekdays = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];
      const currentWeekday = weekdays[currentDayOfWeek === 0 ? 6 : currentDayOfWeek - 1];
      
      // æ‰¾åˆ°ä»Šå¤©çš„è®­ç»ƒè®¡åˆ’
      for (let i = 0; i < plan.week_schedule.length; i++) {
        const dayData = plan.week_schedule[i];
        const dayName = weekdays[i] || dayData.weekday || `ç¬¬${i + 1}å¤©`;
        if (dayName === currentWeekday) {
          // å®‰å…¨åœ°è·å–è®­ç»ƒéƒ¨ä½
          let bodyParts = 'æœªè®¾ç½®';
          if (dayData.body_parts && Array.isArray(dayData.body_parts)) {
            bodyParts = dayData.body_parts.join(' + ');
          } else if (dayData.type) {
            bodyParts = dayData.type;
          }
          
          return {
            planName: plan.name || 'è®­ç»ƒè®¡åˆ’',
            planMode: plan.mode || 'è‡ªå®šä¹‰',
            dayName: currentWeekday,
            bodyParts: bodyParts,
            exercises: dayData.exercises || [],
            isRestDay: bodyParts.includes('ä¼‘æ¯') || (dayData.exercises && dayData.exercises.length === 0)
          };
        }
      }
    }
    
    return null;
  } catch (error) {
    console.error('è·å–ä»Šæ—¥è®¡åˆ’æ•°æ®å¤±è´¥:', error);
    return null;
  }
}

// åˆ›å»ºä»Šæ—¥è®¡åˆ’å¯¼å‡ºå®¹å™¨
function createTodayExportContainer(todayPlan) {
  const container = document.createElement('div');
  container.style.cssText = `
    position: absolute;
    top: -10000px;
    left: -10000px;
    width: 600px;
    background: white;
    padding: 30px;
    font-family: 'Microsoft YaHei', Arial, sans-serif;
    color: #333;
    box-sizing: border-box;
  `;
  
  // ç”ŸæˆåŠ¨ä½œåˆ—è¡¨HTML
  let exercisesHTML = '';
  if (todayPlan.exercises && todayPlan.exercises.length > 0) {
    exercisesHTML = todayPlan.exercises.map((exercise, index) => {
      return `
        <div style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 12px;
          margin: 8px 0;
          background: rgba(76, 175, 80, 0.05);
          border-radius: 6px;
          border-left: 3px solid #4CAF50;
        ">
          <div>
            <div style="font-weight: bold; color: #333; font-size: 15px; margin-bottom: 4px;">
              ${index + 1}. ${exercise.name}
            </div>
            <div style="color: #666; font-size: 13px;">
              ${exercise.sets || 3}ç»„ Ã— ${exercise.reps || '10-12'}æ¬¡
              ${exercise.weight ? ` @ ${exercise.weight}${(exercise.weight && (exercise.weight.toString().includes('kg') || /^(è‡ªé‡|ç©ºæ†)$/.test(exercise.weight.toString()) || exercise.weight.toString().includes('æ†'))) ? '' : 'kg'}` : ''}
              ${exercise.rest ? ` | ä¼‘æ¯${exercise.rest}` : ''}
            </div>
          </div>
        </div>
      `;
    }).join('');
  } else if (todayPlan.isRestDay) {
    exercisesHTML = `
      <div style="
        text-align: center;
        padding: 40px 20px;
        background: rgba(0, 0, 0, 0.05);
        border-radius: 8px;
        color: #999;
        font-style: italic;
      ">
        <div style="font-size: 48px; margin-bottom: 15px;">ğŸ˜´</div>
        <div style="font-size: 18px;">ä¼‘æ¯æ—¥ï¼Œå¥½å¥½æ¢å¤ä½“åŠ›</div>
      </div>
    `;
  } else {
    exercisesHTML = `
      <div style="
        text-align: center;
        padding: 40px 20px;
        background: rgba(0, 0, 0, 0.05);
        border-radius: 8px;
        color: #999;
      ">
        <div style="font-size: 48px; margin-bottom: 15px;">ğŸ“</div>
        <div style="font-size: 16px;">æš‚æœªå®‰æ’å…·ä½“åŠ¨ä½œ</div>
      </div>
    `;
  }
  
  container.innerHTML = `
    <div style="text-align: center; margin-bottom: 25px; border-bottom: 3px solid #4CAF50; padding-bottom: 15px;">
      <h1 style="color: #4CAF50; margin: 0; font-size: 24px;">ä»Šæ—¥è®­ç»ƒè®¡åˆ’</h1>
      <p style="color: #666; margin: 8px 0 0 0; font-size: 13px;">å¯¼å‡ºæ—¥æœŸ: ${new Date().toLocaleDateString('zh-CN')}</p>
    </div>
    
    <div style="margin-bottom: 25px;">
      <div style="background: rgba(76, 175, 80, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #4CAF50;">
        <h2 style="color: #4CAF50; font-size: 18px; margin: 0 0 8px 0;">${todayPlan.dayName}</h2>
        <div style="color: #333; font-size: 14px; margin-bottom: 4px;">
          <strong>è®¡åˆ’:</strong> ${todayPlan.planName}
        </div>
        <div style="color: #333; font-size: 14px; margin-bottom: 4px;">
          <strong>æ¨¡å¼:</strong> ${todayPlan.planMode}
        </div>
        <div style="color: #333; font-size: 14px;">
          <strong>è®­ç»ƒéƒ¨ä½:</strong> ${todayPlan.bodyParts}
        </div>
      </div>
    </div>
    
    <div>
      <h2 style="color: #333; font-size: 18px; margin-bottom: 15px;">ğŸ‹ï¸ è®­ç»ƒåŠ¨ä½œ</h2>
      ${exercisesHTML}
    </div>
    
    <div style="margin-top: 30px; text-align: center; color: #999; font-size: 11px; border-top: 1px solid #eee; padding-top: 15px;">
      <p>ç”± FitMatrix å¥èº«çŸ©é˜µç”Ÿæˆ | ${new Date().toLocaleString('zh-CN')}</p>
      <p style="margin-top: 6px; color: #4CAF50; font-weight: bold;">ğŸŒ shenyiqing.xin</p>
    </div>
  `;
  
  return container;
}

// å¯¼å‡ºå®Œæ•´å‘¨è®­ç»ƒè®¡åˆ’
async function exportFullWeekPlan() {
  try {
    showNotification('æ­£åœ¨ç”Ÿæˆå®Œæ•´å‘¨è®­ç»ƒå›¾ç‰‡...', 'info');
    
    // è·å–å®Œæ•´çš„è®­ç»ƒè®¡åˆ’æ•°æ®
    const fullWeekData = await getActivePlanData();
    if (!fullWeekData) {
      showNotification('æ²¡æœ‰è®­ç»ƒè®¡åˆ’å¯å¯¼å‡º', 'warning');
      return;
    }
    
    // åˆ›å»ºå®Œæ•´å‘¨è®¡åˆ’çš„å¯¼å‡ºå®¹å™¨ï¼Œä½¿ç”¨å’Œç½‘é¡µä¸€è‡´çš„æ ·å¼
    const exportContainer = createFullWeekExportContainer(fullWeekData);
    document.body.appendChild(exportContainer);
    
    // ä½¿ç”¨html2canvasç”Ÿæˆå›¾ç‰‡
    try {
      if (!window.html2canvas) {
        await loadHtml2Canvas();
      }
      
      const canvas = await html2canvas(exportContainer, {
        backgroundColor: '#ffffff',
        scale: 2,
        scrollX: 0,
        scrollY: 0,
        useCORS: true,
        allowTaint: true,
        height: exportContainer.scrollHeight,
        width: exportContainer.scrollWidth
      });
      
      // æ¸…ç†ä¸´æ—¶å®¹å™¨
      document.body.removeChild(exportContainer);
      
      // ä¸‹è½½å›¾ç‰‡
      const dateStr = new Date().toISOString().split('T')[0];
      const link = document.createElement('a');
      link.download = `å®Œæ•´å‘¨è®­ç»ƒè®¡åˆ’_${fullWeekData.name}_${dateStr}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
      
      showNotification('å®Œæ•´å‘¨è®­ç»ƒè®¡åˆ’å¯¼å‡ºæˆåŠŸï¼', 'success');
      
    } catch (error) {
      document.body.removeChild(exportContainer);
      throw error;
    }
    
  } catch (error) {
    console.error('å¯¼å‡ºå®Œæ•´å‘¨è®¡åˆ’å¤±è´¥:', error);
    showNotification('å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
  }
}

// åˆ›å»ºå®Œæ•´å‘¨è®¡åˆ’å¯¼å‡ºå®¹å™¨ï¼Œæ ·å¼ä¸ç½‘é¡µä¿æŒä¸€è‡´
function createFullWeekExportContainer(planData) {
  const container = document.createElement('div');
  container.style.cssText = `
    position: absolute;
    top: -10000px;
    left: -10000px;
    width: 800px;
    background: white;
    padding: 40px;
    font-family: 'Microsoft YaHei', Arial, sans-serif;
    color: #333;
    box-sizing: border-box;
  `;
  
  const today = new Date();
  const currentDayOfWeek = today.getDay();
  const weekdays = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];
  const currentWeekday = weekdays[currentDayOfWeek === 0 ? 6 : currentDayOfWeek - 1];
  
  // ç”Ÿæˆå‘¨è®¡åˆ’HTMLï¼Œæ ·å¼ä¸ç½‘é¡µä¿æŒä¸€è‡´
  let weekPlanHTML = '';
  if (planData.weeklyPlan && planData.weeklyPlan.length > 0) {
    weekPlanHTML = planData.weeklyPlan.map((day, index) => {
      const isToday = day.day === currentWeekday;
      
      // æ ¼å¼åŒ–è¯¦ç»†åŠ¨ä½œä¿¡æ¯
      const exerciseLines = day.exercises.split('\n');
      const hasDetailedExercises = exerciseLines.length > 1 && exerciseLines[0] !== 'å¾…æ·»åŠ ' && exerciseLines[0] !== 'ä¼‘æ¯æ—¥ï¼Œå¥½å¥½æ¢å¤ä½“åŠ›';
      
      let exercisesDetailHTML = '';
      if (hasDetailedExercises) {
        exercisesDetailHTML = exerciseLines.map((line, idx) => 
          `<div style="color: #666; font-size: 12px; margin: 3px 0; padding-left: 15px;">â€¢ ${line}</div>`
        ).join('');
      } else {
        exercisesDetailHTML = `<div style="color: #999; font-size: 13px; text-align: center; font-style: italic; padding: 10px;">${day.exercises}</div>`;
      }
      
      return `
        <div style="
          margin-bottom: 20px;
          padding: 20px;
          background: ${isToday ? 'rgba(76, 175, 80, 0.1)' : 'rgba(248, 249, 250, 1)'};
          border-radius: 8px;
          border-left: 4px solid ${isToday ? '#4CAF50' : '#ddd'};
          border: ${isToday ? '1px solid rgba(76, 175, 80, 0.3)' : '1px solid #eee'};
        ">
          <div style="display: flex; align-items: center; margin-bottom: 15px;">
            <div style="font-weight: bold; color: ${isToday ? '#4CAF50' : '#333'}; font-size: 18px; margin-right: 15px;">
              ${day.day}${isToday ? ' ğŸŒŸ' : ''}
            </div>
            <div style="color: #666; font-size: 14px; background: white; padding: 6px 12px; border-radius: 4px; border: 1px solid #eee;">
              ${day.bodyParts}
            </div>
            ${day.exerciseCount > 0 ? `<div style="margin-left: 15px; color: #888; font-size: 12px; background: rgba(76, 175, 80, 0.1); padding: 3px 8px; border-radius: 12px;">${day.exerciseCount}ä¸ªåŠ¨ä½œ</div>` : ''}
          </div>
          <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #eee;">
            <div style="font-weight: bold; color: #333; font-size: 14px; margin-bottom: 10px;">ğŸ‹ï¸ è®­ç»ƒè¯¦æƒ…</div>
            ${exercisesDetailHTML}
          </div>
        </div>
      `;
    }).join('');
  } else {
    weekPlanHTML = '<div style="text-align: center; color: #999; padding: 40px;">æš‚æ— è®­ç»ƒå®‰æ’</div>';
  }
  
  container.innerHTML = `
    <div style="text-align: center; margin-bottom: 30px; border-bottom: 3px solid #4CAF50; padding-bottom: 20px;">
      <h1 style="color: #4CAF50; margin: 0; font-size: 28px;">${planData.name}</h1>
      <p style="color: #666; margin: 10px 0 0 0; font-size: 14px;">
        ${planData.mode} â€¢ ${planData.cycle_weeks}å‘¨å‘¨æœŸ | å¯¼å‡ºæ—¥æœŸ: ${new Date().toLocaleDateString('zh-CN')}
      </p>
    </div>
    
    <div style="margin-bottom: 30px;">
      <h2 style="color: #333; font-size: 22px; margin-bottom: 20px; display: flex; align-items: center;">
        <i class="fas fa-calendar-week" style="margin-right: 10px; color: #4CAF50;"></i>
        å®Œæ•´å‘¨è®­ç»ƒå®‰æ’
      </h2>
      ${weekPlanHTML}
    </div>
    
    <div style="margin-top: 40px; text-align: center; color: #999; font-size: 12px; border-top: 1px solid #eee; padding-top: 20px;">
      <p>ç”± FitMatrix å¥èº«çŸ©é˜µç”Ÿæˆ | ${new Date().toLocaleString('zh-CN')}</p>
      <p style="margin-top: 8px; color: #4CAF50; font-weight: bold;">ğŸŒ shenyiqing.xin</p>
    </div>
  `;
  
  return container;
}

// æ ‡è®°åŠ¨ä½œå®Œæˆ
function markExerciseDone(exerciseIndex, dayIndex) {
  const exerciseElement = document.querySelector(`[data-exercise-index="${exerciseIndex}"][data-day-index="${dayIndex}"]`);
  if (!exerciseElement) return;
  
  const button = exerciseElement.querySelector('.complete-btn');
  const exerciseItem = exerciseElement.closest('.exercise-item');
  
  if (button && exerciseItem) {
    // åˆ‡æ¢å®ŒæˆçŠ¶æ€
    const isCompleted = button.classList.contains('completed');
    const exerciseName = exerciseItem.querySelector('.exercise-name').textContent;
    
    if (isCompleted) {
      // å–æ¶ˆå®ŒæˆçŠ¶æ€
      button.classList.remove('completed');
      button.innerHTML = '<i class="fas fa-check"></i> å®Œæˆ';
      button.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45A049 100%)';
      exerciseItem.classList.remove('completed');
      exerciseItem.style.opacity = '1';
      exerciseItem.style.background = 'linear-gradient(135deg, rgba(76, 175, 80, 0.05) 0%, rgba(76, 175, 80, 0.02) 100%)';
      
      // ä»æœ¬åœ°å­˜å‚¨ä¸­ç§»é™¤å®ŒæˆçŠ¶æ€
      removeExerciseCompletion(exerciseName, dayIndex);
    } else {
      // æ ‡è®°ä¸ºå®Œæˆ
      button.classList.add('completed');
      button.innerHTML = '<i class="fas fa-check-circle"></i> å·²å®Œæˆ';
      button.style.background = 'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)';
      exerciseItem.classList.add('completed');
      exerciseItem.style.opacity = '0.7';
      exerciseItem.style.background = 'linear-gradient(135deg, rgba(76, 175, 80, 0.15) 0%, rgba(76, 175, 80, 0.08) 100%)';
      
      // ä¿å­˜å®ŒæˆçŠ¶æ€åˆ°æœ¬åœ°å­˜å‚¨
      saveExerciseCompletion(exerciseName, dayIndex);
      
      // æ˜¾ç¤ºå®Œæˆæç¤º
      showNotification(`åŠ¨ä½œ"${exerciseName}"å·²å®Œæˆï¼`, 'success');
    }
    
    // æ›´æ–°è®­ç»ƒè¿›åº¦
    updateTrainingProgress();
  }
}

// ä¿å­˜åŠ¨ä½œå®ŒæˆçŠ¶æ€åˆ°æœ¬åœ°å­˜å‚¨
function saveExerciseCompletion(exerciseName, dayIndex) {
  const today = new Date().toISOString().split('T')[0]; // æ ¼å¼: YYYY-MM-DD
  const storageKey = `exercise_completion_${today}`;
  
  let completions = JSON.parse(localStorage.getItem(storageKey) || '{}');
  
  if (!completions[dayIndex]) {
    completions[dayIndex] = [];
  }
  
  if (!completions[dayIndex].includes(exerciseName)) {
    completions[dayIndex].push(exerciseName);
  }
  
  localStorage.setItem(storageKey, JSON.stringify(completions));
}

// ä»æœ¬åœ°å­˜å‚¨ä¸­ç§»é™¤åŠ¨ä½œå®ŒæˆçŠ¶æ€
function removeExerciseCompletion(exerciseName, dayIndex) {
  const today = new Date().toISOString().split('T')[0];
  const storageKey = `exercise_completion_${today}`;
  
  let completions = JSON.parse(localStorage.getItem(storageKey) || '{}');
  
  if (completions[dayIndex]) {
    const index = completions[dayIndex].indexOf(exerciseName);
    if (index > -1) {
      completions[dayIndex].splice(index, 1);
    }
  }
  
  localStorage.setItem(storageKey, JSON.stringify(completions));
}

// æ£€æŸ¥åŠ¨ä½œæ˜¯å¦å·²å®Œæˆ
function isExerciseCompleted(exerciseName, dayIndex) {
  const today = new Date().toISOString().split('T')[0];
  const storageKey = `exercise_completion_${today}`;
  
  const completions = JSON.parse(localStorage.getItem(storageKey) || '{}');
  
  return completions[dayIndex] && completions[dayIndex].includes(exerciseName);
}

// æ¢å¤åŠ¨ä½œå®ŒæˆçŠ¶æ€
function restoreExerciseCompletions() {
  const exerciseItems = document.querySelectorAll('.exercise-item');
  
  exerciseItems.forEach(item => {
    const exerciseName = item.querySelector('.exercise-name')?.textContent;
    const dayIndex = parseInt(item.getAttribute('data-day-index') || '0');
    const button = item.querySelector('.complete-btn');
    
    if (exerciseName && button && isExerciseCompleted(exerciseName, dayIndex)) {
      // æ¢å¤å®ŒæˆçŠ¶æ€
      button.classList.add('completed');
      button.innerHTML = '<i class="fas fa-check-circle"></i> å·²å®Œæˆ';
      button.style.background = 'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)';
      item.classList.add('completed');
      item.style.opacity = '0.7';
      item.style.background = 'linear-gradient(135deg, rgba(76, 175, 80, 0.15) 0%, rgba(76, 175, 80, 0.08) 100%)';
    }
  });
  
  // æ›´æ–°è®­ç»ƒè¿›åº¦
  updateTrainingProgress();
}

// æ›´æ–°è®­ç»ƒè¿›åº¦
function updateTrainingProgress() {
  const allExercises = document.querySelectorAll('.exercise-item');
  const completedExercises = document.querySelectorAll('.exercise-item.completed');
  
  if (allExercises.length > 0) {
    const progress = Math.round((completedExercises.length / allExercises.length) * 100);
    
    // æ›´æ–°é¡µé¢ä¸Šçš„è¿›åº¦æ˜¾ç¤º
    const progressElement = document.querySelector('.training-progress');
    if (progressElement) {
      progressElement.textContent = `è®­ç»ƒè¿›åº¦: ${progress}% (${completedExercises.length}/${allExercises.length})`;
    }
    
    // å¦‚æœå…¨éƒ¨å®Œæˆï¼Œæ˜¾ç¤ºæ­å–œä¿¡æ¯
    if (progress === 100) {
      setTimeout(() => {
        showNotification('ğŸ‰ æ­å–œï¼ä»Šæ—¥è®­ç»ƒå…¨éƒ¨å®Œæˆï¼', 'success');
      }, 500);
    }
  }
}

// æ˜¾ç¤ºè®­ç»ƒæ—¥è¯¦æƒ…æ¨¡æ€æ¡†
function showDayDetailsModal(dayData, dayNumber) {
  const modal = document.createElement('div');
  modal.className = 'checkin-modal';
  
  // è®¡ç®—æ€»åŠ¨ä½œæ•°
  let totalExercises = 0;
  
  // ç”ŸæˆåŠ¨ä½œåˆ—è¡¨HTML
  let exercisesHTML = '';
  
  if (dayData.exercises && Array.isArray(dayData.exercises)) {
    // æ–°æ ¼å¼ï¼šexercisesæ•°ç»„
    totalExercises = dayData.exercises.length;
    
    if (totalExercises > 0) {
      exercisesHTML = dayData.exercises.map((exercise, index) => {
        const weight = exercise.weight ? `${exercise.weight}${(exercise.weight && (exercise.weight.toString().includes('kg') || /^(è‡ªé‡|ç©ºæ†)$/.test(exercise.weight.toString()) || exercise.weight.toString().includes('æ†'))) ? '' : 'kg'}` : 'è‡ªé‡';
        const reps = exercise.reps || '10-12';
        const sets = exercise.sets || 3;
        const rest = exercise.rest || '90ç§’';
        
        return `
          <div class="exercise-item" style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            border-left: 4px solid var(--rage-primary, #ff6b35);
          ">
            <div class="exercise-info">
              <div class="exercise-name" style="font-weight: 500; color: #e6e6e6; margin-bottom: 4px;">
                ${exercise.name}
              </div>
              <div class="exercise-params" style="font-size: 0.9rem; color: #a8a8a8;">
                ${sets}ç»„ Ã— ${reps}æ¬¡ Ã— ${weight} | ä¼‘æ¯: ${rest}
              </div>
            </div>
            <div class="exercise-actions">
              <button class="exercise-done-btn" onclick="markExerciseDone(${index})" style="
                background: var(--rage-primary, #ff6b35);
                color: white;
                border: none;
                padding: 6px 12px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 0.85rem;
              ">
                <i class="fas fa-check"></i> å®Œæˆ
              </button>
            </div>
          </div>
        `;
      }).join('');
    } else {
      exercisesHTML = `
        <div class="no-exercises" style="
          text-align: center;
          padding: 40px 20px;
          color: #a8a8a8;
        ">
          <i class="fas fa-dumbbell" style="font-size: 2rem; margin-bottom: 16px; opacity: 0.5;"></i>
          <p>ä»Šå¤©æ˜¯ä¼‘æ¯æ—¥</p>
          <p style="font-size: 0.9rem;">å¥½å¥½ä¼‘æ¯ï¼Œä¸ºä¸‹æ¬¡è®­ç»ƒåšå‡†å¤‡ï¼</p>
        </div>
      `;
    }
  } else if (dayData.modules) {
    // æ—§æ ¼å¼ï¼šmoduleså¯¹è±¡
    totalExercises = Object.values(dayData.modules).reduce((sum, module) => sum + (module?.length || 0), 0);
    
    if (dayData.modules && totalExercises > 0) {
      const moduleNames = { warmup: 'çƒ­èº«', main: 'ä¸»è®­', accessory: 'è¾…åŠ©', cooldown: 'æ‹‰ä¼¸' };
      
      Object.entries(dayData.modules).forEach(([moduleType, exercises]) => {
        if (exercises && Array.isArray(exercises) && exercises.length > 0) {
          exercisesHTML += `
            <div class="exercise-module">
              <h5>${moduleNames[moduleType] || moduleType}</h5>
              <div class="exercise-list">
                ${exercises.map(exercise => `
                  <div class="exercise-item-detail">
                    <div class="exercise-name">${exercise.name || 'æœªçŸ¥åŠ¨ä½œ'}</div>
                    <div class="exercise-params">
                      ${exercise.sets ? `${exercise.sets}ç»„` : ''}
                      ${exercise.reps ? ` Ã— ${exercise.reps}æ¬¡` : ''}
                      ${exercise.weight ? ` @ ${exercise.weight}${(exercise.weight && (exercise.weight.toString().includes('kg') || /^(è‡ªé‡|ç©ºæ†)$/.test(exercise.weight.toString()) || exercise.weight.toString().includes('æ†'))) ? '' : 'kg'}` : ''}
                      ${exercise.rest ? ` (ä¼‘æ¯${exercise.rest})` : ''}
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        }
      });
    } else {
      exercisesHTML = `
        <div class="no-exercises" style="
          text-align: center;
          padding: 40px 20px;
          color: #a8a8a8;
        ">
          <i class="fas fa-dumbbell" style="font-size: 2rem; margin-bottom: 16px; opacity: 0.5;"></i>
          <p>ä»Šå¤©æ˜¯ä¼‘æ¯æ—¥</p>
          <p style="font-size: 0.9rem;">å¥½å¥½ä¼‘æ¯ï¼Œä¸ºä¸‹æ¬¡è®­ç»ƒåšå‡†å¤‡ï¼</p>
        </div>
      `;
    }
  }
  
  if (!exercisesHTML) {
    if (dayData.body_parts.includes('ä¼‘æ¯')) {
      exercisesHTML = '<div class="rest-day-info"><i class="fas fa-bed"></i> ä»Šå¤©æ˜¯ä¼‘æ¯æ—¥ï¼Œè®©èº«ä½“æ¢å¤å§ï¼</div>';
    } else {
      exercisesHTML = '<div class="no-exercises-info">æš‚æœªå®‰æ’å…·ä½“åŠ¨ä½œï¼Œå¯ä»¥å‰å¾€è®¡åˆ’ç¼–è¾‘å™¨æ·»åŠ </div>';
    }
  }
  
  modal.innerHTML = `
    <div class="checkin-modal-content">
      <h3>${dayData.weekday || 'è®­ç»ƒæ—¥'} - ${dayData.body_parts ? dayData.body_parts.join(' + ') : (dayData.type || 'è®­ç»ƒ')}</h3>
      <div class="day-details-content">
        ${exercisesHTML}
      </div>
      <div class="form-actions" style="justify-content: center; margin-top: 20px;">
        <button class="btn-secondary" onclick="window.location.href='/tools/fitness/plan-editor/'">
          <i class="fas fa-edit"></i> ç¼–è¾‘è®¡åˆ’
        </button>
        <button class="btn-cancel">å…³é—­</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  modal.querySelector('.btn-cancel').addEventListener('click', () => modal.remove());
  modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
}

// æ˜¾ç¤ºæ— è®¡åˆ’æ¨¡æ€æ¡†
function showNoPlanModal() {
  const modal = document.createElement('div');
  modal.className = 'checkin-modal';
  modal.innerHTML = `
    <div class="checkin-modal-content">
      <h3>æš‚æ— è®­ç»ƒè®¡åˆ’</h3>
      <div style="text-align: center; padding: 20px;">
        <p>æ‚¨è¿˜æ²¡æœ‰æ¿€æ´»çš„è®­ç»ƒè®¡åˆ’</p>
        <p>é€‰æ‹©ä¸€ä¸ªæ¨¡æ¿å¼€å§‹æ‚¨çš„å¥èº«ä¹‹æ—…å§ï¼</p>
      </div>
      <div class="form-actions" style="justify-content: center; margin-top: 20px;">
        <button class="btn-primary" onclick="this.closest('.checkin-modal').remove(); openPlanTemplates();">
          <i class="fas fa-star"></i> é€‰æ‹©æ¨¡æ¿
        </button>
        <button class="btn-secondary" onclick="this.closest('.checkin-modal').remove(); openPlanLibrary();">
          <i class="fas fa-book"></i> è®¡åˆ’åº“
        </button>
        <button class="btn-cancel">å…³é—­</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  modal.querySelector('.btn-cancel').addEventListener('click', () => modal.remove());
  modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
  initShortcutsHelp();
  try { initCurrentPlan(); } catch (e) { console.warn('åˆå§‹åŒ–å½“å‰è®¡åˆ’å¤±è´¥', e); }
});



// è®­ç»ƒè®¡åˆ’äº¤äº’
document.querySelectorAll('.plan-day').forEach(day => {
  day.addEventListener('click', function() {
    document.querySelectorAll('.plan-day').forEach(d => d.classList.remove('active'));
    this.classList.add('active');
  });
});

// è®¡æ—¶å™¨åŠŸèƒ½
let timerInterval;
let timeLeft = 0;
let isRunning = false;

// è®¾ç½®è®¡æ—¶å™¨æŒ‰é’®äº‹ä»¶
const setTimerBtn = document.getElementById('setTimer');
if (setTimerBtn) {
  setTimerBtn.addEventListener('click', function() {
    const timerSecondsEl = document.getElementById('timerSeconds');
    if (!timerSecondsEl) return;
    
    const seconds = parseInt(timerSecondsEl.value);
    if (seconds && seconds > 0 && seconds <= 7200) {
      timeLeft = seconds;
      updateTimerDisplay();
      const startTimerEl = document.getElementById('startTimer');
      if (startTimerEl) {
        startTimerEl.textContent = 'å¼€å§‹';
      }
      if (isRunning) {
        isRunning = false;
        clearInterval(timerInterval);
      }
    } else {
      alert('è¯·è¾“å…¥1-7200ä¹‹é—´çš„ç§’æ•°');
    }
  });
}

const startTimerBtn = document.getElementById('startTimer');
if (startTimerBtn) {
  startTimerBtn.addEventListener('click', function() {
    if (!isRunning && timeLeft > 0) {
      isRunning = true;
      timerInterval = setInterval(updateTimer, 1000);
      this.textContent = 'æš‚åœ';
    } else if (isRunning) {
      isRunning = false;
      clearInterval(timerInterval);
      this.textContent = 'ç»§ç»­';
    }
  });
}

const pauseTimerBtn = document.getElementById('pauseTimer');
if (pauseTimerBtn) {
  pauseTimerBtn.addEventListener('click', function() {
    if (isRunning) {
      isRunning = false;
      clearInterval(timerInterval);
      const startTimerEl = document.getElementById('startTimer');
      if (startTimerEl) {
        startTimerEl.textContent = 'ç»§ç»­';
      }
    }
  });
}

const resetTimerBtn = document.getElementById('resetTimer');
if (resetTimerBtn) {
  resetTimerBtn.addEventListener('click', function() {
    isRunning = false;
    clearInterval(timerInterval);
    timeLeft = 0;
    updateTimerDisplay();
    const startTimerEl = document.getElementById('startTimer');
    if (startTimerEl) {
      startTimerEl.textContent = 'å¼€å§‹';
    }
  });
}

document.querySelectorAll('.preset-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    timeLeft = parseInt(this.getAttribute('data-time'));
    updateTimerDisplay();
  });
});

function updateTimer() {
  if (timeLeft > 0) {
    timeLeft--;
    updateTimerDisplay();
  } else {
    isRunning = false;
    clearInterval(timerInterval);
    alert('è®­ç»ƒå®Œæˆï¼');
  }
}

function updateTimerDisplay() {
  const minutes = Math.floor(timeLeft / 60);
  const seconds = timeLeft % 60;
  // å°†ç§’æ•°æ ¼å¼åŒ–ä¸ºå°æ•°ç‚¹åä¸¤ä½
  const formattedSeconds = seconds.toFixed(2);
  document.getElementById('timerDisplay').textContent = 
    `${minutes.toString().padStart(2, '0')}:${formattedSeconds}`;
}

// æ˜¾ç¤ºè®¡åˆ’è¯¦æƒ…ï¼ˆç®€å•æ¨¡æ€ï¼‰
function showPlanDetails(dayIndex) {
  const modal = document.createElement('div');
  modal.className = 'checkin-modal';
  modal.innerHTML = `
    <div class="checkin-modal-content">
      <h3>è®¡åˆ’è¯¦æƒ… - ç¬¬${dayIndex}å¤©</h3>
      <div>è¯¥åŠŸèƒ½å°†å±•ç¤ºè¯¥å¤©çš„è¯¦ç»†åŠ¨ä½œæ¸…å•ï¼ˆå¾…ä¸è®¡åˆ’åº“è”åŠ¨ï¼‰</div>
      <div class="form-actions" style="justify-content:center; margin-top: 20px;">
        <button class="btn-cancel">å…³é—­</button>
      </div>
    </div>`;
  document.body.appendChild(modal);
  modal.querySelector('.btn-cancel').addEventListener('click', () => modal.remove());
  modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
}

// è¥å…»è®¡ç®—å™¨åŠŸèƒ½
document.getElementById('calculateBMR').addEventListener('click', function() {
  const weight = parseFloat(document.getElementById('weight').value);
  const height = parseFloat(document.getElementById('height').value);
  const age = parseFloat(document.getElementById('age').value);
  const activity = parseFloat(document.getElementById('activity').value);
  
  if (weight && height && age) {
    // ä½¿ç”¨Mifflin-St Jeorå…¬å¼è®¡ç®—BMR
    const bmr = (10 * weight) + (6.25 * height) - (5 * age) + 5;
    const tdee = bmr * activity;
    
    const resultText = `åŸºç¡€ä»£è°¢ç‡: ${Math.round(bmr)} åƒå¡/å¤©\næ¯æ—¥æ€»æ¶ˆè€—: ${Math.round(tdee)} åƒå¡/å¤©`;
    
    document.getElementById('bmrResult').textContent = resultText;
    document.getElementById('bmrResult').style.display = 'block';
  }
});

// è§†é¢‘ç‚¹å‡»äº‹ä»¶


// æ‰“å¡æ—¥å†åŠŸèƒ½
class CheckInCalendar {
  constructor() {
    this.currentDate = new Date();
    this.currentYear = this.currentDate.getFullYear();
    this.currentMonth = this.currentDate.getMonth();
    this.calendarData = {};
    this.streak = { current: 0, longest: 0 };
    this.monthlyStats = {};
    
    this.init();
  }
  
  async init() {
    await this.loadCalendarData();
    this.renderCalendar();
    this.bindEvents();
    this.updateStats();
    await this.loadPlanLibrary();
  }
  
  async loadCalendarData() {
    try {
      const response = await fetch(`/tools/api/checkin/calendar/?type=fitness&year=${this.currentYear}&month=${this.currentMonth + 1}`);
      const data = await response.json();
      
      if (data.success) {
        this.calendarData = data.calendar_data || {};
        this.streak = data.streak || { current: 0, longest: 0 };
        this.monthlyStats = data.monthly_stats || {};
      }
    } catch (error) {
      console.error('åŠ è½½æ—¥å†æ•°æ®å¤±è´¥:', error);
      // è®¾ç½®é»˜è®¤å€¼
      this.calendarData = {};
      this.streak = { current: 0, longest: 0 };
      this.monthlyStats = {};
    }
  }
  
  renderCalendar() {
    const firstDay = new Date(this.currentYear, this.currentMonth, 1);
    const lastDay = new Date(this.currentYear, this.currentMonth + 1, 0);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay());
    
    const calendarBody = document.getElementById('calendarBody');
    if (!calendarBody) return;
    
    calendarBody.innerHTML = '';
    
    // æ›´æ–°æœˆä»½æ˜¾ç¤º
    const currentMonthEl = document.getElementById('currentMonth');
    if (currentMonthEl) {
      currentMonthEl.textContent = `${this.currentYear}å¹´${this.currentMonth + 1}æœˆ`;
    }
    
    // æ›´æ–°è¿ç»­æ‰“å¡ä¿¡æ¯
    const currentStreakEl = document.getElementById('currentStreak');
    const longestStreakEl = document.getElementById('longestStreak');
    
    if (currentStreakEl) {
      currentStreakEl.textContent = this.streak.current || 0;
    }
    if (longestStreakEl) {
      longestStreakEl.textContent = this.streak.longest || 0;
    }
    
    // ç”Ÿæˆæ—¥å†ç½‘æ ¼
    for (let i = 0; i < 42; i++) {
      const date = new Date(startDate);
      date.setDate(startDate.getDate() + i);
      
      const dayElement = document.createElement('div');
      dayElement.className = 'calendar-day';
      
      // ä½¿ç”¨æœ¬åœ°æ—¶åŒºç”Ÿæˆæ—¥æœŸå­—ç¬¦ä¸²ï¼Œé¿å…æ—¶åŒºé—®é¢˜
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const dateStr = `${year}-${month}-${day}`;
      
      const isCurrentMonth = date.getMonth() === this.currentMonth;
      const isToday = date.toDateString() === new Date().toDateString();
      const checkinData = this.calendarData[dateStr];
      
      if (!isCurrentMonth) {
        dayElement.classList.add('other-month');
      }
      
      if (isToday) {
        dayElement.classList.add('today');
      }
      
      if (checkinData) {
        dayElement.classList.add('has-checkin');
        if (checkinData.status === 'completed') {
          dayElement.classList.add('completed');
        } else if (checkinData.status === 'rest') {
          dayElement.classList.add('rest');
        }
      }
      
      dayElement.textContent = date.getDate();
      dayElement.setAttribute('data-date', dateStr);
      
      dayElement.addEventListener('click', () => this.handleDayClick(dateStr, checkinData));
      
      calendarBody.appendChild(dayElement);
    }
  }
  
  async handleDayClick(dateStr, checkinData) {
    const clickedDate = new Date(dateStr);
    const today = new Date();
    
    // è®¾ç½®æ—¶é—´ä¸º0ç‚¹ï¼Œä¾¿äºæ¯”è¾ƒ
    clickedDate.setHours(0, 0, 0, 0);
    today.setHours(0, 0, 0, 0);
    
    // æ£€æŸ¥æ˜¯å¦ä¸ºæœªæ¥æ—¥æœŸ
    if (clickedDate > today) {
      this.showNotification('ä¸èƒ½ä¸ºæœªæ¥æ—¥æœŸæ‰“å¡', 'error');
      return;
    }
    
    if (checkinData) {
      // æ˜¾ç¤ºæ‰“å¡è¯¦æƒ…
      this.showCheckinDetail(dateStr, checkinData);
    } else {
      // æ£€æŸ¥æ˜¯å¦ä¸ºè¿‡å»çš„æ—¥æœŸ
      if (clickedDate < today) {
        // æ˜¾ç¤ºäºŒæ¬¡ç¡®è®¤å¯¹è¯æ¡†
        this.showPastDateConfirmation(dateStr);
      } else {
        // ä»Šå¤©çš„æ—¥æœŸï¼Œç›´æ¥æ˜¾ç¤ºæ‰“å¡è¡¨å•
        this.showCheckinForm(dateStr);
      }
    }
  }

  showPastDateConfirmation(dateStr) {
    const confirmation = `
      <div class="checkin-modal">
        <div class="checkin-modal-content">
          <h3>ç¡®è®¤è¡¥æ‰“å¡</h3>
          <div class="confirmation-message">
            <i class="fas fa-exclamation-triangle" style="color: #ff6b35; font-size: 2rem; margin-bottom: 15px;"></i>
            <p>æ‚¨æ­£åœ¨ä¸º <strong>${dateStr}</strong> è¡¥æ‰“å¡ï¼Œè¿™æ˜¯ä¸€ä¸ªè¿‡å»çš„æ—¥æœŸã€‚</p>
            <p>è¯·ç¡®è®¤æ‚¨ç¡®å®åœ¨è¿™ä¸€å¤©è¿›è¡Œäº†å¥èº«æ´»åŠ¨ã€‚</p>
          </div>
          <div class="form-actions">
            <button class="btn-cancel">å–æ¶ˆ</button>
            <button class="btn-confirm">ç¡®è®¤è¡¥æ‰“å¡</button>
          </div>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', confirmation);
    
    const modal = document.querySelector('.checkin-modal');
    
    modal.querySelector('.btn-cancel').addEventListener('click', () => {
      modal.remove();
    });
    
    modal.querySelector('.btn-confirm').addEventListener('click', () => {
      modal.remove();
      this.showCheckinForm(dateStr);
    });
    
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.remove();
      }
    });
  }

  showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
      <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
      <span>${message}</span>
    `;
    
    Object.assign(notification.style, {
      position: 'fixed',
      top: '20px',
      right: '20px',
      padding: '12px 20px',
      borderRadius: '6px',
      color: 'white',
      fontSize: '14px',
      fontWeight: '500',
      zIndex: '10000',
      display: 'flex',
      alignItems: 'center',
      gap: '8px',
      minWidth: '250px',
      boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
      backgroundColor: type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3',
      animation: 'slideInRight 0.3s ease-out'
    });
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.style.animation = 'slideOutRight 0.3s ease-in';
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 300);
    }, 3000);
  }
  
  showCheckinForm(dateStr) {
    const form = `
      <div class="checkin-modal">
        <div class="checkin-modal-content">
          <h3>æ·»åŠ å¥èº«æ‰“å¡ - ${dateStr}</h3>
          <form id="checkinForm">
            <div class="form-group">
              <label>è¿åŠ¨ç±»å‹</label>
              <select name="workout_type" required>
                <option value="strength">åŠ›é‡è®­ç»ƒ</option>
                <option value="cardio">æœ‰æ°§è®­ç»ƒ</option>
                <option value="yoga">ç‘œä¼½</option>
                <option value="hiit">é«˜å¼ºåº¦é—´æ­‡</option>
                <option value="flexibility">æŸ”éŸ§æ€§è®­ç»ƒ</option>
                <option value="other">å…¶ä»–</option>
              </select>
            </div>
            <div class="form-group">
              <label>ğŸ’ª è®­ç»ƒéƒ¨ä½</label>
              <div class="training-parts-container">
                <label class="checkbox-label">
                  <input type="checkbox" name="training_parts" value="èƒ¸"> èƒ¸
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" name="training_parts" value="èƒŒ"> èƒŒ
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" name="training_parts" value="è…¿"> è…¿
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" name="training_parts" value="è‚©"> è‚©
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" name="training_parts" value="æ‰‹è‡‚"> æ‰‹è‡‚
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" name="training_parts" value="æ ¸å¿ƒ"> æ ¸å¿ƒ
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" name="training_parts" value="å…¨èº«"> å…¨èº«
                </label>
              </div>
            </div>
            <div class="form-group">
              <label>æŒç»­æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰</label>
              <input type="number" name="duration" min="1" max="300" required>
            </div>
            <div class="form-group">
              <label>å¼ºåº¦</label>
              <select name="intensity" required>
                <option value="low">ä½</option>
                <option value="medium">ä¸­</option>
                <option value="high">é«˜</option>
              </select>
            </div>
            <div class="form-group">
              <label>ğŸ”¥ æ„Ÿå—è¯„åˆ†</label>
              <div class="rating-container">
                <div class="star-rating">
                  <input type="radio" name="feeling_rating" value="1" id="star1">
                  <label for="star1">â­</label>
                  <input type="radio" name="feeling_rating" value="2" id="star2">
                  <label for="star2">â­</label>
                  <input type="radio" name="feeling_rating" value="3" id="star3">
                  <label for="star3">â­</label>
                  <input type="radio" name="feeling_rating" value="4" id="star4">
                  <label for="star4">â­</label>
                  <input type="radio" name="feeling_rating" value="5" id="star5">
                  <label for="star5">â­</label>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label>å¤‡æ³¨</label>
              <textarea name="notes" rows="3"></textarea>
            </div>
            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" name="is_shared_to_community" value="true">
                ğŸ“¢ ä¸€é”®åˆ†äº«åˆ°ç¤¾åŒº
              </label>
            </div>
            <div class="form-actions">
              <button type="button" class="btn-cancel">å–æ¶ˆ</button>
              <button type="submit" class="btn-submit">ä¿å­˜</button>
            </div>
          </form>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', form);
    
    const modal = document.querySelector('.checkin-modal');
    const formElement = document.getElementById('checkinForm');
    
    formElement.addEventListener('submit', (e) => {
      e.preventDefault();
      this.submitCheckin(dateStr, formElement);
    });
    
    modal.querySelector('.btn-cancel').addEventListener('click', () => {
      modal.remove();
    });
    
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.remove();
      }
    });
  }
  
  showCheckinDetail(dateStr, checkinData) {
    const detail = `
      <div class="checkin-modal">
        <div class="checkin-modal-content">
          <h3>æ‰“å¡è¯¦æƒ… - ${dateStr}</h3>
          <div class="checkin-detail">
            <p><strong>çŠ¶æ€:</strong> ${checkinData.status === 'completed' ? 'å·²å®Œæˆ' : 'ä¼‘æ¯æ—¥'}</p>
            ${checkinData.detail ? `
              <p><strong>è¿åŠ¨ç±»å‹:</strong> ${this.getWorkoutTypeName(checkinData.detail.workout_type)}</p>
              <p><strong>æŒç»­æ—¶é—´:</strong> ${checkinData.detail.duration} åˆ†é’Ÿ</p>
              <p><strong>å¼ºåº¦:</strong> ${this.getIntensityName(checkinData.detail.intensity)}</p>
              <p><strong>å¤‡æ³¨:</strong> ${checkinData.detail.notes || 'æ— '}</p>
            ` : ''}
          </div>
          <div class="form-actions">
            <button class="btn-edit">ç¼–è¾‘</button>
            <button class="btn-delete">åˆ é™¤</button>
            <button class="btn-cancel">å…³é—­</button>
          </div>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', detail);
    
    const modal = document.querySelector('.checkin-modal');
    
    modal.querySelector('.btn-cancel').addEventListener('click', () => {
      modal.remove();
    });
    
    modal.querySelector('.btn-delete').addEventListener('click', () => {
      if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ‰“å¡è®°å½•å—ï¼Ÿ')) {
        this.deleteCheckin(dateStr);
        modal.remove();
      }
    });
    
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.remove();
      }
    });
  }
  
  async submitCheckin(dateStr, form) {
    const formData = new FormData(form);
    
    // è·å–è®­ç»ƒéƒ¨ä½ï¼ˆå¤šé€‰ï¼‰
    const trainingParts = [];
    form.querySelectorAll('input[name="training_parts"]:checked').forEach(checkbox => {
      trainingParts.push(checkbox.value);
    });
    
    // è·å–æ„Ÿå—è¯„åˆ†
    const feelingRating = form.querySelector('input[name="feeling_rating"]:checked');
    const rating = feelingRating ? parseInt(feelingRating.value) : null;
    
    // è·å–æ˜¯å¦åˆ†äº«åˆ°ç¤¾åŒº
    const isSharedToCommunity = form.querySelector('input[name="is_shared_to_community"]').checked;
    
    const data = {
      type: 'fitness',
      date: dateStr,
      status: 'completed',
      detail: {
        workout_type: formData.get('workout_type'),
        duration: parseInt(formData.get('duration')),
        intensity: formData.get('intensity'),
        training_parts: trainingParts,
        feeling_rating: rating,
        is_shared_to_community: isSharedToCommunity,
        notes: formData.get('notes')
      }
    };
    
    try {
      const response = await fetch('/tools/api/checkin/add/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(data)
      });
      
      const result = await response.json();
      
      if (result.success) {
        // å¦‚æœé€‰æ‹©åˆ†äº«åˆ°ç¤¾åŒºï¼Œåˆ›å»ºç¤¾åŒºå¸–å­
        if (isSharedToCommunity) {
          await this.createCommunityPost(dateStr, data.detail);
        }
        
        await this.loadCalendarData();
        this.renderCalendar();
        this.updateStats();
        document.querySelector('.checkin-modal').remove();
        alert('æ‰“å¡æˆåŠŸï¼');
      } else {
        alert('æ‰“å¡å¤±è´¥: ' + result.error);
      }
    } catch (error) {
      console.error('æäº¤æ‰“å¡å¤±è´¥:', error);
      alert('æ‰“å¡å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  }
  
  async createCommunityPost(dateStr, detailData) {
    try {
      const workoutTypeNames = {
        'strength': 'åŠ›é‡è®­ç»ƒ',
        'cardio': 'æœ‰æ°§è®­ç»ƒ',
        'yoga': 'ç‘œä¼½',
        'hiit': 'é«˜å¼ºåº¦é—´æ­‡',
        'flexibility': 'æŸ”éŸ§æ€§è®­ç»ƒ',
        'other': 'å…¶ä»–'
      };
      
      const intensityNames = {
        'low': 'ä½å¼ºåº¦',
        'medium': 'ä¸­ç­‰å¼ºåº¦',
        'high': 'é«˜å¼ºåº¦'
      };
      
      const title = `ä»Šæ—¥å¥èº«æ‰“å¡ - ${workoutTypeNames[detailData.workout_type]}`;
      const content = `ğŸ’ª è®­ç»ƒéƒ¨ä½ï¼š${detailData.training_parts.join('ã€') || 'å…¨èº«'}
ğŸ”¥ æ„Ÿå—ï¼š${'â­'.repeat(detailData.feeling_rating || 0)}
â±ï¸ æ—¶é•¿ï¼š${detailData.duration}åˆ†é’Ÿ
ğŸ’ª å¼ºåº¦ï¼š${intensityNames[detailData.intensity]}
ğŸ“ å¤‡æ³¨ï¼š${detailData.notes || 'æ— '}

ç»§ç»­åŠ æ²¹ï¼ğŸ’ª`;
      
      const response = await fetch('/tools/api/fitness_community/create_post/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
          post_type: 'checkin',
          title: title,
          content: content,
          training_parts: detailData.training_parts,
          difficulty_level: detailData.intensity === 'high' ? 'advanced' : detailData.intensity === 'medium' ? 'intermediate' : 'beginner',
          tags: ['å¥èº«æ‰“å¡', workoutTypeNames[detailData.workout_type]]
        })
      });
      
      const data = await response.json();
      if (data.success) {
        alert('å·²æˆåŠŸåˆ†äº«åˆ°ç¤¾åŒºï¼');
      }
    } catch (error) {
      console.error('åˆ›å»ºç¤¾åŒºå¸–å­å¤±è´¥:', error);
      alert('åˆ†äº«åˆ°ç¤¾åŒºå¤±è´¥ï¼Œä½†æ‰“å¡å·²ä¿å­˜');
    }
  }
  
  async deleteCheckin(dateStr) {
    try {
      const response = await fetch(`/tools/api/checkin/delete/${this.getCheckinId(dateStr)}/`, {
        method: 'DELETE',
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
      });
      
      const result = await response.json();
      
      if (result.success) {
        await this.loadCalendarData();
        this.renderCalendar();
        this.updateStats();
        alert('åˆ é™¤æˆåŠŸ');
      } else {
        alert('åˆ é™¤å¤±è´¥: ' + result.error);
      }
    } catch (error) {
      console.error('åˆ é™¤æ‰“å¡å¤±è´¥:', error);
      alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  }
  
  getCheckinId(dateStr) {
    // è¿™é‡Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µè·å–checkin_id
    return 1; // ä¸´æ—¶è¿”å›
  }
  
  getWorkoutTypeName(type) {
    const types = {
      'strength': 'åŠ›é‡è®­ç»ƒ',
      'cardio': 'æœ‰æ°§è®­ç»ƒ',
      'yoga': 'ç‘œä¼½',
      'hiit': 'é«˜å¼ºåº¦é—´æ­‡',
      'flexibility': 'æŸ”éŸ§æ€§è®­ç»ƒ',
      'other': 'å…¶ä»–'
    };
    return types[type] || type;
  }
  
  getIntensityName(intensity) {
    const intensities = {
      'low': 'ä½',
      'medium': 'ä¸­',
      'high': 'é«˜'
    };
    return intensities[intensity] || intensity;
  }
  
  updateStats() {
    const completionRateEl = document.getElementById('completionRate');
    const totalDurationEl = document.getElementById('totalDuration');
    const completedDaysEl = document.getElementById('completedDays');
    
    if (completionRateEl) {
      completionRateEl.textContent = `${this.monthlyStats.completion_rate || 0}%`;
    }
    if (totalDurationEl) {
      totalDurationEl.textContent = this.monthlyStats.total_duration || 0;
    }
    if (completedDaysEl) {
      completedDaysEl.textContent = this.monthlyStats.completed_days || 0;
    }
  }
  
  bindEvents() {
    const prevMonthBtn = document.getElementById('prevMonth');
    const nextMonthBtn = document.getElementById('nextMonth');
    const goTodayBtn = document.getElementById('goToday');
    
    if (prevMonthBtn) {
      prevMonthBtn.addEventListener('click', () => {
        this.currentMonth--;
        if (this.currentMonth < 0) {
          this.currentMonth = 11;
          this.currentYear--;
        }
        this.loadCalendarData().then(() => this.renderCalendar());
      });
    }
    
    if (nextMonthBtn) {
      nextMonthBtn.addEventListener('click', () => {
        this.currentMonth++;
        if (this.currentMonth > 11) {
          this.currentMonth = 0;
          this.currentYear++;
        }
        this.loadCalendarData().then(() => this.renderCalendar());
      });
    }
    
    if (goTodayBtn) {
      goTodayBtn.addEventListener('click', () => {
        this.currentDate = new Date();
        this.currentYear = this.currentDate.getFullYear();
        this.currentMonth = this.currentDate.getMonth();
        this.loadCalendarData().then(() => this.renderCalendar());
      });
    }
  }
  
  async loadPlanLibrary() {
    try {

      const response = await fetch('/tools/api/training_plans/list/');

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const data = await response.json();

      if (data.success) {

        this.renderPlanLibrary(data.plans || []);
        this.updatePlanStats(data.plans || []);
      } else {
        console.error('åŠ è½½è®¡åˆ’åº“å¤±è´¥:', data.error);
        this.showPlanLibraryError();
      }
    } catch (error) {
      console.error('åŠ è½½è®¡åˆ’åº“æ•°æ®å¤±è´¥:', error);
      this.showPlanLibraryError();
    }
  }
  
  renderPlanLibrary(plans) {
    const container = document.getElementById('planLibraryContainer');
    if (!container) return;
    
    if (plans.length === 0) {
      container.innerHTML = `
        <div class="no-plans-message">
          <i class="fas fa-clipboard-list" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
          è¿˜æ²¡æœ‰ä¿å­˜çš„è®­ç»ƒè®¡åˆ’
          <br>
          <small>ç‚¹å‡»ä¸Šæ–¹"+"æŒ‰é’®åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªè®¡åˆ’</small>
        </div>
      `;
      return;
    }
    
    const planHTML = plans.map(plan => {
      const statusClass = plan.is_active ? 'active' : '';
      const statusBadge = plan.is_active ? '<i class="fas fa-check-circle" style="color: #28a745; margin-left: 5px;"></i>' : '';
      
      return `
        <div class="plan-item ${statusClass}">
          <div class="plan-info">
            <div class="plan-name">${plan.name}${statusBadge}</div>
            <div class="plan-details">
              <span><i class="fas fa-dumbbell"></i> ${plan.mode}</span>
              <span><i class="fas fa-calendar"></i> ${plan.cycle_weeks}å‘¨</span>
              <span><i class="fas fa-list"></i> ${plan.week_schedule ? plan.week_schedule.length : 0}å¤©å®‰æ’</span>
            </div>
          </div>
          <div class="plan-actions">
            <button class="plan-btn edit" onclick="editPlan(${plan.id})" title="ç¼–è¾‘è®¡åˆ’">
              <i class="fas fa-edit"></i>
            </button>
            <button class="plan-btn preview" onclick="previewPlanFromLibrary(${plan.id})" title="é¢„è§ˆè®¡åˆ’">
              <i class="fas fa-eye"></i>
            </button>
            ${!plan.is_active ? `
              <button class="plan-btn apply" onclick="applyPlan(${plan.id}, '${plan.name}')" title="åº”ç”¨è®¡åˆ’">
                <i class="fas fa-play"></i>
              </button>
            ` : ''}
            <button class="plan-btn delete" onclick="deletePlan(${plan.id}, '${plan.name}')" title="åˆ é™¤è®¡åˆ’">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      `;
    }).join('');
    
    container.innerHTML = planHTML;
  }
  
  updatePlanStats(plans) {
    const elements = {
      totalPlansCount: document.getElementById('totalPlansCount'),
      activePlanName: document.getElementById('activePlanName'),
      planCompletionRate: document.getElementById('planCompletionRate')
    };
    
    if (elements.totalPlansCount) {
      elements.totalPlansCount.textContent = plans.length;
    }
    
    const activePlan = plans.find(plan => plan.is_active);
    if (elements.activePlanName) {
      elements.activePlanName.textContent = activePlan ? activePlan.name : 'æ— ';
    }
    
    if (elements.planCompletionRate) {
      // è®¡ç®—è®¡åˆ’å®Œæˆåº¦ (è¿™é‡Œå¯ä»¥æ ¹æ®å®é™…éœ€è¦è°ƒæ•´è®¡ç®—é€»è¾‘)
      const completionRate = activePlan ? this.calculatePlanCompletion(activePlan) : 0;
      elements.planCompletionRate.textContent = `${completionRate}%`;
    }
  }
  
  calculatePlanCompletion(plan) {
    // ç®€å•çš„å®Œæˆåº¦è®¡ç®—ï¼šåŸºäºå½“å‰æœˆä»½çš„æ‰“å¡æƒ…å†µ
    const currentMonth = new Date().getMonth() + 1;
    const currentYear = new Date().getFullYear();
    const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
    
    let completedDays = 0;
    for (let day = 1; day <= daysInMonth; day++) {
      const dateStr = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      if (this.calendarData[dateStr]) {
        completedDays++;
      }
    }
    
    return Math.round((completedDays / daysInMonth) * 100);
  }
  
  showPlanLibraryError() {
    const container = document.getElementById('planLibraryContainer');
    if (container) {
      container.innerHTML = `
        <div class="no-plans-message" style="color: #ff6b6b;">
          <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
          åŠ è½½è®¡åˆ’åº“å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•
        </div>
      `;
    }
  }
}

// å¼ºåˆ¶æ¸…é™¤ç¼“å­˜çš„å‡½æ•°ï¼ˆå·²ç¦ç”¨ï¼Œé¿å…æ— é™åˆ·æ–°ï¼‰
function forceClearCache() {
  // æš‚æ—¶ç¦ç”¨è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½
  return false;
}

// è¦†ç›–ä»»ä½•å¯èƒ½å­˜åœ¨çš„æ—§å‡½æ•°
window.renderActivePlan = undefined;
// æ³¨æ„ï¼šä¸è¦å°†initCurrentPlanè®¾ç½®ä¸ºundefinedï¼Œå› ä¸ºé¡µé¢åˆå§‹åŒ–æ—¶éœ€è¦è°ƒç”¨å®ƒ

// å…¨å±è®­ç»ƒè®¡åˆ’åŠŸèƒ½
function togglePlanFullscreen() {
  const trainingCard = document.querySelector('.fitness-card');
  const fullscreenBtn = document.querySelector('.fullscreen-plan-btn');
  const fullscreenIcon = fullscreenBtn.querySelector('i');
  
  if (trainingCard.classList.contains('fullscreen')) {
    // é€€å‡ºå…¨å±
    trainingCard.classList.remove('fullscreen');
    document.body.classList.remove('fullscreen-active');
    fullscreenIcon.className = 'fas fa-expand';
    fullscreenBtn.setAttribute('data-zh', 'å…¨å±');
    fullscreenBtn.setAttribute('data-en', 'Fullscreen');
    fullscreenBtn.title = 'å…¨å±';
  } else {
    // è¿›å…¥å…¨å±
    trainingCard.classList.add('fullscreen');
    document.body.classList.add('fullscreen-active');
    fullscreenIcon.className = 'fas fa-compress';
    fullscreenBtn.setAttribute('data-zh', 'é€€å‡ºå…¨å±');
    fullscreenBtn.setAttribute('data-en', 'Exit Fullscreen');
    fullscreenBtn.title = 'é€€å‡ºå…¨å±';
  }
}

// ESCé”®é€€å‡ºå…¨å±
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    const trainingCard = document.querySelector('.fitness-card');
    if (trainingCard && trainingCard.classList.contains('fullscreen')) {
      togglePlanFullscreen();
    }
  }
});

// åˆå§‹åŒ–æ‰“å¡æ—¥å†
document.addEventListener('DOMContentLoaded', function() {
  // å†æ¬¡ç¡®ä¿æ²¡æœ‰æ—§å‡½æ•°
  if (typeof renderActivePlan !== 'undefined') {
    console.error('ä»ç„¶æ£€æµ‹åˆ°æ—§å‡½æ•° renderActivePlanï¼Œè¯·æ¸…é™¤æµè§ˆå™¨ç¼“å­˜');
    return;
  }
  if (typeof initCurrentPlan !== 'undefined') {
    console.error('ä»ç„¶æ£€æµ‹åˆ°æ—§å‡½æ•° initCurrentPlanï¼Œè¯·æ¸…é™¤æµè§ˆå™¨ç¼“å­˜');
    return;
  }

  try {
    window.checkInCalendar = new CheckInCalendar();

    // ç»‘å®šç‚¹å‡»æŸ¥çœ‹è®¡åˆ’è¯¦æƒ…
    document.querySelectorAll('.plan-day').forEach(day => {
      day.addEventListener('click', () => showDayDetails(parseInt(day.getAttribute('data-day')) - 1));
    });
    
    // åŠ è½½å½“å‰æ¿€æ´»çš„è®­ç»ƒè®¡åˆ’
    loadActivePlan();
    
    // å»¶è¿Ÿæ¢å¤å®ŒæˆçŠ¶æ€ï¼Œç¡®ä¿DOMå·²åŠ è½½
    setTimeout(() => {
      restoreExerciseCompletions();
    }, 1000);
  } catch (error) {
    console.error('åˆå§‹åŒ–å¤±è´¥:', error);
  }
});

// åŠ è½½å½“å‰æ¿€æ´»çš„è®­ç»ƒè®¡åˆ’
async function loadActivePlan() {
  try {

    const response = await fetch('/tools/api/training_plans/active/');
    const data = await response.json();

    if (data.success && data.has_plan) {

      updatePlanDisplay(data.plan);
    } else {

      showNoPlanDisplay();
    }
  } catch (error) {
    console.error('åŠ è½½è®­ç»ƒè®¡åˆ’å¤±è´¥:', error);
    showNoPlanDisplay();
  }
}

// æ›´æ–°è®¡åˆ’æ˜¾ç¤º
function updatePlanDisplay(plan) {


  // æ›´æ–°è®¡åˆ’ä¿¡æ¯
  const planInfo = document.querySelector('.plan-info h4');
  const planDescription = document.querySelector('.plan-info p');
  
  if (planInfo) {
    planInfo.textContent = `å½“å‰è®¡åˆ’ï¼š${plan.name}`;
  }
  if (planDescription) {
    planDescription.textContent = `${plan.mode} â€¢ ${plan.cycle_weeks}å‘¨è®¡åˆ’`;
  }
  
  // æ›´æ–°è®­ç»ƒæ—¥æ˜¾ç¤º - åªæ˜¾ç¤ºä»Šå¤©çš„è®­ç»ƒ
  const workoutPlan = document.getElementById('workoutPlan');


  if (workoutPlan && plan.week_schedule) {
    const weekDays = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];
    
    // è·å–å½“å‰æ˜ŸæœŸå‡ 
    const today = new Date();
    const currentDayOfWeek = today.getDay();
    const currentWeekday = weekDays[currentDayOfWeek === 0 ? 6 : currentDayOfWeek - 1]; // è½¬æ¢ä¸ºå‘¨ä¸€å¼€å§‹
    
    // æ‰¾åˆ°ä»Šå¤©çš„è®­ç»ƒè®¡åˆ’
    let todaysPlan = null;
    let todaysIndex = -1;
    
    for (let i = 0; i < plan.week_schedule.length; i++) {
      const dayData = plan.week_schedule[i];
      const dayName = weekDays[i] || dayData.weekday || `ç¬¬${i + 1}å¤©`;
      if (dayName === currentWeekday) {
        todaysPlan = dayData;
        todaysIndex = i;
        break;
      }
    }
    
    if (todaysPlan) {

      const exerciseCount = todaysPlan.exercises ? todaysPlan.exercises.length : 0;
      const dayType = todaysPlan.type || todaysPlan.name || 'è®­ç»ƒ';

      // å®‰å…¨åœ°è·å–è®­ç»ƒéƒ¨ä½
      let bodyParts = 'æœªè®¾ç½®';
      if (todaysPlan.body_parts && Array.isArray(todaysPlan.body_parts)) {
        bodyParts = todaysPlan.body_parts.join(' + ');
      } else if (dayType) {
        bodyParts = dayType;
      }
      
      // æ›´å®‰å…¨çš„ä¼‘æ¯æ—¥åˆ¤æ–­
      let isRestDay = false;
      if (exerciseCount === 0) {
        isRestDay = true;
      } else if (dayType && typeof dayType === 'string') {
        isRestDay = dayType.includes('ä¼‘æ¯');
      }

      const exerciseText = exerciseCount > 0 ? `${exerciseCount}ä¸ªåŠ¨ä½œ` : 
        (isRestDay ? 'æ¢å¤æ—¥' : 'å¾…æ·»åŠ ');
      
      // ç”Ÿæˆä»Šå¤©çš„è¯¦ç»†åŠ¨ä½œåˆ—è¡¨
      let todaysExercisesList = '';
      if (todaysPlan.exercises && Array.isArray(todaysPlan.exercises) && todaysPlan.exercises.length > 0) {
        todaysExercisesList = todaysPlan.exercises.map((exercise, index) => {
          return `
            <div class="exercise-item" data-exercise-index="${index}" data-day-index="0" style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              padding: 15px;
              margin: 10px 0;
              background: linear-gradient(135deg, rgba(76, 175, 80, 0.05) 0%, rgba(76, 175, 80, 0.02) 100%);
              border: 1px solid rgba(76, 175, 80, 0.2);
              border-radius: 12px;
              border-left: 4px solid #4CAF50;
              box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
              transition: all 0.3s ease;
            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0, 0, 0, 0.12)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.08)'">
              <div class="exercise-info" style="flex: 1;">
                <div class="exercise-header" style="display: flex; align-items: center; margin-bottom: 8px;">
                  <div class="exercise-number" style="
                    background: #4CAF50;
                    color: white;
                    width: 24px;
                    height: 24px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 12px;
                    font-weight: bold;
                    margin-right: 12px;
                  ">${index + 1}</div>
                  <div class="exercise-name" style="font-weight: bold; color: white; font-size: 16px; line-height: 1.2; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">
                    ${exercise.name}
                  </div>
                </div>
                <div class="exercise-details" style="
                  color: #666;
                  font-size: 14px;
                  line-height: 1.4;
                  margin-left: 36px;
                  display: flex;
                  flex-wrap: wrap;
                  gap: 12px;
                ">
                  <span style="
                    background: rgba(76, 175, 80, 0.1);
                    padding: 4px 8px;
                    border-radius: 6px;
                    font-weight: 500;
                    color: #2E7D32;
                  ">
                    <i class="fas fa-repeat" style="margin-right: 4px;"></i>
                    ${exercise.sets || 3}ç»„
                  </span>
                  <span style="
                    background: rgba(33, 150, 243, 0.1);
                    padding: 4px 8px;
                    border-radius: 6px;
                    font-weight: 500;
                    color: #1565C0;
                  ">
                    <i class="fas fa-times" style="margin-right: 4px;"></i>
                    ${exercise.reps || '10-12'}æ¬¡
                  </span>
                  ${exercise.weight ? `
                    <span style="
                      background: rgba(255, 152, 0, 0.1);
                      padding: 4px 8px;
                      border-radius: 6px;
                      font-weight: 500;
                      color: #E65100;
                    ">
                      <i class="fas fa-dumbbell" style="margin-right: 4px;"></i>
                      ${exercise.weight}${(exercise.weight && (exercise.weight.toString().includes('kg') || /^(è‡ªé‡|ç©ºæ†)$/.test(exercise.weight.toString()) || exercise.weight.toString().includes('æ†'))) ? '' : 'kg'}
                    </span>
                  ` : ''}
                  ${exercise.rest ? `
                    <span style="
                      background: rgba(156, 39, 176, 0.1);
                      padding: 4px 8px;
                      border-radius: 6px;
                      font-weight: 500;
                      color: #7B1FA2;
                    ">
                      <i class="fas fa-clock" style="margin-right: 4px;"></i>
                      ä¼‘æ¯${exercise.rest}
                    </span>
                  ` : ''}
                </div>
              </div>
              <div class="exercise-actions" style="margin-left: 15px;">
                <button class="complete-btn" onclick="markExerciseDone(${index}, 0)" style="
                  background: linear-gradient(135deg, #4CAF50 0%, #45A049 100%);
                  color: white;
                  border: none;
                  padding: 8px 16px;
                  border-radius: 8px;
                  cursor: pointer;
                  font-size: 13px;
                  font-weight: 500;
                  box-shadow: 0 2px 6px rgba(76, 175, 80, 0.3);
                  transition: all 0.3s ease;
                  display: flex;
                  align-items: center;
                  gap: 6px;
                  min-width: 80px;
                  justify-content: center;
                " onmouseover="if(!this.classList.contains('completed')) { this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(76, 175, 80, 0.4)'; }" onmouseout="if(!this.classList.contains('completed')) { this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px rgba(76, 175, 80, 0.3)'; }">
                  <i class="fas fa-check"></i> å®Œæˆ
                </button>
              </div>
            </div>
          `;
        }).join('');
      } else if (isRestDay) {
        todaysExercisesList = `
          <div class="rest-day-message" style="
            text-align: center;
            padding: 30px 20px;
            background: linear-gradient(135deg, rgba(156, 39, 176, 0.05) 0%, rgba(156, 39, 176, 0.02) 100%);
            border: 1px solid rgba(156, 39, 176, 0.2);
            border-radius: 12px;
            color: #7B1FA2;
            font-style: italic;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
          ">
            <div style="font-size: 48px; margin-bottom: 15px;">ğŸ˜´</div>
            <div style="font-size: 18px; font-weight: 500; margin-bottom: 8px;">ä¼‘æ¯æ—¥</div>
            <div style="font-size: 14px; color: #999;">å¥½å¥½æ¢å¤ä½“åŠ›ï¼Œä¸ºæ˜å¤©çš„è®­ç»ƒåšå‡†å¤‡</div>
          </div>
        `;
      } else {
        todaysExercisesList = `
          <div class="no-exercises-message" style="
            text-align: center;
            padding: 30px 20px;
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.05) 0%, rgba(255, 193, 7, 0.02) 100%);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 12px;
            color: #F57C00;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
          ">
            <div style="font-size: 48px; margin-bottom: 15px;">ğŸ“</div>
            <div style="font-size: 18px; font-weight: 500; margin-bottom: 8px;">å¾…æ·»åŠ åŠ¨ä½œ</div>
            <div style="font-size: 14px; color: #999; margin-bottom: 15px;">æš‚æœªå®‰æ’å…·ä½“è®­ç»ƒåŠ¨ä½œ</div>
            <button onclick="window.location.href='/tools/fitness/plan-editor/'" 
                    style="
                      padding: 10px 20px;
                      background: linear-gradient(135deg, #4CAF50 0%, #45A049 100%);
                      color: white;
                      border: none;
                      border-radius: 8px;
                      cursor: pointer;
                      font-size: 14px;
                      font-weight: 500;
                      box-shadow: 0 2px 6px rgba(76, 175, 80, 0.3);
                      transition: all 0.3s ease;
                    "
                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(76, 175, 80, 0.4)'"
                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px rgba(76, 175, 80, 0.3)'">
              <i class="fas fa-edit" style="margin-right: 6px;"></i> ç¼–è¾‘è®¡åˆ’
            </button>
          </div>
        `;
      }
      
      workoutPlan.innerHTML = `
        <div class="today-plan-container">
          <div class="plan-day active today" data-day="${todaysIndex + 1}" onclick="showDayDetails(${todaysIndex})" style="margin-bottom: 15px;">
            <span>${currentWeekday} ğŸŒŸ</span>
            <span class="plan-type">${bodyParts}</span>
            <span class="plan-exercises">${exerciseText}</span>
          </div>
          
          <div class="today-exercises-details" style="margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin: 10px 0;">
              <h5 style="color: #333; margin: 0; font-size: 14px; font-weight: bold;">
                <i class="fas fa-dumbbell"></i> ä»Šæ—¥è®­ç»ƒè¯¦æƒ…
              </h5>
              <div class="training-progress" style="
                background: rgba(76, 175, 80, 0.1);
                padding: 4px 12px;
                border-radius: 12px;
                font-size: 12px;
                color: #4CAF50;
                font-weight: 500;
              ">
                è®­ç»ƒè¿›åº¦: 0% (0/0)
              </div>
            </div>
            ${todaysExercisesList}
          </div>
          
          <div class="action-buttons" style="display: flex; gap: 10px;">
            <div class="view-full-plan-btn" onclick="showFullWeekPlan()" style="
              flex: 1;
              text-align: center;
              padding: 12px;
              background: rgba(76, 175, 80, 0.1);
              border: 1px dashed #4CAF50;
              border-radius: 8px;
              cursor: pointer;
              color: #4CAF50;
              font-size: 13px;
              transition: all 0.3s ease;
            ">
              <i class="fas fa-eye"></i> æŸ¥çœ‹å®Œæ•´å‘¨è®¡åˆ’
            </div>
            <div class="export-today-btn" onclick="exportTodayPlan()" style="
              flex: 1;
              text-align: center;
              padding: 12px;
              background: rgba(33, 150, 243, 0.1);
              border: 1px dashed #2196F3;
              border-radius: 8px;
              cursor: pointer;
              color: #2196F3;
              font-size: 13px;
              transition: all 0.3s ease;
            ">
              <i class="fas fa-download"></i> å¯¼å‡ºä»Šæ—¥è®¡åˆ’
            </div>
          </div>
        </div>
      `;
      
      // å»¶è¿Ÿæ¢å¤å®ŒæˆçŠ¶æ€
      setTimeout(() => {
        restoreExerciseCompletions();
      }, 100);
    } else {
      // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä»Šå¤©çš„è®¡åˆ’ï¼Œæ˜¾ç¤ºæç¤º
      workoutPlan.innerHTML = `
        <div class="no-plan-today" style="
          text-align: center;
          padding: 20px;
          color: #666;
          background: rgba(0, 0, 0, 0.05);
          border-radius: 8px;
        ">
          <i class="fas fa-calendar-times" style="font-size: 24px; margin-bottom: 10px; color: #999;"></i>
          <p>ä»Šå¤©æ²¡æœ‰å®‰æ’è®­ç»ƒ</p>
          <button onclick="showFullWeekPlan()" class="btn-secondary" style="margin-top: 10px;">
            <i class="fas fa-eye"></i> æŸ¥çœ‹å®Œæ•´å‘¨è®¡åˆ’
          </button>
        </div>
      `;
    }
  }
}

// æ˜¾ç¤ºæ— è®¡åˆ’çŠ¶æ€
function showNoPlanDisplay() {
  const planInfo = document.querySelector('.plan-info h4');
  const planDescription = document.querySelector('.plan-info p');
  
  if (planInfo) {
    planInfo.textContent = 'æš‚æ— è®­ç»ƒè®¡åˆ’';
  }
  if (planDescription) {
    planDescription.textContent = 'ç‚¹å‡»"ç¼–è¾‘è®¡åˆ’"å¼€å§‹åˆ›å»ºä½ çš„è®­ç»ƒè®¡åˆ’';
  }
  
  const workoutPlan = document.getElementById('workoutPlan');
  if (workoutPlan) {
    workoutPlan.innerHTML = `
      <div class="no-plan-message" style="
        text-align: center;
        padding: 40px 20px;
        color: #a8a8a8;
        border: 2px dashed rgba(255, 255, 255, 0.2);
        border-radius: 8px;
      ">
        <i class="fas fa-plus-circle" style="font-size: 2rem; margin-bottom: 16px; opacity: 0.5;"></i>
        <p>è¿˜æ²¡æœ‰è®­ç»ƒè®¡åˆ’</p>
        <p style="font-size: 0.9rem;">ç‚¹å‡»ä¸Šæ–¹"ç¼–è¾‘è®¡åˆ’"æŒ‰é’®å¼€å§‹åˆ›å»º</p>
      </div>
    `;
  }
}

// è®­ç»ƒè®¡åˆ’ç¼–è¾‘å™¨ç›¸å…³å‡½æ•°
function openPlanEditor() {
  window.location.href = '/tools/fitness/plan-editor/';
}

// ç¼–è¾‘å½“å‰æ¿€æ´»çš„è®­ç»ƒè®¡åˆ’
async function editActivePlan() {
  try {
    const response = await fetch('/tools/api/training_plans/active/');
    const data = await response.json();
    
    if (data.success && data.has_plan) {
      // è·³è½¬åˆ°ç¼–è¾‘å™¨å¹¶ä¼ é€’è®¡åˆ’ID
      window.location.href = `/tools/fitness/plan-editor/?plan_id=${data.plan.id}`;
    } else {
      // æ²¡æœ‰æ¿€æ´»çš„è®¡åˆ’ï¼Œåˆ›å»ºæ–°è®¡åˆ’
      openPlanEditor();
    }
  } catch (error) {
    console.error('è·å–æ¿€æ´»è®¡åˆ’å¤±è´¥:', error);
    // å‡ºé”™æ—¶ä¹Ÿè·³è½¬åˆ°ç¼–è¾‘å™¨
    openPlanEditor();
  }
}

// æ‰“å¼€è®¡åˆ’åº“
async function openPlanLibrary() {
  try {
    const response = await fetch('/tools/api/training_plans/list/');
    const data = await response.json();
    
    if (data.success) {
      showPlanLibraryModal(data.plans || []);
    } else {
      alert('åŠ è½½è®¡åˆ’åº“å¤±è´¥: ' + data.error);
    }
  } catch (error) {
    console.error('åŠ è½½è®¡åˆ’åº“å¤±è´¥:', error);
    alert('åŠ è½½è®¡åˆ’åº“å¤±è´¥ï¼Œè¯·é‡è¯•');
  }
}

// æ˜¾ç¤ºè®¡åˆ’åº“æ¨¡æ€æ¡†
function showPlanLibraryModal(plans) {
  const modal = document.createElement('div');
  modal.className = 'checkin-modal';
  
  let plansHTML = '';
  if (plans.length === 0) {
    plansHTML = '<div class="no-plans-message">æ‚¨è¿˜æ²¡æœ‰ä¿å­˜çš„è®­ç»ƒè®¡åˆ’ï¼Œå¿«å»åˆ›å»ºä¸€ä¸ªå§ï¼</div>';
  } else {
    plansHTML = plans.map(plan => `
      <div class="plan-library-item" data-plan-id="${plan.id}">
        <div class="plan-info">
          <div class="plan-name">${plan.name}</div>
          <div class="plan-meta">${plan.mode} â€¢ ${plan.cycle_weeks}å‘¨ â€¢ æ›´æ–°äº ${new Date(plan.updated_at).toLocaleDateString()}</div>
        </div>
        <div class="plan-actions">
          <button class="btn-apply" onclick="applyPlan(${plan.id}, '${plan.name}')">
            <i class="fas fa-play"></i> åº”ç”¨
          </button>
          <button class="btn-preview" onclick="previewPlan(${plan.id})">
            <i class="fas fa-eye"></i> é¢„è§ˆ
          </button>
        </div>
      </div>
    `).join('');
  }
  
  modal.innerHTML = `
    <div class="checkin-modal-content" style="max-width: 600px;">
      <h3><i class="fas fa-book"></i> æˆ‘çš„è®¡åˆ’åº“</h3>
      <div class="plan-library-content">
        ${plansHTML}
      </div>
      <div class="form-actions" style="justify-content: center; margin-top: 20px;">
        <button class="btn-primary" onclick="window.location.href='/tools/fitness/plan-editor/'">
          <i class="fas fa-plus"></i> åˆ›å»ºæ–°è®¡åˆ’
        </button>
        <button class="btn-cancel">å…³é—­</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  modal.querySelector('.btn-cancel').addEventListener('click', () => modal.remove());
  modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
}

// æ‰“å¼€æ¨¡æ¿æ¨è
async function openPlanTemplates() {
  try {
    const response = await fetch('/tools/api/training_plans/templates/');
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();

    if (data.success) {
      let templates = data.templates || data.data || [];
      
      // å¦‚æœtemplatesæ˜¯å¯¹è±¡ï¼Œè½¬æ¢ä¸ºæ•°ç»„
      if (typeof templates === 'object' && !Array.isArray(templates)) {
        templates = Object.keys(templates).map(key => ({
          id: key,
          ...templates[key]
        }));
      }

      showPlanTemplatesModal(templates);
    } else {
      console.error('APIè¿”å›é”™è¯¯:', data);
      alert('åŠ è½½æ¨¡æ¿å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
    }
  } catch (error) {
    console.error('åŠ è½½æ¨¡æ¿å¤±è´¥:', error);
    alert('åŠ è½½æ¨¡æ¿å¤±è´¥: ' + error.message);
  }
}

// æ˜¾ç¤ºæ¨¡æ¿æ¨èæ¨¡æ€æ¡†
function showPlanTemplatesModal(templates) {
  const modal = document.createElement('div');
  modal.className = 'checkin-modal';
  
  // ç¡®ä¿templatesæ˜¯æ•°ç»„
  if (!Array.isArray(templates)) {
    console.warn('templatesä¸æ˜¯æ•°ç»„:', templates);
    templates = [];
  }
  
  // å¤„ç†ç©ºæ¨¡æ¿çš„æƒ…å†µ
  if (templates.length === 0) {
    templates = [{
      id: 'no_templates',
      name: 'æš‚æ— æ¨¡æ¿',
      description: 'å½“å‰æ²¡æœ‰å¯ç”¨çš„è®­ç»ƒè®¡åˆ’æ¨¡æ¿',
      difficulty: 'beginner',
      target_goals: [],
      mode: 'custom'
    }];
  }
  
  const templatesHTML = templates.map(template => {
    const difficultyColors = {
      'beginner': '#4CAF50',
      'intermediate': '#FF9800', 
      'advanced': '#f44336',
      'expert': '#9C27B0'
    };
    
    const difficultyNames = {
      'beginner': 'åˆå­¦è€…',
      'intermediate': 'ä¸­çº§',
      'advanced': 'é«˜çº§',
      'expert': 'ä¸“å®¶'
    };
    
    // ç¡®ä¿æ¨¡æ¿æ•°æ®å®‰å…¨
    const safeTemplate = {
      id: template.id || 'unknown',
      name: template.name || 'æœªçŸ¥æ¨¡æ¿',
      description: template.description || 'æš‚æ— æè¿°',
      difficulty: template.difficulty || 'beginner',
      target_goals: Array.isArray(template.target_goals) ? template.target_goals : [],
      mode: template.mode || 'custom'
    };
    
    return `
      <div class="template-item" data-template-id="${safeTemplate.id}">
        <div class="template-header">
          <div class="template-name">${safeTemplate.name}</div>
          <div class="template-difficulty" style="background: ${difficultyColors[safeTemplate.difficulty] || '#666'}">
            ${difficultyNames[safeTemplate.difficulty] || safeTemplate.difficulty}
          </div>
        </div>
        <div class="template-description">${safeTemplate.description}</div>
        <div class="template-meta">
          <span><i class="fas fa-calendar"></i> ${template.cycle_weeks || 4}å‘¨</span>
          <span><i class="fas fa-dumbbell"></i> ${safeTemplate.mode}</span>
          <span><i class="fas fa-target"></i> ${safeTemplate.target_goals.join(', ')}</span>
        </div>
        <div class="template-actions">
          <button class="btn-apply" onclick="applyTemplate('${safeTemplate.id}', '${safeTemplate.name}')"
            <i class="fas fa-rocket"></i> ç«‹å³åº”ç”¨
          </button>
          <button class="btn-preview" onclick="previewTemplate('${safeTemplate.id}')">
            <i class="fas fa-eye"></i> é¢„è§ˆ
          </button>
        </div>
      </div>
    `;
  }).join('');
  
  modal.innerHTML = `
    <div class="checkin-modal-content" style="max-width: 700px;">
      <h3><i class="fas fa-star"></i> æ¨¡æ¿æ¨è</h3>
      <div class="templates-content">
        ${templatesHTML}
      </div>
      <div class="form-actions" style="justify-content: center; margin-top: 20px;">
        <button class="btn-cancel">å…³é—­</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  modal.querySelector('.btn-cancel').addEventListener('click', () => modal.remove());
  modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
}

// åº”ç”¨è®­ç»ƒè®¡åˆ’
async function applyPlan(planId, planName) {
  if (!confirm(`ç¡®å®šè¦åº”ç”¨è®¡åˆ’"${planName}"å—ï¼Ÿè¿™å°†æ›¿æ¢å½“å‰çš„æ¿€æ´»è®¡åˆ’ã€‚`)) {
    return;
  }
  
  try {
    const response = await fetch('/tools/api/training_plans/apply/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: JSON.stringify({ plan_id: planId })
    });
    
    const data = await response.json();
    
    if (data.success) {
      // å…³é—­æ¨¡æ€æ¡†
      document.querySelector('.checkin-modal').remove();
      
      // åˆ·æ–°å½“å‰è®¡åˆ’æ˜¾ç¤º
      await initCurrentPlan();
      
      // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
      showNotification(data.message, 'success');
    } else {
      alert('åº”ç”¨è®¡åˆ’å¤±è´¥: ' + data.error);
    }
  } catch (error) {
    console.error('åº”ç”¨è®¡åˆ’å¤±è´¥:', error);
    alert('åº”ç”¨è®¡åˆ’å¤±è´¥ï¼Œè¯·é‡è¯•');
  }
}

// åº”ç”¨æ¨¡æ¿
async function applyTemplate(templateId, templateName) {
  const customName = prompt(`ä¸ºæ–°è®¡åˆ’å‘½åï¼ˆç•™ç©ºä½¿ç”¨é»˜è®¤åç§°"${templateName}"ï¼‰:`, templateName);
  
  if (customName === null) return; // ç”¨æˆ·å–æ¶ˆ
  
  try {

    // è·å–CSRFä»¤ç‰Œ
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                      document.querySelector('meta[name=csrf-token]')?.content || 
                      getCookie('csrftoken') || '';

    const requestData = { 
      template_id: templateId,
      custom_name: customName.trim() || templateName
    };

    const response = await fetch('/tools/api/training_plans/templates/apply/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      },
      body: JSON.stringify(requestData)
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error('å“åº”é”™è¯¯:', errorText);
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();

    if (data.success) {
      // å…³é—­æ¨¡æ€æ¡†
      document.querySelector('.checkin-modal').remove();
      
      // åˆ·æ–°å½“å‰è®¡åˆ’æ˜¾ç¤º
      await loadActivePlan();
      
      // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
      showNotification(data.message, 'success');
    } else {
      alert('åº”ç”¨æ¨¡æ¿å¤±è´¥: ' + data.error);
    }
  } catch (error) {
    console.error('åº”ç”¨æ¨¡æ¿å¤±è´¥:', error);
    alert('åº”ç”¨æ¨¡æ¿å¤±è´¥ï¼Œè¯·é‡è¯•');
  }
}

// é¢„è§ˆè®¡åˆ’
async function previewPlan(planId) {
  try {
    const response = await fetch(`/tools/api/training_plans/${planId}/`);
    const data = await response.json();
    
    if (data.success) {
      showPlanPreviewModal(data.plan);
    } else {
      alert('åŠ è½½è®¡åˆ’è¯¦æƒ…å¤±è´¥: ' + data.error);
    }
  } catch (error) {
    console.error('åŠ è½½è®¡åˆ’è¯¦æƒ…å¤±è´¥:', error);
    alert('åŠ è½½è®¡åˆ’è¯¦æƒ…å¤±è´¥ï¼Œè¯·é‡è¯•');
  }
}

// é¢„è§ˆæ¨¡æ¿
async function previewTemplate(templateId) {
  try {

    const response = await fetch('/tools/api/training_plans/templates/');
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();

    if (data.success) {
      let template = null;
      const templates = data.templates || {};
      
      // å¤„ç†å­—å…¸æ ¼å¼çš„templates
      if (typeof templates === 'object' && !Array.isArray(templates)) {
        template = templates[templateId];
        if (template) {
          template.id = templateId; // ç¡®ä¿åŒ…å«id
        }
      } else if (Array.isArray(templates)) {
        // å¤„ç†æ•°ç»„æ ¼å¼çš„templates
        template = templates.find(t => t.id === templateId);
      }

      if (template) {
        showPlanPreviewModal(template);
      } else {
        console.error('æœªæ‰¾åˆ°æ¨¡æ¿:', templateId, 'å¯ç”¨æ¨¡æ¿:', Object.keys(templates));
        alert('æœªæ‰¾åˆ°æ¨¡æ¿æ•°æ®');
      }
    } else {
      console.error('APIé”™è¯¯:', data.error);
      alert('è·å–æ¨¡æ¿æ•°æ®å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
    }
  } catch (error) {
    console.error('é¢„è§ˆæ¨¡æ¿å¤±è´¥:', error);
    alert('é¢„è§ˆæ¨¡æ¿å¤±è´¥: ' + error.message);
  }
}

// æ˜¾ç¤ºè®¡åˆ’é¢„è§ˆæ¨¡æ€æ¡†
function showPlanPreviewModal(plan) {
  const modal = document.createElement('div');
  modal.className = 'checkin-modal';
  
  const weekScheduleHTML = plan.week_schedule.map((day, index) => {
    const exerciseCount = day.modules ? 
      Object.values(day.modules).reduce((sum, module) => sum + (module?.length || 0), 0) : 0;
    const exerciseText = exerciseCount > 0 ? `${exerciseCount}ä¸ªåŠ¨ä½œ` : 
      (day.body_parts.includes('ä¼‘æ¯') ? 'æ¢å¤æ—¥' : 'å¾…æ·»åŠ ');
    
    return `
      <div class="preview-day">
        <span class="day-name">${day.weekday}</span>
        <span class="day-parts">${day.body_parts.join(' + ')}</span>
        <span class="day-exercises">${exerciseText}</span>
      </div>
    `;
  }).join('');
  
  modal.innerHTML = `
    <div class="checkin-modal-content" style="max-width: 500px;">
      <h3><i class="fas fa-eye"></i> è®¡åˆ’é¢„è§ˆ - ${plan.name}</h3>
      <div class="plan-preview-content">
        <div class="preview-meta">
          <div><strong>è®­ç»ƒæ¨¡å¼:</strong> ${plan.mode}</div>
          <div><strong>è®­ç»ƒå‘¨æœŸ:</strong> ${plan.cycle_weeks}å‘¨</div>
        </div>
        <div class="preview-schedule">
          <h4>å‘¨å®‰æ’:</h4>
          ${weekScheduleHTML}
        </div>
      </div>
      <div class="form-actions" style="justify-content: center; margin-top: 20px;">
        <button class="btn-cancel">å…³é—­</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  modal.querySelector('.btn-cancel').addEventListener('click', () => modal.remove());
  modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
}

// æ˜¾ç¤ºé€šçŸ¥æ¶ˆæ¯
function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.className = `notification notification-${type}`;
  notification.innerHTML = `
    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
    <span>${message}</span>
  `;
  
  Object.assign(notification.style, {
    position: 'fixed',
    top: '20px',
    right: '20px',
    padding: '12px 20px',
    borderRadius: '6px',
    color: 'white',
    fontSize: '14px',
    fontWeight: '500',
    zIndex: '10000',
    display: 'flex',
    alignItems: 'center',
    gap: '8px',
    minWidth: '250px',
    boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
    backgroundColor: type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3',
    animation: 'slideInRight 0.3s ease-out'
  });
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.animation = 'slideOutRight 0.3s ease-in';
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 300);
  }, 3000);
}

// é¡µé¢åŠ è½½å®Œæˆåçš„å…¶ä»–åˆå§‹åŒ–

// æ·»åŠ æ–°çš„æ ·å¼
const additionalStyles = `
/* è®¡åˆ’åº“å’Œæ¨¡æ¿æ ·å¼ */
.plan-library-content, .templates-content {
  max-height: 400px;
  overflow-y: auto;
  margin: 20px 0;
}

.plan-library-item, .template-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px;
  margin: 10px 0;
  border: 1px solid rgba(255, 107, 53, 0.3);
  border-radius: 8px;
  background: rgba(255, 107, 53, 0.05);
  transition: all 0.3s ease;
}

.plan-library-item:hover, .template-item:hover {
  background: rgba(255, 107, 53, 0.1);
  border-color: var(--rage-primary, #ff6b35);
}

.plan-info, .template-header {
  flex: 1;
}

.plan-name, .template-name {
  font-size: 16px;
  font-weight: 600;
  color: var(--rage-primary, #ff6b35);
  margin-bottom: 5px;
}

.plan-meta, .template-description, .template-meta {
  font-size: 14px;
  color: #ccc;
  margin-bottom: 5px;
}

.template-item {
  flex-direction: column;
  align-items: stretch;
}

.template-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.template-difficulty {
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 500;
  color: white;
}

.template-meta {
  display: flex;
  gap: 15px;
  margin-bottom: 10px;
}

.template-meta span {
  display: flex;
  align-items: center;
  gap: 5px;
  font-size: 13px;
}

.plan-actions, .template-actions {
  display: flex;
  gap: 10px;
}

.btn-apply, .btn-preview {
  padding: 8px 12px;
  border: none;
  border-radius: 4px;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 5px;
}

.btn-apply {
  background: var(--rage-primary, #ff6b35);
  color: white;
}

.btn-apply:hover {
  background: #e55a2b;
  transform: translateY(-1px);
}

.btn-preview {
  background: transparent;
  color: var(--rage-primary, #ff6b35);
  border: 1px solid var(--rage-primary, #ff6b35);
}

.btn-preview:hover {
  background: var(--rage-primary, #ff6b35);
  color: white;
  transform: translateY(-1px);
}

.no-plans-message {
  text-align: center;
  padding: 40px 20px;
  color: #888;
  font-style: italic;
}

/* è®­ç»ƒæ—¥è¯¦æƒ…æ ·å¼ */
.day-details-content {
  max-height: 400px;
  overflow-y: auto;
  margin: 20px 0;
}

.exercise-module {
  margin-bottom: 20px;
}

.exercise-module h5 {
  color: var(--rage-primary, #ff6b35);
  margin-bottom: 10px;
  padding-bottom: 5px;
  border-bottom: 1px solid rgba(255, 107, 53, 0.3);
}

.exercise-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.exercise-item-detail {
  padding: 10px;
  background: rgba(255, 107, 53, 0.05);
  border-radius: 6px;
  border-left: 3px solid var(--rage-primary, #ff6b35);
}

.exercise-name {
  font-weight: 600;
  margin-bottom: 4px;
}

.exercise-params {
  font-size: 14px;
  color: #ccc;
}

.rest-day-info, .no-exercises-info {
  text-align: center;
  padding: 40px 20px;
  color: #888;
  font-size: 16px;
}

.rest-day-info i {
  font-size: 2em;
  margin-bottom: 10px;
  color: var(--rage-primary, #ff6b35);
}

/* é¢„è§ˆæ ·å¼ */
.plan-preview-content {
  margin: 20px 0;
}

.preview-meta {
  margin-bottom: 20px;
  padding: 15px;
  background: rgba(255, 107, 53, 0.05);
  border-radius: 6px;
}

.preview-meta div {
  margin-bottom: 8px;
}

.preview-schedule h4 {
  color: var(--rage-primary, #ff6b35);
  margin-bottom: 15px;
}

.preview-day {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px;
  margin: 5px 0;
  background: rgba(255, 107, 53, 0.05);
  border-radius: 6px;
  border-left: 3px solid var(--rage-primary, #ff6b35);
}

.day-name {
  font-weight: 600;
  min-width: 60px;
}

.day-parts {
  flex: 1;
  text-align: center;
  color: var(--rage-primary, #ff6b35);
}

.day-exercises {
  font-size: 14px;
  color: #ccc;
  min-width: 80px;
  text-align: right;
}

/* å…¨å±è®­ç»ƒè®¡åˆ’æ ·å¼ */
.fitness-card.fullscreen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  z-index: 9999;
  background: var(--rage-bg, #0a0a0a);
  border-radius: 0;
  box-shadow: none;
  overflow-y: auto;
  padding: 20px;
  box-sizing: border-box;
}

.fitness-card.fullscreen .fitness-card-header {
  position: sticky;
  top: 0;
  background: var(--rage-bg, #0a0a0a);
  z-index: 10000;
  padding: 10px 0;
  margin-bottom: 20px;
  border-bottom: 1px solid var(--rage-border, #333);
}

.fitness-card.fullscreen .fitness-card-content {
  max-height: none;
  overflow: visible;
}

.fitness-card.fullscreen .current-plan-preview {
  margin-bottom: 30px;
}

.fitness-card.fullscreen .detailed-plan-day {
  margin-bottom: 25px;
  padding: 20px;
  border-radius: 12px;
  background: rgba(255, 255, 255, 0.05);
}

.fitness-card.fullscreen .day-header {
  font-size: 1.3rem;
  margin-bottom: 15px;
}

.fitness-card.fullscreen .exercise-item {
  padding: 15px;
  margin-bottom: 12px;
  font-size: 1.1rem;
}

/* å…¨å±æŒ‰é’®å›¾æ ‡åˆ‡æ¢ */
.fitness-card.fullscreen .fullscreen-plan-btn i {
  transform: rotate(45deg);
}

/* é˜²æ­¢é¡µé¢æ»šåŠ¨ */
body.fullscreen-active {
  overflow: hidden;
}
`;

// æ·»åŠ æ ·å¼åˆ°é¡µé¢
const styleSheet = document.createElement('style');
styleSheet.textContent = additionalStyles + `
  @keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  
  @keyframes slideOutRight {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
  }
  
  /* ç¡®è®¤å¯¹è¯æ¡†æ ·å¼ */
  .confirmation-message {
    text-align: center;
    margin: 20px 0;
    padding: 20px;
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 8px;
  }
  
  .confirmation-message p {
    margin: 10px 0;
    color: #856404;
    line-height: 1.5;
  }
  
  .confirmation-message strong {
    color: #ff6b35;
  }
  
  .btn-confirm {
    background: #ff6b35;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
  }
  
  .btn-confirm:hover {
    background: #e55a2b;
    transform: translateY(-2px);
  }
  
  /* é€šçŸ¥æ ·å¼ */
  .notification {
    animation: slideInRight 0.3s ease-out;
  }
  
  .notification.notification-error {
    background-color: #f44336;
  }
  
  .notification.notification-success {
    background-color: #4CAF50;
  }
  
  .notification.notification-info {
    background-color: #2196F3;
  }
  
  /* åº”ç”¨è®¡åˆ’å¯¹è¯æ¡†æ ·å¼ */
  .apply-plan-info {
    margin-bottom: 25px;
  }
  
  .plan-warning {
    background: rgba(255, 193, 7, 0.1);
    border: 1px solid rgba(255, 193, 7, 0.3);
    border-radius: 6px;
    padding: 15px;
    margin-top: 15px;
    display: flex;
    align-items: flex-start;
    gap: 12px;
  }
  
  .plan-warning i {
    color: #ffc107;
    font-size: 1.2rem;
    margin-top: 2px;
  }
  
  .plan-warning p {
    margin: 0;
    color: #ffc107;
    font-size: 0.9rem;
    line-height: 1.4;
  }
  
  .week-schedule-preview {
    margin: 20px 0;
  }
  
  .week-schedule-preview h4 {
    color: var(--rage-primary, #ff6b35);
    margin-bottom: 15px;
    font-size: 1.1rem;
  }
  
  .apply-plan-day {
    border: 1px solid rgba(255, 107, 53, 0.3);
    border-radius: 8px;
    margin-bottom: 10px;
    background: rgba(255, 107, 53, 0.05);
    overflow: hidden;
  }
  
  .day-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  
  .day-header:hover {
    background: rgba(255, 107, 53, 0.1);
  }
  
  .day-info {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  
  .day-name {
    font-weight: 600;
    color: var(--rage-text, #e6e6e6);
    font-size: 1rem;
  }
  
  .day-type {
    color: var(--rage-primary, #ff6b35);
    font-size: 0.9rem;
  }
  
  .day-summary {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #a8a8a8;
    font-size: 0.9rem;
  }
  
  .toggle-icon {
    transition: transform 0.3s ease;
  }
  
  .day-content {
    border-top: 1px solid rgba(255, 107, 53, 0.2);
    padding: 20px;
    background: rgba(0, 0, 0, 0.2);
  }
  
  .exercise-module {
    margin-bottom: 20px;
  }
  
  .exercise-module:last-child {
    margin-bottom: 0;
  }
  
  .exercise-module h5 {
    color: var(--rage-primary, #ff6b35);
    margin-bottom: 12px;
    font-size: 1rem;
    font-weight: 600;
    padding-bottom: 6px;
    border-bottom: 1px solid rgba(255, 107, 53, 0.3);
  }
  
  .exercise-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  
  .exercise-item-detail {
    background: rgba(255, 255, 255, 0.05);
    padding: 12px;
    border-radius: 6px;
    border-left: 3px solid var(--rage-primary, #ff6b35);
  }
  
  .exercise-item-detail .exercise-name {
    font-weight: 600;
    margin-bottom: 6px;
    color: var(--rage-text, #e6e6e6);
  }
  
  .exercise-item-detail .exercise-params {
    font-size: 0.9rem;
    color: #a8a8a8;
    line-height: 1.4;
  }
  
  .rest-day-info {
    text-align: center;
    padding: 30px 20px;
    color: #888;
    font-size: 1rem;
  }
  
  .rest-day-info i {
    font-size: 2rem;
    margin-bottom: 10px;
    color: var(--rage-primary, #ff6b35);
    display: block;
  }
  
  /* è¯¦ç»†è®­ç»ƒè®¡åˆ’æ˜¾ç¤ºæ ·å¼ */
  .detailed-plan-day {
    background: rgba(255, 255, 255, 0.05);
    border: 2px solid rgba(255, 107, 53, 0.3);
    border-radius: 12px;
    margin-bottom: 15px;
    padding: 20px;
    transition: all 0.3s ease;
    cursor: pointer;
  }
  
  .detailed-plan-day:hover {
    background: rgba(255, 107, 53, 0.1);
    border-color: rgba(255, 107, 53, 0.5);
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(255, 107, 53, 0.2);
  }
  
  .detailed-plan-day.active {
    background: rgba(255, 107, 53, 0.15);
    border-color: var(--rage-primary, #ff6b35);
    box-shadow: 0 0 20px rgba(255, 107, 53, 0.3);
  }
  
  .detailed-plan-day.rest-day {
    background: rgba(108, 117, 125, 0.1);
    border-color: rgba(108, 117, 125, 0.3);
  }
  
  .detailed-plan-day.rest-day:hover {
    background: rgba(108, 117, 125, 0.2);
    border-color: rgba(108, 117, 125, 0.5);
  }
  
  .day-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid rgba(255, 107, 53, 0.2);
  }
  
  .detailed-plan-day.rest-day .day-header {
    border-bottom-color: rgba(108, 117, 125, 0.3);
  }
  
  .day-name {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--rage-text, #e6e6e6);
  }
  
  .day-type {
    font-size: 1rem;
    font-weight: 600;
    color: var(--rage-primary, #ff6b35);
    background: rgba(255, 107, 53, 0.1);
    padding: 4px 12px;
    border-radius: 15px;
    border: 1px solid rgba(255, 107, 53, 0.3);
  }
  
  .detailed-plan-day.rest-day .day-type {
    color: #6c757d;
    background: rgba(108, 117, 125, 0.1);
    border-color: rgba(108, 117, 125, 0.3);
  }
  
  .day-exercises {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  
  .exercise-item {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 107, 53, 0.2);
    border-radius: 8px;
    padding: 12px 15px;
    transition: all 0.3s ease;
  }
  
  .exercise-item:hover {
    background: rgba(255, 107, 53, 0.1);
    border-color: rgba(255, 107, 53, 0.4);
  }
  
  .exercise-name {
    font-size: 1rem;
    font-weight: 600;
    color: var(--rage-text, #e6e6e6);
    margin-bottom: 4px;
  }
  
  .exercise-details {
    font-size: 0.9rem;
    color: #a8a8a8;
    font-weight: 500;
  }
  
  .rest-day-message {
    text-align: center;
    padding: 30px 20px;
    color: #6c757d;
    font-size: 1.1rem;
    font-style: italic;
    background: rgba(108, 117, 125, 0.1);
    border: 2px dashed rgba(108, 117, 125, 0.3);
    border-radius: 8px;
  }
  
  /* å“åº”å¼è®¾è®¡ */
  @media (max-width: 768px) {
    .detailed-plan-day {
      padding: 15px;
      margin-bottom: 12px;
    }
    
    .day-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
    }
    
    .day-name {
      font-size: 1.1rem;
    }
    
    .day-type {
      font-size: 0.9rem;
      padding: 3px 10px;
    }
    
    .exercise-item {
      padding: 10px 12px;
    }
    
    .exercise-name {
      font-size: 0.95rem;
    }
    
    .exercise-details {
      font-size: 0.85rem;
    }
  }
`;
document.head.appendChild(styleSheet);

// è¿›å…¥ç¤¾åŒºåŠŸèƒ½
function openFitnessCommunity() {
  window.location.href = '/tools/fitness/community/';
}

// ä¸ªäººæ¡£æ¡ˆåŠŸèƒ½
function openFitnessProfile() {
  window.location.href = '/tools/fitness/profile/';
}

// åº”ç”¨è®­ç»ƒè®¡åˆ’
async function applyPlan(planId, planName) {
  try {
    if (!confirm(`ç¡®å®šè¦åº”ç”¨è®­ç»ƒè®¡åˆ’"${planName}"å—ï¼Ÿè¿™å°†æ›¿æ¢å½“å‰çš„æ¿€æ´»è®¡åˆ’ã€‚`)) {
      return;
    }
    
    const response = await fetch('/tools/api/training_plans/apply/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
      },
      body: JSON.stringify({ plan_id: planId })
    });
    
    const data = await response.json();
    
    if (data.success) {
      // å…³é—­æ¨¡æ€æ¡†
      document.querySelector('.checkin-modal')?.remove();
      
      // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
      showNotification(`å·²åº”ç”¨è®­ç»ƒè®¡åˆ’"${planName}"ï¼`, 'success');
      
      // é‡æ–°åŠ è½½è®­ç»ƒè®¡åˆ’æ˜¾ç¤º
      setTimeout(() => {
        loadActivePlan();
      }, 1000);
    } else {
      alert('åº”ç”¨è®¡åˆ’å¤±è´¥: ' + data.error);
    }
  } catch (error) {
    console.error('åº”ç”¨è®¡åˆ’å¤±è´¥:', error);
    alert('åº”ç”¨è®¡åˆ’å¤±è´¥ï¼Œè¯·é‡è¯•');
  }
}

// é¢„è§ˆè®­ç»ƒè®¡åˆ’
async function previewPlan(planId) {
  try {
    const response = await fetch(`/tools/api/training_plans/${planId}/`);
    const data = await response.json();
    
    if (data.success) {
      showPlanPreviewModal(data.plan);
    } else {
      alert('åŠ è½½è®¡åˆ’è¯¦æƒ…å¤±è´¥: ' + data.error);
    }
  } catch (error) {
    console.error('åŠ è½½è®¡åˆ’è¯¦æƒ…å¤±è´¥:', error);
    alert('åŠ è½½è®¡åˆ’è¯¦æƒ…å¤±è´¥ï¼Œè¯·é‡è¯•');
  }
}

// å®‰å…¨çš„å­—ç¬¦ä¸²è½¬å°å†™å‡½æ•°
function safeToLowerCase(str) {
  if (str === null || str === undefined) return '';
  try {
    return String(str).toLowerCase();
  } catch (error) {
    console.warn('toLowerCaseè½¬æ¢å¤±è´¥:', str, error);
    return '';
  }
}

// å…¨å±€æœç´¢å®‰å…¨å¤„ç†
document.addEventListener('DOMContentLoaded', function() {
  // ç›‘å¬æ‰€æœ‰å¯èƒ½çš„æœç´¢è¾“å…¥æ¡†
  document.addEventListener('input', function(e) {
    if (e.target.type === 'search' || e.target.type === 'text') {
      try {
        // ç¡®ä¿è¾“å…¥å€¼æ˜¯å®‰å…¨çš„
        if (e.target.value && typeof e.target.value !== 'string') {
          e.target.value = String(e.target.value);
        }
      } catch (error) {
        console.warn('è¾“å…¥å€¼å¤„ç†é”™è¯¯:', error);
        e.target.value = '';
      }
    }
  });
  
  // ç›‘å¬é”®ç›˜äº‹ä»¶
  document.addEventListener('keyup', function(e) {
    if (e.target.type === 'search' || e.target.type === 'text') {
      try {
        if (e.target.value && typeof e.target.value !== 'string') {
          e.target.value = String(e.target.value);
        }
      } catch (error) {
        console.warn('é”®ç›˜è¾“å…¥å¤„ç†é”™è¯¯:', error);
        e.target.value = '';
      }
    }
  });
});

// æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
function formatDateTime(dateString) {
  if (!dateString) return 'æœªçŸ¥';
  try {
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return 'æœªçŸ¥';
    return date.toLocaleDateString('zh-CN', {
      year: 'numeric',
      month: '2-digit', 
      day: '2-digit'
    }) + ' ' + date.toLocaleTimeString('zh-CN', {
      hour: '2-digit',
      minute: '2-digit'
    });
  } catch (error) {
    console.error('æ—¶é—´æ ¼å¼åŒ–é”™è¯¯:', error);
    return 'æœªçŸ¥';
  }
}

// åˆ‡æ¢åŠ¨ä½œè¯¦æƒ…æ˜¾ç¤º
function toggleExerciseDetails(element) {
  try {
    const detailsEl = element.querySelector('.exercise-details');
    if (detailsEl) {
      const isHidden = detailsEl.style.display === 'none' || detailsEl.style.display === '';
      detailsEl.style.display = isHidden ? 'block' : 'none';
      
      // åˆ‡æ¢å±•å¼€å›¾æ ‡
      const chevronIcon = element.querySelector('.fa-chevron-down');
      if (chevronIcon) {
        chevronIcon.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
      }
    } else {
      console.warn('æœªæ‰¾åˆ°.exercise-detailså…ƒç´ ï¼Œå¯èƒ½è¿™ä¸€å¤©æ²¡æœ‰è®­ç»ƒå†…å®¹');
    }
  } catch (error) {
    console.error('åˆ‡æ¢åŠ¨ä½œè¯¦æƒ…å¤±è´¥:', error);
  }
}

// æ˜¾ç¤ºè®¡åˆ’é¢„è§ˆæ¨¡æ€æ¡†
function showPlanPreviewModal(plan) {
  const modal = document.createElement('div');
  modal.className = 'checkin-modal';
  
  let scheduleHTML = '';
  if (plan.week_schedule && plan.week_schedule.length > 0) {
    scheduleHTML = plan.week_schedule.map((dayData, index) => {
      const dayName = dayData.weekday || dayData.name || `ç¬¬${index + 1}å¤©`;
      
      // è®¡ç®—åŠ¨ä½œæ•°é‡
      let exerciseCount = 0;
      if (dayData.modules) {
        exerciseCount = Object.values(dayData.modules).reduce((sum, module) => {
          return sum + (Array.isArray(module) ? module.length : 0);
        }, 0);
      } else if (dayData.exercises) {
        exerciseCount = dayData.exercises.length;
      }
      
      const bodyParts = dayData.body_parts || dayData.type || '';
      const isRestDay = exerciseCount === 0 || (Array.isArray(bodyParts) ? bodyParts.includes('ä¼‘æ¯') : bodyParts.includes('ä¼‘æ¯'));
      
      // ç”Ÿæˆè¯¦ç»†çš„åŠ¨ä½œåˆ—è¡¨
      let exerciseDetails = '';
      if (dayData.modules && exerciseCount > 0) {
        const moduleNames = {
          warmup: 'çƒ­èº«',
          main: 'ä¸»è®­ç»ƒ', 
          accessory: 'è¾…åŠ©è®­ç»ƒ',
          cooldown: 'æ‹‰ä¼¸æ”¾æ¾'
        };
        
        Object.entries(dayData.modules).forEach(([moduleKey, exercises]) => {
          if (Array.isArray(exercises) && exercises.length > 0) {
            exerciseDetails += `
              <div class="module-section" style="margin: 8px 0; padding-left: 15px;">
                <div style="font-weight: bold; color: #ff6b35; font-size: 0.85rem; margin-bottom: 4px;">
                  ${moduleNames[moduleKey] || moduleKey}
                </div>
                <div class="exercise-list">
                  ${exercises.map(ex => `
                    <div style="font-size: 0.8rem; color: #999; margin: 2px 0;">
                      â€¢ ${ex.name} ${ex.sets ? `${ex.sets}ç»„` : ''} ${ex.reps ? `Ã—${ex.reps}` : ''}
                    </div>
                  `).join('')}
                </div>
              </div>
            `;
          }
        });
      }
      
      return `
        <div class="preview-day" style="
          margin: 10px 0;
          padding: 12px;
          background: rgba(255, 255, 255, 0.05);
          border-radius: 6px;
          border-left: 4px solid ${isRestDay ? '#666' : 'var(--rage-primary, #ff6b35)'};
          cursor: pointer;
          transition: all 0.3s ease;
        " onclick="toggleExerciseDetails(this)">
          <div class="day-header" style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <strong>${dayName}</strong>
              ${bodyParts ? `<div style="color: #a8a8a8; font-size: 0.8rem; margin-top: 2px;">${Array.isArray(bodyParts) ? bodyParts.join(' + ') : bodyParts}</div>` : ''}
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="color: #a8a8a8; font-size: 0.9rem;">
                ${isRestDay ? 'ä¼‘æ¯æ—¥' : `${exerciseCount}ä¸ªåŠ¨ä½œ`}
              </span>
              ${exerciseCount > 0 ? '<i class="fas fa-chevron-down" style="color: #999; font-size: 0.8rem; transition: transform 0.3s ease;"></i>' : ''}
            </div>
          </div>
          <div class="exercise-details" style="display: none; margin-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 8px;">
            ${exerciseDetails || '<div style="text-align: center; color: #999; padding: 10px;">æš‚æ— è¯¦ç»†åŠ¨ä½œä¿¡æ¯</div>'}
          </div>
        </div>
      `;
    }).join('');
  } else {
    scheduleHTML = '<div style="text-align: center; color: #a8a8a8; padding: 20px;">æš‚æ— è®­ç»ƒå®‰æ’</div>';
  }
  
  modal.innerHTML = `
    <div class="checkin-modal-content" style="max-width: 500px;">
      <h3><i class="fas fa-eye"></i> ${plan.name}</h3>
      <div class="plan-preview-content">
        <div class="plan-meta" style="margin-bottom: 20px; padding: 10px; background: rgba(255, 255, 255, 0.05); border-radius: 6px;">
          <div><strong>è®­ç»ƒæ¨¡å¼ï¼š</strong>${plan.mode}</div>
          <div><strong>è®¡åˆ’å‘¨æœŸï¼š</strong>${plan.cycle_weeks}å‘¨</div>
          <div><strong>åˆ›å»ºæ—¶é—´ï¼š</strong>${formatDateTime(plan.created_at)}</div>
          <div><strong>æ›´æ–°æ—¶é—´ï¼š</strong>${formatDateTime(plan.updated_at)}</div>
          <div><strong>çŠ¶æ€ï¼š</strong>${plan.is_active ? 'å·²æ¿€æ´»' : 'æœªæ¿€æ´»'}</div>
        </div>
        <div class="plan-schedule">
          <h4 style="margin-bottom: 10px;">å‘¨å®‰æ’ <span style="font-size: 0.7rem; color: #999; font-weight: normal;">(ç‚¹å‡»å±•å¼€åŠ¨ä½œè¯¦æƒ…)</span></h4>
          ${scheduleHTML}
        </div>
      </div>
      <div class="form-actions" style="justify-content: center; margin-top: 20px;">
        <button class="btn-primary" onclick="applyPlan(${plan.id}, '${plan.name}')">
          <i class="fas fa-play"></i> åº”ç”¨æ­¤è®¡åˆ’
        </button>
        <button class="btn-secondary" onclick="window.location.href='/tools/fitness/plan-editor/?plan_id=${plan.id}'">
          <i class="fas fa-edit"></i> ç¼–è¾‘è®¡åˆ’
        </button>
        <button class="btn-cancel">å…³é—­</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  modal.querySelector('.btn-cancel').addEventListener('click', () => modal.remove());
  modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
}

// æ˜¾ç¤ºé€šçŸ¥æ¶ˆæ¯
function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.className = `notification notification-${type}`;
  notification.innerHTML = `
    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
    <span>${message}</span>
  `;
  
  Object.assign(notification.style, {
    position: 'fixed',
    top: '20px',
    right: '20px',
    padding: '12px 20px',
    borderRadius: '6px',
    color: 'white',
    fontSize: '14px',
    fontWeight: '500',
    zIndex: '10000',
    display: 'flex',
    alignItems: 'center',
    gap: '8px',
    minWidth: '250px',
    boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
    backgroundColor: type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3',
    animation: 'slideInRight 0.3s ease-out'
  });
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.animation = 'slideOutRight 0.3s ease-in';
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 300);
  }, 3000);
}

// æ›´å¤šå·¥å…·åŠŸèƒ½
function openFitnessTools() {
  window.location.href = '/tools/fitness/tools/';
}

// å…¨å±€å‡½æ•°ï¼šè®¡åˆ’ç®¡ç†
function openTrainingPlanEditor() {
  window.open('/tools/training_plan_editor/', '_blank');
}

function refreshPlanLibrary() {
  const calendar = window.checkInCalendar;
  if (calendar) {
    calendar.loadPlanLibrary();
    showNotification('è®¡åˆ’åº“å·²åˆ·æ–°', 'success');
  }
}

function editPlan(planId) {
  window.open(`/tools/training_plan_editor/?plan_id=${planId}`, '_blank');
}

async function previewPlanFromLibrary(planId) {
  try {
    const response = await fetch(`/tools/api/training_plans/${planId}/`);
    const data = await response.json();
    
    if (data.success) {
      showPlanPreviewModal(data.plan);
    } else {
      showNotification('é¢„è§ˆå¤±è´¥: ' + data.error, 'error');
    }
  } catch (error) {
    console.error('é¢„è§ˆè®¡åˆ’å¤±è´¥:', error);
    showNotification('é¢„è§ˆå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
  }
}

// æ˜¾ç¤ºåº”ç”¨è®¡åˆ’ç¡®è®¤å¯¹è¯æ¡†ï¼ˆå¸¦è¯¦ç»†å†…å®¹ï¼‰
async function showApplyPlanModal(planId, planName) {
  try {
    const response = await fetch(`/tools/api/training_plans/${planId}/`);
    const data = await response.json();
    
    if (!data.success) {
      showNotification('è·å–è®¡åˆ’è¯¦æƒ…å¤±è´¥: ' + data.error, 'error');
      return;
    }
    
    const plan = data.plan;
    const modal = document.createElement('div');
    modal.className = 'checkin-modal';
    
    // ç”Ÿæˆæ¯æ—¥è®­ç»ƒè¯¦æƒ…
    const weekScheduleHTML = plan.week_schedule.map((dayData, index) => {
      const dayNumber = index + 1;
      const dayName = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'][index] || `ç¬¬${dayNumber}å¤©`;
      
      let exercisesHTML = '';
      if (dayData.exercises && dayData.exercises.length > 0) {
        // æŒ‰æ¨¡å—åˆ†ç»„æ˜¾ç¤ºåŠ¨ä½œ
        const moduleGroups = {
          warmup: [],
          main: [],
          accessory: [],
          cooldown: []
        };
        
        dayData.exercises.forEach(exercise => {
          const module = exercise.module || 'main';
          if (moduleGroups[module]) {
            moduleGroups[module].push(exercise);
          } else {
            moduleGroups.main.push(exercise);
          }
        });
        
        const moduleNames = {
          warmup: 'çƒ­èº«',
          main: 'ä¸»è®­',
          accessory: 'è¾…åŠ©',
          cooldown: 'æ”¾æ¾'
        };
        
        Object.keys(moduleGroups).forEach(moduleKey => {
          const exercises = moduleGroups[moduleKey];
          if (exercises.length > 0) {
            exercisesHTML += `
              <div class="exercise-module">
                <h5>${moduleNames[moduleKey]}</h5>
                <div class="exercise-list">
                  ${exercises.map(exercise => `
                    <div class="exercise-item-detail">
                      <div class="exercise-name">${exercise.name}</div>
                      <div class="exercise-params">
                        ${exercise.sets}ç»„ Ã— ${exercise.reps}æ¬¡
                        ${exercise.weight ? ` é‡é‡@ ${exercise.weight}` : ''}
                        ${exercise.rest ? ` | ä¼‘æ¯${exercise.rest}` : ''}
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>
            `;
          }
        });
      } else {
        exercisesHTML = '<div class="rest-day-info"><i class="fas fa-bed"></i><br>ä¼‘æ¯æ—¥</div>';
      }
      
      return `
        <div class="apply-plan-day" data-day="${dayNumber}">
          <div class="day-header" onclick="toggleDayContent(${dayNumber})">
            <div class="day-info">
              <span class="day-name">${dayName}</span>
              <span class="day-type">${dayData.type || dayData.name || 'è®­ç»ƒ'}</span>
            </div>
            <div class="day-summary">
              ${dayData.exercises ? dayData.exercises.length : 0}ä¸ªåŠ¨ä½œ
              <i class="fas fa-chevron-down toggle-icon"></i>
            </div>
          </div>
          <div class="day-content" style="display: none;">
            ${exercisesHTML}
          </div>
        </div>
      `;
    }).join('');
    
    modal.innerHTML = `
      <div class="checkin-modal-content" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
        <div class="modal-header">
          <h3>åº”ç”¨è®­ç»ƒè®¡åˆ’</h3>
          <button class="modal-close" onclick="this.closest('.checkin-modal').remove()">Ã—</button>
        </div>
        
        <div class="apply-plan-info">
          <div class="plan-meta">
            <h4>${plan.name}</h4>
            <div class="plan-details">
              <span><i class="fas fa-dumbbell"></i> ${plan.mode}</span>
              <span><i class="fas fa-calendar"></i> ${plan.cycle_weeks}å‘¨</span>
              <span><i class="fas fa-list"></i> ${plan.week_schedule.length}å¤©å®‰æ’</span>
            </div>
          </div>
          
          <div class="plan-warning">
            <i class="fas fa-exclamation-triangle"></i>
            <p>åº”ç”¨æ­¤è®¡åˆ’å°†æ›¿æ¢å½“å‰çš„æ¿€æ´»è®¡åˆ’ã€‚ç‚¹å‡»ä¸‹æ–¹æ¯ä¸€å¤©å¯ä»¥æŸ¥çœ‹è¯¦ç»†è®­ç»ƒå†…å®¹ã€‚</p>
          </div>
        </div>
        
        <div class="week-schedule-preview">
          <h4>è®­ç»ƒå®‰æ’é¢„è§ˆ</h4>
          ${weekScheduleHTML}
        </div>
        
        <div class="form-actions" style="justify-content: center; margin-top: 30px; gap: 15px;">
          <button class="btn-cancel" onclick="this.closest('.checkin-modal').remove()">å–æ¶ˆ</button>
          <button class="btn-confirm" onclick="confirmApplyPlan(${planId}, '${planName}')">
            <i class="fas fa-check"></i> ç¡®è®¤åº”ç”¨
          </button>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.remove();
    });
    
  } catch (error) {
    console.error('æ˜¾ç¤ºåº”ç”¨è®¡åˆ’å¯¹è¯æ¡†å¤±è´¥:', error);
    showNotification('æ˜¾ç¤ºè®¡åˆ’è¯¦æƒ…å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
  }
}

// åˆ‡æ¢æ¯æ—¥å†…å®¹æ˜¾ç¤º
function toggleDayContent(dayNumber) {
  const dayElement = document.querySelector(`[data-day="${dayNumber}"]`);
  const content = dayElement.querySelector('.day-content');
  const icon = dayElement.querySelector('.toggle-icon');
  
  if (content.style.display === 'none') {
    content.style.display = 'block';
    icon.style.transform = 'rotate(180deg)';
  } else {
    content.style.display = 'none';
    icon.style.transform = 'rotate(0deg)';
  }
}

// ç¡®è®¤åº”ç”¨è®¡åˆ’
async function confirmApplyPlan(planId, planName) {
  try {
    const response = await fetch('/tools/api/training_plans/apply/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: JSON.stringify({ plan_id: planId })
    });
    
    const data = await response.json();
    
    if (data.success) {
      showNotification(`å·²å°†"${planName}"è®¾ä¸ºæ¿€æ´»è®¡åˆ’`, 'success');
      // å…³é—­æ¨¡æ€æ¡†
      document.querySelector('.checkin-modal').remove();
      // åˆ·æ–°è®¡åˆ’åº“å’Œæ¿€æ´»è®¡åˆ’æ˜¾ç¤º
      const calendar = window.checkInCalendar;
      if (calendar) {
        await calendar.loadPlanLibrary();
      }
      await loadActivePlan();
    } else {
      showNotification('åº”ç”¨å¤±è´¥: ' + data.error, 'error');
    }
  } catch (error) {
    console.error('åº”ç”¨è®¡åˆ’å¤±è´¥:', error);
    showNotification('åº”ç”¨å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
  }
}

async function applyPlan(planId, planName) {
  // æ˜¾ç¤ºè¯¦ç»†çš„åº”ç”¨è®¡åˆ’å¯¹è¯æ¡†
  await showApplyPlanModal(planId, planName);
}

async function deletePlan(planId, planName) {
  if (!confirm(`ç¡®å®šè¦åˆ é™¤è®­ç»ƒè®¡åˆ’"${planName}"å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) {
    return;
  }
  
  try {
    const response = await fetch(`/tools/api/training_plans/${planId}/delete/`, {
      method: 'DELETE',
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      }
    });
    
    const data = await response.json();
    
    if (data.success) {
      showNotification(`å·²åˆ é™¤è®­ç»ƒè®¡åˆ’"${planName}"`, 'success');
      // åˆ·æ–°è®¡åˆ’åº“
      const calendar = window.checkInCalendar;
      if (calendar) {
        calendar.loadPlanLibrary();
      }
    } else {
      showNotification('åˆ é™¤å¤±è´¥: ' + data.error, 'error');
    }
  } catch (error) {
    console.error('åˆ é™¤è®¡åˆ’å¤±è´¥:', error);
    showNotification('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
  }
}

// ä¿å­˜å…¨å±€å¼•ç”¨ä»¥ä¾¿å…¶ä»–å‡½æ•°è®¿é—®
window.checkInCalendar = null;

// è·å–Cookieçš„è¾…åŠ©å‡½æ•°
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

// è®­ç»ƒè®¡åˆ’å¯¼å‡ºä¸ºå›¾ç‰‡åŠŸèƒ½
async function exportPlanAsImage() {
  // ç°åœ¨åªå¯¼å‡ºä»Šæ—¥è®¡åˆ’ï¼Œä¸ä¸»é¡µé¢çš„"å¯¼å‡ºä»Šæ—¥è®¡åˆ’"åŠŸèƒ½ä¸€è‡´
  await exportTodayPlan();
}

// è·å–å½“å‰æ¿€æ´»çš„è®­ç»ƒè®¡åˆ’æ•°æ®
async function getActivePlanData() {
  try {
    // ç›´æ¥ä»APIè·å–æœ€æ–°çš„è®­ç»ƒè®¡åˆ’æ•°æ®
    const response = await fetch('/tools/api/training_plans/active/');
    const data = await response.json();
    
    if (data.success && data.has_plan && data.plan) {
      const plan = data.plan;
      const weeklyPlan = [];
      
      if (plan.week_schedule && Array.isArray(plan.week_schedule)) {
        const weekdays = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];
        
        plan.week_schedule.forEach((dayData, index) => {
          const dayName = weekdays[index] || dayData.weekday || `ç¬¬${index + 1}å¤©`;
          
          // å®‰å…¨åœ°è·å–è®­ç»ƒéƒ¨ä½
          let bodyParts = 'æœªè®¾ç½®';
          if (dayData.body_parts && Array.isArray(dayData.body_parts)) {
            bodyParts = dayData.body_parts.join(' + ');
          } else if (dayData.type) {
            bodyParts = dayData.type;
          }
          
          // è·å–è¯¦ç»†çš„åŠ¨ä½œä¿¡æ¯
          let detailedExercises = 'å¾…æ·»åŠ ';
          if (dayData.exercises && Array.isArray(dayData.exercises) && dayData.exercises.length > 0) {
            detailedExercises = dayData.exercises.map(exercise => {
              return `${exercise.name} (${exercise.sets || 3}ç»„ Ã— ${exercise.reps || '10-12'}æ¬¡${exercise.weight ? ` @ ${exercise.weight}${(exercise.weight && (exercise.weight.toString().includes('kg') || /^(è‡ªé‡|ç©ºæ†)$/.test(exercise.weight.toString()) || exercise.weight.toString().includes('æ†'))) ? '' : 'kg'}` : ''})`;
            }).join('\n');
          } else if (bodyParts.includes('ä¼‘æ¯')) {
            detailedExercises = 'ä¼‘æ¯æ—¥ï¼Œå¥½å¥½æ¢å¤ä½“åŠ›';
          }
          
          weeklyPlan.push({
            week: 1,
            day: dayName,
            bodyParts: bodyParts,
            exercises: detailedExercises,
            exerciseCount: dayData.exercises ? dayData.exercises.length : 0
          });
        });
      }
      
      return {
        name: plan.name || 'è®­ç»ƒè®¡åˆ’',
        mode: plan.mode || 'è‡ªå®šä¹‰',
        cycle_weeks: plan.cycle_weeks || 4,
        weeklyPlan: weeklyPlan
      };
    }
    
    // å¤‡ç”¨æ–¹æ¡ˆï¼šä»é¡µé¢DOMè·å–æ•°æ®
    const planElement = document.querySelector('.current-plan-preview');
    if (!planElement) return null;
    
    const planName = planElement.querySelector('h4')?.textContent || 'è®­ç»ƒè®¡åˆ’';
    const weeklyPlan = [];
    
    // ä»å½“å‰æ˜¾ç¤ºçš„è®¡åˆ’å¤©æ•°æ•°æ®ä¸­è·å–
    const planDays = document.querySelectorAll('.plan-day');
    
    if (planDays.length > 0) {
      planDays.forEach((dayElement, index) => {
        const dayName = dayElement.querySelector('span:first-child')?.textContent || `ç¬¬${index + 1}å¤©`;
        const bodyParts = dayElement.querySelector('.plan-type')?.textContent || 'æœªè®¾ç½®';
        const exercises = dayElement.querySelector('.plan-exercises')?.textContent || 'å¾…æ·»åŠ ';
        
        weeklyPlan.push({
          week: 1,
          day: dayName,
          bodyParts: bodyParts,
          exercises: exercises,
          exerciseCount: exercises.includes('ä¸ªåŠ¨ä½œ') ? parseInt(exercises) || 0 : 0
        });
      });
    } else {
      // å¦‚æœæ²¡æœ‰æ‰¾åˆ°è®¡åˆ’å¤©æ•°ï¼Œä½¿ç”¨å…¨å±€çš„activePlanæ•°æ®
      if (window.activePlan && window.activePlan.week_schedule) {
        window.activePlan.week_schedule.forEach((day, index) => {
          const safeDay = {
            weekday: day.weekday || `ç¬¬${index + 1}å¤©`,
            body_parts: Array.isArray(day.body_parts) ? day.body_parts : ['æœªè®¾ç½®'],
            modules: day.modules || {}
          };
          
          const exerciseCount = Object.values(safeDay.modules).reduce((sum, module) => sum + (Array.isArray(module) ? module.length : 0), 0);
          const exerciseText = exerciseCount > 0 ? `${exerciseCount}ä¸ªåŠ¨ä½œ` : 
            (safeDay.body_parts.includes('ä¼‘æ¯') ? 'æ¢å¤æ—¥' : 'å¾…æ·»åŠ ');
          
          weeklyPlan.push({
            week: 1,
            day: safeDay.weekday,
            bodyParts: safeDay.body_parts.join(' + '),
            exercises: exerciseText,
            detailedModules: safeDay.modules
          });
        });
      }
    }
    
    return {
      name: planName.replace('å½“å‰è®¡åˆ’ï¼š', '').trim(),
      details: planDetails,
      weeklyPlan: weeklyPlan,
      exportDate: new Date().toLocaleDateString('zh-CN')
    };
  } catch (error) {
    console.error('è·å–è®¡åˆ’æ•°æ®å¤±è´¥:', error);
    return null;
  }
}

// åˆ›å»ºå¯¼å‡ºç”¨çš„å®¹å™¨
function createExportContainer(planData) {
  const container = document.createElement('div');
  container.style.cssText = `
    position: absolute;
    top: -10000px;
    left: -10000px;
    width: 800px;
    background: white;
    padding: 40px;
    font-family: 'Microsoft YaHei', Arial, sans-serif;
    color: #333;
    box-sizing: border-box;
  `;
  
  container.innerHTML = `
    <div style="text-align: center; margin-bottom: 30px; border-bottom: 3px solid #4CAF50; padding-bottom: 20px;">
      <h1 style="color: #4CAF50; margin: 0; font-size: 28px;">${planData.name}</h1>
      <p style="color: #666; margin: 10px 0 0 0; font-size: 14px;">å¯¼å‡ºæ—¥æœŸ: ${planData.exportDate}</p>
    </div>
    
    <div style="margin-bottom: 30px;">
      <h2 style="color: #333; font-size: 20px; margin-bottom: 15px;">ğŸ“‹ è®¡åˆ’è¯¦æƒ…</h2>
      <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #4CAF50;">
        ${planData.details || 'æš‚æ— è¯¦ç»†ä¿¡æ¯'}
      </div>
    </div>
    
    <div>
      <h2 style="color: #333; font-size: 20px; margin-bottom: 20px;">ğŸ“… è®­ç»ƒå®‰æ’</h2>
      ${generateWeeklyPlanHTML(planData.weeklyPlan)}
    </div>
    
    <div style="margin-top: 40px; text-align: center; color: #999; font-size: 12px; border-top: 1px solid #eee; padding-top: 20px;">
      <p>ç”± FitMatrix å¥èº«çŸ©é˜µç”Ÿæˆ | ${new Date().toLocaleString('zh-CN')}</p>
      <p style="margin-top: 8px; color: #4CAF50; font-weight: bold;">ğŸŒ shenyiqing.xin</p>
    </div>
  `;
  
  return container;
}

// ç”Ÿæˆå‘¨è®¡åˆ’HTML
function generateWeeklyPlanHTML(weeklyPlan) {
  if (!weeklyPlan || weeklyPlan.length === 0) {
    return '<p style="color: #999; text-align: center;">æš‚æ— è®­ç»ƒå®‰æ’</p>';
  }
  
  return `
    <div style="margin-bottom: 25px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">
      <div style="background: #4CAF50; color: white; padding: 10px 15px; font-weight: bold;">
        è®­ç»ƒè®¡åˆ’è¯¦æƒ…
      </div>
      <div style="padding: 15px;">
        ${weeklyPlan.map(day => {
          // æ ¼å¼åŒ–è¯¦ç»†åŠ¨ä½œä¿¡æ¯
          const exerciseLines = day.exercises.split('\n');
          const formattedExercises = exerciseLines.length > 1 && exerciseLines[0] !== 'å¾…æ·»åŠ ' && exerciseLines[0] !== 'ä¼‘æ¯æ—¥ï¼Œå¥½å¥½æ¢å¤ä½“åŠ›'
            ? exerciseLines.map(line => `â€¢ ${line}`).join('<br>')
            : day.exercises;
          
          return `
            <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #4CAF50;">
              <div style="display: flex; align-items: center; margin-bottom: 10px;">
                <div style="font-weight: bold; color: #4CAF50; font-size: 16px; margin-right: 15px;">${day.day}</div>
                <div style="color: #666; font-size: 14px; background: white; padding: 4px 8px; border-radius: 4px;">${day.bodyParts}</div>
                ${day.exerciseCount > 0 ? `<div style="margin-left: 10px; color: #888; font-size: 12px;">${day.exerciseCount}ä¸ªåŠ¨ä½œ</div>` : ''}
              </div>
              <div style="color: #333; font-size: 13px; line-height: 1.5; margin-left: 0;">
                ${formattedExercises}
              </div>
            </div>
          `;
        }).join('')}
      </div>
    </div>
  `;
}

// åŠ¨æ€åŠ è½½html2canvasåº“
function loadHtml2Canvas() {
  return new Promise((resolve, reject) => {
    if (window.html2canvas) {
      resolve();
      return;
    }
    
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
    script.onload = () => resolve();
    script.onerror = () => reject(new Error('html2canvasåº“åŠ è½½å¤±è´¥'));
    document.head.appendChild(script);
  });
}

</script>
{% endblock %} 