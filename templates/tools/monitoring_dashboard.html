{% extends 'base.html' %}
{% load static %}

{% block title %}ç³»ç»Ÿç›‘æ§ä»ªè¡¨æ¿{% endblock %}

{% block extra_css %}
<style>
.monitoring-dashboard {
    padding: 20px;
    background: #f8f9fa;
    min-height: 100vh;
}

.dashboard-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px;
    border-radius: 15px;
    margin-bottom: 30px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

.dashboard-header h1 {
    margin: 0;
    font-size: 2.5rem;
    font-weight: 700;
}

.dashboard-header p {
    margin: 10px 0 0 0;
    opacity: 0.9;
    font-size: 1.1rem;
}

.health-score {
    display: inline-block;
    background: rgba(255,255,255,0.2);
    padding: 10px 20px;
    border-radius: 25px;
    margin-top: 15px;
    font-size: 1.2rem;
    font-weight: 600;
}

.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.metric-card {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.metric-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
}

.metric-header {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
}

.metric-icon {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    margin-right: 15px;
}

.metric-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: #2d3748;
    margin: 0;
}

.metric-value {
    font-size: 2rem;
    font-weight: 700;
    color: #4a5568;
    margin: 10px 0;
}

.metric-unit {
    font-size: 0.9rem;
    color: #718096;
    margin-left: 5px;
}

.metric-trend {
    display: flex;
    align-items: center;
    font-size: 0.9rem;
}

.trend-up {
    color: #38a169;
}

.trend-down {
    color: #e53e3e;
}

.alerts-section {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    margin-bottom: 30px;
}

.alerts-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.alerts-title {
    font-size: 1.3rem;
    font-weight: 600;
    color: #2d3748;
    margin: 0;
}

.alert-item {
    display: flex;
    align-items: center;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 10px;
    border-left: 4px solid;
}

.alert-critical {
    background: #fed7d7;
    border-left-color: #e53e3e;
}

.alert-warning {
    background: #fef5e7;
    border-left-color: #d69e2e;
}

.alert-info {
    background: #e6fffa;
    border-left-color: #38b2ac;
}

.alert-icon {
    font-size: 1.2rem;
    margin-right: 15px;
}

.alert-content {
    flex: 1;
}

.alert-message {
    font-weight: 500;
    margin-bottom: 5px;
}

.alert-time {
    font-size: 0.8rem;
    color: #718096;
}

.actions-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 30px;
}

.action-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 15px 25px;
    border-radius: 10px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.action-btn.secondary {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.action-btn.success {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.chart-container {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    margin-bottom: 30px;
}

.chart-title {
    font-size: 1.3rem;
    font-weight: 600;
    color: #2d3748;
    margin-bottom: 20px;
}

.loading {
    text-align: center;
    padding: 40px;
    color: #718096;
}

.error {
    background: #fed7d7;
    color: #e53e3e;
    padding: 15px;
    border-radius: 10px;
    margin: 20px 0;
}

.refresh-btn {
    background: rgba(255,255,255,0.2);
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 20px;
    cursor: pointer;
    transition: background 0.3s ease;
}

.refresh-btn:hover {
    background: rgba(255,255,255,0.3);
}

@media (max-width: 768px) {
    .metrics-grid {
        grid-template-columns: 1fr;
    }
    
    .dashboard-header h1 {
        font-size: 2rem;
    }
    
    .metric-value {
        font-size: 1.5rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="monitoring-dashboard">
    <div class="dashboard-header">
        <h1>ğŸ–¥ï¸ ç³»ç»Ÿç›‘æ§ä»ªè¡¨æ¿</h1>
        <p>å®æ—¶ç›‘æ§ç³»ç»Ÿæ€§èƒ½ã€èµ„æºä½¿ç”¨å’Œå‘Šè­¦ä¿¡æ¯</p>
        <div class="health-score">
            å¥åº·è¯„åˆ†: <span id="health-score">--</span>
        </div>
        <button class="refresh-btn" onclick="refreshData()">
            ğŸ”„ åˆ·æ–°æ•°æ®
        </button>
    </div>

    <!-- ç³»ç»ŸæŒ‡æ ‡ -->
    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-header">
                <div class="metric-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    ğŸ–¥ï¸
                </div>
                <h3 class="metric-title">CPUä½¿ç”¨ç‡</h3>
            </div>
            <div class="metric-value">
                <span id="cpu-percent">--</span><span class="metric-unit">%</span>
            </div>
            <div class="metric-trend">
                <span id="cpu-trend">--</span>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-header">
                <div class="metric-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                    ğŸ’¾
                </div>
                <h3 class="metric-title">å†…å­˜ä½¿ç”¨ç‡</h3>
            </div>
            <div class="metric-value">
                <span id="memory-percent">--</span><span class="metric-unit">%</span>
            </div>
            <div class="metric-trend">
                <span id="memory-trend">--</span>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-header">
                <div class="metric-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
                    ğŸ’¿
                </div>
                <h3 class="metric-title">ç£ç›˜ä½¿ç”¨ç‡</h3>
            </div>
            <div class="metric-value">
                <span id="disk-percent">--</span><span class="metric-unit">%</span>
            </div>
            <div class="metric-trend">
                <span id="disk-trend">--</span>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-header">
                <div class="metric-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white;">
                    ğŸš€
                </div>
                <h3 class="metric-title">å“åº”æ—¶é—´</h3>
            </div>
            <div class="metric-value">
                <span id="response-time">--</span><span class="metric-unit">ms</span>
            </div>
            <div class="metric-trend">
                <span id="response-trend">--</span>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-header">
                <div class="metric-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white;">
                    ğŸ‘¥
                </div>
                <h3 class="metric-title">æ´»è·ƒç”¨æˆ·</h3>
            </div>
            <div class="metric-value">
                <span id="active-users">--</span>
            </div>
            <div class="metric-trend">
                <span id="users-trend">--</span>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-header">
                <div class="metric-icon" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: white;">
                    ğŸ’¬
                </div>
                <h3 class="metric-title">ä»Šæ—¥æ¶ˆæ¯</h3>
            </div>
            <div class="metric-value">
                <span id="messages-today">--</span>
            </div>
            <div class="metric-trend">
                <span id="messages-trend">--</span>
            </div>
        </div>
    </div>

    <!-- å‘Šè­¦ä¿¡æ¯ -->
    <div class="alerts-section">
        <div class="alerts-header">
            <h3 class="alerts-title">ğŸš¨ å‘Šè­¦ä¿¡æ¯</h3>
            <span id="alerts-count">0 ä¸ªå‘Šè­¦</span>
        </div>
        <div id="alerts-container">
            <div class="loading">åŠ è½½å‘Šè­¦ä¿¡æ¯...</div>
        </div>
    </div>

    <!-- æ“ä½œæŒ‰é’® -->
    <div class="actions-section">
        <button class="action-btn" onclick="clearCache()">
            ğŸ§¹ æ¸…é™¤ç¼“å­˜
        </button>
        <button class="action-btn secondary" onclick="warmUpCache()">
            ğŸ”¥ é¢„çƒ­ç¼“å­˜
        </button>
        <button class="action-btn success" onclick="exportData()">
            ğŸ“Š å¯¼å‡ºæ•°æ®
        </button>
    </div>

    <!-- æ€§èƒ½å›¾è¡¨ -->
    <div class="chart-container">
        <h3 class="chart-title">ğŸ“ˆ æ€§èƒ½è¶‹åŠ¿</h3>
        <div id="performance-chart">
            <div class="loading">åŠ è½½æ€§èƒ½å›¾è¡¨...</div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let refreshInterval;

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
    // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°
    refreshInterval = setInterval(loadDashboardData, 30000);
});

// åŠ è½½ä»ªè¡¨æ¿æ•°æ®
async function loadDashboardData() {
    try {
        const response = await fetch('/tools/monitoring/data/');
        const data = await response.json();
        
        if (data.success) {
            updateDashboard(data.data);
        } else {
            showError('åŠ è½½æ•°æ®å¤±è´¥: ' + data.error);
        }
    } catch (error) {
        showError('ç½‘ç»œé”™è¯¯: ' + error.message);
    }
}

// æ›´æ–°ä»ªè¡¨æ¿
function updateDashboard(data) {
    const metrics = data.metrics;
    
    // æ›´æ–°ç³»ç»ŸæŒ‡æ ‡
    if (metrics.system) {
        document.getElementById('cpu-percent').textContent = 
            Math.round(metrics.system.cpu?.percent || 0);
        document.getElementById('memory-percent').textContent = 
            Math.round(metrics.system.memory?.percent || 0);
        document.getElementById('disk-percent').textContent = 
            Math.round(metrics.system.disk?.percent || 0);
    }
    
    // æ›´æ–°åº”ç”¨æŒ‡æ ‡
    if (metrics.application) {
        document.getElementById('active-users').textContent = 
            metrics.application.active_users_today || 0;
        document.getElementById('messages-today').textContent = 
            metrics.application.messages_today || 0;
    }
    
    // æ›´æ–°æ€§èƒ½æŒ‡æ ‡
    if (metrics.performance) {
        const avgResponseTime = Object.values(metrics.performance)
            .reduce((sum, endpoint) => sum + (endpoint.avg_time || 0), 0) / 
            Math.max(Object.keys(metrics.performance).length, 1);
        document.getElementById('response-time').textContent = 
            Math.round(avgResponseTime * 1000);
    }
    
    // æ›´æ–°å¥åº·è¯„åˆ†
    document.getElementById('health-score').textContent = 
        Math.round(data.health_score || 0);
    
    // æ›´æ–°å‘Šè­¦ä¿¡æ¯
    updateAlerts(data.alerts);
}

// æ›´æ–°å‘Šè­¦ä¿¡æ¯
function updateAlerts(alerts) {
    const container = document.getElementById('alerts-container');
    const countElement = document.getElementById('alerts-count');
    
    countElement.textContent = `${alerts.length} ä¸ªå‘Šè­¦`;
    
    if (alerts.length === 0) {
        container.innerHTML = '<div class="alert-item alert-info">âœ… ç³»ç»Ÿè¿è¡Œæ­£å¸¸ï¼Œæš‚æ— å‘Šè­¦</div>';
        return;
    }
    
    container.innerHTML = alerts.map(alert => `
        <div class="alert-item alert-${alert.level}">
            <div class="alert-icon">
                ${alert.level === 'critical' ? 'ğŸš¨' : alert.level === 'warning' ? 'âš ï¸' : 'â„¹ï¸'}
            </div>
            <div class="alert-content">
                <div class="alert-message">${alert.message}</div>
                <div class="alert-time">${new Date(alert.timestamp).toLocaleString()}</div>
            </div>
        </div>
    `).join('');
}

// åˆ·æ–°æ•°æ®
function refreshData() {
    loadDashboardData();
}

// æ¸…é™¤ç¼“å­˜
async function clearCache() {
    if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ç¼“å­˜å—ï¼Ÿ')) return;
    
    try {
        const response = await fetch('/tools/monitoring/clear-cache/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        const data = await response.json();
        
        if (data.success) {
            alert('ç¼“å­˜æ¸…é™¤æˆåŠŸï¼');
            loadDashboardData();
        } else {
            alert('ç¼“å­˜æ¸…é™¤å¤±è´¥: ' + data.error);
        }
    } catch (error) {
        alert('æ“ä½œå¤±è´¥: ' + error.message);
    }
}

// é¢„çƒ­ç¼“å­˜
async function warmUpCache() {
    try {
        const response = await fetch('/tools/monitoring/warm-cache/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        const data = await response.json();
        
        if (data.success) {
            alert('ç¼“å­˜é¢„çƒ­æˆåŠŸï¼');
            loadDashboardData();
        } else {
            alert('ç¼“å­˜é¢„çƒ­å¤±è´¥: ' + data.error);
        }
    } catch (error) {
        alert('æ“ä½œå¤±è´¥: ' + error.message);
    }
}

// å¯¼å‡ºæ•°æ®
function exportData() {
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    const filename = `monitoring-data-${timestamp}.json`;
    
    fetch('/tools/monitoring/data/')
        .then(response => response.json())
        .then(data => {
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        })
        .catch(error => {
            alert('å¯¼å‡ºå¤±è´¥: ' + error.message);
        });
}

// æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
function showError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error';
    errorDiv.textContent = message;
    document.querySelector('.monitoring-dashboard').insertBefore(
        errorDiv, 
        document.querySelector('.metrics-grid')
    );
    
    setTimeout(() => {
        errorDiv.remove();
    }, 5000);
}

// è·å–CSRF Token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// é¡µé¢å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
window.addEventListener('beforeunload', function() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
});
</script>
{% endblock %}
