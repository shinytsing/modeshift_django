{% extends 'base.html' %}
{% load static %}

{% block title %}系统监控仪表板{% endblock %}

{% block extra_css %}
<style>
.monitoring-dashboard {
    padding: 20px;
    background: #f8f9fa;
    min-height: 100vh;
}

.dashboard-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px;
    border-radius: 15px;
    margin-bottom: 30px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

.dashboard-header h1 {
    margin: 0;
    font-size: 2.5rem;
    font-weight: 700;
}

.dashboard-header p {
    margin: 10px 0 0 0;
    opacity: 0.9;
    font-size: 1.1rem;
}

.health-score {
    display: inline-block;
    background: rgba(255,255,255,0.2);
    padding: 10px 20px;
    border-radius: 25px;
    margin-top: 15px;
    font-size: 1.2rem;
    font-weight: 600;
}

.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.metric-card {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.metric-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
}

.metric-header {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
}

.metric-icon {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    margin-right: 15px;
}

.metric-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: #2d3748;
    margin: 0;
}

.metric-value {
    font-size: 2rem;
    font-weight: 700;
    color: #4a5568;
    margin: 10px 0;
}

.metric-unit {
    font-size: 0.9rem;
    color: #718096;
    margin-left: 5px;
}

.metric-trend {
    display: flex;
    align-items: center;
    font-size: 0.9rem;
}

.trend-up {
    color: #38a169;
}

.trend-down {
    color: #e53e3e;
}

.alerts-section {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    margin-bottom: 30px;
}

.alerts-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.alerts-title {
    font-size: 1.3rem;
    font-weight: 600;
    color: #2d3748;
    margin: 0;
}

.alert-item {
    display: flex;
    align-items: center;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 10px;
    border-left: 4px solid;
}

.alert-critical {
    background: #fed7d7;
    border-left-color: #e53e3e;
}

.alert-warning {
    background: #fef5e7;
    border-left-color: #d69e2e;
}

.alert-info {
    background: #e6fffa;
    border-left-color: #38b2ac;
}

.alert-icon {
    font-size: 1.2rem;
    margin-right: 15px;
}

.alert-content {
    flex: 1;
}

.alert-message {
    font-weight: 500;
    margin-bottom: 5px;
}

.alert-time {
    font-size: 0.8rem;
    color: #718096;
}

.actions-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 30px;
}

.action-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 15px 25px;
    border-radius: 10px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.action-btn.secondary {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.action-btn.success {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.chart-container {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    margin-bottom: 30px;
}

.chart-title {
    font-size: 1.3rem;
    font-weight: 600;
    color: #2d3748;
    margin-bottom: 20px;
}

.loading {
    text-align: center;
    padding: 40px;
    color: #718096;
}

.error {
    background: #fed7d7;
    color: #e53e3e;
    padding: 15px;
    border-radius: 10px;
    margin: 20px 0;
}

.refresh-btn {
    background: rgba(255,255,255,0.2);
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 20px;
    cursor: pointer;
    transition: background 0.3s ease;
}

.refresh-btn:hover {
    background: rgba(255,255,255,0.3);
}

@media (max-width: 768px) {
    .metrics-grid {
        grid-template-columns: 1fr;
    }
    
    .dashboard-header h1 {
        font-size: 2rem;
    }
    
    .metric-value {
        font-size: 1.5rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="monitoring-dashboard">
    <div class="dashboard-header">
        <h1>🖥️ 系统监控仪表板</h1>
        <p>实时监控系统性能、资源使用和告警信息</p>
        <div class="health-score">
            健康评分: <span id="health-score">--</span>
        </div>
        <button class="refresh-btn" onclick="refreshData()">
            🔄 刷新数据
        </button>
    </div>

    <!-- 系统指标 -->
    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-header">
                <div class="metric-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    🖥️
                </div>
                <h3 class="metric-title">CPU使用率</h3>
            </div>
            <div class="metric-value">
                <span id="cpu-percent">--</span><span class="metric-unit">%</span>
            </div>
            <div class="metric-trend">
                <span id="cpu-trend">--</span>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-header">
                <div class="metric-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                    💾
                </div>
                <h3 class="metric-title">内存使用率</h3>
            </div>
            <div class="metric-value">
                <span id="memory-percent">--</span><span class="metric-unit">%</span>
            </div>
            <div class="metric-trend">
                <span id="memory-trend">--</span>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-header">
                <div class="metric-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
                    💿
                </div>
                <h3 class="metric-title">磁盘使用率</h3>
            </div>
            <div class="metric-value">
                <span id="disk-percent">--</span><span class="metric-unit">%</span>
            </div>
            <div class="metric-trend">
                <span id="disk-trend">--</span>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-header">
                <div class="metric-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white;">
                    🚀
                </div>
                <h3 class="metric-title">响应时间</h3>
            </div>
            <div class="metric-value">
                <span id="response-time">--</span><span class="metric-unit">ms</span>
            </div>
            <div class="metric-trend">
                <span id="response-trend">--</span>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-header">
                <div class="metric-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white;">
                    👥
                </div>
                <h3 class="metric-title">活跃用户</h3>
            </div>
            <div class="metric-value">
                <span id="active-users">--</span>
            </div>
            <div class="metric-trend">
                <span id="users-trend">--</span>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-header">
                <div class="metric-icon" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: white;">
                    💬
                </div>
                <h3 class="metric-title">今日消息</h3>
            </div>
            <div class="metric-value">
                <span id="messages-today">--</span>
            </div>
            <div class="metric-trend">
                <span id="messages-trend">--</span>
            </div>
        </div>
    </div>

    <!-- 告警信息 -->
    <div class="alerts-section">
        <div class="alerts-header">
            <h3 class="alerts-title">🚨 告警信息</h3>
            <span id="alerts-count">0 个告警</span>
        </div>
        <div id="alerts-container">
            <div class="loading">加载告警信息...</div>
        </div>
    </div>

    <!-- 操作按钮 -->
    <div class="actions-section">
        <button class="action-btn" onclick="clearCache()">
            🧹 清除缓存
        </button>
        <button class="action-btn secondary" onclick="warmUpCache()">
            🔥 预热缓存
        </button>
        <button class="action-btn success" onclick="exportData()">
            📊 导出数据
        </button>
    </div>

    <!-- 性能图表 -->
    <div class="chart-container">
        <h3 class="chart-title">📈 性能趋势</h3>
        <div id="performance-chart">
            <div class="loading">加载性能图表...</div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let refreshInterval;

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
    // 每30秒自动刷新
    refreshInterval = setInterval(loadDashboardData, 30000);
});

// 加载仪表板数据
async function loadDashboardData() {
    try {
        const response = await fetch('/tools/monitoring/data/');
        const data = await response.json();
        
        if (data.success) {
            updateDashboard(data.data);
        } else {
            showError('加载数据失败: ' + data.error);
        }
    } catch (error) {
        showError('网络错误: ' + error.message);
    }
}

// 更新仪表板
function updateDashboard(data) {
    const metrics = data.metrics;
    
    // 更新系统指标
    if (metrics.system) {
        document.getElementById('cpu-percent').textContent = 
            Math.round(metrics.system.cpu?.percent || 0);
        document.getElementById('memory-percent').textContent = 
            Math.round(metrics.system.memory?.percent || 0);
        document.getElementById('disk-percent').textContent = 
            Math.round(metrics.system.disk?.percent || 0);
    }
    
    // 更新应用指标
    if (metrics.application) {
        document.getElementById('active-users').textContent = 
            metrics.application.active_users_today || 0;
        document.getElementById('messages-today').textContent = 
            metrics.application.messages_today || 0;
    }
    
    // 更新性能指标
    if (metrics.performance) {
        const avgResponseTime = Object.values(metrics.performance)
            .reduce((sum, endpoint) => sum + (endpoint.avg_time || 0), 0) / 
            Math.max(Object.keys(metrics.performance).length, 1);
        document.getElementById('response-time').textContent = 
            Math.round(avgResponseTime * 1000);
    }
    
    // 更新健康评分
    document.getElementById('health-score').textContent = 
        Math.round(data.health_score || 0);
    
    // 更新告警信息
    updateAlerts(data.alerts);
}

// 更新告警信息
function updateAlerts(alerts) {
    const container = document.getElementById('alerts-container');
    const countElement = document.getElementById('alerts-count');
    
    countElement.textContent = `${alerts.length} 个告警`;
    
    if (alerts.length === 0) {
        container.innerHTML = '<div class="alert-item alert-info">✅ 系统运行正常，暂无告警</div>';
        return;
    }
    
    container.innerHTML = alerts.map(alert => `
        <div class="alert-item alert-${alert.level}">
            <div class="alert-icon">
                ${alert.level === 'critical' ? '🚨' : alert.level === 'warning' ? '⚠️' : 'ℹ️'}
            </div>
            <div class="alert-content">
                <div class="alert-message">${alert.message}</div>
                <div class="alert-time">${new Date(alert.timestamp).toLocaleString()}</div>
            </div>
        </div>
    `).join('');
}

// 刷新数据
function refreshData() {
    loadDashboardData();
}

// 清除缓存
async function clearCache() {
    if (!confirm('确定要清除所有缓存吗？')) return;
    
    try {
        const response = await fetch('/tools/monitoring/clear-cache/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        const data = await response.json();
        
        if (data.success) {
            alert('缓存清除成功！');
            loadDashboardData();
        } else {
            alert('缓存清除失败: ' + data.error);
        }
    } catch (error) {
        alert('操作失败: ' + error.message);
    }
}

// 预热缓存
async function warmUpCache() {
    try {
        const response = await fetch('/tools/monitoring/warm-cache/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        const data = await response.json();
        
        if (data.success) {
            alert('缓存预热成功！');
            loadDashboardData();
        } else {
            alert('缓存预热失败: ' + data.error);
        }
    } catch (error) {
        alert('操作失败: ' + error.message);
    }
}

// 导出数据
function exportData() {
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    const filename = `monitoring-data-${timestamp}.json`;
    
    fetch('/tools/monitoring/data/')
        .then(response => response.json())
        .then(data => {
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        })
        .catch(error => {
            alert('导出失败: ' + error.message);
        });
}

// 显示错误信息
function showError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error';
    errorDiv.textContent = message;
    document.querySelector('.monitoring-dashboard').insertBefore(
        errorDiv, 
        document.querySelector('.metrics-grid')
    );
    
    setTimeout(() => {
        errorDiv.remove();
    }, 5000);
}

// 获取CSRF Token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// 页面卸载时清理定时器
window.addEventListener('beforeunload', function() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
});
</script>
{% endblock %}
