{% extends 'base.html' %}
{% load static %}

{% block title %}å‰ä»–ç»ƒä¹ è¿›åº¦è·Ÿè¸ª{% endblock %}

{% block extra_css %}
<style>
    .progress-tracking {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
    }
    
    .progress-header {
        text-align: center;
        color: white;
        margin-bottom: 30px;
    }
    
    .progress-header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    .progress-header p {
        font-size: 1.2rem;
        opacity: 0.9;
    }
    
    .stats-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        text-align: center;
        transition: transform 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
    }
    
    .stat-icon {
        font-size: 2.5rem;
        margin-bottom: 10px;
        display: block;
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: #667eea;
        margin-bottom: 5px;
    }
    
    .stat-label {
        color: #666;
        font-size: 0.9rem;
    }
    
    .chart-section {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        margin-bottom: 30px;
    }
    
    .chart-header {
        text-align: center;
        margin-bottom: 20px;
    }
    
    .chart-header h2 {
        color: #333;
        margin-bottom: 10px;
    }
    
    .chart-container {
        position: relative;
        height: 300px;
        margin: 20px 0;
    }
    
    .chart-tabs {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    
    .chart-tab {
        padding: 8px 16px;
        border: none;
        border-radius: 20px;
        background: #f8f9fa;
        color: #666;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .chart-tab.active {
        background: #667eea;
        color: white;
    }
    
    .chart-tab:hover {
        background: #5a6fd8;
        color: white;
    }
    
    .achievements-section {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        margin-bottom: 30px;
    }
    
    .achievements-header {
        text-align: center;
        margin-bottom: 20px;
    }
    
    .achievements-header h2 {
        color: #333;
        margin-bottom: 10px;
    }
    
    .achievements-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
    }
    
    .achievement-card {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }
    
    .achievement-card.earned {
        border-color: #4CAF50;
        background: #e8f5e8;
    }
    
    .achievement-card:hover {
        transform: scale(1.05);
    }
    
    .achievement-icon {
        font-size: 3rem;
        margin-bottom: 15px;
        display: block;
    }
    
    .achievement-title {
        font-size: 1.1rem;
        font-weight: bold;
        color: #333;
        margin-bottom: 8px;
    }
    
    .achievement-description {
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 10px;
    }
    
    .achievement-progress {
        background: #e9ecef;
        border-radius: 10px;
        height: 8px;
        margin-bottom: 10px;
        overflow: hidden;
    }
    
    .achievement-progress-fill {
        height: 100%;
        background: linear-gradient(45deg, #4CAF50, #45a049);
        transition: width 0.3s ease;
    }
    
    .achievement-points {
        color: #667eea;
        font-weight: bold;
        font-size: 0.9rem;
    }
    
    .practice-history {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        margin-bottom: 30px;
    }
    
    .history-header {
        text-align: center;
        margin-bottom: 20px;
    }
    
    .history-header h2 {
        color: #333;
        margin-bottom: 10px;
    }
    
    .history-filters {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    
    .filter-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 20px;
        background: #f8f9fa;
        color: #666;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .filter-btn.active {
        background: #667eea;
        color: white;
    }
    
    .history-list {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .history-item {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 10px;
        border-left: 4px solid #667eea;
        transition: all 0.3s ease;
    }
    
    .history-item:hover {
        background: #e9ecef;
        transform: translateX(5px);
    }
    
    .history-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }
    
    .history-item-title {
        font-weight: bold;
        color: #333;
    }
    
    .history-item-date {
        color: #666;
        font-size: 0.9rem;
    }
    
    .history-item-details {
        display: flex;
        gap: 15px;
        font-size: 0.9rem;
        color: #666;
    }
    
    .history-item-notes {
        margin-top: 10px;
        padding: 10px;
        background: #e3f2fd;
        border-radius: 5px;
        font-size: 0.9rem;
        color: #1976D2;
    }
    
    .navigation-buttons {
        display: flex;
        justify-content: center;
        gap: 15px;
        flex-wrap: wrap;
    }
    
    .nav-btn {
        background: rgba(255, 255, 255, 0.9);
        color: #333;
        border: none;
        padding: 12px 24px;
        border-radius: 25px;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .nav-btn:hover {
        background: white;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        text-decoration: none;
        color: #333;
    }
    
    .empty-state {
        text-align: center;
        padding: 40px;
        color: #666;
    }
    
    .empty-state-icon {
        font-size: 4rem;
        margin-bottom: 20px;
        opacity: 0.5;
    }
    
    @media (max-width: 768px) {
        .stats-overview {
            grid-template-columns: 1fr;
        }
        
        .achievements-grid {
            grid-template-columns: 1fr;
        }
        
        .history-filters {
            flex-direction: column;
            align-items: center;
        }
        
        .history-item-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
        }
        
        .history-item-details {
            flex-direction: column;
            gap: 5px;
        }
        
        .progress-header h1 {
            font-size: 2rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="progress-tracking">
    <div class="progress-header">
        <h1>ğŸ“Š å‰ä»–ç»ƒä¹ è¿›åº¦è·Ÿè¸ª</h1>
        <p>æŸ¥çœ‹ä½ çš„å­¦ä¹ è¿›åº¦å’Œæˆå°±</p>
    </div>

    <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
    <div class="stats-overview">
        <div class="stat-card">
            <span class="stat-icon">â±ï¸</span>
            <div class="stat-value">{{ user_stats.total_practice_time }}</div>
            <div class="stat-label">æ€»ç»ƒä¹ æ—¶é—´ï¼ˆå°æ—¶ï¼‰</div>
        </div>
        <div class="stat-card">
            <span class="stat-icon">ğŸ¯</span>
            <div class="stat-value">{{ user_stats.total_sessions }}</div>
            <div class="stat-label">ç»ƒä¹ æ¬¡æ•°</div>
        </div>
        <div class="stat-card">
            <span class="stat-icon">ğŸ”¥</span>
            <div class="stat-value">{{ user_stats.current_streak }}</div>
            <div class="stat-label">è¿ç»­ç»ƒä¹ å¤©æ•°</div>
        </div>
        <div class="stat-card">
            <span class="stat-icon">ğŸ“ˆ</span>
            <div class="stat-value">{{ user_stats.accuracy_avg }}%</div>
            <div class="stat-label">å¹³å‡å‡†ç¡®ç‡</div>
        </div>
        <div class="stat-card">
            <span class="stat-icon">ğŸ†</span>
            <div class="stat-value">{{ user_stats.points }}</div>
            <div class="stat-label">è·å¾—ç§¯åˆ†</div>
        </div>
        <div class="stat-card">
            <span class="stat-icon">ğŸ’</span>
            <div class="stat-value">{{ user_stats.longest_streak }}</div>
            <div class="stat-label">æœ€é•¿è¿ç»­å¤©æ•°</div>
        </div>
    </div>

    <!-- å›¾è¡¨åŒºåŸŸ -->
    <div class="chart-section">
        <div class="chart-header">
            <h2>ğŸ“ˆ ç»ƒä¹ è¶‹åŠ¿</h2>
        </div>
        
        <div class="chart-tabs">
            <button class="chart-tab active" onclick="switchChart('weekly')">å‘¨è¶‹åŠ¿</button>
            <button class="chart-tab" onclick="switchChart('monthly')">æœˆè¶‹åŠ¿</button>
            <button class="chart-tab" onclick="switchChart('accuracy')">å‡†ç¡®ç‡</button>
            <button class="chart-tab" onclick="switchChart('distribution')">ç»ƒä¹ åˆ†å¸ƒ</button>
        </div>
        
        <div class="chart-container">
            <canvas id="progressChart"></canvas>
        </div>
    </div>

    <!-- æˆå°±ç³»ç»Ÿ -->
    <div class="achievements-section">
        <div class="achievements-header">
            <h2>ğŸ† æˆå°±ç³»ç»Ÿ</h2>
        </div>
        
        <div class="achievements-grid">
            {% for achievement in achievements %}
            <div class="achievement-card {% if achievement.earned %}earned{% endif %}">
                <span class="achievement-icon">{{ achievement.icon }}</span>
                <div class="achievement-title">{{ achievement.name }}</div>
                <div class="achievement-description">{{ achievement.description }}</div>
                {% if not achievement.earned %}
                <div class="achievement-progress">
                    <div class="achievement-progress-fill" style="width: {{ achievement.progress }}%"></div>
                </div>
                <div class="achievement-progress-text">{{ achievement.progress }}% å®Œæˆ</div>
                {% endif %}
                <div class="achievement-points">+{{ achievement.points }} ç§¯åˆ†</div>
            </div>
            {% empty %}
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ†</div>
                <p>è¿˜æ²¡æœ‰è·å¾—æˆå°±ï¼Œç»§ç»­ç»ƒä¹ å§ï¼</p>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- ç»ƒä¹ å†å² -->
    <div class="practice-history">
        <div class="history-header">
            <h2>ğŸ“ ç»ƒä¹ å†å²</h2>
        </div>
        
        <div class="history-filters">
            <button class="filter-btn active" onclick="filterHistory('all')">å…¨éƒ¨</button>
            <button class="filter-btn" onclick="filterHistory('chord_progression')">å’Œå¼¦è¿›è¡Œ</button>
            <button class="filter-btn" onclick="filterHistory('fingerpicking')">æŒ‡å¼¹æŠ€å·§</button>
            <button class="filter-btn" onclick="filterHistory('scale_practice')">éŸ³é˜¶ç»ƒä¹ </button>
            <button class="filter-btn" onclick="filterHistory('song_learning')">æ­Œæ›²å­¦ä¹ </button>
            <button class="filter-btn" onclick="filterHistory('theory_study')">ä¹ç†å­¦ä¹ </button>
        </div>
        
        <div class="history-list" id="historyList">
            {% for practice in practice_history %}
            <div class="history-item" data-type="{{ practice.practice_type }}">
                <div class="history-item-header">
                    <div class="history-item-title">{{ practice.exercise_name }}</div>
                    <div class="history-item-date">{{ practice.completed_at|date:"Y-m-d H:i" }}</div>
                </div>
                <div class="history-item-details">
                    <span>æ—¶é•¿: {{ practice.duration }} åˆ†é’Ÿ</span>
                    <span>å‡†ç¡®ç‡: {{ practice.accuracy }}%</span>
                    <span>éš¾åº¦: {{ practice.difficulty }}</span>
                </div>
                {% if practice.notes %}
                <div class="history-item-notes">{{ practice.notes }}</div>
                {% endif %}
            </div>
            {% empty %}
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ“</div>
                <p>è¿˜æ²¡æœ‰ç»ƒä¹ è®°å½•ï¼Œå¼€å§‹ä½ çš„ç¬¬ä¸€æ¬¡ç»ƒä¹ å§ï¼</p>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- å¯¼èˆªæŒ‰é’® -->
    <div class="navigation-buttons">
        <a href="{% url 'tools:guitar_training_dashboard' %}" class="nav-btn">ğŸ  è¿”å›ä¸»é¡µ</a>
<a href="{% url 'tools:guitar_theory_guide' %}" class="nav-btn">ğŸ“š ä¹ç†å­¦ä¹ </a>
<a href="{% url 'tools:guitar_song_library' %}" class="nav-btn">ğŸµ æ­Œæ›²åº“</a>
        <a href="#" class="nav-btn" onclick="exportProgress()">ğŸ“Š å¯¼å‡ºæ•°æ®</a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let currentChart = null;
let currentChartType = 'weekly';

// å›¾è¡¨æ•°æ®
const chartData = {
    weekly: {
        labels: ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'],
        datasets: [{
            label: 'ç»ƒä¹ æ—¶é—´ï¼ˆå°æ—¶ï¼‰',
            data: {{ progress_data.weekly_practice_time|safe }},
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            tension: 0.4
        }]
    },
    monthly: {
        labels: ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'],
        datasets: [{
            label: 'ç»ƒä¹ æ—¶é—´ï¼ˆå°æ—¶ï¼‰',
            data: {{ progress_data.monthly_practice_time|safe }},
            borderColor: '#764ba2',
            backgroundColor: 'rgba(118, 75, 162, 0.1)',
            tension: 0.4
        }]
    },
    accuracy: {
        labels: ['ç¬¬1å‘¨', 'ç¬¬2å‘¨', 'ç¬¬3å‘¨', 'ç¬¬4å‘¨', 'ç¬¬5å‘¨', 'ç¬¬6å‘¨', 'ç¬¬7å‘¨'],
        datasets: [{
            label: 'å‡†ç¡®ç‡ï¼ˆ%ï¼‰',
            data: {{ progress_data.accuracy_trend|safe }},
            borderColor: '#4CAF50',
            backgroundColor: 'rgba(76, 175, 80, 0.1)',
            tension: 0.4
        }]
    },
    distribution: {
        labels: ['å’Œå¼¦è¿›è¡Œ', 'æŒ‡å¼¹æŠ€å·§', 'éŸ³é˜¶ç»ƒä¹ ', 'æ­Œæ›²å­¦ä¹ ', 'ä¹ç†å­¦ä¹ '],
        datasets: [{
            label: 'ç»ƒä¹ åˆ†å¸ƒï¼ˆ%ï¼‰',
            data: [
                {{ progress_data.practice_types_distribution.chord_progression }},
                {{ progress_data.practice_types_distribution.fingerpicking }},
                {{ progress_data.practice_types_distribution.scale_practice }},
                {{ progress_data.practice_types_distribution.song_learning }},
                {{ progress_data.practice_types_distribution.theory_study }}
            ],
            backgroundColor: [
                '#667eea',
                '#764ba2',
                '#4CAF50',
                '#FF9800',
                '#F44336'
            ]
        }]
    }
};

// åˆå§‹åŒ–å›¾è¡¨
document.addEventListener('DOMContentLoaded', function() {
    initChart('weekly');
});

function initChart(type) {
    const ctx = document.getElementById('progressChart').getContext('2d');
    
    if (currentChart) {
        currentChart.destroy();
    }
    
    const config = {
        type: type === 'distribution' ? 'doughnut' : 'line',
        data: chartData[type],
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                },
                title: {
                    display: true,
                    text: getChartTitle(type)
                }
            },
            scales: type !== 'distribution' ? {
                y: {
                    beginAtZero: true
                }
            } : {}
        }
    };
    
    currentChart = new Chart(ctx, config);
    currentChartType = type;
}

function switchChart(type) {
    // æ›´æ–°æ ‡ç­¾çŠ¶æ€
    document.querySelectorAll('.chart-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // åˆ‡æ¢å›¾è¡¨
    initChart(type);
}

function getChartTitle(type) {
    const titles = {
        weekly: 'æœ¬å‘¨ç»ƒä¹ æ—¶é—´è¶‹åŠ¿',
        monthly: 'æœ¬æœˆç»ƒä¹ æ—¶é—´è¶‹åŠ¿',
        accuracy: 'å‡†ç¡®ç‡å˜åŒ–è¶‹åŠ¿',
        distribution: 'ç»ƒä¹ ç±»å‹åˆ†å¸ƒ'
    };
    return titles[type] || '';
}

function filterHistory(type) {
    // æ›´æ–°è¿‡æ»¤å™¨çŠ¶æ€
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // è¿‡æ»¤å†å²è®°å½•
    const historyItems = document.querySelectorAll('.history-item');
    historyItems.forEach(item => {
        if (type === 'all' || item.dataset.type === type) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

function exportProgress() {
    // å¯¼å‡ºè¿›åº¦æ•°æ®
    const data = {
        user_stats: {{ user_stats|safe }},
        progress_data: {{ progress_data|safe }},
        achievements: {{ achievements|safe }},
        practice_history: {{ practice_history|safe }}
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'guitar_progress_' + new Date().toISOString().split('T')[0] + '.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// æ·»åŠ ä¸€äº›åŠ¨ç”»æ•ˆæœ
document.addEventListener('DOMContentLoaded', function() {
    const cards = document.querySelectorAll('.stat-card, .achievement-card, .history-item');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        setTimeout(() => {
            card.style.transition = 'all 0.6s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });
});
</script>
{% endblock %}
