{% extends 'base.html' %}
{% load static %}

{% block title %}吉他练习进度跟踪{% endblock %}

{% block extra_css %}
<style>
    .progress-tracking {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
    }
    
    .progress-header {
        text-align: center;
        color: white;
        margin-bottom: 30px;
    }
    
    .progress-header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    .progress-header p {
        font-size: 1.2rem;
        opacity: 0.9;
    }
    
    .stats-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        text-align: center;
        transition: transform 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
    }
    
    .stat-icon {
        font-size: 2.5rem;
        margin-bottom: 10px;
        display: block;
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: #667eea;
        margin-bottom: 5px;
    }
    
    .stat-label {
        color: #666;
        font-size: 0.9rem;
    }
    
    .chart-section {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        margin-bottom: 30px;
    }
    
    .chart-header {
        text-align: center;
        margin-bottom: 20px;
    }
    
    .chart-header h2 {
        color: #333;
        margin-bottom: 10px;
    }
    
    .chart-container {
        position: relative;
        height: 300px;
        margin: 20px 0;
    }
    
    .chart-tabs {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    
    .chart-tab {
        padding: 8px 16px;
        border: none;
        border-radius: 20px;
        background: #f8f9fa;
        color: #666;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .chart-tab.active {
        background: #667eea;
        color: white;
    }
    
    .chart-tab:hover {
        background: #5a6fd8;
        color: white;
    }
    
    .achievements-section {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        margin-bottom: 30px;
    }
    
    .achievements-header {
        text-align: center;
        margin-bottom: 20px;
    }
    
    .achievements-header h2 {
        color: #333;
        margin-bottom: 10px;
    }
    
    .achievements-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
    }
    
    .achievement-card {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }
    
    .achievement-card.earned {
        border-color: #4CAF50;
        background: #e8f5e8;
    }
    
    .achievement-card:hover {
        transform: scale(1.05);
    }
    
    .achievement-icon {
        font-size: 3rem;
        margin-bottom: 15px;
        display: block;
    }
    
    .achievement-title {
        font-size: 1.1rem;
        font-weight: bold;
        color: #333;
        margin-bottom: 8px;
    }
    
    .achievement-description {
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 10px;
    }
    
    .achievement-progress {
        background: #e9ecef;
        border-radius: 10px;
        height: 8px;
        margin-bottom: 10px;
        overflow: hidden;
    }
    
    .achievement-progress-fill {
        height: 100%;
        background: linear-gradient(45deg, #4CAF50, #45a049);
        transition: width 0.3s ease;
    }
    
    .achievement-points {
        color: #667eea;
        font-weight: bold;
        font-size: 0.9rem;
    }
    
    .practice-history {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        margin-bottom: 30px;
    }
    
    .history-header {
        text-align: center;
        margin-bottom: 20px;
    }
    
    .history-header h2 {
        color: #333;
        margin-bottom: 10px;
    }
    
    .history-filters {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    
    .filter-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 20px;
        background: #f8f9fa;
        color: #666;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .filter-btn.active {
        background: #667eea;
        color: white;
    }
    
    .history-list {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .history-item {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 10px;
        border-left: 4px solid #667eea;
        transition: all 0.3s ease;
    }
    
    .history-item:hover {
        background: #e9ecef;
        transform: translateX(5px);
    }
    
    .history-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }
    
    .history-item-title {
        font-weight: bold;
        color: #333;
    }
    
    .history-item-date {
        color: #666;
        font-size: 0.9rem;
    }
    
    .history-item-details {
        display: flex;
        gap: 15px;
        font-size: 0.9rem;
        color: #666;
    }
    
    .history-item-notes {
        margin-top: 10px;
        padding: 10px;
        background: #e3f2fd;
        border-radius: 5px;
        font-size: 0.9rem;
        color: #1976D2;
    }
    
    .navigation-buttons {
        display: flex;
        justify-content: center;
        gap: 15px;
        flex-wrap: wrap;
    }
    
    .nav-btn {
        background: rgba(255, 255, 255, 0.9);
        color: #333;
        border: none;
        padding: 12px 24px;
        border-radius: 25px;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .nav-btn:hover {
        background: white;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        text-decoration: none;
        color: #333;
    }
    
    .empty-state {
        text-align: center;
        padding: 40px;
        color: #666;
    }
    
    .empty-state-icon {
        font-size: 4rem;
        margin-bottom: 20px;
        opacity: 0.5;
    }
    
    @media (max-width: 768px) {
        .stats-overview {
            grid-template-columns: 1fr;
        }
        
        .achievements-grid {
            grid-template-columns: 1fr;
        }
        
        .history-filters {
            flex-direction: column;
            align-items: center;
        }
        
        .history-item-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
        }
        
        .history-item-details {
            flex-direction: column;
            gap: 5px;
        }
        
        .progress-header h1 {
            font-size: 2rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="progress-tracking">
    <div class="progress-header">
        <h1>📊 吉他练习进度跟踪</h1>
        <p>查看你的学习进度和成就</p>
    </div>

    <!-- 统计概览 -->
    <div class="stats-overview">
        <div class="stat-card">
            <span class="stat-icon">⏱️</span>
            <div class="stat-value">{{ user_stats.total_practice_time }}</div>
            <div class="stat-label">总练习时间（小时）</div>
        </div>
        <div class="stat-card">
            <span class="stat-icon">🎯</span>
            <div class="stat-value">{{ user_stats.total_sessions }}</div>
            <div class="stat-label">练习次数</div>
        </div>
        <div class="stat-card">
            <span class="stat-icon">🔥</span>
            <div class="stat-value">{{ user_stats.current_streak }}</div>
            <div class="stat-label">连续练习天数</div>
        </div>
        <div class="stat-card">
            <span class="stat-icon">📈</span>
            <div class="stat-value">{{ user_stats.accuracy_avg }}%</div>
            <div class="stat-label">平均准确率</div>
        </div>
        <div class="stat-card">
            <span class="stat-icon">🏆</span>
            <div class="stat-value">{{ user_stats.points }}</div>
            <div class="stat-label">获得积分</div>
        </div>
        <div class="stat-card">
            <span class="stat-icon">💎</span>
            <div class="stat-value">{{ user_stats.longest_streak }}</div>
            <div class="stat-label">最长连续天数</div>
        </div>
    </div>

    <!-- 图表区域 -->
    <div class="chart-section">
        <div class="chart-header">
            <h2>📈 练习趋势</h2>
        </div>
        
        <div class="chart-tabs">
            <button class="chart-tab active" onclick="switchChart('weekly')">周趋势</button>
            <button class="chart-tab" onclick="switchChart('monthly')">月趋势</button>
            <button class="chart-tab" onclick="switchChart('accuracy')">准确率</button>
            <button class="chart-tab" onclick="switchChart('distribution')">练习分布</button>
        </div>
        
        <div class="chart-container">
            <canvas id="progressChart"></canvas>
        </div>
    </div>

    <!-- 成就系统 -->
    <div class="achievements-section">
        <div class="achievements-header">
            <h2>🏆 成就系统</h2>
        </div>
        
        <div class="achievements-grid">
            {% for achievement in achievements %}
            <div class="achievement-card {% if achievement.earned %}earned{% endif %}">
                <span class="achievement-icon">{{ achievement.icon }}</span>
                <div class="achievement-title">{{ achievement.name }}</div>
                <div class="achievement-description">{{ achievement.description }}</div>
                {% if not achievement.earned %}
                <div class="achievement-progress">
                    <div class="achievement-progress-fill" style="width: {{ achievement.progress }}%"></div>
                </div>
                <div class="achievement-progress-text">{{ achievement.progress }}% 完成</div>
                {% endif %}
                <div class="achievement-points">+{{ achievement.points }} 积分</div>
            </div>
            {% empty %}
            <div class="empty-state">
                <div class="empty-state-icon">🏆</div>
                <p>还没有获得成就，继续练习吧！</p>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- 练习历史 -->
    <div class="practice-history">
        <div class="history-header">
            <h2>📝 练习历史</h2>
        </div>
        
        <div class="history-filters">
            <button class="filter-btn active" onclick="filterHistory('all')">全部</button>
            <button class="filter-btn" onclick="filterHistory('chord_progression')">和弦进行</button>
            <button class="filter-btn" onclick="filterHistory('fingerpicking')">指弹技巧</button>
            <button class="filter-btn" onclick="filterHistory('scale_practice')">音阶练习</button>
            <button class="filter-btn" onclick="filterHistory('song_learning')">歌曲学习</button>
            <button class="filter-btn" onclick="filterHistory('theory_study')">乐理学习</button>
        </div>
        
        <div class="history-list" id="historyList">
            {% for practice in practice_history %}
            <div class="history-item" data-type="{{ practice.practice_type }}">
                <div class="history-item-header">
                    <div class="history-item-title">{{ practice.exercise_name }}</div>
                    <div class="history-item-date">{{ practice.completed_at|date:"Y-m-d H:i" }}</div>
                </div>
                <div class="history-item-details">
                    <span>时长: {{ practice.duration }} 分钟</span>
                    <span>准确率: {{ practice.accuracy }}%</span>
                    <span>难度: {{ practice.difficulty }}</span>
                </div>
                {% if practice.notes %}
                <div class="history-item-notes">{{ practice.notes }}</div>
                {% endif %}
            </div>
            {% empty %}
            <div class="empty-state">
                <div class="empty-state-icon">📝</div>
                <p>还没有练习记录，开始你的第一次练习吧！</p>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- 导航按钮 -->
    <div class="navigation-buttons">
        <a href="{% url 'tools:guitar_training_dashboard' %}" class="nav-btn">🏠 返回主页</a>
<a href="{% url 'tools:guitar_theory_guide' %}" class="nav-btn">📚 乐理学习</a>
<a href="{% url 'tools:guitar_song_library' %}" class="nav-btn">🎵 歌曲库</a>
        <a href="#" class="nav-btn" onclick="exportProgress()">📊 导出数据</a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let currentChart = null;
let currentChartType = 'weekly';

// 图表数据
const chartData = {
    weekly: {
        labels: ['周一', '周二', '周三', '周四', '周五', '周六', '周日'],
        datasets: [{
            label: '练习时间（小时）',
            data: {{ progress_data.weekly_practice_time|safe }},
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            tension: 0.4
        }]
    },
    monthly: {
        labels: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
        datasets: [{
            label: '练习时间（小时）',
            data: {{ progress_data.monthly_practice_time|safe }},
            borderColor: '#764ba2',
            backgroundColor: 'rgba(118, 75, 162, 0.1)',
            tension: 0.4
        }]
    },
    accuracy: {
        labels: ['第1周', '第2周', '第3周', '第4周', '第5周', '第6周', '第7周'],
        datasets: [{
            label: '准确率（%）',
            data: {{ progress_data.accuracy_trend|safe }},
            borderColor: '#4CAF50',
            backgroundColor: 'rgba(76, 175, 80, 0.1)',
            tension: 0.4
        }]
    },
    distribution: {
        labels: ['和弦进行', '指弹技巧', '音阶练习', '歌曲学习', '乐理学习'],
        datasets: [{
            label: '练习分布（%）',
            data: [
                {{ progress_data.practice_types_distribution.chord_progression }},
                {{ progress_data.practice_types_distribution.fingerpicking }},
                {{ progress_data.practice_types_distribution.scale_practice }},
                {{ progress_data.practice_types_distribution.song_learning }},
                {{ progress_data.practice_types_distribution.theory_study }}
            ],
            backgroundColor: [
                '#667eea',
                '#764ba2',
                '#4CAF50',
                '#FF9800',
                '#F44336'
            ]
        }]
    }
};

// 初始化图表
document.addEventListener('DOMContentLoaded', function() {
    initChart('weekly');
});

function initChart(type) {
    const ctx = document.getElementById('progressChart').getContext('2d');
    
    if (currentChart) {
        currentChart.destroy();
    }
    
    const config = {
        type: type === 'distribution' ? 'doughnut' : 'line',
        data: chartData[type],
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                },
                title: {
                    display: true,
                    text: getChartTitle(type)
                }
            },
            scales: type !== 'distribution' ? {
                y: {
                    beginAtZero: true
                }
            } : {}
        }
    };
    
    currentChart = new Chart(ctx, config);
    currentChartType = type;
}

function switchChart(type) {
    // 更新标签状态
    document.querySelectorAll('.chart-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // 切换图表
    initChart(type);
}

function getChartTitle(type) {
    const titles = {
        weekly: '本周练习时间趋势',
        monthly: '本月练习时间趋势',
        accuracy: '准确率变化趋势',
        distribution: '练习类型分布'
    };
    return titles[type] || '';
}

function filterHistory(type) {
    // 更新过滤器状态
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // 过滤历史记录
    const historyItems = document.querySelectorAll('.history-item');
    historyItems.forEach(item => {
        if (type === 'all' || item.dataset.type === type) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

function exportProgress() {
    // 导出进度数据
    const data = {
        user_stats: {{ user_stats|safe }},
        progress_data: {{ progress_data|safe }},
        achievements: {{ achievements|safe }},
        practice_history: {{ practice_history|safe }}
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'guitar_progress_' + new Date().toISOString().split('T')[0] + '.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// 添加一些动画效果
document.addEventListener('DOMContentLoaded', function() {
    const cards = document.querySelectorAll('.stat-card, .achievement-card, .history-item');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        setTimeout(() => {
            card.style.transition = 'all 0.6s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });
});
</script>
{% endblock %}
