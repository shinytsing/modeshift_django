{% extends 'base.html' %}
{% load static %}

{% block title %}{{ item.title }} - èˆ¹å®{% endblock %}

{% block extra_css %}
<style>
/* èˆ¹å®è¯¦æƒ…é¡µé¢æ ·å¼ */
.shipbao-detail-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #f5576c 75%, #4facfe 100%);
    min-height: 100vh;
    position: relative;
    overflow: hidden;
}

/* åŠ¨æ€èƒŒæ™¯æ•ˆæœ */
.shipbao-detail-container::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: 
        radial-gradient(circle at 20% 80%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(255, 255, 255, 0.05) 0%, transparent 50%);
    z-index: -1;
    animation: shipbaoPulse 8s ease-in-out infinite;
}

@keyframes shipbaoPulse {
    0%, 100% { 
        transform: scale(1) rotate(0deg);
        opacity: 0.8;
    }
    50% { 
        transform: scale(1.1) rotate(1deg);
        opacity: 1;
    }
}

.back-btn {
    background: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: white;
    padding: 10px 20px;
    border-radius: 25px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
    margin-bottom: 20px;
}

.back-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
}

.item-detail-card {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 25px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    position: relative;
    animation: cardSlideIn 0.6s ease-out;
}

@keyframes cardSlideIn {
    from {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.item-images {
    position: relative;
    height: 400px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    overflow: hidden;
}

.main-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.image-nav {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 10px;
}

.image-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.5);
    cursor: pointer;
    transition: all 0.3s ease;
}

.image-dot.active {
    background: white;
    transform: scale(1.2);
}

.item-info {
    padding: 30px;
}

.item-header {
    margin-bottom: 20px;
}

.item-title {
    font-size: 28px;
    font-weight: 700;
    color: #2c3e50;
    margin-bottom: 10px;
    line-height: 1.3;
}

.item-price {
    font-size: 32px;
    font-weight: bold;
    color: #e74c3c;
    margin-bottom: 15px;
    text-shadow: 0 2px 4px rgba(231, 76, 60, 0.2);
}

.item-meta {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #7f8c8d;
    font-size: 14px;
}

.item-description {
    color: #2c3e50;
    line-height: 1.6;
    margin-bottom: 25px;
    font-size: 16px;
}

.item-tags {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 25px;
}

.item-tag {
    background: linear-gradient(135deg, #ecf0f1, #bdc3c7);
    color: #2c3e50;
    padding: 6px 12px;
    border-radius: 15px;
    font-size: 12px;
    font-weight: 500;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.seller-info {
    background: rgba(52, 152, 219, 0.1);
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 25px;
    border: 1px solid rgba(52, 152, 219, 0.2);
}

.seller-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
}

.seller-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: linear-gradient(135deg, #3498db, #2980b9);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 20px;
    font-weight: bold;
}

.seller-details h4 {
    color: #2c3e50;
    margin-bottom: 5px;
    font-size: 18px;
}

.seller-details p {
    color: #7f8c8d;
    font-size: 14px;
    margin: 0;
}

.action-buttons {
    display: flex;
    gap: 15px;
    margin-bottom: 25px;
}

.want-btn {
    background: linear-gradient(135deg, #27ae60, #2ecc71);
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.want-btn:hover {
    background: linear-gradient(135deg, #229954, #27ae60);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
}

.want-btn.wanted {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
}

.want-btn.wanted:hover {
    background: linear-gradient(135deg, #c0392b, #a93226);
}

.btn {
    flex: 1;
    padding: 15px 25px;
    border: none;
    border-radius: 25px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
    text-decoration: none;
    display: inline-block;
}

.btn-primary {
    background: linear-gradient(135deg, #27ae60, #229954);
    color: white;
    box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
}

.btn-primary:hover {
    background: linear-gradient(135deg, #229954, #1e8449);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
}

.btn-secondary {
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
    box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
}

.btn-secondary:hover {
    background: linear-gradient(135deg, #2980b9, #1f5f8b);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
}

.btn-outline {
    background: transparent;
    color: #3498db;
    border: 2px solid #3498db;
}

.btn-outline:hover {
    background: #3498db;
    color: white;
    transform: translateY(-2px);
}

.location-section {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 25px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.location-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
}

.location-icon {
    color: #3498db;
    font-size: 20px;
}

.location-title {
    color: #2c3e50;
    font-size: 18px;
    font-weight: 600;
}

.location-info {
    color: #7f8c8d;
    margin-bottom: 15px;
}

.map-picker-btn {
    background: linear-gradient(135deg, #f39c12, #e67e22);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
}

.map-picker-btn:hover {
    background: linear-gradient(135deg, #e67e22, #d35400);
    transform: translateY(-2px);
}

/* åœ°å›¾é€‰æ‹©å™¨æ¨¡æ€æ¡† */
.map-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 10000;
    backdrop-filter: blur(5px);
}

/* æ¶ˆæ¯æç¤ºæ ·å¼ */
.message-toast {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 20px;
    border-radius: 8px;
    color: white;
    font-weight: 500;
    z-index: 10001;
    transform: translateX(100%);
    transition: transform 0.3s ease;
    max-width: 300px;
    word-wrap: break-word;
}

.message-toast.show {
    transform: translateX(0);
}

.message-success {
    background: linear-gradient(135deg, #27ae60, #2ecc71);
    box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
}

.message-error {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
}

.message-info {
    background: linear-gradient(135deg, #3498db, #2980b9);
    box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
}

/* ä½ç½®å»ºè®®æ ·å¼å¢å¼º */
.location-suggestion {
    padding: 12px 16px;
    border-bottom: 1px solid #ecf0f1;
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.location-suggestion:hover {
    background-color: #f8f9fa;
}

.suggestion-name {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 4px;
}

.suggestion-address {
    font-size: 12px;
    color: #7f8c8d;
}

.loading-suggestion {
    padding: 20px;
    text-align: center;
    color: #7f8c8d;
}

.no-suggestions {
    padding: 20px;
    text-align: center;
    color: #7f8c8d;
    font-style: italic;
}

/* æ”¶è—æŒ‰é’®çŠ¶æ€ */
.btn-outline.favorited {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    color: white;
    border-color: #e74c3c;
}

.map-modal.show {
    display: flex;
    align-items: center;
    justify-content: center;
}

.map-content {
    background: white;
    border-radius: 20px;
    padding: 30px;
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    position: relative;
}

.map-close {
    position: absolute;
    top: 15px;
    right: 20px;
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #7f8c8d;
}

.map-close:hover {
    color: #e74c3c;
}

.map-title {
    font-size: 24px;
    font-weight: 700;
    color: #2c3e50;
    margin-bottom: 20px;
    text-align: center;
}

.location-search {
    margin-bottom: 20px;
}

.location-search input {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #ecf0f1;
    border-radius: 12px;
    font-size: 16px;
    transition: all 0.3s ease;
}

.location-search input:focus {
    outline: none;
    border-color: #3498db;
    box-shadow: 0 0 10px rgba(52, 152, 219, 0.3);
}

.location-suggestions {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #ecf0f1;
    border-radius: 8px;
    margin-bottom: 20px;
}

.location-suggestion {
    padding: 12px 16px;
    cursor: pointer;
    border-bottom: 1px solid #ecf0f1;
    transition: background 0.3s ease;
}

.location-suggestion:hover {
    background: #f8f9fa;
}

.location-suggestion:last-child {
    border-bottom: none;
}

.map-container {
    width: 100%;
    height: 300px;
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 20px;
    background: #ecf0f1;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #7f8c8d;
}

.map-confirm-btn {
    background: linear-gradient(135deg, #27ae60, #229954);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    width: 100%;
    transition: all 0.3s ease;
}

.map-confirm-btn:hover {
    background: linear-gradient(135deg, #229954, #1e8449);
    transform: translateY(-2px);
}

/* æƒ³è¦æ­¤å•†å“çš„ç”¨æˆ·æ ·å¼ */
.want-count-section {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 25px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.want-count-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
    color: #2c3e50;
    font-size: 18px;
    font-weight: 600;
}

.interested-users h4 {
    color: #2c3e50;
    margin-bottom: 15px;
    font-size: 16px;
}

.interested-user-item {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 12px;
    margin-bottom: 15px;
    border: 1px solid rgba(52, 152, 219, 0.2);
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.user-info {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 15px;
    background: rgba(52, 152, 219, 0.1);
    border-bottom: 1px solid rgba(52, 152, 219, 0.2);
}

.user-name {
    font-weight: 600;
    color: #2c3e50;
    font-size: 16px;
}

.user-time {
    color: #34495e;
    font-size: 12px;
    font-weight: 500;
}

.user-want-message {
    padding: 10px 15px;
    background: rgba(255, 255, 255, 0.9);
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    color: #2c3e50;
    font-size: 14px;
    font-weight: 500;
}

.user-want-message strong {
    color: #2980b9;
    font-weight: 700;
    margin-right: 8px;
}

.transaction-messages {
    padding: 15px;
    background: rgba(255, 255, 255, 0.95);
}

.transaction-messages strong {
    color: #c0392b;
    font-size: 15px;
    font-weight: 700;
    margin-bottom: 10px;
    display: block;
}

.messages-list {
    max-height: 200px;
    overflow-y: auto;
}

.message-item {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
    border-left: 4px solid #3498db;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.message-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.message-sender {
    font-weight: 700;
    color: #2c3e50;
    font-size: 14px;
}

.message-time {
    color: #34495e;
    font-size: 12px;
    font-weight: 500;
}

.message-content {
    color: #2c3e50;
    font-size: 15px;
    line-height: 1.5;
    font-weight: 500;
}

.offer-price {
    display: inline-block;
    background: linear-gradient(135deg, #f39c12, #e67e22);
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    margin-right: 8px;
}

.message-text {
    color: #2c3e50;
    font-weight: 500;
}

.user-actions {
    padding: 10px 15px;
    background: rgba(255, 255, 255, 0.8);
    border-top: 1px solid rgba(0, 0, 0, 0.05);
    text-align: right;
}

.btn-chat {
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 15px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.3s ease;
}

.btn-chat:hover {
    background: linear-gradient(135deg, #2980b9, #1f5f8b);
    transform: translateY(-1px);
}

/* èŠå¤©é€šçŸ¥æ ·å¼ */
.chat-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    color: white;
    padding: 15px 20px;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
    z-index: 10002;
    cursor: pointer;
    transform: translateX(100%);
    transition: transform 0.3s ease;
    max-width: 300px;
}

.chat-notification.show {
    transform: translateX(0);
}

.chat-notification-content {
    display: flex;
    align-items: center;
    gap: 10px;
}

.chat-notification-icon {
    font-size: 20px;
}

.chat-notification-text {
    flex: 1;
}

.chat-notification-title {
    font-weight: 600;
    margin-bottom: 2px;
}

.chat-notification-message {
    font-size: 12px;
    opacity: 0.9;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .item-detail-card {
        margin: 10px;
    }
    
    .item-images {
        height: 300px;
    }
    
    .item-info {
        padding: 20px;
    }
    
    .item-title {
        font-size: 24px;
    }
    
    .item-price {
        font-size: 28px;
    }
    
    .action-buttons {
        flex-direction: column;
    }
    
    .map-content {
        margin: 20px;
        padding: 20px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="shipbao-detail-container">
    <button class="back-btn" onclick="history.back()">â† è¿”å›</button>
    
    <div class="item-detail-card">
        <!-- è°ƒè¯•ä¿¡æ¯ - å·²éšè— -->
        <!-- <div style="background: #f8f9fa; padding: 10px; margin: 10px; border-radius: 5px; font-size: 12px;">
            <strong>è°ƒè¯•ä¿¡æ¯ï¼š</strong><br>
            å•†å“ID: {{ item.id }}<br>
            æ”¶è—çŠ¶æ€: {{ is_favorited }}<br>
            æƒ³è¦äººæ•°: {{ want_count }}<br>
            æ˜¯å¦å–å®¶: {{ is_seller }}<br>
            ç”¨æˆ·: {{ user.username }}
        </div> -->
        
        <!-- å•†å“å›¾ç‰‡ -->
        <div class="item-images">
            <img src="{% if item.get_main_image %}{{ item.get_main_image }}{% else %}/static/img/default-item.jpg{% endif %}" alt="{{ item.title }}" class="main-image" id="main-image">
            <div class="image-nav" id="image-nav">
                <!-- å›¾ç‰‡å¯¼èˆªç‚¹å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
            </div>
        </div>
        
        <!-- å•†å“ä¿¡æ¯ -->
        <div class="item-info">
            <div class="item-header">
                <h1 class="item-title">{{ item.title }}</h1>
                <div class="item-price">Â¥{{ item.price }}</div>
                <div class="item-meta">
                    <div class="meta-item">
                        <i class="fas fa-star"></i>
                        <span>{{ item.condition_stars }}</span>
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-map-marker-alt"></i>
                        <span id="item-distance">{{ item.distance|default:"è·ç¦»æœªçŸ¥" }}</span>
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-clock"></i>
                        <span>{{ item.created_at|date:"Y-m-d H:i" }}</span>
                    </div>
                </div>
            </div>
            
            <div class="item-description">
                {{ item.description|linebreaks }}
            </div>
            
            <div class="item-tags">
                {% if item.category_display %}
                    <span class="item-tag">{{ item.category_display }}</span>
                {% endif %}
                {% if item.can_bargain %}
                    <span class="item-tag">ğŸ’¬ å¯è®®ä»·</span>
                {% endif %}
                <span class="item-tag">
                    {% if item.delivery_option == 'pickup' %}
                        ğŸ“¦ è‡ªæ
                    {% elif item.delivery_option == 'delivery' %}
                        ğŸšš é€è´§
                    {% else %}
                        ğŸ“¦ğŸšš è‡ªæ/é€è´§
                    {% endif %}
                </span>
            </div>
            
            <!-- å–å®¶ä¿¡æ¯ -->
            <div class="seller-info">
                <div class="seller-header">
                    <div class="seller-avatar">
                        {{ item.seller.username|first|upper }}
                    </div>
                    <div class="seller-details">
                        <h4>{{ item.seller.username }}</h4>
                        <p>æ³¨å†Œæ—¶é—´ï¼š{{ item.seller.date_joined|date:"Y-m-d" }}</p>
                    </div>
                </div>
            </div>
            
            <!-- ä½ç½®ä¿¡æ¯ -->
            <div class="location-section">
                <div class="location-header">
                    <i class="fas fa-map-marker-alt location-icon"></i>
                    <h3 class="location-title">ä½ç½®ä¿¡æ¯</h3>
                </div>
                <div class="location-info">
                    <p id="current-location">æ­£åœ¨è·å–ä½ç½®ä¿¡æ¯...</p>
                </div>
                
                <!-- ä½ç½®æ“ä½œæŒ‰é’® -->
                <div class="location-actions">
                    <button class="location-btn auto-locate-btn" onclick="autoLocateUser()">
                        <i class="fas fa-crosshairs"></i> è‡ªåŠ¨å®šä½
                    </button>
                    <button class="location-btn map-picker-btn" onclick="openMapPicker()">
                        <i class="fas fa-map"></i> é€‰æ‹©åœ°å€
                    </button>
                </div>
                
                <!-- ä½ç½®è¾“å…¥å®¹å™¨ -->
                <div class="location-input-container" id="location-input-container" style="display: none;">
                    <div class="input-group">
                        <input type="text" 
                               id="location-search-input" 
                               class="location-search-input" 
                               placeholder="è¾“å…¥åŸå¸‚æˆ–åœ°å€è¿›è¡Œæœç´¢..."
                               oninput="searchLocationSuggestions(this.value)">
                        <button class="input-group-btn" onclick="searchCurrentInput()">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    
                    <!-- æœç´¢å»ºè®®åˆ—è¡¨ -->
                    <div class="location-suggestions-list" id="location-suggestions-list">
                        <!-- æœç´¢å»ºè®®å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                    </div>
                    
                    <!-- æ“ä½œæŒ‰é’® -->
                    <div class="location-input-actions">
                        <button class="btn-confirm" onclick="confirmManualLocation()">
                            <i class="fas fa-check"></i> ç¡®è®¤
                        </button>
                        <button class="btn-cancel" onclick="cancelLocationInput()">
                            <i class="fas fa-times"></i> å–æ¶ˆ
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- æƒ³è¦æ­¤å•†å“çš„äººæ•° -->
            {% if want_count > 0 %}
            <div class="want-count-section">
                <div class="want-count-header">
                    <i class="fas fa-users"></i>
                    <span>{{ want_count }} äººæƒ³è¦æ­¤å•†å“</span>
                </div>
                {% if is_seller and interested_users %}
                <div class="interested-users">
                    <h4>æƒ³è¦æ­¤å•†å“çš„ç”¨æˆ·ï¼š</h4>
                    {% for user in interested_users %}
                    <div class="interested-user-item">
                        <div class="user-info">
                            <span class="user-name">{{ user.username }}</span>
                            <span class="user-time">{{ user.created_at|slice:":16" }}</span>
                        </div>
                        
                        <!-- æƒ³è¦ç•™è¨€ -->
                        {% if user.message %}
                        <div class="user-want-message">
                            <strong>æƒ³è¦ç•™è¨€ï¼š</strong>{{ user.message }}
                        </div>
                        {% endif %}
                        
                        <!-- äº¤æ˜“æ¶ˆæ¯ -->
                        {% if user.transaction_messages %}
                        <div class="transaction-messages">
                            <strong>äº¤æ˜“æ¶ˆæ¯ï¼š</strong>
                            <div class="messages-list">
                                {% for msg in user.transaction_messages %}
                                <div class="message-item">
                                    <div class="message-header">
                                        <span class="message-sender">{{ msg.sender }}</span>
                                        <span class="message-time">{{ msg.created_at|slice:":16" }}</span>
                                    </div>
                                    <div class="message-content">
                                        {% if msg.message_type == 'offer' and msg.offer_price %}
                                            <span class="offer-price">ğŸ’° æŠ¥ä»·ï¼šÂ¥{{ msg.offer_price }}</span>
                                        {% endif %}
                                        <span class="message-text">{{ msg.content }}</span>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="user-actions">
                            <button class="btn-chat" onclick="chatWithUser('{{ user.user_id }}', '{{ item.id }}')">
                                <i class="fas fa-comments"></i> è”ç³»
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endif %}
            
            <!-- æ“ä½œæŒ‰é’® -->
            <div class="action-buttons">
                {% if not is_seller %}
                    <button class="btn btn-primary" onclick="contactSeller()">
                        <i class="fas fa-comments"></i> è”ç³»å–å®¶
                    </button>
                    <button class="btn btn-secondary transaction-btn" onclick="makeOffer()">
                        <i class="fas fa-handshake"></i> å‘èµ·äº¤æ˜“
                    </button>
                    <button class="btn btn-success want-btn" onclick="toggleWantItem()">
                        <i class="fas fa-heart"></i> æƒ³è¦æ­¤å•†å“
                    </button>
                    {% if not is_seller %}
                    <button class="btn btn-outline favorite-btn {% if is_favorited %}favorited{% endif %}" onclick="toggleFavorite()">
                        <i class="fas fa-star"></i> {% if is_favorited %}å·²æ”¶è—{% else %}æ”¶è—{% endif %}
                    </button>
                    {% endif %}
                {% else %}
                    <!-- å‘å¸ƒè€…æ“ä½œæŒ‰é’® -->
                    <button class="btn btn-secondary" onclick="editProduct()">
                        <i class="fas fa-edit"></i> ç¼–è¾‘å•†å“
                    </button>
                    <button class="btn btn-outline" onclick="toggleProductStatus()">
                        <i class="fas fa-archive"></i> ä¸‹æ¶å•†å“
                    </button>
                    <button class="btn btn-primary" onclick="markAsSold()">
                        <i class="fas fa-check-circle"></i> æ ‡è®°ä¸ºå·²å”®
                    </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- åœ°å›¾é€‰æ‹©å™¨æ¨¡æ€æ¡† -->
<div class="map-modal" id="mapModal">
    <div class="map-content">
        <button class="map-close" onclick="closeMapPicker()">&times;</button>
        <h2 class="map-title">é€‰æ‹©åœ°å€</h2>
        
        <div class="location-search">
            <input type="text" id="locationSearch" placeholder="æœç´¢åœ°å€æˆ–åŸå¸‚..." oninput="searchLocation(this.value)">
        </div>
        
        <div class="location-suggestions" id="locationSuggestions">
            <!-- åœ°å€å»ºè®®å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
        </div>
        
        <div class="map-container" id="mapContainer">
            <div>
                <i class="fas fa-map" style="font-size: 48px; margin-bottom: 10px;"></i>
                <p>åœ°å›¾åŠ è½½ä¸­...</p>
            </div>
        </div>
        
        <button class="map-confirm-btn" onclick="confirmLocation()">
            ç¡®è®¤é€‰æ‹©æ­¤åœ°å€
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// å…¨å±€å˜é‡
const ITEM_ID = {% if item.id %}{{ item.id }}{% else %}null{% endif %};
let currentLocation = null;
let selectedLocation = null;
let selectedLocationData = null;
let userLocation = null;

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    getLocationInfo();
    loadItemImages();
    initializeFavoriteButton();
    initializeTransactionButton();
    
    // è‡ªåŠ¨è·å–ç”¨æˆ·ä½ç½®ä¿¡æ¯
    autoGetUserLocation();
    
    // åˆå§‹åŒ–WebSocket
    initWebSocket();
});

// åˆå§‹åŒ–æ”¶è—æŒ‰é’®çŠ¶æ€
function initializeFavoriteButton() {
    const favoriteBtn = document.querySelector('.favorite-btn');
    const isFavorited = {% if is_favorited %}true{% else %}false{% endif %};

    if (favoriteBtn) {
        updateFavoriteButton(isFavorited);
    } else {
        // å¦‚æœæ˜¯å–å®¶ï¼Œä¸æ˜¾ç¤ºæ”¶è—æŒ‰é’®æ˜¯æ­£å¸¸çš„
        const isSeller = {{ item.seller.id|default:"null" }} === {{ user.id|default:"null" }};
        if (!isSeller) {
            console.warn('åˆå§‹åŒ–æ—¶æœªæ‰¾åˆ°æ”¶è—æŒ‰é’®');
            // å»¶è¿Ÿä¸€æ®µæ—¶é—´å†å°è¯•
            setTimeout(() => {
                const retryBtn = document.querySelector('.favorite-btn');
                if (retryBtn) {
                    updateFavoriteButton(isFavorited);
                } else {
                    console.warn('é‡è¯•åä»æœªæ‰¾åˆ°æ”¶è—æŒ‰é’®');
                }
            }, 500);
        }
    }
}

// åˆå§‹åŒ–äº¤æ˜“æŒ‰é’®çŠ¶æ€
function initializeTransactionButton() {

    const transactionBtn = document.querySelector('.transaction-btn');
    if (!transactionBtn) {

        return;
    }
    
    const itemId = ITEM_ID;
    if (!itemId) {
        console.error('å•†å“IDæ— æ•ˆ');
        return;
    }

    // æ£€æŸ¥æ˜¯å¦å·²ç»å‘èµ·è¿‡äº¤æ˜“
    fetch(`/tools/api/shipbao/transaction-status/${itemId}/`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {

        if (data.has_transaction) {
            updateTransactionButton(true, data.transaction_status);
        } else {
            updateTransactionButton(false);
        }
    })
    .catch(error => {
        console.error('æ£€æŸ¥äº¤æ˜“çŠ¶æ€å¤±è´¥:', error);
        // å¦‚æœæ£€æŸ¥å¤±è´¥ï¼Œä¿æŒé»˜è®¤çŠ¶æ€
    });
}

// æ›´æ–°äº¤æ˜“æŒ‰é’®çŠ¶æ€
function updateTransactionButton(hasTransaction, transactionStatus = null) {

    const transactionBtn = document.querySelector('.transaction-btn');
    if (!transactionBtn) {
        console.error('æœªæ‰¾åˆ°äº¤æ˜“æŒ‰é’®');
        return;
    }
    
    if (hasTransaction) {
        // å·²ç»å‘èµ·è¿‡äº¤æ˜“
        transactionBtn.innerHTML = '<i class="fas fa-check-circle"></i> å·²å‘èµ·äº¤æ˜“';
        transactionBtn.classList.add('btn-success');
        transactionBtn.classList.remove('btn-secondary');
        transactionBtn.disabled = true;

    } else {
        // æœªå‘èµ·äº¤æ˜“
        transactionBtn.innerHTML = '<i class="fas fa-handshake"></i> å‘èµ·äº¤æ˜“';
        transactionBtn.classList.add('btn-secondary');
        transactionBtn.classList.remove('btn-success');
        transactionBtn.disabled = false;

    }
}

// è·å–ä½ç½®ä¿¡æ¯
function getLocationInfo() {
    // å°è¯•ä»localStorageè·å–ä¿å­˜çš„ä½ç½®
    const savedLocation = localStorage.getItem('user_location');
    if (savedLocation) {
        userLocation = JSON.parse(savedLocation);
        updateLocationDisplay(userLocation);
    }
    
    // è·å–IPå®šä½ä¿¡æ¯
    fetch('/tools/api/location/')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.location) {
                userLocation = data.location;
                updateLocationDisplay(userLocation);
                localStorage.setItem('user_location', JSON.stringify(userLocation));
            }
        })
        .catch(error => {
            console.error('è·å–ä½ç½®ä¿¡æ¯å¤±è´¥:', error);
        });
}

// è‡ªåŠ¨è·å–ç”¨æˆ·ä½ç½®ä¿¡æ¯ï¼ˆè¿›å…¥è¯¦æƒ…é¡µæ—¶è‡ªåŠ¨è°ƒç”¨ï¼‰
function autoGetUserLocation() {
    console.log('è‡ªåŠ¨è·å–ç”¨æˆ·ä½ç½®ä¿¡æ¯...');
    
    // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ä½ç½®ä¿¡æ¯
    const savedLocation = localStorage.getItem('user_location');
    if (savedLocation) {
        try {
            const location = JSON.parse(savedLocation);
            // å¦‚æœä½ç½®ä¿¡æ¯æ˜¯æœ€è¿‘5åˆ†é’Ÿå†…è·å–çš„ï¼Œç›´æ¥ä½¿ç”¨
            if (location.timestamp && (Date.now() - location.timestamp) < 300000) {
                console.log('ä½¿ç”¨ç¼“å­˜çš„ä½ç½®ä¿¡æ¯:', location);
                userLocation = location;
                updateLocationDisplay(userLocation);
                return;
            }
        } catch (e) {
            console.error('è§£æç¼“å­˜ä½ç½®ä¿¡æ¯å¤±è´¥:', e);
        }
    }
    
    // æ›´æ–°ä½ç½®æ˜¾ç¤ºä¸ºæ­£åœ¨è·å–
    const locationElement = document.getElementById('current-location');
    if (locationElement) {
        locationElement.textContent = 'æ­£åœ¨è‡ªåŠ¨è·å–ä½ç½®ä¿¡æ¯...';
    }
    
    // ä¼˜å…ˆä½¿ç”¨GPSå®šä½
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                console.log('GPSå®šä½æˆåŠŸ:', position.coords);
                const coords = {
                    lat: position.coords.latitude,
                    lon: position.coords.longitude
                };
                
                // ä½¿ç”¨åå‘åœ°ç†ç¼–ç è·å–è¯¦ç»†åœ°å€
                reverseGeocodeWithAmap(coords);
            },
            function(error) {
                console.error('GPSå®šä½å¤±è´¥:', error);
                // GPSå¤±è´¥ï¼Œä½¿ç”¨IPå®šä½
                getIPLocationFallback();
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 300000 // 5åˆ†é’Ÿç¼“å­˜
            }
        );
    } else {
        console.log('æµè§ˆå™¨ä¸æ”¯æŒGPSå®šä½ï¼Œä½¿ç”¨IPå®šä½');
        getIPLocationFallback();
    }
}

// IPå®šä½å¤‡ç”¨æ–¹æ¡ˆ
function getIPLocationFallback() {
    console.log('ä½¿ç”¨IPå®šä½...');
    
    fetch('/tools/api/location/')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.location) {
                const locationInfo = {
                    ...data.location,
                    timestamp: Date.now(),
                    source: 'ip'
                };
                
                userLocation = locationInfo;
                updateLocationDisplay(userLocation);
                localStorage.setItem('user_location', JSON.stringify(userLocation));
                console.log('IPå®šä½æˆåŠŸ:', locationInfo);
            } else {
                console.error('IPå®šä½å¤±è´¥:', data.error);
                showLocationError('ä½ç½®è·å–å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©ä½ç½®');
            }
        })
        .catch(error => {
            console.error('IPå®šä½è¯·æ±‚å¤±è´¥:', error);
            showLocationError('ä½ç½®æœåŠ¡ä¸å¯ç”¨ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©ä½ç½®');
        });
}

// æ›´æ–°ä½ç½®æ˜¾ç¤º
function updateLocationDisplay(location) {
    const locationElement = document.getElementById('current-location');
    if (location && location.city && location.city !== 'æœªçŸ¥') {
        locationElement.textContent = `å½“å‰ä½ç½®ï¼š${location.city}ï¼Œ${location.region}`;
        
        // å¦‚æœæœ‰åæ ‡ä¿¡æ¯ï¼Œè®¡ç®—ä¸å•†å“çš„è·ç¦»
        if (location.lat && location.lon) {
            calculateDistance(location.lat, location.lon);
        }
    } else {
        locationElement.textContent = 'ä½ç½®ä¿¡æ¯è·å–å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©';
    }
}

// è®¡ç®—è·ç¦»
function calculateDistance(userLat, userLon) {
    // è·å–å•†å“ä½ç½®ä¿¡æ¯ï¼ˆè¿™äº›ä¿¡æ¯åº”è¯¥ä»åç«¯ä¼ é€’ï¼‰
    const itemLat = {% if item.latitude %}{{ item.latitude }}{% else %}null{% endif %};
    const itemLon = {% if item.longitude %}{{ item.longitude }}{% else %}null{% endif %};
    
    if (itemLat && itemLon) {
        const distance = getDistance(userLat, userLon, itemLat, itemLon);
        const distanceElement = document.getElementById('item-distance');
        if (distanceElement) {
            if (distance < 1) {
                distanceElement.textContent = `è·ç¦» ${(distance * 1000).toFixed(0)}ç±³`;
            } else {
                distanceElement.textContent = `è·ç¦» ${distance.toFixed(1)}å…¬é‡Œ`;
            }
        }
    } else {
        // å¦‚æœå•†å“æ²¡æœ‰ç²¾ç¡®åæ ‡ï¼Œå°è¯•ä½¿ç”¨åœ°å€è¿›è¡Œä¼°ç®—

        const distanceElement = document.getElementById('item-distance');
        if (distanceElement) {
            distanceElement.textContent = 'è·ç¦»æœªçŸ¥';
        }
    }
}

// ä½¿ç”¨Haversineå…¬å¼è®¡ç®—ä¸¤ç‚¹é—´è·ç¦»ï¼ˆå…¬é‡Œï¼‰
function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // åœ°çƒåŠå¾„ï¼ˆå…¬é‡Œï¼‰
    const dLat = toRadians(lat2 - lat1);
    const dLon = toRadians(lon2 - lon1);
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(toRadians(lat1)) * Math.cos(toRadians(lat2)) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

// è§’åº¦è½¬å¼§åº¦
function toRadians(degrees) {
    return degrees * (Math.PI / 180);
}

// åŠ è½½å•†å“å›¾ç‰‡
function loadItemImages() {
    // è¿™é‡Œå¯ä»¥æ ¹æ®å®é™…çš„å›¾ç‰‡æ•°æ®æ¥ç”Ÿæˆå›¾ç‰‡å¯¼èˆª
    const imageNav = document.getElementById('image-nav');
    // ç¤ºä¾‹ï¼šå¦‚æœæœ‰å¤šä¸ªå›¾ç‰‡ï¼Œå¯ä»¥åœ¨è¿™é‡Œç”Ÿæˆå¯¼èˆªç‚¹
}

// æ‰“å¼€åœ°å›¾é€‰æ‹©å™¨
function openMapPicker() {
    const modal = document.getElementById('mapModal');
    modal.classList.add('show');
    
    // åŠ è½½åœ°å›¾ï¼ˆè¿™é‡Œå¯ä»¥é›†æˆå®é™…çš„åœ°å›¾APIï¼‰
    loadMap();
    
    // é¢„å¡«å……å½“å‰ä½ç½®
    if (userLocation) {
        document.getElementById('locationSearch').value = `${userLocation.city}ï¼Œ${userLocation.region}`;
    }
}

// å…³é—­åœ°å›¾é€‰æ‹©å™¨
function closeMapPicker() {
    const modal = document.getElementById('mapModal');
    modal.classList.remove('show');
    selectedLocation = null;
}

// æœç´¢ä½ç½®
function searchLocation(query) {
    if (query.length < 2) {
        document.getElementById('locationSuggestions').innerHTML = '';
        return;
    }
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const suggestionsContainer = document.getElementById('locationSuggestions');
    suggestionsContainer.innerHTML = '<div class="loading-suggestion">æ­£åœ¨æœç´¢ä½ç½®...</div>';

    // è°ƒç”¨åœ°å›¾é€‰æ‹©å™¨API
    fetch(`/tools/api/map_picker/?query=${encodeURIComponent(query)}`)
        .then(response => {

            return response.json();
        })
        .then(data => {

            if (data.success && data.suggestions && data.suggestions.length > 0) {

                suggestionsContainer.innerHTML = data.suggestions.map(suggestion => 
                    `<div class="location-suggestion" onclick="selectLocation('${suggestion.name}', ${JSON.stringify(suggestion).replace(/"/g, '&quot;')})">
                        <div class="suggestion-name">${suggestion.name}</div>
                        <div class="suggestion-address">${suggestion.address || suggestion.full_address || ''}</div>
                    </div>`
                ).join('');
            } else {

                generateFallbackSuggestions(query, suggestionsContainer);
            }
        })
        .catch(error => {
            console.error('æœç´¢ä½ç½®å¤±è´¥:', error);
            generateFallbackSuggestions(query, suggestionsContainer);
        });
}

// ç”Ÿæˆå¤‡ç”¨ä½ç½®å»ºè®®
function generateFallbackSuggestions(query, container) {
    const suggestions = [
        `${query}å¸‚ä¸­å¿ƒ`,
        `${query}ç«è½¦ç«™`,
        `${query}æœºåœº`,
        `${query}å¤§å­¦`,
        `${query}è´­ç‰©ä¸­å¿ƒ`
    ];
    
    container.innerHTML = suggestions.map(suggestion => 
        `<div class="location-suggestion" onclick="selectLocation('${suggestion}')">${suggestion}</div>`
    ).join('');
}

// é€‰æ‹©ä½ç½®
function selectLocation(location, locationData = null) {
    selectedLocation = location;
    selectedLocationData = locationData;
    document.getElementById('locationSearch').value = location;
    document.getElementById('locationSuggestions').innerHTML = '';
    
    // æ›´æ–°åœ°å›¾æ˜¾ç¤º
    updateMapDisplay(location, locationData);
}

// åŠ è½½åœ°å›¾
function loadMap() {
    const mapContainer = document.getElementById('mapContainer');
    
    // å°è¯•åŠ è½½é«˜å¾·åœ°å›¾API
    if (typeof AMap !== 'undefined') {
        // é«˜å¾·åœ°å›¾å·²åŠ è½½
        initAMap();
    } else {
        // åŠ è½½é«˜å¾·åœ°å›¾API
        const script = document.createElement('script');
        script.src = 'https://webapi.amap.com/maps?v=1.4.15&key=YOUR_AMAP_KEY';
        script.onload = function() {
            initAMap();
        };
        script.onerror = function() {
            // å›é€€åˆ°ç®€å•çš„åœ°å›¾æ˜¾ç¤º
            showSimpleMap();
        };
        document.head.appendChild(script);
    }
}

// åˆå§‹åŒ–é«˜å¾·åœ°å›¾
function initAMap() {
    const mapContainer = document.getElementById('mapContainer');
    
    try {
        // åˆ›å»ºåœ°å›¾å®ä¾‹
        const map = new AMap.Map(mapContainer, {
            zoom: 11,
            center: [116.397428, 39.90923] // é»˜è®¤åŒ—äº¬
        });
        
        // æ·»åŠ æ§ä»¶
        map.plugin(['AMap.ToolBar', 'AMap.Scale'], function() {
            map.addControl(new AMap.ToolBar());
            map.addControl(new AMap.Scale());
        });
        
        // å¦‚æœæœ‰å½“å‰ä½ç½®ï¼Œè®¾ç½®ä¸ºä¸­å¿ƒ
        if (userLocation && userLocation.lat && userLocation.lon) {
            map.setCenter([userLocation.lon, userLocation.lat]);
            new AMap.Marker({
                position: [userLocation.lon, userLocation.lat],
                title: 'å½“å‰ä½ç½®',
                map: map
            });
        }
        
        // ä¿å­˜åœ°å›¾å®ä¾‹
        window.currentMap = map;
        
    } catch (error) {
        console.error('åœ°å›¾åˆå§‹åŒ–å¤±è´¥:', error);
        showSimpleMap();
    }
}

// æ˜¾ç¤ºç®€å•åœ°å›¾
function showSimpleMap() {
    const mapContainer = document.getElementById('mapContainer');
    mapContainer.innerHTML = `
        <div style="text-align: center; padding: 40px;">
            <i class="fas fa-map-marked-alt" style="font-size: 48px; color: #3498db; margin-bottom: 15px;"></i>
            <p>åœ°å›¾åŠ è½½ä¸­...</p>
            <p style="font-size: 12px; color: #7f8c8d;">æ‚¨å¯ä»¥æœç´¢å¹¶é€‰æ‹©åœ°å€</p>
            <div style="margin-top: 20px;">
                <button onclick="showLocationPicker()" style="background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                    æ‰‹åŠ¨é€‰æ‹©ä½ç½®
                </button>
            </div>
        </div>
    `;
}

// æ˜¾ç¤ºä½ç½®é€‰æ‹©å™¨
function showLocationPicker() {
    const locations = [
        { name: 'åŒ—äº¬å¸‚æœé˜³åŒº', lat: 39.9219, lon: 116.4551 },
        { name: 'ä¸Šæµ·å¸‚æµ¦ä¸œæ–°åŒº', lat: 31.2304, lon: 121.4737 },
        { name: 'å¹¿å·å¸‚å¤©æ²³åŒº', lat: 23.1291, lon: 113.2644 },
        { name: 'æ·±åœ³å¸‚å—å±±åŒº', lat: 22.5431, lon: 113.9344 },
        { name: 'æ­å·å¸‚è¥¿æ¹–åŒº', lat: 30.2741, lon: 120.1551 }
    ];
    
    const mapContainer = document.getElementById('mapContainer');
    mapContainer.innerHTML = `
        <div style="padding: 20px;">
            <h4 style="margin-bottom: 15px;">é€‰æ‹©åŸå¸‚ï¼š</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                ${locations.map(loc => `
                    <button onclick="selectLocation('${loc.name}', {lat: ${loc.lat}, lon: ${loc.lon}})" 
                            style="background: #ecf0f1; border: 1px solid #bdc3c7; padding: 10px; border-radius: 8px; cursor: pointer; text-align: center;">
                        ${loc.name}
                    </button>
                `).join('')}
            </div>
        </div>
    `;
}

// æ›´æ–°åœ°å›¾æ˜¾ç¤º
function updateMapDisplay(location, locationData = null) {
    const mapContainer = document.getElementById('mapContainer');
    
    if (locationData && locationData.lat && locationData.lon) {
        // æ˜¾ç¤ºåæ ‡ä¿¡æ¯
        mapContainer.innerHTML = `
            <div style="text-align: center;">
                <i class="fas fa-map-pin" style="font-size: 48px; color: #e74c3c; margin-bottom: 15px;"></i>
                <p><strong>å·²é€‰æ‹©åœ°å€ï¼š</strong></p>
                <p>${location}</p>
                <p style="font-size: 12px; color: #7f8c8d;">
                    åæ ‡ï¼š${locationData.lat.toFixed(4)}, ${locationData.lon.toFixed(4)}
                </p>
            </div>
        `;
    } else {
        mapContainer.innerHTML = `
            <div style="text-align: center;">
                <i class="fas fa-map-pin" style="font-size: 48px; color: #e74c3c; margin-bottom: 15px;"></i>
                <p><strong>å·²é€‰æ‹©åœ°å€ï¼š</strong></p>
                <p>${location}</p>
            </div>
        `;
    }
}

// ç¡®è®¤ä½ç½®é€‰æ‹©
function confirmLocation() {
    if (selectedLocation) {
        // æ›´æ–°ç”¨æˆ·ä½ç½®
        if (selectedLocationData) {
            userLocation = {
                city: selectedLocationData.city || selectedLocation.split('ï¼Œ')[0],
                region: selectedLocationData.region || selectedLocation.split('ï¼Œ')[1] || 'ç”¨æˆ·é€‰æ‹©',
                country: selectedLocationData.country || 'ä¸­å›½',
                lat: selectedLocationData.lat || 39.9042,
                lon: selectedLocationData.lon || 116.4074,
                address: selectedLocation
            };
        } else {
            userLocation = {
                city: selectedLocation.split('ï¼Œ')[0],
                region: selectedLocation.split('ï¼Œ')[1] || 'ç”¨æˆ·é€‰æ‹©',
                country: 'ä¸­å›½',
                lat: 39.9042,
                lon: 116.4074,
                address: selectedLocation
            };
        }
        
        // ä¿å­˜åˆ°localStorage
        localStorage.setItem('user_location', JSON.stringify(userLocation));
        
        // æ›´æ–°æ˜¾ç¤º
        updateLocationDisplay(userLocation);
        
        // å…³é—­æ¨¡æ€æ¡†
        closeMapPicker();
        
        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        showSuccessMessage('åœ°å€é€‰æ‹©æˆåŠŸï¼');
    } else {
        showErrorMessage('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªåœ°å€');
    }
}

// è”ç³»å–å®¶
function contactSeller() {
    const itemId = ITEM_ID;
    
    if (!itemId) {
        showErrorMessage('å•†å“IDæ— æ•ˆ');
        return;
    }

    // è·å–ç”¨æˆ·è¾“å…¥çš„æ¶ˆæ¯
    const message = prompt('è¯·è¾“å…¥æ‚¨æƒ³å¯¹å–å®¶è¯´çš„è¯ï¼š') || 'ä½ å¥½ï¼Œæˆ‘å¯¹æ‚¨çš„å•†å“æ„Ÿå…´è¶£ï¼Œæƒ³è¿›ä¸€æ­¥äº†è§£ã€‚';
    
    fetch('/tools/api/shipbao/contact-seller/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            item_id: itemId,
            message: message
        })
    })
    .then(response => {

        return response.json();
    })
    .then(data => {

        if (data.success) {
            if (data.queue_info) {
                // åŠ å…¥é˜Ÿåˆ—

                showQueueInfo(data.queue_info);
            } else if (data.chat_url || data.redirect_url) {
                // ç›´æ¥è¿›å…¥èŠå¤©
                const chatUrl = data.chat_url || data.redirect_url;

                // æ˜¾ç¤ºæˆåŠŸæç¤ºå’ŒèŠå¤©å®¤é“¾æ¥
                showChatRoomCreatedNotification(chatUrl);
                
                // å»¶è¿Ÿè·³è½¬ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æç¤º
                setTimeout(() => {
                    window.location.href = chatUrl;
                }, 2000);
            } else {

                showSuccessMessage(data.message || 'è”ç³»å–å®¶æˆåŠŸ');
            }
        } else {

            if (data.queue_info) {
                showQueueInfo(data.queue_info);
            } else {
                showErrorMessage(data.error || 'è”ç³»å–å®¶å¤±è´¥');
            }
        }
    })
    .catch(error => {
        console.error('è”ç³»å–å®¶å¤±è´¥:', error);
        showErrorMessage('è”ç³»å–å®¶å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    });
}

// æƒ³è¦æ­¤å•†å“
function toggleWantItem() {
    const itemId = ITEM_ID;
    
    if (!itemId) {
        showErrorMessage('å•†å“IDæ— æ•ˆ');
        return;
    }

    // è·å–ç”¨æˆ·è¾“å…¥çš„æ¶ˆæ¯
    const message = prompt('è¯·è¾“å…¥æ‚¨æƒ³å¯¹å–å®¶è¯´çš„è¯ï¼ˆå¯é€‰ï¼‰ï¼š') || '';
    
    fetch('/tools/api/shipbao/want-item/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            item_id: itemId,
            action: 'add',
            message: message
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessMessage('å·²è¡¨ç¤ºæƒ³è¦æ­¤å•†å“ï¼');
            // æ›´æ–°æƒ³è¦æŒ‰é’®çŠ¶æ€
            updateWantButton(true);
            // å»¶è¿Ÿåˆ·æ–°é¡µé¢ä»¥æ›´æ–°æƒ³è¦äººæ•°
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            showErrorMessage(data.error || 'æ“ä½œå¤±è´¥');
        }
    })
    .catch(error => {
        console.error('æƒ³è¦å•†å“å¤±è´¥:', error);
        showErrorMessage('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    });
}

// æ›´æ–°æƒ³è¦æŒ‰é’®çŠ¶æ€
function updateWantButton(isWanted) {
    const wantBtn = document.querySelector('.want-btn');
    if (wantBtn) {
        if (isWanted) {
            wantBtn.innerHTML = '<i class="fas fa-heart"></i> å·²æƒ³è¦';
            wantBtn.classList.add('wanted');
        } else {
            wantBtn.innerHTML = '<i class="fas fa-heart"></i> æƒ³è¦æ­¤å•†å“';
            wantBtn.classList.remove('wanted');
        }
    }
}

// å‘èµ·äº¤æ˜“
function makeOffer() {
    // åˆ›å»ºå‡ºä»·è¾“å…¥å¯¹è¯æ¡†
    const offerDialog = createOfferDialog();
    document.body.appendChild(offerDialog);
}

// åˆ›å»ºå‡ºä»·å¯¹è¯æ¡†
function createOfferDialog() {
    const dialog = document.createElement('div');
    dialog.className = 'offer-dialog-overlay';
    dialog.innerHTML = `
        <div class="offer-dialog">
            <div class="offer-dialog-header">
                <h3>å‘èµ·äº¤æ˜“</h3>
                <button class="close-btn" onclick="closeOfferDialog()">&times;</button>
            </div>
            <div class="offer-dialog-content">
                <div class="form-group">
                    <label for="offer-price">å‡ºä»·é‡‘é¢ï¼ˆå…ƒï¼‰ï¼š</label>
                    <input type="number" id="offer-price" placeholder="è¯·è¾“å…¥æ‚¨çš„å‡ºä»·" min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label for="offer-message">äº¤æ˜“ç•™è¨€ï¼š</label>
                    <textarea id="offer-message" placeholder="è¯·è¾“å…¥æ‚¨çš„äº¤æ˜“æ„å‘æˆ–ç•™è¨€..." rows="4"></textarea>
                </div>
            </div>
            <div class="offer-dialog-actions">
                <button class="btn-cancel" onclick="closeOfferDialog()">å–æ¶ˆ</button>
                <button class="btn-confirm" onclick="submitOffer()">ç¡®è®¤å‘èµ·äº¤æ˜“</button>
            </div>
        </div>
    `;
    
    // æ·»åŠ æ ·å¼
    const style = document.createElement('style');
    style.textContent = `
        .offer-dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        .offer-dialog {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        .offer-dialog-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        .offer-dialog-header h3 {
            margin: 0;
            color: #2c3e50;
        }
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
        }
        .offer-dialog-content {
            padding: 20px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e6ed;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }
        .offer-dialog-actions {
            display: flex;
            gap: 10px;
            padding: 20px;
            border-top: 1px solid #eee;
            justify-content: flex-end;
        }
        .btn-cancel, .btn-confirm {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
        .btn-cancel {
            background: #95a5a6;
            color: white;
        }
        .btn-confirm {
            background: #3498db;
            color: white;
        }
        .btn-cancel:hover {
            background: #7f8c8d;
        }
        .btn-confirm:hover {
            background: #2980b9;
        }
    `;
    document.head.appendChild(style);
    
    return dialog;
}

// å…³é—­å‡ºä»·å¯¹è¯æ¡†
function closeOfferDialog() {
    const dialog = document.querySelector('.offer-dialog-overlay');
    if (dialog) {
        dialog.remove();
    }
}

// æäº¤å‡ºä»·
function submitOffer() {
    const priceInput = document.getElementById('offer-price');
    const messageInput = document.getElementById('offer-message');
    
    const price = priceInput.value.trim();
    const message = messageInput.value.trim();
    
    if (!price && !message) {
        showErrorMessage('è¯·è¾“å…¥å‡ºä»·é‡‘é¢æˆ–äº¤æ˜“ç•™è¨€');
        return;
    }
    
    const itemId = ITEM_ID;
    if (!itemId) {
        showErrorMessage('å•†å“IDæ— æ•ˆ');
        return;
    }
    
    // æ„å»ºè¯·æ±‚æ•°æ®
    const requestData = {
        item_id: itemId,
        message: message || 'å‘èµ·äº¤æ˜“'
    };
    
    // å¦‚æœæœ‰å‡ºä»·ï¼Œæ·»åŠ åˆ°è¯·æ±‚æ•°æ®ä¸­
    if (price) {
        requestData.offer_price = parseFloat(price);
    }
    
    fetch('/tools/api/shipbao/initiate-transaction/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessMessage('äº¤æ˜“è¯·æ±‚å·²å‘é€ï¼');
            // å…³é—­å¯¹è¯æ¡†
            closeOfferDialog();
            // æ›´æ–°äº¤æ˜“æŒ‰é’®çŠ¶æ€
            updateTransactionButton(true, 'initiated');
            // å»¶è¿Ÿåˆ·æ–°é¡µé¢ä»¥æ›´æ–°æƒ³è¦äººæ•°
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            showErrorMessage(data.error || 'å‘èµ·äº¤æ˜“å¤±è´¥');
            
            // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœé”™è¯¯æ˜¯"å·²ç»å‘èµ·è¿‡äº¤æ˜“è¯·æ±‚"ï¼Œæ›´æ–°æŒ‰é’®çŠ¶æ€
            if (data.error && data.error.includes('å·²ç»å‘èµ·è¿‡äº¤æ˜“è¯·æ±‚')) {
                updateTransactionButton(true, 'initiated');
                showSuccessMessage('æ‚¨å·²ç»å‘èµ·è¿‡äº¤æ˜“è¯·æ±‚');
            }
        }
    })
    .catch(error => {
        console.error('å‘èµ·äº¤æ˜“å¤±è´¥:', error);
        showErrorMessage('å‘èµ·äº¤æ˜“å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    });
}

// ä¸ç”¨æˆ·èŠå¤©
function chatWithUser(userId, itemId) {
    // ç›´æ¥åˆ›å»ºäº¤æ˜“å¹¶è¿›å…¥èŠå¤©å®¤
    createTransactionAndChat(userId, itemId);
}

// åˆ›å»ºäº¤æ˜“å¹¶è¿›å…¥èŠå¤©å®¤
function createTransactionAndChat(userId, itemId) {
    // æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦æ˜¯å–å®¶
    const itemSellerId = {{ item.seller.id|default:"null" }};
    const currentUserId = {{ user.id|default:"null" }};
    const isSeller = itemSellerId === currentUserId;
    
    let message;
    if (isSeller) {
        message = prompt('è¯·è¾“å…¥æ‚¨æƒ³å¯¹ä¹°å®¶è¯´çš„è¯ï¼š') || 'ä½ å¥½ï¼Œæˆ‘æ˜¯å–å®¶ï¼Œæƒ³ä¸æ‚¨è¿›ä¸€æ­¥æ²Ÿé€šã€‚';
    } else {
        message = prompt('è¯·è¾“å…¥æ‚¨æƒ³å¯¹å–å®¶è¯´çš„è¯ï¼š') || 'ä½ å¥½ï¼Œæˆ‘å¯¹æ‚¨çš„å•†å“æ„Ÿå…´è¶£ï¼Œæƒ³è¿›ä¸€æ­¥äº†è§£ã€‚';
    }
    
    // æ„å»ºè¯·æ±‚æ•°æ®
    const requestData = {
        item_id: itemId,
        message: message
    };
    
    // å¦‚æœæ˜¯å–å®¶è”ç³»ä¹°å®¶ï¼Œéœ€è¦æ·»åŠ buyer_id
    if (isSeller) {
        requestData.buyer_id = userId;
    }
    
    fetch('/tools/api/shipbao/initiate-transaction/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.transaction_id) {
                // ä¹°å®¶è”ç³»å–å®¶ï¼Œè·³è½¬åˆ°äº¤æ˜“èŠå¤©å®¤
                window.open(`/tools/shipbao/chat/${data.transaction_id}/`, '_blank');
            } else if (data.chat_room_id) {
                // å–å®¶è”ç³»ä¹°å®¶ï¼Œç›´æ¥è·³è½¬åˆ°èŠå¤©å®¤
                window.open(`/tools/heart_link/chat/${data.chat_room_id}/`, '_blank');
            } else {
                showSuccessMessage('è”ç³»æˆåŠŸï¼');
            }
        } else {
            showErrorMessage('åˆ›å»ºè”ç³»å¤±è´¥ï¼š' + data.error);
        }
    })
    .catch(error => {
        console.error('åˆ›å»ºè”ç³»å¤±è´¥:', error);
        showErrorMessage('åˆ›å»ºè”ç³»å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    });
}

// è·å–Cookieå€¼
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// åˆ‡æ¢æ”¶è—çŠ¶æ€
function toggleFavorite() {

    const itemId = ITEM_ID;

    if (!itemId) {
        console.error('å•†å“IDæ— æ•ˆ');
        showErrorMessage('å•†å“IDæ— æ•ˆ');
        return;
    }
    
    const favoriteBtn = document.querySelector('.favorite-btn');

    if (!favoriteBtn) {
        // å¦‚æœæ˜¯å–å®¶ï¼Œä¸æ˜¾ç¤ºæ”¶è—æŒ‰é’®æ˜¯æ­£å¸¸çš„
        const isSeller = {{ item.seller.id|default:"null" }} === {{ user.id|default:"null" }};
        if (!isSeller) {
            console.error('æ”¶è—æŒ‰é’®æœªæ‰¾åˆ°');
            showErrorMessage('æ”¶è—æŒ‰é’®æœªæ‰¾åˆ°');
        }
        return;
    }
    
    const isCurrentlyFavorited = favoriteBtn.classList.contains('favorited');


    const action = isCurrentlyFavorited ? 'remove' : 'add';

    // ç«‹å³æ›´æ–°æŒ‰é’®çŠ¶æ€ä»¥æä¾›å³æ—¶åé¦ˆ
    favoriteBtn.disabled = true;
    const originalHTML = favoriteBtn.innerHTML;
    favoriteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> å¤„ç†ä¸­...';
    
    const newFavoritedState = !isCurrentlyFavorited;



    fetch('/tools/api/shipbao/favorites/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            item_id: itemId,
            action: action
        })
    })
    .then(response => {

        return response.json();
    })
    .then(data => {

        if (data.success) {

            showSuccessMessage(data.message);

            updateFavoriteButton(data.is_favorited);
        } else {
            console.error('APIè°ƒç”¨å¤±è´¥:', data.error);
            
            // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœé”™è¯¯æ˜¯"å·²ç»æ”¶è—è¿‡"ï¼Œè¯´æ˜å®é™…çŠ¶æ€æ˜¯å·²æ”¶è—
            if (data.error && data.error.includes('å·²ç»æ”¶è—è¿‡')) {

                updateFavoriteButton(true);
                showSuccessMessage('å•†å“å·²åœ¨æ”¶è—åˆ—è¡¨ä¸­');
            } 
            // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœé”™è¯¯æ˜¯"å°šæœªæ”¶è—"ï¼Œè¯´æ˜å®é™…çŠ¶æ€æ˜¯æœªæ”¶è—
            else if (data.error && data.error.includes('å°šæœªæ”¶è—')) {

                updateFavoriteButton(false);
                showErrorMessage('å•†å“å°šæœªæ”¶è—');
            }
            else {
                showErrorMessage(data.error || 'æ“ä½œå¤±è´¥');
                // æ¢å¤åŸå§‹çŠ¶æ€

                updateFavoriteButton(isCurrentlyFavorited);
            }
        }
    })
    .catch(error => {
        console.error('è¯·æ±‚å‡ºé”™:', error);
        showErrorMessage('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        // æ¢å¤åŸå§‹çŠ¶æ€

        updateFavoriteButton(isCurrentlyFavorited);
    })
    .finally(() => {
        // é‡æ–°å¯ç”¨æŒ‰é’®

        favoriteBtn.disabled = false;
    });
}

// æ›´æ–°æ”¶è—æŒ‰é’®çŠ¶æ€
function updateFavoriteButton(isFavorited) {

    const favoriteBtn = document.querySelector('.favorite-btn');

    if (favoriteBtn) {


        if (isFavorited) {
            favoriteBtn.innerHTML = '<i class="fas fa-heart" style="color: #e74c3c;"></i> å·²æ”¶è—';
            favoriteBtn.classList.add('favorited');

        } else {
            favoriteBtn.innerHTML = '<i class="fas fa-heart"></i> æ”¶è—';
            favoriteBtn.classList.remove('favorited');

        }


    } else {
        console.error('updateFavoriteButton: æœªæ‰¾åˆ°æ”¶è—æŒ‰é’®');
    }
}

// ç¼–è¾‘å•†å“ï¼ˆå‘å¸ƒè€…åŠŸèƒ½ï¼‰
function editProduct() {
    const itemId = ITEM_ID;
    if (!itemId) {
        showErrorMessage('å•†å“IDæ— æ•ˆ');
        return;
    }
    
    // è·³è½¬åˆ°ç¼–è¾‘é¡µé¢
    window.location.href = `/tools/shipbao/edit/${itemId}/`;
}

// ä¸‹æ¶å•†å“ï¼ˆå‘å¸ƒè€…åŠŸèƒ½ï¼‰
function toggleProductStatus() {
    const itemId = ITEM_ID;
    
    if (!itemId) {
        showErrorMessage('å•†å“IDæ— æ•ˆ');
        return;
    }
    
    if (!confirm('ç¡®å®šè¦ä¸‹æ¶è¿™ä¸ªå•†å“å—ï¼Ÿä¸‹æ¶åå…¶ä»–ç”¨æˆ·å°†æ— æ³•çœ‹åˆ°æ­¤å•†å“ã€‚')) {
        return;
    }
    
    fetch('/tools/api/shipbao/remove-item/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            item_id: itemId,
            action: 'remove'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessMessage('å•†å“å·²ä¸‹æ¶');
            setTimeout(() => {
                window.location.href = '/tools/shipbao/';
            }, 1500);
        } else {
            showErrorMessage(data.error || 'ä¸‹æ¶å¤±è´¥');
        }
    })
    .catch(error => {
        console.error('ä¸‹æ¶å•†å“å¤±è´¥:', error);
        showErrorMessage('ä¸‹æ¶å•†å“å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    });
}

// æ ‡è®°ä¸ºå·²å”®ï¼ˆå‘å¸ƒè€…åŠŸèƒ½ï¼‰
function markAsSold() {
    const itemId = ITEM_ID;
    
    if (!itemId) {
        showErrorMessage('å•†å“IDæ— æ•ˆ');
        return;
    }
    
    if (!confirm('ç¡®å®šè¦æ ‡è®°æ­¤å•†å“ä¸ºå·²å”®å—ï¼Ÿ')) {
        return;
    }
    
    fetch('/tools/api/shipbao/mark-sold/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            item_id: itemId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessMessage('å•†å“å·²æ ‡è®°ä¸ºå·²å”®');
            setTimeout(() => {
                window.location.href = '/tools/shipbao/';
            }, 1500);
        } else {
            showErrorMessage(data.error || 'æ ‡è®°å¤±è´¥');
        }
    })
    .catch(error => {
        console.error('æ ‡è®°ä¸ºå·²å”®å¤±è´¥:', error);
        showErrorMessage('æ ‡è®°ä¸ºå·²å”®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    });
}

// æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
function showSuccessMessage(message) {
    showMessage(message, 'success');
}

// æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
function showErrorMessage(message) {
    showMessage(message, 'error');
}

// æ˜¾ç¤ºæ¶ˆæ¯æç¤º
function showMessage(message, type = 'info') {
    // åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
    const messageDiv = document.createElement('div');
    messageDiv.className = `message-toast message-${type}`;
    messageDiv.textContent = message;
    
    // æ·»åŠ åˆ°é¡µé¢
    document.body.appendChild(messageDiv);
    
    // æ˜¾ç¤ºåŠ¨ç”»
    setTimeout(() => {
        messageDiv.classList.add('show');
    }, 100);
    
    // è‡ªåŠ¨éšè—
    setTimeout(() => {
        messageDiv.classList.remove('show');
        setTimeout(() => {
            document.body.removeChild(messageDiv);
        }, 300);
    }, 3000);
}

// æ˜¾ç¤ºèŠå¤©å®¤åˆ›å»ºæˆåŠŸé€šçŸ¥
function showChatRoomCreatedNotification(chatUrl) {
    // åˆ›å»ºç‰¹æ®Šçš„èŠå¤©å®¤åˆ›å»ºé€šçŸ¥
    const notification = document.createElement('div');
    notification.className = 'chat-room-created-notification';
    notification.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, #27ae60, #2ecc71);
        color: white;
        padding: 20px 30px;
        border-radius: 15px;
        box-shadow: 0 8px 32px rgba(39, 174, 96, 0.3);
        z-index: 10003;
        text-align: center;
        min-width: 300px;
        backdrop-filter: blur(10px);
        animation: popIn 0.3s ease-out;
    `;
    
    notification.innerHTML = `
        <div style="margin-bottom: 15px;">
            <i class="fas fa-check-circle" style="font-size: 48px; color: white; margin-bottom: 10px;"></i>
            <h3 style="margin: 0; font-size: 18px;">èŠå¤©å®¤åˆ›å»ºæˆåŠŸï¼</h3>
        </div>
        <div style="margin-bottom: 15px; font-size: 14px; opacity: 0.9;">
            æ­£åœ¨ä¸ºæ‚¨è·³è½¬åˆ°èŠå¤©é¡µé¢...
        </div>
        <div style="font-size: 12px; opacity: 0.8;">
            èŠå¤©å®¤ID: ${chatUrl.split('/').pop()}
        </div>
        <div style="margin-top: 15px;">
            <button onclick="window.location.href='${chatUrl}'" style="
                background: rgba(255,255,255,0.2);
                border: 1px solid rgba(255,255,255,0.3);
                color: white;
                padding: 8px 15px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 12px;
                margin-right: 10px;
            ">ç«‹å³è¿›å…¥</button>
            <button onclick="closeNotification(this.parentElement.parentElement)" style="
                background: transparent;
                border: 1px solid rgba(255,255,255,0.3);
                color: white;
                padding: 8px 15px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 12px;
            ">å…³é—­</button>
        </div>
    `;
    
    // æ·»åŠ åŠ¨ç”»æ ·å¼
    const style = document.createElement('style');
    style.textContent = `
        @keyframes popIn {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
    `;
    if (!document.querySelector('style[data-chat-notification]')) {
        style.setAttribute('data-chat-notification', 'true');
        document.head.appendChild(style);
    }
    
    // æ·»åŠ åˆ°é¡µé¢
    document.body.appendChild(notification);
    
    // è‡ªåŠ¨å…³é—­
    setTimeout(() => {
        if (document.body.contains(notification)) {
            closeNotification(notification);
        }
    }, 5000);
}

// å…³é—­é€šçŸ¥
function closeNotification(element) {
    if (element && document.body.contains(element)) {
        element.style.animation = 'popOut 0.3s ease-in';
        setTimeout(() => {
            if (document.body.contains(element)) {
                document.body.removeChild(element);
            }
        }, 300);
    }
}

// ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
document.getElementById('mapModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeMapPicker();
    }
});

// èŠå¤©é€šçŸ¥åŠŸèƒ½
function showChatNotification(sender, message) {
    const notification = document.createElement('div');
    notification.className = 'chat-notification';
    notification.innerHTML = `
        <div class="chat-notification-content">
            <div class="chat-notification-icon">
                <i class="fas fa-comments"></i>
            </div>
            <div class="chat-notification-text">
                <div class="chat-notification-title">æ–°æ¶ˆæ¯</div>
                <div class="chat-notification-message">${sender}: ${message}</div>
            </div>
        </div>
    `;
    
    // æ·»åŠ åˆ°é¡µé¢
    document.body.appendChild(notification);
    
    // æ˜¾ç¤ºåŠ¨ç”»
    setTimeout(() => {
        notification.classList.add('show');
    }, 100);
    
    // ç‚¹å‡»è·³è½¬åˆ°èŠå¤©
    notification.addEventListener('click', function() {
        window.location.href = '/tools/shipbao/chat/';
    });
    
    // è‡ªåŠ¨éšè—
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
            if (document.body.contains(notification)) {
                document.body.removeChild(notification);
            }
        }, 300);
    }, 5000);
}

// åˆå§‹åŒ–WebSocketè¿æ¥ï¼ˆç”¨äºå®æ—¶æ¶ˆæ¯é€šçŸ¥ï¼‰
function initWebSocket() {
    // æš‚æ—¶ç¦ç”¨WebSocketè¿æ¥ï¼Œé¿å…shipbaoèŠå¤©å®¤ä¸å­˜åœ¨çš„é—®é¢˜
    return;
    
    if ('WebSocket' in window) {
        // ä¸ºshipbaoä½¿ç”¨å›ºå®šçš„æˆ¿é—´IDï¼Œæˆ–è€…åŸºäºå•†å“IDç”Ÿæˆ
        const roomId = ITEM_ID ? `shipbao-item-${ITEM_ID}` : 'shipbao-general';
        const ws = new WebSocket(`ws://localhost:8000/ws/chat/${roomId}/`);
        
        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            if (data.type === 'chat_message') {
                showChatNotification(data.sender, data.message);
            }
        };
        
        ws.onerror = function(error) {
            console.error('WebSocketè¿æ¥é”™è¯¯:', error);
        };
        
        // ä¿å­˜WebSocketå®ä¾‹
        window.chatWebSocket = ws;
    }
}

// æ£€æŸ¥é˜Ÿåˆ—çŠ¶æ€
async function checkQueueStatus() {
    const itemId = ITEM_ID;
    
    if (!itemId) {
        return null;
    }
    
    try {
        const response = await fetch(`/tools/api/shipbao/inquiry-queue/${itemId}/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        if (response.ok) {
            return await response.json();
        }
    } catch (error) {
        console.error('æ£€æŸ¥é˜Ÿåˆ—çŠ¶æ€å¤±è´¥:', error);
    }
    
    return null;
}

// æ˜¾ç¤ºé˜Ÿåˆ—ä¿¡æ¯
function showQueueInfo(queueInfo) {
    // ç§»é™¤ç°æœ‰çš„å¼¹çª—
    closeQueueModal();
    
    const queueHtml = `
        <div class="queue-info-modal" style="
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 1000;
            max-width: 400px;
            width: 90%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        ">
            <h3 style="margin-top: 0; color: #333;">ğŸ“‹ å’¨è¯¢é˜Ÿåˆ—çŠ¶æ€</h3>
            <div style="margin: 15px 0; color: #666;">
                <p><strong>é˜Ÿåˆ—ä½ç½®ï¼š</strong> ç¬¬ ${queueInfo.position} ä½</p>
                <p><strong>é¢„è®¡ç­‰å¾…ï¼š</strong> ${queueInfo.estimated_wait}</p>
                <p><strong>æ€»æ’é˜Ÿäººæ•°ï¼š</strong> ${queueInfo.total_pending} äºº</p>
                ${queueInfo.priority_score ? `<p><strong>æ‚¨çš„ä¼˜å…ˆçº§åˆ†æ•°ï¼š</strong> ${queueInfo.priority_score}</p>` : ''}
            </div>
            <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin: 15px 0; font-size: 14px;">
                ğŸ’¡ <strong>æç¤ºï¼š</strong> è¯¦ç»†çš„å’¨è¯¢æ¶ˆæ¯å¯ä»¥æé«˜ä¼˜å…ˆçº§ï¼Œå–å®¶ä¼šä¼˜å…ˆå›å¤é«˜è´¨é‡å’¨è¯¢ã€‚
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="closeQueueModal()" style="
                    background: #6c757d;
                    color: white;
                    border: none;
                    padding: 8px 16px;
                    border-radius: 4px;
                    cursor: pointer;
                    margin-right: 10px;
                ">ç¡®å®š</button>
                <button onclick="refreshQueueStatus()" style="
                    background: #28a745;
                    color: white;
                    border: none;
                    padding: 8px 16px;
                    border-radius: 4px;
                    cursor: pointer;
                ">åˆ·æ–°çŠ¶æ€</button>
            </div>
        </div>
        <div class="queue-backdrop" style="
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        " onclick="closeQueueModal()"></div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', queueHtml);
}

// å…³é—­é˜Ÿåˆ—ä¿¡æ¯å¼¹çª—
function closeQueueModal() {
    const modal = document.querySelector('.queue-info-modal');
    const backdrop = document.querySelector('.queue-backdrop');
    if (modal) modal.remove();
    if (backdrop) backdrop.remove();
}

// åˆ·æ–°é˜Ÿåˆ—çŠ¶æ€
async function refreshQueueStatus() {
    const itemId = ITEM_ID;
    
    if (!itemId) {
        showErrorMessage('å•†å“IDæ— æ•ˆ');
        return;
    }
    
    try {
        const data = await checkQueueStatus();
        
        if (data && data.success && data.queue_info.user_inquiry) {
            const userInquiry = data.queue_info.user_inquiry;
            
            if (userInquiry.status === 'responded' && userInquiry.chat_room_id) {
                // å·²å“åº”ï¼Œè·³è½¬åˆ°èŠå¤©å®¤
                closeQueueModal();
                showSuccessMessage('ğŸ‰ å–å®¶å·²å“åº”ï¼Œæ­£åœ¨è·³è½¬åˆ°èŠå¤©å®¤...');
                setTimeout(() => {
                    window.location.href = `/tools/heart_link/chat/${userInquiry.chat_room_id}/`;
                }, 1500);
            } else if (userInquiry.status === 'pending') {
                // æ›´æ–°é˜Ÿåˆ—ä¿¡æ¯
                showQueueInfo({
                    position: userInquiry.position,
                    estimated_wait: userInquiry.estimated_wait,
                    total_pending: data.queue_info.total_pending,
                    priority_score: userInquiry.priority_score
                });
            }
        } else {
            showErrorMessage('è·å–é˜Ÿåˆ—çŠ¶æ€å¤±è´¥');
        }
    } catch (error) {
        showErrorMessage('æ£€æŸ¥çŠ¶æ€å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    }
}

// WebSocketåˆå§‹åŒ–å‡½æ•°
function initWebSocket() {
    // WebSocketåˆå§‹åŒ–é€»è¾‘
}

// ==================== å¢å¼ºçš„ä½ç½®ç®¡ç†åŠŸèƒ½ ====================

let selectedLocationInfo = null;
let searchTimeout = null;

// è‡ªåŠ¨å®šä½ç”¨æˆ·
function autoLocateUser() {

    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    const autoBtn = document.querySelector('.auto-locate-btn');
    if (autoBtn) {
        autoBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> å®šä½ä¸­...';
        autoBtn.disabled = true;
    }
    
    // æ›´æ–°ä½ç½®æ˜¾ç¤º
    const locationElement = document.getElementById('current-location');
    if (locationElement) {
        locationElement.textContent = 'æ­£åœ¨è‡ªåŠ¨å®šä½ä¸­...';
    }
    
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            // æˆåŠŸå›è°ƒ
            function(position) {

                const coords = {
                    lat: position.coords.latitude,
                    lon: position.coords.longitude
                };
                
                // ä½¿ç”¨é«˜å¾·APIåå‘åœ°ç†ç¼–ç 
                reverseGeocodeWithAmap(coords);
            },
            // é”™è¯¯å›è°ƒ
            function(error) {
                console.error('è‡ªåŠ¨å®šä½å¤±è´¥:', error);
                handleLocationError(error);
                resetAutoLocateButton();
            },
            // é€‰é¡¹
            {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 60000 // 1åˆ†é’Ÿç¼“å­˜
            }
        );
    } else {
        console.error('æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†ä½ç½®');
        showLocationError('æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†ä½ç½®åŠŸèƒ½');
        resetAutoLocateButton();
    }
}

// ä½¿ç”¨é«˜å¾·APIåå‘åœ°ç†ç¼–ç 
function reverseGeocodeWithAmap(coords) {

    fetch('/tools/api/map/reverse-geocode/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            lat: coords.lat,
            lon: coords.lon
        })
    })
    .then(response => response.json())
    .then(data => {

        if (data.success && data.location) {
            const locationInfo = {
                city: data.location.city || 'æœªçŸ¥åŸå¸‚',
                region: data.location.region || '',
                address: data.location.address || '',
                lat: coords.lat,
                lon: coords.lon,
                timestamp: Date.now(),
                source: 'auto_locate'
            };
            
            // ä¿å­˜å’Œæ›´æ–°ä½ç½®
            saveUserLocation(locationInfo);
            updateLocationDisplay(locationInfo);
            showSuccessMessage('è‡ªåŠ¨å®šä½æˆåŠŸï¼');
            console.log('è‡ªåŠ¨å®šä½æˆåŠŸ:', locationInfo);
        } else {
            console.error('åå‘åœ°ç†ç¼–ç å¤±è´¥:', data.error);
            showLocationError('ä½ç½®è§£æå¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©');
        }
        
        resetAutoLocateButton();
    })
    .catch(error => {
        console.error('åå‘åœ°ç†ç¼–ç è¯·æ±‚å¤±è´¥:', error);
        showLocationError('å®šä½æœåŠ¡æš‚æ—¶ä¸å¯ç”¨');
        resetAutoLocateButton();
    });
}

// é‡ç½®è‡ªåŠ¨å®šä½æŒ‰é’®
function resetAutoLocateButton() {
    const autoBtn = document.querySelector('.auto-locate-btn');
    if (autoBtn) {
        autoBtn.innerHTML = '<i class="fas fa-crosshairs"></i> è‡ªåŠ¨å®šä½';
        autoBtn.disabled = false;
    }
}

// å¤„ç†å®šä½é”™è¯¯
function handleLocationError(error) {
    let errorMessage = '';
    
    switch(error.code) {
        case error.PERMISSION_DENIED:
            errorMessage = 'ä½ç½®æƒé™è¢«æ‹’ç»ï¼Œè¯·å…è®¸è·å–ä½ç½®æƒé™';
            break;
        case error.POSITION_UNAVAILABLE:
            errorMessage = 'ä½ç½®ä¿¡æ¯ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
            break;
        case error.TIMEOUT:
            errorMessage = 'ä½ç½®è·å–è¶…æ—¶ï¼Œè¯·é‡è¯•';
            break;
        default:
            errorMessage = 'ä½ç½®è·å–å¤±è´¥ï¼Œè¯·é‡è¯•';
            break;
    }
    
    showLocationError(errorMessage);
}

// æ˜¾ç¤ºä½ç½®é”™è¯¯
function showLocationError(message) {
    const locationElement = document.getElementById('current-location');
    if (locationElement) {
        locationElement.textContent = `âŒ ${message}`;
    }
    showErrorMessage(message);
}

// æœç´¢ä½ç½®å»ºè®®
function searchLocationSuggestions(query) {

    // æ¸…é™¤ä¹‹å‰çš„æœç´¢è¶…æ—¶
    if (searchTimeout) {
        clearTimeout(searchTimeout);
    }
    
    // å¦‚æœæŸ¥è¯¢ä¸ºç©ºï¼Œæ¸…ç©ºå»ºè®®åˆ—è¡¨
    if (!query || query.trim().length === 0) {
        clearLocationSuggestions();
        return;
    }
    
    // å»¶è¿Ÿæœç´¢é¿å…é¢‘ç¹è¯·æ±‚
    searchTimeout = setTimeout(() => {
        performLocationSearch(query.trim());
    }, 300);
}

// æ‰§è¡Œä½ç½®æœç´¢
function performLocationSearch(query) {

    fetch('/tools/api/map/search-location/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            query: query
        })
    })
    .then(response => response.json())
    .then(data => {

        if (data.success && data.suggestions) {
            displayLocationSuggestions(data.suggestions);
        } else {
            console.error('ä½ç½®æœç´¢å¤±è´¥:', data.error);
            clearLocationSuggestions();
        }
    })
    .catch(error => {
        console.error('ä½ç½®æœç´¢è¯·æ±‚å¤±è´¥:', error);
        clearLocationSuggestions();
    });
}

// æ˜¾ç¤ºä½ç½®å»ºè®®
function displayLocationSuggestions(suggestions) {
    const suggestionsContainer = document.getElementById('location-suggestions-list');
    if (!suggestionsContainer) return;
    
    if (!suggestions || suggestions.length === 0) {
        suggestionsContainer.innerHTML = '<div class="no-suggestions">æœªæ‰¾åˆ°ç›¸å…³ä½ç½®</div>';
        suggestionsContainer.style.display = 'block';
        return;
    }
    
    const suggestionsHTML = suggestions.map(suggestion => `
        <div class="location-suggestion-item" onclick="selectLocationSuggestion(this)" data-location='${JSON.stringify(suggestion)}'>
            <div class="suggestion-main">${suggestion.name || suggestion.address}</div>
            <div class="suggestion-detail">${suggestion.district || suggestion.city || ''}</div>
        </div>
    `).join('');
    
    suggestionsContainer.innerHTML = suggestionsHTML;
    suggestionsContainer.style.display = 'block';
}

// é€‰æ‹©ä½ç½®å»ºè®®
function selectLocationSuggestion(element) {
    try {
        const locationData = JSON.parse(element.getAttribute('data-location'));

        selectedLocationInfo = locationData;
        
        // æ›´æ–°è¾“å…¥æ¡†
        const input = document.getElementById('location-search-input');
        if (input) {
            input.value = locationData.name || locationData.address;
        }
        
        // é«˜äº®é€‰ä¸­é¡¹
        document.querySelectorAll('.location-suggestion-item').forEach(item => {
            item.classList.remove('selected');
        });
        element.classList.add('selected');
        
        // éšè—å»ºè®®åˆ—è¡¨
        clearLocationSuggestions();
        
    } catch (error) {
        console.error('é€‰æ‹©ä½ç½®å»ºè®®å¤±è´¥:', error);
    }
}

// æ¸…ç©ºä½ç½®å»ºè®®
function clearLocationSuggestions() {
    const suggestionsContainer = document.getElementById('location-suggestions-list');
    if (suggestionsContainer) {
        suggestionsContainer.innerHTML = '';
        suggestionsContainer.style.display = 'none';
    }
}

// æœç´¢å½“å‰è¾“å…¥çš„å†…å®¹
function searchCurrentInput() {
    const input = document.getElementById('location-search-input');
    if (input && input.value.trim()) {
        performLocationSearch(input.value.trim());
    }
}

// ç¡®è®¤æ‰‹åŠ¨ä½ç½®é€‰æ‹©
function confirmManualLocation() {
    const input = document.getElementById('location-search-input');
    if (!input || !input.value.trim()) {
        showErrorMessage('è¯·å…ˆè¾“å…¥æˆ–é€‰æ‹©ä¸€ä¸ªä½ç½®');
        return;
    }
    
    let locationInfo;
    
    if (selectedLocationInfo) {
        // ä½¿ç”¨é€‰ä¸­çš„å»ºè®®ä½ç½®
        locationInfo = {
            city: selectedLocationInfo.city || selectedLocationInfo.name,
            region: selectedLocationInfo.district || selectedLocationInfo.region || '',
            address: selectedLocationInfo.address || selectedLocationInfo.name,
            lat: selectedLocationInfo.lat || selectedLocationInfo.location?.[0],
            lon: selectedLocationInfo.lon || selectedLocationInfo.location?.[1],
            timestamp: Date.now(),
            source: 'manual_select'
        };
    } else {
        // ä½¿ç”¨è¾“å…¥çš„æ–‡æœ¬
        const inputText = input.value.trim();
        locationInfo = {
            city: inputText,
            region: '',
            address: inputText,
            lat: null,
            lon: null,
            timestamp: Date.now(),
            source: 'manual_input'
        };
        
        // å°è¯•åœ°ç†ç¼–ç è·å–åæ ‡
        geocodeLocation(locationInfo);
        return; // geocodeLocationä¼šå¤„ç†åç»­æ­¥éª¤
    }
    
    // ä¿å­˜å’Œæ›´æ–°ä½ç½®
    saveUserLocation(locationInfo);
    updateLocationDisplay(locationInfo);
    cancelLocationInput();
    showSuccessMessage('ä½ç½®è®¾ç½®æˆåŠŸï¼');
}

// åœ°ç†ç¼–ç ä½ç½®
function geocodeLocation(locationInfo) {

    fetch('/tools/api/map/geocode/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            address: locationInfo.address
        })
    })
    .then(response => response.json())
    .then(data => {

        if (data.success && data.location) {
            locationInfo.lat = data.location.lat;
            locationInfo.lon = data.location.lon;
            locationInfo.region = data.location.region || locationInfo.region;
        }
        
        // æ— è®ºç¼–ç æ˜¯å¦æˆåŠŸï¼Œéƒ½ä¿å­˜ä½ç½®
        saveUserLocation(locationInfo);
        updateLocationDisplay(locationInfo);
        cancelLocationInput();
        showSuccessMessage('ä½ç½®è®¾ç½®æˆåŠŸï¼');
    })
    .catch(error => {
        console.error('åœ°ç†ç¼–ç å¤±è´¥:', error);
        
        // å³ä½¿ç¼–ç å¤±è´¥ï¼Œä¹Ÿä¿å­˜ä½ç½®
        saveUserLocation(locationInfo);
        updateLocationDisplay(locationInfo);
        cancelLocationInput();
        showSuccessMessage('ä½ç½®è®¾ç½®æˆåŠŸï¼');
    });
}

// å–æ¶ˆä½ç½®è¾“å…¥
function cancelLocationInput() {
    const container = document.getElementById('location-input-container');
    if (container) {
        container.style.display = 'none';
    }
    
    // æ¸…ç©ºè¾“å…¥å’Œé€‰æ‹©
    const input = document.getElementById('location-search-input');
    if (input) {
        input.value = '';
    }
    
    selectedLocationInfo = null;
    clearLocationSuggestions();
}

// ä¿å­˜ç”¨æˆ·ä½ç½®
function saveUserLocation(location) {
    userLocation = location;
    
    // ä¿å­˜åˆ°localStorage
    try {
        localStorage.setItem('user_location', JSON.stringify(location));

    } catch (error) {
        console.error('ä¿å­˜ä½ç½®åˆ°æœ¬åœ°å­˜å‚¨å¤±è´¥:', error);
    }
    
    // å‘é€åˆ°æœåŠ¡å™¨
    fetch('/tools/api/user/save-location/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(location)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {

        } else {

        }
    })
    .catch(error => {
        console.error('ä¿å­˜ä½ç½®åˆ°æœåŠ¡å™¨å¤±è´¥:', error);
    });
}

// é‡å†™openMapPickerå‡½æ•°ä»¥ä½¿ç”¨æ–°çš„è¾“å…¥å®¹å™¨
function openMapPicker() {
    const container = document.getElementById('location-input-container');
    if (container) {
        container.style.display = 'block';
        
        // èšç„¦åˆ°è¾“å…¥æ¡†
        const input = document.getElementById('location-search-input');
        if (input) {
            input.focus();
        }
    }
}
</script>

<style>
/* ä½ç½®æ“ä½œæŒ‰é’® */
.location-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
    flex-wrap: wrap;
}

.location-btn {
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid rgba(0, 0, 0, 0.1);
    color: #2c3e50;
    padding: 10px 15px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 14px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.location-btn:hover {
    background: rgba(255, 255, 255, 1);
    border-color: rgba(52, 152, 219, 0.5);
    color: #3498db;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.location-btn:active {
    transform: translateY(0);
}

.location-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
    background: rgba(255, 255, 255, 0.6);
    color: #7f8c8d;
}

/* ä½ç½®è¾“å…¥å®¹å™¨ */
.location-input-container {
    margin-top: 15px;
    padding: 15px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    backdrop-filter: blur(10px);
}

.input-group {
    display: flex;
    margin-bottom: 10px;
}

.location-search-input {
    flex: 1;
    padding: 12px 15px;
    border: none;
    border-radius: 8px 0 0 8px;
    background: rgba(255, 255, 255, 0.9);
    color: #333;
    font-size: 14px;
    outline: none;
}

.location-search-input::placeholder {
    color: #666;
}

.input-group-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    padding: 12px 15px;
    border-radius: 0 8px 8px 0;
    color: white;
    cursor: pointer;
    transition: background 0.3s ease;
}

.input-group-btn:hover {
    background: rgba(255, 255, 255, 0.3);
}

/* æœç´¢å»ºè®®åˆ—è¡¨ */
.location-suggestions-list {
    max-height: 200px;
    overflow-y: auto;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 8px;
    margin-bottom: 10px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    display: none;
}

.location-suggestion-item {
    padding: 12px 15px;
    color: #333;
    cursor: pointer;
    transition: background 0.2s ease;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
}

.location-suggestion-item:last-child {
    border-bottom: none;
}

.location-suggestion-item:hover {
    background: rgba(102, 126, 234, 0.1);
}

.location-suggestion-item.selected {
    background: rgba(102, 126, 234, 0.2);
}

.suggestion-main {
    font-weight: 500;
    margin-bottom: 2px;
}

.suggestion-detail {
    font-size: 12px;
    color: #666;
}

.no-suggestions {
    padding: 15px;
    text-align: center;
    color: #666;
    font-size: 14px;
}

/* ä½ç½®è¾“å…¥æ“ä½œæŒ‰é’® */
.location-input-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

.btn-confirm, .btn-cancel {
    padding: 8px 15px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 5px;
    transition: all 0.3s ease;
}

.btn-confirm {
    background: #27ae60;
    color: white;
}

.btn-confirm:hover {
    background: #2ecc71;
}

.btn-cancel {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.btn-cancel:hover {
    background: rgba(255, 255, 255, 0.3);
}
</style>
{% endblock %}
