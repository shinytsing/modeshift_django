{% extends 'base.html' %}
{% load static %}

{% block title %}Clashå†…åµŒä»£ç†ç³»ç»Ÿ{% endblock %}

{% block extra_css %}
<style>
/* Clashä»ªè¡¨æ¿æ ·å¼ */
.clash-container {
    min-height: 100vh;
    background: linear-gradient(135deg, #0a0e17 0%, #1a1f2e 100%);
    color: #e6e6e6;
    font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
    padding: 2rem;
    position: relative;
    overflow: hidden;
}

.clash-container::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: 
        radial-gradient(circle at 20% 80%, rgba(0, 255, 231, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(0, 191, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(255, 107, 157, 0.05) 0%, transparent 50%);
    z-index: -1;
    animation: clashMatrix 25s ease-in-out infinite;
}

@keyframes clashMatrix {
    0%, 100% { 
        transform: translateY(0px) rotate(0deg);
        opacity: 0.8;
    }
    33% { 
        transform: translateY(-10px) rotate(0.5deg);
        opacity: 1;
    }
    66% { 
        transform: translateY(5px) rotate(-0.5deg);
        opacity: 0.9;
    }
}

.clash-header {
    text-align: center;
    margin-bottom: 3rem;
}

.clash-title {
    color: #00ffe7;
    font-size: 3rem;
    font-weight: 700;
    margin-bottom: 1rem;
    letter-spacing: 2px;
    text-shadow: 0 0 20px rgba(0, 255, 231, 0.5);
    animation: clashGlow 2s ease-in-out infinite alternate;
}

@keyframes clashGlow {
    from { text-shadow: 0 0 20px rgba(0, 255, 231, 0.5); }
    to { text-shadow: 0 0 30px rgba(0, 255, 231, 0.8), 0 0 40px rgba(0, 255, 231, 0.3); }
}

.clash-subtitle {
    color: #8a9ba8;
    font-size: 1.2rem;
    margin-bottom: 1rem;
}

/* å®‰å…¨æç¤ºæ ·å¼ */
.security-notice {
    background: rgba(255, 193, 7, 0.1);
    border: 1px solid rgba(255, 193, 7, 0.3);
    border-radius: 8px;
    padding: 12px 20px;
    margin: 1rem auto;
    max-width: 600px;
    backdrop-filter: blur(10px);
}

.notice-content {
    display: flex;
    align-items: center;
    gap: 10px;
    color: #ffc107;
    font-size: 0.9rem;
    font-weight: 500;
}

.notice-content i {
    font-size: 1.1rem;
    color: #ffc107;
}

.clash-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 2rem;
    margin-bottom: 3rem;
}

.clash-card {
    background: linear-gradient(135deg, rgba(26,31,46,0.9) 0%, rgba(0,255,231,0.1) 100%);
    border: 1px solid rgba(0, 255, 231, 0.1);
    border-radius: 16px;
    padding: 2rem;
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.clash-card::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(135deg, #00ffe7 0%, #00bfff 50%, #ff6b9d 100%);
    transform: scaleX(0);
    transition: transform 0.3s ease;
}

.clash-card:hover::after {
    transform: scaleX(1);
}

.clash-card:hover {
    transform: translateY(-4px) scale(1.02);
    border-color: #00ffe7;
    box-shadow: 0 8px 32px rgba(0, 255, 231, 0.2);
}

.clash-card-title {
    color: #00ffe7;
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.clash-card-title i {
    font-size: 1.2rem;
}

.clash-btn {
    background: linear-gradient(135deg, #00ffe7 0%, #00bfff 50%, #ff6b9d 100%);
    color: #0a0e17;
    border: none;
    border-radius: 8px;
    padding: 0.8rem 1.5rem;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: inherit;
    margin: 0.5rem;
}

.clash-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0, 255, 231, 0.3);
}

.clash-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.clash-btn.secondary {
    background: transparent;
    color: #00ffe7;
    border: 2px solid #00ffe7;
}

.clash-btn.secondary:hover {
    background: #00ffe7;
    color: #0a0e17;
}

.clash-btn.danger {
    background: linear-gradient(135deg, #ff4444 0%, #ff6b6b 100%);
}

.clash-btn.success {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
}

.clash-status {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #ff4444;
    animation: pulse 2s infinite;
}

.status-indicator.running {
    background: #00ff41;
}

.status-indicator.starting {
    background: #ffaa00;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.clash-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: rgba(26, 31, 46, 0.8);
    border: 1px solid rgba(0, 255, 231, 0.2);
    border-radius: 8px;
    padding: 1.5rem;
    text-align: center;
}

.stat-number {
    color: #00ffe7;
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.stat-label {
    color: #8a9ba8;
    font-size: 0.9rem;
}

.clash-terminal {
    background: #111417;
    color: #00ffe7;
    font-family: 'Courier New', monospace;
    padding: 1rem;
    border-radius: 8px;
    margin: 1rem 0;
    border: 1px solid rgba(0, 255, 231, 0.3);
    max-height: 400px;
    overflow-y: auto;
}

.clash-terminal::before {
    content: '$ ';
    color: #00bfff;
    font-weight: bold;
}

.proxy-list {
    max-height: 300px;
    overflow-y: auto;
    margin: 1rem 0;
}

.proxy-item {
    background: rgba(26, 31, 46, 0.8);
    border: 1px solid rgba(0, 255, 231, 0.2);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.proxy-info {
    flex: 1;
}

.proxy-name {
    color: #00ffe7;
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.proxy-details {
    color: #8a9ba8;
    font-size: 0.9rem;
}

.proxy-actions {
    display: flex;
    gap: 0.5rem;
}

.proxy-btn {
    background: rgba(0, 255, 231, 0.1);
    color: #00ffe7;
    border: 1px solid rgba(0, 255, 231, 0.3);
    border-radius: 4px;
    padding: 0.25rem 0.5rem;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.proxy-btn:hover {
    background: rgba(0, 255, 231, 0.2);
}

.proxy-btn.active {
    background: #00ffe7;
    color: #0a0e17;
}

.loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(0, 255, 231, 0.3);
    border-radius: 50%;
    border-top-color: #00ffe7;
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .clash-container {
        padding: 1rem;
    }
    
    .clash-title {
        font-size: 2rem;
    }
    
    .clash-grid {
        grid-template-columns: 1fr;
    }
    
    .clash-stats {
        grid-template-columns: repeat(2, 1fr);
    }
}

/* è§£å†³æ–¹æ¡ˆæ˜¾ç¤ºæ ·å¼ */
.solution-container {
    background: rgba(0, 0, 0, 0.8);
    border: 1px solid #333;
    border-radius: 8px;
    padding: 1rem;
    margin-top: 1rem;
    max-height: 600px;
    overflow-y: auto;
}

.solution-item {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 6px;
    padding: 15px;
    margin-bottom: 15px;
    transition: all 0.3s ease;
}

.solution-item:hover {
    background: rgba(255, 255, 255, 0.08);
    border-color: rgba(0, 255, 231, 0.3);
    transform: translateY(-2px);
}

.solution-title {
    color: #00ffe7;
    font-size: 1.1rem;
    font-weight: 600;
    margin: 0 0 8px 0;
}

.solution-description {
    color: #8a9ba8;
    font-size: 0.9rem;
    margin: 0 0 10px 0;
    line-height: 1.4;
}

.difficulty-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 500;
    margin-bottom: 10px;
}

.difficulty-easy {
    background: rgba(40, 167, 69, 0.2);
    color: #28a745;
    border: 1px solid rgba(40, 167, 69, 0.3);
}

.difficulty-medium {
    background: rgba(255, 193, 7, 0.2);
    color: #ffc107;
    border: 1px solid rgba(255, 193, 7, 0.3);
}

.difficulty-hard {
    background: rgba(220, 53, 69, 0.2);
    color: #dc3545;
    border: 1px solid rgba(220, 53, 69, 0.3);
}

.command-block {
    background: rgba(0, 0, 0, 0.6);
    border: 1px solid #333;
    border-radius: 4px;
    padding: 10px;
    margin: 8px 0;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.85rem;
    color: #00ff41;
    overflow-x: auto;
    white-space: pre-wrap;
}

.download-links {
    margin-top: 10px;
}

.download-links ul {
    margin: 5px 0 0 0;
    padding-left: 20px;
}

.download-links li {
    margin-bottom: 5px;
}

.download-links a {
    color: #00bfff;
    text-decoration: none;
    transition: color 0.3s ease;
}

.download-links a:hover {
    color: #00ffe7;
    text-decoration: underline;
}

.manual-guide {
    background: rgba(0, 0, 0, 0.8);
    border: 1px solid #333;
    border-radius: 8px;
    padding: 15px;
    margin-top: 15px;
}

.guide-title {
    color: #ffa500;
    font-size: 1.1rem;
    font-weight: 600;
    margin: 0 0 15px 0;
}

.guide-steps {
    margin-bottom: 15px;
}

.guide-steps ol {
    margin: 0 0 15px 0;
    padding-left: 20px;
}

.guide-steps li {
    margin-bottom: 8px;
    color: #e6e6e6;
    line-height: 1.4;
}

.troubleshooting {
    margin-top: 15px;
}

.troubleshooting ul {
    margin: 0;
    padding-left: 20px;
}

.troubleshooting li {
    margin-bottom: 5px;
    color: #8a9ba8;
    line-height: 1.4;
}
</style>
{% endblock %}

{% block content %}
<div class="clash-container">
    <div class="clash-header">
        <h1 class="clash-title">
            <i class="fas fa-shield-alt"></i>
            Clashå†…åµŒä»£ç†ç³»ç»Ÿ
        </h1>
        <p class="clash-subtitle">ğŸš€ ä¸€é”®å¯åŠ¨Clashä»£ç†ï¼Œè½»æ¾è®¿é—®å¤–ç½‘</p>
        
        <!-- å®‰å…¨æç¤º -->
        <div class="security-notice">
            <div class="notice-content">
                <i class="fas fa-info-circle"></i>
                <span>è¿™æ˜¯å…¬å…±ä»£ç†ç®¡ç†ç•Œé¢ï¼Œæ•æ„Ÿé…ç½®ä¿¡æ¯å·²éšè—ä¿æŠ¤</span>
            </div>
        </div>
    </div>

    <!-- ç³»ç»ŸçŠ¶æ€ -->
    <div class="clash-stats" id="clashStats">
        <div class="stat-card">
            <div class="stat-number" id="clashStatus">æ£€æµ‹ä¸­...</div>
            <div class="stat-label">æœåŠ¡çŠ¶æ€</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="clashUptime">-</div>
            <div class="stat-label">è¿è¡Œæ—¶é—´</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="clashHttpPort">7890</div>
            <div class="stat-label">HTTPç«¯å£</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="clashSocksPort">7891</div>
            <div class="stat-label">SOCKSç«¯å£</div>
        </div>
    </div>

    <!-- ä¸»è¦åŠŸèƒ½ -->
    <div class="clash-grid">
        <!-- æœåŠ¡æ§åˆ¶ -->
        <div class="clash-card">
            <h3 class="clash-card-title">
                <i class="fas fa-power-off"></i>
                æœåŠ¡æ§åˆ¶
            </h3>
            <div class="clash-status">
                <div class="status-indicator" id="statusIndicator"></div>
                <span id="statusText">æ£€æµ‹ä¸­...</span>
            </div>
            <div>
                <button class="clash-btn success" onclick="startClash()" id="startBtn">
                    <i class="fas fa-play"></i>
                    å¯åŠ¨æœåŠ¡
                </button>
                <button class="clash-btn danger" onclick="stopClash()" id="stopBtn">
                    <i class="fas fa-stop"></i>
                    åœæ­¢æœåŠ¡
                </button>
                <button class="clash-btn secondary" onclick="restartClash()" id="restartBtn">
                    <i class="fas fa-redo"></i>
                    é‡å¯æœåŠ¡
                </button>
            </div>
        </div>

        <!-- è¿æ¥æµ‹è¯• -->
        <div class="clash-card">
            <h3 class="clash-card-title">
                <i class="fas fa-network-wired"></i>
                è¿æ¥æµ‹è¯•
            </h3>
            <p>æµ‹è¯•Clashä»£ç†è¿æ¥çŠ¶æ€å’Œç½‘ç»œè®¿é—®èƒ½åŠ›</p>
            <button class="clash-btn" onclick="testConnection()">
                <i class="fas fa-wifi"></i>
                æµ‹è¯•è¿æ¥
            </button>
            <div class="clash-terminal" id="connectionResults"></div>
        </div>

        <!-- ä»£ç†ç®¡ç† -->
        <div class="clash-card" style="grid-column: span 2;">
            <h3 class="clash-card-title">
                <i class="fas fa-server"></i>
                ä»£ç†ç®¡ç†
            </h3>
            <div class="proxy-list" id="proxyList">
                <div class="loading"></div> åŠ è½½ä»£ç†åˆ—è¡¨...
            </div>
        </div>

        <!-- è‡ªåŠ¨å®‰è£… -->
        <div class="clash-card">
            <h3 class="clash-card-title">
                <i class="fas fa-download"></i>
                è‡ªåŠ¨å®‰è£…
            </h3>
            <p>è‡ªåŠ¨æ£€æµ‹ç³»ç»Ÿå¹¶å®‰è£…Clashä»£ç†è½¯ä»¶</p>
            <button class="clash-btn" onclick="installClash()">
                <i class="fas fa-download"></i>
                å®‰è£…Clash
            </button>
            <div class="clash-terminal" id="installResults"></div>
        </div>

        <!-- é…ç½®ç®¡ç† - å·²éšè— -->
        <!--
        <div class="clash-card">
            <h3 class="clash-card-title">
                <i class="fas fa-cog"></i>
                é…ç½®ç®¡ç†
            </h3>
            <p>ç®¡ç†Clashé…ç½®æ–‡ä»¶å’Œä»£ç†è§„åˆ™</p>
            <button class="clash-btn secondary" onclick="showConfig()">
                <i class="fas fa-file-code"></i>
                æŸ¥çœ‹é…ç½®
            </button>
            <button class="clash-btn secondary" onclick="exportConfig()">
                <i class="fas fa-download"></i>
                å¯¼å‡ºé…ç½®
            </button>
        </div>
        -->
    </div>

    <!-- ç»ˆç«¯è¾“å‡º -->
    <div class="clash-terminal" id="clashTerminal">
        Clashå†…åµŒä»£ç†ç³»ç»Ÿå·²å¯åŠ¨...
        è¾“å…¥ 'help' æŸ¥çœ‹å¯ç”¨å‘½ä»¤
    </div>
</div>

<script>
// Clashå†…åµŒä»£ç†ç³»ç»Ÿ
let clashStatus = null;
let proxyList = [];
let statusCheckInterval = null;

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    initializeClashSystem();
    startStatusCheck();
});

// åˆå§‹åŒ–Clashç³»ç»Ÿ
async function initializeClashSystem() {
    try {
        log('æ­£åœ¨åˆå§‹åŒ–Clashå†…åµŒä»£ç†ç³»ç»Ÿ...');
        await checkClashStatus();
        await loadProxyList();
        log('âœ… Clashç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
    } catch (error) {
        log(`âŒ ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
    }
}

// æ£€æŸ¥ClashçŠ¶æ€
async function checkClashStatus() {
    try {
        const response = await fetch('/tools/api/clash/status/');
        const data = await response.json();
        
        if (data.success) {
            clashStatus = data.data;
            updateStatusDisplay();
        } else {
            log(`âŒ è·å–çŠ¶æ€å¤±è´¥: ${data.error}`, 'error');
        }
    } catch (error) {
        log(`âŒ çŠ¶æ€æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
    }
}

// æ›´æ–°çŠ¶æ€æ˜¾ç¤º
function updateStatusDisplay() {
    if (!clashStatus) return;
    
    const statusIndicator = document.getElementById('statusIndicator');
    const statusText = document.getElementById('statusText');
    const clashStatusEl = document.getElementById('clashStatus');
    const clashUptimeEl = document.getElementById('clashUptime');
    
    if (clashStatus.is_running) {
        statusIndicator.className = 'status-indicator running';
        statusText.textContent = 'è¿è¡Œä¸­';
        clashStatusEl.textContent = 'è¿è¡Œä¸­';
        clashStatusEl.style.color = '#00ff41';
        
        if (clashStatus.uptime) {
            clashUptimeEl.textContent = formatUptime(clashStatus.uptime);
        }
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.getElementById('startBtn').disabled = true;
        document.getElementById('stopBtn').disabled = false;
        document.getElementById('restartBtn').disabled = false;
    } else {
        statusIndicator.className = 'status-indicator';
        statusText.textContent = 'å·²åœæ­¢';
        clashStatusEl.textContent = 'å·²åœæ­¢';
        clashStatusEl.style.color = '#ff4444';
        clashUptimeEl.textContent = '-';
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.getElementById('startBtn').disabled = false;
        document.getElementById('stopBtn').disabled = true;
        document.getElementById('restartBtn').disabled = true;
    }
}

// æ ¼å¼åŒ–è¿è¡Œæ—¶é—´
function formatUptime(seconds) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    
    if (hours > 0) {
        return `${hours}h ${minutes}m ${secs}s`;
    } else if (minutes > 0) {
        return `${minutes}m ${secs}s`;
    } else {
        return `${secs}s`;
    }
}

// å¯åŠ¨Clash
async function startClash() {
    try {
        log('æ­£åœ¨å¯åŠ¨ClashæœåŠ¡...');
        document.getElementById('startBtn').innerHTML = '<div class="loading"></div> å¯åŠ¨ä¸­...';
        document.getElementById('startBtn').disabled = true;
        
        const response = await fetch('/tools/api/clash/start/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            log(`âœ… ${data.message}`, 'success');
            await checkClashStatus();
        } else {
            log(`âŒ ${data.error}`, 'error');
        }
    } catch (error) {
        log(`âŒ å¯åŠ¨å¤±è´¥: ${error.message}`, 'error');
    } finally {
        document.getElementById('startBtn').innerHTML = '<i class="fas fa-play"></i> å¯åŠ¨æœåŠ¡';
        document.getElementById('startBtn').disabled = false;
    }
}

// åœæ­¢Clash
async function stopClash() {
    try {
        log('æ­£åœ¨åœæ­¢ClashæœåŠ¡...');
        document.getElementById('stopBtn').innerHTML = '<div class="loading"></div> åœæ­¢ä¸­...';
        document.getElementById('stopBtn').disabled = true;
        
        const response = await fetch('/tools/api/clash/stop/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            log(`âœ… ${data.message}`, 'success');
            await checkClashStatus();
        } else {
            log(`âŒ ${data.error}`, 'error');
        }
    } catch (error) {
        log(`âŒ åœæ­¢å¤±è´¥: ${error.message}`, 'error');
    } finally {
        document.getElementById('stopBtn').innerHTML = '<i class="fas fa-stop"></i> åœæ­¢æœåŠ¡';
        document.getElementById('stopBtn').disabled = false;
    }
}

// é‡å¯Clash
async function restartClash() {
    try {
        log('æ­£åœ¨é‡å¯ClashæœåŠ¡...');
        document.getElementById('restartBtn').innerHTML = '<div class="loading"></div> é‡å¯ä¸­...';
        document.getElementById('restartBtn').disabled = true;
        
        const response = await fetch('/tools/api/clash/restart/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            log(`âœ… ${data.message}`, 'success');
            await checkClashStatus();
        } else {
            log(`âŒ ${data.error}`, 'error');
        }
    } catch (error) {
        log(`âŒ é‡å¯å¤±è´¥: ${error.message}`, 'error');
    } finally {
        document.getElementById('restartBtn').innerHTML = '<i class="fas fa-redo"></i> é‡å¯æœåŠ¡';
        document.getElementById('restartBtn').disabled = false;
    }
}

// æµ‹è¯•è¿æ¥
async function testConnection() {
    try {
        log('æ­£åœ¨æµ‹è¯•Clashè¿æ¥...');
        const resultsDiv = document.getElementById('connectionResults');
        resultsDiv.innerHTML = '<div class="loading"></div> æµ‹è¯•ä¸­...';
        
        const response = await fetch('/tools/api/clash/test-connection/');
        const data = await response.json();
        
        if (data.success) {
            resultsDiv.innerHTML = `<div style="color: #00ff41;">âœ… ${data.message}</div>`;
            log(`âœ… è¿æ¥æµ‹è¯•æˆåŠŸ: ${data.message}`, 'success');
        } else {
            resultsDiv.innerHTML = `<div style="color: #ff4444;">âŒ ${data.error}</div>`;
            log(`âŒ è¿æ¥æµ‹è¯•å¤±è´¥: ${data.error}`, 'error');
        }
    } catch (error) {
        log(`âŒ è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
        document.getElementById('connectionResults').innerHTML = `<div style="color: #ff4444;">âŒ ${error.message}</div>`;
    }
}

// åŠ è½½ä»£ç†åˆ—è¡¨
async function loadProxyList() {
    try {
        const response = await fetch('/tools/api/clash/proxy-info/');
        const data = await response.json();
        
        if (data.success) {
            proxyList = data.data;
            updateProxyListDisplay();
        } else {
            log(`âŒ åŠ è½½ä»£ç†åˆ—è¡¨å¤±è´¥: ${data.error}`, 'error');
        }
    } catch (error) {
        log(`âŒ åŠ è½½ä»£ç†åˆ—è¡¨å¤±è´¥: ${error.message}`, 'error');
    }
}

// æ›´æ–°ä»£ç†åˆ—è¡¨æ˜¾ç¤º
function updateProxyListDisplay() {
    const proxyListDiv = document.getElementById('proxyList');
    
    if (!proxyList || Object.keys(proxyList).length === 0) {
        proxyListDiv.innerHTML = '<div style="color: #8a9ba8;">æš‚æ— ä»£ç†èŠ‚ç‚¹</div>';
        return;
    }
    
    let html = '';
    for (const [groupName, groupData] of Object.entries(proxyList)) {
        if (groupData.type === 'Selector' || groupData.type === 'URLTest') {
            html += `<div style="margin-bottom: 1rem;">`;
            html += `<h4 style="color: #00ffe7; margin-bottom: 0.5rem;">${groupName}</h4>`;
            
            if (groupData.all) {
                for (const proxyName of groupData.all) {
                    const isSelected = groupData.now === proxyName;
                    html += `
                        <div class="proxy-item">
                            <div class="proxy-info">
                                <div class="proxy-name">${proxyName}</div>
                                <div class="proxy-details">ç±»å‹: ${groupData.type}</div>
                            </div>
                            <div class="proxy-actions">
                                <button class="proxy-btn ${isSelected ? 'active' : ''}" 
                                        onclick="switchProxy('${groupName}', '${proxyName}')"
                                        ${isSelected ? 'disabled' : ''}>
                                    ${isSelected ? 'å½“å‰' : 'åˆ‡æ¢'}
                                </button>
                            </div>
                        </div>
                    `;
                }
            }
            html += `</div>`;
        }
    }
    
    proxyListDiv.innerHTML = html || '<div style="color: #8a9ba8;">æš‚æ— å¯ç”¨ä»£ç†</div>';
}

// åˆ‡æ¢ä»£ç†
async function switchProxy(group, proxy) {
    try {
        log(`æ­£åœ¨åˆ‡æ¢åˆ°ä»£ç†: ${proxy}`);
        
        const response = await fetch('/tools/api/clash/switch-proxy/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                group: group,
                proxy: proxy
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            log(`âœ… ${data.message}`, 'success');
            await loadProxyList(); // é‡æ–°åŠ è½½ä»£ç†åˆ—è¡¨
        } else {
            log(`âŒ ${data.error}`, 'error');
        }
    } catch (error) {
        log(`âŒ åˆ‡æ¢ä»£ç†å¤±è´¥: ${error.message}`, 'error');
    }
}

// å®‰è£…Clash
async function installClash() {
    try {
        log('æ­£åœ¨å®‰è£…Clash...');
        const resultsDiv = document.getElementById('installResults');
        resultsDiv.innerHTML = '<div class="loading"></div> å®‰è£…ä¸­...';
        
        const response = await fetch('/tools/api/clash/install/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            resultsDiv.innerHTML = `<div style="color: #00ff41;">âœ… ${data.message}</div>`;
            log(`âœ… å®‰è£…æˆåŠŸ: ${data.message}`, 'success');
        } else {
            // æ˜¾ç¤ºè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œè§£å†³æ–¹æ¡ˆ
            let errorHtml = `<div style="color: #ff4444; margin-bottom: 15px;">âŒ ${data.message || data.error}</div>`;
            
            // å¦‚æœæœ‰è§£å†³æ–¹æ¡ˆï¼Œæ˜¾ç¤ºå®ƒä»¬
            if (data.solutions && data.solutions.length > 0) {
                errorHtml += '<div style="margin-top: 15px;"><h4 style="color: #ffa500; margin-bottom: 10px;">ğŸ’¡ è§£å†³æ–¹æ¡ˆ:</h4>';
                
                data.solutions.forEach((solution, index) => {
                    errorHtml += `
                        <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; padding: 15px; margin-bottom: 10px;">
                            <h5 style="color: #495057; margin: 0 0 8px 0;">${solution.title}</h5>
                            <p style="color: #6c757d; margin: 0 0 10px 0; font-size: 14px;">${solution.description}</p>
                            <span style="background: ${solution.difficulty === 'ç®€å•' ? '#d4edda' : solution.difficulty === 'ä¸­ç­‰' ? '#fff3cd' : '#f8d7da'}; 
                                      color: ${solution.difficulty === 'ç®€å•' ? '#155724' : solution.difficulty === 'ä¸­ç­‰' ? '#856404' : '#721c24'}; 
                                      padding: 2px 8px; border-radius: 12px; font-size: 12px;">${solution.difficulty}</span>
                    `;
                    
                    // æ˜¾ç¤ºå‘½ä»¤
                    if (solution.commands && solution.commands.length > 0) {
                        errorHtml += '<div style="margin-top: 10px;"><strong>å‘½ä»¤:</strong><pre style="background: #e9ecef; padding: 8px; border-radius: 4px; font-size: 12px; margin: 5px 0 0 0; overflow-x: auto;">';
                        solution.commands.forEach(cmd => {
                            errorHtml += `${cmd}\n`;
                        });
                        errorHtml += '</pre></div>';
                    }
                    
                    // æ˜¾ç¤ºä¸‹è½½é“¾æ¥
                    if (solution.links && solution.links.length > 0) {
                        errorHtml += '<div style="margin-top: 10px;"><strong>ä¸‹è½½é“¾æ¥:</strong><ul style="margin: 5px 0 0 0; padding-left: 20px;">';
                        solution.links.forEach(link => {
                            errorHtml += `<li><a href="${link.url}" target="_blank" style="color: #007bff;">${link.name}</a> - ${link.description}</li>`;
                        });
                        errorHtml += '</ul></div>';
                    }
                    
                    errorHtml += '</div>';
                });
                
                errorHtml += '</div>';
            }
            
            // å¦‚æœæœ‰æ‰‹åŠ¨å®‰è£…æŒ‡å—ï¼Œæ˜¾ç¤ºå®ƒ
            if (data.manual_guide) {
                errorHtml += `
                    <div style="margin-top: 15px;">
                        <h4 style="color: #ffa500; margin-bottom: 10px;">ğŸ“– è¯¦ç»†å®‰è£…æŒ‡å— (${data.manual_guide.system_info}):</h4>
                        <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; padding: 15px;">
                            <h5 style="color: #495057; margin: 0 0 10px 0;">å®‰è£…æ­¥éª¤:</h5>
                            <ol style="margin: 0 0 15px 0; padding-left: 20px;">
                `;
                
                data.manual_guide.steps.forEach(step => {
                    errorHtml += `<li style="margin-bottom: 5px;">${step}</li>`;
                });
                
                errorHtml += `
                            </ol>
                            <h5 style="color: #495057; margin: 0 0 10px 0;">æ•…éšœæ’é™¤:</h5>
                            <ul style="margin: 0; padding-left: 20px;">
                `;
                
                data.manual_guide.troubleshooting.forEach(tip => {
                    errorHtml += `<li style="margin-bottom: 5px;">${tip}</li>`;
                });
                
                errorHtml += `
                            </ul>
                        </div>
                    </div>
                `;
            }
            
            resultsDiv.innerHTML = errorHtml;
            log(`âŒ å®‰è£…å¤±è´¥: ${data.message || data.error}`, 'error');
        }
    } catch (error) {
        log(`âŒ å®‰è£…å¤±è´¥: ${error.message}`, 'error');
        document.getElementById('installResults').innerHTML = `<div style="color: #ff4444;">âŒ ${error.message}</div>`;
    }
}

// æ˜¾ç¤ºé…ç½®
async function showConfig() {
    try {
        const response = await fetch('/tools/api/clash/config/');
        const data = await response.json();
        
        if (data.success) {
            const configWindow = window.open('', '_blank', 'width=800,height=600');
            configWindow.document.write(`
                <html>
                <head>
                    <title>Clashé…ç½®</title>
                    <style>
                        body { font-family: monospace; background: #1a1a1a; color: #00ff00; padding: 20px; }
                        pre { background: #000; padding: 15px; border-radius: 5px; overflow-x: auto; }
                    </style>
                </head>
                <body>
                    <h2>Clashé…ç½®æ–‡ä»¶</h2>
                    <pre>${data.data.config}</pre>
                </body>
                </html>
            `);
        } else {
            log(`âŒ è·å–é…ç½®å¤±è´¥: ${data.error}`, 'error');
        }
    } catch (error) {
        log(`âŒ è·å–é…ç½®å¤±è´¥: ${error.message}`, 'error');
    }
}

// å¯¼å‡ºé…ç½®
async function exportConfig() {
    try {
        const response = await fetch('/tools/api/clash/config/');
        const data = await response.json();
        
        if (data.success) {
            const blob = new Blob([data.data.config], { type: 'text/yaml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'clash-config.yaml';
            a.click();
            URL.revokeObjectURL(url);
            log('âœ… é…ç½®å·²å¯¼å‡º', 'success');
        } else {
            log(`âŒ å¯¼å‡ºé…ç½®å¤±è´¥: ${data.error}`, 'error');
        }
    } catch (error) {
        log(`âŒ å¯¼å‡ºé…ç½®å¤±è´¥: ${error.message}`, 'error');
    }
}

// å¼€å§‹çŠ¶æ€æ£€æŸ¥
function startStatusCheck() {
    statusCheckInterval = setInterval(async () => {
        await checkClashStatus();
    }, 5000); // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡çŠ¶æ€
}

// åœæ­¢çŠ¶æ€æ£€æŸ¥
function stopStatusCheck() {
    if (statusCheckInterval) {
        clearInterval(statusCheckInterval);
        statusCheckInterval = null;
    }
}

// æ—¥å¿—è¾“å‡º
function log(message, type = 'info') {
    const terminal = document.getElementById('clashTerminal');
    const timestamp = new Date().toLocaleTimeString();
    const color = type === 'error' ? '#ff4444' : type === 'success' ? '#00ff41' : '#00ffe7';
    
    terminal.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
    terminal.scrollTop = terminal.scrollHeight;
}

// è·å–CSRF Token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// é¡µé¢å¸è½½æ—¶æ¸…ç†
window.addEventListener('beforeunload', function() {
    stopStatusCheck();
});

log('ğŸš€ Clashå†…åµŒä»£ç†ç³»ç»Ÿå·²å¯åŠ¨');
log('ğŸ’¡ ç³»ç»Ÿå°†è‡ªåŠ¨æ£€æµ‹å’Œå¯åŠ¨Clashä»£ç†æœåŠ¡');
</script>
{% endblock %}
