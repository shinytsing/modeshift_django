{% extends 'tools/base_tool.html' %}
{% load static %}

{% block tool_title_inner %}å†¥æƒ³å¼•å¯¼å¸ˆ - å¯»æ‰¾å†…å¿ƒçš„å¹³é™{% endblock %}
{% block tool_title_display %}å†¥æƒ³å¼•å¯¼å¸ˆ - å¯»æ‰¾å†…å¿ƒçš„å¹³é™{% endblock %}

{% block tool_content %}
<div class="meditation-container">
    <div class="meditation-header">
        <h1><i class="fas fa-pray"></i> å†¥æƒ³å¼•å¯¼å¸ˆ</h1>
        <p class="meditation-subtitle">å¯»æ‰¾å†…å¿ƒçš„å¹³é™ï¼Œä¸è‡ªæˆ‘å¯¹è¯</p>
    </div>

    <div class="meditation-content">
        <!-- å†¥æƒ³ç±»å‹é€‰æ‹© -->
        <div class="meditation-types">
            <h3><i class="fas fa-list"></i> é€‰æ‹©å†¥æƒ³ç±»å‹</h3>
            <div class="types-grid">
                <div class="type-card" data-type="breathing">
                    <div class="type-icon">ğŸ«</div>
                    <div class="type-name">å‘¼å¸å†¥æƒ³</div>
                </div>
                <div class="type-card" data-type="mindfulness">
                    <div class="type-icon">ğŸ§˜â€â™€ï¸</div>
                    <div class="type-name">æ­£å¿µå†¥æƒ³</div>
                </div>
                <div class="type-card" data-type="loving">
                    <div class="type-icon">ğŸ’</div>
                    <div class="type-name">æ…ˆå¿ƒå†¥æƒ³</div>
                </div>
                <div class="type-card" data-type="body">
                    <div class="type-icon">ğŸ‘¤</div>
                    <div class="type-name">èº«ä½“æ‰«æ</div>
                </div>
            </div>
        </div>

        <!-- å†¥æƒ³æŒ‡å¯¼ -->
        <div class="meditation-guidance">
            <h3><i class="fas fa-lightbulb"></i> å†¥æƒ³æŒ‡å¯¼</h3>
            <div class="guidance-content" id="guidanceContent">
                <!-- åŠ¨æ€æŒ‡å¯¼å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                <div class="guidance-placeholder">
                    <p>è¯·é€‰æ‹©å†¥æƒ³ç±»å‹æŸ¥çœ‹ç›¸åº”çš„æŒ‡å¯¼å†…å®¹</p>
                </div>
            </div>
        </div>

        <!-- å†¥æƒ³ç»ƒä¹ åŒºåŸŸ -->
        <div class="meditation-practice">
            <h3><i class="fas fa-play-circle"></i> å†¥æƒ³ç»ƒä¹ </h3>
            <div class="practice-area">
                <!-- æ—¶é—´é€‰æ‹© -->
                <div class="time-selection">
                    <h4><i class="fas fa-clock"></i> é€‰æ‹©å†¥æƒ³æ—¶é•¿</h4>
                    <div class="time-options">
                        <button class="time-btn" data-time="300">5åˆ†é’Ÿ</button>
                        <button class="time-btn" data-time="600">10åˆ†é’Ÿ</button>
                        <button class="time-btn" data-time="900">15åˆ†é’Ÿ</button>
                        <button class="time-btn" data-time="1200">20åˆ†é’Ÿ</button>
                        <button class="time-btn" data-time="1800">30åˆ†é’Ÿ</button>
                        <button class="time-btn" data-time="3600">60åˆ†é’Ÿ</button>
                    </div>
                </div>

                <div class="breathing-circle" id="breathingCircle">
                    <div class="circle-inner">
                        <div class="breathing-text" id="breathingText">å‡†å¤‡å¼€å§‹</div>
                        <div class="timer" id="timer">10:00</div>
                    </div>
                </div>
                
                <div class="practice-controls">
                    <button class="control-btn start-btn" onclick="startMeditation()">
                        <i class="fas fa-play"></i> å¼€å§‹å†¥æƒ³
                    </button>
                    <button class="control-btn pause-btn" onclick="pauseMeditation()" style="display: none;">
                        <i class="fas fa-pause"></i> æš‚åœ
                    </button>
                    <button class="control-btn reset-btn" onclick="resetMeditation()">
                        <i class="fas fa-redo"></i> é‡ç½®
                    </button>
                </div>
                
                <!-- å†¥æƒ³éŸ³æ•ˆé€‰æ‹©åŒºåŸŸ -->
                <div class="audio-section">
                    <h4><i class="fas fa-music"></i> å†¥æƒ³éŸ³æ•ˆ</h4>
                    <div class="audio-controls">
                        <div class="meditation-audio-buttons">
                            <button class="meditation-audio-btn" data-category="nature" onclick="selectMeditationAudio('nature')">
                                <i class="fas fa-tree"></i> è‡ªç„¶éŸ³æ•ˆ
                            </button>
                            <button class="meditation-audio-btn" data-category="ambient" onclick="selectMeditationAudio('ambient')">
                                <i class="fas fa-cloud"></i> ç¯å¢ƒéŸ³æ•ˆ
                            </button>
                            <button class="meditation-audio-btn" data-category="instrumental" onclick="selectMeditationAudio('instrumental')">
                                <i class="fas fa-music"></i> å™¨ä¹éŸ³æ•ˆ
                            </button>
                            <button class="meditation-audio-btn" data-category="binaural" onclick="selectMeditationAudio('binaural')">
                                <i class="fas fa-brain"></i> åŒè€³èŠ‚æ‹
                            </button>
                            <button class="meditation-audio-btn" data-category="zen" onclick="selectMeditationAudio('zen')">
                                <i class="fas fa-om"></i> ç¦…æ„éŸ³æ•ˆ
                            </button>
                        </div>
                        <div class="custom-audio-section">
                            <input type="file" id="customAudio" accept="audio/*" style="display: none;">
                            <button class="control-btn upload-btn" onclick="document.getElementById('customAudio').click()">
                                <i class="fas fa-upload"></i> ä¸Šä¼ è‡ªå®šä¹‰éŸ³æ•ˆ
                            </button>
                        </div>
                    </div>
                    <div class="volume-control">
                        <label>éŸ³é‡: <span id="volumeValue">50%</span></label>
                        <input type="range" id="volumeSlider" min="0" max="100" value="50">
                    </div>
                    <div class="current-audio-info" id="currentAudioInfo" style="display: none;">
                        <i class="fas fa-music"></i>
                        <span id="currentAudioText">å½“å‰éŸ³æ•ˆä¿¡æ¯</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* ç”Ÿæ´»æ¨¡å¼ä¸»é¢˜èƒŒæ™¯ */
body {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #f5576c 75%, #4facfe 100%);
  min-height: 100vh;
  position: relative;
  overflow-x: hidden;
  /* æ€§èƒ½ä¼˜åŒ– */
  will-change: auto;
  transform: translateZ(0);
}

/* æµ®åŠ¨çˆ±å¿ƒèƒŒæ™¯ */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: 
    radial-gradient(circle at 20% 80%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 40% 60%, rgba(255, 255, 255, 0.05) 0%, transparent 50%);
  z-index: -1;
  /* å‡å°‘åŠ¨ç”»å¤æ‚åº¦ï¼Œåªåœ¨ç”¨æˆ·äº¤äº’æ—¶æ’­æ”¾ */
  animation: none;
  /* æ€§èƒ½ä¼˜åŒ– */
  will-change: auto;
  transform: translateZ(0);
}

/* åªåœ¨ç”¨æˆ·æ‚¬åœæ—¶æ’­æ”¾åŠ¨ç”» */
body:hover::before {
  animation: lifePulse 4s ease-in-out infinite;
}

@keyframes lifePulse {
  0%, 100% { 
    transform: scale(1) rotate(0deg);
    opacity: 0.8;
  }
  50% { 
    transform: scale(1.01) rotate(0.3deg);
    opacity: 1;
  }
}

.meditation-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px;
    position: relative;
    z-index: 1;
    color: #ffffff;
}

.meditation-header {
    text-align: center;
    margin-bottom: 40px;
    padding: 40px 0;
}

.meditation-header h1 {
    font-size: 3rem;
    font-weight: 900;
    color: #ffffff;
    margin-bottom: 10px;
    text-shadow: 0 2px 10px rgba(0,0,0,0.3);
    animation: titleGlow 3s ease-in-out infinite;
}

@keyframes titleGlow {
  0%, 100% { text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
  50% { text-shadow: 0 2px 20px rgba(255,255,255,0.5); }
}

.meditation-header h1 i {
    font-size: 2.5rem;
    animation: float 3s ease-in-out infinite;
}

@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-10px); }
}

.meditation-subtitle {
    font-size: 1.2rem;
    color: rgba(255,255,255,0.9);
    text-shadow: 0 1px 3px rgba(0,0,0,0.3);
    animation: subtitleFloat 4s ease-in-out infinite;
}

@keyframes subtitleFloat {
  0%, 100% { transform: translateY(0px); opacity: 0.9; }
  50% { transform: translateY(-5px); opacity: 1; }
}

.meditation-content {
    display: grid;
    gap: 30px;
}

.meditation-types, .meditation-practice, .meditation-guidance {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
    border: 2px solid rgba(255, 255, 255, 0.2);
    border-radius: 20px;
    padding: 30px;
    backdrop-filter: blur(20px);
    box-shadow: 0 10px 30px rgba(255, 255, 255, 0.1);
    transition: all 0.4s ease;
    /* æ€§èƒ½ä¼˜åŒ– */
    will-change: transform;
    transform: translateZ(0);
}

.meditation-types:hover, .meditation-practice:hover, .meditation-guidance:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 40px rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.4);
}

.meditation-types h3, .meditation-practice h3, .meditation-guidance h3 {
    color: #ffffff;
    margin-bottom: 20px;
    font-size: 1.5rem;
    font-weight: 600;
}

.types-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

.type-card {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
    border: 2px solid rgba(255, 255, 255, 0.2);
    border-radius: 15px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
    color: #ffffff;
}

.type-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.4);
}

.type-icon {
    font-size: 2.5rem;
    margin-bottom: 10px;
}

.type-name {
    font-weight: 600;
    font-size: 1.1rem;
}

.practice-area {
    text-align: center;
}

.breathing-circle {
    width: 200px;
    height: 200px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    margin: 0 auto 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
}

.breathing-circle:hover {
    border-color: rgba(255, 255, 255, 0.6);
    box-shadow: 0 10px 25px rgba(255, 255, 255, 0.2);
}

.circle-inner {
    text-align: center;
    color: #ffffff;
}

.breathing-text {
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 10px;
}

.timer {
    font-size: 2rem;
    font-weight: 700;
}

.practice-controls {
    display: flex;
    gap: 15px;
    justify-content: center;
}

.control-btn {
    padding: 12px 24px;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
    color: #ffffff;
    box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
}

.control-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(255, 107, 107, 0.4);
}

.guidance-content {
    display: grid;
    gap: 20px;
}

.guidance-step {
    display: flex;
    align-items: flex-start;
    gap: 15px;
    padding: 15px;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
}

.step-number {
    width: 30px;
    height: 30px;
    background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    color: #ffffff;
    flex-shrink: 0;
}

.step-content h4 {
    color: #ffffff;
    margin: 0 0 5px 0;
    font-size: 1.1rem;
}

.step-content p {
    color: rgba(255, 255, 255, 0.8);
    margin: 0;
    line-height: 1.5;
}

/* æ—¶é—´é€‰æ‹©æ ·å¼ */
.time-selection {
    margin-bottom: 30px;
    padding: 20px;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
    border-radius: 15px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
}

.time-selection h4 {
    color: #ffffff;
    margin-bottom: 15px;
    font-size: 1.2rem;
}

.time-options {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}

.time-btn {
    padding: 10px 20px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 25px;
    background: rgba(255, 255, 255, 0.1);
    color: #ffffff;
    cursor: pointer;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
    font-weight: 600;
}

.time-btn:hover {
    border-color: rgba(255, 255, 255, 0.6);
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-2px);
}

.time-btn.selected {
    border-color: #ff6b6b;
    background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
    box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
}

/* éŸ³æ•ˆæ§åˆ¶æ ·å¼ */
.audio-section {
    margin-top: 30px;
    padding: 20px;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
    border-radius: 15px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
}

.audio-section h4 {
    color: #ffffff;
    margin-bottom: 15px;
    font-size: 1.2rem;
}

.audio-controls {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.meditation-audio-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.meditation-audio-btn {
    padding: 15px 20px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 15px;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
    color: #ffffff;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    backdrop-filter: blur(10px);
}

.meditation-audio-btn:hover {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.1) 100%);
    border-color: rgba(255, 255, 255, 0.5);
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(255, 255, 255, 0.2);
}

.meditation-audio-btn.selected {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.3) 0%, rgba(255, 255, 255, 0.1) 100%);
    border-color: rgba(255, 255, 255, 0.6);
    box-shadow: 0 8px 20px rgba(255, 255, 255, 0.3);
}

.meditation-audio-btn i {
    font-size: 1.5rem;
    margin-bottom: 5px;
}

.custom-audio-section {
    display: flex;
    justify-content: center;
}

.current-audio-info {
    margin-top: 15px;
    padding: 12px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    color: #ffffff;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
    backdrop-filter: blur(10px);
}

.current-audio-info i {
    color: #4CAF50;
}

.volume-control {
    display: flex;
    align-items: center;
    gap: 10px;
}

.volume-control label {
    color: #ffffff;
    font-size: 0.9rem;
    min-width: 80px;
}

.volume-control input[type="range"] {
    flex: 1;
    height: 6px;
    border-radius: 3px;
    background: rgba(255, 255, 255, 0.2);
    outline: none;
}

.volume-control input[type="range"]::-webkit-slider-thumb {
    appearance: none;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: #ff6b6b;
    cursor: pointer;
}

.guidance-placeholder {
    text-align: center;
    padding: 40px;
    color: rgba(255, 255, 255, 0.7);
    font-style: italic;
}

/* å€’è®¡æ—¶åŠ¨ç”» */
.breathing-circle.meditating {
    animation: breathingPulse 4s ease-in-out infinite;
}

/* æš‚åœçŠ¶æ€æ ·å¼ */
.breathing-circle.paused {
    border-color: rgba(255, 193, 7, 0.6);
    background: rgba(255, 193, 7, 0.1);
    box-shadow: 0 0 20px rgba(255, 193, 7, 0.3);
}

@keyframes breathingPulse {
    0%, 100% { 
        transform: scale(1);
        border-color: rgba(255, 255, 255, 0.3);
    }
    50% { 
        transform: scale(1.1);
        border-color: #ff6b6b;
    }
}

@keyframes slideIn {
    from { 
        transform: translateX(100%);
        opacity: 0;
    }
    to { 
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOut {
    from { 
        transform: translateX(0);
        opacity: 1;
    }
    to { 
        transform: translateX(100%);
        opacity: 0;
    }
}

/* å®Œæˆé€šçŸ¥æ ·å¼ */
.completion-notification {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    animation: fadeIn 0.3s ease;
}

.notification-content {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 40px;
    border-radius: 20px;
    text-align: center;
    color: #ffffff;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    animation: slideIn 0.5s ease;
    max-width: 400px;
    width: 90%;
}

.notification-content i {
    font-size: 3rem;
    color: #4CAF50;
    margin-bottom: 20px;
}

.notification-content h3 {
    font-size: 1.8rem;
    margin-bottom: 15px;
    color: #ffffff;
}

.notification-content p {
    font-size: 1.1rem;
    margin-bottom: 25px;
    color: rgba(255, 255, 255, 0.9);
}

.notification-content button {
    background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
    border: none;
    padding: 12px 30px;
    border-radius: 25px;
    color: #ffffff;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.notification-content button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(255, 107, 107, 0.4);
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideIn {
    from { 
        transform: translateY(-50px);
        opacity: 0;
    }
    to { 
        transform: translateY(0);
        opacity: 1;
    }
}

/* æ·»åŠ æ»šåŠ¨æ€§èƒ½ä¼˜åŒ– */
@media (prefers-reduced-motion: reduce) {
  * {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}
</style>

<script>
let currentType = null;
let isMeditating = false;
let isPaused = false;
let meditationTimer = null;
let selectedTime = 600; // é»˜è®¤10åˆ†é’Ÿ
let totalSeconds = 600;
let remainingSeconds = 600;
let audioPlayer = null;
let customAudioUrl = null;

// å†¥æƒ³æŒ‡å¯¼å†…å®¹
const guidanceContent = {
    breathing: [
        { title: "å‡†å¤‡å§¿åŠ¿", description: "ååœ¨å«å­ä¸Šæˆ–æ¤…å­ä¸Šï¼Œä¿æŒèƒŒéƒ¨æŒºç›´ä½†ä¸åƒµç¡¬ï¼ŒåŒæ‰‹è‡ªç„¶æ”¾åœ¨è†ç›–ä¸Šã€‚" },
        { title: "è°ƒæ•´å‘¼å¸", description: "é—­ä¸Šçœ¼ç›ï¼Œå¼€å§‹æ·±å‘¼å¸ã€‚å¸æ°”æ—¶æ•°1-4ï¼Œå‘¼æ°”æ—¶æ•°1-6ï¼Œè®©å‘¼å¸å˜å¾—ç¼“æ…¢è€Œå‡åŒ€ã€‚" },
        { title: "ä¸“æ³¨å‘¼å¸", description: "å°†æ³¨æ„åŠ›å®Œå…¨é›†ä¸­åœ¨å‘¼å¸ä¸Šï¼Œæ„Ÿå—ç©ºæ°”è¿›å…¥å’Œç¦»å¼€èº«ä½“çš„æ„Ÿè§‰ã€‚" },
        { title: "ä¿æŒä¸“æ³¨", description: "å½“æ€ç»ªé£˜æ•£æ—¶ï¼Œæ¸©æŸ”åœ°å°†æ³¨æ„åŠ›å¸¦å›åˆ°å‘¼å¸ä¸Šï¼Œä¸è¦è¯„åˆ¤è‡ªå·±ã€‚" },
        { title: "ç»“æŸå†¥æƒ³", description: "æ…¢æ…¢çå¼€çœ¼ç›ï¼Œæ„Ÿå—å†…å¿ƒçš„å¹³é™å’Œä¸“æ³¨ã€‚" }
    ],
    mindfulness: [
        { title: "æ­£å¿µå‡†å¤‡", description: "æ‰¾åˆ°ä¸€ä¸ªèˆ’é€‚çš„å§¿åŠ¿ï¼Œä¿æŒèƒŒéƒ¨æŒºç›´ï¼ŒåŒæ‰‹è‡ªç„¶æ”¾ç½®ã€‚" },
        { title: "èº«ä½“æ‰«æ", description: "ä»å¤´é¡¶å¼€å§‹ï¼Œé€ä¸€æ„Ÿå—èº«ä½“çš„æ¯ä¸ªéƒ¨ä½ï¼Œé‡Šæ”¾ç´§å¼ å’Œå‹åŠ›ã€‚" },
        { title: "è§‚å¯Ÿæ€ç»ª", description: "è§‚å¯Ÿè„‘æµ·ä¸­å‡ºç°çš„æƒ³æ³•ï¼Œå°±åƒçœ‹äº‘æœµé£˜è¿‡å¤©ç©ºï¼Œä¸æ‰§ç€ä¹Ÿä¸æŠ—æ‹’ã€‚" },
        { title: "å½“ä¸‹è§‰å¯Ÿ", description: "ä¸“æ³¨äºå½“ä¸‹çš„æ„Ÿå—ï¼Œæ— è®ºæ˜¯å£°éŸ³ã€è§¦è§‰è¿˜æ˜¯å†…å¿ƒçš„æƒ…ç»ªã€‚" },
        { title: "æ…ˆæ‚²å¿ƒ", description: "å¯¹è‡ªå·±å’Œä»–äººä¿æŒæ…ˆæ‚²å¿ƒï¼Œæ¥çº³ä¸€åˆ‡å¦‚å…¶æ‰€æ˜¯ã€‚" }
    ],
    loving: [
        { title: "æ…ˆå¿ƒå‡†å¤‡", description: "ååœ¨èˆ’é€‚çš„ä½ç½®ï¼Œé—­ä¸Šçœ¼ç›ï¼Œæƒ³è±¡å¿ƒä¸­æœ‰ä¸€ç›æ¸©æš–çš„ç¯ã€‚" },
        { title: "å¯¹è‡ªå·±æ…ˆæ‚²", description: "é¦–å…ˆå¯¹è‡ªå·±è¯´ï¼šæ„¿æˆ‘å¹³å®‰ï¼Œæ„¿æˆ‘å¥åº·ï¼Œæ„¿æˆ‘å¿«ä¹ï¼Œæ„¿æˆ‘è‡ªåœ¨ã€‚" },
        { title: "å¯¹äº²äººæ…ˆæ‚²", description: "æƒ³è±¡ä½ çˆ±çš„äººï¼Œå¯¹ä»–ä»¬è¯´ï¼šæ„¿ä½ å¹³å®‰ï¼Œæ„¿ä½ å¥åº·ï¼Œæ„¿ä½ å¿«ä¹ï¼Œæ„¿ä½ è‡ªåœ¨ã€‚" },
        { title: "å¯¹æ‰€æœ‰äººæ…ˆæ‚²", description: "å°†æ…ˆæ‚²å¿ƒæ‰©å±•åˆ°æ‰€æœ‰äººï¼šæ„¿æ‰€æœ‰äººå¹³å®‰ï¼Œæ„¿æ‰€æœ‰äººå¥åº·ï¼Œæ„¿æ‰€æœ‰äººå¿«ä¹ã€‚" },
        { title: "å›å‘åŠŸå¾·", description: "å°†å†¥æƒ³çš„åŠŸå¾·å›å‘ç»™æ‰€æœ‰ä¼—ç”Ÿï¼Œæ„¿ä¸–ç•Œå……æ»¡çˆ±ä¸å’Œå¹³ã€‚" }
    ],
    body: [
        { title: "èº«ä½“æ‰«æå‡†å¤‡", description: "å¹³èººæˆ–åç€ï¼Œé—­ä¸Šçœ¼ç›ï¼Œå¼€å§‹èº«ä½“æ‰«æå†¥æƒ³ã€‚" },
        { title: "ä»å¤´å¼€å§‹", description: "ä»å¤´é¡¶å¼€å§‹ï¼Œæ„Ÿå—å¤´éƒ¨çš„é‡é‡å’Œæ¸©åº¦ï¼Œé‡Šæ”¾ä»»ä½•ç´§å¼ ã€‚" },
        { title: "é€éƒ¨ä½æ‰«æ", description: "ä¾æ¬¡æ„Ÿå—é¢éƒ¨ã€é¢ˆéƒ¨ã€è‚©è†€ã€æ‰‹è‡‚ã€èƒ¸éƒ¨ã€è…¹éƒ¨ã€è…¿éƒ¨ã€è„šéƒ¨ã€‚" },
        { title: "æ·±åº¦æ”¾æ¾", description: "åœ¨æ¯ä¸ªéƒ¨ä½åœç•™å‡ ç§’é’Ÿï¼Œæ„Ÿå—æ”¾æ¾çš„æ„Ÿè§‰å‘å…¨èº«æ‰©æ•£ã€‚" },
        { title: "æ•´ä½“æ„Ÿå—", description: "æ„Ÿå—æ•´ä¸ªèº«ä½“çš„æ”¾æ¾å’Œèˆ’é€‚ï¼Œäº«å—è¿™ç§æ·±åº¦çš„ä¼‘æ¯ã€‚" }
    ]
};

// å†¥æƒ³éŸ³æ•ˆé…ç½®
const meditationAudioCategories = {
    nature: { name: 'è‡ªç„¶éŸ³æ•ˆ', icon: 'fas fa-tree', desc: 'å¤§è‡ªç„¶çš„å£°éŸ³ï¼Œå¸®åŠ©æ”¾æ¾èº«å¿ƒ' },
    ambient: { name: 'ç¯å¢ƒéŸ³æ•ˆ', icon: 'fas fa-cloud', desc: 'èˆ’ç¼“çš„ç¯å¢ƒéŸ³æ•ˆï¼Œè¥é€ å†¥æƒ³æ°›å›´' },
    instrumental: { name: 'å™¨ä¹éŸ³æ•ˆ', icon: 'fas fa-music', desc: 'è½»æŸ”çš„å™¨ä¹å£°ï¼Œå¼•å¯¼å†…å¿ƒå¹³é™' },
    binaural: { name: 'åŒè€³èŠ‚æ‹', icon: 'fas fa-brain', desc: 'åŒè€³èŠ‚æ‹éŸ³æ•ˆï¼Œä¿ƒè¿›æ·±åº¦æ”¾æ¾' },
    zen: { name: 'ç¦…æ„éŸ³æ•ˆ', icon: 'fas fa-om', desc: 'ç¦…æ„éŸ³æ•ˆï¼Œè¥é€ å®é™æ°›å›´' }
};

let currentAudioMode = null;
let currentAudioInfo = null;

document.addEventListener('DOMContentLoaded', function() {
    initializeTypeSelector();
    initializeTimeSelector();
    initializeVolumeControl();
    initializeCustomAudio();
});

function initializeTypeSelector() {
    const typeCards = document.querySelectorAll('.type-card');
    typeCards.forEach(card => {
        card.addEventListener('click', function() {
            typeCards.forEach(c => c.classList.remove('selected'));
            this.classList.add('selected');
            currentType = this.dataset.type;
            updateGuidance();
        });
    });
}

function initializeTimeSelector() {
    const timeButtons = document.querySelectorAll('.time-btn');
    timeButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            timeButtons.forEach(b => b.classList.remove('selected'));
            this.classList.add('selected');
            selectedTime = parseInt(this.dataset.time);
            totalSeconds = selectedTime;
            remainingSeconds = selectedTime;
            document.getElementById('timer').textContent = formatTime(remainingSeconds);
        });
    });
    
    // é»˜è®¤é€‰æ‹©10åˆ†é’Ÿ
    document.querySelector('[data-time="600"]').classList.add('selected');
}

// é€‰æ‹©å†¥æƒ³éŸ³æ•ˆ
async function selectMeditationAudio(category) {
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    document.querySelectorAll('.meditation-audio-btn').forEach(btn => {
        btn.classList.remove('selected');
    });
    document.querySelector(`[data-category="${category}"]`).classList.add('selected');
    
    currentAudioMode = category;
    
    try {
        // è°ƒç”¨å†¥æƒ³éŸ³æ•ˆAPIè·å–å¯¹åº”ç±»åˆ«çš„éŸ³æ•ˆ
        const response = await fetch(`/tools/api/meditation-audio/?category=${category}&action=random`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const data = await response.json();
        
        if (data.success && data.data) {
            const sound = data.data;
            currentAudioInfo = sound;
            
            // åœæ­¢å½“å‰æ’­æ”¾çš„éŸ³é¢‘
            if (audioPlayer) {
                audioPlayer.pause();
                audioPlayer = null;
            }
            
            // æ’­æ”¾æ–°çš„éŸ³é¢‘
            audioPlayer = new Audio(sound.play_url);
            audioPlayer.loop = true;
            audioPlayer.volume = document.getElementById('volumeSlider').value / 100;
            
            audioPlayer.play().then(() => {
                // æ˜¾ç¤ºå½“å‰éŸ³æ•ˆä¿¡æ¯
                document.getElementById('currentAudioInfo').style.display = 'flex';
                document.getElementById('currentAudioText').textContent = `${sound.name} - ${sound.artist}`;
                
                showNotification(`ğŸµ å·²åˆ‡æ¢åˆ°${meditationAudioCategories[category].name}éŸ³æ•ˆ`, 'success');
            }).catch(error => {

                showNotification(`ğŸµ éŸ³æ•ˆè·å–æˆåŠŸï¼Œä½†æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥`, 'warning');
                
                // æ˜¾ç¤ºéŸ³æ•ˆä¿¡æ¯ï¼ˆå³ä½¿æ’­æ”¾å¤±è´¥ï¼‰
                document.getElementById('currentAudioInfo').style.display = 'flex';
                document.getElementById('currentAudioText').textContent = `${sound.name} - ${sound.artist}`;
            });
            
        } else {
            showNotification(`âŒ è·å–${meditationAudioCategories[category].name}éŸ³æ•ˆå¤±è´¥`, 'error');
        }
    } catch (error) {
        console.error('è·å–éŸ³æ•ˆå¤±è´¥:', error);
        showNotification(`âŒ ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•è·å–${meditationAudioCategories[category].name}éŸ³æ•ˆ`, 'error');
    }
}

function initializeVolumeControl() {
    const volumeSlider = document.getElementById('volumeSlider');
    const volumeValue = document.getElementById('volumeValue');
    
    volumeSlider.addEventListener('input', function() {
        const volume = this.value;
        volumeValue.textContent = volume + '%';
        if (audioPlayer) {
            audioPlayer.volume = volume / 100;
        }
    });
}

function initializeCustomAudio() {
    const customAudioInput = document.getElementById('customAudio');
    customAudioInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            // éªŒè¯æ–‡ä»¶ç±»å‹
            if (!file.type.startsWith('audio/')) {
                showNotification('âŒ è¯·é€‰æ‹©éŸ³é¢‘æ–‡ä»¶', 'error');
                return;
            }
            
            // éªŒè¯æ–‡ä»¶å¤§å°ï¼ˆæœ€å¤§50MBï¼‰
            if (file.size > 50 * 1024 * 1024) {
                showNotification('âŒ éŸ³é¢‘æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº50MBçš„æ–‡ä»¶', 'error');
                return;
            }
            
            customAudioUrl = URL.createObjectURL(file);
            playCustomAudio();
        }
    });
}



function playCustomAudio() {
    if (customAudioUrl) {
        // æ¸…é™¤æŒ‰é’®é€‰æ‹©çŠ¶æ€
        document.querySelectorAll('.meditation-audio-btn').forEach(btn => {
            btn.classList.remove('selected');
        });
        
        if (audioPlayer) {
            audioPlayer.pause();
        }
        audioPlayer = new Audio(customAudioUrl);
        audioPlayer.loop = true;
        audioPlayer.volume = document.getElementById('volumeSlider').value / 100;
        
        audioPlayer.play().then(() => {
            // æ˜¾ç¤ºå½“å‰éŸ³æ•ˆä¿¡æ¯
            document.getElementById('currentAudioInfo').style.display = 'flex';
            document.getElementById('currentAudioText').textContent = 'è‡ªå®šä¹‰å†¥æƒ³éŸ³æ•ˆ';
            
            showNotification('ğŸµ è‡ªå®šä¹‰å†¥æƒ³éŸ³æ•ˆæ’­æ”¾æˆåŠŸ', 'success');
        }).catch(e => {

            showNotification('âŒ è‡ªå®šä¹‰å†¥æƒ³éŸ³æ•ˆæ’­æ”¾å¤±è´¥', 'error');
        });
    }
}

// è·å–CSRF Token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// æ˜¾ç¤ºé€šçŸ¥
function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 8px;
        color: white;
        font-size: 14px;
        z-index: 10000;
        animation: slideIn 0.3s ease;
        ${type === 'success' ? 'background: #4CAF50;' : ''}
        ${type === 'error' ? 'background: #f44336;' : ''}
        ${type === 'warning' ? 'background: #ff9800;' : ''}
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            if (document.body.contains(notification)) {
                document.body.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

function updateGuidance() {
    const guidanceElement = document.getElementById('guidanceContent');
    if (currentType && guidanceContent[currentType]) {
        const steps = guidanceContent[currentType];
        let html = '';
        steps.forEach((step, index) => {
            html += `
                <div class="guidance-step">
                    <div class="step-number">${index + 1}</div>
                    <div class="step-content">
                        <h4>${step.title}</h4>
                        <p>${step.description}</p>
                    </div>
                </div>
            `;
        });
        guidanceElement.innerHTML = html;
    } else {
        guidanceElement.innerHTML = '<div class="guidance-placeholder"><p>è¯·é€‰æ‹©å†¥æƒ³ç±»å‹æŸ¥çœ‹ç›¸åº”çš„æŒ‡å¯¼å†…å®¹</p></div>';
    }
}

function startMeditation() {
    if (!currentType) {
        alert('è¯·å…ˆé€‰æ‹©å†¥æƒ³ç±»å‹');
        return;
    }
    
    if (isMeditating && !isPaused) return;
    
    if (isPaused) {
        // ç»§ç»­å†¥æƒ³
        isPaused = false;
        document.querySelector('.start-btn').style.display = 'none';
        document.querySelector('.pause-btn').style.display = 'inline-block';
        document.getElementById('breathingCircle').classList.add('meditating');
        document.getElementById('breathingCircle').classList.remove('paused');
        document.getElementById('breathingText').textContent = 'å†¥æƒ³ä¸­...';
        
        // æ¢å¤éŸ³é¢‘æ’­æ”¾
        if (audioPlayer && audioPlayer.paused) {
            audioPlayer.play().catch(error => {

            });
        }
        
        startTimer();
    } else {
        // å¼€å§‹å†¥æƒ³
        isMeditating = true;
        isPaused = false;
        document.getElementById('breathingText').textContent = 'å†¥æƒ³ä¸­...';
        document.querySelector('.start-btn').style.display = 'none';
        document.querySelector('.pause-btn').style.display = 'inline-block';
        document.getElementById('breathingCircle').classList.add('meditating');
        startTimer();
    }
}

function pauseMeditation() {
    if (!isMeditating) return;
    
    isPaused = true;
    document.getElementById('breathingText').textContent = 'å·²æš‚åœ';
    document.querySelector('.start-btn').style.display = 'inline-block';
    document.querySelector('.pause-btn').style.display = 'none';
    document.getElementById('breathingCircle').classList.remove('meditating');
    document.getElementById('breathingCircle').classList.add('paused');
    
    // æš‚åœéŸ³é¢‘æ’­æ”¾
    if (audioPlayer && !audioPlayer.paused) {
        audioPlayer.pause();
    }
    
    clearInterval(meditationTimer);
}

function resetMeditation() {
    isMeditating = false;
    isPaused = false;
    remainingSeconds = selectedTime;
    totalSeconds = selectedTime;
    
    document.getElementById('breathingText').textContent = 'å‡†å¤‡å¼€å§‹';
    document.getElementById('timer').textContent = formatTime(remainingSeconds);
    document.querySelector('.start-btn').style.display = 'inline-block';
    document.querySelector('.pause-btn').style.display = 'none';
    document.getElementById('breathingCircle').classList.remove('meditating');
    document.getElementById('breathingCircle').classList.remove('paused');
    
    clearInterval(meditationTimer);
    
    // åœæ­¢éŸ³é¢‘
    if (audioPlayer) {
        audioPlayer.pause();
        audioPlayer = null;
    }
}

function startTimer() {
    clearInterval(meditationTimer);
    meditationTimer = setInterval(() => {
        remainingSeconds--;
        document.getElementById('timer').textContent = formatTime(remainingSeconds);
        
        if (remainingSeconds <= 0) {
            completeMeditation();
        }
    }, 1000);
}

function formatTime(seconds) {
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    // å°†ç§’æ•°æ ¼å¼åŒ–ä¸ºå°æ•°ç‚¹åä¸¤ä½
    const formattedSeconds = remainingSeconds.toFixed(2);
    return `${minutes.toString().padStart(2, '0')}:${formattedSeconds}`;
}

function completeMeditation() {
    clearInterval(meditationTimer);
    isMeditating = false;
    isPaused = false;
    
    document.getElementById('breathingText').textContent = 'å†¥æƒ³å®Œæˆ';
    document.getElementById('timer').textContent = '00:00';
    document.querySelector('.start-btn').style.display = 'inline-block';
    document.querySelector('.pause-btn').style.display = 'none';
    document.getElementById('breathingCircle').classList.remove('meditating');
    document.getElementById('breathingCircle').classList.remove('paused');
    
    // åœæ­¢éŸ³é¢‘
    if (audioPlayer) {
        audioPlayer.pause();
        audioPlayer = null;
    }
    
    // æ’­æ”¾å®Œæˆæç¤ºéŸ³
    playCompletionSound();
    
    // æ˜¾ç¤ºå®Œæˆé€šçŸ¥
    setTimeout(() => {
        showCompletionNotification();
    }, 500);
}

function playCompletionSound() {
    // åˆ›å»ºæç¤ºéŸ³ï¼ˆä½¿ç”¨Web Audio APIï¼‰
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        // è®¾ç½®æç¤ºéŸ³å‚æ•°
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
        oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime + 0.2);
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.3);
    } catch (e) {

        // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ç®€å•çš„éŸ³é¢‘æ–‡ä»¶
        const completionSound = new Audio('/static/audio/thursday.mp3');
        completionSound.volume = 0.3;
        completionSound.play().catch(e => {
            // å¤‡ç”¨æç¤ºéŸ³æ’­æ”¾å¤±è´¥
        });
    }
}

function showCompletionNotification() {
    // åˆ›å»ºå®Œæˆé€šçŸ¥
    const notification = document.createElement('div');
    notification.className = 'completion-notification';
    notification.innerHTML = `
        <div class="notification-content">
            <i class="fas fa-check-circle"></i>
            <h3>å†¥æƒ³å®Œæˆï¼</h3>
            <p>æ­å–œæ‚¨å®Œæˆäº† ${formatTime(selectedTime)} çš„å†¥æƒ³ç»ƒä¹ </p>
            <button onclick="this.parentElement.parentElement.remove()">ç¡®å®š</button>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // 3ç§’åè‡ªåŠ¨ç§»é™¤
    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 5000);
}
</script>
{% endblock %} 