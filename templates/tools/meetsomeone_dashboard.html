{% extends 'base.html' %}
{% load static %}

{% block tool_title_inner %}MeeSomeone äººé™…æ¡£æ¡ˆ{% endblock %}
{% block tool_title_display %}MeeSomeone äººé™…æ¡£æ¡ˆ{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'emo.css' %}">
<style>
/* MeeSomeone ä¸“å±æ ·å¼ */
.meetsomeone-container {
  min-height: 100vh;
  background: var(--emo-bg);
  padding: 2rem;
  font-family: var(--emo-font);
}

.meetsomeone-header {
  text-align: center;
  margin-bottom: 3rem;
  padding: 2rem 0;
}

.meetsomeone-title {
  color: var(--emo-primary);
  font-size: 3rem;
  font-weight: 700;
  margin-bottom: 1rem;
  text-shadow: 0 0 20px rgba(156, 39, 176, 0.3);
}

.meetsomeone-subtitle {
  color: var(--emo-text-muted);
  font-size: 1.2rem;
  margin-bottom: 2rem;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 2rem;
  margin-bottom: 3rem;
}

.stat-card {
  background: var(--emo-gradient-card);
  border: 1px solid var(--emo-border);
  border-radius: var(--emo-radius);
  padding: 2rem;
  text-align: center;
  box-shadow: var(--emo-shadow);
  backdrop-filter: blur(15px);
  transition: all 0.3s ease;
}

.stat-card:hover {
  transform: translateY(-5px);
  box-shadow: var(--emo-shadow-hover);
}

.stat-card.clickable {
  cursor: pointer;
}

.stat-card.clickable:active {
  transform: translateY(-2px);
}

.stat-number {
  font-size: 2.5rem;
  font-weight: 700;
  color: var(--emo-primary);
  margin-bottom: 0.5rem;
}

.stat-label {
  color: var(--emo-text-muted);
  font-size: 1rem;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.section-card {
  background: var(--emo-gradient-card);
  border: 1px solid var(--emo-border);
  border-radius: var(--emo-radius);
  padding: 2rem;
  margin-bottom: 2rem;
  box-shadow: var(--emo-shadow);
  backdrop-filter: blur(15px);
}

.section-title {
  color: var(--emo-primary);
  font-size: 1.5rem;
  font-weight: 600;
  margin-bottom: 1.5rem;
  display: flex;
  align-items: center;
  gap: 1rem;
}

.action-buttons {
  display: flex;
  gap: 1rem;
  margin-bottom: 2rem;
  flex-wrap: wrap;
}

.btn-emo {
  background: var(--emo-gradient);
  color: white;
  border: none;
  padding: 1rem 2rem;
  border-radius: var(--emo-radius);
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  text-transform: uppercase;
  letter-spacing: 1px;
  box-shadow: 0 4px 15px rgba(156, 39, 176, 0.3);
}

.btn-emo:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(156, 39, 176, 0.4);
}

.btn-emo-secondary {
  background: transparent;
  color: var(--emo-primary);
  border: 2px solid var(--emo-primary);
}

.btn-emo-secondary:hover {
  background: var(--emo-primary);
  color: white;
}

.interaction-item {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem;
  background: rgba(255, 255, 255, 0.1);
  border-radius: var(--emo-radius);
  margin-bottom: 1rem;
  transition: all 0.3s ease;
}

.interaction-item:hover {
  background: rgba(255, 255, 255, 0.2);
  transform: translateX(5px);
}

.interaction-avatar {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: var(--emo-gradient);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 600;
  font-size: 1.2rem;
}

.interaction-content {
  flex: 1;
}

.interaction-title {
  font-weight: 600;
  color: var(--emo-text);
  margin-bottom: 0.3rem;
}

.interaction-meta {
  color: var(--emo-text-muted);
  font-size: 0.9rem;
}

.reminder-item {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem;
  background: rgba(233, 30, 99, 0.1);
  border-left: 4px solid var(--emo-accent);
  border-radius: 0 var(--emo-radius) var(--emo-radius) 0;
  margin-bottom: 1rem;
}

.reminder-icon {
  color: var(--emo-accent);
  font-size: 1.5rem;
}

.reminder-content {
  flex: 1;
}

.reminder-title {
  font-weight: 600;
  color: var(--emo-text);
  margin-bottom: 0.3rem;
}

.reminder-date {
  color: var(--emo-accent);
  font-size: 0.9rem;
  font-weight: 500;
}

.empty-state {
  text-align: center;
  padding: 3rem;
  color: var(--emo-text-muted);
}

.empty-state i {
  font-size: 3rem;
  margin-bottom: 1rem;
  opacity: 0.5;
}

.loading {
  text-align: center;
  padding: 2rem;
  color: var(--emo-text-muted);
}

.loading i {
  font-size: 2rem;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.main-content {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 2rem;
}

@media (max-width: 768px) {
  .meetsomeone-container {
    padding: 1rem;
  }
  
  .meetsomeone-title {
    font-size: 2rem;
  }
  
  .stats-grid {
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
  }
  
  .main-content {
    grid-template-columns: 1fr;
  }
  
  .action-buttons {
    flex-direction: column;
  }
}

/* æ¨¡æ€æ¡†æ ·å¼ */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  z-index: 1000;
}

.modal-content {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: var(--emo-card-bg);
  border-radius: var(--emo-radius-lg);
  padding: 2rem;
  width: 90%;
  max-width: 600px;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 2rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid var(--emo-border);
}

.modal-title {
  color: var(--emo-primary);
  font-size: 1.5rem;
  font-weight: 600;
}

.close-btn {
  background: none;
  border: none;
  font-size: 1.5rem;
  color: var(--emo-text-muted);
  cursor: pointer;
  transition: color 0.3s ease;
}

.close-btn:hover {
  color: var(--emo-accent);
}

.form-group {
  margin-bottom: 1.5rem;
}

.form-label {
  display: block;
  color: var(--emo-text);
  font-weight: 500;
  margin-bottom: 0.5rem;
}

.form-input {
  width: 100%;
  padding: 1rem;
  border: 1px solid var(--emo-border);
  border-radius: var(--emo-radius);
  background: rgba(255, 255, 255, 0.9);
  color: var(--emo-text);
  font-size: 1rem;
  transition: all 0.3s ease;
}

.form-input:focus {
  outline: none;
  border-color: var(--emo-primary);
  box-shadow: 0 0 10px rgba(156, 39, 176, 0.2);
}

.form-textarea {
  resize: vertical;
  min-height: 100px;
}

.form-select {
  appearance: none;
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
  background-position: right 0.5rem center;
  background-repeat: no-repeat;
  background-size: 1.5em 1.5em;
  padding-right: 2.5rem;
}

.tag-selector {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-top: 0.5rem;
}

.tag-item {
  padding: 0.5rem 1rem;
  background: rgba(156, 39, 176, 0.1);
  border: 1px solid var(--emo-border);
  border-radius: 20px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 0.9rem;
}

.tag-item:hover {
  background: rgba(156, 39, 176, 0.2);
}

.tag-item.selected {
  background: var(--emo-primary);
  color: white;
  border-color: var(--emo-primary);
}

.importance-selector {
  display: flex;
  gap: 0.5rem;
  margin-top: 0.5rem;
}

.star-btn {
  background: none;
  border: none;
  font-size: 1.5rem;
  color: #ddd;
  cursor: pointer;
  transition: color 0.3s ease;
}

.star-btn:hover,
.star-btn.active {
  color: #ffd700;
}
</style>
{% endblock %}

{% block content %}
<div class="meetsomeone-container emo-theme">
  <div class="meetsomeone-header">
    <h1 class="meetsomeone-title">
      <i class="fas fa-users"></i> MeeSomeone
    </h1>
    <p class="meetsomeone-subtitle">ğŸ’œ è®°å½•ç”Ÿå‘½ä¸­çš„æ¯ä¸€ä¸ªé‡è¦è¿æ¥</p>
  </div>

  <!-- ç»Ÿè®¡æ•°æ® -->
  <div class="stats-grid" id="statsGrid">
    <div class="loading">
      <i class="fas fa-spinner"></i>
      <p>åŠ è½½ç»Ÿè®¡æ•°æ®ä¸­...</p>
    </div>
  </div>

  <!-- æ“ä½œæŒ‰é’® -->
  <div class="action-buttons">
    <button class="btn-emo" onclick="openCreatePersonModal()">
      <i class="fas fa-user-plus"></i> æ–°å»ºæ¡£æ¡ˆ
    </button>
    <button class="btn-emo" onclick="openCreateInteractionModal()">
      <i class="fas fa-comments"></i> è®°å½•äº’åŠ¨
    </button>
    <button class="btn-emo" onclick="openCreateMomentModal()">
      <i class="fas fa-star"></i> é‡è¦æ—¶åˆ»
    </button>
    <button class="btn-emo btn-emo-secondary" onclick="window.location.href='{% url 'tools:meetsomeone_timeline' %}'">
      <i class="fas fa-clock"></i> æ—¶å…‰è½´
    </button>
    <button class="btn-emo btn-emo-secondary" onclick="window.location.href='{% url 'tools:meetsomeone_graph' %}'">
      <i class="fas fa-project-diagram"></i> å…³ç³»å›¾è°±
    </button>
  </div>

  <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
  <div class="main-content">
    <!-- å·¦ä¾§ï¼šæœ€è¿‘äº’åŠ¨ -->
    <div class="section-card">
      <h2 class="section-title">
        <i class="fas fa-clock"></i> æœ€è¿‘äº’åŠ¨
      </h2>
      <div id="recentInteractions">
        <div class="loading">
          <i class="fas fa-spinner"></i>
          <p>åŠ è½½äº’åŠ¨è®°å½•ä¸­...</p>
        </div>
      </div>
    </div>

    <!-- å³ä¾§ï¼šå¾…åŠæé†’ -->
    <div class="section-card">
      <h2 class="section-title">
        <i class="fas fa-bell"></i> å¾…åŠæé†’
      </h2>
      <div id="pendingReminders">
        <div class="loading">
          <i class="fas fa-spinner"></i>
          <p>åŠ è½½æé†’äº‹é¡¹ä¸­...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- åˆ›å»ºäººç‰©æ¡£æ¡ˆæ¨¡æ€æ¡† -->
<div id="createPersonModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">åˆ›å»ºäººç‰©æ¡£æ¡ˆ</h3>
      <button class="close-btn" onclick="closeCreatePersonModal()">&times;</button>
    </div>
    <form id="createPersonForm">
      <div class="form-group">
        <label class="form-label" for="personName">å§“å *</label>
        <input type="text" id="personName" class="form-input" required>
      </div>
      
      <div class="form-group">
        <label class="form-label" for="personNickname">æ˜µç§°/å¤‡æ³¨å</label>
        <input type="text" id="personNickname" class="form-input">
      </div>
      
      <div class="form-group">
        <label class="form-label" for="personImportance">é‡è¦ç¨‹åº¦</label>
        <div class="importance-selector">
          <button type="button" class="star-btn" data-value="1">â­</button>
          <button type="button" class="star-btn" data-value="2">â­</button>
          <button type="button" class="star-btn" data-value="3">â­</button>
          <button type="button" class="star-btn" data-value="4">â­</button>
          <button type="button" class="star-btn" data-value="5">â­</button>
        </div>
        <input type="hidden" id="personImportance" value="3">
      </div>
      
      <div class="form-group">
        <label class="form-label">å…³ç³»æ ‡ç­¾</label>
        <div id="relationshipTags" class="tag-selector">
          <!-- æ ‡ç­¾å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
        </div>
      </div>
      
      <div class="form-group">
        <label class="form-label" for="firstMetDate">è®¤è¯†æ—¥æœŸ</label>
        <input type="date" id="firstMetDate" class="form-input">
      </div>
      
      <div class="form-group">
        <label class="form-label" for="firstMetLocation">è®¤è¯†åœºæ™¯</label>
        <input type="text" id="firstMetLocation" class="form-input" placeholder="å¦‚ï¼šå…¬å¸ã€å­¦æ ¡ã€æœ‹å‹èšä¼šç­‰">
      </div>
      
      <div class="form-group">
        <label class="form-label" for="personOccupation">èŒä¸š</label>
        <input type="text" id="personOccupation" class="form-input">
      </div>
      
      <div class="action-buttons">
        <button type="submit" class="btn-emo">
          <i class="fas fa-save"></i> åˆ›å»ºæ¡£æ¡ˆ
        </button>
        <button type="button" class="btn-emo btn-emo-secondary" onclick="closeCreatePersonModal()">
          <i class="fas fa-times"></i> å–æ¶ˆ
        </button>
      </div>
    </form>
  </div>
</div>

<!-- åˆ›å»ºäº’åŠ¨è®°å½•æ¨¡æ€æ¡† -->
<div id="createInteractionModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">è®°å½•äº’åŠ¨</h3>
      <button class="close-btn" onclick="closeCreateInteractionModal()">&times;</button>
    </div>
    <form id="createInteractionForm">
      <div class="form-group">
        <label class="form-label" for="interactionPerson">é€‰æ‹©äººç‰© *</label>
        <select id="interactionPerson" class="form-input form-select" required>
          <option value="">è¯·é€‰æ‹©...</option>
          <!-- äººç‰©é€‰é¡¹å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label" for="interactionTitle">æ ‡é¢˜/æ‘˜è¦ *</label>
        <input type="text" id="interactionTitle" class="form-input" required>
      </div>
      
      <div class="form-group">
        <label class="form-label" for="interactionType">äº’åŠ¨ç±»å‹</label>
        <select id="interactionType" class="form-input form-select">
          <option value="meeting">è§é¢</option>
          <option value="phone_call">ç”µè¯</option>
          <option value="video_call">è§†é¢‘é€šè¯</option>
          <option value="message">æ¶ˆæ¯èŠå¤©</option>
          <option value="email">é‚®ä»¶</option>
          <option value="social_media">ç¤¾äº¤åª’ä½“</option>
          <option value="event">å…±åŒæ´»åŠ¨</option>
          <option value="gift">é€ç¤¼/æ”¶ç¤¼</option>
          <option value="help">äº’ç›¸å¸®åŠ©</option>
          <option value="other">å…¶ä»–</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label" for="interactionDate">æ—¥æœŸ *</label>
        <input type="date" id="interactionDate" class="form-input" required>
      </div>
      
      <div class="form-group">
        <label class="form-label" for="interactionContent">è¯¦ç»†å†…å®¹ *</label>
        <textarea id="interactionContent" class="form-input form-textarea" required placeholder="æè¿°è¿™æ¬¡äº’åŠ¨çš„å…·ä½“å†…å®¹..."></textarea>
      </div>
      
      <div class="form-group">
        <label class="form-label" for="interactionMood">å½“æ—¶å¿ƒæƒ…</label>
        <select id="interactionMood" class="form-input form-select">
          <option value="">è¯·é€‰æ‹©...</option>
          <option value="very_happy">éå¸¸å¼€å¿ƒ ğŸ˜„</option>
          <option value="happy">å¼€å¿ƒ ğŸ˜Š</option>
          <option value="neutral">ä¸€èˆ¬ ğŸ˜</option>
          <option value="disappointed">å¤±æœ› ğŸ˜</option>
          <option value="sad">éš¾è¿‡ ğŸ˜¢</option>
          <option value="angry">ç”Ÿæ°” ğŸ˜ </option>
          <option value="confused">å›°æƒ‘ ğŸ˜•</option>
          <option value="excited">å…´å¥‹ ğŸ¤©</option>
          <option value="nervous">ç´§å¼  ğŸ˜°</option>
          <option value="grateful">æ„Ÿæ¿€ ğŸ™</option>
        </select>
      </div>
      
      <div class="action-buttons">
        <button type="submit" class="btn-emo">
          <i class="fas fa-save"></i> ä¿å­˜è®°å½•
        </button>
        <button type="button" class="btn-emo btn-emo-secondary" onclick="closeCreateInteractionModal()">
          <i class="fas fa-times"></i> å–æ¶ˆ
        </button>
      </div>
    </form>
  </div>
</div>

<!-- åˆ›å»ºé‡è¦æ—¶åˆ»æ¨¡æ€æ¡† -->
<div id="createMomentModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">è®°å½•é‡è¦æ—¶åˆ»</h3>
      <button class="close-btn" onclick="closeCreateMomentModal()">&times;</button>
    </div>
    <form id="createMomentForm">
      <div class="form-group">
        <label class="form-label" for="momentPerson">ç›¸å…³äººç‰© *</label>
        <select id="momentPerson" class="form-input form-select" required>
          <option value="">è¯·é€‰æ‹©...</option>
          <!-- äººç‰©é€‰é¡¹å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label" for="momentTitle">æ—¶åˆ»æ ‡é¢˜ *</label>
        <input type="text" id="momentTitle" class="form-input" required placeholder="å¦‚ï¼šç¬¬ä¸€æ¬¡è§é¢ã€ç”Ÿæ—¥èšä¼šã€é‡è¦è°ˆè¯ç­‰">
      </div>
      
      <div class="form-group">
        <label class="form-label" for="momentType">æ—¶åˆ»ç±»å‹</label>
        <select id="momentType" class="form-input form-select">
          <option value="milestone">é‡è¦é‡Œç¨‹ç¢‘</option>
          <option value="first_time">ç¬¬ä¸€æ¬¡</option>
          <option value="achievement">æˆå°±æ—¶åˆ»</option>
          <option value="memorable">éš¾å¿˜ç»å†</option>
          <option value="turning_point">è½¬æŠ˜ç‚¹</option>
          <option value="special_day">ç‰¹æ®Šæ—¥å­</option>
          <option value="conflict">å†²çªäº‹ä»¶</option>
          <option value="reconciliation">å’Œè§£æ—¶åˆ»</option>
          <option value="other">å…¶ä»–</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label" for="momentDate">å‘ç”Ÿæ—¥æœŸ *</label>
        <input type="date" id="momentDate" class="form-input" required>
      </div>
      
      <div class="form-group">
        <label class="form-label" for="momentLocation">å‘ç”Ÿåœ°ç‚¹</label>
        <input type="text" id="momentLocation" class="form-input" placeholder="å¦‚ï¼šå®¶ä¸­ã€åŠå…¬å®¤ã€å’–å•¡å…ç­‰">
      </div>
      
      <div class="form-group">
        <label class="form-label" for="momentDescription">è¯¦ç»†æè¿° *</label>
        <textarea id="momentDescription" class="form-input form-textarea" required placeholder="è¯¦ç»†æè¿°è¿™ä¸ªé‡è¦æ—¶åˆ»..."></textarea>
      </div>
      
      <div class="form-group">
        <label class="form-label" for="emotionalImpact">æƒ…æ„Ÿå½±å“</label>
        <select id="emotionalImpact" class="form-input form-select">
          <option value="very_positive">éå¸¸ç§¯æ ğŸ˜„</option>
          <option value="positive">ç§¯æ ğŸ˜Š</option>
          <option value="neutral">ä¸­æ€§ ğŸ˜</option>
          <option value="negative">æ¶ˆæ ğŸ˜</option>
          <option value="very_negative">éå¸¸æ¶ˆæ ğŸ˜¢</option>
          <option value="mixed">å¤æ‚ ğŸ˜•</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label" for="personalReflection">ä¸ªäººåæ€</label>
        <textarea id="personalReflection" class="form-input form-textarea" placeholder="è¿™ä¸ªæ—¶åˆ»å¯¹ä½ æ„å‘³ç€ä»€ä¹ˆï¼Ÿä½ çš„æ„Ÿæƒ³å’Œæ€è€ƒ..."></textarea>
      </div>
      
      <div class="action-buttons">
        <button type="submit" class="btn-emo">
          <i class="fas fa-save"></i> ä¿å­˜æ—¶åˆ»
        </button>
        <button type="button" class="btn-emo btn-emo-secondary" onclick="closeCreateMomentModal()">
          <i class="fas fa-times"></i> å–æ¶ˆ
        </button>
      </div>
    </form>
  </div>
</div>

<script>
// å…¨å±€å˜é‡
let selectedTags = new Set();
let personProfiles = [];
let relationshipTags = [];

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
  loadDashboardData();
  loadRelationshipTags();
  initStarSelector();
  initCurrentDate();
});

// åŠ è½½ä»ªè¡¨ç›˜æ•°æ®
async function loadDashboardData() {
  try {
    const response = await fetch('/tools/api/meetsomeone/dashboard-stats/');
    const data = await response.json();
    
    if (data.status === 'success') {
      displayStats(data.data.stats);
      displayRecentInteractions(data.data.recent_interactions);
      displayPendingReminders(data.data.pending_reminders);
    } else {
      showError('åŠ è½½æ•°æ®å¤±è´¥: ' + data.message);
    }
  } catch (error) {
    console.error('Error loading dashboard data:', error);
    showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
  }
}

// æ˜¾ç¤ºç»Ÿè®¡æ•°æ®
function displayStats(stats) {
  const statsGrid = document.getElementById('statsGrid');
  statsGrid.innerHTML = `
    <div class="stat-card clickable" onclick="showPeopleList()">
      <div class="stat-number">${stats.total_people}</div>
      <div class="stat-label">äººç‰©æ¡£æ¡ˆ</div>
    </div>
    <div class="stat-card clickable" onclick="showInteractionsList()">
      <div class="stat-number">${stats.total_interactions}</div>
      <div class="stat-label">äº’åŠ¨è®°å½•</div>
    </div>
    <div class="stat-card clickable" onclick="showActiveRelationships()">
      <div class="stat-number">${stats.active_relationships}</div>
      <div class="stat-label">æ´»è·ƒå…³ç³»</div>
    </div>
    <div class="stat-card clickable" onclick="showMomentsList()">
      <div class="stat-number">${stats.total_moments}</div>
      <div class="stat-label">é‡è¦æ—¶åˆ»</div>
    </div>
  `;
}

// æ˜¾ç¤ºæœ€è¿‘äº’åŠ¨
function displayRecentInteractions(interactions) {
  const container = document.getElementById('recentInteractions');
  
  if (interactions.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-comments"></i>
        <p>è¿˜æ²¡æœ‰äº’åŠ¨è®°å½•<br>å¼€å§‹åˆ›å»ºä½ çš„ç¬¬ä¸€æ¡è®°å½•å§ï¼</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = interactions.map(interaction => `
    <div class="interaction-item">
      <div class="interaction-avatar">
        ${interaction.person_name.charAt(0)}
      </div>
      <div class="interaction-content">
        <div class="interaction-title">${interaction.title}</div>
        <div class="interaction-meta">
          ${interaction.person_name} â€¢ ${interaction.date} â€¢ ${interaction.interaction_type} ${interaction.mood_emoji}
        </div>
      </div>
    </div>
  `).join('');
}

// æ˜¾ç¤ºå¾…åŠæé†’
function displayPendingReminders(reminders) {
  const container = document.getElementById('pendingReminders');
  
  if (reminders.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-bell"></i>
        <p>æš‚æ— å¾…åŠæé†’</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = reminders.map(reminder => `
    <div class="reminder-item">
      <div class="reminder-icon">
        <i class="fas fa-bell"></i>
      </div>
      <div class="reminder-content">
        <div class="reminder-title">${reminder.title}</div>
        <div class="reminder-date">${reminder.person_name} â€¢ ${reminder.reminder_date}</div>
      </div>
    </div>
  `).join('');
}

// åŠ è½½å…³ç³»æ ‡ç­¾
async function loadRelationshipTags() {
  try {
    const response = await fetch('/tools/api/meetsomeone/relationship-tags/');
    const data = await response.json();
    
    if (data.status === 'success') {
      relationshipTags = data.data;
      displayRelationshipTags();
    }
  } catch (error) {
    console.error('Error loading relationship tags:', error);
  }
}

// æ˜¾ç¤ºå…³ç³»æ ‡ç­¾
function displayRelationshipTags() {
  const container = document.getElementById('relationshipTags');
  container.innerHTML = relationshipTags.map(tag => `
    <div class="tag-item" data-tag-id="${tag.id}" style="border-color: ${tag.color}" onclick="toggleTag(${tag.id})">
      ${tag.name}
    </div>
  `).join('');
}

// åˆ‡æ¢æ ‡ç­¾é€‰æ‹©
function toggleTag(tagId) {
  const tagElement = document.querySelector(`[data-tag-id="${tagId}"]`);
  
  if (selectedTags.has(tagId)) {
    selectedTags.delete(tagId);
    tagElement.classList.remove('selected');
  } else {
    selectedTags.add(tagId);
    tagElement.classList.add('selected');
  }
}

// åˆå§‹åŒ–æ˜Ÿçº§é€‰æ‹©å™¨
function initStarSelector() {
  const starButtons = document.querySelectorAll('.star-btn');
  
  starButtons.forEach((btn, index) => {
    btn.addEventListener('click', function() {
      const value = parseInt(this.dataset.value);
      document.getElementById('personImportance').value = value;
      
      // æ›´æ–°æ˜Ÿçº§æ˜¾ç¤º
      starButtons.forEach((star, i) => {
        star.classList.toggle('active', i < value);
      });
    });
  });
  
  // è®¾ç½®é»˜è®¤å€¼
  const defaultValue = 3;
  starButtons.forEach((star, i) => {
    star.classList.toggle('active', i < defaultValue);
  });
}

// åˆå§‹åŒ–å½“å‰æ—¥æœŸ
function initCurrentDate() {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('interactionDate').value = today;
}

// æ‰“å¼€åˆ›å»ºäººç‰©æ¡£æ¡ˆæ¨¡æ€æ¡†
function openCreatePersonModal() {
  document.getElementById('createPersonModal').style.display = 'block';
  loadPersonProfiles(); // ä¸ºäº’åŠ¨è®°å½•å‡†å¤‡æ•°æ®
}

// å…³é—­åˆ›å»ºäººç‰©æ¡£æ¡ˆæ¨¡æ€æ¡†
function closeCreatePersonModal() {
  document.getElementById('createPersonModal').style.display = 'none';
  document.getElementById('createPersonForm').reset();
  selectedTags.clear();
  document.querySelectorAll('.tag-item').forEach(tag => tag.classList.remove('selected'));
  
  // é‡ç½®æ˜Ÿçº§
  const starButtons = document.querySelectorAll('.star-btn');
  starButtons.forEach((star, i) => {
    star.classList.toggle('active', i < 3);
  });
  document.getElementById('personImportance').value = 3;
}

// æ‰“å¼€åˆ›å»ºäº’åŠ¨è®°å½•æ¨¡æ€æ¡†
function openCreateInteractionModal() {
  document.getElementById('createInteractionModal').style.display = 'block';
  loadPersonProfiles();
}

// å…³é—­åˆ›å»ºäº’åŠ¨è®°å½•æ¨¡æ€æ¡†
function closeCreateInteractionModal() {
  document.getElementById('createInteractionModal').style.display = 'none';
  document.getElementById('createInteractionForm').reset();
  initCurrentDate();
}

// æ‰“å¼€åˆ›å»ºé‡è¦æ—¶åˆ»æ¨¡æ€æ¡†
function openCreateMomentModal() {
  document.getElementById('createMomentModal').style.display = 'block';
  loadPersonProfiles();
  populateMomentPersonSelect();
  initCurrentDate();
}

// å…³é—­åˆ›å»ºé‡è¦æ—¶åˆ»æ¨¡æ€æ¡†
function closeCreateMomentModal() {
  document.getElementById('createMomentModal').style.display = 'none';
  document.getElementById('createMomentForm').reset();
}

// å¡«å……é‡è¦æ—¶åˆ»äººç‰©é€‰æ‹©ä¸‹æ‹‰æ¡†
function populateMomentPersonSelect() {
  const select = document.getElementById('momentPerson');
  
  if (personProfiles.length === 0) {
    select.innerHTML = '<option value="">è¯·å…ˆåˆ›å»ºäººç‰©æ¡£æ¡ˆ</option>';
    return;
  }
  
  select.innerHTML = `
    <option value="">è¯·é€‰æ‹©...</option>
    ${personProfiles.map(person => `
      <option value="${person.id}">${person.name}${person.nickname ? ` (${person.nickname})` : ''}</option>
    `).join('')}
  `;
}

// åŠ è½½äººç‰©æ¡£æ¡ˆåˆ—è¡¨
async function loadPersonProfiles() {
  try {
    const response = await fetch('/tools/api/meetsomeone/person-profiles/?page_size=100');
    const data = await response.json();
    
    if (data.status === 'success') {
      personProfiles = data.data.profiles;
      populatePersonSelect();
    }
  } catch (error) {
    console.error('Error loading person profiles:', error);
  }
}

// å¡«å……äººç‰©é€‰æ‹©ä¸‹æ‹‰æ¡†
function populatePersonSelect() {
  const select = document.getElementById('interactionPerson');
  const currentOptions = select.innerHTML;
  
  if (personProfiles.length === 0) {
    select.innerHTML = `
      <option value="">è¯·å…ˆåˆ›å»ºäººç‰©æ¡£æ¡ˆ</option>
    `;
    return;
  }
  
  select.innerHTML = `
    <option value="">è¯·é€‰æ‹©...</option>
    ${personProfiles.map(person => `
      <option value="${person.id}">${person.name}${person.nickname ? ` (${person.nickname})` : ''}</option>
    `).join('')}
  `;
}

// åˆ›å»ºäººç‰©æ¡£æ¡ˆè¡¨å•æäº¤
document.getElementById('createPersonForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const formData = {
    name: document.getElementById('personName').value.trim(),
    nickname: document.getElementById('personNickname').value.trim(),
    importance_level: parseInt(document.getElementById('personImportance').value),
    first_met_date: document.getElementById('firstMetDate').value || null,
    first_met_location: document.getElementById('firstMetLocation').value.trim(),
    occupation: document.getElementById('personOccupation').value.trim(),
    relationship_tag_ids: Array.from(selectedTags)
  };
  
  try {
    const response = await fetch('/tools/api/meetsomeone/person-profiles/create/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify(formData)
    });
    
    const data = await response.json();
    
    if (data.status === 'success') {
      showSuccess('äººç‰©æ¡£æ¡ˆåˆ›å»ºæˆåŠŸï¼');
      closeCreatePersonModal();
      loadDashboardData(); // åˆ·æ–°é¡µé¢æ•°æ®
    } else {
      showError(data.message);
    }
  } catch (error) {
    console.error('Error creating person profile:', error);
    showError('åˆ›å»ºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
  }
});

// åˆ›å»ºäº’åŠ¨è®°å½•è¡¨å•æäº¤
document.getElementById('createInteractionForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const formData = {
    person_id: parseInt(document.getElementById('interactionPerson').value),
    title: document.getElementById('interactionTitle').value.trim(),
    interaction_type: document.getElementById('interactionType').value,
    date: document.getElementById('interactionDate').value,
    content: document.getElementById('interactionContent').value.trim(),
    mood: document.getElementById('interactionMood').value || null
  };
  
  try {
    const response = await fetch('/tools/api/meetsomeone/interactions/create/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify(formData)
    });
    
    const data = await response.json();
    
    if (data.status === 'success') {
      showSuccess('äº’åŠ¨è®°å½•åˆ›å»ºæˆåŠŸï¼');
      closeCreateInteractionModal();
      loadDashboardData(); // åˆ·æ–°é¡µé¢æ•°æ®
    } else {
      showError(data.message);
    }
  } catch (error) {
    console.error('Error creating interaction:', error);
    showError('åˆ›å»ºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
  }
});

// åˆ›å»ºé‡è¦æ—¶åˆ»è¡¨å•æäº¤
document.getElementById('createMomentForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const formData = {
    person_id: parseInt(document.getElementById('momentPerson').value),
    title: document.getElementById('momentTitle').value.trim(),
    moment_type: document.getElementById('momentType').value,
    date: document.getElementById('momentDate').value,
    location: document.getElementById('momentLocation').value.trim(),
    description: document.getElementById('momentDescription').value.trim(),
    emotional_impact: document.getElementById('emotionalImpact').value,
    personal_reflection: document.getElementById('personalReflection').value.trim()
  };
  
  try {
    const response = await fetch('/tools/api/meetsomeone/moments/create/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify(formData)
    });
    
    const data = await response.json();
    
    if (data.status === 'success') {
      showSuccess('é‡è¦æ—¶åˆ»è®°å½•æˆåŠŸï¼');
      closeCreateMomentModal();
      loadDashboardData(); // åˆ·æ–°é¡µé¢æ•°æ®
    } else {
      showError(data.message);
    }
  } catch (error) {
    console.error('Error creating important moment:', error);
    showError('åˆ›å»ºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
  }
});

// å·¥å…·å‡½æ•°
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

function showSuccess(message) {
  // è¿™é‡Œå¯ä»¥å®ç°ä¸€ä¸ªæˆåŠŸæç¤ºç»„ä»¶
  alert(message);
}

function showError(message) {
  // è¿™é‡Œå¯ä»¥å®ç°ä¸€ä¸ªé”™è¯¯æç¤ºç»„ä»¶
  alert(message);
}

// ç»Ÿè®¡å¡ç‰‡ç‚¹å‡»å‡½æ•°
function showPeopleList() {
  // æ˜¾ç¤ºäººç‰©æ¡£æ¡ˆåˆ—è¡¨
  if (personProfiles.length === 0) {
    showError('æš‚æ— äººç‰©æ¡£æ¡ˆæ•°æ®');
    return;
  }
  
  let content = '<div class="people-list"><h3>äººç‰©æ¡£æ¡ˆåˆ—è¡¨</h3>';
  personProfiles.slice(0, 10).forEach(person => {
    content += `
      <div class="person-item">
        <strong>${person.name}</strong>
        ${person.nickname ? `(${person.nickname})` : ''}
        - ${person.occupation || 'æœªçŸ¥èŒä¸š'}
        <br><small>é‡è¦ç¨‹åº¦: ${'â­'.repeat(person.importance_level)}</small>
      </div>
    `;
  });
  if (personProfiles.length > 10) {
    content += `<p><small>è¿˜æœ‰ ${personProfiles.length - 10} ä¸ªäººç‰©æ¡£æ¡ˆ...</small></p>`;
  }
  content += '</div>';
  
  showInfo(content);
}

function showInteractionsList() {
  showInfo('äº’åŠ¨è®°å½•åŠŸèƒ½ï¼šæŸ¥çœ‹æœ€è¿‘çš„äº’åŠ¨è®°å½•ã€‚ç‚¹å‡»ä¸Šæ–¹"è®°å½•äº’åŠ¨"æŒ‰é’®æ·»åŠ æ–°çš„äº’åŠ¨è®°å½•ã€‚');
}

function showActiveRelationships() {
  showInfo('æ´»è·ƒå…³ç³»ï¼šæ˜¾ç¤ºæœ€è¿‘30å¤©å†…æœ‰äº’åŠ¨çš„äººé™…å…³ç³»ã€‚ä¿æŒå®šæœŸäº’åŠ¨æœ‰åŠ©äºç»´æŠ¤è‰¯å¥½çš„äººé™…å…³ç³»ã€‚');
}

function showMomentsList() {
  showInfo('é‡è¦æ—¶åˆ»ï¼šè®°å½•äººç”Ÿä¸­çš„é‡è¦æ—¶åˆ»å’Œé‡Œç¨‹ç¢‘ã€‚ç‚¹å‡»ä¸Šæ–¹"é‡è¦æ—¶åˆ»"æŒ‰é’®æ·»åŠ æ–°çš„è®°å½•ã€‚');
}

function showInfo(content) {
  // åˆ›å»ºä¸€ä¸ªç®€å•çš„ä¿¡æ¯æ˜¾ç¤ºæ¡†
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); z-index: 1000; display: flex;
    align-items: center; justify-content: center;
  `;
  
  const content_div = document.createElement('div');
  content_div.style.cssText = `
    background: white; padding: 20px; border-radius: 8px;
    max-width: 500px; max-height: 400px; overflow-y: auto;
    position: relative;
  `;
  content_div.innerHTML = content + '<br><button onclick="this.closest(\'.info-modal\').remove()">å…³é—­</button>';
  
  modal.className = 'info-modal';
  modal.appendChild(content_div);
  document.body.appendChild(modal);
  
  // ç‚¹å‡»èƒŒæ™¯å…³é—­
  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      modal.remove();
    }
  });
}

// ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
window.addEventListener('click', function(event) {
  const createPersonModal = document.getElementById('createPersonModal');
  const createInteractionModal = document.getElementById('createInteractionModal');
  const createMomentModal = document.getElementById('createMomentModal');
  
  if (event.target === createPersonModal) {
    closeCreatePersonModal();
  }
  if (event.target === createInteractionModal) {
    closeCreateInteractionModal();
  }
  if (event.target === createMomentModal) {
    closeCreateMomentModal();
  }
});
</script>
{% endblock %}
