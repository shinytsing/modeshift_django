{% extends 'base.html' %}
{% load static %}

{% block tool_title_inner %}MeeSomeone ‰∫∫ÈôÖÊ°£Ê°à{% endblock %}
{% block tool_title_display %}MeeSomeone ‰∫∫ÈôÖÊ°£Ê°à{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'emo.css' %}">
<style>
/* MeeSomeone ‰∏ìÂ±ûÊ†∑Âºè */
.meetsomeone-container {
  min-height: 100vh;
  background: var(--emo-bg);
  padding: 2rem;
  font-family: var(--emo-font);
}

.meetsomeone-header {
  text-align: center;
  margin-bottom: 3rem;
  padding: 2rem 0;
}

.meetsomeone-title {
  color: var(--emo-primary);
  font-size: 3rem;
  font-weight: 700;
  margin-bottom: 1rem;
  text-shadow: 0 0 20px rgba(156, 39, 176, 0.3);
}

.meetsomeone-subtitle {
  color: var(--emo-text-muted);
  font-size: 1.2rem;
  margin-bottom: 2rem;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 2rem;
  margin-bottom: 3rem;
}

.stat-card {
  background: var(--emo-gradient-card);
  border: 1px solid var(--emo-border);
  border-radius: var(--emo-radius);
  padding: 2rem;
  text-align: center;
  box-shadow: var(--emo-shadow);
  backdrop-filter: blur(15px);
  transition: all 0.3s ease;
}

.stat-card:hover {
  transform: translateY(-5px);
  box-shadow: var(--emo-shadow-hover);
}

.stat-card.clickable {
  cursor: pointer;
}

.stat-card.clickable:active {
  transform: translateY(-2px);
}

.stat-number {
  font-size: 2.5rem;
  font-weight: 700;
  color: var(--emo-primary);
  margin-bottom: 0.5rem;
}

.stat-label {
  color: var(--emo-text-muted);
  font-size: 1rem;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.section-card {
  background: var(--emo-gradient-card);
  border: 1px solid var(--emo-border);
  border-radius: var(--emo-radius);
  padding: 2rem;
  margin-bottom: 2rem;
  box-shadow: var(--emo-shadow);
  backdrop-filter: blur(15px);
}

.section-title {
  color: var(--emo-primary);
  font-size: 1.5rem;
  font-weight: 600;
  margin-bottom: 1.5rem;
  display: flex;
  align-items: center;
  gap: 1rem;
}

.action-buttons {
  display: flex;
  gap: 1rem;
  margin-bottom: 2rem;
  flex-wrap: wrap;
}

.btn-emo {
  background: var(--emo-gradient);
  color: white;
  border: none;
  padding: 1rem 2rem;
  border-radius: var(--emo-radius);
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  text-transform: uppercase;
  letter-spacing: 1px;
  box-shadow: 0 4px 15px rgba(156, 39, 176, 0.3);
}

.btn-emo:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(156, 39, 176, 0.4);
}

.btn-emo-secondary {
  background: transparent;
  color: var(--emo-primary);
  border: 2px solid var(--emo-primary);
}

.btn-emo-secondary:hover {
  background: var(--emo-primary);
  color: white;
}

.interaction-item {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem;
  background: rgba(255, 255, 255, 0.1);
  border-radius: var(--emo-radius);
  margin-bottom: 1rem;
  transition: all 0.3s ease;
}

.interaction-item:hover {
  background: rgba(255, 255, 255, 0.2);
  transform: translateX(5px);
}

.interaction-avatar {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: var(--emo-gradient);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 600;
  font-size: 1.2rem;
}

.interaction-content {
  flex: 1;
}

.interaction-title {
  font-weight: 600;
  color: var(--emo-text);
  margin-bottom: 0.3rem;
}

.interaction-meta {
  color: var(--emo-text-muted);
  font-size: 0.9rem;
}

.reminder-item {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem;
  background: rgba(233, 30, 99, 0.1);
  border-left: 4px solid var(--emo-accent);
  border-radius: 0 var(--emo-radius) var(--emo-radius) 0;
  margin-bottom: 1rem;
}

.reminder-icon {
  color: var(--emo-accent);
  font-size: 1.5rem;
}

.reminder-content {
  flex: 1;
}

.reminder-title {
  font-weight: 600;
  color: var(--emo-text);
  margin-bottom: 0.3rem;
}

.reminder-date {
  color: var(--emo-accent);
  font-size: 0.9rem;
  font-weight: 500;
}

.empty-state {
  text-align: center;
  padding: 3rem;
  color: var(--emo-text-muted);
}

.empty-state i {
  font-size: 3rem;
  margin-bottom: 1rem;
  opacity: 0.5;
}

.loading {
  text-align: center;
  padding: 2rem;
  color: var(--emo-text-muted);
}

.loading i {
  font-size: 2rem;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.main-content {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 2rem;
}

@media (max-width: 768px) {
  .meetsomeone-container {
    padding: 1rem;
  }
  
  .meetsomeone-title {
    font-size: 2rem;
  }
  
  .stats-grid {
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
  }
  
  .main-content {
    grid-template-columns: 1fr;
  }
  
  .action-buttons {
    flex-direction: column;
  }
}

/* Ê®°ÊÄÅÊ°ÜÊ†∑Âºè */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  z-index: 1000;
}

.modal-content {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: var(--emo-card-bg);
  border-radius: var(--emo-radius-lg);
  padding: 2rem;
  width: 90%;
  max-width: 600px;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 2rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid var(--emo-border);
}

.modal-title {
  color: var(--emo-primary);
  font-size: 1.5rem;
  font-weight: 600;
}

.close-btn {
  background: none;
  border: none;
  font-size: 1.5rem;
  color: var(--emo-text-muted);
  cursor: pointer;
  transition: color 0.3s ease;
}

.close-btn:hover {
  color: var(--emo-accent);
}

.form-group {
  margin-bottom: 1.5rem;
}

.form-label {
  display: block;
  color: var(--emo-text);
  font-weight: 500;
  margin-bottom: 0.5rem;
}

.form-input {
  width: 100%;
  padding: 1rem;
  border: 1px solid var(--emo-border);
  border-radius: var(--emo-radius);
  background: rgba(255, 255, 255, 0.9);
  color: var(--emo-text);
  font-size: 1rem;
  transition: all 0.3s ease;
}

.form-input:focus {
  outline: none;
  border-color: var(--emo-primary);
  box-shadow: 0 0 10px rgba(156, 39, 176, 0.2);
}

.form-textarea {
  resize: vertical;
  min-height: 100px;
}

.form-select {
  appearance: none;
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
  background-position: right 0.5rem center;
  background-repeat: no-repeat;
  background-size: 1.5em 1.5em;
  padding-right: 2.5rem;
}

.tag-selector {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-top: 0.5rem;
}

.tag-item {
  padding: 0.5rem 1rem;
  background: rgba(156, 39, 176, 0.1);
  border: 1px solid var(--emo-border);
  border-radius: 20px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 0.9rem;
}

.tag-item:hover {
  background: rgba(156, 39, 176, 0.2);
}

.tag-item.selected {
  background: var(--emo-primary);
  color: white;
  border-color: var(--emo-primary);
}

.importance-selector {
  display: flex;
  gap: 0.5rem;
  margin-top: 0.5rem;
}

.star-btn {
  background: none;
  border: none;
  font-size: 1.5rem;
  color: #ddd;
  cursor: pointer;
  transition: color 0.3s ease;
}

.star-btn:hover,
.star-btn.active {
  color: #ffd700;
}
</style>
{% endblock %}

{% block content %}
<div class="meetsomeone-container emo-theme">
  <div class="meetsomeone-header">
    <h1 class="meetsomeone-title">
      <i class="fas fa-users"></i> MeeSomeone
    </h1>
    <p class="meetsomeone-subtitle">üíú ËÆ∞ÂΩïÁîüÂëΩ‰∏≠ÁöÑÊØè‰∏Ä‰∏™ÈáçË¶ÅËøûÊé•</p>
  </div>

  <!-- ÁªüËÆ°Êï∞ÊçÆ -->
  <div class="stats-grid" id="statsGrid">
    <div class="loading">
      <i class="fas fa-spinner"></i>
      <p>Âä†ËΩΩÁªüËÆ°Êï∞ÊçÆ‰∏≠...</p>
    </div>
  </div>

  <!-- Êìç‰ΩúÊåâÈíÆ -->
  <div class="action-buttons">
    <button class="btn-emo" onclick="openCreatePersonModal()">
      <i class="fas fa-user-plus"></i> Êñ∞Âª∫Ê°£Ê°à
    </button>
    <button class="btn-emo" onclick="openCreateInteractionModal()">
      <i class="fas fa-comments"></i> ËÆ∞ÂΩï‰∫íÂä®
    </button>
    <button class="btn-emo" onclick="openCreateMomentModal()">
      <i class="fas fa-star"></i> ÈáçË¶ÅÊó∂Âàª
    </button>
    <button class="btn-emo btn-emo-secondary" onclick="window.location.href='{% url 'tools:meetsomeone_timeline' %}'">
      <i class="fas fa-clock"></i> Êó∂ÂÖâËΩ¥
    </button>
    <button class="btn-emo btn-emo-secondary" onclick="window.location.href='{% url 'tools:meetsomeone_graph' %}'">
      <i class="fas fa-project-diagram"></i> ÂÖ≥Á≥ªÂõæË∞±
    </button>
  </div>

  <!-- ‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü -->
  <div class="main-content">
    <!-- Â∑¶‰æßÔºöÊúÄËøë‰∫íÂä® -->
    <div class="section-card">
      <h2 class="section-title">
        <i class="fas fa-clock"></i> ÊúÄËøë‰∫íÂä®
      </h2>
      <div id="recentInteractions">
        <div class="loading">
          <i class="fas fa-spinner"></i>
          <p>Âä†ËΩΩ‰∫íÂä®ËÆ∞ÂΩï‰∏≠...</p>
        </div>
      </div>
    </div>

    <!-- Âè≥‰æßÔºöÂæÖÂäûÊèêÈÜí -->
    <div class="section-card">
      <h2 class="section-title">
        <i class="fas fa-bell"></i> ÂæÖÂäûÊèêÈÜí
      </h2>
      <div id="pendingReminders">
        <div class="loading">
          <i class="fas fa-spinner"></i>
          <p>Âä†ËΩΩÊèêÈÜí‰∫ãÈ°π‰∏≠...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ÂàõÂª∫‰∫∫Áâ©Ê°£Ê°àÊ®°ÊÄÅÊ°Ü -->
<div id="createPersonModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">ÂàõÂª∫‰∫∫Áâ©Ê°£Ê°à</h3>
      <button class="close-btn" onclick="closeCreatePersonModal()">&times;</button>
    </div>
    <form id="createPersonForm">
      <div class="form-group">
        <label class="form-label" for="personName">ÂßìÂêç *</label>
        <input type="text" id="personName" class="form-input" required>
      </div>
      
      <div class="form-group">
        <label class="form-label" for="personNickname">ÊòµÁß∞/Â§áÊ≥®Âêç</label>
        <input type="text" id="personNickname" class="form-input">
      </div>
      
      <div class="form-group">
        <label class="form-label" for="personImportance">ÈáçË¶ÅÁ®ãÂ∫¶</label>
        <div class="importance-selector">
          <button type="button" class="star-btn" data-value="1">‚≠ê</button>
          <button type="button" class="star-btn" data-value="2">‚≠ê</button>
          <button type="button" class="star-btn" data-value="3">‚≠ê</button>
          <button type="button" class="star-btn" data-value="4">‚≠ê</button>
          <button type="button" class="star-btn" data-value="5">‚≠ê</button>
        </div>
        <input type="hidden" id="personImportance" value="3">
      </div>
      
      <div class="form-group">
        <label class="form-label">ÂÖ≥Á≥ªÊ†áÁ≠æ</label>
        <div id="relationshipTags" class="tag-selector">
          <!-- Ê†áÁ≠æÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÂä†ËΩΩ -->
        </div>
      </div>
      
      <div class="form-group">
        <label class="form-label" for="firstMetDate">ËÆ§ËØÜÊó•Êúü</label>
        <input type="date" id="firstMetDate" class="form-input">
      </div>
      
      <div class="form-group">
        <label class="form-label" for="firstMetLocation">ËÆ§ËØÜÂú∫ÊôØ</label>
        <input type="text" id="firstMetLocation" class="form-input" placeholder="Â¶ÇÔºöÂÖ¨Âè∏„ÄÅÂ≠¶Ê†°„ÄÅÊúãÂèãËÅö‰ºöÁ≠â">
      </div>
      
      <div class="form-group">
        <label class="form-label" for="personOccupation">ËÅå‰∏ö</label>
        <input type="text" id="personOccupation" class="form-input">
      </div>
      
      <div class="action-buttons">
        <button type="submit" class="btn-emo">
          <i class="fas fa-save"></i> ÂàõÂª∫Ê°£Ê°à
        </button>
        <button type="button" class="btn-emo btn-emo-secondary" onclick="closeCreatePersonModal()">
          <i class="fas fa-times"></i> ÂèñÊ∂à
        </button>
      </div>
    </form>
  </div>
</div>

<!-- ÂàõÂª∫‰∫íÂä®ËÆ∞ÂΩïÊ®°ÊÄÅÊ°Ü -->
<div id="createInteractionModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">ËÆ∞ÂΩï‰∫íÂä®</h3>
      <button class="close-btn" onclick="closeCreateInteractionModal()">&times;</button>
    </div>
    <form id="createInteractionForm">
      <div class="form-group">
        <label class="form-label" for="interactionPerson">ÈÄâÊã©‰∫∫Áâ© *</label>
        <select id="interactionPerson" class="form-input form-select" required>
          <option value="">ËØ∑ÈÄâÊã©...</option>
          <!-- ‰∫∫Áâ©ÈÄâÈ°πÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÂä†ËΩΩ -->
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label" for="interactionTitle">Ê†áÈ¢ò/ÊëòË¶Å *</label>
        <input type="text" id="interactionTitle" class="form-input" required>
      </div>
      
      <div class="form-group">
        <label class="form-label" for="interactionType">‰∫íÂä®Á±ªÂûã</label>
        <select id="interactionType" class="form-input form-select">
          <option value="meeting">ËßÅÈù¢</option>
          <option value="phone_call">ÁîµËØù</option>
          <option value="video_call">ËßÜÈ¢ëÈÄöËØù</option>
          <option value="message">Ê∂àÊÅØËÅäÂ§©</option>
          <option value="email">ÈÇÆ‰ª∂</option>
          <option value="social_media">Á§æ‰∫§Â™í‰Ωì</option>
          <option value="event">ÂÖ±ÂêåÊ¥ªÂä®</option>
          <option value="gift">ÈÄÅÁ§º/Êî∂Á§º</option>
          <option value="help">‰∫íÁõ∏Â∏ÆÂä©</option>
          <option value="other">ÂÖ∂‰ªñ</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label" for="interactionDate">Êó•Êúü *</label>
        <input type="date" id="interactionDate" class="form-input" required>
      </div>
      
      <div class="form-group">
        <label class="form-label" for="interactionContent">ËØ¶ÁªÜÂÜÖÂÆπ *</label>
        <textarea id="interactionContent" class="form-input form-textarea" required placeholder="ÊèèËø∞ËøôÊ¨°‰∫íÂä®ÁöÑÂÖ∑‰ΩìÂÜÖÂÆπ..."></textarea>
      </div>
      
      <div class="form-group">
        <label class="form-label" for="interactionMood">ÂΩìÊó∂ÂøÉÊÉÖ</label>
        <select id="interactionMood" class="form-input form-select">
          <option value="">ËØ∑ÈÄâÊã©...</option>
          <option value="very_happy">ÈùûÂ∏∏ÂºÄÂøÉ üòÑ</option>
          <option value="happy">ÂºÄÂøÉ üòä</option>
          <option value="neutral">‰∏ÄËà¨ üòê</option>
          <option value="disappointed">Â§±Êúõ üòû</option>
          <option value="sad">ÈöæËøá üò¢</option>
          <option value="angry">ÁîüÊ∞î üò†</option>
          <option value="confused">Âõ∞ÊÉë üòï</option>
          <option value="excited">ÂÖ¥Â•ã ü§©</option>
          <option value="nervous">Á¥ßÂº† üò∞</option>
          <option value="grateful">ÊÑüÊøÄ üôè</option>
        </select>
      </div>
      
      <div class="action-buttons">
        <button type="submit" class="btn-emo">
          <i class="fas fa-save"></i> ‰øùÂ≠òËÆ∞ÂΩï
        </button>
        <button type="button" class="btn-emo btn-emo-secondary" onclick="closeCreateInteractionModal()">
          <i class="fas fa-times"></i> ÂèñÊ∂à
        </button>
      </div>
    </form>
  </div>
</div>

<!-- ÂàõÂª∫ÈáçË¶ÅÊó∂ÂàªÊ®°ÊÄÅÊ°Ü -->
<div id="createMomentModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">ËÆ∞ÂΩïÈáçË¶ÅÊó∂Âàª</h3>
      <button class="close-btn" onclick="closeCreateMomentModal()">&times;</button>
    </div>
    <form id="createMomentForm">
      <div class="form-group">
        <label class="form-label" for="momentPerson">Áõ∏ÂÖ≥‰∫∫Áâ© *</label>
        <select id="momentPerson" class="form-input form-select" required>
          <option value="">ËØ∑ÈÄâÊã©...</option>
          <!-- ‰∫∫Áâ©ÈÄâÈ°πÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÂä†ËΩΩ -->
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label" for="momentTitle">Êó∂ÂàªÊ†áÈ¢ò *</label>
        <input type="text" id="momentTitle" class="form-input" required placeholder="Â¶ÇÔºöÁ¨¨‰∏ÄÊ¨°ËßÅÈù¢„ÄÅÁîüÊó•ËÅö‰ºö„ÄÅÈáçË¶ÅË∞àËØùÁ≠â">
      </div>
      
      <div class="form-group">
        <label class="form-label" for="momentType">Êó∂ÂàªÁ±ªÂûã</label>
        <select id="momentType" class="form-input form-select">
          <option value="milestone">ÈáçË¶ÅÈáåÁ®ãÁ¢ë</option>
          <option value="first_time">Á¨¨‰∏ÄÊ¨°</option>
          <option value="achievement">ÊàêÂ∞±Êó∂Âàª</option>
          <option value="memorable">ÈöæÂøòÁªèÂéÜ</option>
          <option value="turning_point">ËΩ¨ÊäòÁÇπ</option>
          <option value="special_day">ÁâπÊÆäÊó•Â≠ê</option>
          <option value="conflict">ÂÜ≤Á™Å‰∫ã‰ª∂</option>
          <option value="reconciliation">ÂíåËß£Êó∂Âàª</option>
          <option value="other">ÂÖ∂‰ªñ</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label" for="momentDate">ÂèëÁîüÊó•Êúü *</label>
        <input type="date" id="momentDate" class="form-input" required>
      </div>
      
      <div class="form-group">
        <label class="form-label" for="momentLocation">ÂèëÁîüÂú∞ÁÇπ</label>
        <input type="text" id="momentLocation" class="form-input" placeholder="Â¶ÇÔºöÂÆ∂‰∏≠„ÄÅÂäûÂÖ¨ÂÆ§„ÄÅÂíñÂï°ÂéÖÁ≠â">
      </div>
      
      <div class="form-group">
        <label class="form-label" for="momentDescription">ËØ¶ÁªÜÊèèËø∞ *</label>
        <textarea id="momentDescription" class="form-input form-textarea" required placeholder="ËØ¶ÁªÜÊèèËø∞Ëøô‰∏™ÈáçË¶ÅÊó∂Âàª..."></textarea>
      </div>
      
      <div class="form-group">
        <label class="form-label" for="emotionalImpact">ÊÉÖÊÑüÂΩ±Âìç</label>
        <select id="emotionalImpact" class="form-input form-select">
          <option value="very_positive">ÈùûÂ∏∏ÁßØÊûÅ üòÑ</option>
          <option value="positive">ÁßØÊûÅ üòä</option>
          <option value="neutral">‰∏≠ÊÄß üòê</option>
          <option value="negative">Ê∂àÊûÅ üòû</option>
          <option value="very_negative">ÈùûÂ∏∏Ê∂àÊûÅ üò¢</option>
          <option value="mixed">Â§çÊùÇ üòï</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label" for="personalReflection">‰∏™‰∫∫ÂèçÊÄù</label>
        <textarea id="personalReflection" class="form-input form-textarea" placeholder="Ëøô‰∏™Êó∂ÂàªÂØπ‰Ω†ÊÑèÂë≥ÁùÄ‰ªÄ‰πàÔºü‰Ω†ÁöÑÊÑüÊÉ≥ÂíåÊÄùËÄÉ..."></textarea>
      </div>
      
      <div class="action-buttons">
        <button type="submit" class="btn-emo">
          <i class="fas fa-save"></i> ‰øùÂ≠òÊó∂Âàª
        </button>
        <button type="button" class="btn-emo btn-emo-secondary" onclick="closeCreateMomentModal()">
          <i class="fas fa-times"></i> ÂèñÊ∂à
        </button>
      </div>
    </form>
  </div>
</div>

<script>
// ÂÖ®Â±ÄÂèòÈáè
let selectedTags = new Set();
let personProfiles = [];
let relationshipTags = [];

// È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ
document.addEventListener('DOMContentLoaded', function() {
  loadDashboardData();
  loadRelationshipTags();
  initStarSelector();
  initCurrentDate();
});

// Âä†ËΩΩ‰ª™Ë°®ÁõòÊï∞ÊçÆ
async function loadDashboardData() {
  try {
    const response = await fetch('/tools/api/meetsomeone/dashboard-stats/');
    const data = await response.json();
    
    if (data.status === 'success') {
      displayStats(data.data.stats);
      displayRecentInteractions(data.data.recent_interactions);
      displayPendingReminders(data.data.pending_reminders);
    } else {
      showError('Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•: ' + data.message);
    }
  } catch (error) {
    console.error('Error loading dashboard data:', error);
    showError('ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï');
  }
}

// ÊòæÁ§∫ÁªüËÆ°Êï∞ÊçÆ
function displayStats(stats) {
  const statsGrid = document.getElementById('statsGrid');
  statsGrid.innerHTML = `
    <div class="stat-card clickable" onclick="showPeopleList()">
      <div class="stat-number">${stats.total_people}</div>
      <div class="stat-label">‰∫∫Áâ©Ê°£Ê°à</div>
    </div>
    <div class="stat-card clickable" onclick="showInteractionsList()">
      <div class="stat-number">${stats.total_interactions}</div>
      <div class="stat-label">‰∫íÂä®ËÆ∞ÂΩï</div>
    </div>
    <div class="stat-card clickable" onclick="showActiveRelationships()">
      <div class="stat-number">${stats.active_relationships}</div>
      <div class="stat-label">Ê¥ªË∑ÉÂÖ≥Á≥ª</div>
    </div>
    <div class="stat-card clickable" onclick="showMomentsList()">
      <div class="stat-number">${stats.total_moments}</div>
      <div class="stat-label">ÈáçË¶ÅÊó∂Âàª</div>
    </div>
  `;
}

// ÊòæÁ§∫ÊúÄËøë‰∫íÂä®
function displayRecentInteractions(interactions) {
  const container = document.getElementById('recentInteractions');
  
  if (interactions.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-comments"></i>
        <p>ËøòÊ≤°Êúâ‰∫íÂä®ËÆ∞ÂΩï<br>ÂºÄÂßãÂàõÂª∫‰Ω†ÁöÑÁ¨¨‰∏ÄÊù°ËÆ∞ÂΩïÂêßÔºÅ</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = interactions.map(interaction => `
    <div class="interaction-item">
      <div class="interaction-avatar">
        ${interaction.person_name.charAt(0)}
      </div>
      <div class="interaction-content">
        <div class="interaction-title">${interaction.title}</div>
        <div class="interaction-meta">
          ${interaction.person_name} ‚Ä¢ ${interaction.date} ‚Ä¢ ${interaction.interaction_type} ${interaction.mood_emoji}
        </div>
      </div>
    </div>
  `).join('');
}

// ÊòæÁ§∫ÂæÖÂäûÊèêÈÜí
function displayPendingReminders(reminders) {
  const container = document.getElementById('pendingReminders');
  
  if (reminders.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-bell"></i>
        <p>ÊöÇÊó†ÂæÖÂäûÊèêÈÜí</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = reminders.map(reminder => `
    <div class="reminder-item">
      <div class="reminder-icon">
        <i class="fas fa-bell"></i>
      </div>
      <div class="reminder-content">
        <div class="reminder-title">${reminder.title}</div>
        <div class="reminder-date">${reminder.person_name} ‚Ä¢ ${reminder.reminder_date}</div>
      </div>
    </div>
  `).join('');
}

// Âä†ËΩΩÂÖ≥Á≥ªÊ†áÁ≠æ
async function loadRelationshipTags() {
  try {
    const response = await fetch('/tools/api/meetsomeone/relationship-tags/');
    const data = await response.json();
    
    if (data.status === 'success') {
      relationshipTags = data.data;
      displayRelationshipTags();
    }
  } catch (error) {
    console.error('Error loading relationship tags:', error);
  }
}

// ÊòæÁ§∫ÂÖ≥Á≥ªÊ†áÁ≠æ
function displayRelationshipTags() {
  const container = document.getElementById('relationshipTags');
  container.innerHTML = relationshipTags.map(tag => `
    <div class="tag-item" data-tag-id="${tag.id}" style="border-color: ${tag.color}" onclick="toggleTag(${tag.id})">
      ${tag.name}
    </div>
  `).join('');
}

// ÂàáÊç¢Ê†áÁ≠æÈÄâÊã©
function toggleTag(tagId) {
  const tagElement = document.querySelector(`[data-tag-id="${tagId}"]`);
  
  if (selectedTags.has(tagId)) {
    selectedTags.delete(tagId);
    tagElement.classList.remove('selected');
  } else {
    selectedTags.add(tagId);
    tagElement.classList.add('selected');
  }
}

// ÂàùÂßãÂåñÊòüÁ∫ßÈÄâÊã©Âô®
function initStarSelector() {
  const starButtons = document.querySelectorAll('.star-btn');
  
  starButtons.forEach((btn, index) => {
    btn.addEventListener('click', function() {
      const value = parseInt(this.dataset.value);
      document.getElementById('personImportance').value = value;
      
      // Êõ¥Êñ∞ÊòüÁ∫ßÊòæÁ§∫
      starButtons.forEach((star, i) => {
        star.classList.toggle('active', i < value);
      });
    });
  });
  
  // ËÆæÁΩÆÈªòËÆ§ÂÄº
  const defaultValue = 3;
  starButtons.forEach((star, i) => {
    star.classList.toggle('active', i < defaultValue);
  });
}

// ÂàùÂßãÂåñÂΩìÂâçÊó•Êúü
function initCurrentDate() {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('interactionDate').value = today;
}

// ÊâìÂºÄÂàõÂª∫‰∫∫Áâ©Ê°£Ê°àÊ®°ÊÄÅÊ°Ü
function openCreatePersonModal() {
  document.getElementById('createPersonModal').style.display = 'block';
  loadPersonProfiles(); // ‰∏∫‰∫íÂä®ËÆ∞ÂΩïÂáÜÂ§áÊï∞ÊçÆ
}

// ÂÖ≥Èó≠ÂàõÂª∫‰∫∫Áâ©Ê°£Ê°àÊ®°ÊÄÅÊ°Ü
function closeCreatePersonModal() {
  document.getElementById('createPersonModal').style.display = 'none';
  document.getElementById('createPersonForm').reset();
  selectedTags.clear();
  document.querySelectorAll('.tag-item').forEach(tag => tag.classList.remove('selected'));
  
  // ÈáçÁΩÆÊòüÁ∫ß
  const starButtons = document.querySelectorAll('.star-btn');
  starButtons.forEach((star, i) => {
    star.classList.toggle('active', i < 3);
  });
  document.getElementById('personImportance').value = 3;
}

// ÊâìÂºÄÂàõÂª∫‰∫íÂä®ËÆ∞ÂΩïÊ®°ÊÄÅÊ°Ü
function openCreateInteractionModal() {
  document.getElementById('createInteractionModal').style.display = 'block';
  loadPersonProfiles();
}

// ÂÖ≥Èó≠ÂàõÂª∫‰∫íÂä®ËÆ∞ÂΩïÊ®°ÊÄÅÊ°Ü
function closeCreateInteractionModal() {
  document.getElementById('createInteractionModal').style.display = 'none';
  document.getElementById('createInteractionForm').reset();
  initCurrentDate();
}

// ÊâìÂºÄÂàõÂª∫ÈáçË¶ÅÊó∂ÂàªÊ®°ÊÄÅÊ°Ü
function openCreateMomentModal() {
  document.getElementById('createMomentModal').style.display = 'block';
  loadPersonProfiles();
  populateMomentPersonSelect();
  initCurrentDate();
}

// ÂÖ≥Èó≠ÂàõÂª∫ÈáçË¶ÅÊó∂ÂàªÊ®°ÊÄÅÊ°Ü
function closeCreateMomentModal() {
  document.getElementById('createMomentModal').style.display = 'none';
  document.getElementById('createMomentForm').reset();
}

// Â°´ÂÖÖÈáçË¶ÅÊó∂Âàª‰∫∫Áâ©ÈÄâÊã©‰∏ãÊãâÊ°Ü
function populateMomentPersonSelect() {
  const select = document.getElementById('momentPerson');
  
  if (personProfiles.length === 0) {
    select.innerHTML = '<option value="">ËØ∑ÂÖàÂàõÂª∫‰∫∫Áâ©Ê°£Ê°à</option>';
    return;
  }
  
  select.innerHTML = `
    <option value="">ËØ∑ÈÄâÊã©...</option>
    ${personProfiles.map(person => `
      <option value="${person.id}">${person.name}${person.nickname ? ` (${person.nickname})` : ''}</option>
    `).join('')}
  `;
}

// Âä†ËΩΩ‰∫∫Áâ©Ê°£Ê°àÂàóË°®
async function loadPersonProfiles() {
  try {
    const response = await fetch('/tools/api/meetsomeone/person-profiles/?page_size=100');
    const data = await response.json();
    
    if (data.status === 'success') {
      personProfiles = data.data.profiles;
      populatePersonSelect();
    }
  } catch (error) {
    console.error('Error loading person profiles:', error);
  }
}

// Â°´ÂÖÖ‰∫∫Áâ©ÈÄâÊã©‰∏ãÊãâÊ°Ü
function populatePersonSelect() {
  const select = document.getElementById('interactionPerson');
  const currentOptions = select.innerHTML;
  
  if (personProfiles.length === 0) {
    select.innerHTML = `
      <option value="">ËØ∑ÂÖàÂàõÂª∫‰∫∫Áâ©Ê°£Ê°à</option>
    `;
    return;
  }
  
  select.innerHTML = `
    <option value="">ËØ∑ÈÄâÊã©...</option>
    ${personProfiles.map(person => `
      <option value="${person.id}">${person.name}${person.nickname ? ` (${person.nickname})` : ''}</option>
    `).join('')}
  `;
}

// ÂàõÂª∫‰∫∫Áâ©Ê°£Ê°àË°®ÂçïÊèê‰∫§
document.getElementById('createPersonForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const formData = {
    name: document.getElementById('personName').value.trim(),
    nickname: document.getElementById('personNickname').value.trim(),
    importance_level: parseInt(document.getElementById('personImportance').value),
    first_met_date: document.getElementById('firstMetDate').value || null,
    first_met_location: document.getElementById('firstMetLocation').value.trim(),
    occupation: document.getElementById('personOccupation').value.trim(),
    relationship_tag_ids: Array.from(selectedTags)
  };
  
  try {
    const response = await fetch('/tools/api/meetsomeone/person-profiles/create/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify(formData)
    });
    
    const data = await response.json();
    
    if (data.status === 'success') {
      showSuccess('‰∫∫Áâ©Ê°£Ê°àÂàõÂª∫ÊàêÂäüÔºÅ');
      closeCreatePersonModal();
      loadDashboardData(); // Âà∑Êñ∞È°µÈù¢Êï∞ÊçÆ
    } else {
      showError(data.message);
    }
  } catch (error) {
    console.error('Error creating person profile:', error);
    showError('ÂàõÂª∫Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï');
  }
});

// ÂàõÂª∫‰∫íÂä®ËÆ∞ÂΩïË°®ÂçïÊèê‰∫§
document.getElementById('createInteractionForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const formData = {
    person_id: parseInt(document.getElementById('interactionPerson').value),
    title: document.getElementById('interactionTitle').value.trim(),
    interaction_type: document.getElementById('interactionType').value,
    date: document.getElementById('interactionDate').value,
    content: document.getElementById('interactionContent').value.trim(),
    mood: document.getElementById('interactionMood').value || null
  };
  
  try {
    const response = await fetch('/tools/api/meetsomeone/interactions/create/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify(formData)
    });
    
    const data = await response.json();
    
    if (data.status === 'success') {
      showSuccess('‰∫íÂä®ËÆ∞ÂΩïÂàõÂª∫ÊàêÂäüÔºÅ');
      closeCreateInteractionModal();
      loadDashboardData(); // Âà∑Êñ∞È°µÈù¢Êï∞ÊçÆ
    } else {
      showError(data.message);
    }
  } catch (error) {
    console.error('Error creating interaction:', error);
    showError('ÂàõÂª∫Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï');
  }
});

// ÂàõÂª∫ÈáçË¶ÅÊó∂ÂàªË°®ÂçïÊèê‰∫§
document.getElementById('createMomentForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const formData = {
    person_id: parseInt(document.getElementById('momentPerson').value),
    title: document.getElementById('momentTitle').value.trim(),
    moment_type: document.getElementById('momentType').value,
    date: document.getElementById('momentDate').value,
    location: document.getElementById('momentLocation').value.trim(),
    description: document.getElementById('momentDescription').value.trim(),
    emotional_impact: document.getElementById('emotionalImpact').value,
    personal_reflection: document.getElementById('personalReflection').value.trim()
  };
  
  try {
    const response = await fetch('/tools/api/meetsomeone/moments/create/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify(formData)
    });
    
    const data = await response.json();
    
    if (data.status === 'success') {
      showSuccess('ÈáçË¶ÅÊó∂ÂàªËÆ∞ÂΩïÊàêÂäüÔºÅ');
      closeCreateMomentModal();
      loadDashboardData(); // Âà∑Êñ∞È°µÈù¢Êï∞ÊçÆ
    } else {
      showError(data.message);
    }
  } catch (error) {
    console.error('Error creating important moment:', error);
    showError('ÂàõÂª∫Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï');
  }
});

// Â∑•ÂÖ∑ÂáΩÊï∞
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

function showSuccess(message) {
  // ËøôÈáåÂèØ‰ª•ÂÆûÁé∞‰∏Ä‰∏™ÊàêÂäüÊèêÁ§∫ÁªÑ‰ª∂
  alert(message);
}

function showError(message) {
  // ËøôÈáåÂèØ‰ª•ÂÆûÁé∞‰∏Ä‰∏™ÈîôËØØÊèêÁ§∫ÁªÑ‰ª∂
  alert(message);
}

// ÁªüËÆ°Âç°ÁâáÁÇπÂáªÂáΩÊï∞
function showPeopleList() {
  // ÊòæÁ§∫‰∫∫Áâ©Ê°£Ê°àÂàóË°®
  if (personProfiles.length === 0) {
    showError('ÊöÇÊó†‰∫∫Áâ©Ê°£Ê°àÊï∞ÊçÆ');
    return;
  }
  
  let content = '<div class="people-list"><h3>‰∫∫Áâ©Ê°£Ê°àÂàóË°®</h3>';
  personProfiles.slice(0, 10).forEach(person => {
    content += `
      <div class="person-item">
        <strong>${person.name}</strong>
        ${person.nickname ? `(${person.nickname})` : ''}
        - ${person.occupation || 'Êú™Áü•ËÅå‰∏ö'}
        <br><small>ÈáçË¶ÅÁ®ãÂ∫¶: ${'‚≠ê'.repeat(person.importance_level)}</small>
      </div>
    `;
  });
  if (personProfiles.length > 10) {
    content += `<p><small>ËøòÊúâ ${personProfiles.length - 10} ‰∏™‰∫∫Áâ©Ê°£Ê°à...</small></p>`;
  }
  content += '</div>';
  
  showInfo(content);
}

function showInteractionsList() {
  showInfo('‰∫íÂä®ËÆ∞ÂΩïÂäüËÉΩÔºöÊü•ÁúãÊúÄËøëÁöÑ‰∫íÂä®ËÆ∞ÂΩï„ÄÇÁÇπÂáª‰∏äÊñπ"ËÆ∞ÂΩï‰∫íÂä®"ÊåâÈíÆÊ∑ªÂä†Êñ∞ÁöÑ‰∫íÂä®ËÆ∞ÂΩï„ÄÇ');
}

function showActiveRelationships() {
  showInfo('Ê¥ªË∑ÉÂÖ≥Á≥ªÔºöÊòæÁ§∫ÊúÄËøë30Â§©ÂÜÖÊúâ‰∫íÂä®ÁöÑ‰∫∫ÈôÖÂÖ≥Á≥ª„ÄÇ‰øùÊåÅÂÆöÊúü‰∫íÂä®ÊúâÂä©‰∫éÁª¥Êä§ËâØÂ•ΩÁöÑ‰∫∫ÈôÖÂÖ≥Á≥ª„ÄÇ');
}

function showMomentsList() {
  showInfo('ÈáçË¶ÅÊó∂ÂàªÔºöËÆ∞ÂΩï‰∫∫Áîü‰∏≠ÁöÑÈáçË¶ÅÊó∂ÂàªÂíåÈáåÁ®ãÁ¢ë„ÄÇÁÇπÂáª‰∏äÊñπ"ÈáçË¶ÅÊó∂Âàª"ÊåâÈíÆÊ∑ªÂä†Êñ∞ÁöÑËÆ∞ÂΩï„ÄÇ');
}

function showInfo(content) {
  // ÂàõÂª∫‰∏Ä‰∏™ÁÆÄÂçïÁöÑ‰ø°ÊÅØÊòæÁ§∫Ê°Ü
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); z-index: 1000; display: flex;
    align-items: center; justify-content: center;
  `;
  
  const content_div = document.createElement('div');
  content_div.style.cssText = `
    background: white; padding: 20px; border-radius: 8px;
    max-width: 500px; max-height: 400px; overflow-y: auto;
    position: relative;
  `;
  content_div.innerHTML = content + '<br><button onclick="this.closest(\'.info-modal\').remove()">ÂÖ≥Èó≠</button>';
  
  modal.className = 'info-modal';
  modal.appendChild(content_div);
  document.body.appendChild(modal);
  
  // ÁÇπÂáªËÉåÊôØÂÖ≥Èó≠
  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      modal.remove();
    }
  });
}

// ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
window.addEventListener('click', function(event) {
  const createPersonModal = document.getElementById('createPersonModal');
  const createInteractionModal = document.getElementById('createInteractionModal');
  const createMomentModal = document.getElementById('createMomentModal');
  
  if (event.target === createPersonModal) {
    closeCreatePersonModal();
  }
  if (event.target === createInteractionModal) {
    closeCreateInteractionModal();
  }
  if (event.target === createMomentModal) {
    closeCreateMomentModal();
  }
});
</script>
{% endblock %}
