{% extends 'base.html' %}
{% load static %}

{% block title %}1RM计算器 - QAToolBox{% endblock %}

{% block extra_css %}
<style>
.calculator-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 40px 20px;
}

.calculator-header {
    text-align: center;
    margin-bottom: 40px;
}

.calculator-header h1 {
    color: var(--primary-color, #667eea);
    font-size: 2.5rem;
    margin-bottom: 15px;
}

.calculator-header p {
    color: #666;
    font-size: 1.1rem;
    line-height: 1.6;
}

.calculator-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
    margin-bottom: 40px;
}

.calculator-card {
    background: white;
    border-radius: 15px;
    padding: 30px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.calculator-card h2 {
    color: var(--primary-color, #667eea);
    font-size: 1.5rem;
    margin-bottom: 20px;
    text-align: center;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #333;
}

.form-group input,
.form-group select {
    width: 100%;
    padding: 12px;
    border: 2px solid #e1e5e9;
    border-radius: 8px;
    font-size: 16px;
    transition: border-color 0.3s ease;
}

.form-group input:focus,
.form-group select:focus {
    outline: none;
    border-color: var(--primary-color, #667eea);
}

.input-row {
    display: grid;
    grid-template-columns: 1fr auto 1fr auto;
    gap: 10px;
    align-items: end;
}

.input-row .form-group {
    margin-bottom: 0;
}

.input-row .unit {
    font-weight: 600;
    color: #666;
    padding: 12px 0;
}

.calculate-btn {
    width: 100%;
    padding: 15px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.3s ease;
}

.calculate-btn:hover {
    transform: translateY(-2px);
}

.result-section {
    background: white;
    border-radius: 15px;
    padding: 30px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    margin-bottom: 30px;
}

.result-header {
    text-align: center;
    margin-bottom: 30px;
}

.result-header h2 {
    color: var(--primary-color, #667eea);
    font-size: 1.8rem;
    margin-bottom: 10px;
}

.one-rm-result {
    text-align: center;
    margin-bottom: 30px;
}

.one-rm-value {
    font-size: 3rem;
    font-weight: bold;
    color: var(--primary-color, #667eea);
    margin-bottom: 10px;
}

.one-rm-label {
    color: #666;
    font-size: 1.1rem;
}

.formula-info {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
    text-align: center;
}

.formula-name {
    font-weight: 600;
    color: #333;
    margin-bottom: 5px;
}

.formula-description {
    color: #666;
    font-size: 0.9rem;
}

.results-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.result-card {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    text-align: center;
}

.result-card h3 {
    color: #333;
    font-size: 1.1rem;
    margin-bottom: 15px;
}

.weight-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--primary-color, #667eea);
    margin-bottom: 5px;
}

.reps-info {
    color: #666;
    font-size: 0.9rem;
}

.training-recommendations {
    background: #e8f4fd;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
}

.training-recommendations h3 {
    color: #2c5aa0;
    font-size: 1.2rem;
    margin-bottom: 15px;
    text-align: center;
}

.recommendation-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

.recommendation-item {
    background: white;
    border-radius: 8px;
    padding: 15px;
    text-align: center;
}

.recommendation-type {
    font-weight: 600;
    color: #2c5aa0;
    margin-bottom: 5px;
}

.recommendation-weight {
    font-size: 1.2rem;
    font-weight: bold;
    color: #333;
    margin-bottom: 5px;
}

.recommendation-desc {
    color: #666;
    font-size: 0.9rem;
}

.warning-section {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 10px;
    padding: 20px;
    margin-top: 30px;
}

.warning-section h3 {
    color: #856404;
    font-size: 1.2rem;
    margin-bottom: 15px;
}

.warning-section ul {
    color: #856404;
    margin: 0;
    padding-left: 20px;
}

.warning-section li {
    margin-bottom: 8px;
}

@media (max-width: 768px) {
    .calculator-grid {
        grid-template-columns: 1fr;
    }
    
    .input-row {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .input-row .unit {
        text-align: center;
    }
    
    .results-grid {
        grid-template-columns: 1fr;
    }
    
    .recommendation-grid {
        grid-template-columns: 1fr;
    }
}

.loading {
    text-align: center;
    padding: 20px;
    color: #666;
}

.error-message {
    background: #f8d7da;
    color: #721c24;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    text-align: center;
}

.success-message {
    background: #d4edda;
    color: #155724;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    text-align: center;
}
</style>
{% endblock %}

{% block content %}
<div class="calculator-container">
    <div class="calculator-header">
        <h1>1RM计算器</h1>
        <p>科学计算您的一次最大重复重量，为训练计划提供精确指导</p>
    </div>

    <div class="calculator-grid">
        <!-- 1RM计算器 -->
        <div class="calculator-card">
            <h2>计算1RM</h2>
            <form id="oneRmForm">
                <div class="form-group">
                    <label for="formula">计算公式</label>
                    <select id="formula" name="formula">
                        <option value="epley">埃普勒公式 (最常用)</option>
                        <option value="brzycki">布日奇克公式 (高次数更准确)</option>
                        <option value="lombardi">隆巴迪公式 (通用)</option>
                        <option value="oconner">奥康纳公式 (简单易用)</option>
                    </select>
                </div>
                
                <div class="input-row">
                    <div class="form-group">
                        <label for="weight">重量</label>
                        <input type="number" id="weight" name="weight" step="0.1" min="0" placeholder="80" required>
                    </div>
                    <div class="unit">kg</div>
                    <div class="form-group">
                        <label for="reps">重复次数</label>
                        <input type="number" id="reps" name="reps" min="1" max="20" placeholder="10" required>
                    </div>
                    <div class="unit">次</div>
                </div>
                
                <button type="submit" class="calculate-btn">
                    <i class="fas fa-calculator"></i> 计算1RM
                </button>
            </form>
        </div>

        <!-- 次数预测器 -->
        <div class="calculator-card">
            <h2>预测重复次数</h2>
            <form id="predictRepsForm">
                <div class="form-group">
                    <label for="predictFormula">计算公式</label>
                    <select id="predictFormula" name="formula">
                        <option value="epley">埃普勒公式</option>
                        <option value="brzycki">布日奇克公式</option>
                        <option value="lombardi">隆巴迪公式</option>
                        <option value="oconner">奥康纳公式</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="targetWeight">目标重量</label>
                    <input type="number" id="targetWeight" name="targetWeight" step="0.1" min="0" placeholder="100" required>
                </div>
                
                <div class="form-group">
                    <label>已知数据 (选择一种方式)</label>
                    <div style="margin-top: 10px;">
                        <div class="input-row">
                            <div class="form-group">
                                <label for="knownWeight">重量</label>
                                <input type="number" id="knownWeight" name="knownWeight" step="0.1" min="0" placeholder="80">
                            </div>
                            <div class="unit">kg</div>
                            <div class="form-group">
                                <label for="knownReps">次数</label>
                                <input type="number" id="knownReps" name="knownReps" min="1" max="20" placeholder="10">
                            </div>
                            <div class="unit">次</div>
                        </div>
                        <div style="text-align: center; margin: 10px 0; color: #666;">或</div>
                        <div class="form-group">
                            <label for="oneRepMax">已知1RM</label>
                            <input type="number" id="oneRepMax" name="oneRepMax" step="0.1" min="0" placeholder="107">
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="calculate-btn">
                    <i class="fas fa-chart-line"></i> 预测次数
                </button>
            </form>
        </div>
    </div>

    <!-- 结果显示区域 -->
    <div id="resultSection" class="result-section" style="display: none;">
        <div class="result-header">
            <h2>计算结果</h2>
        </div>
        
        <div id="oneRmResult" class="one-rm-result">
            <!-- 1RM结果将在这里显示 -->
        </div>
        
        <div id="formulaInfo" class="formula-info">
            <!-- 公式信息将在这里显示 -->
        </div>
        
        <div id="repWeights" class="results-grid">
            <!-- 不同重复次数的重量将在这里显示 -->
        </div>
        
        <div id="trainingRecommendations" class="training-recommendations">
            <!-- 训练建议将在这里显示 -->
        </div>
    </div>

    <!-- 预测结果区域 -->
    <div id="predictResultSection" class="result-section" style="display: none;">
        <div class="result-header">
            <h2>预测结果</h2>
        </div>
        
        <div id="predictResult" class="one-rm-result">
            <!-- 预测结果将在这里显示 -->
        </div>
    </div>

    <!-- 警告和免责声明 -->
    <div class="warning-section">
        <h3><i class="fas fa-exclamation-triangle"></i> 重要提醒</h3>
        <ul>
            <li>本计算器提供的所有数据均为理论估计值，并非医疗或专业建议</li>
            <li>实际力量水平会因个人体能、技术、疲劳程度和当天状态而异</li>
            <li>切勿在无人保护的情况下独自尝试极限重量（1RM）</li>
            <li>训练时务必寻求合格的教练进行现场指导与保护</li>
            <li>确保使用安全装备（如卧推架安全销）</li>
            <li>安全第一，量力而行</li>
        </ul>
    </div>
</div>

<script>
// 1RM计算
document.getElementById('oneRmForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {
        weight: parseFloat(formData.get('weight')),
        reps: parseInt(formData.get('reps')),
        formula: formData.get('formula')
    };
    
    calculateOneRM(data);
});

// 次数预测
document.getElementById('predictRepsForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {
        target_weight: parseFloat(formData.get('targetWeight')),
        formula: formData.get('formula')
    };
    
    // 检查是否有已知重量和次数
    const knownWeight = parseFloat(formData.get('knownWeight'));
    const knownReps = parseInt(formData.get('knownReps'));
    
    if (knownWeight && knownReps) {
        data.known_weight = knownWeight;
        data.known_reps = knownReps;
    } else {
        const oneRepMax = parseFloat(formData.get('oneRepMax'));
        if (oneRepMax) {
            data.one_rep_max = oneRepMax;
        } else {
            alert('请提供已知重量和次数，或已知1RM');
            return;
        }
    }
    
    predictReps(data);
});

function calculateOneRM(data) {
    showLoading('oneRmResult', '正在计算1RM...');
    
    fetch('/tools/api/fitness/one-rm/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            displayOneRMResult(result.data);
        } else {
            showError('oneRmResult', result.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError('oneRmResult', '计算过程中出现错误');
    });
}

function predictReps(data) {
    showLoading('predictResult', '正在预测重复次数...');
    
    fetch('/tools/api/fitness/predict-reps/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            displayPredictResult(result.data);
        } else {
            showError('predictResult', result.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError('predictResult', '预测过程中出现错误');
    });
}

function displayOneRMResult(data) {
    // 显示1RM结果
    document.getElementById('oneRmResult').innerHTML = `
        <div class="one-rm-value">${data.one_rep_max} kg</div>
        <div class="one-rm-label">您的预测1RM</div>
    `;
    
    // 显示公式信息
    document.getElementById('formulaInfo').innerHTML = `
        <div class="formula-name">${data.formula_used}</div>
        <div class="formula-description">${data.formula_description}</div>
    `;
    
    // 显示不同重复次数的重量
    const repWeightsHtml = Object.entries(data.rep_weights).map(([reps, weight]) => `
        <div class="result-card">
            <h3>${reps}次重复</h3>
            <div class="weight-value">${weight} kg</div>
            <div class="reps-info">建议重量</div>
        </div>
    `).join('');
    
    document.getElementById('repWeights').innerHTML = repWeightsHtml;
    
    // 显示训练建议
    const recommendationsHtml = Object.entries(data.training_recommendations).map(([type, rec]) => `
        <div class="recommendation-item">
            <div class="recommendation-type">${getTrainingTypeName(type)}</div>
            <div class="recommendation-weight">${rec.weight}</div>
            <div class="recommendation-desc">${rec.reps} - ${rec.description}</div>
        </div>
    `).join('');
    
    document.getElementById('trainingRecommendations').innerHTML = `
        <h3>训练建议</h3>
        <div class="recommendation-grid">
            ${recommendationsHtml}
        </div>
    `;
    
    // 显示结果区域
    document.getElementById('resultSection').style.display = 'block';
    document.getElementById('predictResultSection').style.display = 'none';
}

function displayPredictResult(data) {
    document.getElementById('predictResult').innerHTML = `
        <div class="one-rm-value">${data.predicted_reps} 次</div>
        <div class="one-rm-label">预测可完成的重复次数</div>
        <div style="margin-top: 20px; color: #666;">
            目标重量: ${data.target_weight} kg<br>
            使用公式: ${data.formula_used}
        </div>
    `;
    
    // 显示预测结果区域
    document.getElementById('predictResultSection').style.display = 'block';
    document.getElementById('resultSection').style.display = 'none';
}

function getTrainingTypeName(type) {
    const names = {
        'strength': '力量训练',
        'hypertrophy': '增肌训练',
        'endurance': '耐力训练'
    };
    return names[type] || type;
}

function showLoading(elementId, message) {
    document.getElementById(elementId).innerHTML = `
        <div class="loading">
            <i class="fas fa-spinner fa-spin"></i> ${message}
        </div>
    `;
}

function showError(elementId, message) {
    document.getElementById(elementId).innerHTML = `
        <div class="error-message">
            <i class="fas fa-exclamation-circle"></i> ${message}
        </div>
    `;
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// 页面加载完成后的初始化
document.addEventListener('DOMContentLoaded', function() {

});
</script>
{% endblock %}
