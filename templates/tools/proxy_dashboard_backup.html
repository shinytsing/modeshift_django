{% extends 'base.html' %}
{% load static %}

{% block title %}代理系统 - 极客模式{% endblock %}

{% block extra_css %}
<style>
/* 代理翻墙功能样式 */
.proxy-container {
    min-height: 100vh;
    background: linear-gradient(135deg, #0a0e17 0%, #1a1f2e 100%);
    color: #e6e6e6;
    font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
    padding: 2rem;
    position: relative;
    overflow: hidden;
}

/* Web代理浏览器样式 */
.proxy-input-group {
    display: flex;
    gap: 10px;
    margin: 15px 0;
}

.proxy-input {
    flex: 1;
    padding: 10px 15px;
    background: rgba(26, 31, 46, 0.8);
    border: 1px solid rgba(0, 255, 231, 0.3);
    border-radius: 8px;
    color: #e6e6e6;
    font-family: 'JetBrains Mono', monospace;
    font-size: 14px;
    outline: none;
    transition: all 0.3s ease;
}

.proxy-input:focus {
    border-color: #00ffe7;
    box-shadow: 0 0 10px rgba(0, 255, 231, 0.2);
}

.quick-links-mini {
    display: flex;
    gap: 8px;
    margin: 10px 0;
    flex-wrap: wrap;
}

.quick-link-btn {
    padding: 6px 12px;
    background: rgba(0, 191, 255, 0.1);
    border: 1px solid rgba(0, 191, 255, 0.3);
    border-radius: 15px;
    color: #00bfff;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: 'JetBrains Mono', monospace;
}

.quick-link-btn:hover {
    background: rgba(0, 191, 255, 0.2);
    border-color: #00bfff;
    transform: translateY(-1px);
}

.proxy-status {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 10px;
    font-size: 12px;
    color: #888;
}

.status-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #dc3545;
    transition: background 0.3s ease;
}

.status-indicator.online {
    background: #28a745;
}

.proxy-container::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: 
        radial-gradient(circle at 20% 80%, rgba(0, 255, 231, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(0, 191, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(255, 107, 157, 0.05) 0%, transparent 50%);
    z-index: -1;
    animation: geekMatrix 25s ease-in-out infinite;
}

@keyframes geekMatrix {
    0%, 100% { 
        transform: translateY(0px) rotate(0deg);
        opacity: 0.8;
    }
    33% { 
        transform: translateY(-10px) rotate(0.5deg);
        opacity: 1;
    }
    66% { 
        transform: translateY(5px) rotate(-0.5deg);
        opacity: 0.9;
    }
}

.proxy-header {
    text-align: center;
    margin-bottom: 3rem;
}

.proxy-title {
    color: #00ffe7;
    font-size: 3rem;
    font-weight: 700;
    margin-bottom: 1rem;
    letter-spacing: 2px;
    text-shadow: 0 0 20px rgba(0, 255, 231, 0.5);
    animation: geekGlow 2s ease-in-out infinite alternate;
}

@keyframes geekGlow {
    from { text-shadow: 0 0 20px rgba(0, 255, 231, 0.5); }
    to { text-shadow: 0 0 30px rgba(0, 255, 231, 0.8), 0 0 40px rgba(0, 255, 231, 0.3); }
}

.proxy-subtitle {
    color: #8a9ba8;
    font-size: 1.2rem;
    margin-bottom: 2rem;
}

.proxy-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 2rem;
    margin-bottom: 3rem;
}

.proxy-card {
    background: linear-gradient(135deg, rgba(26,31,46,0.9) 0%, rgba(0,255,231,0.1) 100%);
    border: 1px solid rgba(0, 255, 231, 0.1);
    border-radius: 16px;
    padding: 2rem;
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.proxy-card::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(135deg, #00ffe7 0%, #00bfff 50%, #ff6b9d 100%);
    transform: scaleX(0);
    transition: transform 0.3s ease;
}

.proxy-card:hover::after {
    transform: scaleX(1);
}

.proxy-card:hover {
    transform: translateY(-4px) scale(1.02);
    border-color: #00ffe7;
    box-shadow: 0 8px 32px rgba(0, 255, 231, 0.2);
}

.proxy-card-title {
    color: #00ffe7;
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.proxy-card-title i {
    font-size: 1.2rem;
}

.proxy-status {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #ff4444;
    animation: pulse 2s infinite;
}

.status-indicator.working {
    background: #00ff41;
}

.status-indicator.testing {
    background: #ffaa00;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.proxy-btn {
    background: linear-gradient(135deg, #00ffe7 0%, #00bfff 50%, #ff6b9d 100%);
    color: #0a0e17;
    border: none;
    border-radius: 8px;
    padding: 0.8rem 1.5rem;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: inherit;
    margin: 0.5rem;
}

.proxy-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0, 255, 231, 0.3);
}

.proxy-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.proxy-btn.secondary {
    background: transparent;
    color: #00ffe7;
    border: 2px solid #00ffe7;
}

.proxy-btn.secondary:hover {
    background: #00ffe7;
    color: #0a0e17;
}

.proxy-results {
    background: rgba(26, 31, 46, 0.8);
    border: 1px solid rgba(0, 255, 231, 0.2);
    border-radius: 8px;
    padding: 1rem;
    margin-top: 1rem;
    max-height: 300px;
    overflow-y: auto;
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
}

.proxy-result-item {
    padding: 0.5rem;
    margin-bottom: 0.5rem;
    border-radius: 4px;
    border-left: 3px solid #00ffe7;
}

.proxy-result-item.success {
    background: rgba(0, 255, 65, 0.1);
    border-left-color: #00ff41;
}

.proxy-result-item.error {
    background: rgba(255, 68, 68, 0.1);
    border-left-color: #ff4444;
}

.proxy-result-item.warning {
    background: rgba(255, 170, 0, 0.1);
    border-left-color: #ffaa00;
}

.proxy-input {
    background: rgba(26, 31, 46, 0.8);
    border: 1px solid rgba(0, 255, 231, 0.3);
    border-radius: 8px;
    padding: 0.8rem;
    color: #e6e6e6;
    font-family: inherit;
    width: 100%;
    margin-bottom: 1rem;
}

.proxy-input:focus {
    outline: none;
    border-color: #00ffe7;
    box-shadow: 0 0 0 2px rgba(0, 255, 231, 0.2);
}

.proxy-select {
    background: rgba(26, 31, 46, 0.8);
    border: 1px solid rgba(0, 255, 231, 0.3);
    border-radius: 8px;
    padding: 0.8rem;
    color: #e6e6e6;
    font-family: inherit;
    width: 100%;
    margin-bottom: 1rem;
}

.proxy-select:focus {
    outline: none;
    border-color: #00ffe7;
}

.proxy-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: rgba(26, 31, 46, 0.8);
    border: 1px solid rgba(0, 255, 231, 0.2);
    border-radius: 8px;
    padding: 1.5rem;
    text-align: center;
}

.stat-number {
    color: #00ffe7;
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.stat-label {
    color: #8a9ba8;
    font-size: 0.9rem;
}

.loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(0, 255, 231, 0.3);
    border-radius: 50%;
    border-top-color: #00ffe7;
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.proxy-terminal {
    background: #111417;
    color: #00ffe7;
    font-family: 'Courier New', monospace;
    padding: 1rem;
    border-radius: 8px;
    margin: 1rem 0;
    border: 1px solid rgba(0, 255, 231, 0.3);
    max-height: 400px;
    overflow-y: auto;
}

.proxy-terminal::before {
    content: '$ ';
    color: #00bfff;
    font-weight: bold;
}

/* 模态框样式 */
.proxy-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    backdrop-filter: blur(5px);
}

.proxy-modal-content {
    background: linear-gradient(135deg, rgba(26,31,46,0.95) 0%, rgba(0,255,231,0.1) 100%);
    border: 1px solid rgba(0, 255, 231, 0.3);
    border-radius: 16px;
    padding: 2rem;
    max-width: 500px;
    width: 90%;
    color: #e6e6e6;
    backdrop-filter: blur(15px);
    box-shadow: 0 0 30px rgba(0, 255, 231, 0.3);
}

.proxy-modal-content h3 {
    color: #00ffe7;
    margin-bottom: 1rem;
    text-align: center;
}

.config-info {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 8px;
    padding: 1rem;
    margin: 1rem 0;
    border-left: 3px solid #00ffe7;
}

.config-info p {
    margin: 0.5rem 0;
    font-family: 'JetBrains Mono', monospace;
}

.config-note {
    background: rgba(255, 107, 157, 0.1);
    border: 1px solid rgba(255, 107, 157, 0.3);
    border-radius: 8px;
    padding: 1rem;
    margin: 1rem 0;
    color: #ff6b9d;
    font-style: italic;
}

/* 成功按钮样式 */
.proxy-btn.success {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    border-color: #28a745;
}

.proxy-btn.success:hover {
    background: linear-gradient(135deg, #20c997 0%, #28a745 100%);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
}

/* 快捷访问按钮网格 */
.quick-access-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 12px;
    margin: 15px 0;
}

.quick-btn {
    background: linear-gradient(135deg, rgba(26,31,46,0.8) 0%, rgba(0,255,231,0.1) 100%);
    border: 1px solid rgba(0, 255, 231, 0.2);
    border-radius: 12px;
    padding: 15px 10px;
    color: #e6e6e6;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    font-family: inherit;
    text-decoration: none;
    position: relative;
    overflow: hidden;
}

.quick-btn:hover {
    transform: translateY(-3px);
    border-color: #00ffe7;
    box-shadow: 0 8px 25px rgba(0, 255, 231, 0.3);
}

.quick-btn i {
    font-size: 1.8rem;
    transition: transform 0.3s ease;
}

.quick-btn:hover i {
    transform: scale(1.1);
}

.quick-btn span {
    font-size: 0.9rem;
    font-weight: 600;
    letter-spacing: 0.5px;
}

/* 特定网站品牌色彩 */
.quick-btn.youtube:hover {
    border-color: #ff0000;
    box-shadow: 0 8px 25px rgba(255, 0, 0, 0.3);
}

.quick-btn.youtube:hover i {
    color: #ff0000;
}

.quick-btn.google:hover {
    border-color: #4285f4;
    box-shadow: 0 8px 25px rgba(66, 133, 244, 0.3);
}

.quick-btn.google:hover i {
    color: #4285f4;
}

.quick-btn.facebook:hover {
    border-color: #1877f2;
    box-shadow: 0 8px 25px rgba(24, 119, 242, 0.3);
}

.quick-btn.facebook:hover i {
    color: #1877f2;
}

.quick-btn.twitter:hover {
    border-color: #1da1f2;
    box-shadow: 0 8px 25px rgba(29, 161, 242, 0.3);
}

.quick-btn.twitter:hover i {
    color: #1da1f2;
}

.quick-btn.instagram:hover {
    border-color: #e4405f;
    box-shadow: 0 8px 25px rgba(228, 64, 95, 0.3);
}

.quick-btn.instagram:hover i {
    color: #e4405f;
}

.quick-btn.github:hover {
    border-color: #333;
    box-shadow: 0 8px 25px rgba(51, 51, 51, 0.3);
}

.quick-btn.github:hover i {
    color: #333;
}

/* 响应式设计 */
@media (max-width: 768px) {
    .proxy-container {
        padding: 1rem;
    }
    
    .proxy-title {
        font-size: 2rem;
    }
    
    .proxy-grid {
        grid-template-columns: 1fr;
    }
    
    .proxy-stats {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .quick-access-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}
</style>
{% endblock %}

{% block content %}
<div class="proxy-container">
    <div class="proxy-header">
        <h1 class="proxy-title">
            <i class="fas fa-shield-alt"></i>
            代理翻墙系统
        </h1>
        <p class="proxy-subtitle">🌐 专业翻墙服务 - 安全稳定访问全球网络</p>
    </div>

    <!-- 系统状态 -->
    <div class="proxy-stats" id="proxyStats">
        <div class="stat-card">
            <div class="stat-number" id="localIP">检测中...</div>
            <div class="stat-label">本地IP</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="proxyIP">检测中...</div>
            <div class="stat-label">代理IP</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="proxyStatus">检测中...</div>
            <div class="stat-label">代理状态</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="systemStatus">就绪</div>
            <div class="stat-label">系统状态</div>
        </div>
    </div>

    <!-- 商业化翻墙服务 -->
    <div class="proxy-grid">
        <!-- 服务状态检测 -->
        <div class="proxy-card">
            <h3 class="proxy-card-title">
                <i class="fas fa-shield-check"></i>
                服务状态检测
            </h3>
            <p class="proxy-description">检测您当前网络状态和我们代理服务的连接情况</p>
            <button class="proxy-btn" onclick="getIPComparison()">
                <i class="fas fa-sync-alt"></i>
                检测网络状态
            </button>
            <div class="proxy-results" id="ipComparisonResults"></div>
        </div>

        <!-- Clash内嵌代理系统 -->
        <div class="proxy-card">
            <h3 class="proxy-card-title">
                <i class="fas fa-rocket"></i>
                Clash内嵌代理
            </h3>
            <p class="proxy-description">一键启动Clash代理服务，自动管理代理节点和配置</p>
            <button class="proxy-btn success" onclick="openClashDashboard()">
                <i class="fas fa-cog"></i>
                打开Clash控制台
            </button>
        </div>



        <!-- Web代理浏览器 - 主要服务 -->
        <div class="proxy-card" style="grid-column: span 2;">
            <h3 class="proxy-card-title">
                <i class="fas fa-globe-americas"></i>
                Web代理浏览器
            </h3>
            <p class="proxy-description">无需下载软件，直接在网页内安全访问YouTube、Google等全球网站</p>
            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                <input type="text" class="proxy-input" id="webBrowserUrl" 
                       placeholder="输入网址或直接点击下方快捷按钮" style="flex: 1;">
                <button class="proxy-btn" onclick="openWebBrowser()">
                    <i class="fas fa-rocket"></i>
                    立即访问
                </button>
            </div>

            <!-- 热门网站快捷访问 -->
            <div class="quick-access-grid">
                <button class="quick-btn youtube" onclick="quickAccess('youtube.com')">
                    <i class="fab fa-youtube"></i>
                    <span>YouTube</span>
                </button>
                <button class="quick-btn google" onclick="quickAccess('google.com')">
                    <i class="fab fa-google"></i>
                    <span>Google</span>
                </button>
                <button class="quick-btn facebook" onclick="quickAccess('facebook.com')">
                    <i class="fab fa-facebook"></i>
                    <span>Facebook</span>
                </button>
                <button class="quick-btn twitter" onclick="quickAccess('twitter.com')">
                    <i class="fab fa-twitter"></i>
                    <span>Twitter</span>
                </button>
                <button class="quick-btn instagram" onclick="quickAccess('instagram.com')">
                    <i class="fab fa-instagram"></i>
                    <span>Instagram</span>
                </button>
                <button class="quick-btn github" onclick="quickAccess('github.com')">
                    <i class="fab fa-github"></i>
                    <span>GitHub</span>
                </button>
            </div>
            <div class="proxy-results" id="webBrowserResults"></div>
        </div>
    </div>

    <!-- 终端输出 -->
    <div class="proxy-terminal" id="proxyTerminal">
        代理系统已启动...
        输入 'help' 查看可用命令
    </div>
</div>

<!-- 画中画Web浏览器模态框 -->
<div class="web-browser-modal" id="webBrowserModal" style="display: none;">
    <div class="web-browser-content">
        <div class="web-browser-header">
            <div class="web-browser-controls">
                <button class="browser-btn" onclick="browserBack()">
                    <i class="fas fa-arrow-left"></i>
            </button>
                <button class="browser-btn" onclick="browserForward()">
                    <i class="fas fa-arrow-right"></i>
                </button>
                <button class="browser-btn" onclick="browserRefresh()">
                    <i class="fas fa-sync-alt"></i>
                </button>
        </div>
            <div class="web-browser-address">
                <input type="text" id="browserAddressBar" placeholder="输入网址...">
                <button class="browser-btn primary" onclick="browserNavigate()">
                    <i class="fas fa-arrow-right"></i>
            </button>
        </div>
                        <div class="web-browser-actions">
                <button class="browser-btn" onclick="openInNewWindow()" title="在新窗口打开">
                    <i class="fas fa-external-link-alt"></i>
                </button>
                <button class="browser-btn" onclick="refreshCurrentPage()" title="刷新页面">
                    <i class="fas fa-redo"></i>
                </button>
                <button class="browser-btn" onclick="toggleFullscreen()" title="全屏模式">
                    <i class="fas fa-expand"></i>
                </button>
                <button class="browser-btn" onclick="togglePictureInPicture()" title="画中画模式">
                    <i class="fas fa-compress"></i>
                </button>
                <button class="browser-btn" onclick="closeBrowser()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
    </div>
        <div class="web-browser-loading" id="browserLoading" style="display: none;">
            <div class="loading-spinner"></div>
            <span>正在加载...</span>
        </div>
        <div class="web-browser-iframe-container" id="browserContainer">
            <div class="browser-placeholder">
                <i class="fas fa-globe" style="font-size: 3rem; color: #00ffe7; margin-bottom: 1rem;"></i>
                <p>Web代理浏览器已准备就绪</p>
                <p>输入网址开始浏览外网内容</p>
            </div>
        </div>
    </div>
</div>

<style>
/* Web浏览器模态框样式 */
.web-browser-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    z-index: 2000;
    display: flex;
    justify-content: center;
    align-items: center;
}

.web-browser-content {
    background: linear-gradient(135deg, rgba(26,31,46,0.95) 0%, rgba(0,255,231,0.1) 100%);
    border: 1px solid rgba(0, 255, 231, 0.3);
    border-radius: 12px;
    width: 95%;
    height: 90%;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    backdrop-filter: blur(15px);
}

.web-browser-header {
    background: rgba(26, 31, 46, 0.8);
    padding: 10px;
    border-bottom: 1px solid rgba(0, 255, 231, 0.2);
    display: flex;
    align-items: center;
    gap: 15px;
}

.web-browser-controls {
    display: flex;
    gap: 5px;
}

.browser-btn {
    background: rgba(0, 255, 231, 0.1);
    color: #00ffe7;
    border: 1px solid rgba(0, 255, 231, 0.3);
    border-radius: 6px;
    padding: 8px 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
}

.browser-btn:hover {
    background: rgba(0, 255, 231, 0.2);
    box-shadow: 0 2px 8px rgba(0, 255, 231, 0.3);
}

.browser-btn.primary {
    background: linear-gradient(135deg, #00ffe7 0%, #00bfff 100%);
    color: #0a0e17;
    border-color: #00ffe7;
}

.web-browser-address {
    flex: 1;
    display: flex;
    gap: 8px;
    align-items: center;
}

.web-browser-address input {
    flex: 1;
    background: rgba(26, 31, 46, 0.8);
    border: 1px solid rgba(0, 255, 231, 0.3);
    border-radius: 6px;
    padding: 8px 12px;
    color: #e6e6e6;
    font-family: inherit;
}

.web-browser-address input:focus {
    outline: none;
    border-color: #00ffe7;
    box-shadow: 0 0 0 2px rgba(0, 255, 231, 0.2);
}

.web-browser-actions {
    display: flex;
    gap: 5px;
}

.web-browser-loading {
    background: rgba(26, 31, 46, 0.9);
    padding: 20px;
    text-align: center;
    color: #00ffe7;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
}

.loading-spinner {
    width: 20px;
    height: 20px;
    border: 2px solid rgba(0, 255, 231, 0.3);
    border-top: 2px solid #00ffe7;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

.web-browser-iframe-container {
    flex: 1;
    background: #0a0e17;
    position: relative;
    overflow: hidden;
}

.browser-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #8a9ba8;
    text-align: center;
}

.web-browser-iframe {
    width: 100%;
    height: 100%;
    border: none;
    background: white;
}

/* 画中画模式样式 */
.picture-in-picture {
    position: fixed;
    top: 20px;
    right: 20px;
    width: 400px;
    height: 300px;
    z-index: 3000;
    resize: both;
    overflow: auto;
    min-width: 300px;
    min-height: 200px;
}

.picture-in-picture .web-browser-content {
    width: 100%;
    height: 100%;
}

@media (max-width: 768px) {
    .web-browser-content {
        width: 98%;
        height: 95%;
    }
    
    .web-browser-header {
        flex-wrap: wrap;
        padding: 8px;
    }
    
    .web-browser-controls, .web-browser-actions {
        order: 3;
        margin-top: 8px;
    }
    
    .web-browser-address {
        order: 1;
        width: 100%;
    }
}
</style>

<script>
// 简化的代理系统 - 专注核心功能
let systemReady = false;

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {

    initializeSystem();
    log('系统初始化完成');
});

// 初始化商业化翻墙服务
async function initializeSystem() {
    try {
        log('正在初始化专业翻墙服务...');
        document.getElementById('systemStatus').textContent = '初始化中...';
        
        // 检测代理服务状态
        await checkProxyStatus();
        
        // 自动获取IP对比以显示服务状态
        await getIPComparison();
        
        // 测试YouTube访问（需要翻墙）
        await testYouTubeAccess();
        
        // 初始化Web代理浏览器
        await checkWebProxyStatus();
        
        systemReady = true;
        document.getElementById('systemStatus').textContent = '就绪';
        log('✅ 翻墙服务已就绪');
        log('🌐 可直接访问YouTube、Google等全球网站');
        
    } catch (error) {
        log(`❌ 服务初始化失败: ${error.message}`, 'error');
        document.getElementById('systemStatus').textContent = '错误';
    }
}

// 检测代理服务状态
async function checkProxyStatus() {
    try {
        log('🔍 检测代理服务状态...');
        
        // 检测本地代理服务器
        const localProxyStatus = await testLocalProxy();
        if (localProxyStatus) {
            document.getElementById('proxyStatus').textContent = '本地代理可用';
            document.getElementById('proxyStatus').style.color = '#00ff88';
            log('✅ 本地代理服务器运行正常');
            
            // 显示代理服务详细信息
            log('💡 检测到ClashX Pro正在运行');
            log('🌐 HTTP代理端口: 7890');
            log('🔌 SOCKS5代理端口: 7891');
            log('🎛️  管理面板端口: 9090');
            
        } else {
            document.getElementById('proxyStatus').textContent = '本地代理不可用';
            document.getElementById('proxyStatus').style.color = '#ff6b6b';
            log('⚠️  本地代理服务器未运行，将使用备用方案');
            log('💡 请确保ClashX Pro已启动并配置了代理节点');
            log('🔧 或者使用Web代理浏览器功能直接访问外网');
        }
        
    } catch (error) {
        log(`❌ 代理状态检测失败: ${error.message}`, 'error');
        document.getElementById('proxyStatus').textContent = '检测失败';
        document.getElementById('proxyStatus').style.color = '#ff6b6b';
        log('💡 这可能是网络连接问题，请检查网络设置');
    }
}

// 测试本地代理服务器 - 修复版本 v2.0
async function testLocalProxy() {
    try {
        log('🔧 使用修复后的代理测试方法 v2.0');
        // 测试Clash HTTP代理端口 - 使用正确的代理测试方法
        const proxyPorts = [7890, 7891, 8080, 9090];
        
        for (const port of proxyPorts) {
            try {
                // 方法1: 尝试通过代理访问一个简单的测试URL
                const testUrl = 'http://httpbin.org/ip';
                const proxyUrl = `http://127.0.0.1:${port}`;
                
                // 使用fetch with proxy (如果浏览器支持)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000);
                
                try {
                    // 尝试直接连接测试
                    const response = await fetch(`http://127.0.0.1:${port}`, {
                        method: 'GET',
                        mode: 'no-cors',
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    
                    // 如果返回400 Bad Request，说明代理服务在运行但需要正确的请求格式
                    if (response.status === 400 || response.status === 0) {
                        log(`✅ 检测到代理服务运行在端口 ${port} (状态: ${response.status})`);
                        if (response.status === 400) {
                            log('💡 400状态码表示代理服务正常运行，但需要正确的HTTP代理请求格式');
                        }
                        return true;
                    }
                } catch (fetchError) {
                    clearTimeout(timeoutId);
                    
                    // 如果是因为CORS或网络错误，但端口是开放的，也认为代理可用
                    if (fetchError.name === 'TypeError' && fetchError.message.includes('Failed to fetch')) {
                        // 尝试通过WebSocket或其他方式测试端口连通性
                        try {
                            const ws = new WebSocket(`ws://127.0.0.1:${port}`);
                            await new Promise((resolve, reject) => {
                                const timeout = setTimeout(() => {
                                    ws.close();
                                    reject(new Error('timeout'));
                                }, 1000);
                                
                                ws.onopen = () => {
                                    clearTimeout(timeout);
                                    ws.close();
                                    resolve();
                                };
                                
                                ws.onerror = () => {
                                    clearTimeout(timeout);
                                    reject(new Error('connection failed'));
                                };
                            });
                            log(`✅ 检测到代理服务运行在端口 ${port} (WebSocket测试)`);
                            return true;
                        } catch (wsError) {
                            // WebSocket测试也失败，继续尝试下一个端口
                        }
                    }
                }
                
                // 方法2: 尝试通过后端API测试代理
                try {
                    const response = await fetch('/tools/api/proxy/test-connection/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({ 
                            proxy_host: '127.0.0.1',
                            proxy_port: port,
                            test_url: 'http://httpbin.org/ip'
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            log(`✅ 代理服务测试成功: 127.0.0.1:${port}`);
                            return true;
                        }
                    }
                } catch (apiError) {
                    // API测试失败，继续尝试下一个端口
                }
                
            } catch (e) {
                // 尝试下一个端口
                continue;
            }
        }
        
        log('⚠️  未检测到可用的代理服务');
        return false;
        
    } catch (error) {
        log(`❌ 代理测试失败: ${error.message}`);
        return false;
    }
}

// 测试YouTube访问（需要翻墙）
async function testYouTubeAccess() {
    try {
        log('🔍 测试YouTube访问...');
        
        // 使用本地代理测试YouTube访问
        const response = await fetch('/tools/api/proxy/web-browse/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ url: 'https://www.youtube.com' })
        });
        
        const data = await response.json();
        
        if (data.success) {
            log('✅ YouTube访问正常，代理服务工作良好', 'success');
            document.getElementById('systemStatus').textContent = '代理正常';
            document.getElementById('systemStatus').style.color = '#00ff88';
        } else {
            log(`⚠️  YouTube访问异常: ${data.error}`, 'warning');
            document.getElementById('systemStatus').textContent = '代理异常';
            document.getElementById('systemStatus').style.color = '#ffaa00';
        }
    } catch (error) {
        log(`❌ YouTube访问失败: ${error.message}`, 'error');
        document.getElementById('systemStatus').textContent = '网络错误';
        document.getElementById('systemStatus').style.color = '#ff6b6b';
    }
}

// 日志输出
function log(message, type = 'info') {
    const terminal = document.getElementById('proxyTerminal');
    const timestamp = new Date().toLocaleTimeString();
    const color = type === 'error' ? '#ff4444' : type === 'success' ? '#00ff41' : '#00ffe7';
    
    terminal.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
    terminal.scrollTop = terminal.scrollHeight;

}

// ===== 核心功能1: IP对比功能 =====
async function getIPComparison() {
    try {
        log('正在获取IP对比信息...');
        document.getElementById('localIP').textContent = '检测中...';
        document.getElementById('proxyIP').textContent = '检测中...';
        
        const response = await fetch('/tools/api/proxy/ip-comparison/');
        const data = await response.json();
        
        if (data.success) {
            displayIPComparison(data.data);
            log('✅ IP对比获取完成', 'success');
        } else {
            log(`❌ IP对比获取失败: ${data.error}`, 'error');
            document.getElementById('localIP').textContent = '获取失败';
            document.getElementById('proxyIP').textContent = '获取失败';
        }
    } catch (error) {
        log(`❌ 网络错误: ${error.message}`, 'error');
        document.getElementById('localIP').textContent = '网络错误';
        document.getElementById('proxyIP').textContent = '网络错误';
    }
}



// 显示IP对比结果
function displayIPComparison(data) {
    const resultsDiv = document.getElementById('ipComparisonResults');
    let html = '<div class="proxy-result-item">';
    
    // 更新状态栏
    if (data.direct_ip.success) {
        document.getElementById('localIP').textContent = data.direct_ip.ip;
        html += `
            <div style="margin-bottom: 15px;">
                <strong>🌐 本地IP:</strong> ${data.direct_ip.ip}
                <br><small>位置: ${data.direct_ip.country} ${data.direct_ip.region} ${data.direct_ip.city}</small>
                <br><small>ISP: ${data.direct_ip.isp}</small>
            </div>
        `;
    } else {
        document.getElementById('localIP').textContent = '获取失败';
        html += `
            <div style="margin-bottom: 15px;">
                <strong>🌐 本地IP:</strong> 获取失败
                <br><small>错误: ${data.direct_ip.error}</small>
            </div>
        `;
    }
    
    // 代理IP
    if (data.proxy_ip && data.proxy_ip.success) {
        document.getElementById('proxyIP').textContent = data.proxy_ip.ip;
        html += `
            <div style="margin-bottom: 15px;">
                <strong>🔗 代理IP:</strong> ${data.proxy_ip.ip}
                <br><small>位置: ${data.proxy_ip.country} ${data.proxy_ip.region} ${data.proxy_ip.city}</small>
                <br><small>代理: ${data.proxy_ip.proxy_used}</small>
            </div>
        `;
    } else {
        document.getElementById('proxyIP').textContent = 'N/A';
        html += `
            <div style="margin-bottom: 15px;">
                <strong>🔗 代理IP:</strong> 无法获取
                <br><small>说明: 需要使用Trojan客户端配置</small>
            </div>
        `;
    }
    
    html += '</div>';
    resultsDiv.innerHTML = html;
}

// ===== 核心功能2: 一键代理设置功能 =====
// 注意: 此功能需要相应的HTML元素支持，当前版本已注释
/*
async function setupProxy() {
    const targetUrl = document.getElementById('targetWebsite').value.trim();
    if (!targetUrl) {
        log('❌ 请输入要访问的外网地址', 'error');
        return;
    }
    
    try {
        log(`正在为 ${targetUrl} 设置最佳代理...`);
        document.getElementById('proxySetupResults').innerHTML = '<div class="loading"></div> 正在分析最佳代理...';
        
        const response = await fetch('/tools/api/proxy/setup/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ url: targetUrl })
        });
        
        const data = await response.json();
        
        if (data.success) {
            displayProxySetup(data.data, targetUrl);
            log(`✅ 代理设置完成`, 'success');
        } else {
            log(`❌ 代理设置失败: ${data.error}`, 'error');
            document.getElementById('proxySetupResults').innerHTML = `<div class="proxy-result-item error">设置失败: ${data.error}</div>`;
        }
    } catch (error) {
        log(`❌ 网络错误: ${error.message}`, 'error');
        document.getElementById('proxySetupResults').innerHTML = `<div class="proxy-result-item error">网络错误: ${error.message}</div>`;
    }
}

// 显示代理设置结果
function displayProxySetup(data, targetUrl) {
    const resultsDiv = document.getElementById('proxySetupResults');
    
    if (data.success) {
        const proxy = data.recommended_proxy;
        const item = document.createElement('div');
        item.className = 'proxy-result-item success';
        item.innerHTML = `
            <div style="margin-bottom: 15px;">
                <strong>🎯 推荐代理节点:</strong> ${proxy.name}
                <br><small>服务器: ${proxy.server}:${proxy.port}</small>
                <br><small>位置: ${proxy.country} | 类型: ${proxy.type}</small>
                <br><small>推荐理由: ${data.reason}</small>
            </div>
            
            <div style="margin-bottom: 15px;">
                <strong>🌐 目标网站:</strong> ${targetUrl}
            </div>
            
            <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin: 10px 0;">
                ${proxy.type === 'trojan' ? `
                    <h4 style="color: #00ffe7; margin-bottom: 10px;">🔐 Trojan配置信息</h4>
                    <p><strong>服务器:</strong> ${proxy.server}</p>
                    <p><strong>端口:</strong> ${proxy.port}</p>
                    <p><strong>密码:</strong> ${proxy.password}</p>
                    <p><strong>协议:</strong> Trojan</p>
                    
                    <div style="background: rgba(255,107,157,0.1); padding: 10px; border-radius: 5px; margin: 10px 0; color: #ff6b9d;">
                        💡 <strong>使用方法:</strong><br>
                        1. 下载Clash、V2Ray等客户端<br>
                        2. 将以上配置信息添加到客户端<br>
                        3. 启用代理后即可访问 ${targetUrl}
                    </div>
                    
                    <button class="proxy-btn" onclick="copyTrojanConfig('${proxy.server}', '${proxy.port}', '${proxy.password}')">
                        📋 复制配置信息
                    </button>
                ` : `
                    <h4 style="color: #00ffe7; margin-bottom: 10px;">🔗 HTTP代理设置</h4>
                    <p><strong>代理地址:</strong> ${proxy.server}</p>
                    <p><strong>代理端口:</strong> ${proxy.port}</p>
                    <p><strong>协议:</strong> HTTP</p>
                    
                    <div style="background: rgba(255,107,157,0.1); padding: 10px; border-radius: 5px; margin: 10px 0; color: #ff6b9d;">
                        💡 <strong>使用方法:</strong><br>
                        在浏览器或系统网络设置中配置HTTP代理即可访问外网
                    </div>
                `}
            </div>
            
            <button class="proxy-btn success" onclick="testProxyAccess('${proxy.name}', '${targetUrl}')">
                🚀 测试代理访问
            </button>
        `;
        resultsDiv.innerHTML = '';
        resultsDiv.appendChild(item);
    } else {
        const item = document.createElement('div');
        item.className = 'proxy-result-item error';
        item.innerHTML = `
            <strong>❌ 代理设置失败</strong>
            <br>错误: ${data.error}
            <br>目标网站: ${targetUrl}
        `;
        resultsDiv.innerHTML = '';
        resultsDiv.appendChild(item);
    }
}
*/

// ===== 核心功能: Web翻墙浏览器 =====

let currentBrowserUrl = '';
let browserHistory = [];
let currentHistoryIndex = -1;
let isPictureInPicture = false;

// 打开Web代理浏览器
async function openWebBrowser() {
    const url = document.getElementById('webBrowserUrl').value.trim();
    if (!url) {
        log('❌ 请输入要访问的网址', 'error');
        return;
    }
    
    // 显示浏览器模态框
    document.getElementById('webBrowserModal').style.display = 'flex';
    document.getElementById('browserAddressBar').value = url;
    
    // 加载网页
    await loadWebPage(url);
}

// 快速访问预设网站
async function quickAccess(url) {
    document.getElementById('webBrowserUrl').value = url;
    await openWebBrowser();
}

// 加载网页内容
async function loadWebPage(url) {
    try {
        // 确保URL格式正确
        if (!url.startsWith('http://') && !url.startsWith('https://')) {
            url = 'https://' + url;
        }
        
        log(`正在加载: ${url}`);
        
        // 显示加载状态
        document.getElementById('browserLoading').style.display = 'flex';
        document.getElementById('browserContainer').innerHTML = '';
        
        const response = await fetch('/tools/api/proxy/web-browse/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ url: url })
        });
        
        const data = await response.json();
        
        // 隐藏加载状态
        document.getElementById('browserLoading').style.display = 'none';
        
        if (data.success) {
            // 处理内容编码和显示
            let content = data.data.content;
            
            // 确保内容包含正确的编码声明
            if (!content.includes('charset') && !content.includes('encoding')) {
                if (content.includes('<head>')) {
                    content = content.replace('<head>', '<head><meta charset="UTF-8">');
                } else if (content.includes('<html>')) {
                    content = content.replace('<html>', '<html><head><meta charset="UTF-8"></head>');
                } else {
                    content = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>代理浏览器</title></head><body>${content}</body></html>`;
                }
            }
            
            // 添加基础样式来改善显示效果
            const baseStyles = `
                <style>
                    body { 
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
                        line-height: 1.6;
                        color: #333;
                        margin: 20px;
                        background-color: #fff;
                    }
                    img { max-width: 100%; height: auto; }
                    a { color: #1976d2; text-decoration: none; }
                    a:hover { text-decoration: underline; }
                </style>
            `;
            
            if (content.includes('</head>')) {
                content = content.replace('</head>', baseStyles + '</head>');
            } else {
                content = baseStyles + content;
            }
            
            // 对于所有网站，直接显示内容而不是使用iframe
            // 这样可以避免X-Frame-Options限制
            
            // 直接显示内容，不使用iframe避免X-Frame-Options问题
            const contentDiv = document.createElement('div');
            contentDiv.className = 'web-browser-content';
            contentDiv.innerHTML = content;
            
            // 添加样式改进
            const style = document.createElement('style');
            style.textContent = `
                .web-browser-content {
                    width: 100%;
                    height: 80vh;
                    overflow: auto;
                    border: 1px solid #ddd;
                    border-radius: 8px;
                    background: white;
                }
                .web-browser-content a[href^="http"] {
                    color: #0066cc;
                    text-decoration: underline;
                }
                .web-browser-content a[href^="http"]:hover {
                    color: #004499;
                }
                .web-browser-content img {
                    max-width: 100%;
                    height: auto;
                }
                .web-browser-content video {
                    max-width: 100%;
                    height: auto;
                }
            `;
            document.head.appendChild(style);
            
            // 处理所有外部链接，使其在新窗口打开
            const links = contentDiv.querySelectorAll('a[href^="http"]');
            links.forEach(link => {
                link.target = '_blank';
                link.rel = 'noopener noreferrer';
            });
            
            // 处理所有相对链接，使其通过代理访问
            const relativeLinks = contentDiv.querySelectorAll('a[href^="/"], a[href^="./"], a[href^="../"]');
            relativeLinks.forEach(link => {
                const originalHref = link.href;
                link.href = `/tools/api/proxy/web-browse/?url=${encodeURIComponent(originalHref)}`;
                link.target = '_blank';
            });
            
            log(`✅ 网页内容加载完成: ${data.data.final_url}`, 'success');
            log(`📊 内容长度: ${data.data.content_length} 字符`, 'info');
            log(`🔤 使用编码: ${data.data.charset_used || 'unknown'}`, 'info');
                
                // 改进iframe交互处理
                setTimeout(() => {
                    try {
                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                        if (iframeDoc && iframeDoc.body) {
                            const bodyText = iframeDoc.body.innerText || iframeDoc.body.textContent;
                            if (!bodyText || bodyText.trim().length < 10) {
                                log(`⚠️  iframe内容可能为空，建议在新窗口打开`, 'warning');
                                // 尝试使用srcdoc方式
                                iframe.srcdoc = content;
                            } else if (bodyText.includes('�') || bodyText.match(/[^\x00-\x7F\u4e00-\u9fff\u3400-\u4dbf]/g)) {
                                log(`⚠️  检测到可能的乱码字符，建议在新窗口打开获得更好体验`, 'warning');
                            } else {
                                log(`✅ iframe内容验证通过`, 'success');
                            }
                            
                            // 添加点击提示
                            const interactionHint = document.createElement('div');
                            interactionHint.style.cssText = `
                                position: absolute;
                                top: 10px;
                                right: 10px;
                                background: rgba(0, 0, 0, 0.8);
                                color: white;
                                padding: 8px 12px;
                                border-radius: 5px;
                                font-size: 12px;
                                z-index: 1000;
                                cursor: pointer;
                                transition: opacity 0.3s;
                            `;
                            interactionHint.innerHTML = '💡 交互受限？点击"新窗口打开"获得完整体验';
                            interactionHint.onclick = () => openInNewWindow();
                            
                            const browserContainer = document.getElementById('browserContainer');
                            browserContainer.style.position = 'relative';
                            browserContainer.appendChild(interactionHint);
                            
                            // 5秒后自动隐藏提示
                            setTimeout(() => {
                                if (interactionHint && interactionHint.parentNode) {
                                    interactionHint.style.opacity = '0';
                                    setTimeout(() => {
                                        if (interactionHint.parentNode) {
                                            interactionHint.parentNode.removeChild(interactionHint);
                                        }
                                    }, 300);
                                }
                            }, 5000);
                        }
                    } catch (e) {
                        log(`ℹ️  iframe交互受限（跨域保护），建议使用"新窗口打开"功能`, 'info');
                    }
                }, 1000);
            };
            
            iframe.onerror = function() {
                URL.revokeObjectURL(blobUrl);
                log(`❌ iframe加载失败，尝试使用srcdoc方式`, 'error');
                
                // 尝试使用srcdoc作为备选方案
                iframe.src = '';
                iframe.srcdoc = content;
            };
            
            iframe.src = blobUrl;
            
            document.getElementById('browserContainer').innerHTML = '';
            document.getElementById('browserContainer').appendChild(contentDiv);
            
            // 更新浏览历史
            currentBrowserUrl = url;
            if (currentHistoryIndex === -1 || browserHistory[currentHistoryIndex] !== url) {
                browserHistory = browserHistory.slice(0, currentHistoryIndex + 1);
                browserHistory.push(url);
                currentHistoryIndex = browserHistory.length - 1;
            }
            
            log(`✅ 网页加载成功: ${url}`, 'success');
            
        } else {
            document.getElementById('browserContainer').innerHTML = 
                `<div class="browser-placeholder">
                    <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #ff4444; margin-bottom: 1rem;"></i>
                    <p>网页加载失败</p>
                    <p>${data.error}</p>
                </div>`;
            log(`❌ 网页加载失败: ${data.error}`, 'error');
        }
        
    } catch (error) {
        document.getElementById('browserLoading').style.display = 'none';
        document.getElementById('browserContainer').innerHTML = 
            `<div class="browser-placeholder">
                <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #ff4444; margin-bottom: 1rem;"></i>
                <p>网络错误</p>
                <p>${error.message}</p>
            </div>`;
        log(`❌ 网络错误: ${error.message}`, 'error');
    }
}

// 浏览器导航
async function browserNavigate() {
    const url = document.getElementById('browserAddressBar').value.trim();
    if (url) {
        await loadWebPage(url);
    }
}

// 浏览器后退
function browserBack() {
    if (currentHistoryIndex > 0) {
        currentHistoryIndex--;
        const url = browserHistory[currentHistoryIndex];
        document.getElementById('browserAddressBar').value = url;
        loadWebPage(url);
    }
}

// 浏览器前进
function browserForward() {
    if (currentHistoryIndex < browserHistory.length - 1) {
        currentHistoryIndex++;
        const url = browserHistory[currentHistoryIndex];
        document.getElementById('browserAddressBar').value = url;
        loadWebPage(url);
    }
}

// 浏览器刷新
function browserRefresh() {
    if (currentBrowserUrl) {
        loadWebPage(currentBrowserUrl);
    }
}

// 切换画中画模式
function togglePictureInPicture() {
    const modal = document.getElementById('webBrowserModal');
    
    if (!isPictureInPicture) {
        // 切换到画中画模式
        modal.classList.add('picture-in-picture');
        document.querySelector('.web-browser-modal .fas.fa-compress').className = 'fas fa-expand';
        isPictureInPicture = true;
        log('✅ 已切换到画中画模式', 'success');
    } else {
        // 切换到全屏模式
        modal.classList.remove('picture-in-picture');
        document.querySelector('.web-browser-modal .fas.fa-expand').className = 'fas fa-compress';
        isPictureInPicture = false;
        log('✅ 已切换到全屏模式', 'success');
    }
}

// 关闭浏览器
function closeBrowser() {
    document.getElementById('webBrowserModal').style.display = 'none';
    isPictureInPicture = false;
    currentBrowserUrl = '';
    log('🔧 Web代理浏览器已关闭');
}

// 在新窗口打开当前页面
function openInNewWindow() {
    if (!currentBrowserUrl) {
        log('❌ 没有可打开的页面', 'error');
        return;
    }
    
    // 创建一个代理访问链接
    const proxyUrl = `/tools/api/proxy/web-browse/?url=${encodeURIComponent(currentBrowserUrl)}`;
    
    // 打开新窗口并显示代理内容
    const newWindow = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
    if (newWindow) {
        newWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>代理浏览器 - ${currentBrowserUrl}</title>
                <meta charset="UTF-8">
                <style>
                    body { margin: 0; padding: 20px; font-family: Arial, sans-serif; }
                    .header { background: #f5f5f5; padding: 10px; margin-bottom: 20px; border-radius: 5px; }
                    .url { color: #666; font-size: 14px; }
                    iframe { width: 100%; height: 80vh; border: 1px solid #ddd; border-radius: 5px; }
                    .loading { text-align: center; padding: 50px; color: #666; }
                </style>
            </head>
            <body>
                <div class="header">
                    <strong>代理浏览器</strong>
                    <div class="url">访问: ${currentBrowserUrl}</div>
                </div>
                <div id="content" class="loading">正在加载页面内容...</div>
                <script>
                    // 获取页面内容并显示
                    const csrfToken = document.cookie.split(';').find(row => row.startsWith('csrftoken='))?.split('=')[1] || '';
                    fetch('${proxyUrl}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({ url: '${currentBrowserUrl}' })
                    })
                    .then(response => response.json())
                    .then(data => {
                        const contentDiv = document.getElementById('content');
                        if (data.success) {
                            // 直接显示内容，不使用iframe避免X-Frame-Options问题
                            contentDiv.innerHTML = data.data.content;
                            
                            // 添加一些样式改进
                            const style = document.createElement('style');
                            style.textContent = `
                                body { 
                                    margin: 0; 
                                    padding: 0; 
                                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                                }
                                /* 确保链接在新窗口打开 */
                                a[href^="http"] {
                                    color: #0066cc;
                                    text-decoration: underline;
                                }
                                a[href^="http"]:hover {
                                    color: #004499;
                                }
                                /* 改进图片显示 */
                                img {
                                    max-width: 100%;
                                    height: auto;
                                }
                                /* 改进视频显示 */
                                video {
                                    max-width: 100%;
                                    height: auto;
                                }
                            `;
                            document.head.appendChild(style);
                            
                            // 处理所有外部链接，使其在新窗口打开
                            const links = contentDiv.querySelectorAll('a[href^="http"]');
                            links.forEach(link => {
                                link.target = '_blank';
                                link.rel = 'noopener noreferrer';
                            });
                            
                            // 处理所有相对链接，使其通过代理访问
                            const relativeLinks = contentDiv.querySelectorAll('a[href^="/"], a[href^="./"], a[href^="../"]');
                            relativeLinks.forEach(link => {
                                const originalHref = link.href;
                                link.href = `/tools/api/proxy/web-browse/?url=${encodeURIComponent(originalHref)}`;
                                link.target = '_blank';
                            });
                            
                        } else {
                            contentDiv.innerHTML = '<div style="color: red; padding: 20px; text-align: center;"><h3>加载失败</h3><p>' + data.error + '</p><button onclick="location.reload()">重新加载</button></div>';
                        }
                    })
                    .catch(error => {
                        document.getElementById('content').innerHTML = '<div style="color: red;">网络错误: ' + error.message + '</div>';
                    });
                <\/script>
            </body>
            </html>
        `);
        log('🔗 页面已在新窗口打开，可以正常交互', 'success');
    } else {
        log('❌ 无法打开新窗口，请检查浏览器设置', 'error');
    }
}

// 刷新当前页面
function refreshCurrentPage() {
    if (!currentBrowserUrl) {
        log('❌ 没有可刷新的页面', 'error');
        return;
    }
    
    log('🔄 刷新页面: ' + currentBrowserUrl);
    loadWebPage(currentBrowserUrl);
}

// 全屏模式切换
function toggleFullscreen() {
    const modal = document.getElementById('webBrowserModal');
    
    if (!document.fullscreenElement) {
        // 进入全屏
        if (modal.requestFullscreen) {
            modal.requestFullscreen();
        } else if (modal.webkitRequestFullscreen) {
            modal.webkitRequestFullscreen();
        } else if (modal.mozRequestFullScreen) {
            modal.mozRequestFullScreen();
        }
        log('📺 进入全屏模式', 'success');
    } else {
        // 退出全屏
        if (document.exitFullscreen) {
            document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
        } else if (document.mozCancelFullScreen) {
            document.mozCancelFullScreen();
        }
        log('🪟 退出全屏模式', 'success');
    }
}

// ===== 辅助函数 =====

// 打开Clash控制台
function openClashDashboard() {
    window.open('/tools/clash-dashboard/', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
    log('🚀 已打开Clash内嵌代理控制台', 'success');
}

// 打开Web代理浏览器




// 复制Trojan配置信息到剪贴板
async function copyTrojanConfig(server, port, password) {
    const configText = `
服务器: ${server}
端口: ${port}
密码: ${password}
协议: Trojan
    `.trim();
    
    try {
        await navigator.clipboard.writeText(configText);
        log('✅ 配置信息已复制到剪贴板', 'success');
    } catch (error) {
        log('❌ 复制失败，请手动复制配置信息', 'error');
        // 创建临时文本区域进行复制（兼容性方案）
        const textArea = document.createElement('textarea');
        textArea.value = configText;
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            log('✅ 配置信息已复制到剪贴板', 'success');
        } catch (e) {
            log('❌ 复制失败', 'error');
        }
        document.body.removeChild(textArea);
    }
}

// 测试代理访问
async function testProxyAccess(proxyName, targetUrl) {
    try {
        log(`正在测试代理访问: ${proxyName} -> ${targetUrl}`);
        
        const response = await fetch('/tools/api/proxy/create-url/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ 
                proxy: proxyName, 
                url: targetUrl 
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            if (data.data.proxy_config.type === 'trojan') {
                log('✅ Trojan代理配置已生成，请使用客户端连接', 'success');
            } else {
                log('✅ HTTP代理访问链接已创建', 'success');
                // 对于HTTP代理，可以尝试在新窗口打开
                window.open(data.data.proxy_url, '_blank');
            }
        } else {
            log(`❌ 创建代理访问链接失败: ${data.error}`, 'error');
        }
    } catch (error) {
        log(`❌ 网络错误: ${error.message}`, 'error');
    }
}

// 获取CSRF Token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// 键盘快捷键
document.addEventListener('keydown', function(e) {
    // 全局快捷键
    if (e.ctrlKey && e.key === 'r') {
        e.preventDefault();
        getIPComparison();
        log('🔄 刷新网络状态');
    }
    if (e.ctrlKey && e.key === 'w') {
        e.preventDefault();
        const url = document.getElementById('webBrowserUrl').value.trim();
        if (url) {
            openWebBrowser();
        } else {
            log('❌ 请先输入网址，然后按Ctrl+W打开翻墙浏览器');
        }
    }
    
    // 浏览器内快捷键
    if (document.getElementById('webBrowserModal').style.display === 'flex') {
        if (e.key === 'Escape') {
            closeBrowser();
        }
        if (e.ctrlKey && e.key === 'p') {
            e.preventDefault();
            togglePictureInPicture();
        }
    }
});

// 浏览器地址栏回车事件
document.addEventListener('DOMContentLoaded', function() {
    const browserAddressBar = document.getElementById('browserAddressBar');
    if (browserAddressBar) {
        browserAddressBar.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                browserNavigate();
            }
        });
    }
    
    // Web代理浏览器输入框回车事件

});

log('🚀 专业翻墙服务已启动 - 修复版本 v2.0');
log('💡 快捷键: Ctrl+R 检测网络状态, Ctrl+W 打开翻墙浏览器');
log('🌐 浏览器快捷键: Esc 关闭浏览器, Ctrl+P 切换画中画模式');
log('🔧 代理测试已修复，400错误现在被正确识别为代理服务正常');
</script>
{% endblock %}
