{% extends 'base.html' %}
{% load static %}

{% block tool_title_inner %}æ¬²æœ›ä»£åŠç³»ç»Ÿ{% endblock %}
{% block tool_title_display %}æ¬²æœ›ä»£åŠç³»ç»Ÿ{% endblock %}

{% block extra_css %}
<style>
.desire-todo-container {
  min-height: 100vh;
  background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
  color: #ffffff;
  font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
  padding: 2rem;
  position: relative;
  overflow-x: hidden;
}

.desire-todo-container::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: 
    radial-gradient(circle at 20% 80%, rgba(255, 68, 68, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 80% 20%, rgba(255, 107, 53, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 40% 40%, rgba(255, 215, 0, 0.05) 0%, transparent 50%);
  z-index: -1;
  animation: desirePulse 8s ease-in-out infinite;
}

@keyframes desirePulse {
  0%, 100% { opacity: 0.5; }
  50% { opacity: 1; }
}

.desire-header {
  text-align: center;
  margin-bottom: 3rem;
  padding: 2rem 0;
}

.desire-title {
  font-size: 3.5rem;
  font-weight: 900;
  background: linear-gradient(135deg, #ff4444, #ff6b35, #ffd700, #ff4444);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: 1rem;
  text-shadow: 0 0 40px rgba(255, 68, 68, 0.5);
  animation: desireGlow 3s ease-in-out infinite alternate;
}

@keyframes desireGlow {
  from { filter: brightness(1) hue-rotate(0deg); }
  to { filter: brightness(1.2) hue-rotate(10deg); }
}

.desire-subtitle {
  font-size: 1.3rem;
  color: rgba(255, 255, 255, 0.9);
  margin-bottom: 1rem;
  font-weight: 600;
}

.desire-motto {
  font-size: 1rem;
  color: rgba(255, 215, 0, 0.8);
  font-style: italic;
  margin-bottom: 2rem;
}

.desire-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 2rem;
  max-width: 1600px;
  margin: 0 auto;
}

.desire-card {
  background: rgba(26, 26, 26, 0.9);
  border: 3px solid rgba(255, 68, 68, 0.4);
  border-radius: 15px;
  padding: 2rem;
  backdrop-filter: blur(15px);
  transition: all 0.4s ease;
  position: relative;
  overflow: hidden;
}

.desire-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(135deg, #ff4444, #ff6b35, #ffd700);
  transform: scaleX(0);
  transition: transform 0.4s ease;
}

.desire-card:hover::before {
  transform: scaleX(1);
}

.desire-card:hover {
  transform: translateY(-8px) scale(1.02);
  box-shadow: 0 20px 50px rgba(255, 68, 68, 0.3);
  border-color: #ff4444;
}

.card-title {
  font-size: 1.8rem;
  font-weight: 700;
  color: #ff4444;
  margin-bottom: 1.5rem;
  text-align: center;
  text-transform: uppercase;
  letter-spacing: 2px;
}

/* æ¬²æœ›ä»£åŠåˆ†ç±» */
.desire-categories {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  margin-bottom: 2rem;
}

.category-btn {
  background: rgba(255, 68, 68, 0.1);
  border: 2px solid rgba(255, 68, 68, 0.3);
  border-radius: 10px;
  padding: 1rem;
  text-align: center;
  transition: all 0.3s ease;
  cursor: pointer;
  color: #ffffff;
  font-weight: 600;
}

.category-btn:hover {
  background: rgba(255, 68, 68, 0.2);
  border-color: #ff4444;
  transform: translateY(-3px);
}

.category-btn.active {
  background: rgba(255, 68, 68, 0.3);
  border-color: #ff4444;
  box-shadow: 0 0 20px rgba(255, 68, 68, 0.3);
}

.category-icon {
  font-size: 2rem;
  margin-bottom: 0.5rem;
  display: block;
}

/* æ¬²æœ›ä»£åŠåˆ—è¡¨ */
.desire-todo-list {
  max-height: 400px;
  overflow-y: auto;
}

.todo-item {
  background: rgba(255, 68, 68, 0.1);
  border: 2px solid rgba(255, 68, 68, 0.3);
  border-radius: 10px;
  padding: 1.5rem;
  margin-bottom: 1rem;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.todo-item:hover {
  background: rgba(255, 68, 68, 0.15);
  border-color: #ff4444;
  transform: translateX(5px);
}

.todo-item.completed {
  background: rgba(40, 167, 69, 0.1);
  border-color: #28a745;
  opacity: 0.7;
}

.todo-item.completed .todo-title {
  text-decoration: line-through;
  color: #28a745;
}

.todo-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.todo-title {
  font-size: 1.1rem;
  font-weight: 600;
  color: #ff6b35;
  flex: 1;
}

.todo-priority {
  padding: 0.3rem 0.8rem;
  border-radius: 15px;
  font-size: 0.8rem;
  font-weight: 600;
  margin-left: 1rem;
}

.priority-high {
  background: rgba(255, 68, 68, 0.3);
  color: #ff4444;
}

.priority-medium {
  background: rgba(255, 193, 7, 0.3);
  color: #ffc107;
}

.priority-low {
  background: rgba(40, 167, 69, 0.3);
  color: #28a745;
}

.todo-description {
  font-size: 0.9rem;
  color: rgba(255, 255, 255, 0.8);
  margin-bottom: 1rem;
  line-height: 1.5;
}

.todo-meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 0.8rem;
  color: rgba(255, 255, 255, 0.6);
}

.todo-reward {
  color: #ffd700;
  font-weight: 600;
}

.todo-actions {
  display: flex;
  gap: 0.5rem;
  margin-top: 1rem;
}

.todo-btn {
  padding: 0.5rem 1rem;
  border: none;
  border-radius: 5px;
  font-size: 0.8rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-complete {
  background: #28a745;
  color: white;
}

.btn-complete:hover {
  background: #218838;
  transform: scale(1.05);
}

.btn-edit {
  background: #ffc107;
  color: #000;
}

.btn-edit:hover {
  background: #e0a800;
  transform: scale(1.05);
}

.btn-delete {
  background: #dc3545;
  color: white;
}

.btn-delete:hover {
  background: #c82333;
  transform: scale(1.05);
}

/* æ·»åŠ æ–°ä»£åŠ */
.add-todo-form {
  background: rgba(26, 26, 26, 0.8);
  border: 2px solid rgba(255, 68, 68, 0.3);
  border-radius: 10px;
  padding: 2rem;
  margin-bottom: 2rem;
}

.form-group {
  margin-bottom: 1.5rem;
}

.form-label {
  display: block;
  font-size: 0.9rem;
  font-weight: 600;
  color: #ff6b35;
  margin-bottom: 0.5rem;
}

.form-input {
  width: 100%;
  padding: 0.8rem;
  background: rgba(255, 255, 255, 0.1);
  border: 2px solid rgba(255, 68, 68, 0.3);
  border-radius: 5px;
  color: #ffffff;
  font-family: inherit;
  transition: all 0.3s ease;
}

.form-input:focus {
  outline: none;
  border-color: #ff4444;
  box-shadow: 0 0 10px rgba(255, 68, 68, 0.3);
}

.form-select {
  width: 100%;
  padding: 0.8rem;
  background: rgba(255, 255, 255, 0.1);
  border: 2px solid rgba(255, 68, 68, 0.3);
  border-radius: 5px;
  color: #ffffff;
  font-family: inherit;
}

.form-textarea {
  width: 100%;
  padding: 0.8rem;
  background: rgba(255, 255, 255, 0.1);
  border: 2px solid rgba(255, 68, 68, 0.3);
  border-radius: 5px;
  color: #ffffff;
  font-family: inherit;
  min-height: 100px;
  resize: vertical;
}

.submit-btn {
  background: linear-gradient(135deg, #ff4444, #ff6b35);
  color: white;
  border: none;
  padding: 1rem 2rem;
  border-radius: 10px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.submit-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 25px rgba(255, 68, 68, 0.4);
}

/* æ¬²æœ›ç»Ÿè®¡ */
.desire-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 1rem;
  margin-bottom: 2rem;
}

.stat-item {
  background: rgba(255, 68, 68, 0.1);
  border: 2px solid rgba(255, 68, 68, 0.3);
  border-radius: 10px;
  padding: 1.5rem;
  text-align: center;
  transition: all 0.3s ease;
}

.stat-item:hover {
  background: rgba(255, 68, 68, 0.2);
  border-color: #ff4444;
  transform: translateY(-3px);
}

.stat-value {
  font-size: 2rem;
  font-weight: 900;
  color: #ffd700;
  margin-bottom: 0.5rem;
}

.stat-label {
  font-size: 0.9rem;
  color: #ff6b35;
  font-weight: 600;
}

/* æ¬²æœ›å¥–åŠ±ç³»ç»Ÿ */
.desire-rewards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  margin-top: 1.5rem;
}

.reward-item {
  background: rgba(255, 215, 0, 0.1);
  border: 2px solid rgba(255, 215, 0, 0.3);
  border-radius: 10px;
  padding: 1.5rem;
  text-align: center;
  transition: all 0.3s ease;
  cursor: pointer;
}

.reward-item:hover {
  background: rgba(255, 215, 0, 0.2);
  border-color: #ffd700;
  transform: translateY(-3px);
}

.reward-item.unlocked {
  background: rgba(255, 215, 0, 0.3);
  border-color: #ffd700;
  animation: rewardGlow 2s ease-in-out infinite;
}

@keyframes rewardGlow {
  0%, 100% { box-shadow: 0 0 10px rgba(255, 215, 0, 0.3); }
  50% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.6); }
}

.reward-icon {
  font-size: 2.5rem;
  margin-bottom: 0.5rem;
}

.reward-name {
  font-size: 1rem;
  font-weight: 600;
  color: #ffd700;
  margin-bottom: 0.5rem;
}

.reward-desc {
  font-size: 0.8rem;
  color: rgba(255, 255, 255, 0.7);
}

.reward-cost {
  font-size: 0.9rem;
  color: #ff6b35;
  font-weight: 600;
  margin-top: 0.5rem;
}

/* é€šçŸ¥åŠ¨ç”» */
@keyframes slideIn {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .desire-title {
    font-size: 2.5rem;
  }
  
  .desire-grid {
    grid-template-columns: 1fr;
    gap: 1.5rem;
  }
  
  .desire-card {
    padding: 1.5rem;
  }
  
  .todo-actions {
    flex-direction: column;
  }
  
  .todo-btn {
    width: 100%;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="desire-todo-container">
  <div class="desire-header">
    <h1 class="desire-title">ğŸ”¥ æ¬²æœ›ä»£åŠç³»ç»Ÿ</h1>
    <p class="desire-subtitle">å°†æ¬²æœ›è½¬åŒ–ä¸ºåŠ¨åŠ›ï¼Œè®©æ¯ä¸ªä»»åŠ¡éƒ½æœ‰æ„ä¹‰</p>
    <p class="desire-motto">"å®Œæˆä¸€ä¸ªä»»åŠ¡ï¼Œå®ç°ä¸€ä¸ªæ¬²æœ›"</p>
  </div>

  <!-- æ¬²æœ›ç»Ÿè®¡ -->
  <div class="desire-stats">
    <div class="stat-item">
      <div class="stat-value" id="totalTodos">12</div>
      <div class="stat-label">æ€»ä»£åŠæ•°</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="completedTodos">8</div>
      <div class="stat-label">å·²å®Œæˆ</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="pendingTodos">4</div>
      <div class="stat-label">å¾…å®Œæˆ</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="totalRewards">Â¥2,450</div>
      <div class="stat-label">æ€»å¥–åŠ±</div>
    </div>
  </div>

  <div class="desire-grid">
    <!-- æ·»åŠ æ–°ä»£åŠ -->
    <div class="desire-card">
      <h2 class="card-title">æ·»åŠ æ–°æ¬²æœ›ä»£åŠ</h2>
      <form class="add-todo-form" id="addTodoForm">
        <div class="form-group">
          <label class="form-label">ä»£åŠæ ‡é¢˜</label>
          <input type="text" class="form-input" id="todoTitle" placeholder="è¾“å…¥ä½ çš„æ¬²æœ›ä»£åŠ..." required>
        </div>
        <div class="form-group">
          <label class="form-label">æè¿°</label>
          <textarea class="form-textarea" id="todoDescription" placeholder="è¯¦ç»†æè¿°è¿™ä¸ªæ¬²æœ›ä»£åŠ..."></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">åˆ†ç±»</label>
          <select class="form-select" id="todoCategory" required>
            <option value="">é€‰æ‹©åˆ†ç±»</option>
            <option value="work">å·¥ä½œç›¸å…³</option>
            <option value="personal">ä¸ªäººæˆé•¿</option>
            <option value="health">å¥åº·ç”Ÿæ´»</option>
            <option value="social">ç¤¾äº¤å…³ç³»</option>
            <option value="entertainment">å¨±ä¹æ”¾æ¾</option>
            <option value="finance">è´¢åŠ¡ç›®æ ‡</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">ä¼˜å…ˆçº§</label>
          <select class="form-select" id="todoPriority" required>
            <option value="">é€‰æ‹©ä¼˜å…ˆçº§</option>
            <option value="high">é«˜ä¼˜å…ˆçº§</option>
            <option value="medium">ä¸­ä¼˜å…ˆçº§</option>
            <option value="low">ä½ä¼˜å…ˆçº§</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">æ¬²æœ›å¥–åŠ±</label>
          <input type="text" class="form-input" id="todoReward" placeholder="å®Œæˆåçš„å¥–åŠ±ï¼Œå¦‚ï¼šä¹°ä¸€åŒæ–°é‹ Â¥500">
        </div>
        <button type="submit" class="submit-btn">æ·»åŠ æ¬²æœ›ä»£åŠ</button>
      </form>
    </div>

    <!-- ä»£åŠåˆ†ç±» -->
    <div class="desire-card">
      <h2 class="card-title">æ¬²æœ›ä»£åŠåˆ†ç±»</h2>
      <div class="desire-categories">
        <button class="category-btn active" data-category="all">
          <span class="category-icon">ğŸ“‹</span>
          å…¨éƒ¨ä»£åŠ
        </button>
        <button class="category-btn" data-category="work">
          <span class="category-icon">ğŸ’¼</span>
          å·¥ä½œç›¸å…³
        </button>
        <button class="category-btn" data-category="personal">
          <span class="category-icon">ğŸ¯</span>
          ä¸ªäººæˆé•¿
        </button>
        <button class="category-btn" data-category="health">
          <span class="category-icon">ğŸ’ª</span>
          å¥åº·ç”Ÿæ´»
        </button>
        <button class="category-btn" data-category="social">
          <span class="category-icon">ğŸ‘¥</span>
          ç¤¾äº¤å…³ç³»
        </button>
        <button class="category-btn" data-category="entertainment">
          <span class="category-icon">ğŸ®</span>
          å¨±ä¹æ”¾æ¾
        </button>
        <button class="category-btn" data-category="finance">
          <span class="category-icon">ğŸ’°</span>
          è´¢åŠ¡ç›®æ ‡
        </button>
      </div>
    </div>

    <!-- ä»£åŠåˆ—è¡¨ -->
    <div class="desire-card">
      <h2 class="card-title">æ¬²æœ›ä»£åŠåˆ—è¡¨</h2>
      <div class="desire-todo-list" id="todoList">
        <div class="todo-item" data-category="work">
          <div class="todo-header">
            <div class="todo-title">å®Œæˆé¡¹ç›®é‡æ„</div>
            <div class="todo-priority priority-high">é«˜ä¼˜å…ˆçº§</div>
          </div>
          <div class="todo-description">é‡æ„ç°æœ‰ä»£ç æ¶æ„ï¼Œæé«˜ç³»ç»Ÿæ€§èƒ½å’Œå¯ç»´æŠ¤æ€§</div>
          <div class="todo-meta">
            <span>åˆ†ç±»: å·¥ä½œç›¸å…³</span>
            <span class="todo-reward">å¥–åŠ±: Â¥1,000</span>
          </div>
          <div class="todo-actions">
            <button class="todo-btn btn-complete" onclick="completeTodo(this)">å®Œæˆ</button>
            <button class="todo-btn btn-edit" onclick="editTodo(this)">ç¼–è¾‘</button>
            <button class="todo-btn btn-delete" onclick="deleteTodo(this)">åˆ é™¤</button>
          </div>
        </div>

        <div class="todo-item completed" data-category="personal">
          <div class="todo-header">
            <div class="todo-title">å­¦ä¹ æ–°ç¼–ç¨‹è¯­è¨€</div>
            <div class="todo-priority priority-medium">ä¸­ä¼˜å…ˆçº§</div>
          </div>
          <div class="todo-description">å­¦ä¹ Rustç¼–ç¨‹è¯­è¨€ï¼ŒæŒæ¡ç³»ç»Ÿçº§ç¼–ç¨‹æŠ€èƒ½</div>
          <div class="todo-meta">
            <span>åˆ†ç±»: ä¸ªäººæˆé•¿</span>
            <span class="todo-reward">å¥–åŠ±: Â¥500</span>
          </div>
          <div class="todo-actions">
            <button class="todo-btn btn-complete" disabled>å·²å®Œæˆ</button>
            <button class="todo-btn btn-edit" onclick="editTodo(this)">ç¼–è¾‘</button>
            <button class="todo-btn btn-delete" onclick="deleteTodo(this)">åˆ é™¤</button>
          </div>
        </div>

        <div class="todo-item" data-category="health">
          <div class="todo-header">
            <div class="todo-title">å¥èº«30å¤©</div>
            <div class="todo-priority priority-medium">ä¸­ä¼˜å…ˆçº§</div>
          </div>
          <div class="todo-description">è¿ç»­30å¤©è¿›è¡Œå¥èº«é”»ç‚¼ï¼Œæ”¹å–„èº«ä½“çŠ¶å†µ</div>
          <div class="todo-meta">
            <span>åˆ†ç±»: å¥åº·ç”Ÿæ´»</span>
            <span class="todo-reward">å¥–åŠ±: ä¹°ä¸€åŒæ–°è·‘é‹</span>
          </div>
          <div class="todo-actions">
            <button class="todo-btn btn-complete" onclick="completeTodo(this)">å®Œæˆ</button>
            <button class="todo-btn btn-edit" onclick="editTodo(this)">ç¼–è¾‘</button>
            <button class="todo-btn btn-delete" onclick="deleteTodo(this)">åˆ é™¤</button>
          </div>
        </div>

        <div class="todo-item" data-category="entertainment">
          <div class="todo-header">
            <div class="todo-title">çœ‹ä¸€éƒ¨ç»å…¸ç”µå½±</div>
            <div class="todo-priority priority-low">ä½ä¼˜å…ˆçº§</div>
          </div>
          <div class="todo-description">è§‚çœ‹ã€Šè‚–ç”³å…‹çš„æ•‘èµã€‹ï¼Œæ„Ÿå—ç»å…¸ç”µå½±çš„é­…åŠ›</div>
          <div class="todo-meta">
            <span>åˆ†ç±»: å¨±ä¹æ”¾æ¾</span>
            <span class="todo-reward">å¥–åŠ±: ä¹°ä¸€åŒ…é›¶é£Ÿ</span>
          </div>
          <div class="todo-actions">
            <button class="todo-btn btn-complete" onclick="completeTodo(this)">å®Œæˆ</button>
            <button class="todo-btn btn-edit" onclick="editTodo(this)">ç¼–è¾‘</button>
            <button class="todo-btn btn-delete" onclick="deleteTodo(this)">åˆ é™¤</button>
          </div>
        </div>
      </div>
    </div>

    <!-- æ¬²æœ›å¥–åŠ±ç³»ç»Ÿ -->
    <div class="desire-card">
      <h2 class="card-title">æ¬²æœ›å¥–åŠ±ç³»ç»Ÿ</h2>
      <div class="desire-rewards">
        <div class="reward-item unlocked">
          <div class="reward-icon">ğŸ®</div>
          <div class="reward-name">æ¸¸æˆæ—¶é—´</div>
          <div class="reward-desc">å®Œæˆ3ä¸ªä»£åŠåè·å¾—1å°æ—¶æ¸¸æˆæ—¶é—´</div>
          <div class="reward-cost">éœ€è¦: 3ä¸ªä»£åŠ</div>
        </div>
        <div class="reward-item">
          <div class="reward-icon">ğŸ•</div>
          <div class="reward-name">ç¾é£Ÿå¥–åŠ±</div>
          <div class="reward-desc">å®Œæˆ5ä¸ªä»£åŠåäº«å—ä¸€é¡¿ç¾é£Ÿ</div>
          <div class="reward-cost">éœ€è¦: 5ä¸ªä»£åŠ</div>
        </div>
        <div class="reward-item">
          <div class="reward-icon">ğŸ›ï¸</div>
          <div class="reward-name">è´­ç‰©å¥–åŠ±</div>
          <div class="reward-desc">å®Œæˆ10ä¸ªä»£åŠåè´­ä¹°å¿ƒä»ªç‰©å“</div>
          <div class="reward-cost">éœ€è¦: 10ä¸ªä»£åŠ</div>
        </div>
        <div class="reward-item">
          <div class="reward-icon">âœˆï¸</div>
          <div class="reward-name">æ—…è¡Œå¥–åŠ±</div>
          <div class="reward-desc">å®Œæˆ20ä¸ªä»£åŠåå®‰æ’ä¸€æ¬¡æ—…è¡Œ</div>
          <div class="reward-cost">éœ€è¦: 20ä¸ªä»£åŠ</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// æ¬²æœ›ä»£åŠç³»ç»Ÿäº¤äº’åŠŸèƒ½
class DesireTodoSystem {
  constructor() {
    this.todos = [];
    this.currentCategory = 'all';
    this.init();
  }
  
  init() {
    this.bindEvents();
    this.loadTodos();
    this.loadStats();
  }
  
  bindEvents() {
    // åˆ†ç±»ç­›é€‰
    document.querySelectorAll('.category-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        this.filterByCategory(e.target.getAttribute('data-category'));
      });
    });
    
    // æ·»åŠ æ–°ä»£åŠ
    document.getElementById('addTodoForm').addEventListener('submit', (e) => {
      e.preventDefault();
      this.addNewTodo();
    });
  }
  
  async loadTodos() {
    try {
      const response = await fetch('/tools/api/desire_todos/');
      const data = await response.json();
      
      if (data.success) {
        this.todos = data.todos;
        this.renderTodos();
      }
    } catch (error) {

    }
  }
  
  async loadStats() {
    try {
      const response = await fetch('/tools/api/desire_todos/stats/');
      const data = await response.json();
      
      if (data.success) {
        this.updateStatsDisplay(data.stats);
      }
    } catch (error) {

    }
  }
  
  filterByCategory(category) {
    this.currentCategory = category;
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
    document.querySelector(`[data-category="${category}"]`).classList.add('active');
    
    // ç­›é€‰ä»£åŠ
    const todos = document.querySelectorAll('.todo-item');
    todos.forEach(todo => {
      if (category === 'all' || todo.getAttribute('data-category') === category) {
        todo.style.display = 'block';
      } else {
        todo.style.display = 'none';
      }
    });
  }
  
  async addNewTodo() {
    const title = document.getElementById('todoTitle').value;
    const description = document.getElementById('todoDescription').value;
    const category = document.getElementById('todoCategory').value;
    const priority = document.getElementById('todoPriority').value;
    const reward = document.getElementById('todoReward').value;
    
    try {
      const response = await fetch('/tools/api/desire_todos/add/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': this.getCSRFToken()
        },
        body: JSON.stringify({
          title,
          description,
          category,
          priority,
          reward
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        const todoItem = this.createTodoItem({
          id: data.todo_id,
          title,
          description,
          category,
          priority,
          reward,
          is_completed: false,
          created_at: new Date().toLocaleString()
        });
        
        document.getElementById('todoList').prepend(todoItem);
        document.getElementById('addTodoForm').reset();
        
        this.showNotification('æ¬²æœ›ä»£åŠæ·»åŠ æˆåŠŸï¼', 'success');
        this.loadStats();
      } else {
        this.showNotification('æ·»åŠ å¤±è´¥: ' + data.error, 'error');
      }
    } catch (error) {
      this.showNotification('æ·»åŠ å¤±è´¥: ' + error.message, 'error');
    }
  }
  
  createTodoItem(todo) {
    const categoryNames = {
      'work': 'å·¥ä½œç›¸å…³',
      'personal': 'ä¸ªäººæˆé•¿',
      'health': 'å¥åº·ç”Ÿæ´»',
      'social': 'ç¤¾äº¤å…³ç³»',
      'entertainment': 'å¨±ä¹æ”¾æ¾',
      'finance': 'è´¢åŠ¡ç›®æ ‡'
    };
    
    const priorityClasses = {
      'high': 'priority-high',
      'medium': 'priority-medium',
      'low': 'priority-low'
    };
    
    const todoItem = document.createElement('div');
    todoItem.className = `todo-item ${todo.is_completed ? 'completed' : ''}`;
    todoItem.setAttribute('data-category', todo.category);
    todoItem.setAttribute('data-id', todo.id);
    
    todoItem.innerHTML = `
      <div class="todo-header">
        <div class="todo-title">${todo.title}</div>
        <div class="todo-priority ${priorityClasses[todo.priority]}">${todo.priority === 'high' ? 'é«˜' : todo.priority === 'medium' ? 'ä¸­' : 'ä½'}ä¼˜å…ˆçº§</div>
      </div>
      <div class="todo-description">${todo.description}</div>
      <div class="todo-meta">
        <span>åˆ†ç±»: ${categoryNames[todo.category]}</span>
        <span class="todo-reward">å¥–åŠ±: ${todo.reward}</span>
      </div>
      <div class="todo-actions">
        <button class="todo-btn btn-complete" onclick="desireTodoSystem.completeTodo(${todo.id})" ${todo.is_completed ? 'disabled' : ''}>
          ${todo.is_completed ? 'å·²å®Œæˆ' : 'å®Œæˆ'}
        </button>
        <button class="todo-btn btn-edit" onclick="desireTodoSystem.editTodo(${todo.id})">ç¼–è¾‘</button>
        <button class="todo-btn btn-delete" onclick="desireTodoSystem.deleteTodo(${todo.id})">åˆ é™¤</button>
      </div>
    `;
    
    return todoItem;
  }
  
  renderTodos() {
    const todoList = document.getElementById('todoList');
    todoList.innerHTML = '';
    
    this.todos.forEach(todo => {
      const todoItem = this.createTodoItem(todo);
      todoList.appendChild(todoItem);
    });
  }
  
  async completeTodo(todoId) {
    try {
      const response = await fetch('/tools/api/desire_todos/complete/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': this.getCSRFToken()
        },
        body: JSON.stringify({ todo_id: todoId })
      });
      
      const data = await response.json();
      
      if (data.success) {
        const todoItem = document.querySelector(`[data-id="${todoId}"]`);
        todoItem.classList.add('completed');
        const completeBtn = todoItem.querySelector('.btn-complete');
        completeBtn.textContent = 'å·²å®Œæˆ';
        completeBtn.disabled = true;
        
        this.showNotification('æ¬²æœ›ä»£åŠå®Œæˆï¼', 'success');
        this.loadStats();
        this.checkRewards();
      } else {
        this.showNotification('å®Œæˆå¤±è´¥: ' + data.error, 'error');
      }
    } catch (error) {
      this.showNotification('å®Œæˆå¤±è´¥: ' + error.message, 'error');
    }
  }
  
  async deleteTodo(todoId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»£åŠå—ï¼Ÿ')) return;
    
    try {
      const response = await fetch('/tools/api/desire_todos/delete/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': this.getCSRFToken()
        },
        body: JSON.stringify({ todo_id: todoId })
      });
      
      const data = await response.json();
      
      if (data.success) {
        const todoItem = document.querySelector(`[data-id="${todoId}"]`);
        todoItem.remove();
        
        this.showNotification('æ¬²æœ›ä»£åŠåˆ é™¤æˆåŠŸ', 'success');
        this.loadStats();
      } else {
        this.showNotification('åˆ é™¤å¤±è´¥: ' + data.error, 'error');
      }
    } catch (error) {
      this.showNotification('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
    }
  }
  
  editTodo(todoId) {
    const todoItem = document.querySelector(`[data-id="${todoId}"]`);
    const title = todoItem.querySelector('.todo-title').textContent;
    const description = todoItem.querySelector('.todo-description').textContent;
    
    // è¿™é‡Œå¯ä»¥å®ç°ç¼–è¾‘åŠŸèƒ½
    this.showNotification('ç¼–è¾‘åŠŸèƒ½å¼€å‘ä¸­...', 'info');
  }
  
  updateStatsDisplay(stats) {
    document.getElementById('totalTodos').textContent = stats.total_todos;
    document.getElementById('completedTodos').textContent = stats.completed_todos;
    document.getElementById('pendingTodos').textContent = stats.pending_todos;
    document.getElementById('totalRewards').textContent = stats.total_rewards;
  }
  
  checkRewards() {
    const completedTodos = document.querySelectorAll('.todo-item.completed').length;
    const rewards = document.querySelectorAll('.reward-item');
    
    rewards.forEach((reward, index) => {
      const required = [3, 5, 10, 20][index];
      if (completedTodos >= required) {
        reward.classList.add('unlocked');
      }
    });
  }
  
  getCSRFToken() {
    const token = document.querySelector('[name=csrfmiddlewaretoken]');
    return token ? token.value : '';
  }
  
  showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 1rem 2rem;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      z-index: 1000;
      animation: slideIn 0.3s ease;
      background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8'};
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.remove();
    }, 3000);
  }
};

// å…¨å±€å‡½æ•°
function completeTodo(btn) {
  const todoItem = btn.closest('.todo-item');
  const todoId = todoItem.getAttribute('data-id');
  desireTodoSystem.completeTodo(todoId);
}

function editTodo(btn) {
  const todoItem = btn.closest('.todo-item');
  const todoId = todoItem.getAttribute('data-id');
  desireTodoSystem.editTodo(todoId);
}

function deleteTodo(btn) {
  const todoItem = btn.closest('.todo-item');
  const todoId = todoItem.getAttribute('data-id');
  desireTodoSystem.deleteTodo(todoId);
}

// åˆå§‹åŒ–æ¬²æœ›ä»£åŠç³»ç»Ÿ
let desireTodoSystem;
document.addEventListener('DOMContentLoaded', function() {
  desireTodoSystem = new DesireTodoSystem();
});


</script>
{% endblock %} 