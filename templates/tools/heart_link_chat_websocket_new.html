{% extends 'base.html' %}
{% load static %}

{% block title %}聊天室 - {{ room_id }}{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        max-width: 800px;
        margin: 0 auto;
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .chat-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .chat-actions {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    
    .video-chat-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border-radius: 50%;
        text-decoration: none;
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .video-chat-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
        color: white;
        text-decoration: none;
    }
    
    .video-chat-btn i {
        font-size: 1.2em;
    }

    .chat-header h3 {
        margin: 0;
        font-size: 18px;
    }

    .connection-status {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
    }

    .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #ff4757;
        animation: pulse 2s infinite;
    }

    .status-indicator.connected {
        background: #2ed573;
    }

    .chat-messages {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background: #f8f9fa;
    }

    .message {
        margin-bottom: 15px;
        display: flex;
        flex-direction: column;
    }

    .message.own {
        align-items: flex-end;
    }

    .message.other {
        align-items: flex-start;
    }

    .message-bubble {
        max-width: 70%;
        padding: 12px 16px;
        border-radius: 18px;
        position: relative;
        word-wrap: break-word;
    }

    .message.own .message-bubble {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-bottom-right-radius: 4px;
    }

    .message.other .message-bubble {
        background: white;
        color: #333;
        border: 1px solid #e9ecef;
        border-bottom-left-radius: 4px;
    }

    .message-content {
        margin-bottom: 5px;
    }

    .message-image {
        max-width: 100%;
        max-height: 300px;
        border-radius: 8px;
        cursor: pointer;
        transition: transform 0.2s;
    }

    .message-image:hover {
        transform: scale(1.05);
    }

    .message-audio {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
    }

    .audio-player {
        height: 40px;
        border-radius: 20px;
        flex: 1;
        min-width: 200px;
    }
    
    .audio-download-btn {
        background: #667eea;
        color: white;
        border: none;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .audio-download-btn:hover {
        background: #5a6fd8;
        transform: scale(1.1);
    }

    .message-file {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
        background: rgba(0, 0, 0, 0.05);
        border-radius: 8px;
    }

    .message-file a {
        color: inherit;
        text-decoration: none;
        font-weight: 500;
    }

    .message-meta {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        color: #6c757d;
        margin-top: 4px;
    }

    .message.own .message-meta {
        justify-content: flex-end;
    }

    .message-time {
        font-size: 12px;
        font-weight: 600;
        color: #495057;
        background: rgba(255, 255, 255, 0.8);
        padding: 2px 6px;
        border-radius: 4px;
        margin-right: 4px;
    }

    .message-status {
        font-size: 11px;
        font-weight: 500;
    }

    .message-status.unread {
        color: #ff4757;
    }

    .message-status.read {
        color: #2ed573;
    }

    .chat-input-container {
        padding: 20px;
        background: white;
        border-top: 1px solid #e9ecef;
    }

    .chat-toolbar {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
    }

    .toolbar-btn {
        background: none;
        border: none;
        padding: 8px;
        border-radius: 50%;
        cursor: pointer;
        transition: background-color 0.2s;
        color: #6c757d;
    }

    .toolbar-btn:hover {
        background: #f8f9fa;
        color: #495057;
    }

    .toolbar-btn.active {
        background: #e9ecef;
        color: #495057;
    }

    .emoji-picker {
        position: absolute;
        bottom: 100%;
        left: 0;
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 10px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        z-index: 99999;
        display: none;
        min-width: 200px;
        max-width: 300px;
        margin-bottom: 10px;
        visibility: hidden;
    }
    
    .emoji-picker.show {
        display: block !important;
        visibility: visible !important;
    }

    .emoji-grid {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        gap: 5px;
    }

    .emoji-btn {
        background: none;
        border: none;
        padding: 5px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 20px;
        transition: background-color 0.2s;
    }

    .emoji-btn:hover {
        background: #f8f9fa;
    }

    .chat-input-wrapper {
        position: relative;
        display: flex;
        align-items: flex-end;
        gap: 10px;
    }

    .chat-input {
        flex: 1;
        border: 1px solid #e9ecef;
        border-radius: 20px;
        padding: 12px 16px;
        resize: none;
        outline: none;
        font-family: inherit;
        font-size: 14px;
        line-height: 1.4;
        max-height: 120px;
        transition: all 0.2s;
        background: #f8f9fa;
        color: #495057;
    }

    .chat-input:focus {
        border-color: #667eea;
        background: white;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .chat-input::placeholder {
        color: #adb5bd;
    }

    .chat-send-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 50%;
        width: 44px;
        height: 44px;
        cursor: pointer;
        transition: transform 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .chat-send-btn:hover {
        transform: scale(1.05);
    }

    .chat-send-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .typing-indicator {
        padding: 10px 20px;
        color: #6c757d;
        font-style: italic;
        font-size: 14px;
    }

    .system-message {
        text-align: center;
        margin: 20px 0;
        padding: 10px;
        background: rgba(0, 0, 0, 0.05);
        border-radius: 8px;
        color: #6c757d;
    }

    .room-ended-message {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }

    .welcome-message {
        text-align: center;
        padding: 40px 20px;
        color: #6c757d;
    }

    .welcome-message h4 {
        margin-bottom: 10px;
        color: #495057;
    }

    .no-messages {
        text-align: center;
        padding: 40px 20px;
        color: #6c757d;
    }

    .cooldown-message {
        font-size: 12px;
        color: #6c757d;
        text-align: center;
        margin-top: 5px;
    }

    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }

    .pulse-animation {
        animation: pulse 1.5s ease-in-out infinite;
    }

    .file-input {
        display: none;
    }

    .upload-progress {
        margin-top: 10px;
        padding: 10px;
        background: #e9ecef;
        border-radius: 8px;
        display: none;
    }

    .progress-bar {
        width: 100%;
        height: 4px;
        background: #dee2e6;
        border-radius: 2px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        width: 0%;
        transition: width 0.3s;
    }

    @media (max-width: 768px) {
        .chat-container {
            height: 100vh;
            border-radius: 0;
        }
        
        .message-bubble {
            max-width: 85%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-container">
    <!-- 聊天头部 -->
    <div class="chat-header">
        <h3>聊天室 {{ room_id|truncatechars:8 }}</h3>
        <div class="connection-status">
            <div class="status-indicator" id="status-indicator"></div>
            <span id="status-text">连接中...</span>
        </div>
        <div class="chat-actions">
            <a href="/tools/video-chat/{{ room_id }}/" class="video-chat-btn" title="开始视频通话">
                <i class="fas fa-video"></i>
            </a>
        </div>
    </div>

    <!-- 聊天消息区域 -->
    <div class="chat-messages" id="chat-messages">
        <div class="welcome-message">
            <h4>欢迎来到聊天室</h4>
            <p>开始您的对话吧！</p>
        </div>
    </div>

    <!-- 聊天输入区域 -->
    <div class="chat-input-container">
        <!-- 工具栏 -->
        <div class="chat-toolbar">
            <button class="toolbar-btn" title="表情" id="emoji-btn" style="position: relative; z-index: 1000;">
                <i class="fas fa-smile"></i>
            </button>
            <button class="toolbar-btn" title="图片" onclick="document.getElementById('image-input').click()">
                <i class="fas fa-image"></i>
            </button>
            <button class="toolbar-btn" title="录音" id="record-btn">
                <i class="fas fa-microphone"></i>
            </button>
            <button class="toolbar-btn" title="文件" onclick="document.getElementById('file-input').click()">
                <i class="fas fa-paperclip"></i>
            </button>
            <button class="toolbar-btn" title="视频通话" onclick="sendVideoCallInvite()">
                <i class="fas fa-video"></i>
            </button>
        </div>

        <!-- 表情选择器 -->
        <div class="emoji-picker" id="emoji-picker" style="display: none;">
            <div class="emoji-grid">
                <button class="emoji-btn" onclick="insertEmoji('😊')">😊</button>
                <button class="emoji-btn" onclick="insertEmoji('😂')">😂</button>
                <button class="emoji-btn" onclick="insertEmoji('😍')">😍</button>
                <button class="emoji-btn" onclick="insertEmoji('🤔')">🤔</button>
                <button class="emoji-btn" onclick="insertEmoji('👍')">👍</button>
                <button class="emoji-btn" onclick="insertEmoji('❤️')">❤️</button>
                <button class="emoji-btn" onclick="insertEmoji('😭')">😭</button>
                <button class="emoji-btn" onclick="insertEmoji('🎉')">🎉</button>
                <button class="emoji-btn" onclick="insertEmoji('🔥')">🔥</button>
                <button class="emoji-btn" onclick="insertEmoji('💯')">💯</button>
                <button class="emoji-btn" onclick="insertEmoji('😎')">😎</button>
                <button class="emoji-btn" onclick="insertEmoji('🤗')">🤗</button>
                <button class="emoji-btn" onclick="insertEmoji('😴')">😴</button>
                <button class="emoji-btn" onclick="insertEmoji('🤯')">🤯</button>
                <button class="emoji-btn" onclick="insertEmoji('🥳')">🥳</button>
                <button class="emoji-btn" onclick="insertEmoji('😇')">😇</button>
            </div>
        </div>

        <!-- 输入区域 -->
        <div class="chat-input-wrapper">
            <textarea 
                class="chat-input" 
                id="chat-input" 
                placeholder="输入消息..." 
                rows="1"
                onkeydown="handleKeyDown(event)"
                oninput="autoResize(this)"
            ></textarea>
            <button class="chat-send-btn" id="send-btn">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>

        <!-- 冷却提示 -->
        <div class="cooldown-message" id="send-cooldown"></div>

        <!-- 上传进度 -->
        <div class="upload-progress" id="upload-progress">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
        </div>
    </div>

    <!-- 隐藏的文件输入 -->
    <input type="file" id="image-input" class="file-input" accept="image/*" onchange="handleImageUpload(event)">
    <input type="file" id="file-input" class="file-input" onchange="handleFileUpload(event)">
</div>

<!-- 图片预览模态框 -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">图片预览</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="closeImageModal()"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modal-image" src="" alt="预览图片" style="max-width: 100%; max-height: 70vh; object-fit: contain;">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeImageModal()">关闭</button>
                <button type="button" class="btn btn-primary" onclick="downloadImage()">下载图片</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Bootstrap JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
// WebSocket连接
let socket = null;
let reconnectAttempts = 0;
const maxReconnectAttempts = 5;
const reconnectDelay = 3000;

// 聊天状态
let lastMessageId = 0;
let typingTimeout = null;
let sendCooldown = false;
let sendCooldownTimer = null;
let isRecording = false;
let recordingTimer = null;
let recordingStartTime = null;
let mediaRecorder = null;
let audioChunks = [];

// 获取房间ID
const roomId = '{{ room_id }}';

// 页面加载时初始化
document.addEventListener('DOMContentLoaded', function() {

    // 检查roomId是否有效
    if (!roomId || roomId === 'undefined' || roomId === 'null' || roomId === '') {
        console.error('❌ 无效的roomId:', roomId);
        console.error('无法初始化聊天功能');
        return;
    }

    // 延迟一点初始化，确保DOM完全准备好
    setTimeout(() => {
        initializeEventListeners();
        connectWebSocket();
        loadInitialMessages();
    }, 100);
});

// 初始化事件监听器
function initializeEventListeners() {

    // 表情按钮 - 彻底重写

    const emojiBtn = document.getElementById('emoji-btn');
    if (emojiBtn) {

        // 清除所有旧事件
        emojiBtn.removeEventListener('click', handleEmojiClick);
        emojiBtn.onclick = null;
        
        // 设置样式确保可点击
        emojiBtn.style.pointerEvents = 'auto';
        emojiBtn.style.cursor = 'pointer';
        emojiBtn.style.zIndex = '10000';
        emojiBtn.style.position = 'relative';
        emojiBtn.disabled = false;
        
        // 使用简单直接的事件处理
        emojiBtn.onclick = function(e) {

            e.preventDefault();
            e.stopPropagation();
            toggleEmojiPicker();
        };
        
        // 添加hover效果验证按钮响应
        emojiBtn.onmouseenter = function() {

            this.style.backgroundColor = '#e9ecef';
        };
        
        emojiBtn.onmouseleave = function() {

            this.style.backgroundColor = '';
        };

    } else {
        console.error('❌ 表情按钮未找到！');
        setTimeout(() => {

            const delayedBtn = document.getElementById('emoji-btn');
            if (delayedBtn) {

                delayedBtn.onclick = function(e) {

                    e.preventDefault();
                    e.stopPropagation();
                    toggleEmojiPicker();
                };
            }
        }, 1000);
    }
    
    // 录音按钮
    const recordBtn = document.getElementById('record-btn');
    if (recordBtn) {
        recordBtn.addEventListener('click', toggleVoiceRecording);
    }
    
    // 发送按钮
    const sendBtn = document.getElementById('send-btn');
    if (sendBtn) {
        sendBtn.addEventListener('click', sendMessage);
    }
    
    // 点击其他地方隐藏表情选择器
    document.addEventListener('click', function(event) {
        const emojiPicker = document.getElementById('emoji-picker');
        const emojiBtn = document.getElementById('emoji-btn');
        
        if (emojiPicker && !emojiPicker.contains(event.target) && !emojiBtn.contains(event.target)) {
            emojiPicker.style.display = 'none';
        }
    });
    
    // 事件委托：处理文件下载链接点击
    document.addEventListener('click', function(event) {
        if (event.target.classList.contains('file-download-link') || event.target.closest('.file-download-link')) {
            event.preventDefault();
            const link = event.target.classList.contains('file-download-link') ? event.target : event.target.closest('.file-download-link');
            const fileUrl = link.getAttribute('data-file-url');
            const fileName = link.getAttribute('data-file-name');
            downloadFile(fileUrl, fileName);
        }
    });
    
    // 事件委托：处理音频下载按钮点击
    document.addEventListener('click', function(event) {
        if (event.target.classList.contains('audio-download-btn') || event.target.closest('.audio-download-btn')) {
            event.preventDefault();
            const btn = event.target.classList.contains('audio-download-btn') ? event.target : event.target.closest('.audio-download-btn');
            const fileUrl = btn.getAttribute('data-file-url');
            const fileName = btn.getAttribute('data-file-name');
            downloadFile(fileUrl, fileName);
        }
    });
}

// 处理表情按钮点击
function handleEmojiClick(event) {
    event.preventDefault();
    event.stopPropagation();

    const picker = document.getElementById('emoji-picker');
    if (picker) {
        // 检查当前显示状态
        const isCurrentlyVisible = picker.classList.contains('show') || 
                                  picker.style.display === 'block' ||
                                  getComputedStyle(picker).display === 'block';

        if (isCurrentlyVisible) {
            // 隐藏
            picker.classList.remove('show');
            picker.style.display = 'none';
            picker.style.visibility = 'hidden';

        } else {
            // 显示
            picker.classList.add('show');
            picker.style.display = 'block';
            picker.style.visibility = 'visible';
            picker.style.position = 'absolute';
            picker.style.zIndex = '99999';
            picker.style.bottom = '100%';
            picker.style.left = '0';

        }
    } else {
        console.error('表情选择器未找到');
    }
}

// 连接WebSocket
function connectWebSocket() {
    // 检查roomId是否有效
    if (!roomId || roomId === 'undefined' || roomId === 'null' || roomId === '') {
        console.error('❌ 无效的roomId:', roomId);
        console.error('无法建立WebSocket连接');
        return;
    }
    
    // 检查是否已经连接
    if (socket && socket.readyState === WebSocket.OPEN) {

        return;
    }
    
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/chat/${roomId}/`;

    try {
        socket = new WebSocket(wsUrl);
    } catch (error) {
        console.error('❌ WebSocket创建失败:', error);
        return;
    }
    
    socket.onopen = function(event) {

        updateConnectionStatus(true);
        reconnectAttempts = 0;
    };
    
    socket.onmessage = function(event) {
        const data = JSON.parse(event.data);
        handleWebSocketMessage(data);
    };
    
    socket.onclose = function(event) {

        updateConnectionStatus(false);
        
        // 如果不是正常关闭，尝试重连
        if (event.code !== 1000 && reconnectAttempts < maxReconnectAttempts) {
            setTimeout(() => {
                reconnectAttempts++;

                // 检查roomId是否仍然有效
                if (roomId && roomId !== 'undefined' && roomId !== 'null' && roomId !== '') {
                    connectWebSocket();
                } else {
                    console.error('❌ roomId无效，停止重连尝试');
                }
            }, reconnectDelay);
        } else if (reconnectAttempts >= maxReconnectAttempts) {
            console.error('重连次数已达上限，请刷新页面');
            alert('连接已断开，请刷新页面重试');
        }
    };
    
    socket.onerror = function(error) {
        console.error('WebSocket错误:', error);
        updateConnectionStatus(false);
    };
}

// 更新连接状态
function updateConnectionStatus(connected) {
    const indicator = document.getElementById('status-indicator');
    const statusText = document.getElementById('status-text');
    
    if (connected) {
        indicator.classList.add('connected');
        statusText.textContent = '已连接';
    } else {
        indicator.classList.remove('connected');
        statusText.textContent = '连接中...';
    }
}

// 处理WebSocket消息
function handleWebSocketMessage(data) {

    switch (data.type) {
        case 'connection_established':

            break;
            
        case 'chat_message':
            addMessageToChat(data.message);
            break;
            
        case 'user_typing':
            handleUserTyping(data.username, data.is_typing);
            break;
            
        case 'user_joined':

            showSystemMessage(`${data.username} 加入了聊天室`);
            break;
            
        case 'new_message':
            // 收到新消息通知，刷新消息列表

            loadInitialMessages();
            break;
            
        case 'video_call_invite':
            handleVideoCallInvite(data);
            break;
            
        case 'video_call_status':
            handleVideoCallStatus(data);
            break;
            
        case 'read_status_update':
            updateMessageReadStatus(data.message_ids, data.username);
            break;
            
        default:

    }
}

// 加载初始消息
function loadInitialMessages() {
    // 检查roomId是否有效
    if (!roomId || roomId === 'undefined' || roomId === 'null' || roomId === '') {
        console.error('❌ 无效的roomId，无法加载消息:', roomId);
        return;
    }

    fetch(`/tools/api/chat/${roomId}/messages/`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.messages) {
                displayMessages(data.messages);
                // 标记消息为已读
                markMessagesAsRead();
            } else if (data.room_ended) {
                showRoomEndedMessage();
                disableChatInput();
            }
        })
        .catch(error => console.error('Error loading messages:', error));
}

// 显示消息
function displayMessages(messages) {
    const messagesContainer = document.getElementById('chat-messages');
    const welcomeMessage = messagesContainer.querySelector('.welcome-message');
    if (welcomeMessage) {
        welcomeMessage.remove();
    }
    
    messages.forEach(message => {
        if (message.id > lastMessageId) {
            addMessageToChat(message);
            lastMessageId = Math.max(lastMessageId, message.id);
        }
    });
}

// 添加消息到聊天界面
function addMessageToChat(message) {
    const messagesContainer = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${message.is_own ? 'own' : 'other'}`;
    messageDiv.setAttribute('data-message-id', message.id);
    
    const time = new Date(message.created_at).toLocaleTimeString('zh-CN', {
        hour: '2-digit',
        minute: '2-digit'
    });
    
    let contentHtml = '';
    if (message.message_type === 'image') {
        // 确保图片URL是完整的
        const imageUrl = message.file_url.startsWith('http') ? message.file_url : 
                        message.file_url.startsWith('/media/') ? window.location.origin + message.file_url :
                        window.location.origin + '/media/' + message.file_url;
        contentHtml = `<img src="${imageUrl}" alt="图片" class="message-image" onclick="openImageModal('${imageUrl}')" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
            <div class="image-error" style="display: none; color: #dc3545; font-size: 12px;">图片加载失败</div>`;
    } else if (message.message_type === 'audio' || message.message_type === 'voice') {
        // 确保音频URL是完整的
        const audioUrl = message.file_url.startsWith('http') ? message.file_url : 
                        message.file_url.startsWith('/media/') ? window.location.origin + message.file_url :
                        window.location.origin + '/media/' + message.file_url;
        contentHtml = `
            <div class="message-audio">
                <audio controls class="audio-player" preload="metadata">
                    <source src="${audioUrl}" type="audio/webm">
                    <source src="${audioUrl}" type="audio/mp3">
                    <source src="${audioUrl}" type="audio/wav">
                    <source src="${audioUrl}" type="audio/ogg">
                    您的浏览器不支持音频播放
                </audio>
                <button class="audio-download-btn" data-file-url="${audioUrl}" data-file-name="voice_message.webm" title="下载音频">
                    <i class="fas fa-download"></i>
                </button>
            </div>
        `;
    } else if (message.message_type === 'file') {
        // 确保文件URL是完整的
        const fileUrl = message.file_url.startsWith('http') ? message.file_url : 
                       message.file_url.startsWith('/media/') ? window.location.origin + message.file_url :
                       window.location.origin + '/media/' + message.file_url;
        contentHtml = `
            <div class="message-file">
                <i class="fas fa-file"></i>
                <a href="javascript:void(0)" data-file-url="${fileUrl}" data-file-name="${escapeHtml(message.content)}" class="file-download-link" title="点击下载文件">${escapeHtml(message.content)}</a>
            </div>
        `;
    } else {
        contentHtml = `<div class="message-content">${escapeHtml(message.content)}</div>`;
    }
    
    let statusHtml = '';
    if (message.is_own) {
        // 发送方显示已读状态（知道对方是否已读）
        statusHtml = `<span class="message-status ${message.is_read ? 'read' : 'unread'}">${message.is_read ? '已读' : '未读'}</span>`;
    } else {
        // 接收方也显示已读状态（表示自己是否已读这条消息）
        statusHtml = `<span class="message-status ${message.is_read ? 'read' : 'unread'}">${message.is_read ? '已读' : '未读'}</span>`;
    }
    
    messageDiv.innerHTML = `
        <div class="message-bubble">
            ${contentHtml}
            <div class="message-meta">
                <span class="message-time">${time}</span>
                ${statusHtml}
            </div>
        </div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    scrollToBottom();
}

// 发送消息
function sendMessage() {
    const input = document.getElementById('chat-input');
    const content = input.value.trim();
    
    if (!content) {

        return;
    }
    
    const sendBtn = document.getElementById('send-btn');
    sendBtn.disabled = true;

    // 通过WebSocket发送消息
    if (socket && socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({
            type: 'message',
            content: content,
            message_type: 'text'
        }));
        
        // 清空输入框
        input.value = '';
        autoResize(input);
        
        // 重新启用发送按钮
        setTimeout(() => {
            sendBtn.disabled = false;
        }, 1000);
    } else {
        console.error('WebSocket未连接');
        alert('连接已断开，请刷新页面重试');
    }
}

// 处理回车键
function handleKeyDown(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        event.stopPropagation();
        

        
        const sendBtn = document.getElementById('send-btn');
        if (sendBtn.disabled) {

            return false;
        }
        
        const input = document.getElementById('chat-input');
        const content = input.value.trim();
        if (!content) {

            return false;
        }

        sendMessage();
        
        return false;
    }
}

// 处理发送按钮点击（已内联到事件监听器中）

// 冷却功能已移除 - 允许快速发送消息

// 处理表情按钮点击（已内联到事件监听器中）

// 插入表情到输入框
function insertEmoji(emoji) {
    const messageInput = document.getElementById('message-input');
    if (messageInput) {
        const currentValue = messageInput.value;
        const cursorPosition = messageInput.selectionStart;
        const newValue = currentValue.slice(0, cursorPosition) + emoji + currentValue.slice(cursorPosition);
        messageInput.value = newValue;
        messageInput.focus();
        // 设置光标位置到表情后面
        messageInput.setSelectionRange(cursorPosition + emoji.length, cursorPosition + emoji.length);
        
        // 隐藏表情选择器
        const picker = document.getElementById('emoji-picker');
        if (picker) {
            picker.style.display = 'none';
            picker.classList.remove('show');
        }
    }
}

// 显示系统消息
function showSystemMessage(message) {
    const chatContainer = document.getElementById('chat-messages');
    if (chatContainer) {
        const systemMsg = document.createElement('div');
        systemMsg.className = 'system-message';
        systemMsg.style.cssText = `
            text-align: center;
            color: #666;
            font-style: italic;
            margin: 10px 0;
            font-size: 0.9em;
        `;
        systemMsg.textContent = message;
        chatContainer.appendChild(systemMsg);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
}

// 发送视频通话邀请
function sendVideoCallInvite() {

    // 通过WebSocket发送邀请
    if (socket && socket.readyState === WebSocket.OPEN) {
        const message = {
            type: 'video_call_invite',
            room_id: roomId,
            message: '邀请您进行视频通话'
        };
        
        socket.send(JSON.stringify(message));

        // 在聊天中显示邀请消息
        showVideoInviteMessage('您', '发起了视频通话邀请', roomId, true);
    } else {
        console.error('WebSocket连接未建立');
        alert('连接未建立，无法发送邀请');
    }
}

// 处理收到的视频通话邀请
function handleVideoCallInvite(data) {

    // 在聊天中显示邀请消息
    showVideoInviteMessage(data.username || '对方', '邀请您进行视频通话', data.room_id || roomId, false);
}

// 处理视频通话状态更新
function handleVideoCallStatus(data) {

    if (data.message_id) {

        // 查找所有可能的消息ID（因为可能有多个视频邀请消息）
        const allVideoInvites = document.querySelectorAll('.video-invite-message');

        allVideoInvites.forEach((invite, index) => {
            const messageId = invite.id;

            if (messageId) {
                updateVideoCallStatus(messageId, data.status, data.username || '对方');
            }
        });
    } else {

    }
}

// 显示视频邀请消息
function showVideoInviteMessage(senderName, message, videoRoomId, isSelf) {
    const chatContainer = document.getElementById('chat-messages');
    if (!chatContainer) return;
    
    const messageId = `video-invite-${Date.now()}`;
    const messageDiv = document.createElement('div');
    messageDiv.id = messageId;
    messageDiv.className = `message ${isSelf ? 'self' : 'other'} video-invite-message`;
    messageDiv.style.cssText = `
        margin: 10px 0;
        padding: 15px;
        border-radius: 10px;
        background: ${isSelf ? '#007bff' : '#f8f9fa'};
        color: ${isSelf ? 'white' : '#333'};
        border: 2px solid #007bff;
    `;
    
    const statusId = `status-${messageId}`;
    
    messageDiv.innerHTML = `
        <div class="video-invite-content">
            <div class="invite-header">
                <i class="fas fa-video" style="margin-right: 8px;"></i>
                <strong>${senderName}</strong> ${message}
            </div>
            <div id="${statusId}" class="invite-status" style="margin-top: 8px; font-size: 0.9em; opacity: 0.8;">
                <i class="fas fa-clock"></i> 等待对方响应...
            </div>
            <div class="invite-actions" style="margin-top: 10px;">
                ${!isSelf ? `
                    <button onclick="joinVideoCall('${videoRoomId}', '${messageId}')" 
                            style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 5px; margin-right: 10px; cursor: pointer;">
                        <i class="fas fa-video"></i> 加入通话
                    </button>
                    <button onclick="declineVideoCall('${messageId}')" 
                            style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">
                        <i class="fas fa-times"></i> 拒绝
                    </button>
                ` : `
                    <button onclick="joinVideoCall('${videoRoomId}', '${messageId}')" 
                            style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">
                        <i class="fas fa-video"></i> 进入通话
                    </button>
                `}
            </div>
        </div>
    `;
    
    chatContainer.appendChild(messageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
    
    // 开始监控视频通话状态
    if (isSelf) {
        monitorVideoCallStatus(videoRoomId, messageId);
    }
}

// 监控视频通话状态
function monitorVideoCallStatus(videoRoomId, messageId) {
    const statusElement = document.getElementById(`status-${messageId}`);
    if (!statusElement) return;
    
    let checkCount = 0;
    const maxChecks = 120; // 检查120次，每次3秒，共6分钟
    let animationCount = 0;
    
    const statusInterval = setInterval(async () => {
        checkCount++;
        animationCount++;
        
        // 检查对方是否已进入视频聊天室
        try {
            const response = await fetch(`/tools/check-video-room-status/${videoRoomId}/`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.participants && data.participants.length > 1) {
                    // 对方已加入
                    statusElement.innerHTML = '<i class="fas fa-video" style="color: #28a745;"></i> 对方已加入通话';
                    statusElement.style.color = '#28a745';
                    clearInterval(statusInterval);
                    delete window.videoStatusIntervals[messageId];
                    return;
                } else if (data.status === 'declined') {
                    // 对方拒绝了
                    statusElement.innerHTML = '<i class="fas fa-times" style="color: #dc3545;"></i> 对方拒绝了通话';
                    statusElement.style.color = '#dc3545';
                    clearInterval(statusInterval);
                    delete window.videoStatusIntervals[messageId];
                    return;
                }
            }
        } catch (error) {

        }
        
        if (checkCount > maxChecks) {
            // 超时
            statusElement.innerHTML = '<i class="fas fa-clock" style="color: #dc3545;"></i> 邀请已过期';
            statusElement.style.color = '#dc3545';
            clearInterval(statusInterval);
            delete window.videoStatusIntervals[messageId];
            return;
        }
        
        // 更新等待状态动画
        const dots = '.'.repeat((animationCount % 3) + 1);
        const waitingText = '等待对方响应' + dots;
        statusElement.innerHTML = `<i class="fas fa-clock pulse-animation"></i> ${waitingText}`;
        
    }, 3000); // 每3秒检查一次
    
    // 存储interval以便后续清理
    if (!window.videoStatusIntervals) {
        window.videoStatusIntervals = {};
    }
    window.videoStatusIntervals[messageId] = statusInterval;
}

// 更新视频通话状态
function updateVideoCallStatus(messageId, status, userInfo) {
    const statusElement = document.getElementById(`status-${messageId}`);
    if (!statusElement) return;
    
    // 清理监控interval
    if (window.videoStatusIntervals && window.videoStatusIntervals[messageId]) {
        clearInterval(window.videoStatusIntervals[messageId]);
        delete window.videoStatusIntervals[messageId];
    }
    
    switch (status) {
        case 'joined':
            statusElement.innerHTML = `<i class="fas fa-check-circle" style="color: #28a745;"></i> ${userInfo || '对方'}已进入视频聊天`;
            statusElement.style.color = '#28a745';
            break;
        case 'declined':
            statusElement.innerHTML = `<i class="fas fa-times-circle" style="color: #dc3545;"></i> ${userInfo || '对方'}拒绝了邀请`;
            statusElement.style.color = '#dc3545';
            break;
        case 'left':
            statusElement.innerHTML = `<i class="fas fa-sign-out-alt" style="color: #ffc107;"></i> ${userInfo || '对方'}已离开视频聊天`;
            statusElement.style.color = '#ffc107';
            break;
        case 'expired':
            statusElement.innerHTML = '<i class="fas fa-clock"></i> 邀请已过期';
            statusElement.style.color = '#6c757d';
            break;
    }
}

// 加入视频通话
function joinVideoCall(videoRoomId, messageId) {

    // 更新状态
    if (messageId) {
        updateVideoCallStatus(messageId, 'joined', '您');
    }
    
    // 在新窗口打开视频通话页面
    const videoUrl = `/tools/video-chat/${videoRoomId}/`;
    window.open(videoUrl, '_blank', 'width=1200,height=800');
    
    // 通过WebSocket通知对方用户已加入
    if (socket && socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({
            type: 'video_call_status',
            room_id: roomId,
            video_room_id: videoRoomId,
            status: 'joined',
            message_id: messageId
        }));
    }
}

// 拒绝视频通话
function declineVideoCall(messageId) {

    // 更新状态
    if (messageId) {
        updateVideoCallStatus(messageId, 'declined', '您');
    }
    
    showSystemMessage('您拒绝了视频通话邀请');
    
    // 通过WebSocket通知对方用户拒绝了邀请
    if (socket && socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({
            type: 'video_call_status',
            room_id: roomId,
            status: 'declined',
            message_id: messageId
        }));
    }
}

// 切换表情选择器
function toggleEmojiPicker() {

    const picker = document.getElementById('emoji-picker');
    if (!picker) {
        console.error('❌ 表情选择器未找到');
        return;
    }
    
    // 检查当前显示状态
    const isCurrentlyVisible = picker.classList.contains('show');


    if (isCurrentlyVisible) {
        // 隐藏表情选择器

        picker.classList.remove('show');
        picker.style.display = 'none';
        picker.style.visibility = 'hidden';

    } else {
        // 显示表情选择器 - 强制设置所有必要样式

        picker.classList.add('show');
        
        // 强制设置样式，确保显示
        picker.style.display = 'block';
        picker.style.visibility = 'visible';
        picker.style.opacity = '1';
        picker.style.position = 'absolute';
        picker.style.bottom = '100%';
        picker.style.left = '0';
        picker.style.zIndex = '99999';
        picker.style.background = 'white';
        picker.style.border = '1px solid #e9ecef';
        picker.style.borderRadius = '8px';
        picker.style.padding = '10px';
        picker.style.boxShadow = '0 4px 20px rgba(0, 0, 0, 0.1)';
        picker.style.minWidth = '200px';
        picker.style.maxWidth = '300px';

        // 延迟添加关闭监听器
        setTimeout(() => {
            function closeEmojiPicker(e) {
                if (!picker.contains(e.target) && !e.target.closest('#emoji-btn')) {

                    picker.classList.remove('show');
                    picker.style.display = 'none';
                    picker.style.visibility = 'hidden';
                    document.removeEventListener('click', closeEmojiPicker);
                }
            }
            document.addEventListener('click', closeEmojiPicker);
        }, 100);
    }
    
    // 验证最终状态
    setTimeout(() => {
        const finalDisplay = getComputedStyle(picker).display;
        const finalVisibility = getComputedStyle(picker).visibility;
        const finalOpacity = getComputedStyle(picker).opacity;
        const finalZIndex = getComputedStyle(picker).zIndex;
        const hasShowClass = picker.classList.contains('show');








    }, 100);
}

// 获取Cookie函数
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// 插入表情
function insertEmoji(emoji) {
    const input = document.getElementById('chat-input');
    if (!input) {
        console.error('聊天输入框未找到');
        return;
    }
    
    const start = input.selectionStart;
    const end = input.selectionEnd;
    const text = input.value;
    
    input.value = text.substring(0, start) + emoji + text.substring(end);
    input.selectionStart = input.selectionEnd = start + emoji.length;
    input.focus();
    
    // 自动调整输入框高度
    autoResize(input);
    
    const picker = document.getElementById('emoji-picker');
    if (picker) {
        picker.style.display = 'none';
    }
}

// 处理图片上传
function handleImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // 检查文件类型
    if (!file.type.startsWith('image/')) {
        alert('请选择图片文件');
        return;
    }
    
    // 检查文件大小（5MB）
    if (file.size > 5 * 1024 * 1024) {
        alert('图片大小不能超过5MB');
        return;
    }
    
    const formData = new FormData();
    formData.append('image', file);
    formData.append('room_id', roomId);
    
    // 获取CSRF token
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || 
                     document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                     getCookie('csrftoken');
    if (!csrfToken) {
        alert('CSRF token未找到，请刷新页面重试');
        return;
    }
    
    // 显示上传进度
    const progressDiv = document.getElementById('upload-progress');
    const progressFill = document.getElementById('progress-fill');
    if (progressDiv) progressDiv.style.display = 'block';
    
    fetch(`/tools/api/chat/${roomId}/send-image/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (progressDiv) progressDiv.style.display = 'none';
        if (data.success) {
            // 图片上传成功，通过WebSocket广播给其他用户

            // 发送WebSocket消息通知其他用户有新图片
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    'type': 'new_message',
                    'message_id': data.message.id,
                    'room_id': roomId
                }));

            }
            
            // 本地刷新消息列表
            loadInitialMessages();
        } else {
            alert('发送图片失败: ' + data.error);
        }
    })
    .catch(error => {
        if (progressDiv) progressDiv.style.display = 'none';
        console.error('Error:', error);
        alert('网络错误，请重试');
    });
    
    event.target.value = '';
}

// 处理文件上传
function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // 检查文件大小（10MB）
    if (file.size > 10 * 1024 * 1024) {
        alert('文件大小不能超过10MB');
        return;
    }
    
    // 检查文件类型（排除可执行文件）
    const dangerousExtensions = ['.exe', '.bat', '.cmd', '.com', '.scr', '.pif', '.vbs', '.js', '.jar'];
    const fileName = file.name.toLowerCase();
    const hasDangerousExtension = dangerousExtensions.some(ext => fileName.endsWith(ext));
    
    if (hasDangerousExtension) {
        alert('不允许上传可执行文件');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', file);
    formData.append('room_id', roomId);
    
    // 获取CSRF token
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || 
                     document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                     getCookie('csrftoken');
    if (!csrfToken) {
        alert('CSRF token未找到，请刷新页面重试');
        return;
    }
    
    fetch(`/tools/api/chat/${roomId}/send-file/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 文件上传成功，通过WebSocket广播给其他用户

            // 发送WebSocket消息通知其他用户有新文件
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    'type': 'new_message',
                    'message_id': data.message.id,
                    'room_id': roomId
                }));

            }
            
            // 本地刷新消息列表
            loadInitialMessages();
        } else {
            alert('发送文件失败: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('网络错误，请重试');
    });
    
    event.target.value = '';
}

// 切换语音录制
function toggleVoiceRecording() {
    if (isRecording) {
        stopRecording();
    } else {
        startRecording();
    }
}

// 开始录音
function startRecording() {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert('您的浏览器不支持录音功能');
        return;
    }
    
    navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
            mediaRecorder = new MediaRecorder(stream, {
                mimeType: 'audio/webm;codecs=opus' // 使用WebM格式，支持更好的压缩
            });
            
            audioChunks = [];
            recordingStartTime = Date.now();
            
            mediaRecorder.ondataavailable = event => {
                audioChunks.push(event.data);
            };
            
            mediaRecorder.onstop = () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                uploadAudio(audioBlob);
                
                // 停止所有音轨
                stream.getTracks().forEach(track => track.stop());
            };
            
            mediaRecorder.start();
            isRecording = true;
            
            // 更新UI
            const recordBtn = document.getElementById('record-btn');
            if (recordBtn) {
                recordBtn.innerHTML = '<i class="fas fa-stop"></i>';
                recordBtn.style.backgroundColor = '#ff4757';
                recordBtn.style.color = 'white';
            }
            
            // 开始录音计时
            startRecordingTimer();

        })
        .catch(error => {
            console.error('录音失败:', error);
            alert('无法访问麦克风，请检查权限设置');
        });
}

// 停止录音
function stopRecording() {
    if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
        isRecording = false;
        
        // 更新UI
        const recordBtn = document.getElementById('record-btn');
        if (recordBtn) {
            recordBtn.innerHTML = '<i class="fas fa-microphone"></i>';
            recordBtn.style.backgroundColor = '';
            recordBtn.style.color = '';
        }
        
        // 停止计时
        stopRecordingTimer();

    }
}

// 上传音频文件
function uploadAudio(audioBlob) {
    const formData = new FormData();
    formData.append('audio', audioBlob, 'recording.webm');
    formData.append('room_id', roomId);
    
    // 获取CSRF token
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || 
                     document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                     getCookie('csrftoken');
    if (!csrfToken) {
        alert('CSRF token未找到，请刷新页面重试');
        return;
    }
    
    // 显示上传进度
    const progressDiv = document.getElementById('upload-progress');
    const progressFill = document.getElementById('progress-fill');
    if (progressDiv) progressDiv.style.display = 'block';
    
    fetch(`/tools/api/chat/${roomId}/send-audio/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (progressDiv) progressDiv.style.display = 'none';
        if (data.success) {
            // 语音上传成功，通过WebSocket广播给其他用户

            // 发送WebSocket消息通知其他用户有新语音
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    'type': 'new_message',
                    'message_id': data.message.id,
                    'room_id': roomId
                }));

            }
            
            // 本地刷新消息列表
            loadInitialMessages();
        } else {
            alert('发送语音失败: ' + data.error);
        }
    })
    .catch(error => {
        if (progressDiv) progressDiv.style.display = 'none';
        console.error('Error:', error);
        alert('网络错误，请重试');
    });
}

// 开始录音计时
function startRecordingTimer() {
    recordingTimer = setInterval(() => {
        const elapsed = Date.now() - recordingStartTime;
        const seconds = Math.floor(elapsed / 1000);
        const minutes = Math.floor(seconds / 60);
        
        const recordBtn = document.getElementById('record-btn');
        if (recordBtn) {
            const timeStr = `${minutes}:${(seconds % 60).toString().padStart(2, '0')}`;
            recordBtn.title = `录音中 ${timeStr}`;
        }
    }, 1000);
}

// 停止录音计时
function stopRecordingTimer() {
    if (recordingTimer) {
        clearInterval(recordingTimer);
        recordingTimer = null;
        
        const recordBtn = document.getElementById('record-btn');
        if (recordBtn) {
            recordBtn.title = '录音';
        }
    }
}

// 标记消息为已读
function markMessagesAsRead() {
    const unreadMessages = document.querySelectorAll('.message.other .message-status.unread');
    if (unreadMessages.length > 0) {
        const messageIds = Array.from(unreadMessages).map(el => {
            const messageDiv = el.closest('.message');
            return messageDiv.getAttribute('data-message-id');
        });

        // 通过WebSocket发送已读状态
        if (socket && socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({
                type: 'read_status',
                message_ids: messageIds
            }));
        }
        
        // 同时通过API标记已读
        fetch(`/tools/api/chat/${roomId}/mark-read/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || 
                              document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                              getCookie('csrftoken')
            },
            body: JSON.stringify({ message_ids: messageIds })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {

            }
        })
        .catch(error => {
            console.error('API标记已读失败:', error);
        });
    }
}

// 更新消息已读状态
function updateMessageReadStatus(messageIds, username) {
    messageIds.forEach(messageId => {
        const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
        if (messageDiv) {
            const statusElement = messageDiv.querySelector('.message-status');
            if (statusElement) {
                statusElement.textContent = '已读';
                statusElement.className = 'message-status read';
            }
        }
    });
}

// 处理用户打字状态
function handleUserTyping(username, isTyping) {
    // 可以在这里显示"对方正在输入..."的提示

}

// 自动调整输入框高度
function autoResize(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
}

// 滚动到底部
function scrollToBottom() {
    const messagesContainer = document.getElementById('chat-messages');
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// 打开图片模态框
function openImageModal(imageUrl) {

    const modalElement = document.getElementById('imageModal');
    const modalImage = document.getElementById('modal-image');
    
    if (!modalElement || !modalImage) {
        console.error('模态框元素未找到');
        window.open(imageUrl, '_blank');
        return;
    }
    
    // 确保图片URL是完整的
    const fullImageUrl = imageUrl.startsWith('http') ? imageUrl : window.location.origin + imageUrl;

    // 先设置图片源
    modalImage.src = fullImageUrl;
    window.currentImageUrl = fullImageUrl; // 保存图片URL用于下载
    
    // 确保图片加载完成后再显示模态框
    modalImage.onload = function() {

        try {
            // 检查Bootstrap是否可用
            if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
            } else {
                console.error('Bootstrap未加载');
                modalElement.style.display = 'block';
                modalElement.classList.add('show');
            }
        } catch (error) {
            console.error('Bootstrap模态框错误:', error);
            // 备用方案：直接显示模态框
            modalElement.style.display = 'block';
            modalElement.classList.add('show');
        }
    };
    
    modalImage.onerror = function() {
        console.error('图片加载失败:', fullImageUrl);
        alert('图片加载失败，请检查图片链接');
        window.open(fullImageUrl, '_blank');
    };
}

// 关闭图片模态框
function closeImageModal() {
    const modalElement = document.getElementById('imageModal');
    if (modalElement) {
        try {
            if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                    modal.hide();
                } else {
                    modalElement.style.display = 'none';
                    modalElement.classList.remove('show');
                }
            } else {
                modalElement.style.display = 'none';
                modalElement.classList.remove('show');
            }
        } catch (error) {
            console.error('关闭模态框失败:', error);
            modalElement.style.display = 'none';
            modalElement.classList.remove('show');
        }
    }
}

// 下载图片
function downloadImage() {
    const imageUrl = window.currentImageUrl;
    if (!imageUrl) {
        console.error('没有图片URL');
        return;
    }
    
    try {
        const link = document.createElement('a');
        link.href = imageUrl;
        link.download = 'image_' + Date.now() + '.jpg';
        link.target = '_blank';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

    } catch (error) {
        console.error('下载图片失败:', error);
        // 备用方案：在新窗口打开
        window.open(imageUrl, '_blank');
    }
}

// 下载文件
function downloadFile(fileUrl, fileName) {

    // 如果是聊天室文件，使用专门的下载API
    if (fileUrl.includes('/media/chat_')) {
        // 从URL中提取消息ID
        const urlParts = fileUrl.split('/');
        const filename = urlParts[urlParts.length - 1];
        const messageId = filename.split('_')[1]?.split('.')[0];
        
        if (messageId) {
            const downloadUrl = `/tools/api/chat/${roomId}/download/${messageId}/`;

            // 创建一个隐藏的下载链接
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.style.display = 'none';
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            return;
        }
    }
    
    // 确保文件URL是完整的
    const fullFileUrl = fileUrl.startsWith('http') ? fileUrl : window.location.origin + fileUrl;
    
    try {
        // 使用fetch下载文件
        fetch(fullFileUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.blob();
            })
            .then(blob => {
                // 创建下载链接
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);

            })
            .catch(error => {
                console.error('下载文件失败:', error);
                // 备用方案：直接打开链接
                window.open(fullFileUrl, '_blank');
            });
    } catch (error) {
        console.error('创建下载链接失败:', error);
        // 备用方案：在新窗口打开
        window.open(fullFileUrl, '_blank');
    }
}

// 显示聊天室结束消息
function showRoomEndedMessage() {
    const messagesContainer = document.getElementById('chat-messages');
    const endedMessage = document.createElement('div');
    endedMessage.className = 'system-message room-ended-message';
    endedMessage.innerHTML = `
        <div class="system-message-content">
            <i class="fas fa-exclamation-triangle"></i>
            <span>聊天室已结束，无法继续发送消息</span>
        </div>
    `;
    messagesContainer.appendChild(endedMessage);
    scrollToBottom();
}

// 禁用聊天输入
function disableChatInput() {
    const input = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const toolbarBtns = document.querySelectorAll('.toolbar-btn');
    
    input.disabled = true;
    sendBtn.disabled = true;
    toolbarBtns.forEach(btn => btn.disabled = true);
    
    input.classList.add('disabled');
    sendBtn.classList.add('disabled');
}

// HTML转义
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// 定期标记消息为已读
setInterval(markMessagesAsRead, 2000);

// 定期检查WebSocket连接状态
setInterval(() => {
    try {
        if (socket && socket.readyState === WebSocket.OPEN) {
            try {
                // 发送心跳包
                socket.send(JSON.stringify({ type: 'ping' }));
            } catch (error) {
                console.error('❌ 心跳包发送失败:', error);
                // 如果心跳包发送失败，可能需要重新连接
                if (error.name === 'InvalidStateError' || error.name === 'NetworkError') {

                    connectWebSocket();
                }
            }
        } else if (socket && socket.readyState === WebSocket.CLOSED) {

            // 检查roomId是否仍然有效
            if (roomId && roomId !== 'undefined' && roomId !== 'null' && roomId !== '') {
                connectWebSocket();
            } else {
                console.error('❌ roomId无效，停止重连尝试');
            }
        }
    } catch (error) {
        console.error('❌ WebSocket状态检查失败:', error);
    }
}, 30000); // 每30秒检查一次

// 页面卸载时关闭WebSocket连接
window.addEventListener('beforeunload', function() {
    if (socket) {
        socket.close();
    }
});

// 添加键盘事件监听
document.addEventListener('keydown', function(event) {
    // ESC键关闭图片模态框
    if (event.key === 'Escape') {
        const modalElement = document.getElementById('imageModal');
        if (modalElement && modalElement.style.display === 'block') {
            closeImageModal();
        }
        
        // ESC键关闭表情选择器
        const emojiPicker = document.getElementById('emoji-picker');
        if (emojiPicker && emojiPicker.classList.contains('show')) {
            emojiPicker.classList.remove('show');
            emojiPicker.style.display = 'none';
        }
    }
});

// 全局错误处理
window.addEventListener('error', function(event) {
    if (event.error && event.error.message && event.error.message.includes('WebSocket')) {
        console.error('🌐 WebSocket全局错误:', event.error);
        console.error('错误详情:', event.error.message);
        console.error('错误堆栈:', event.error.stack);
    }
});

// 全局未处理的Promise拒绝处理
window.addEventListener('unhandledrejection', function(event) {
    if (event.reason && event.reason.message && event.reason.message.includes('WebSocket')) {
        console.error('🌐 WebSocket Promise拒绝:', event.reason);
        console.error('错误详情:', event.reason.message);
    }
});
</script>
{% endblock %}
