{% extends "base.html" %}
{% block content %}

<div class="vanity-todo-container">
  <!-- åŠ¨æ€èƒŒæ™¯ -->
  <div class="vanity-background">
    <div class="money-rain"></div>
    <div class="luxury-shapes">
      <div class="shape car-shape">ğŸš—</div>
      <div class="shape yacht-shape">ğŸ›¥ï¸</div>
      <div class="shape diamond-shape">ğŸ’</div>
      <div class="shape mansion-shape">ğŸ°</div>
    </div>
  </div>

  <!-- ä¸»è¦å†…å®¹ -->
  <div class="vanity-content">
    <div class="vanity-header">
      <h1 class="vanity-title">æ¬²æœ›é©±åŠ¨å¾…åŠæ¸…å•</h1>
      <p class="vanity-subtitle">æ¯ä¸ªä»»åŠ¡éƒ½ç»‘å®šæ¬²æœ›å…‘ç°å€¼</p>
    </div>

    <!-- æ·»åŠ æ–°ä»»åŠ¡ -->
    <div class="add-task-section">
      <div class="dashboard-card">
        <h3>æ·»åŠ æ–°ä»»åŠ¡</h3>
        <form id="add-task-form">
          <div class="form-group">
            <label for="task-title">ä»»åŠ¡æ ‡é¢˜</label>
            <input type="text" id="task-title" name="title" required>
          </div>
          <div class="form-group">
            <label for="task-description">ä»»åŠ¡æè¿°</label>
            <textarea id="task-description" name="description" rows="3"></textarea>
          </div>
          <div class="form-group">
            <label for="task-type">ä»»åŠ¡ç±»å‹</label>
            <select id="task-type" name="task_type" required>
              <option value="code_refactor">ä»£ç é‡æ„</option>
              <option value="bug_fix">ä¿®å¤Bug</option>
              <option value="feature_dev">åŠŸèƒ½å¼€å‘</option>
              <option value="blog_write">å†™æŠ€æœ¯åšå®¢</option>
              <option value="code_review">ä»£ç å®¡æŸ¥</option>
              <option value="testing">æµ‹è¯•ç¼–å†™</option>
            </select>
          </div>
          <div class="form-group">
            <label for="task-difficulty">éš¾åº¦ç­‰çº§ (1-10)</label>
            <input type="number" id="task-difficulty" name="difficulty" min="1" max="10" value="3" required>
          </div>
          <button type="submit" class="btn btn-primary">æ·»åŠ ä»»åŠ¡</button>
        </form>
      </div>
    </div>

    <!-- ä»»åŠ¡åˆ—è¡¨ -->
    <div class="tasks-section">
      <div class="dashboard-card">
        <h3>æˆ‘çš„æ¬²æœ›ä»»åŠ¡</h3>
        <div id="tasks-list">
          <p>æ­£åœ¨åŠ è½½ä»»åŠ¡...</p>
        </div>
      </div>
    </div>

    <!-- ä»»åŠ¡ç»Ÿè®¡ -->
    <div class="stats-section">
      <div class="dashboard-card">
        <h3>ä»»åŠ¡ç»Ÿè®¡</h3>
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-number" id="total-tasks">0</div>
            <div class="stat-label">æ€»ä»»åŠ¡æ•°</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="completed-tasks">0</div>
            <div class="stat-label">å·²å®Œæˆ</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="pending-tasks">0</div>
            <div class="stat-label">å¾…å®Œæˆ</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="total-rewards">0</div>
            <div class="stat-label">æ€»å¥–åŠ±å€¼</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
/* å®¹å™¨æ ·å¼ */
.vanity-todo-container {
  min-height: 100vh;
  position: relative;
  overflow: hidden;
  background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
  padding: 20px;
}

/* åŠ¨æ€èƒŒæ™¯ */
.vanity-background {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 1;
}

/* é‡‘é’±é›¨æ•ˆæœ */
.money-rain {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(180deg, 
    transparent 0%, 
    rgba(255, 215, 0, 0.1) 50%, 
    transparent 100%);
  animation: moneyRain 15s linear infinite;
}

@keyframes moneyRain {
  0% { transform: translateY(-100%); }
  100% { transform: translateY(100%); }
}

/* å¥¢ä¾ˆå“å½¢çŠ¶ */
.luxury-shapes {
  position: absolute;
  width: 100%;
  height: 100%;
}

.shape {
  position: absolute;
  font-size: 2rem;
  animation: floatLuxury 8s ease-in-out infinite;
  opacity: 0.6;
}

.car-shape {
  top: 20%;
  left: 10%;
  animation-delay: 0s;
}

.yacht-shape {
  top: 60%;
  right: 15%;
  animation-delay: 2s;
}

.diamond-shape {
  bottom: 30%;
  left: 20%;
  animation-delay: 4s;
}

.mansion-shape {
  top: 40%;
  left: 60%;
  animation-delay: 6s;
}

@keyframes floatLuxury {
  0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.6; }
  50% { transform: translateY(-20px) rotate(10deg); opacity: 0.8; }
}

/* ä¸»è¦å†…å®¹ */
.vanity-content {
  position: relative;
  z-index: 10;
  max-width: 1200px;
  margin: 0 auto;
}

/* æ ‡é¢˜ */
.vanity-header {
  text-align: center;
  margin-bottom: 40px;
}

.vanity-title {
  font-size: 3rem;
  font-weight: 900;
  background: linear-gradient(45deg, #ffd700, #ff6b35, #ff0066);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  text-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
  margin-bottom: 10px;
  font-family: 'JetBrains Mono', monospace;
}

.vanity-subtitle {
  font-size: 1.2rem;
  color: #ffffff;
  opacity: 0.8;
  font-style: italic;
}

/* å¡ç‰‡æ ·å¼ */
.dashboard-card {
  background: rgba(255, 255, 255, 0.1);
  border: 2px solid rgba(255, 215, 0, 0.3);
  border-radius: 15px;
  padding: 25px;
  backdrop-filter: blur(10px);
  margin-bottom: 20px;
  transition: all 0.3s ease;
}

.dashboard-card:hover {
  transform: translateY(-5px);
  border-color: rgba(255, 215, 0, 0.6);
  box-shadow: 0 10px 30px rgba(255, 215, 0, 0.2);
}

.dashboard-card h3 {
  color: #ffd700;
  margin-bottom: 20px;
  font-size: 1.3rem;
  text-align: center;
}

/* è¡¨å•æ ·å¼ */
.form-group {
  margin-bottom: 15px;
}

.form-group label {
  display: block;
  color: #ffffff;
  margin-bottom: 5px;
  font-weight: bold;
}

.form-group input,
.form-group textarea,
.form-group select {
  width: 100%;
  padding: 10px;
  border: 1px solid rgba(255, 215, 0, 0.3);
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.1);
  color: #ffffff;
  font-size: 1rem;
}

.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus {
  outline: none;
  border-color: rgba(255, 215, 0, 0.8);
  box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
}

/* æŒ‰é’®æ ·å¼ */
.btn {
  display: inline-block;
  padding: 12px 24px;
  border: none;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
  text-decoration: none;
}

.btn-primary {
  background: linear-gradient(45deg, #ff0066, #ff6b35);
  color: white;
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(255, 0, 102, 0.3);
}

.btn-success {
  background: linear-gradient(45deg, #00ff88, #00bfff);
  color: white;
}

.btn-danger {
  background: linear-gradient(45deg, #ff0066, #ff3333);
  color: white;
}

/* ä»»åŠ¡åˆ—è¡¨æ ·å¼ */
.task-item {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 215, 0, 0.2);
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 10px;
  transition: all 0.3s ease;
}

.task-item:hover {
  border-color: rgba(255, 215, 0, 0.5);
  transform: translateX(5px);
}

.task-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.task-title {
  font-size: 1.1rem;
  font-weight: bold;
  color: #ffd700;
}

.task-difficulty {
  background: linear-gradient(45deg, #ff0066, #ff6b35);
  color: white;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.8rem;
  font-weight: bold;
}

.task-description {
  color: #ffffff;
  opacity: 0.8;
  margin-bottom: 10px;
}

.task-actions {
  display: flex;
  gap: 10px;
}

.task-actions .btn {
  padding: 6px 12px;
  font-size: 0.9rem;
}

/* ç»Ÿè®¡æ ·å¼ */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 20px;
}

.stat-item {
  text-align: center;
  padding: 20px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 10px;
  border: 1px solid rgba(255, 215, 0, 0.2);
}

.stat-number {
  font-size: 2rem;
  font-weight: bold;
  color: #ffd700;
  margin-bottom: 5px;
}

.stat-label {
  color: #ffffff;
  opacity: 0.8;
  font-size: 0.9rem;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .vanity-title {
    font-size: 2rem;
  }
  
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .task-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
  }
  
  .task-actions {
    flex-wrap: wrap;
  }
}

@media (max-width: 480px) {
  .vanity-title {
    font-size: 1.5rem;
  }
  
  .stats-grid {
    grid-template-columns: 1fr;
  }
  
  .dashboard-card {
    padding: 15px;
  }
}
</style>

<script>
// é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
document.addEventListener('DOMContentLoaded', function() {
  loadTasks();
  loadStats();
});

// åŠ è½½ä»»åŠ¡åˆ—è¡¨
function loadTasks() {
  fetch('/tools/api/vanity_tasks/')
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        displayTasks(data.tasks);
      } else {
        document.getElementById('tasks-list').innerHTML = '<p style="color: #ff0066;">åŠ è½½ä»»åŠ¡å¤±è´¥</p>';
      }
    })
    .catch(error => {
      console.error('åŠ è½½ä»»åŠ¡å¤±è´¥:', error);
      document.getElementById('tasks-list').innerHTML = '<p style="color: #ff0066;">åŠ è½½ä»»åŠ¡å¤±è´¥</p>';
    });
}

// æ˜¾ç¤ºä»»åŠ¡åˆ—è¡¨
function displayTasks(tasks) {
  const tasksList = document.getElementById('tasks-list');
  
  if (tasks.length === 0) {
    tasksList.innerHTML = '<p style="text-align: center; color: #ffffff; opacity: 0.8;">æš‚æ— ä»»åŠ¡ï¼Œæ·»åŠ ç¬¬ä¸€ä¸ªæ¬²æœ›ä»»åŠ¡å§ï¼</p>';
    return;
  }
  
  let html = '';
  tasks.forEach(task => {
    html += `
      <div class="task-item">
        <div class="task-header">
          <div class="task-title">${task.title}</div>
          <div class="task-difficulty">éš¾åº¦ ${task.difficulty}</div>
        </div>
        <div class="task-description">${task.description || 'æ— æè¿°'}</div>
        <div class="task-actions">
          <button class="btn btn-success" onclick="completeTask(${task.id})">å®Œæˆ</button>
          <button class="btn btn-danger" onclick="deleteTask(${task.id})">åˆ é™¤</button>
        </div>
      </div>
    `;
  });
  
  tasksList.innerHTML = html;
}

// åŠ è½½ç»Ÿè®¡æ•°æ®
function loadStats() {
  fetch('/tools/api/vanity_tasks/stats/')
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        document.getElementById('total-tasks').textContent = data.total_tasks;
        document.getElementById('completed-tasks').textContent = data.completed_tasks;
        document.getElementById('pending-tasks').textContent = data.pending_tasks;
        document.getElementById('total-rewards').textContent = data.total_rewards;
      }
    })
    .catch(error => {
      console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', error);
    });
}

// æ·»åŠ æ–°ä»»åŠ¡
document.getElementById('add-task-form').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  const taskData = {
    title: formData.get('title'),
    description: formData.get('description'),
    task_type: formData.get('task_type'),
    difficulty: parseInt(formData.get('difficulty'))
  };
  
  fetch('/tools/api/vanity_tasks/add/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify(taskData)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      this.reset();
      loadTasks();
      loadStats();
      alert('ä»»åŠ¡æ·»åŠ æˆåŠŸï¼');
    } else {
      alert('æ·»åŠ å¤±è´¥: ' + data.error);
    }
  })
  .catch(error => {
    console.error('æ·»åŠ ä»»åŠ¡å¤±è´¥:', error);
    alert('æ·»åŠ ä»»åŠ¡å¤±è´¥');
  });
});

// å®Œæˆä»»åŠ¡
function completeTask(taskId) {
  fetch('/tools/api/vanity_tasks/complete/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify({task_id: taskId})
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      loadTasks();
      loadStats();
      alert('ä»»åŠ¡å®Œæˆï¼è·å¾—å¥–åŠ±: ' + data.reward_description);
    } else {
      alert('æ“ä½œå¤±è´¥: ' + data.error);
    }
  })
  .catch(error => {
    console.error('å®Œæˆä»»åŠ¡å¤±è´¥:', error);
    alert('å®Œæˆä»»åŠ¡å¤±è´¥');
  });
}

// åˆ é™¤ä»»åŠ¡
function deleteTask(taskId) {
  if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) {
    return;
  }
  
  fetch('/tools/api/vanity_tasks/delete/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify({task_id: taskId})
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      loadTasks();
      loadStats();
      alert('ä»»åŠ¡åˆ é™¤æˆåŠŸï¼');
    } else {
      alert('åˆ é™¤å¤±è´¥: ' + data.error);
    }
  })
  .catch(error => {
    console.error('åˆ é™¤ä»»åŠ¡å¤±è´¥:', error);
    alert('åˆ é™¤ä»»åŠ¡å¤±è´¥');
  });
}

// è·å–CSRF Token
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
</script>

{% endblock %}
