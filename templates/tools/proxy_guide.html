{% extends 'base.html' %}
{% load static %}

{% block title %}ä»£ç†ä½¿ç”¨æŒ‡å— - QAToolBox{% endblock %}

{% block extra_css %}
<style>
    .proxy-guide-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .guide-section {
        background: #fff;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .guide-section h2 {
        color: #333;
        border-bottom: 2px solid #007bff;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }
    
    .proxy-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }
    
    .proxy-item {
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 15px;
        background: #f8f9fa;
    }
    
    .proxy-item h4 {
        margin: 0 0 10px 0;
        color: #007bff;
    }
    
    .proxy-details {
        font-size: 14px;
        color: #666;
    }
    
    .proxy-details strong {
        color: #333;
    }
    
    .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
    }
    
    .status-unknown { background-color: #6c757d; }
    .status-connected { background-color: #28a745; }
    .status-failed { background-color: #dc3545; }
    .status-timeout { background-color: #ffc107; }
    
    .test-button {
        background: #007bff;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 10px;
    }
    
    .test-button:hover {
        background: #0056b3;
    }
    
    .test-button:disabled {
        background: #6c757d;
        cursor: not-allowed;
    }
    
    .connection-results {
        margin-top: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 6px;
        border-left: 4px solid #007bff;
    }
    
    .result-item {
        padding: 8px 0;
        border-bottom: 1px solid #eee;
    }
    
    .result-item:last-child {
        border-bottom: none;
    }
    
    .warning-box {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 6px;
        padding: 15px;
        margin: 20px 0;
        color: #856404;
    }
    
    .info-box {
        background: #d1ecf1;
        border: 1px solid #bee5eb;
        border-radius: 6px;
        padding: 15px;
        margin: 20px 0;
        color: #0c5460;
    }
    
    .clash-config {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 15px;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        overflow-x: auto;
        margin: 15px 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="proxy-guide-container">
    <div class="guide-section">
        <h2>ğŸ”— ä»£ç†æœåŠ¡å™¨çŠ¶æ€</h2>
        
        <div class="warning-box">
            <strong>âš ï¸ é‡è¦æç¤ºï¼š</strong> æ‚¨çš„ä»£ç†æœåŠ¡å™¨ä½¿ç”¨Trojanåè®®ï¼Œéœ€è¦é€šè¿‡ä¸“é—¨çš„å®¢æˆ·ç«¯ï¼ˆå¦‚Clashã€V2Rayç­‰ï¼‰æ‰èƒ½æ­£å¸¸ä½¿ç”¨ã€‚ç›´æ¥é€šè¿‡HTTPä»£ç†æ–¹å¼è¿æ¥ä¼šå¤±è´¥ã€‚
        </div>
        
        <div class="info-box">
            <strong>ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼š</strong> 
            <ul>
                <li>ä½¿ç”¨Clashã€V2Rayç­‰ä»£ç†å®¢æˆ·ç«¯</li>
                <li>é…ç½®ä»£ç†æœåŠ¡å™¨ä¿¡æ¯</li>
                <li>å¯åŠ¨ä»£ç†æœåŠ¡åå³å¯æ­£å¸¸è®¿é—®å¤–ç½‘</li>
            </ul>
        </div>
        
        <button class="test-button" onclick="testConnections()" id="testBtn">
            æµ‹è¯•TCPè¿æ¥
        </button>
        
        <div id="connectionResults" class="connection-results" style="display: none;">
            <h4>è¿æ¥æµ‹è¯•ç»“æœï¼š</h4>
            <div id="resultsContent"></div>
        </div>
    </div>
    
    <div class="guide-section">
        <h2>ğŸ“‹ ä»£ç†æœåŠ¡å™¨åˆ—è¡¨</h2>
        <div class="proxy-list">
            {% for proxy in proxy_servers %}
            <div class="proxy-item">
                <h4>{{ proxy.name }}</h4>
                <div class="proxy-details">
                    <p><strong>ç±»å‹ï¼š</strong>{{ proxy.type|upper }}</p>
                    <p><strong>æœåŠ¡å™¨ï¼š</strong>{{ proxy.server }}</p>
                    <p><strong>ç«¯å£ï¼š</strong>{{ proxy.port }}</p>
                    <p><strong>å›½å®¶ï¼š</strong>{{ proxy.country }}</p>
                    <p><strong>ç±»åˆ«ï¼š</strong>{{ proxy.category }}</p>
                    <p><strong>çŠ¶æ€ï¼š</strong><span class="status-indicator status-unknown"></span>æœªæµ‹è¯•</p>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <div class="guide-section">
        <h2>âš™ï¸ Clashé…ç½®ç¤ºä¾‹</h2>
        <p>å°†ä»¥ä¸‹é…ç½®æ·»åŠ åˆ°æ‚¨çš„Clashé…ç½®æ–‡ä»¶ä¸­ï¼š</p>
        
        <div class="clash-config">
proxies:
{% for proxy in trojan_proxies %}
  - name: {{ proxy.name }}
    type: trojan
    server: {{ proxy.server }}
    port: {{ proxy.port }}
    password: {{ proxy.password }}
    udp: true
    sni: {{ proxy.server }}
{% endfor %}

proxy-groups:
  - name: Proxy
    type: select
    proxies:
{% for proxy in trojan_proxies %}
      - {{ proxy.name }}
{% endfor %}
        </div>
    </div>
    
    <div class="guide-section">
        <h2>ğŸ“± å®¢æˆ·ç«¯æ¨è</h2>
        <div class="proxy-list">
            <div class="proxy-item">
                <h4>Windows</h4>
                <ul>
                    <li>Clash for Windows</li>
                    <li>V2RayN</li>
                    <li>Proxifier</li>
                </ul>
            </div>
            <div class="proxy-item">
                <h4>macOS</h4>
                <ul>
                    <li>ClashX</li>
                    <li>V2RayX</li>
                    <li>ShadowsocksX-NG</li>
                </ul>
            </div>
            <div class="proxy-item">
                <h4>Linux</h4>
                <ul>
                    <li>Clash for Linux</li>
                    <li>V2Ray</li>
                    <li>Shadowsocks</li>
                </ul>
            </div>
            <div class="proxy-item">
                <h4>ç§»åŠ¨ç«¯</h4>
                <ul>
                    <li>iOS: Shadowrocket</li>
                    <li>Android: V2RayNG</li>
                    <li>Android: Clash for Android</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function testConnections() {
    const testBtn = document.getElementById('testBtn');
    const resultsDiv = document.getElementById('connectionResults');
    const resultsContent = document.getElementById('resultsContent');
    
    testBtn.disabled = true;
    testBtn.textContent = 'æµ‹è¯•ä¸­...';
    resultsDiv.style.display = 'none';
    
    fetch('/tools/api/proxy/connection-test/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayResults(data.data);
            } else {
                resultsContent.innerHTML = `<p style="color: red;">âŒ æµ‹è¯•å¤±è´¥: ${data.error}</p>`;
            }
            resultsDiv.style.display = 'block';
        })
        .catch(error => {
            resultsContent.innerHTML = `<p style="color: red;">âŒ ç½‘ç»œé”™è¯¯: ${error.message}</p>`;
            resultsDiv.style.display = 'block';
        })
        .finally(() => {
            testBtn.disabled = false;
            testBtn.textContent = 'æµ‹è¯•TCPè¿æ¥';
        });
}

function displayResults(data) {
    const resultsContent = document.getElementById('resultsContent');
    const stats = data.statistics;
    
    let html = `
        <div style="margin-bottom: 15px; padding: 10px; background: #e9ecef; border-radius: 4px;">
            <strong>ç»Ÿè®¡ä¿¡æ¯ï¼š</strong> æ€»è®¡ ${stats.total_proxies} ä¸ªä»£ç†ï¼Œ${stats.connected_proxies} ä¸ªå¯è¿æ¥ (${stats.connection_rate}%)
        </div>
    `;
    
    data.proxy_results.forEach(result => {
        const statusClass = result.success ? 'status-connected' : 
                           result.status === 'timeout' ? 'status-timeout' : 'status-failed';
        const statusText = result.success ? 'âœ… è¿æ¥æˆåŠŸ' : 
                          result.status === 'timeout' ? 'â° è¿æ¥è¶…æ—¶' : 'âŒ è¿æ¥å¤±è´¥';
        
        html += `
            <div class="result-item">
                <span class="status-indicator ${statusClass}"></span>
                <strong>${result.proxy}</strong>: ${statusText}
                ${result.success ? `<br>å“åº”æ—¶é—´: ${result.response_time}s` : ''}
                ${result.error ? `<br>é”™è¯¯: ${result.error}` : ''}
            </div>
        `;
    });
    
    resultsContent.innerHTML = html;
}

// é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•
document.addEventListener('DOMContentLoaded', function() {
    // å»¶è¿Ÿ2ç§’åè‡ªåŠ¨æµ‹è¯•
    setTimeout(testConnections, 2000);
});
</script>
{% endblock %}
