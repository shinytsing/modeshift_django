{% extends 'base.html' %}
{% load static %}

{% block title %}代理使用指南 - QAToolBox{% endblock %}

{% block extra_css %}
<style>
    .proxy-guide-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .guide-section {
        background: #fff;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .guide-section h2 {
        color: #333;
        border-bottom: 2px solid #007bff;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }
    
    .proxy-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }
    
    .proxy-item {
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 15px;
        background: #f8f9fa;
    }
    
    .proxy-item h4 {
        margin: 0 0 10px 0;
        color: #007bff;
    }
    
    .proxy-details {
        font-size: 14px;
        color: #666;
    }
    
    .proxy-details strong {
        color: #333;
    }
    
    .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
    }
    
    .status-unknown { background-color: #6c757d; }
    .status-connected { background-color: #28a745; }
    .status-failed { background-color: #dc3545; }
    .status-timeout { background-color: #ffc107; }
    
    .test-button {
        background: #007bff;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 10px;
    }
    
    .test-button:hover {
        background: #0056b3;
    }
    
    .test-button:disabled {
        background: #6c757d;
        cursor: not-allowed;
    }
    
    .connection-results {
        margin-top: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 6px;
        border-left: 4px solid #007bff;
    }
    
    .result-item {
        padding: 8px 0;
        border-bottom: 1px solid #eee;
    }
    
    .result-item:last-child {
        border-bottom: none;
    }
    
    .warning-box {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 6px;
        padding: 15px;
        margin: 20px 0;
        color: #856404;
    }
    
    .info-box {
        background: #d1ecf1;
        border: 1px solid #bee5eb;
        border-radius: 6px;
        padding: 15px;
        margin: 20px 0;
        color: #0c5460;
    }
    
    .clash-config {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 15px;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        overflow-x: auto;
        margin: 15px 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="proxy-guide-container">
    <div class="guide-section">
        <h2>🔗 代理服务器状态</h2>
        
        <div class="warning-box">
            <strong>⚠️ 重要提示：</strong> 您的代理服务器使用Trojan协议，需要通过专门的客户端（如Clash、V2Ray等）才能正常使用。直接通过HTTP代理方式连接会失败。
        </div>
        
        <div class="info-box">
            <strong>💡 解决方案：</strong> 
            <ul>
                <li>使用Clash、V2Ray等代理客户端</li>
                <li>配置代理服务器信息</li>
                <li>启动代理服务后即可正常访问外网</li>
            </ul>
        </div>
        
        <button class="test-button" onclick="testConnections()" id="testBtn">
            测试TCP连接
        </button>
        
        <div id="connectionResults" class="connection-results" style="display: none;">
            <h4>连接测试结果：</h4>
            <div id="resultsContent"></div>
        </div>
    </div>
    
    <div class="guide-section">
        <h2>📋 代理服务器列表</h2>
        <div class="proxy-list">
            {% for proxy in proxy_servers %}
            <div class="proxy-item">
                <h4>{{ proxy.name }}</h4>
                <div class="proxy-details">
                    <p><strong>类型：</strong>{{ proxy.type|upper }}</p>
                    <p><strong>服务器：</strong>{{ proxy.server }}</p>
                    <p><strong>端口：</strong>{{ proxy.port }}</p>
                    <p><strong>国家：</strong>{{ proxy.country }}</p>
                    <p><strong>类别：</strong>{{ proxy.category }}</p>
                    <p><strong>状态：</strong><span class="status-indicator status-unknown"></span>未测试</p>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <div class="guide-section">
        <h2>⚙️ Clash配置示例</h2>
        <p>将以下配置添加到您的Clash配置文件中：</p>
        
        <div class="clash-config">
proxies:
{% for proxy in trojan_proxies %}
  - name: {{ proxy.name }}
    type: trojan
    server: {{ proxy.server }}
    port: {{ proxy.port }}
    password: {{ proxy.password }}
    udp: true
    sni: {{ proxy.server }}
{% endfor %}

proxy-groups:
  - name: Proxy
    type: select
    proxies:
{% for proxy in trojan_proxies %}
      - {{ proxy.name }}
{% endfor %}
        </div>
    </div>
    
    <div class="guide-section">
        <h2>📱 客户端推荐</h2>
        <div class="proxy-list">
            <div class="proxy-item">
                <h4>Windows</h4>
                <ul>
                    <li>Clash for Windows</li>
                    <li>V2RayN</li>
                    <li>Proxifier</li>
                </ul>
            </div>
            <div class="proxy-item">
                <h4>macOS</h4>
                <ul>
                    <li>ClashX</li>
                    <li>V2RayX</li>
                    <li>ShadowsocksX-NG</li>
                </ul>
            </div>
            <div class="proxy-item">
                <h4>Linux</h4>
                <ul>
                    <li>Clash for Linux</li>
                    <li>V2Ray</li>
                    <li>Shadowsocks</li>
                </ul>
            </div>
            <div class="proxy-item">
                <h4>移动端</h4>
                <ul>
                    <li>iOS: Shadowrocket</li>
                    <li>Android: V2RayNG</li>
                    <li>Android: Clash for Android</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function testConnections() {
    const testBtn = document.getElementById('testBtn');
    const resultsDiv = document.getElementById('connectionResults');
    const resultsContent = document.getElementById('resultsContent');
    
    testBtn.disabled = true;
    testBtn.textContent = '测试中...';
    resultsDiv.style.display = 'none';
    
    fetch('/tools/api/proxy/connection-test/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayResults(data.data);
            } else {
                resultsContent.innerHTML = `<p style="color: red;">❌ 测试失败: ${data.error}</p>`;
            }
            resultsDiv.style.display = 'block';
        })
        .catch(error => {
            resultsContent.innerHTML = `<p style="color: red;">❌ 网络错误: ${error.message}</p>`;
            resultsDiv.style.display = 'block';
        })
        .finally(() => {
            testBtn.disabled = false;
            testBtn.textContent = '测试TCP连接';
        });
}

function displayResults(data) {
    const resultsContent = document.getElementById('resultsContent');
    const stats = data.statistics;
    
    let html = `
        <div style="margin-bottom: 15px; padding: 10px; background: #e9ecef; border-radius: 4px;">
            <strong>统计信息：</strong> 总计 ${stats.total_proxies} 个代理，${stats.connected_proxies} 个可连接 (${stats.connection_rate}%)
        </div>
    `;
    
    data.proxy_results.forEach(result => {
        const statusClass = result.success ? 'status-connected' : 
                           result.status === 'timeout' ? 'status-timeout' : 'status-failed';
        const statusText = result.success ? '✅ 连接成功' : 
                          result.status === 'timeout' ? '⏰ 连接超时' : '❌ 连接失败';
        
        html += `
            <div class="result-item">
                <span class="status-indicator ${statusClass}"></span>
                <strong>${result.proxy}</strong>: ${statusText}
                ${result.success ? `<br>响应时间: ${result.response_time}s` : ''}
                ${result.error ? `<br>错误: ${result.error}` : ''}
            </div>
        `;
    });
    
    resultsContent.innerHTML = html;
}

// 页面加载时自动测试
document.addEventListener('DOMContentLoaded', function() {
    // 延迟2秒后自动测试
    setTimeout(testConnections, 2000);
});
</script>
{% endblock %}
