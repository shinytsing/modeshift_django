{% extends 'base.html' %}
{% load static %}

{% block title %}心动链接测试{% endblock %}

{% block extra_css %}
<style>
    .test-container {
        max-width: 800px;
        margin: 20px auto;
        padding: 20px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .status-panel {
        padding: 15px;
        margin: 10px 0;
        border-radius: 5px;
        font-weight: bold;
    }
    
    .status-connected {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .status-disconnected {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .status-connecting {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }
    
    .message-log {
        height: 300px;
        border: 1px solid #ddd;
        padding: 10px;
        overflow-y: auto;
        background: #f8f9fa;
        margin: 10px 0;
        font-family: monospace;
        font-size: 12px;
    }
    
    .controls {
        display: flex;
        gap: 10px;
        margin: 10px 0;
        flex-wrap: wrap;
    }
    
    .controls button {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    
    .btn-primary {
        background: #007bff;
        color: white;
    }
    
    .btn-success {
        background: #28a745;
        color: white;
    }
    
    .btn-danger {
        background: #dc3545;
        color: white;
    }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    
    .test-input {
        flex: 1;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    
    .user-info {
        background: #e9ecef;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="test-container">
    <h1>心动链接WebSocket测试</h1>
    
    <div class="user-info">
        <strong>当前用户:</strong> {{ user.username }} (ID: {{ user.id }})<br>
        <strong>测试房间:</strong> {{ room_id }}<br>
        <strong>WebSocket URL:</strong> ws://localhost:8000/ws/chat/{{ room_id }}/
    </div>
    
    <div id="status" class="status-panel status-disconnected">
        🔴 WebSocket未连接
    </div>
    
    <div class="controls">
        <button id="connectBtn" class="btn-primary" onclick="connectWebSocket()">连接</button>
        <button id="disconnectBtn" class="btn-danger" onclick="disconnectWebSocket()">断开</button>
        <button class="btn-secondary" onclick="clearLog()">清空日志</button>
        <input type="text" id="testMessage" class="test-input" placeholder="输入测试消息..." onkeypress="handleKeyPress(event)">
        <button class="btn-success" onclick="sendTestMessage()">发送</button>
    </div>
    
    <div id="messageLog" class="message-log"></div>
    
    <div class="controls">
        <button class="btn-secondary" onclick="testHeartbeat()">测试心跳</button>
        <button class="btn-secondary" onclick="testTyping()">测试打字状态</button>
        <button class="btn-secondary" onclick="testReadStatus()">测试已读状态</button>
    </div>
</div>

<script>
let socket = null;
let reconnectAttempts = 0;
const maxReconnectAttempts = 3;
const roomId = '{{ room_id }}';

function addLog(message, type = 'info') {
    const log = document.getElementById('messageLog');
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = document.createElement('div');
    
    let color = '#333';
    if (type === 'error') color = '#dc3545';
    else if (type === 'success') color = '#28a745';
    else if (type === 'warning') color = '#ffc107';
    
    logEntry.style.color = color;
    logEntry.innerHTML = `[${timestamp}] ${message}`;
    log.appendChild(logEntry);
    log.scrollTop = log.scrollHeight;
}

function updateStatus(status, message) {
    const statusDiv = document.getElementById('status');
    statusDiv.className = `status-panel status-${status}`;
    
    let emoji = '🔴';
    if (status === 'connected') emoji = '🟢';
    else if (status === 'connecting') emoji = '🟡';
    
    statusDiv.textContent = `${emoji} ${message}`;
}

function connectWebSocket() {
    if (socket && socket.readyState === WebSocket.OPEN) {
        addLog('WebSocket已经连接', 'warning');
        return;
    }
    
    const wsUrl = `ws://localhost:8000/ws/chat/${roomId}/`;
    addLog(`尝试连接: ${wsUrl}`);
    updateStatus('connecting', 'WebSocket连接中...');
    
    try {
        socket = new WebSocket(wsUrl);
        
        socket.onopen = function(event) {
            addLog('✅ WebSocket连接成功', 'success');
            updateStatus('connected', 'WebSocket已连接');
            reconnectAttempts = 0;
            
            document.getElementById('connectBtn').disabled = true;
            document.getElementById('disconnectBtn').disabled = false;
        };
        
        socket.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                addLog(`📨 收到消息 [${data.type}]: ${JSON.stringify(data, null, 2)}`, 'success');
            } catch (e) {
                addLog(`📨 收到原始消息: ${event.data}`, 'success');
            }
        };
        
        socket.onclose = function(event) {
            addLog(`❌ WebSocket连接关闭 (代码: ${event.code}, 原因: ${event.reason || '无原因'})`, 'error');
            updateStatus('disconnected', 'WebSocket未连接');
            
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('disconnectBtn').disabled = true;
            
            // 自动重连
            if (event.code !== 1000 && reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                addLog(`🔄 ${3}秒后尝试第${reconnectAttempts}次重连...`, 'warning');
                setTimeout(connectWebSocket, 3000);
            }
        };
        
        socket.onerror = function(error) {
            addLog(`❌ WebSocket错误: ${error}`, 'error');
            updateStatus('disconnected', 'WebSocket连接错误');
        };
        
    } catch (error) {
        addLog(`❌ 创建WebSocket失败: ${error}`, 'error');
        updateStatus('disconnected', 'WebSocket创建失败');
    }
}

function disconnectWebSocket() {
    if (socket) {
        socket.close(1000, 'User requested disconnect');
        socket = null;
    }
}

function sendTestMessage() {
    const input = document.getElementById('testMessage');
    const message = input.value.trim();
    
    if (!message) {
        addLog('❌ 请输入测试消息', 'error');
        return;
    }
    
    if (!socket || socket.readyState !== WebSocket.OPEN) {
        addLog('❌ WebSocket未连接，无法发送消息', 'error');
        return;
    }
    
    const messageData = {
        type: 'message',
        content: message,
        message_type: 'text'
    };
    
    try {
        socket.send(JSON.stringify(messageData));
        addLog(`📤 发送消息: ${message}`, 'success');
        input.value = '';
    } catch (error) {
        addLog(`❌ 发送消息失败: ${error}`, 'error');
    }
}

function testHeartbeat() {
    if (!socket || socket.readyState !== WebSocket.OPEN) {
        addLog('❌ WebSocket未连接', 'error');
        return;
    }
    
    const heartbeat = {
        type: 'heartbeat_ack',
        timestamp: Date.now()
    };
    
    socket.send(JSON.stringify(heartbeat));
    addLog('💓 发送心跳包', 'success');
}

function testTyping() {
    if (!socket || socket.readyState !== WebSocket.OPEN) {
        addLog('❌ WebSocket未连接', 'error');
        return;
    }
    
    const typing = {
        type: 'typing',
        is_typing: true
    };
    
    socket.send(JSON.stringify(typing));
    addLog('⌨️ 发送打字状态', 'success');
    
    // 2秒后停止打字
    setTimeout(() => {
        if (socket && socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({type: 'typing', is_typing: false}));
            addLog('⌨️ 停止打字状态', 'success');
        }
    }, 2000);
}

function testReadStatus() {
    if (!socket || socket.readyState !== WebSocket.OPEN) {
        addLog('❌ WebSocket未连接', 'error');
        return;
    }
    
    const readStatus = {
        type: 'read_status',
        message_ids: [1, 2, 3]
    };
    
    socket.send(JSON.stringify(readStatus));
    addLog('👁️ 发送已读状态', 'success');
}

function clearLog() {
    document.getElementById('messageLog').innerHTML = '';
}

function handleKeyPress(event) {
    if (event.key === 'Enter') {
        sendTestMessage();
    }
}

// 页面加载时自动连接
window.onload = function() {
    addLog('🚀 页面加载完成，准备测试WebSocket');
    document.getElementById('disconnectBtn').disabled = true;
    
    // 延迟1秒自动连接
    setTimeout(connectWebSocket, 1000);
};

// 页面卸载时断开连接
window.onbeforeunload = function() {
    if (socket) {
        socket.close();
    }
};
</script>
{% endblock %}
