{% extends 'base.html' %}
{% load static %}

{% block title %}å¿ƒåŠ¨é“¾æ¥æµ‹è¯•{% endblock %}

{% block extra_css %}
<style>
    .test-container {
        max-width: 800px;
        margin: 20px auto;
        padding: 20px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .status-panel {
        padding: 15px;
        margin: 10px 0;
        border-radius: 5px;
        font-weight: bold;
    }
    
    .status-connected {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .status-disconnected {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .status-connecting {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }
    
    .message-log {
        height: 300px;
        border: 1px solid #ddd;
        padding: 10px;
        overflow-y: auto;
        background: #f8f9fa;
        margin: 10px 0;
        font-family: monospace;
        font-size: 12px;
    }
    
    .controls {
        display: flex;
        gap: 10px;
        margin: 10px 0;
        flex-wrap: wrap;
    }
    
    .controls button {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    
    .btn-primary {
        background: #007bff;
        color: white;
    }
    
    .btn-success {
        background: #28a745;
        color: white;
    }
    
    .btn-danger {
        background: #dc3545;
        color: white;
    }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    
    .test-input {
        flex: 1;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    
    .user-info {
        background: #e9ecef;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="test-container">
    <h1>å¿ƒåŠ¨é“¾æ¥WebSocketæµ‹è¯•</h1>
    
    <div class="user-info">
        <strong>å½“å‰ç”¨æˆ·:</strong> {{ user.username }} (ID: {{ user.id }})<br>
        <strong>æµ‹è¯•æˆ¿é—´:</strong> {{ room_id }}<br>
        <strong>WebSocket URL:</strong> ws://localhost:8000/ws/chat/{{ room_id }}/
    </div>
    
    <div id="status" class="status-panel status-disconnected">
        ğŸ”´ WebSocketæœªè¿æ¥
    </div>
    
    <div class="controls">
        <button id="connectBtn" class="btn-primary" onclick="connectWebSocket()">è¿æ¥</button>
        <button id="disconnectBtn" class="btn-danger" onclick="disconnectWebSocket()">æ–­å¼€</button>
        <button class="btn-secondary" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        <input type="text" id="testMessage" class="test-input" placeholder="è¾“å…¥æµ‹è¯•æ¶ˆæ¯..." onkeypress="handleKeyPress(event)">
        <button class="btn-success" onclick="sendTestMessage()">å‘é€</button>
    </div>
    
    <div id="messageLog" class="message-log"></div>
    
    <div class="controls">
        <button class="btn-secondary" onclick="testHeartbeat()">æµ‹è¯•å¿ƒè·³</button>
        <button class="btn-secondary" onclick="testTyping()">æµ‹è¯•æ‰“å­—çŠ¶æ€</button>
        <button class="btn-secondary" onclick="testReadStatus()">æµ‹è¯•å·²è¯»çŠ¶æ€</button>
    </div>
</div>

<script>
let socket = null;
let reconnectAttempts = 0;
const maxReconnectAttempts = 3;
const roomId = '{{ room_id }}';

function addLog(message, type = 'info') {
    const log = document.getElementById('messageLog');
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = document.createElement('div');
    
    let color = '#333';
    if (type === 'error') color = '#dc3545';
    else if (type === 'success') color = '#28a745';
    else if (type === 'warning') color = '#ffc107';
    
    logEntry.style.color = color;
    logEntry.innerHTML = `[${timestamp}] ${message}`;
    log.appendChild(logEntry);
    log.scrollTop = log.scrollHeight;
}

function updateStatus(status, message) {
    const statusDiv = document.getElementById('status');
    statusDiv.className = `status-panel status-${status}`;
    
    let emoji = 'ğŸ”´';
    if (status === 'connected') emoji = 'ğŸŸ¢';
    else if (status === 'connecting') emoji = 'ğŸŸ¡';
    
    statusDiv.textContent = `${emoji} ${message}`;
}

function connectWebSocket() {
    if (socket && socket.readyState === WebSocket.OPEN) {
        addLog('WebSocketå·²ç»è¿æ¥', 'warning');
        return;
    }
    
    const wsUrl = `ws://localhost:8000/ws/chat/${roomId}/`;
    addLog(`å°è¯•è¿æ¥: ${wsUrl}`);
    updateStatus('connecting', 'WebSocketè¿æ¥ä¸­...');
    
    try {
        socket = new WebSocket(wsUrl);
        
        socket.onopen = function(event) {
            addLog('âœ… WebSocketè¿æ¥æˆåŠŸ', 'success');
            updateStatus('connected', 'WebSocketå·²è¿æ¥');
            reconnectAttempts = 0;
            
            document.getElementById('connectBtn').disabled = true;
            document.getElementById('disconnectBtn').disabled = false;
        };
        
        socket.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                addLog(`ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯ [${data.type}]: ${JSON.stringify(data, null, 2)}`, 'success');
            } catch (e) {
                addLog(`ğŸ“¨ æ”¶åˆ°åŸå§‹æ¶ˆæ¯: ${event.data}`, 'success');
            }
        };
        
        socket.onclose = function(event) {
            addLog(`âŒ WebSocketè¿æ¥å…³é—­ (ä»£ç : ${event.code}, åŸå› : ${event.reason || 'æ— åŸå› '})`, 'error');
            updateStatus('disconnected', 'WebSocketæœªè¿æ¥');
            
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('disconnectBtn').disabled = true;
            
            // è‡ªåŠ¨é‡è¿
            if (event.code !== 1000 && reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                addLog(`ğŸ”„ ${3}ç§’åå°è¯•ç¬¬${reconnectAttempts}æ¬¡é‡è¿...`, 'warning');
                setTimeout(connectWebSocket, 3000);
            }
        };
        
        socket.onerror = function(error) {
            addLog(`âŒ WebSocketé”™è¯¯: ${error}`, 'error');
            updateStatus('disconnected', 'WebSocketè¿æ¥é”™è¯¯');
        };
        
    } catch (error) {
        addLog(`âŒ åˆ›å»ºWebSocketå¤±è´¥: ${error}`, 'error');
        updateStatus('disconnected', 'WebSocketåˆ›å»ºå¤±è´¥');
    }
}

function disconnectWebSocket() {
    if (socket) {
        socket.close(1000, 'User requested disconnect');
        socket = null;
    }
}

function sendTestMessage() {
    const input = document.getElementById('testMessage');
    const message = input.value.trim();
    
    if (!message) {
        addLog('âŒ è¯·è¾“å…¥æµ‹è¯•æ¶ˆæ¯', 'error');
        return;
    }
    
    if (!socket || socket.readyState !== WebSocket.OPEN) {
        addLog('âŒ WebSocketæœªè¿æ¥ï¼Œæ— æ³•å‘é€æ¶ˆæ¯', 'error');
        return;
    }
    
    const messageData = {
        type: 'message',
        content: message,
        message_type: 'text'
    };
    
    try {
        socket.send(JSON.stringify(messageData));
        addLog(`ğŸ“¤ å‘é€æ¶ˆæ¯: ${message}`, 'success');
        input.value = '';
    } catch (error) {
        addLog(`âŒ å‘é€æ¶ˆæ¯å¤±è´¥: ${error}`, 'error');
    }
}

function testHeartbeat() {
    if (!socket || socket.readyState !== WebSocket.OPEN) {
        addLog('âŒ WebSocketæœªè¿æ¥', 'error');
        return;
    }
    
    const heartbeat = {
        type: 'heartbeat_ack',
        timestamp: Date.now()
    };
    
    socket.send(JSON.stringify(heartbeat));
    addLog('ğŸ’“ å‘é€å¿ƒè·³åŒ…', 'success');
}

function testTyping() {
    if (!socket || socket.readyState !== WebSocket.OPEN) {
        addLog('âŒ WebSocketæœªè¿æ¥', 'error');
        return;
    }
    
    const typing = {
        type: 'typing',
        is_typing: true
    };
    
    socket.send(JSON.stringify(typing));
    addLog('âŒ¨ï¸ å‘é€æ‰“å­—çŠ¶æ€', 'success');
    
    // 2ç§’ååœæ­¢æ‰“å­—
    setTimeout(() => {
        if (socket && socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({type: 'typing', is_typing: false}));
            addLog('âŒ¨ï¸ åœæ­¢æ‰“å­—çŠ¶æ€', 'success');
        }
    }, 2000);
}

function testReadStatus() {
    if (!socket || socket.readyState !== WebSocket.OPEN) {
        addLog('âŒ WebSocketæœªè¿æ¥', 'error');
        return;
    }
    
    const readStatus = {
        type: 'read_status',
        message_ids: [1, 2, 3]
    };
    
    socket.send(JSON.stringify(readStatus));
    addLog('ğŸ‘ï¸ å‘é€å·²è¯»çŠ¶æ€', 'success');
}

function clearLog() {
    document.getElementById('messageLog').innerHTML = '';
}

function handleKeyPress(event) {
    if (event.key === 'Enter') {
        sendTestMessage();
    }
}

// é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿æ¥
window.onload = function() {
    addLog('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡æµ‹è¯•WebSocket');
    document.getElementById('disconnectBtn').disabled = true;
    
    // å»¶è¿Ÿ1ç§’è‡ªåŠ¨è¿æ¥
    setTimeout(connectWebSocket, 1000);
};

// é¡µé¢å¸è½½æ—¶æ–­å¼€è¿æ¥
window.onbeforeunload = function() {
    if (socket) {
        socket.close();
    }
};
</script>
{% endblock %}
