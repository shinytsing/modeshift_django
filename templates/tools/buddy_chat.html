{% extends 'base.html' %}
{% load static %}

{% block title %}{{ event.title }} - ç¾¤èŠ{% endblock %}

{% block extra_css %}
<style>
/* ç°ä»£åŒ–æ­å­ç¾¤èŠé¡µé¢æ ·å¼ */
.buddy-chat-container {
    display: flex;
    height: 100vh;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #f5576c 75%, #4facfe 100%);
    position: relative;
    overflow: hidden;
}

/* åŠ¨æ€èƒŒæ™¯æ•ˆæœ */
.buddy-chat-container::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: 
        radial-gradient(circle at 20% 80%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
    z-index: -1;
    animation: chatPulse 15s ease-in-out infinite;
}

@keyframes chatPulse {
    0%, 100% { 
        transform: scale(1) rotate(0deg);
        opacity: 0.8;
    }
    50% { 
        transform: scale(1.02) rotate(1deg);
        opacity: 1;
    }
}

/* ä¾§è¾¹æ  */
.chat-sidebar {
    width: 300px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-right: 1px solid rgba(255, 255, 255, 0.3);
    display: flex;
    flex-direction: column;
    position: relative;
    z-index: 1;
}

/* æ´»åŠ¨ä¿¡æ¯å¤´éƒ¨ */
.event-header {
    padding: 20px;
    border-bottom: 1px solid #e9ecef;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.event-title {
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 8px;
    line-height: 1.3;
}

.event-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    font-size: 0.85rem;
    opacity: 0.9;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: 4px;
}

/* è¿”å›æŒ‰é’® */
.back-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: none;
    border-radius: 20px;
    padding: 8px 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    gap: 4px;
}

.back-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-1px);
}

/* æˆå‘˜åˆ—è¡¨ */
.members-section {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
}

.members-title {
    font-size: 1rem;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.members-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.member-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 12px;
    transition: all 0.3s ease;
}

.member-item:hover {
    background: #e9ecef;
    transform: translateY(-1px);
}

.member-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 1.1rem;
}

.member-info {
    flex: 1;
}

.member-name {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 2px;
}

.member-role {
    font-size: 0.8rem;
    color: #6c757d;
    padding: 2px 8px;
    background: #e9ecef;
    border-radius: 10px;
    display: inline-block;
}

.member-role.creator {
    background: #d4edda;
    color: #155724;
}

.member-status {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #28a745;
    margin-left: auto;
}

.member-status.offline {
    background: #6c757d;
}

/* ä¸»èŠå¤©åŒºåŸŸ */
.chat-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    position: relative;
    z-index: 1;
}

/* èŠå¤©å¤´éƒ¨ */
.chat-header {
    padding: 15px 20px;
    border-bottom: 1px solid #e9ecef;
    background: #f8f9fa;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.chat-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #2c3e50;
    display: flex;
    align-items: center;
    gap: 8px;
}

.online-count {
    font-size: 0.85rem;
    color: #28a745;
    background: #d4edda;
    padding: 4px 8px;
    border-radius: 10px;
}

/* èŠå¤©æ¶ˆæ¯åŒºåŸŸ */
.chat-messages {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.message {
    display: flex;
    gap: 12px;
    max-width: 70%;
    animation: messageSlideIn 0.3s ease-out;
}

@keyframes messageSlideIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.message.own {
    align-self: flex-end;
    flex-direction: row-reverse;
}

.message-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 0.9rem;
    flex-shrink: 0;
}

.message-content {
    flex: 1;
}

.message-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
}

.message-sender {
    font-weight: 600;
    color: #2c3e50;
    font-size: 0.9rem;
}

.message-time {
    font-size: 0.75rem;
    color: #6c757d;
}

.message-bubble {
    background: #f8f9fa;
    padding: 12px 16px;
    border-radius: 18px;
    border-top-left-radius: 4px;
    word-wrap: break-word;
    line-height: 1.4;
}

.message.own .message-bubble {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-top-left-radius: 18px;
    border-top-right-radius: 4px;
}

.message.own .message-header {
    flex-direction: row-reverse;
}

/* è¾“å…¥åŒºåŸŸ */
.chat-input {
    padding: 20px;
    border-top: 1px solid #e9ecef;
    background: #f8f9fa;
}

.input-container {
    display: flex;
    gap: 12px;
    align-items: flex-end;
}

.message-input {
    flex: 1;
    border: 2px solid #e1e5e9;
    border-radius: 20px;
    padding: 12px 16px;
    font-size: 1rem;
    resize: none;
    min-height: 44px;
    max-height: 120px;
    background: white;
    transition: all 0.3s ease;
}

.message-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.send-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 50%;
    width: 44px;
    height: 44px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
}

.send-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.send-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

/* ç©ºçŠ¶æ€ */
.empty-messages {
    text-align: center;
    color: #6c757d;
    padding: 40px;
}

.empty-icon {
    font-size: 3rem;
    margin-bottom: 15px;
    opacity: 0.5;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .buddy-chat-container {
        flex-direction: column;
        height: 100vh;
    }
    
    .chat-sidebar {
        width: 100%;
        height: 200px;
        border-right: none;
        border-bottom: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .members-section {
        padding: 15px;
    }
    
    .members-list {
        flex-direction: row;
        overflow-x: auto;
        gap: 8px;
    }
    
    .member-item {
        min-width: 200px;
    }
    
    .chat-main {
        flex: 1;
    }
    
    .message {
        max-width: 85%;
    }
}

/* åŠ è½½åŠ¨ç”» */
.loading-messages {
    text-align: center;
    padding: 20px;
    color: #6c757d;
}

.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid #e9ecef;
    border-radius: 50%;
    border-top-color: #667eea;
    animation: spin 1s ease-in-out infinite;
    margin-right: 8px;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* é€šçŸ¥æ ·å¼ */
.chat-notification {
    background: #d1ecf1;
    color: #0c5460;
    padding: 12px 16px;
    border-radius: 8px;
    margin-bottom: 15px;
    text-align: center;
    font-size: 0.9rem;
    border: 1px solid #bee5eb;
}
</style>
{% endblock %}

{% block content %}
<div class="buddy-chat-container">
    <!-- ä¾§è¾¹æ  -->
    <div class="chat-sidebar">
        <!-- æ´»åŠ¨ä¿¡æ¯å¤´éƒ¨ -->
        <div class="event-header">
            <a href="{% url 'tools:buddy_detail' event.id %}" class="back-btn">
                <i class="fas fa-arrow-left"></i> è¿”å›
            </a>
            
            <div class="event-title">{{ event.title }}</div>
            <div class="event-meta">
                <div class="meta-item">
                    <span>
                        {% if event.event_type == 'meal' %}ğŸ½ï¸
                        {% elif event.event_type == 'sports' %}âš½
                        {% elif event.event_type == 'travel' %}ğŸ’
                        {% elif event.event_type == 'study' %}ğŸ“š
                        {% elif event.event_type == 'game' %}ğŸ®
                        {% elif event.event_type == 'movie' %}ğŸ¬
                        {% elif event.event_type == 'shopping' %}ğŸ›ï¸
                        {% elif event.event_type == 'coffee' %}â˜•
                        {% else %}ğŸ¯
                        {% endif %}
                    </span>
                    <span>{{ event.get_event_type_display }}</span>
                </div>
                <div class="meta-item">
                    <span>ğŸ“…</span>
                    <span>{{ event.start_time|date:"m-d H:i" }}</span>
                </div>
                <div class="meta-item">
                    <span>ğŸ“</span>
                    <span>{{ event.location|truncatechars:20 }}</span>
                </div>
            </div>
        </div>

        <!-- æˆå‘˜åˆ—è¡¨ -->
        <div class="members-section">
            <div class="members-title">
                ğŸ‘¥ å‚ä¸æˆå‘˜ (<span id="member-count">1</span>/{{ event.max_members }})
            </div>
            <div class="members-list" id="members-list">
                <!-- å‘èµ·äºº -->
                <div class="member-item">
                    <div class="member-avatar">
                        {{ event.creator.username|first|upper }}
                    </div>
                    <div class="member-info">
                        <div class="member-name">{{ event.creator.username }}</div>
                        <div class="member-role creator">å‘èµ·äºº</div>
                    </div>
                    <div class="member-status" id="status-{{ event.creator.id }}"></div>
                </div>
                
                <!-- å…¶ä»–æˆå‘˜å°†é€šè¿‡JavaScriptåŠ è½½ -->
            </div>
        </div>
    </div>

    <!-- ä¸»èŠå¤©åŒºåŸŸ -->
    <div class="chat-main">
        <!-- èŠå¤©å¤´éƒ¨ -->
        <div class="chat-header">
            <div class="chat-title">
                ğŸ’¬ ç¾¤èŠ
                <span class="online-count" id="online-count">1äººåœ¨çº¿</span>
            </div>
        </div>

        <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
        <div class="chat-messages" id="chat-messages">
            <div class="chat-notification">
                æ¬¢è¿æ¥åˆ°"{{ event.title }}"ç¾¤èŠï¼è¯·æ–‡æ˜èŠå¤©ï¼Œå‹å¥½äº¤æµ ğŸ˜Š
            </div>
            
            <div class="loading-messages" id="loading-messages">
                <span class="loading-spinner"></span>
                æ­£åœ¨åŠ è½½å†å²æ¶ˆæ¯...
            </div>
            
            <!-- æ¶ˆæ¯å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
        </div>

        <!-- è¾“å…¥åŒºåŸŸ -->
        <div class="chat-input">
            <div class="input-container">
                <textarea 
                    class="message-input" 
                    id="message-input" 
                    placeholder="è¾“å…¥æ¶ˆæ¯..."
                    rows="1"></textarea>
                <button class="send-btn" id="send-btn" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// èŠå¤©ç›¸å…³å˜é‡
let eventId = {{ event.id }};
let currentUser = '{{ user.username }}';
let currentUserId = {{ user.id }};
let chatSocket = null;
let isConnected = false;

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    initializeChat();
    loadMembers();
    loadMessages();
    setupInputHandler();
});

// åˆå§‹åŒ–èŠå¤©
function initializeChat() {
    // è¿æ¥WebSocketï¼ˆå¦‚æœéœ€è¦å®æ—¶èŠå¤©åŠŸèƒ½ï¼‰
    connectWebSocket();
    
    // å®šæœŸæ›´æ–°åœ¨çº¿çŠ¶æ€
    setInterval(updateOnlineStatus, 30000); // æ¯30ç§’æ›´æ–°ä¸€æ¬¡
}

// è¿æ¥WebSocket
function connectWebSocket() {
    // è¿™é‡Œå¯ä»¥å®ç°WebSocketè¿æ¥é€»è¾‘
    // æš‚æ—¶ä½¿ç”¨è½®è¯¢æ–¹å¼

}

// åŠ è½½æˆå‘˜åˆ—è¡¨
async function loadMembers() {
    try {
        // è¿™é‡Œå¯ä»¥è°ƒç”¨APIè·å–æ´»åŠ¨æˆå‘˜åˆ—è¡¨
        // æš‚æ—¶ä½¿ç”¨é™æ€æ•°æ®
        updateMemberCount(1);
    } catch (error) {
        console.error('åŠ è½½æˆå‘˜åˆ—è¡¨å¤±è´¥:', error);
    }
}

// åŠ è½½å†å²æ¶ˆæ¯
async function loadMessages() {
    try {
        const response = await fetch(`{% url "tools:buddy_messages_api" %}?event_id=${eventId}`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            displayMessages(result.messages);
        } else {
            console.error('åŠ è½½æ¶ˆæ¯å¤±è´¥:', result.message);
        }
    } catch (error) {
        console.error('åŠ è½½æ¶ˆæ¯å¤±è´¥:', error);
        showEmptyMessages();
    } finally {
        document.getElementById('loading-messages').style.display = 'none';
    }
}

// æ˜¾ç¤ºæ¶ˆæ¯åˆ—è¡¨
function displayMessages(messages) {
    const messagesContainer = document.getElementById('chat-messages');
    const loadingElement = document.getElementById('loading-messages');
    
    if (messages.length === 0) {
        showEmptyMessages();
        return;
    }
    
    messages.forEach(message => {
        const messageElement = createMessageElement(message);
        messagesContainer.insertBefore(messageElement, loadingElement);
    });
    
    // æ»šåŠ¨åˆ°åº•éƒ¨
    scrollToBottom();
}

// æ˜¾ç¤ºç©ºæ¶ˆæ¯çŠ¶æ€
function showEmptyMessages() {
    const messagesContainer = document.getElementById('chat-messages');
    const emptyElement = document.createElement('div');
    emptyElement.className = 'empty-messages';
    emptyElement.innerHTML = `
        <div class="empty-icon">ğŸ’¬</div>
        <div>è¿˜æ²¡æœ‰æ¶ˆæ¯ï¼Œå¿«æ¥å¼€å¯å¯¹è¯å§ï¼</div>
    `;
    messagesContainer.appendChild(emptyElement);
}

// åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
function createMessageElement(message) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${message.sender_id === currentUserId ? 'own' : ''}`;
    
    const isOwn = message.sender_id === currentUserId;
    
    messageDiv.innerHTML = `
        <div class="message-avatar">
            ${message.sender_name.charAt(0).toUpperCase()}
        </div>
        <div class="message-content">
            <div class="message-header">
                <span class="message-sender">${message.sender_name}</span>
                <span class="message-time">${formatTime(message.created_at)}</span>
            </div>
            <div class="message-bubble">
                ${escapeHtml(message.content)}
            </div>
        </div>
    `;
    
    return messageDiv;
}

// å‘é€æ¶ˆæ¯
async function sendMessage() {
    const input = document.getElementById('message-input');
    const content = input.value.trim();
    
    if (!content) {
        return;
    }
    
    const sendBtn = document.getElementById('send-btn');
    sendBtn.disabled = true;
    
    try {
        const response = await fetch('{% url "tools:buddy_send_message_api" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                event_id: eventId,
                content: content
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // æ¸…ç©ºè¾“å…¥æ¡†
            input.value = '';
            
            // æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢
            const messageElement = createMessageElement({
                sender_id: currentUserId,
                sender_name: currentUser,
                content: content,
                created_at: new Date().toISOString()
            });
            
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.appendChild(messageElement);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            scrollToBottom();
        } else {
            alert('å‘é€å¤±è´¥ï¼š' + result.message);
        }
    } catch (error) {
        alert('å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•');
        console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
    } finally {
        sendBtn.disabled = false;
    }
}

// è®¾ç½®è¾“å…¥å¤„ç†
function setupInputHandler() {
    const input = document.getElementById('message-input');
    
    // è‡ªåŠ¨è°ƒæ•´é«˜åº¦
    input.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });
    
    // å›è½¦å‘é€æ¶ˆæ¯
    input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
}

// æ›´æ–°æˆå‘˜æ•°é‡
function updateMemberCount(count) {
    document.getElementById('member-count').textContent = count;
    document.getElementById('online-count').textContent = `${count}äººåœ¨çº¿`;
}

// æ›´æ–°åœ¨çº¿çŠ¶æ€
function updateOnlineStatus() {
    // è¿™é‡Œå¯ä»¥å®ç°åœ¨çº¿çŠ¶æ€æ›´æ–°é€»è¾‘

}

// æ»šåŠ¨åˆ°åº•éƒ¨
function scrollToBottom() {
    const messagesContainer = document.getElementById('chat-messages');
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// æ ¼å¼åŒ–æ—¶é—´
function formatTime(timeString) {
    const date = new Date(timeString);
    const now = new Date();
    
    if (date.toDateString() === now.toDateString()) {
        // ä»Šå¤©ï¼Œæ˜¾ç¤ºæ—¶é—´
        return date.toLocaleTimeString('zh-CN', {
            hour: '2-digit',
            minute: '2-digit'
        });
    } else {
        // å…¶ä»–æ—¥æœŸï¼Œæ˜¾ç¤ºæœˆ-æ—¥ æ—¶:åˆ†
        return date.toLocaleString('zh-CN', {
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }
}

// HTMLè½¬ä¹‰
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// è·å–CSRF Token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
