{% extends 'base.html' %}
{% load static %}

{% block title %}å‘èµ·æ´»åŠ¨ - æ­å­{% endblock %}

{% block extra_css %}
<style>
/* ç°ä»£åŒ–æ­å­åˆ›å»ºé¡µé¢æ ·å¼ */
.buddy-create-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #f5576c 75%, #4facfe 100%);
    min-height: 100vh;
    position: relative;
    overflow: hidden;
}

/* åŠ¨æ€èƒŒæ™¯æ•ˆæœ */
.buddy-create-container::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: 
        radial-gradient(circle at 30% 70%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 70% 30%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
    z-index: -1;
    animation: createPulse 6s ease-in-out infinite;
}

@keyframes createPulse {
    0%, 100% { 
        transform: scale(1) rotate(0deg);
        opacity: 0.8;
    }
    50% { 
        transform: scale(1.05) rotate(2deg);
        opacity: 1;
    }
}

/* æµ®åŠ¨å…ƒç´  */
.floating-elements {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: -1;
}

.floating-element {
    position: absolute;
    opacity: 0.15;
    animation: floatCreate 8s ease-in-out infinite;
}

.floating-element:nth-child(1) {
    top: 15%;
    left: 15%;
    font-size: 2.5rem;
    animation-delay: 0s;
}

.floating-element:nth-child(2) {
    top: 25%;
    right: 20%;
    font-size: 2rem;
    animation-delay: 2s;
}

.floating-element:nth-child(3) {
    bottom: 35%;
    left: 25%;
    font-size: 2.2rem;
    animation-delay: 4s;
}

@keyframes floatCreate {
    0%, 100% { 
        transform: translateY(0px) rotate(0deg); 
        opacity: 0.15;
    }
    50% { 
        transform: translateY(-15px) rotate(5deg); 
        opacity: 0.25;
    }
}

/* å¤´éƒ¨æ ·å¼ */
.create-header {
    text-align: center;
    margin-bottom: 40px;
    position: relative;
    z-index: 1;
}

.create-header h1 {
    font-size: 3rem;
    font-weight: 700;
    color: #fff;
    text-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    margin-bottom: 10px;
    background: linear-gradient(45deg, #fff, #f0f8ff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.create-header p {
    font-size: 1.2rem;
    color: rgba(255, 255, 255, 0.9);
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

/* è¡¨å•å®¹å™¨ */
.create-form-container {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 20px;
    padding: 40px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    position: relative;
    z-index: 1;
}

/* è¡¨å•ç»„æ ·å¼ */
.form-group {
    margin-bottom: 25px;
}

.form-group label {
    display: block;
    font-weight: 600;
    color: #333;
    margin-bottom: 8px;
    font-size: 1.1rem;
}

.form-group label .required {
    color: #e74c3c;
    margin-left: 4px;
}

.form-control {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid rgba(225, 229, 233, 0.6);
    border-radius: 10px;
    font-size: 1rem;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(5px);
    color: #333;
}

.form-control:not(:placeholder-shown) {
    color: #000;
    font-weight: 500;
}

.form-control:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    transform: translateY(-1px);
}

textarea.form-control {
    resize: vertical;
    min-height: 100px;
}

select.form-control {
    cursor: pointer;
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    background: rgba(255, 255, 255, 0.8) url("data:image/svg+xml;charset=utf8,<svg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'><path fill='%23667eea' d='M6 9L1.5 4.5h9z'/></svg>") no-repeat right 12px center;
    background-size: 12px;
    padding-right: 40px;
    position: relative;
    z-index: 10;
    color: #333;
}

select.form-control option {
    color: #333;
    background: #fff;
}

/* æ—¥æœŸæ—¶é—´è¾“å…¥æ¡†æ ·å¼ */
input[type="datetime-local"].form-control {
    color: #333;
}

input[type="datetime-local"].form-control::-webkit-datetime-edit {
    color: #333;
}

input[type="datetime-local"].form-control::-webkit-datetime-edit-fields-wrapper {
    color: #333;
}

/* ç¡®ä¿æœ‰å€¼æ—¶æ–‡å­—ä¸ºé»‘è‰² */
.form-control:valid {
    color: #000 !important;
    font-weight: 500;
}

/* å¼ºåˆ¶æ˜¾ç¤ºé€‰é¡¹æ ·å¼ */
select.form-control option {
    background: white !important;
    color: #333 !important;
    padding: 12px 16px !important;
    font-size: 1rem !important;
    line-height: 1.6 !important;
    border: none !important;
    font-weight: normal !important;
    min-height: 40px !important;
    display: block !important;
}

select.form-control option:hover {
    background: #667eea !important;
    color: white !important;
}

select.form-control option:checked,
select.form-control option:selected {
    background: #667eea !important;
    color: white !important;
    font-weight: 600 !important;
}

/* ä¿®å¤Safariå’ŒChromeçš„é€‰é¡¹æ˜¾ç¤º */
select.form-control {
    background-color: white;
    border: 2px solid #e1e5e9;
    border-radius: 10px;
    padding: 12px 40px 12px 16px;
    font-size: 1rem;
    transition: all 0.3s ease;
    width: 100%;
    height: auto;
    min-height: 48px;
}

select.form-control:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    transform: translateY(-1px);
}

/* é’ˆå¯¹ä¸åŒæµè§ˆå™¨çš„é€‰é¡¹æ ·å¼ä¿®å¤ */
select.form-control optgroup {
    background: white;
    color: #666;
    font-weight: bold;
    font-style: normal;
}

/* è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†åŒ…è£…å™¨ */
.custom-select-wrapper {
    position: relative;
    display: block;
}

.custom-select-wrapper::after {
    content: 'â–¼';
    position: absolute;
    top: 50%;
    right: 16px;
    transform: translateY(-50%);
    pointer-events: none;
    color: #667eea;
    font-size: 0.8rem;
    font-weight: bold;
    z-index: 2;
}

.custom-select {
    appearance: none !important;
    -webkit-appearance: none !important;
    -moz-appearance: none !important;
    background: white !important;
    background-image: none !important;
    padding-right: 45px !important;
    cursor: pointer;
    position: relative;
    z-index: 1;
}

/* å¼ºåˆ¶æ˜¾ç¤ºé€‰é¡¹ - æ›´å¼ºçš„æ ·å¼è¦†ç›– */
.custom-select option {
    background: white !important;
    color: #333 !important;
    padding: 12px 16px !important;
    font-size: 1rem !important;
    line-height: 1.6 !important;
    border: none !important;
    font-weight: normal !important;
    min-height: 45px !important;
    display: block !important;
    text-indent: 0 !important;
}

.custom-select option:hover {
    background: #667eea !important;
    color: white !important;
}

.custom-select option:checked,
.custom-select option:selected {
    background: #667eea !important;
    color: white !important;
    font-weight: 600 !important;
}

/* é’ˆå¯¹WebKitæµè§ˆå™¨çš„ç‰¹æ®Šå¤„ç† */
@media screen and (-webkit-min-device-pixel-ratio:0) {
    .custom-select {
        background: white;
        border: 2px solid #e1e5e9;
        border-radius: 10px;
        padding: 12px 45px 12px 16px;
    }
    
    .custom-select option {
        background: white;
        color: #333;
        padding: 10px;
        font-size: 16px; /* é˜²æ­¢iOSç¼©æ”¾ */
    }
}

/* Firefoxç‰¹æ®Šå¤„ç† */
@-moz-document url-prefix() {
    .custom-select {
        background: white;
        border: 2px solid #e1e5e9;
        border-radius: 10px;
        padding: 12px 45px 12px 16px;
        text-indent: 0.01px;
        text-overflow: '';
    }
    
    .custom-select option {
        background: white;
        color: #333;
        padding: 8px;
    }
}

/* ç¡®ä¿ä¸‹æ‹‰é€‰é¡¹åœ¨æ‰€æœ‰æµè§ˆå™¨ä¸­å¯è§ */
@supports (-webkit-appearance: none) {
    .custom-select option {
        background: white;
        color: #333;
    }
}

@supports (-moz-appearance: none) {
    .custom-select option {
        background: white;
        color: #333;
    }
}

/* æ—¶é—´è¾“å…¥ç»„ */
.time-group {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

/* è´¹ç”¨ç›¸å…³ */
.cost-group {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    align-items: end;
}

/* å¹´é¾„é™åˆ¶ */
.age-group {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

/* ä½ç½®ç›¸å…³ */
.location-group {
    position: relative;
}

.location-input {
    padding-right: 80px;
}

.location-btn {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    background: #667eea;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 6px 12px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.3s ease;
}

.location-btn:hover {
    background: #5a6fd8;
    transform: translateY(-50%) scale(1.05);
}

/* åœ°ç‚¹æœç´¢ä¸‹æ‹‰åˆ—è¡¨ */
.location-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: rgba(255, 255, 255, 0.98);
    border: 1px solid rgba(225, 229, 233, 0.8);
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    backdrop-filter: blur(10px);
    z-index: 1000;
    max-height: 400px;
    overflow: hidden;
    margin-top: 4px;
}

.location-dropdown-header {
    padding: 12px 16px;
    border-bottom: 1px solid rgba(225, 229, 233, 0.5);
    display: flex;
    gap: 8px;
}

.location-action-btn {
    background: rgba(102, 126, 234, 0.1);
    color: #667eea;
    border: 1px solid rgba(102, 126, 234, 0.3);
    border-radius: 8px;
    padding: 6px 12px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 4px;
}

.location-action-btn:hover {
    background: rgba(102, 126, 234, 0.2);
    transform: translateY(-1px);
}

.location-suggestions {
    max-height: 320px;
    overflow-y: auto;
}

.location-suggestion-item {
    padding: 12px 16px;
    cursor: pointer;
    border-bottom: 1px solid rgba(225, 229, 233, 0.3);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 12px;
}

.location-suggestion-item:last-child {
    border-bottom: none;
}

.location-suggestion-item:hover {
    background: rgba(102, 126, 234, 0.08);
}

.location-suggestion-icon {
    width: 20px;
    height: 20px;
    background: rgba(102, 126, 234, 0.1);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #667eea;
    font-size: 10px;
    flex-shrink: 0;
}

.location-suggestion-content {
    flex: 1;
}

.location-suggestion-name {
    font-weight: 500;
    color: #333;
    margin-bottom: 2px;
}

.location-suggestion-address {
    font-size: 0.85rem;
    color: #666;
}

/* æŒ‰é’®æ ·å¼ */
.btn-group {
    display: flex;
    gap: 15px;
    margin-top: 30px;
}

.btn {
    flex: 1;
    padding: 15px 25px;
    border: none;
    border-radius: 12px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    text-align: center;
    display: inline-block;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 25px rgba(102, 126, 234, 0.4);
}

.btn-secondary {
    background: #f8f9fa;
    color: #6c757d;
    border: 2px solid #e9ecef;
}

.btn-secondary:hover {
    background: #e9ecef;
    border-color: #d1d5db;
    transform: translateY(-1px);
}

/* åŠ è½½çŠ¶æ€ */
.btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none !important;
}

.loading-spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
    margin-right: 8px;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* é”™è¯¯æç¤º */
.error-message {
    background: #fee;
    color: #c33;
    padding: 12px 16px;
    border-radius: 8px;
    margin-bottom: 20px;
    border: 1px solid #fcc;
    display: none;
}

.success-message {
    background: #efe;
    color: #363;
    padding: 12px 16px;
    border-radius: 8px;
    margin-bottom: 20px;
    border: 1px solid #cfc;
    display: none;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .buddy-create-container {
        padding: 15px;
    }
    
    .create-form-container {
        padding: 25px;
        margin: 0 10px;
    }
    
    .create-header h1 {
        font-size: 2.5rem;
    }
    
    .time-group,
    .cost-group,
    .age-group {
        grid-template-columns: 1fr;
    }
    
    .btn-group {
        flex-direction: column;
    }
}

/* å·¥å…·æç¤º */
.tooltip {
    position: relative;
    display: inline-block;
    cursor: help;
    margin-left: 5px;
    color: #667eea;
}

.tooltip:hover::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 125%;
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 0.85rem;
    white-space: nowrap;
    z-index: 1000;
    opacity: 1;
}

.tooltip::before {
    content: '?';
    display: inline-block;
    width: 16px;
    height: 16px;
    background: #667eea;
    color: white;
    border-radius: 50%;
    text-align: center;
    font-size: 0.8rem;
    line-height: 16px;
}

/* åœ°å›¾é€‰æ‹©å™¨æ ·å¼ */
.map-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.map-modal-content {
    background: white;
    border-radius: 15px;
    width: 90%;
    max-width: 800px;
    height: 80%;
    max-height: 600px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
}

.map-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid #e9ecef;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.map-modal-header h3 {
    margin: 0;
    font-size: 1.3rem;
    flex: 1;
}

.map-status {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
    opacity: 0.9;
}

.status-indicator {
    font-size: 1rem;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}

.status-text {
    font-size: 0.85rem;
}

.map-close-btn {
    background: none;
    border: none;
    color: white;
    font-size: 1.8rem;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.3s ease;
}

.map-close-btn:hover {
    background: rgba(255, 255, 255, 0.2);
}

.map-search-bar {
    display: flex;
    gap: 10px;
    padding: 15px 20px;
    border-bottom: 1px solid #e9ecef;
    background: #f8f9fa;
}

.search-input-container {
    flex: 1;
    position: relative;
}

.map-search-input {
    width: 100%;
    padding: 10px 15px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 1rem;
}

.search-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-top: none;
    border-radius: 0 0 8px 8px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
}

.suggestion-item {
    padding: 10px 15px;
    cursor: pointer;
    border-bottom: 1px solid #f1f1f1;
    transition: background-color 0.2s ease;
}

.suggestion-item:hover {
    background-color: #f8f9fa;
}

.suggestion-item:last-child {
    border-bottom: none;
}

.suggestion-name {
    font-weight: 500;
    color: #333;
    margin-bottom: 2px;
}

.suggestion-address {
    font-size: 0.85rem;
    color: #666;
}

.suggestion-distance {
    font-size: 0.75rem;
    color: #999;
    float: right;
}

.map-search-btn,
.map-location-btn {
    padding: 10px 15px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 600;
    transition: all 0.3s ease;
}

.map-search-btn {
    background: #667eea;
    color: white;
}

.map-search-btn:hover {
    background: #5a6fd8;
}

.map-location-btn {
    background: #28a745;
    color: white;
}

.map-location-btn:hover {
    background: #218838;
}

.map-container {
    flex: 1;
    position: relative;
    min-height: 300px;
}

.map-modal-footer {
    padding: 20px;
    border-top: 1px solid #e9ecef;
    background: #f8f9fa;
}

.selected-location {
    margin-bottom: 15px;
    color: #495057;
}

.map-buttons {
    display: flex;
    gap: 15px;
    justify-content: flex-end;
}

.btn-cancel,
.btn-confirm {
    padding: 10px 25px;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-cancel {
    background: #6c757d;
    color: white;
}

.btn-cancel:hover {
    background: #5a6268;
}

.btn-confirm {
    background: #28a745;
    color: white;
}

.btn-confirm:hover {
    background: #218838;
}

.btn-confirm:disabled {
    background: #6c757d;
    cursor: not-allowed;
}

/* åœ°ç‚¹æ¨èæ ·å¼ */
.location-suggestions {
    padding: 15px 20px;
    background: #f8f9fa;
    border-bottom: 1px solid #e9ecef;
}

.suggestion-title {
    font-size: 0.9rem;
    color: #6c757d;
    margin-bottom: 10px;
    font-weight: 500;
}

.suggestion-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.suggestion-tag {
    padding: 6px 12px;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 15px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.3s ease;
    user-select: none;
}

.suggestion-tag:hover {
    background: #667eea;
    color: white;
    border-color: #667eea;
    transform: translateY(-1px);
}

/* æœç´¢æç¤ºæ ·å¼ */
.search-tip {
    padding: 12px 16px;
    margin: 10px 20px;
    border-radius: 8px;
    font-size: 0.9rem;
    line-height: 1.4;
    animation: tipSlideIn 0.3s ease-out;
    white-space: pre-line;
}

@keyframes tipSlideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.search-tip-info {
    background: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
}

.search-tip-success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.search-tip-warning {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
}
</style>
{% endblock %}

{% block content %}
<div class="buddy-create-container">
    <!-- æµ®åŠ¨å…ƒç´  -->
    <div class="floating-elements">
        <div class="floating-element">ğŸ¯</div>
        <div class="floating-element">âœ¨</div>
        <div class="floating-element">ğŸ¤</div>
    </div>

    <!-- å¤´éƒ¨ -->
    <div class="create-header">
        <h1>âœ¨ å‘èµ·æ´»åŠ¨</h1>
        <p>åˆ›å»ºä¸€ä¸ªç²¾å½©çš„åŒåŸæ´»åŠ¨ï¼Œæ‰¾åˆ°å¿—åŒé“åˆçš„ä¼™ä¼´</p>
    </div>

    <!-- è¡¨å•å®¹å™¨ -->
    <div class="create-form-container">
        <!-- é”™è¯¯å’ŒæˆåŠŸæç¤º -->
        <div id="error-message" class="error-message"></div>
        <div id="success-message" class="success-message"></div>

        <form id="create-event-form">
            <!-- åŸºç¡€ä¿¡æ¯ -->
            <div class="form-group">
                <label for="title">æ´»åŠ¨æ ‡é¢˜ <span class="required">*</span></label>
                <input type="text" id="title" name="title" class="form-control" 
                       placeholder="ç»™ä½ çš„æ´»åŠ¨èµ·ä¸ªå¸å¼•äººçš„æ ‡é¢˜..." maxlength="200" required>
            </div>

            <div class="form-group">
                <label for="event_type">æ´»åŠ¨ç±»å‹ <span class="required">*</span></label>
                <div class="custom-select-wrapper">
                    <select id="event_type" name="event_type" class="form-control custom-select" required>
                        <option value="">è¯·é€‰æ‹©æ´»åŠ¨ç±»å‹</option>
                        <option value="meal">ğŸ½ï¸ é¥­æ­ - ä¸€èµ·åƒé¥­èŠå¤©</option>
                        <option value="sports">âš½ çƒæ­ - è¿åŠ¨å¥èº«</option>
                        <option value="travel">ğŸ’ æ—…è¡Œæ­ - ç»“ä¼´å‡ºæ¸¸</option>
                        <option value="study">ğŸ“š å­¦ä¹ æ­ - ä¸€èµ·å­¦ä¹ </option>
                        <option value="game">ğŸ® æ¸¸æˆæ­ - æ¸¸æˆå¨±ä¹</option>
                        <option value="movie">ğŸ¬ ç”µå½±æ­ - è§‚å½±æ´»åŠ¨</option>
                        <option value="shopping">ğŸ›ï¸ è´­ç‰©æ­ - è´­ç‰©é€›è¡—</option>
                        <option value="coffee">â˜• å’–å•¡æ­ - å’–å•¡èšä¼š</option>
                        <option value="other">ğŸ¯ å…¶ä»– - å…¶ä»–æ´»åŠ¨</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="description">æ´»åŠ¨æè¿° <span class="required">*</span></label>
                <textarea id="description" name="description" class="form-control" 
                          placeholder="è¯¦ç»†æè¿°ä½ çš„æ´»åŠ¨å†…å®¹ã€è¦æ±‚ã€æ³¨æ„äº‹é¡¹ç­‰..." required></textarea>
            </div>

            <!-- æ—¶é—´å®‰æ’ -->
            <div class="form-group">
                <label>æ—¶é—´å®‰æ’ <span class="required">*</span></label>
                <div class="time-group">
                    <div>
                        <label for="start_time">å¼€å§‹æ—¶é—´</label>
                        <input type="datetime-local" id="start_time" name="start_time" class="form-control" required>
                    </div>
                    <div>
                        <label for="end_time">ç»“æŸæ—¶é—´</label>
                        <input type="datetime-local" id="end_time" name="end_time" class="form-control">
                    </div>
                </div>
            </div>

            <!-- åœ°ç‚¹ä¿¡æ¯ -->
            <div class="form-group">
                <label for="location">æ´»åŠ¨åœ°ç‚¹ <span class="required">*</span>
                    <span class="tooltip" data-tooltip="ç‚¹å‡»åœ°å›¾é€‰æ‹©ç²¾ç¡®ä½ç½®ï¼Œæˆ–æ‰‹åŠ¨è¾“å…¥åœ°å€"></span>
                </label>
                <div class="location-group">
                    <input type="text" id="location" name="location" class="form-control location-input" 
                           placeholder="è¯·è¾“å…¥åœ°ç‚¹åç§°ï¼Œå¦‚ï¼šå§é¾™å…¬å›­ã€å§é¾™å°åŒº..." required autocomplete="off">
                    <button type="button" class="location-btn" onclick="openMapPicker()">ğŸ—ºï¸ åœ°å›¾</button>
                    
                    <!-- åœ°ç‚¹æœç´¢ä¸‹æ‹‰åˆ—è¡¨ -->
                    <div id="location-dropdown" class="location-dropdown" style="display: none;">
                        <div class="location-dropdown-header">
                            <button type="button" class="location-action-btn" onclick="getCurrentLocation()">
                                <i class="fas fa-location-arrow"></i> å½“å‰ä½ç½®
                            </button>
                            <button type="button" class="location-action-btn" onclick="clearLocationSearch()">
                                <i class="fas fa-times"></i> æ¸…é™¤
                            </button>
                        </div>
                        <div id="location-suggestions" class="location-suggestions">
                            <!-- æœç´¢å»ºè®®å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                    </div>
                </div>
                <input type="hidden" id="latitude" name="latitude">
                <input type="hidden" id="longitude" name="longitude">
                
                <!-- åœ°å›¾é€‰æ‹©å™¨ -->
                <div id="map-picker-modal" class="map-modal" style="display: none;">
                    <div class="map-modal-content">
                        <div class="map-modal-header">
                            <h3>ğŸ“ é€‰æ‹©æ´»åŠ¨åœ°ç‚¹</h3>
                            <div class="map-status" id="map-status">
                                <span class="status-indicator" id="status-indicator">ğŸ”„</span>
                                <span class="status-text" id="status-text">åˆå§‹åŒ–ä¸­...</span>
                            </div>
                            <button type="button" class="map-close-btn" onclick="closeMapPicker()">&times;</button>
                        </div>
                        <div class="map-search-bar">
                            <div class="search-input-container">
                                <input type="text" id="map-search-input" placeholder="æœç´¢å’–å•¡å…ã€é¤å…ã€å…¬å›­ã€å•†åœºç­‰åœ°ç‚¹..." class="map-search-input" autocomplete="off">
                                <div class="search-suggestions" id="search-suggestions"></div>
                            </div>
                            <button type="button" onclick="searchLocation()" class="map-search-btn">ğŸ” æœç´¢</button>
                            <button type="button" onclick="getCurrentLocationForMap()" class="map-location-btn">ğŸ“ å®šä½</button>
                        </div>
                        
                        <!-- åœ°ç‚¹æ¨èæç¤º -->
                        <div class="location-suggestions">
                            <div class="suggestion-title">ğŸ’¡ æ¨èåœ°ç‚¹ç±»å‹ï¼š</div>
                            <div class="suggestion-tags">
                                <span class="suggestion-tag" onclick="searchSuggestion('åŒ—äº¬å¤§å­¦')">ğŸ“ åŒ—äº¬å¤§å­¦</span>
                                <span class="suggestion-tag" onclick="searchSuggestion('æ¸…åå¤§å­¦')">ğŸ“ æ¸…åå¤§å­¦</span>
                                <span class="suggestion-tag" onclick="searchSuggestion('å¤©å®‰é—¨å¹¿åœº')">ğŸ›ï¸ å¤©å®‰é—¨</span>
                                <span class="suggestion-tag" onclick="searchSuggestion('ä¸Šæµ·å¤–æ»©')">ğŸŒƒ å¤–æ»©</span>
                                <span class="suggestion-tag" onclick="searchSuggestion('è¥¿æ¹–')">ğŸŒŠ è¥¿æ¹–</span>
                                <span class="suggestion-tag" onclick="searchSuggestion('å’–å•¡å…')">â˜• å’–å•¡å…</span>
                                <span class="suggestion-tag" onclick="searchSuggestion('é¤å…')">ğŸ½ï¸ é¤å…</span>
                                <span class="suggestion-tag" onclick="searchSuggestion('å…¬å›­')">ğŸŒ³ å…¬å›­</span>
                                <span class="suggestion-tag" onclick="searchSuggestion('å•†åœº')">ğŸ›ï¸ å•†åœº</span>
                                <span class="suggestion-tag" onclick="searchSuggestion('å›¾ä¹¦é¦†')">ğŸ“š å›¾ä¹¦é¦†</span>
                                <span class="suggestion-tag" onclick="searchSuggestion('ç”µå½±é™¢')">ğŸ¬ ç”µå½±é™¢</span>
                                <span class="suggestion-tag" onclick="searchSuggestion('å¥èº«æˆ¿')">ğŸ’ª å¥èº«æˆ¿</span>
                            </div>
                        </div>
                        <div id="amap-container" class="map-container"></div>
                        <div class="map-modal-footer">
                            <div class="selected-location">
                                <strong>å·²é€‰æ‹©ï¼š</strong>
                                <span id="selected-location-text">è¯·åœ¨åœ°å›¾ä¸Šç‚¹å‡»é€‰æ‹©ä½ç½®</span>
                            </div>
                            <div class="map-buttons">
                                <button type="button" onclick="closeMapPicker()" class="btn-cancel">å–æ¶ˆ</button>
                                <button type="button" onclick="confirmLocation()" class="btn-confirm">ç¡®è®¤ä½ç½®</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- äººæ•°å’Œè´¹ç”¨ -->
            <div class="form-group">
                <label for="max_members">äººæ•°ä¸Šé™
                    <span class="tooltip" data-tooltip="åŒ…å«æ‚¨åœ¨å†…çš„æ€»äººæ•°"></span>
                </label>
                <div class="custom-select-wrapper">
                    <select id="max_members" name="max_members" class="form-control custom-select">
                        <option value="2">ğŸ‘¥ 2äºº - å°èš</option>
                        <option value="3">ğŸ‘¥ 3äºº - ä¸‰äººè¡Œ</option>
                        <option value="4" selected>ğŸ‘¥ 4äºº - å°å›¢é˜Ÿï¼ˆæ¨èï¼‰</option>
                        <option value="5">ğŸ‘¥ 5äºº - äº”äººç»„</option>
                        <option value="6">ğŸ‘¥ 6äºº - å…­äººå›¢</option>
                        <option value="8">ğŸ‘¥ 8äºº - å¤§èšä¼š</option>
                        <option value="10">ğŸ‘¥ 10äºº - å¤§å›¢é˜Ÿ</option>
                        <option value="15">ğŸ‘¥ 15äºº - è¶…å¤§å›¢é˜Ÿ</option>
                        <option value="20">ğŸ‘¥ 20äºº - èšä¼šæ´»åŠ¨</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>è´¹ç”¨ä¿¡æ¯</label>
                <div class="cost-group">
                    <div>
                        <label for="cost_type">è´¹ç”¨ç±»å‹</label>
                        <select id="cost_type" name="cost_type" class="form-control">
                            <option value="free">å…è´¹</option>
                            <option value="aa" selected>AAåˆ¶</option>
                        </select>
                    </div>
                    <div>
                        <label for="estimated_cost">é¢„ä¼°è´¹ç”¨ï¼ˆå…ƒï¼‰</label>
                        <input type="number" id="estimated_cost" name="estimated_cost" class="form-control" 
                               placeholder="0" min="0" step="0.01">
                    </div>
                </div>
            </div>

            <!-- é™åˆ¶æ¡ä»¶ -->
            <div class="form-group">
                <label for="gender_restriction">æ€§åˆ«é™åˆ¶</label>
                <select id="gender_restriction" name="gender_restriction" class="form-control">
                    <option value="none">ä¸é™</option>
                    <option value="male">ä»…é™ç”·æ€§</option>
                    <option value="female">ä»…é™å¥³æ€§</option>
                </select>
            </div>

            <div class="form-group">
                <label>å¹´é¾„é™åˆ¶</label>
                <div class="age-group">
                    <div>
                        <label for="age_min">æœ€å°å¹´é¾„</label>
                        <input type="number" id="age_min" name="age_min" class="form-control" 
                               placeholder="ä¸é™" min="16" max="100">
                    </div>
                    <div>
                        <label for="age_max">æœ€å¤§å¹´é¾„</label>
                        <input type="number" id="age_max" name="age_max" class="form-control" 
                               placeholder="ä¸é™" min="16" max="100">
                    </div>
                </div>
            </div>

            <!-- æŒ‰é’®ç»„ -->
            <div class="btn-group">
                <a href="{% url 'tools:buddy_home' %}" class="btn btn-secondary">å–æ¶ˆ</a>
                <button type="submit" class="btn btn-primary" id="submit-btn">
                    <span id="submit-text">å‘å¸ƒæ´»åŠ¨</span>
                    <span id="submit-loading" style="display: none;">
                        <span class="loading-spinner"></span>å‘å¸ƒä¸­...
                    </span>
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
        <!-- é«˜å¾·åœ°å›¾API - ä½¿ç”¨æœ‰æ•ˆçš„APIå¯†é’¥ -->
        <script src="https://webapi.amap.com/maps?v=2.0&key=a825cd9231f473717912d3203a62c53e&plugin=AMap.PlaceSearch,AMap.Autocomplete,AMap.Geolocation,AMap.Geocoder"></script>
<script>
// è¡¨å•æäº¤å¤„ç†
document.getElementById('create-event-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submit-btn');
    const submitText = document.getElementById('submit-text');
    const submitLoading = document.getElementById('submit-loading');
    const errorMessage = document.getElementById('error-message');
    const successMessage = document.getElementById('success-message');
    
    // éšè—ä¹‹å‰çš„æ¶ˆæ¯
    errorMessage.style.display = 'none';
    successMessage.style.display = 'none';
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    submitBtn.disabled = true;
    submitText.style.display = 'none';
    submitLoading.style.display = 'inline';
    
    try {
        // æ”¶é›†è¡¨å•æ•°æ®
        const formData = {
            title: document.getElementById('title').value.trim(),
            event_type: document.getElementById('event_type').value,
            description: document.getElementById('description').value.trim(),
            start_time: document.getElementById('start_time').value,
            end_time: document.getElementById('end_time').value || null,
            location: document.getElementById('location').value.trim(),
            latitude: document.getElementById('latitude').value || null,
            longitude: document.getElementById('longitude').value || null,
            max_members: parseInt(document.getElementById('max_members').value),
            cost_type: document.getElementById('cost_type').value,
            estimated_cost: document.getElementById('estimated_cost').value || 0,
            gender_restriction: document.getElementById('gender_restriction').value,
            age_min: document.getElementById('age_min').value || null,
            age_max: document.getElementById('age_max').value || null
        };
        
        // åŸºç¡€éªŒè¯
        if (!formData.title) {
            throw new Error('è¯·å¡«å†™æ´»åŠ¨æ ‡é¢˜');
        }
        if (!formData.event_type) {
            throw new Error('è¯·é€‰æ‹©æ´»åŠ¨ç±»å‹');
        }
        if (!formData.description) {
            throw new Error('è¯·å¡«å†™æ´»åŠ¨æè¿°');
        }
        if (!formData.start_time) {
            throw new Error('è¯·é€‰æ‹©å¼€å§‹æ—¶é—´');
        }
        if (!formData.location) {
            throw new Error('è¯·å¡«å†™æ´»åŠ¨åœ°ç‚¹');
        }
        
        // æ—¶é—´éªŒè¯
        const startTime = new Date(formData.start_time);
        const now = new Date();
        if (startTime <= now) {
            throw new Error('å¼€å§‹æ—¶é—´å¿…é¡»æ™šäºå½“å‰æ—¶é—´');
        }
        
        if (formData.end_time) {
            const endTime = new Date(formData.end_time);
            if (endTime <= startTime) {
                throw new Error('ç»“æŸæ—¶é—´å¿…é¡»æ™šäºå¼€å§‹æ—¶é—´');
            }
        }
        
        // å¹´é¾„éªŒè¯
        if (formData.age_min && formData.age_max) {
            if (parseInt(formData.age_min) > parseInt(formData.age_max)) {
                throw new Error('æœ€å°å¹´é¾„ä¸èƒ½å¤§äºæœ€å¤§å¹´é¾„');
            }
        }
        
        // å‘é€è¯·æ±‚
        const response = await fetch('{% url "tools:buddy_create_event_api" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            // æˆåŠŸ
            successMessage.textContent = result.message;
            successMessage.style.display = 'block';
            
            // 3ç§’åè·³è½¬åˆ°æ´»åŠ¨è¯¦æƒ…é¡µ
            setTimeout(() => {
                window.location.href = `{% url 'tools:buddy_detail' 0 %}`.replace('0', result.event_id);
            }, 2000);
        } else {
            // å¤±è´¥
            errorMessage.textContent = result.message || 'åˆ›å»ºæ´»åŠ¨å¤±è´¥';
            errorMessage.style.display = 'block';
        }
        
    } catch (error) {
        errorMessage.textContent = error.message || 'åˆ›å»ºæ´»åŠ¨å¤±è´¥ï¼Œè¯·é‡è¯•';
        errorMessage.style.display = 'block';
    } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        submitBtn.disabled = false;
        submitText.style.display = 'inline';
        submitLoading.style.display = 'none';
    }
});

// åœ°å›¾ç›¸å…³å˜é‡
let map = null;
let marker = null;
let selectedLocation = null;
let placeSearch = null;
let autocomplete = null;
let searchTimeout = null;

// æ‰“å¼€åœ°å›¾é€‰æ‹©å™¨
function openMapPicker() {
    const modal = document.getElementById('map-picker-modal');
    modal.style.display = 'flex';
    
    // åˆå§‹åŒ–åœ°å›¾
    if (!map) {
        initMap();
    }
}

// å…³é—­åœ°å›¾é€‰æ‹©å™¨
function closeMapPicker() {
    const modal = document.getElementById('map-picker-modal');
    modal.style.display = 'none';
}

// åˆå§‹åŒ–åœ°å›¾
function initMap() {
    try {
        // åˆ›å»ºåœ°å›¾å®ä¾‹
        map = new AMap.Map('amap-container', {
            zoom: 15,
            center: [116.397428, 39.90923], // é»˜è®¤åŒ—äº¬å¤©å®‰é—¨
            mapStyle: 'amap://styles/normal',
            resizeEnable: true,
            rotateEnable: false,
            pitchEnable: false,
            zoomEnable: true,
            dragEnable: true
        });
        
        // åˆ›å»ºæ ‡è®°
        marker = new AMap.Marker({
            position: [116.397428, 39.90923],
            draggable: true,
            cursor: 'move',
            title: 'ç‚¹å‡»åœ°å›¾æˆ–æ‹–æ‹½æ­¤æ ‡è®°é€‰æ‹©ä½ç½®'
        });
        
        // æ·»åŠ æ ‡è®°åˆ°åœ°å›¾
        map.add(marker);
        
        // åˆ›å»ºåœ°ç‚¹æœç´¢æœåŠ¡
        placeSearch = new AMap.PlaceSearch({
            pageSize: 20,
            pageIndex: 1,
            city: '', // å…¨å›½æœç´¢
            citylimit: false,
            map: map,
            panel: false,
            autoFitView: false
        });
        
        // åœ°å›¾ç‚¹å‡»äº‹ä»¶
        map.on('click', function(e) {
            const lng = e.lnglat.getLng();
            const lat = e.lnglat.getLat();
            
            // ç§»åŠ¨æ ‡è®°
            marker.setPosition([lng, lat]);
            
            // åå‘åœ°ç†ç¼–ç è·å–åœ°å€
            reverseGeocode(lng, lat);
        });
        
        // æ ‡è®°æ‹–æ‹½äº‹ä»¶
        marker.on('dragend', function(e) {
            const lng = e.lnglat.getLng();
            const lat = e.lnglat.getLat();
            
            // åå‘åœ°ç†ç¼–ç è·å–åœ°å€
            reverseGeocode(lng, lat);
        });
        
        // åœ°å›¾åŠ è½½å®Œæˆåçš„å›è°ƒ
        map.on('complete', function() {

            updateMapStatus('âœ…', 'åœ°å›¾å·²å°±ç»ª');
            showSearchTip('åœ°å›¾å·²åŠ è½½å®Œæˆï¼Œæ‚¨å¯ä»¥æœç´¢åœ°ç‚¹æˆ–ç›´æ¥ç‚¹å‡»åœ°å›¾é€‰æ‹©ä½ç½®', 'success');
        });
        
        // å°è¯•è·å–ç”¨æˆ·å½“å‰ä½ç½®
        getCurrentLocationForMap();
        
    } catch (error) {
        console.error('åœ°å›¾åˆå§‹åŒ–å¤±è´¥:', error);
        updateMapStatus('âŒ', 'åœ°å›¾åŠ è½½å¤±è´¥');
        showSearchTip('åœ°å›¾åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'warning');
    }
}

// æ›´æ–°åœ°å›¾çŠ¶æ€
function updateMapStatus(indicator, text) {
    const statusIndicator = document.getElementById('status-indicator');
    const statusText = document.getElementById('status-text');
    
    if (statusIndicator && statusText) {
        statusIndicator.textContent = indicator;
        statusText.textContent = text;
    }
}

// æœç´¢åœ°ç‚¹ - ä½¿ç”¨æœ¬åœ°åœ°å›¾æœç´¢API
async function searchLocation() {
    const keyword = document.getElementById('map-search-input').value.trim();
    if (!keyword) {
        showSearchTip('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
        return;
    }
    
    // æ˜¾ç¤ºæœç´¢çŠ¶æ€
    const searchBtn = document.querySelector('.map-search-btn');
    const originalText = searchBtn.textContent;
    searchBtn.textContent = 'ğŸ” æœç´¢ä¸­...';
    searchBtn.disabled = true;
    
    try {
        const response = await fetch('/tools/api/map/search-location/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ query: keyword })
        });

        const data = await response.json();
        
        // æ¢å¤æœç´¢æŒ‰é’®
        searchBtn.textContent = originalText;
        searchBtn.disabled = false;
        
        if (data.success && data.suggestions && data.suggestions.length > 0) {
            // é€‰æ‹©æœ€åŒ¹é…çš„ç»“æœ
            const bestMatch = findBestMatch(data.suggestions, keyword);
            
            if (bestMatch) {
                const lng = bestMatch.lon || bestMatch.longitude || bestMatch.lng;
                const lat = bestMatch.lat || bestMatch.latitude;
                
                // ç§»åŠ¨åœ°å›¾ä¸­å¿ƒå’Œæ ‡è®°
                map.setCenter([lng, lat]);
                marker.setPosition([lng, lat]);
                
                // æ›´æ–°é€‰ä¸­çš„ä½ç½®ä¿¡æ¯
                selectedLocation = {
                    lng: lng,
                    lat: lat,
                    address: bestMatch.name + (bestMatch.address ? ' - ' + bestMatch.address : ''),
                    name: bestMatch.name
                };
                
                document.getElementById('selected-location-text').textContent = selectedLocation.address;
                document.querySelector('.btn-confirm').disabled = false;
                
                showSearchTip('âœ… æ‰¾åˆ°åœ°ç‚¹ï¼š' + bestMatch.name, 'success');
            }
        } else {
            showSearchTip('ğŸ” æœç´¢å»ºè®®ï¼š\nâ€¢ å°è¯•è¾“å…¥å®Œæ•´åœ°åï¼ˆå¦‚ï¼šåŒ—äº¬å¤§å­¦ã€æ¸…åå¤§å­¦ï¼‰\nâ€¢ åŒ…å«åŸå¸‚åç§°ï¼ˆå¦‚ï¼šåŒ—äº¬ä¸‰é‡Œå±¯ã€ä¸Šæµ·å¤–æ»©ï¼‰\nâ€¢ ç‚¹å‡»åœ°å›¾ç›´æ¥é€‰æ‹©ä½ç½®\nâ€¢ ä½¿ç”¨ä¸‹æ–¹æ¨èçš„åœ°ç‚¹ç±»å‹å¿«é€Ÿæœç´¢', 'info');
        }
    } catch (error) {
        console.error('æœç´¢å¤±è´¥:', error);
        searchBtn.textContent = originalText;
        searchBtn.disabled = false;
        showSearchTip('ğŸ”§ æœç´¢æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç›´æ¥ç‚¹å‡»åœ°å›¾é€‰æ‹©ä½ç½®', 'warning');
    }
}



// æ‰¾åˆ°æœ€ä½³åŒ¹é…ç»“æœ
function findBestMatch(suggestions, keyword) {
    if (!suggestions || suggestions.length === 0) {
        return null;
    }
    
    // ä¼˜å…ˆé€‰æ‹©åç§°åŒ…å«å…³é”®è¯çš„ç»“æœ
    for (let item of suggestions) {
        const name = item.name || item.address || '';
        if (name.includes(keyword)) {
            return item;
        }
    }
    
    // å…¶æ¬¡é€‰æ‹©åœ°å€åŒ…å«å…³é”®è¯çš„ç»“æœ
    for (let item of suggestions) {
        const address = item.address || '';
        if (address.includes(keyword)) {
            return item;
        }
    }
    
    // æœ€åè¿”å›ç¬¬ä¸€ä¸ªç»“æœ
    return suggestions[0] || null;
}

// æ˜¾ç¤ºæœç´¢æç¤º
function showSearchTip(message, type = 'info') {
    const tipElement = document.createElement('div');
    tipElement.className = `search-tip search-tip-${type}`;
    tipElement.textContent = message;
    
    // æ’å…¥åˆ°åœ°å›¾å®¹å™¨ä¸Šæ–¹
    const mapContainer = document.getElementById('amap-container');
    mapContainer.parentNode.insertBefore(tipElement, mapContainer);
    
    // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
    setTimeout(() => {
        if (tipElement.parentNode) {
            tipElement.parentNode.removeChild(tipElement);
        }
    }, type === 'success' ? 2000 : 5000);
}

// æœç´¢å»ºè®®åœ°ç‚¹
function searchSuggestion(keyword) {
    document.getElementById('map-search-input').value = keyword;
    searchLocation();
}

// è·å–å½“å‰ä½ç½®ï¼ˆç”¨äºåœ°å›¾ï¼‰
function getCurrentLocationForMap() {
    if (!navigator.geolocation) {

        return;
    }
    
    const locationBtn = document.querySelector('.map-location-btn');
    const originalText = locationBtn.textContent;
    locationBtn.textContent = 'ğŸ“ å®šä½ä¸­...';
    locationBtn.disabled = true;
    
    navigator.geolocation.getCurrentPosition(
        function(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            // ç§»åŠ¨åœ°å›¾ä¸­å¿ƒå’Œæ ‡è®°
            map.setCenter([lng, lat]);
            marker.setPosition([lng, lat]);
            
            // åå‘åœ°ç†ç¼–ç è·å–åœ°å€
            reverseGeocode(lng, lat);
            
            locationBtn.textContent = 'âœ… å·²å®šä½';
            setTimeout(() => {
                locationBtn.textContent = originalText;
                locationBtn.disabled = false;
            }, 2000);
        },
        function(error) {

            locationBtn.textContent = originalText;
            locationBtn.disabled = false;
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 300000
        }
    );
}

// åå‘åœ°ç†ç¼–ç 
function reverseGeocode(lng, lat) {
    const geocoder = new AMap.Geocoder();
    
    geocoder.getAddress([lng, lat], function(status, result) {
        if (status === 'complete' && result.regeocode) {
            const address = result.regeocode.formattedAddress;
            const poi = result.regeocode.pois[0];
            const poiName = poi ? poi.name : '';
            
            selectedLocation = {
                lng: lng,
                lat: lat,
                address: address,
                name: poiName || address
            };
            
            document.getElementById('selected-location-text').textContent = selectedLocation.address;
            document.querySelector('.btn-confirm').disabled = false;
        }
    });
}

// ç¡®è®¤ä½ç½®é€‰æ‹©
function confirmLocation() {
    if (!selectedLocation) {
        alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªä½ç½®');
        return;
    }
    
    // æ›´æ–°è¡¨å•å­—æ®µ
    const locationInput = document.getElementById('location');
    locationInput.value = selectedLocation.address;
    document.getElementById('latitude').value = selectedLocation.lat;
    document.getElementById('longitude').value = selectedLocation.lng;
    
    // è§¦å‘è¾“å…¥æ¡†çš„changeäº‹ä»¶ï¼Œç¡®ä¿æ ·å¼æ›´æ–°
    locationInput.dispatchEvent(new Event('input'));
    locationInput.dispatchEvent(new Event('change'));
    
    // å…³é—­åœ°å›¾é€‰æ‹©å™¨
    closeMapPicker();
}



// æœç´¢å»ºè®® - ä½¿ç”¨æœ¬åœ°åœ°å›¾æœç´¢API
async function searchSuggestions(query) {
    await searchLocationSuggestions(query);
}

// ä½¿ç”¨æœ¬åœ°åœ°å›¾æœç´¢APIè·å–ä½ç½®å»ºè®®
async function searchLocationSuggestions(query) {
    if (!query || query.length < 2) {
        hideSuggestions();
        return;
    }

    try {
        const response = await fetch('/tools/api/map/search-location/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ query: query })
        });

        const data = await response.json();
        
        if (data.success && data.suggestions && data.suggestions.length > 0) {
            // è½¬æ¢ä¸ºå…¼å®¹æ ¼å¼
            const tips = data.suggestions.slice(0, 8).map(item => ({
                name: item.name || item.address,
                address: item.address || '',
                location: {
                    lat: item.lat || item.latitude,
                    lng: item.lon || item.longitude || item.lng
                },
                district: item.district || item.city || '',
                cityname: item.city || ''
            }));
            
            showSuggestions(tips);
        } else {
            hideSuggestions();
            showSearchTip('ğŸ’¡ æœªæ‰¾åˆ°ç›¸å…³åœ°ç‚¹ï¼Œè¯·å°è¯•å…¶ä»–å…³é”®è¯æˆ–ç‚¹å‡»åœ°å›¾é€‰æ‹©ä½ç½®', 'info');
        }
    } catch (error) {
        console.error('æœç´¢å»ºè®®å¤±è´¥:', error);
        hideSuggestions();
        showSearchTip('ğŸ”§ æœç´¢æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç›´æ¥ç‚¹å‡»åœ°å›¾é€‰æ‹©ä½ç½®', 'warning');
    }
}

// æ˜¾ç¤ºæœç´¢å»ºè®®
function showSuggestions(tips) {
    const suggestionsContainer = document.getElementById('search-suggestions');
    suggestionsContainer.innerHTML = '';
    
    tips.forEach(tip => {
        const suggestionItem = document.createElement('div');
        suggestionItem.className = 'suggestion-item';
        
        suggestionItem.innerHTML = `
            <div class="suggestion-name">${tip.name}</div>
            <div class="suggestion-address">${tip.address || tip.district}</div>
        `;
        
        suggestionItem.addEventListener('click', function() {
            selectSuggestion(tip);
        });
        
        suggestionsContainer.appendChild(suggestionItem);
    });
    
    suggestionsContainer.style.display = 'block';
}

// éšè—æœç´¢å»ºè®®
function hideSuggestions() {
    const suggestionsContainer = document.getElementById('search-suggestions');
    suggestionsContainer.style.display = 'none';
}

// é€‰æ‹©å»ºè®®é¡¹
function selectSuggestion(tip) {
    const searchInput = document.getElementById('map-search-input');
    searchInput.value = tip.name;
    
    hideSuggestions();
    
    // å¦‚æœæœ‰ä½ç½®ä¿¡æ¯ï¼Œç›´æ¥å®šä½
    if (tip.location) {
        const lng = typeof tip.location.lng !== 'undefined' ? tip.location.lng : tip.location.getLng();
        const lat = typeof tip.location.lat !== 'undefined' ? tip.location.lat : tip.location.getLat();
        
        // ç§»åŠ¨åœ°å›¾ä¸­å¿ƒå’Œæ ‡è®°
        if (map && marker) {
            map.setCenter([lng, lat]);
            marker.setPosition([lng, lat]);
            
            // æ›´æ–°é€‰ä¸­çš„ä½ç½®ä¿¡æ¯
            selectedLocation = {
                lng: lng,
                lat: lat,
                address: tip.name + (tip.address ? ' - ' + tip.address : ''),
                name: tip.name
            };
            
            document.getElementById('selected-location-text').textContent = selectedLocation.address;
            document.querySelector('.btn-confirm').disabled = false;
        }
    } else {
        // æ²¡æœ‰ä½ç½®ä¿¡æ¯ï¼Œè¿›è¡Œæœç´¢
        searchLocation();
    }
}

// åœ°ç‚¹ä¸‹æ‹‰æœç´¢ç›¸å…³å‡½æ•°
async function searchLocationDropdown(query) {
    if (!query || query.length < 2) {
        hideLocationDropdown();
        return;
    }

    try {
        const response = await fetch('/tools/api/map/search-location/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ query: query })
        });

        const data = await response.json();
        
        if (data.success && data.suggestions && data.suggestions.length > 0) {
            displayLocationSuggestions(data.suggestions);
        } else {
            showLocationDropdown(); // æ˜¾ç¤ºç©ºçš„ä¸‹æ‹‰
        }
    } catch (error) {
        console.error('åœ°ç‚¹æœç´¢å¤±è´¥:', error);
        showLocationDropdown(); // æ˜¾ç¤ºç©ºçš„ä¸‹æ‹‰
    }
}

function displayLocationSuggestions(suggestions) {
    const dropdown = document.getElementById('location-dropdown');
    const suggestionsContainer = document.getElementById('location-suggestions');
    
    suggestionsContainer.innerHTML = '';
    
    suggestions.slice(0, 8).forEach(item => {
        const suggestionItem = document.createElement('div');
        suggestionItem.className = 'location-suggestion-item';
        
        suggestionItem.innerHTML = `
            <div class="location-suggestion-icon">
                <i class="fas fa-map-marker-alt"></i>
            </div>
            <div class="location-suggestion-content">
                <div class="location-suggestion-name">${item.name || item.address}</div>
                <div class="location-suggestion-address">${item.address || item.city || ''}</div>
            </div>
        `;
        
        suggestionItem.addEventListener('click', function() {
            selectLocationSuggestion(item);
        });
        
        suggestionsContainer.appendChild(suggestionItem);
    });
    
    dropdown.style.display = 'block';
}

function selectLocationSuggestion(item) {
    const locationInput = document.getElementById('location');
    const latInput = document.getElementById('latitude');
    const lonInput = document.getElementById('longitude');
    
    // è®¾ç½®åœ°ç‚¹åç§°
    locationInput.value = item.name || item.address;
    
    // è®¾ç½®åæ ‡
    const lat = item.lat || item.latitude;
    const lon = item.lon || item.longitude || item.lng;
    
    if (lat) {
        latInput.value = lat;
    }
    if (lon) {
        lonInput.value = lon;
    }
    
    // æ›´æ–°åœ°å›¾é€‰æ‹©å™¨ä¸­çš„åœ°å€æ˜¾ç¤º
    updateMapSelectedLocation({
        name: item.name || item.address,
        address: item.address || '',
        lat: lat,
        lng: lon
    });
    
    hideLocationDropdown();
}

function showLocationDropdown() {
    const dropdown = document.getElementById('location-dropdown');
    const suggestionsContainer = document.getElementById('location-suggestions');
    
    // å¦‚æœæ²¡æœ‰å»ºè®®ï¼Œæ¸…ç©ºå»ºè®®å®¹å™¨
    if (!suggestionsContainer.children.length) {
        suggestionsContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">è¾“å…¥åœ°ç‚¹åç§°å¼€å§‹æœç´¢</div>';
    }
    
    dropdown.style.display = 'block';
}

function hideLocationDropdown() {
    const dropdown = document.getElementById('location-dropdown');
    dropdown.style.display = 'none';
}

function getCurrentLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                const locationText = `å½“å‰ä½ç½® (${lat.toFixed(4)}, ${lon.toFixed(4)})`;
                
                // æ›´æ–°è¡¨å•å­—æ®µ
                const locationInput = document.getElementById('location');
                document.getElementById('latitude').value = lat;
                document.getElementById('longitude').value = lon;
                locationInput.value = locationText;
                
                // è§¦å‘è¾“å…¥æ¡†äº‹ä»¶ç¡®ä¿æ ·å¼æ›´æ–°
                locationInput.dispatchEvent(new Event('input'));
                locationInput.dispatchEvent(new Event('change'));
                
                // æ›´æ–°åœ°å›¾é€‰æ‹©å™¨ä¸­çš„åœ°å€æ˜¾ç¤º
                updateMapSelectedLocation({
                    name: locationText,
                    address: locationText,
                    lat: lat,
                    lng: lon
                });
                
                hideLocationDropdown();
            },
            function(error) {
                alert('æ— æ³•è·å–å½“å‰ä½ç½®ï¼š' + error.message);
            }
        );
    } else {
        alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†å®šä½');
    }
}

function clearLocationSearch() {
    document.getElementById('location').value = '';
    document.getElementById('latitude').value = '';
    document.getElementById('longitude').value = '';
    
    // æ¸…é™¤åœ°å›¾é€‰æ‹©å™¨ä¸­çš„åœ°å€æ˜¾ç¤º
    clearMapSelectedLocation();
    
    hideLocationDropdown();
}

// æ›´æ–°åœ°å›¾é€‰æ‹©å™¨ä¸­çš„åœ°å€æ˜¾ç¤º
function updateMapSelectedLocation(location) {
    // æ›´æ–°åœ°å›¾é€‰æ‹©å™¨ä¸­çš„æ˜¾ç¤ºæ–‡æœ¬
    const selectedLocationText = document.getElementById('selected-location-text');
    if (selectedLocationText) {
        selectedLocationText.textContent = location.address || location.name;
    }
    
    // æ›´æ–°å…¨å±€é€‰ä¸­ä½ç½®å˜é‡
    if (typeof selectedLocation !== 'undefined') {
        selectedLocation = {
            lng: location.lng,
            lat: location.lat,
            address: location.address || location.name,
            name: location.name
        };
    }
    
    // å¦‚æœåœ°å›¾å·²ç»åˆå§‹åŒ–ï¼Œæ›´æ–°åœ°å›¾ä¸­å¿ƒå’Œæ ‡è®°
    if (typeof map !== 'undefined' && map && location.lat && location.lng) {
        map.setCenter([location.lng, location.lat]);
        if (typeof marker !== 'undefined' && marker) {
            marker.setPosition([location.lng, location.lat]);
        }
    }
    
    // å¯ç”¨ç¡®è®¤æŒ‰é’®
    const confirmBtn = document.querySelector('.btn-confirm');
    if (confirmBtn) {
        confirmBtn.disabled = false;
    }
}

// æ¸…é™¤åœ°å›¾é€‰æ‹©å™¨ä¸­çš„åœ°å€æ˜¾ç¤º
function clearMapSelectedLocation() {
    const selectedLocationText = document.getElementById('selected-location-text');
    if (selectedLocationText) {
        selectedLocationText.textContent = 'è¯·é€‰æ‹©æ´»åŠ¨åœ°ç‚¹';
    }
    
    // æ¸…é™¤å…¨å±€é€‰ä¸­ä½ç½®å˜é‡
    if (typeof selectedLocation !== 'undefined') {
        selectedLocation = null;
    }
    
    // ç¦ç”¨ç¡®è®¤æŒ‰é’®
    const confirmBtn = document.querySelector('.btn-confirm');
    if (confirmBtn) {
        confirmBtn.disabled = true;
    }
}

// è·å–CSRF Token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// é¡µé¢åŠ è½½å®Œæˆåè®¾ç½®é»˜è®¤æ—¶é—´
document.addEventListener('DOMContentLoaded', function() {
    // è®¾ç½®é»˜è®¤å¼€å§‹æ—¶é—´ä¸º1å°æ—¶å
    const now = new Date();
    const oneHourLater = new Date(now.getTime() + 60 * 60 * 1000);
    const twoHoursLater = new Date(now.getTime() + 2 * 60 * 60 * 1000);
    
    // æ ¼å¼åŒ–ä¸ºdatetime-localæ ¼å¼
    const startTimeString = oneHourLater.toISOString().slice(0, 16);
    const endTimeString = twoHoursLater.toISOString().slice(0, 16);
    
    document.getElementById('start_time').value = startTimeString;
    document.getElementById('end_time').value = endTimeString;
    
    // åœ°ç‚¹è¾“å…¥æ¡†äº‹ä»¶ç»‘å®š
    const locationInput = document.getElementById('location');
    let locationSearchTimeout;
    
    // è¾“å…¥æ—¶å®æ—¶æœç´¢
    locationInput.addEventListener('input', function(e) {
        const query = e.target.value.trim();
        if (query.length >= 2) {
            // é˜²æŠ–å¤„ç†
            clearTimeout(locationSearchTimeout);
            locationSearchTimeout = setTimeout(() => {
                searchLocationDropdown(query);
            }, 300);
        } else {
            hideLocationDropdown();
        }
    });
    
    // è·å¾—ç„¦ç‚¹æ—¶æ˜¾ç¤ºä¸‹æ‹‰
    locationInput.addEventListener('focus', function(e) {
        const query = e.target.value.trim();
        if (query.length >= 2) {
            searchLocationDropdown(query);
        } else {
            showLocationDropdown(); // æ˜¾ç¤ºç©ºçš„ä¸‹æ‹‰ï¼ˆåªæœ‰æ“ä½œæŒ‰é’®ï¼‰
        }
    });
    
    // å¤±å»ç„¦ç‚¹æ—¶å»¶è¿Ÿéšè—ä¸‹æ‹‰ï¼ˆå…è®¸ç‚¹å‡»ä¸‹æ‹‰é¡¹ï¼‰
    locationInput.addEventListener('blur', function(e) {
        setTimeout(() => {
            hideLocationDropdown();
        }, 200);
    });
    
    // ç‚¹å‡»å¤–éƒ¨åŒºåŸŸéšè—ä¸‹æ‹‰
    document.addEventListener('click', function(e) {
        const locationGroup = document.querySelector('.location-group');
        if (!locationGroup.contains(e.target)) {
            hideLocationDropdown();
        }
    });
    
    // åœ°å›¾æœç´¢æ¡†äº‹ä»¶ç»‘å®š
    const searchInput = document.getElementById('map-search-input');
    
    // å›è½¦é”®æ”¯æŒ
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchLocation();
        }
    });
    
    // è¾“å…¥æ—¶æœç´¢å»ºè®®
    searchInput.addEventListener('input', function(e) {
        const query = e.target.value.trim();
        if (query.length >= 2) {
            // é˜²æŠ–å¤„ç†
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                searchSuggestions(query);
            }, 300);
        } else {
            hideSuggestions();
        }
    });
    
    // å¤±å»ç„¦ç‚¹æ—¶éšè—å»ºè®®
    searchInput.addEventListener('blur', function() {
        setTimeout(() => {
            hideSuggestions();
        }, 200); // å»¶è¿Ÿéšè—ï¼Œå…è®¸ç‚¹å‡»å»ºè®®é¡¹
    });
});

// è´¹ç”¨ç±»å‹å˜åŒ–æ—¶çš„å¤„ç†
document.getElementById('cost_type').addEventListener('change', function() {
    const estimatedCostInput = document.getElementById('estimated_cost');
    if (this.value === 'free') {
        estimatedCostInput.value = '0';
        estimatedCostInput.disabled = true;
    } else {
        estimatedCostInput.disabled = false;
        if (estimatedCostInput.value === '0') {
            estimatedCostInput.value = '';
        }
    }
});
</script>
{% endblock %}

