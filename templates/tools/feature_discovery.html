{% extends 'base.html' %}
{% load static %}

{% block title %}功能发现 - ModeShift{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/feature-recommendation.css' %}">
<style>
    .discovery-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 3rem 0;
        margin-bottom: 2rem;
        text-align: center;
    }
    
    .discovery-header h1 {
        font-size: 2.5rem;
        margin-bottom: 1rem;
    }
    
    .discovery-header p {
        font-size: 1.2rem;
        opacity: 0.9;
    }
    
    .loading-spinner {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 200px;
    }
    
    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #6c757d;
    }
    
    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    
    .pagination {
        justify-content: center;
        margin-top: 2rem;
    }
    
    .page-link {
        color: #667eea;
        border-color: #dee2e6;
    }
    
    .page-link:hover {
        color: #5a67d8;
        background-color: #e7f1ff;
        border-color: #667eea;
    }
    
    .page-item.active .page-link {
        background-color: #667eea;
        border-color: #667eea;
    }
</style>
{% endblock %}

{% block content %}
<div class="discovery-header">
    <div class="container">
        <h1><i class="fas fa-compass"></i> 功能发现</h1>
        <p>探索更多有趣实用的功能</p>
    </div>
</div>

<div class="container">
    <!-- 筛选器 -->
    <div class="feature-filters">
        <div class="filter-group">
            <label>功能类型</label>
            <select id="typeFilter">
                <option value="">全部类型</option>
                {% for type_value, type_display in feature_types %}
                <option value="{{ type_value }}">{{ type_display }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="filter-group">
            <label>功能分类</label>
            <select id="categoryFilter">
                <option value="">全部分类</option>
                {% for category_value, category_display in categories %}
                <option value="{{ category_value }}">{{ category_display }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="filter-group">
            <label>搜索功能</label>
            <input type="text" id="searchInput" placeholder="输入功能名称...">
        </div>
        
        <div class="filter-group">
            <label>&nbsp;</label>
            <button id="resetFilters" class="btn btn-secondary">重置筛选</button>
        </div>
    </div>

    <!-- 加载状态 -->
    <div id="loadingSpinner" class="loading-spinner" style="display: none;">
        <div class="spinner"></div>
    </div>

    <!-- 功能网格 -->
    <div id="featuresGrid" class="feature-grid">
        <!-- 功能卡片将通过JavaScript动态加载 -->
    </div>

    <!-- 空状态 -->
    <div id="emptyState" class="empty-state" style="display: none;">
        <i class="fas fa-search"></i>
        <h4>没有找到匹配的功能</h4>
        <p>请尝试调整筛选条件或搜索关键词</p>
    </div>

    <!-- 分页 -->
    <nav id="paginationNav" style="display: none;">
        <ul class="pagination">
            <!-- 分页按钮将通过JavaScript动态生成 -->
        </ul>
    </nav>
</div>
{% endblock %}

{% block extra_js %}
<script>
class FeatureDiscoveryPage {
    constructor() {
        this.currentPage = 1;
        this.pageSize = 12;
        this.currentFilters = {
            type: '',
            category: '',
            search: ''
        };
        this.init();
    }

    init() {
        this.bindEvents();
        this.loadFeatures();
    }

    bindEvents() {
        // 筛选器事件
        document.getElementById('typeFilter').addEventListener('change', (e) => {
            this.currentFilters.type = e.target.value;
            this.currentPage = 1;
            this.loadFeatures();
        });

        document.getElementById('categoryFilter').addEventListener('change', (e) => {
            this.currentFilters.category = e.target.value;
            this.currentPage = 1;
            this.loadFeatures();
        });

        // 搜索输入防抖
        let searchTimeout;
        document.getElementById('searchInput').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                this.currentFilters.search = e.target.value;
                this.currentPage = 1;
                this.loadFeatures();
            }, 500);
        });

        // 重置筛选
        document.getElementById('resetFilters').addEventListener('click', () => {
            this.resetFilters();
        });
    }

    async loadFeatures() {
        this.showLoading(true);

        const params = new URLSearchParams({
            page: this.currentPage,
            page_size: this.pageSize,
            ...this.currentFilters
        });

        try {
            const response = await fetch(`/tools/api/feature_list/?${params}`);
            const data = await response.json();

            if (data.success) {
                this.renderFeatures(data.features);
                this.renderPagination(data);
            } else {
                console.error('加载功能失败:', data.error);
                this.showEmptyState('加载失败，请稍后重试');
            }
        } catch (error) {
            console.error('请求失败:', error);
            this.showEmptyState('网络错误，请检查连接');
        } finally {
            this.showLoading(false);
        }
    }

    renderFeatures(features) {
        const grid = document.getElementById('featuresGrid');
        
        if (features.length === 0) {
            this.showEmptyState();
            return;
        }

        this.hideEmptyState();

        grid.innerHTML = features.map(feature => `
            <div class="feature-item">
                <div class="feature-header">
                    <div class="feature-icon" style="color: ${feature.icon_color}">
                        <i class="${feature.icon_class}"></i>
                    </div>
                    <h4 class="feature-title">${feature.name}</h4>
                </div>
                <p class="feature-description">${feature.description}</p>
                <div class="feature-footer">
                    <span class="feature-category">${feature.category_display}</span>
                    <a href="/tools/${feature.url_name}/" class="feature-action">
                        <i class="fas fa-arrow-right"></i> 体验
                    </a>
                </div>
            </div>
        `).join('');
    }

    renderPagination(data) {
        const nav = document.getElementById('paginationNav');
        const pagination = nav.querySelector('.pagination');
        
        if (data.total_count <= this.pageSize) {
            nav.style.display = 'none';
            return;
        }

        nav.style.display = 'block';
        const totalPages = Math.ceil(data.total_count / this.pageSize);
        
        let paginationHTML = '';
        
        // 上一页
        if (data.has_prev) {
            paginationHTML += `
                <li class="page-item">
                    <a class="page-link" href="#" data-page="${this.currentPage - 1}">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
            `;
        }

        // 页码
        const startPage = Math.max(1, this.currentPage - 2);
        const endPage = Math.min(totalPages, this.currentPage + 2);

        for (let i = startPage; i <= endPage; i++) {
            paginationHTML += `
                <li class="page-item ${i === this.currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" data-page="${i}">${i}</a>
                </li>
            `;
        }

        // 下一页
        if (data.has_next) {
            paginationHTML += `
                <li class="page-item">
                    <a class="page-link" href="#" data-page="${this.currentPage + 1}">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            `;
        }

        pagination.innerHTML = paginationHTML;

        // 绑定分页点击事件
        pagination.addEventListener('click', (e) => {
            e.preventDefault();
            const page = e.target.closest('[data-page]')?.dataset.page;
            if (page) {
                this.currentPage = parseInt(page);
                this.loadFeatures();
            }
        });
    }

    showLoading(show) {
        document.getElementById('loadingSpinner').style.display = show ? 'flex' : 'none';
        document.getElementById('featuresGrid').style.display = show ? 'none' : 'grid';
    }

    showEmptyState(message = null) {
        const emptyState = document.getElementById('emptyState');
        const grid = document.getElementById('featuresGrid');
        const pagination = document.getElementById('paginationNav');
        
        if (message) {
            emptyState.querySelector('p').textContent = message;
        }
        
        emptyState.style.display = 'block';
        grid.style.display = 'none';
        pagination.style.display = 'none';
    }

    hideEmptyState() {
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('featuresGrid').style.display = 'grid';
    }

    resetFilters() {
        document.getElementById('typeFilter').value = '';
        document.getElementById('categoryFilter').value = '';
        document.getElementById('searchInput').value = '';
        
        this.currentFilters = {
            type: '',
            category: '',
            search: ''
        };
        this.currentPage = 1;
        this.loadFeatures();
    }
}

// 页面初始化
document.addEventListener('DOMContentLoaded', function() {
    new FeatureDiscoveryPage();
});
</script>
{% endblock %}