{% extends 'base.html' %}
{% load static %}

{% block title %}抖音视频分析 - 极客工具箱{% endblock %}

{% block extra_css %}
<style>
    .douyin-analyzer {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
    }
    
    .analyzer-container {
        max-width: 1200px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }
    
    .analyzer-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
    }
    
    .analyzer-header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        font-weight: 700;
    }
    
    .analyzer-header p {
        font-size: 1.1rem;
        opacity: 0.9;
    }
    
    .analyzer-content {
        padding: 30px;
    }
    
    .input-section {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 30px;
        border: 2px solid #e9ecef;
    }
    
    .url-input {
        display: flex;
        gap: 15px;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .url-input input {
        flex: 1;
        padding: 15px 20px;
        border: 2px solid #dee2e6;
        border-radius: 10px;
        font-size: 1rem;
        transition: all 0.3s ease;
    }
    
    .url-input input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .analyze-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 10px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
    }
    
    .analyze-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }
    
    .analyze-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }
    
    .progress-section {
        display: none;
        text-align: center;
        padding: 20px;
    }
    
    .progress-bar {
        width: 100%;
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
        margin: 15px 0;
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        width: 0%;
        transition: width 0.3s ease;
    }
    
    .results-section {
        display: none;
        margin-top: 30px;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        border: 1px solid #e9ecef;
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: #667eea;
        margin-bottom: 5px;
    }
    
    .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
    }
    
    .content-section {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .section-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .section-title i {
        color: #667eea;
    }
    
    .tags-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 20px;
    }
    
    .tag {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 500;
    }
    
    .videos-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    
    .video-card {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        border: 1px solid #e9ecef;
        transition: transform 0.3s ease;
    }
    
    .video-card:hover {
        transform: translateY(-5px);
    }
    
    .video-thumbnail {
        width: 100%;
        height: 180px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 3rem;
    }
    
    .video-info {
        padding: 15px;
    }
    
    .video-title {
        font-weight: 600;
        margin-bottom: 10px;
        color: #333;
        line-height: 1.4;
    }
    
    .video-stats {
        display: flex;
        justify-content: space-between;
        color: #6c757d;
        font-size: 0.9rem;
    }
    
    .product-preview-section {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 15px;
        padding: 25px;
        margin-top: 20px;
    }
    
    .preview-content {
        background: white;
        border-radius: 10px;
        padding: 20px;
        border-left: 4px solid #667eea;
        line-height: 1.6;
        color: #333;
    }
    
    .generate-preview-btn {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 15px;
    }
    
    .generate-preview-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 15px rgba(40, 167, 69, 0.3);
    }
    
    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        border: 1px solid #f5c6cb;
    }
    
    .success-message {
        background: #d4edda;
        color: #155724;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        border: 1px solid #c3e6cb;
    }
</style>
{% endblock %}

{% block content %}
<div class="douyin-analyzer">
    <div class="analyzer-container">
        <div class="analyzer-header">
            <h1><i class="fas fa-video"></i> 抖音视频分析</h1>
            <p>深度分析抖音UP主内容，生成产品功能预览</p>
        </div>
        
        <div class="analyzer-content">
            <!-- 输入区域 -->
            <div class="input-section">
                <h3><i class="fas fa-link"></i> 输入UP主主页URL</h3>
                <div class="url-input">
                    <input type="url" id="up主Url" placeholder="请输入抖音UP主主页URL，例如：https://www.douyin.com/user/xxx" />
                    <button class="analyze-btn" id="analyzeBtn" onclick="startAnalysis()">
                        <span id="analyzeBtnText">开始分析</span>
                        <div class="loading-spinner" id="analyzeSpinner" style="display: none;"></div>
                    </button>
                </div>
                <p style="color: #6c757d; font-size: 0.9rem; margin: 0;">
                    <i class="fas fa-info-circle"></i> 
                    使用真实爬虫技术分析UP主的视频内容、粉丝数据、互动情况等，并生成创新的产品功能预览
                </p>
            </div>
            
            <!-- 进度区域 -->
            <div class="progress-section" id="progressSection">
                <h3><i class="fas fa-cogs"></i> 正在分析中...</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <p id="progressText">正在访问抖音主页并爬取UP主数据...</p>
            </div>
            
            <!-- 结果区域 -->
            <div class="results-section" id="resultsSection">
                <!-- 数据来源说明 -->
                <div class="data-source-info" style="background: #e8f4fd; border: 1px solid #bee5eb; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-database" style="color: #17a2b8; font-size: 1.2rem;"></i>
                        <div>
                            <strong style="color: #17a2b8;">真实数据来源</strong>
                            <p style="margin: 5px 0 0 0; color: #6c757d; font-size: 0.9rem;">
                                数据通过真实爬虫技术从抖音平台获取，基于UP主实际发布的内容进行分析
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- 统计数据 -->
                <div class="content-section">
                    <h3 class="section-title">
                        <i class="fas fa-chart-bar"></i> 数据分析
                    </h3>
                    <div class="stats-grid" id="statsGrid"></div>
                </div>
                
                <!-- 内容分析 -->
                <div class="content-section">
                    <h3 class="section-title">
                        <i class="fas fa-tags"></i> 内容主题
                    </h3>
                    <div class="tags-container" id="contentThemes"></div>
                    
                    <h3 class="section-title">
                        <i class="fas fa-hashtag"></i> 热门标签
                    </h3>
                    <div class="tags-container" id="videoTags"></div>
                </div>
                
                <!-- 热门视频 -->
                <div class="content-section">
                    <h3 class="section-title">
                        <i class="fas fa-fire"></i> 热门视频
                    </h3>
                    <div class="videos-grid" id="videosGrid"></div>
                </div>
                
                <!-- 产品功能预览 -->
                <div class="product-preview-section">
                    <h3 class="section-title">
                        <i class="fas fa-lightbulb"></i> 产品功能预览
                    </h3>
                    <div id="previewContent">
                        <p style="color: #6c757d; text-align: center; padding: 40px;">
                            <i class="fas fa-magic" style="font-size: 3rem; margin-bottom: 20px; display: block; color: #667eea;"></i>
                            基于分析结果，AI将为您生成创新的产品功能预览
                        </p>
                        <button class="generate-preview-btn" onclick="generateProductPreview()">
                            <i class="fas fa-magic"></i> 生成产品预览
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentAnalysisId = null;

function startAnalysis() {
    const urlInput = document.getElementById('up主Url');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const analyzeBtnText = document.getElementById('analyzeBtnText');
    const analyzeSpinner = document.getElementById('analyzeSpinner');
    const progressSection = document.getElementById('progressSection');
    const resultsSection = document.getElementById('resultsSection');
    
    const up主Url = urlInput.value.trim();
    
    if (!up主Url) {
        showMessage('请输入UP主主页URL', 'error');
        return;
    }
    
    if (!up主Url.includes('douyin.com')) {
        showMessage('请输入有效的抖音UP主主页URL', 'error');
        return;
    }
    
    // 显示加载状态
    analyzeBtn.disabled = true;
    analyzeBtnText.textContent = '分析中...';
    analyzeSpinner.style.display = 'inline-block';
    progressSection.style.display = 'block';
    resultsSection.style.display = 'none';
    
    // 模拟进度
    let progress = 0;
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    
    const progressInterval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 90) progress = 90;
        progressFill.style.width = progress + '%';
        
        if (progress < 30) {
            progressText.textContent = '正在访问抖音主页并解析用户信息...';
        } else if (progress < 60) {
            progressText.textContent = '正在爬取视频数据和内容分析...';
        } else {
            progressText.textContent = '正在生成详细分析报告...';
        }
    }, 500);
    
    // 发送分析请求
    fetch('/tools/api/douyin_analysis/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            up主_url: up主Url
        })
    })
    .then(response => response.json())
    .then(data => {
        clearInterval(progressInterval);
        
        if (data.success) {
            currentAnalysisId = data.analysis_id;
            progressFill.style.width = '100%';
            progressText.textContent = '分析完成！';
            
            setTimeout(() => {
                loadAnalysisResults(data.analysis_id);
            }, 1000);
        } else {
            showMessage(data.error, 'error');
            resetAnalyzeButton();
        }
    })
    .catch(error => {
        clearInterval(progressInterval);
        showMessage('网络错误，请重试', 'error');
        resetAnalyzeButton();
    });
}

function loadAnalysisResults(analysisId) {
    fetch(`/tools/api/douyin_analysis/result/?analysis_id=${analysisId}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayResults(data.analysis);
        } else {
            showMessage(data.error, 'error');
        }
    })
    .catch(error => {
        showMessage('加载分析结果失败', 'error');
    });
}

function displayResults(analysis) {
    // 隐藏进度区域，显示结果区域
    document.getElementById('progressSection').style.display = 'none';
    document.getElementById('resultsSection').style.display = 'block';
    
    // 重置按钮状态
    resetAnalyzeButton();
    
    // 检查是否为演示数据并显示提示
    if (analysis.error_message && analysis.error_message.includes('演示数据')) {
        showDemoDataNotice(analysis.error_message);
    }
    
    // 显示统计数据
    const statsGrid = document.getElementById('statsGrid');
    statsGrid.innerHTML = `
        <div class="stat-card">
            <div class="stat-number">${analysis.video_count.toLocaleString()}</div>
            <div class="stat-label">视频总数</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${analysis.follower_count.toLocaleString()}</div>
            <div class="stat-label">粉丝数量</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${analysis.total_likes.toLocaleString()}</div>
            <div class="stat-label">总点赞数</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${analysis.total_comments.toLocaleString()}</div>
            <div class="stat-label">总评论数</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${analysis.total_shares.toLocaleString()}</div>
            <div class="stat-label">总分享数</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${analysis.posting_frequency}</div>
            <div class="stat-label">发布频率</div>
        </div>
    `;
    
    // 显示内容主题
    const contentThemes = document.getElementById('contentThemes');
    contentThemes.innerHTML = analysis.content_themes.map(theme => 
        `<span class="tag">${theme}</span>`
    ).join('');
    
    // 显示视频标签
    const videoTags = document.getElementById('videoTags');
    videoTags.innerHTML = analysis.video_tags.map(tag => 
        `<span class="tag">${tag}</span>`
    ).join('');
    
    // 显示热门视频
    const videosGrid = document.getElementById('videosGrid');
    videosGrid.innerHTML = analysis.videos.map(video => `
        <div class="video-card">
            <div class="video-thumbnail">
                <i class="fas fa-play"></i>
            </div>
            <div class="video-info">
                <div class="video-title">${video.title}</div>
                <div class="video-stats">
                    <span><i class="fas fa-heart"></i> ${video.likes.toLocaleString()}</span>
                    <span><i class="fas fa-comment"></i> ${video.comments.toLocaleString()}</span>
                    <span><i class="fas fa-share"></i> ${video.shares.toLocaleString()}</span>
                </div>
            </div>
        </div>
    `).join('');
}

function generateProductPreview() {
    if (!currentAnalysisId) {
        showMessage('请先完成UP主分析', 'error');
        return;
    }
    
    const previewContent = document.getElementById('previewContent');
    previewContent.innerHTML = `
        <div style="text-align: center; padding: 40px;">
            <div class="loading-spinner" style="width: 40px; height: 40px; margin: 0 auto 20px;"></div>
            <p>AI正在生成产品功能预览...</p>
        </div>
    `;
    
    fetch('/tools/api/douyin_analysis/preview/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            analysis_id: currentAnalysisId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            previewContent.innerHTML = `
                <div class="preview-content">
                    ${data.product_preview.replace(/\n/g, '<br>')}
                </div>
            `;
        } else {
            previewContent.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle"></i> ${data.error}
                </div>
                <button class="generate-preview-btn" onclick="generateProductPreview()">
                    <i class="fas fa-redo"></i> 重新生成
                </button>
            `;
        }
    })
    .catch(error => {
        previewContent.innerHTML = `
            <div class="error-message">
                <i class="fas fa-exclamation-triangle"></i> 生成失败，请重试
            </div>
            <button class="generate-preview-btn" onclick="generateProductPreview()">
                <i class="fas fa-redo"></i> 重新生成
            </button>
        `;
    });
}

function resetAnalyzeButton() {
    const analyzeBtn = document.getElementById('analyzeBtn');
    const analyzeBtnText = document.getElementById('analyzeBtnText');
    const analyzeSpinner = document.getElementById('analyzeSpinner');
    
    analyzeBtn.disabled = false;
    analyzeBtnText.textContent = '开始分析';
    analyzeSpinner.style.display = 'none';
}

function showMessage(message, type) {
    const messageDiv = document.createElement('div');
    messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
    messageDiv.innerHTML = `<i class="fas fa-${type === 'error' ? 'exclamation-triangle' : 'check-circle'}"></i> ${message}`;
    
    const container = document.querySelector('.analyzer-content');
    container.insertBefore(messageDiv, container.firstChild);
    
    setTimeout(() => {
        messageDiv.remove();
    }, 5000);
}

function showDemoDataNotice(message) {
    const noticeDiv = document.createElement('div');
    noticeDiv.className = 'demo-notice';
    noticeDiv.innerHTML = `
        <div class="demo-notice-content">
            <i class="fas fa-info-circle"></i>
            <div class="demo-text">
                <strong>演示模式</strong>
                <p>${message}</p>
                <small>由于抖音反爬虫限制，当前显示为功能演示数据</small>
            </div>
            <button class="retry-btn" onclick="retryAnalysis()">
                <i class="fas fa-redo"></i> 重试获取真实数据
            </button>
        </div>
    `;
    
    const resultsSection = document.getElementById('resultsSection');
    resultsSection.insertBefore(noticeDiv, resultsSection.firstChild);
}

function retryAnalysis() {
    // 移除演示数据提示
    const demoNotice = document.querySelector('.demo-notice');
    if (demoNotice) {
        demoNotice.remove();
    }
    
    // 重新开始分析
    const urlInput = document.getElementById('up主Url');
    if (urlInput.value.trim()) {
        analyzeUp主();
    } else {
        showMessage('请输入UP主URL', 'error');
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %} 