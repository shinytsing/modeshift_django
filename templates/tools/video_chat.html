{% extends 'base.html' %}
{% load static %}

{% block title %}è§†é¢‘å¯¹è¯ - QAToolBox{% endblock %}

{% block extra_css %}
<style>
.video-chat-container {
    max-width: 1200px;
    margin: 20px auto;
    padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    color: white;
}

.chat-header {
    text-align: center;
    margin-bottom: 30px;
}

.chat-title {
    font-size: 2.5em;
    margin-bottom: 10px;
    font-weight: 700;
}

.chat-subtitle {
    font-size: 1.2em;
    opacity: 0.9;
}

.video-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 30px;
}

.video-container {
    position: relative;
    background: rgba(0,0,0,0.3);
    border-radius: 15px;
    overflow: hidden;
    aspect-ratio: 16/9;
}

.video-element {
    width: 100%;
    height: 100%;
    object-fit: cover;
    background: #000;
}

.video-label {
    position: absolute;
    bottom: 10px;
    left: 10px;
    background: rgba(0,0,0,0.7);
    color: white;
    padding: 5px 10px;
    border-radius: 5px;
    font-size: 0.9em;
}

.controls-container {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-bottom: 30px;
    flex-wrap: wrap;
}

.control-button {
    background: rgba(255,255,255,0.2);
    border: 2px solid rgba(255,255,255,0.3);
    color: white;
    padding: 12px 25px;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
    font-size: 1em;
    display: flex;
    align-items: center;
    gap: 8px;
}

.control-button:hover {
    background: rgba(255,255,255,0.3);
    transform: translateY(-2px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.control-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

.control-button.active {
    background: rgba(40,167,69,0.3);
    border-color: rgba(40,167,69,0.5);
}

.control-button.danger {
    background: rgba(220,53,69,0.3);
    border-color: rgba(220,53,69,0.5);
}

.control-button.danger:hover {
    background: rgba(220,53,69,0.4);
}

.status-message {
    text-align: center;
    margin: 20px 0;
    padding: 15px;
    border-radius: 10px;
    font-size: 1.1em;
    background: rgba(255,255,255,0.1);
    backdrop-filter: blur(10px);
}

.status-waiting {
    background: rgba(255,193,7,0.2);
    border: 1px solid rgba(255,193,7,0.3);
}

.status-success {
    background: rgba(40,167,69,0.2);
    border: 1px solid rgba(40,167,69,0.3);
}

.status-error {
    background: rgba(220,53,69,0.2);
    border: 1px solid rgba(220,53,69,0.3);
}

.chat-info {
    background: rgba(255,255,255,0.1);
    padding: 20px;
    border-radius: 15px;
    margin-top: 20px;
    backdrop-filter: blur(10px);
}

.chat-info h3 {
    margin-bottom: 15px;
    text-align: center;
}

.connection-status {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding: 10px;
    background: rgba(255,255,255,0.1);
    border-radius: 10px;
}

.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 10px;
}

.status-online {
    background: #28a745;
    box-shadow: 0 0 10px rgba(40,167,69,0.5);
}

.status-offline {
    background: #dc3545;
}

.status-connecting {
    background: #ffc107;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.settings-panel {
    background: rgba(255,255,255,0.1);
    padding: 20px;
    border-radius: 15px;
    margin-top: 20px;
    backdrop-filter: blur(10px);
}

.settings-panel h3 {
    margin-bottom: 15px;
    text-align: center;
}

.setting-group {
    margin-bottom: 15px;
}

.setting-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
}

.setting-group select,
.setting-group input {
    width: 100%;
    padding: 8px 12px;
    border: none;
    border-radius: 8px;
    background: rgba(255,255,255,0.2);
    color: white;
    backdrop-filter: blur(10px);
}

.setting-group select option {
    background: #333;
    color: white;
}

.setting-group input::placeholder {
    color: rgba(255,255,255,0.7);
}

@media (max-width: 768px) {
    .video-grid {
        grid-template-columns: 1fr;
    }
    
    .controls-container {
        flex-direction: column;
        align-items: center;
    }
    
    .control-button {
        width: 100%;
        max-width: 200px;
        justify-content: center;
    }
    
    .chat-title {
        font-size: 2em;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="video-chat-container">
    <div class="chat-header">
        <h1 class="chat-title">ğŸ“¹ è§†é¢‘å¯¹è¯</h1>
        <p class="chat-subtitle">ä¸ {{ other_user.display_name }} è¿›è¡Œå®æ—¶è§†é¢‘é€šè¯</p>
    </div>
    
    <div class="video-grid">
        <div class="video-container">
            <video id="localVideo" class="video-element" autoplay muted playsinline></video>
            <div class="video-label">æˆ‘ ({{ user.username }})</div>
        </div>
        <div class="video-container">
            <video id="remoteVideo" class="video-element" autoplay playsinline></video>
            <div class="video-label">{{ other_user.display_name }}</div>
        </div>
    </div>
    
    <div class="controls-container">
        <button id="startButton" class="control-button" onclick="startVideoChat()">
            <i class="fas fa-video"></i> å¼€å§‹è§†é¢‘
        </button>
        <button id="stopButton" class="control-button danger" onclick="stopVideoChat()" style="display: none;">
            <i class="fas fa-stop"></i> ç»“æŸé€šè¯
        </button>
        <button id="muteButton" class="control-button" onclick="toggleMute()" style="display: none;">
            <i class="fas fa-microphone"></i> é™éŸ³
        </button>
        <button id="videoButton" class="control-button" onclick="toggleVideo()" style="display: none;">
            <i class="fas fa-video"></i> å…³é—­è§†é¢‘
        </button>
        <button id="screenShareButton" class="control-button" onclick="toggleScreenShare()" style="display: none;">
            <i class="fas fa-desktop"></i> å±å¹•å…±äº«
        </button>
        <button id="returnButton" class="control-button" onclick="returnToTextChat()">
            <i class="fas fa-arrow-left"></i> è¿”å›æ–‡æœ¬èŠå¤©
        </button>
    </div>
    
    <div class="status-message" id="statusMessage" style="display: none;">
        <div id="statusContent"></div>
    </div>
    
    <div class="chat-info">
        <h3>ğŸ“‹ é€šè¯ä¿¡æ¯</h3>
        <div class="connection-status">
            <div>
                <span class="status-indicator" id="connectionStatus"></span>
                <span id="connectionText">æœªè¿æ¥</span>
            </div>
            <div id="callDuration">00:00</div>
        </div>
        <p><strong>æˆ¿é—´ID:</strong> {{ room_id }}</p>
        <p><strong>å‚ä¸è€…:</strong> {{ user.username }} â†” {{ other_user.display_name }}</p>
    </div>
    
    <div class="settings-panel">
        <h3>âš™ï¸ è®¾ç½®</h3>
        <div class="setting-group">
            <label for="cameraSelect">æ‘„åƒå¤´:</label>
            <select id="cameraSelect">
                <option value="">é€‰æ‹©æ‘„åƒå¤´...</option>
            </select>
        </div>
        <div class="setting-group">
            <label for="microphoneSelect">éº¦å…‹é£:</label>
            <select id="microphoneSelect">
                <option value="">é€‰æ‹©éº¦å…‹é£...</option>
            </select>
        </div>
        <div class="setting-group">
            <label for="speakerSelect">æ‰¬å£°å™¨:</label>
            <select id="speakerSelect">
                <option value="">é€‰æ‹©æ‰¬å£°å™¨...</option>
            </select>
        </div>
    </div>
</div>

<script>
let localStream = null;
let remoteStream = null;
let peerConnection = null;
let socket = null;
let isMuted = false;
let isVideoOff = false;
let isScreenSharing = false;
let callStartTime = null;
let callDurationInterval = null;

const configuration = {
    iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' }
    ]
};

// åˆå§‹åŒ–é¡µé¢
document.addEventListener('DOMContentLoaded', function() {
    loadDeviceOptions();
    updateConnectionStatus('offline');
    connectWebSocket();
});

// è¿æ¥WebSocket
function connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const socketUrl = `${protocol}//${window.location.host}/ws/chat/{{ room_id }}/`;
    
    socket = new WebSocket(socketUrl);
    
    socket.onopen = function(event) {

        showStatus('è¿æ¥å·²å»ºç«‹ï¼Œç­‰å¾…å¯¹æ–¹åŠ å…¥...', 'success');
    };
    
    socket.onmessage = function(event) {
        const data = JSON.parse(event.data);
        handleWebSocketMessage(data);
    };
    
    socket.onclose = function(event) {

        if (event.code !== 1000) {
            showStatus('è¿æ¥å·²æ–­å¼€', 'error');
        }
    };
    
    socket.onerror = function(error) {
        console.error('WebSocketé”™è¯¯:', error);
        showStatus('è¿æ¥é”™è¯¯', 'error');
    };
}

// å¤„ç†WebSocketæ¶ˆæ¯
async function handleWebSocketMessage(data) {

    try {
        switch (data.type) {
            case 'video_offer':
                await handleVideoOffer(data.offer);
                break;
                
            case 'video_answer':
                await handleVideoAnswer(data.answer);
                break;
                
            case 'ice_candidate':
                await handleIceCandidate(data.candidate);
                break;
                
            case 'video_call_end':
                showStatus('å¯¹æ–¹å·²ç»“æŸé€šè¯', 'warning');
                stopVideoChat();
                break;
                
            default:

        }
    } catch (error) {
        console.error('å¤„ç†WebSocketæ¶ˆæ¯å¤±è´¥:', error);
    }
}

// å¤„ç†è§†é¢‘offer
async function handleVideoOffer(offer) {

    try {
        if (!peerConnection) {
            await initializeWebRTC(false); // ä¸åˆ›å»ºofferï¼Œåªåˆå§‹åŒ–è¿æ¥
        }
        
        await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
        
        // åˆ›å»ºanswer
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        
        // å‘é€answer
        if (socket && socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({
                type: 'video_answer',
                answer: answer,
                room_id: '{{ room_id }}'
            }));
        }
        
        // æ›´æ–°UIçŠ¶æ€
        document.getElementById('startButton').style.display = 'none';
        document.getElementById('stopButton').style.display = 'inline-flex';
        document.getElementById('muteButton').style.display = 'inline-flex';
        document.getElementById('videoButton').style.display = 'inline-flex';
        document.getElementById('screenShareButton').style.display = 'inline-flex';
        
        showStatus('æ­£åœ¨è¿æ¥å¯¹æ–¹...', 'waiting');
        updateConnectionStatus('online');
        startCallTimer();
        
    } catch (error) {
        console.error('å¤„ç†video offerå¤±è´¥:', error);
        showStatus('è¿æ¥å¤±è´¥', 'error');
    }
}

// å¤„ç†è§†é¢‘answer
async function handleVideoAnswer(answer) {

    if (peerConnection) {
        await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
        showStatus('è§†é¢‘è¿æ¥å·²å»ºç«‹', 'success');
    }
}

// å¤„ç†ICEå€™é€‰
async function handleIceCandidate(candidate) {

    if (peerConnection) {
        await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
    }
}

// åŠ è½½è®¾å¤‡é€‰é¡¹
async function loadDeviceOptions() {
    try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        
        const cameraSelect = document.getElementById('cameraSelect');
        const microphoneSelect = document.getElementById('microphoneSelect');
        const speakerSelect = document.getElementById('speakerSelect');
        
        // æ¸…ç©ºç°æœ‰é€‰é¡¹
        cameraSelect.innerHTML = '<option value="">é€‰æ‹©æ‘„åƒå¤´...</option>';
        microphoneSelect.innerHTML = '<option value="">é€‰æ‹©éº¦å…‹é£...</option>';
        speakerSelect.innerHTML = '<option value="">é€‰æ‹©æ‰¬å£°å™¨...</option>';
        
        devices.forEach(device => {
            const option = document.createElement('option');
            option.value = device.deviceId;
            option.text = device.label || `${device.kind} ${device.deviceId.slice(0, 8)}`;
            
            if (device.kind === 'videoinput') {
                cameraSelect.appendChild(option.cloneNode(true));
            } else if (device.kind === 'audioinput') {
                microphoneSelect.appendChild(option.cloneNode(true));
            } else if (device.kind === 'audiooutput') {
                speakerSelect.appendChild(option.cloneNode(true));
            }
        });
        
        // è®¾ç½®é»˜è®¤è®¾å¤‡
        if (cameraSelect.options.length > 1) cameraSelect.selectedIndex = 1;
        if (microphoneSelect.options.length > 1) microphoneSelect.selectedIndex = 1;
        if (speakerSelect.options.length > 1) speakerSelect.selectedIndex = 1;
        
    } catch (error) {
        console.error('åŠ è½½è®¾å¤‡é€‰é¡¹å¤±è´¥:', error);
        showStatus('æ— æ³•è®¿é—®è®¾å¤‡åˆ—è¡¨', 'error');
    }
}

// å¼€å§‹è§†é¢‘é€šè¯
async function startVideoChat() {
    try {
        showStatus('æ­£åœ¨åˆå§‹åŒ–è§†é¢‘é€šè¯...', 'waiting');
        updateConnectionStatus('connecting');
        
        // è·å–ç”¨æˆ·åª’ä½“
        const constraints = {
            video: {
                deviceId: document.getElementById('cameraSelect').value ? 
                    { exact: document.getElementById('cameraSelect').value } : undefined
            },
            audio: {
                deviceId: document.getElementById('microphoneSelect').value ? 
                    { exact: document.getElementById('microphoneSelect').value } : undefined
            }
        };
        
        localStream = await navigator.mediaDevices.getUserMedia(constraints);
        document.getElementById('localVideo').srcObject = localStream;
        
        // åˆå§‹åŒ–WebRTCè¿æ¥
        await initializeWebRTC();
        
        // æ˜¾ç¤ºæ§åˆ¶æŒ‰é’®
        document.getElementById('startButton').style.display = 'none';
        document.getElementById('stopButton').style.display = 'inline-flex';
        document.getElementById('muteButton').style.display = 'inline-flex';
        document.getElementById('videoButton').style.display = 'inline-flex';
        document.getElementById('screenShareButton').style.display = 'inline-flex';
        
        showStatus('è§†é¢‘é€šè¯å·²å¼€å§‹', 'success');
        updateConnectionStatus('online');
        startCallTimer();
        
    } catch (error) {
        console.error('å¯åŠ¨è§†é¢‘é€šè¯å¤±è´¥:', error);
        showStatus(`å¯åŠ¨å¤±è´¥: ${error.message}`, 'error');
        updateConnectionStatus('offline');
    }
}

// åˆå§‹åŒ–WebRTCè¿æ¥
async function initializeWebRTC(createOffer = true) {
    peerConnection = new RTCPeerConnection(configuration);
    
    // å¦‚æœè¿˜æ²¡æœ‰æœ¬åœ°æµï¼Œå…ˆè·å–
    if (!localStream) {
        const constraints = {
            video: {
                deviceId: document.getElementById('cameraSelect').value ? 
                    { exact: document.getElementById('cameraSelect').value } : undefined
            },
            audio: {
                deviceId: document.getElementById('microphoneSelect').value ? 
                    { exact: document.getElementById('microphoneSelect').value } : undefined
            }
        };
        
        localStream = await navigator.mediaDevices.getUserMedia(constraints);
        document.getElementById('localVideo').srcObject = localStream;
    }
    
    // æ·»åŠ æœ¬åœ°æµ
    localStream.getTracks().forEach(track => {
        peerConnection.addTrack(track, localStream);
    });
    
    // å¤„ç†è¿œç¨‹æµ
    peerConnection.ontrack = (event) => {

        remoteStream = event.streams[0];
        document.getElementById('remoteVideo').srcObject = remoteStream;
        showStatus('è§†é¢‘è¿æ¥å·²å»ºç«‹', 'success');
    };
    
    // å¤„ç†ICEå€™é€‰
    peerConnection.onicecandidate = (event) => {
        if (event.candidate) {
            // é€šè¿‡WebSocketå‘é€ICEå€™é€‰
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'ice_candidate',
                    candidate: event.candidate,
                    room_id: '{{ room_id }}'
                }));
            }
        }
    };
    
    // åªæœ‰ä¸»åŠ¨å‘èµ·æ–¹éœ€è¦åˆ›å»ºoffer
    if (createOffer) {
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        
        // é€šè¿‡WebSocketå‘é€offer
        if (socket && socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({
                type: 'video_offer',
                offer: offer,
                room_id: '{{ room_id }}'
            }));
        }
    }
}

// ç»“æŸè§†é¢‘é€šè¯
function stopVideoChat() {
    if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
    }
    
    if (peerConnection) {
        peerConnection.close();
        peerConnection = null;
    }
    
    if (socket) {
        socket.close();
        socket = null;
    }
    
    // é‡ç½®UI
    document.getElementById('localVideo').srcObject = null;
    document.getElementById('remoteVideo').srcObject = null;
    document.getElementById('startButton').style.display = 'inline-flex';
    document.getElementById('stopButton').style.display = 'none';
    document.getElementById('muteButton').style.display = 'none';
    document.getElementById('videoButton').style.display = 'none';
    document.getElementById('screenShareButton').style.display = 'none';
    
    showStatus('è§†é¢‘é€šè¯å·²ç»“æŸï¼Œå³å°†è¿”å›æ–‡æœ¬èŠå¤©...', 'success');
    updateConnectionStatus('offline');
    stopCallTimer();
    
    // å»¶è¿Ÿ2ç§’åè¿”å›æ–‡æœ¬èŠå¤©é¡µé¢
    setTimeout(() => {
        // å¦‚æœæ˜¯ä»æ–°çª—å£æ‰“å¼€çš„ï¼Œå…³é—­å½“å‰çª—å£
        if (window.opener) {
            window.close();
        } else {
            // è¿”å›åˆ°å¿ƒè¿å¿ƒèŠå¤©é¡µé¢
            const roomId = '{{ room_id }}';
            window.location.href = `/tools/heart_link/chat/${roomId}/`;
        }
    }, 2000);
}

// åˆ‡æ¢é™éŸ³
function toggleMute() {
    if (localStream) {
        const audioTrack = localStream.getAudioTracks()[0];
        if (audioTrack) {
            audioTrack.enabled = !audioTrack.enabled;
            isMuted = !audioTrack.enabled;
            
            const muteButton = document.getElementById('muteButton');
            if (isMuted) {
                muteButton.innerHTML = '<i class="fas fa-microphone-slash"></i> å–æ¶ˆé™éŸ³';
                muteButton.classList.add('active');
            } else {
                muteButton.innerHTML = '<i class="fas fa-microphone"></i> é™éŸ³';
                muteButton.classList.remove('active');
            }
        }
    }
}

// åˆ‡æ¢è§†é¢‘
function toggleVideo() {
    if (localStream) {
        const videoTrack = localStream.getVideoTracks()[0];
        if (videoTrack) {
            videoTrack.enabled = !videoTrack.enabled;
            isVideoOff = !videoTrack.enabled;
            
            const videoButton = document.getElementById('videoButton');
            if (isVideoOff) {
                videoButton.innerHTML = '<i class="fas fa-video-slash"></i> å¼€å¯è§†é¢‘';
                videoButton.classList.add('active');
            } else {
                videoButton.innerHTML = '<i class="fas fa-video"></i> å…³é—­è§†é¢‘';
                videoButton.classList.remove('active');
            }
        }
    }
}

// åˆ‡æ¢å±å¹•å…±äº«
async function toggleScreenShare() {
    try {
        if (!isScreenSharing) {
            const screenStream = await navigator.mediaDevices.getDisplayMedia({
                video: true,
                audio: true
            });
            
            const videoTrack = screenStream.getVideoTracks()[0];
            const sender = peerConnection.getSenders().find(s => s.track && s.track.kind === 'video');
            
            if (sender) {
                sender.replaceTrack(videoTrack);
                document.getElementById('localVideo').srcObject = screenStream;
                isScreenSharing = true;
                
                const screenShareButton = document.getElementById('screenShareButton');
                screenShareButton.innerHTML = '<i class="fas fa-stop"></i> åœæ­¢å…±äº«';
                screenShareButton.classList.add('active');
            }
        } else {
            // åœæ­¢å±å¹•å…±äº«ï¼Œæ¢å¤æ‘„åƒå¤´
            const videoTrack = localStream.getVideoTracks()[0];
            const sender = peerConnection.getSenders().find(s => s.track && s.track.kind === 'video');
            
            if (sender) {
                sender.replaceTrack(videoTrack);
                document.getElementById('localVideo').srcObject = localStream;
                isScreenSharing = false;
                
                const screenShareButton = document.getElementById('screenShareButton');
                screenShareButton.innerHTML = '<i class="fas fa-desktop"></i> å±å¹•å…±äº«';
                screenShareButton.classList.remove('active');
            }
        }
    } catch (error) {
        console.error('å±å¹•å…±äº«å¤±è´¥:', error);
        showStatus('å±å¹•å…±äº«å¤±è´¥', 'error');
    }
}

// æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
function showStatus(message, type) {
    const statusMessage = document.getElementById('statusMessage');
    const statusContent = document.getElementById('statusContent');
    
    statusMessage.className = `status-message status-${type}`;
    statusContent.innerHTML = message;
    statusMessage.style.display = 'block';
    
    // 3ç§’åè‡ªåŠ¨éšè—æˆåŠŸæ¶ˆæ¯
    if (type === 'success') {
        setTimeout(() => {
            statusMessage.style.display = 'none';
        }, 3000);
    }
}

// æ›´æ–°è¿æ¥çŠ¶æ€
function updateConnectionStatus(status) {
    const statusIndicator = document.getElementById('connectionStatus');
    const statusText = document.getElementById('connectionText');
    
    statusIndicator.className = `status-indicator status-${status}`;
    
    switch (status) {
        case 'online':
            statusText.textContent = 'å·²è¿æ¥';
            break;
        case 'connecting':
            statusText.textContent = 'è¿æ¥ä¸­...';
            break;
        case 'offline':
            statusText.textContent = 'æœªè¿æ¥';
            break;
    }
}

// å¼€å§‹é€šè¯è®¡æ—¶
function startCallTimer() {
    callStartTime = Date.now();
    callDurationInterval = setInterval(updateCallDuration, 1000);
}

// åœæ­¢é€šè¯è®¡æ—¶
function stopCallTimer() {
    if (callDurationInterval) {
        clearInterval(callDurationInterval);
        callDurationInterval = null;
    }
    document.getElementById('callDuration').textContent = '00:00';
}

// æ›´æ–°é€šè¯æ—¶é•¿
function updateCallDuration() {
    if (callStartTime) {
        const duration = Math.floor((Date.now() - callStartTime) / 1000);
        const minutes = Math.floor(duration / 60);
        const seconds = duration % 60;
        document.getElementById('callDuration').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
}

// è¿”å›æ–‡æœ¬èŠå¤©é¡µé¢
function returnToTextChat() {
    // ç»“æŸè§†é¢‘èŠå¤©
    if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
    }
    
    if (peerConnection) {
        peerConnection.close();
        peerConnection = null;
    }
    
    if (socket) {
        socket.close();
        socket = null;
    }
    
    // ç›´æ¥è¿”å›æ–‡æœ¬èŠå¤©é¡µé¢
    if (window.opener) {
        window.close();
    } else {
        const roomId = '{{ room_id }}';
        window.location.href = `/tools/heart_link/chat/${roomId}/`;
    }
}

// é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
window.addEventListener('beforeunload', function() {
    stopVideoChat();
});
</script>
{% endblock %}
