{% extends "base.html" %}
{% load static %}

{% block title %}å¼‚æ­¥æµ‹è¯•ç”¨ä¾‹ç”Ÿæˆå™¨{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #8b5cf6;
        --primary-hover: #7c3aed;
        --secondary-color: #a855f7;
        --accent-color: #c084fc;
        --background-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --card-background: rgba(255, 255, 255, 0.95);
        --border-radius: 12px;
        --border-radius-sm: 8px;
        --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        --shadow-hover: 0 12px 40px rgba(0, 0, 0, 0.15);
        --text-primary: #1f2937;
        --text-secondary: #6b7280;
        --success-color: #10b981;
        --warning-color: #f59e0b;
        --error-color: #ef4444;
        --info-color: #3b82f6;
    }

    body {
        background: var(--background-gradient);
        min-height: 100vh;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        color: var(--text-primary);
    }

    #app {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: var(--card-background);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    h1 {
        text-align: center;
        color: var(--primary-color);
        margin-bottom: 30px;
        font-size: 2.5rem;
        font-weight: 700;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .form-group {
        margin-bottom: 25px;
    }

    label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--text-primary);
        font-size: 1.1rem;
    }

    textarea, input[type="text"] {
        width: 100%;
        padding: 15px;
        border: 2px solid #e5e7eb;
        border-radius: var(--border-radius-sm);
        font-size: 1rem;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(5px);
    }

    textarea:focus, input[type="text"]:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        background: rgba(255, 255, 255, 1);
    }

    button {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: var(--border-radius-sm);
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        position: relative;
        overflow: hidden;
    }

    button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
        background: linear-gradient(135deg, var(--primary-hover), var(--primary-color));
    }

    button:active {
        transform: translateY(0);
    }

    button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .btn-outline-primary {
        background: transparent;
        color: var(--primary-color);
        border: 2px solid var(--primary-color);
        box-shadow: none;
    }

    .btn-outline-primary:hover:not(:disabled) {
        background: var(--primary-color);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
    }

    .btn-success {
        background: linear-gradient(135deg, var(--success-color), #059669);
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }

    .btn-success:hover:not(:disabled) {
        background: linear-gradient(135deg, #059669, var(--success-color));
        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
    }

    .btn-info {
        background: linear-gradient(135deg, var(--info-color), #2563eb);
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
    }

    .btn-info:hover:not(:disabled) {
        background: linear-gradient(135deg, #2563eb, var(--info-color));
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
    }

    #result {
        margin-top: 30px;
        padding: 25px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: var(--border-radius);
        border: 1px solid rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        box-shadow: var(--shadow);
        display: none;
    }

    .hint {
        background: rgba(139, 92, 246, 0.1);
        border: 1px solid rgba(139, 92, 246, 0.2);
        border-radius: var(--border-radius-sm);
        padding: 15px;
        margin: 15px 0;
        color: var(--text-secondary);
        font-size: 0.95rem;
        line-height: 1.5;
    }

    #defaultPromptContainer {
        margin-top: 20px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.8);
        border-radius: var(--border-radius-sm);
        border: 1px solid rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(5px);
        display: none;
    }

    .toggle-btn {
        background: rgba(139, 92, 246, 0.1);
        color: var(--primary-color);
        border: 1px solid rgba(139, 92, 246, 0.3);
        padding: 10px 20px;
        border-radius: var(--border-radius-sm);
        font-size: 0.9rem;
        margin: 10px 0;
        transition: all 0.3s ease;
    }

    .toggle-btn:hover {
        background: rgba(139, 92, 246, 0.2);
        transform: translateY(-1px);
    }

    .test-case-display {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: var(--border-radius-sm);
        padding: 20px;
        margin: 20px 0;
        max-height: 600px;
        overflow-y: auto;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.9rem;
        line-height: 1.6;
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    .action-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin: 20px 0;
        flex-wrap: wrap;
    }

    .download-status {
        margin-top: 15px;
        padding: 10px;
        background: rgba(16, 185, 129, 0.1);
        border: 1px solid rgba(16, 185, 129, 0.3);
        border-radius: var(--border-radius-sm);
        color: var(--success-color);
        font-size: 0.9rem;
        display: none;
    }

    /* å¼‚æ­¥ä»»åŠ¡ç‰¹æœ‰æ ·å¼ */
    .task-status {
        padding: 20px;
        margin: 20px 0;
        border-radius: var(--border-radius);
        border-left: 4px solid;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(5px);
        box-shadow: var(--shadow);
    }
    
    .task-pending {
        border-left-color: var(--text-secondary);
        background: rgba(107, 114, 128, 0.1);
    }
    
    .task-running {
        border-left-color: var(--info-color);
        background: rgba(59, 130, 246, 0.1);
    }
    
    .task-completed {
        border-left-color: var(--success-color);
        background: rgba(16, 185, 129, 0.1);
    }
    
    .task-failed {
        border-left-color: var(--error-color);
        background: rgba(239, 68, 68, 0.1);
    }
    
    .progress-bar {
        width: 100%;
        height: 25px;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 12px;
        overflow: hidden;
        margin: 15px 0;
        border: 1px solid rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(5px);
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        transition: width 0.5s ease;
        border-radius: 12px;
        position: relative;
        overflow: hidden;
    }
    
    .progress-fill::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        animation: shimmer 2s infinite;
    }
    
    @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }
    
    .task-list {
        max-height: 500px;
        overflow-y: auto;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: var(--border-radius);
        padding: 15px;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(5px);
    }
    
    .task-item {
        padding: 15px;
        margin: 10px 0;
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: var(--border-radius-sm);
        cursor: pointer;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(5px);
    }
    
    .task-item:hover {
        background: rgba(139, 92, 246, 0.1);
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    
    .task-item.active {
        background: rgba(139, 92, 246, 0.2);
        border-color: var(--primary-color);
        box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
    }

    .task-history-card {
        background: var(--card-background);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        margin-top: 20px;
    }

    .task-history-header {
        padding: 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .task-history-body {
        padding: 20px;
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
        #app {
            margin: 10px;
            padding: 15px;
        }
        
        h1 {
            font-size: 2rem;
        }
        
        .action-buttons {
            flex-direction: column;
            align-items: center;
        }
        
        button {
            width: 100%;
            max-width: 300px;
        }
    }

    /* æ¶ˆæ¯æç¤ºæ ·å¼ */
    .message {
        padding: 15px 20px;
        border-radius: var(--border-radius-sm);
        margin: 15px 0;
        font-weight: 500;
        display: none;
        animation: slideIn 0.3s ease;
    }

    .message.success {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success-color);
        border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .message.error {
        background: rgba(239, 68, 68, 0.1);
        color: var(--error-color);
        border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .message.loading {
        background: rgba(59, 130, 246, 0.1);
        color: var(--info-color);
        border: 1px solid rgba(59, 130, 246, 0.3);
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

{% block content %}
<div id="app">
    <h1>ğŸš€ å¼‚æ­¥æµ‹è¯•ç”¨ä¾‹ç”Ÿæˆå™¨</h1>
    <p style="text-align: center; color: var(--text-secondary); margin-bottom: 30px; font-size: 1.1rem;">
        æ”¯æŒé•¿æ—¶é—´ä»»åŠ¡çš„åå°å¤„ç†ï¼Œé¿å…è¶…æ—¶é—®é¢˜ï¼Œè®©AIæœ‰å……è¶³æ—¶é—´ç”Ÿæˆé«˜è´¨é‡çš„æµ‹è¯•ç”¨ä¾‹
    </p>

    <form id="asyncTestForm">
        {% csrf_token %}
        <div class="form-group">
            <label for="requirement">ğŸ“‹ äº§å“éœ€æ±‚ï¼š</label>
            <textarea 
                id="requirement" 
                name="requirement" 
                rows="4" 
                placeholder="è¯·è¯¦ç»†æè¿°æ‚¨è¦æµ‹è¯•çš„äº§å“éœ€æ±‚ï¼Œä¾‹å¦‚ï¼šç”¨æˆ·ç™»å½•åŠŸèƒ½ã€è´­ç‰©è½¦åŠŸèƒ½ã€æ”¯ä»˜æµç¨‹ç­‰ã€‚æè¿°è¶Šè¯¦ç»†ï¼Œç”Ÿæˆçš„æµ‹è¯•ç”¨ä¾‹è¶Šç²¾å‡†ã€‚"
                required
            ></textarea>
        </div>

        <div class="form-group">
            <label for="prompt">ğŸ¯ è‡ªå®šä¹‰æç¤ºè¯ï¼ˆå¯é€‰ï¼‰ï¼š</label>
            <textarea 
                id="prompt" 
                name="prompt" 
                rows="6" 
                placeholder="è¯·è¾“å…¥è‡ªå®šä¹‰æç¤ºè¯ï¼ˆä½¿ç”¨{requirement}ä½œä¸ºéœ€æ±‚å ä½ç¬¦ï¼‰ï¼Œä¾‹å¦‚ï¼šæ ¹æ®{requirement}ç”Ÿæˆè¯¦ç»†çš„æµ‹è¯•ç”¨ä¾‹..."
            ></textarea>
            <div class="hint">
                æç¤ºï¼šç•™ç©ºå°†ä½¿ç”¨é»˜è®¤æç¤ºè¯æ¨¡æ¿ï¼Œç”ŸæˆåŒ…å«å¤šçº§ç»“æ„çš„æµ‹è¯•ç”¨ä¾‹
            </div>

            <!-- é»˜è®¤æç¤ºè¯æŸ¥çœ‹/ç¼–è¾‘åŒºåŸŸ -->
            <div class="toggle-section">
                <button type="button" class="toggle-btn" onclick="toggleDefaultPrompt()">
                    <i class="fas fa-cog"></i> æŸ¥çœ‹/ç¼–è¾‘é»˜è®¤æç¤ºè¯æ¨¡æ¿
                </button>
            </div>
            <div id="defaultPromptContainer" style="display: none;">
                <textarea
                    id="defaultPromptText"
                    placeholder="é»˜è®¤æç¤ºè¯æ¨¡æ¿..."
                ></textarea>
                <div class="hint">
                    æç¤ºï¼šä¿®æ”¹åå°†å½±å“æ‰€æœ‰æœªè¾“å…¥è‡ªå®šä¹‰æç¤ºè¯çš„ç”Ÿæˆç»“æœ
                </div>
            </div>
        </div>

        <div class="action-buttons">
            <button type="button" id="resetBtn" class="btn-outline-primary">
                <i class="fas fa-undo"></i> é‡ç½®
            </button>
            <button type="submit" id="submitBtn">
                <i class="fas fa-rocket"></i> å¼€å§‹å¼‚æ­¥ç”Ÿæˆ
            </button>
        </div>
        
        <!-- æç¤ºä¿¡æ¯ -->
        <div class="hint" style="margin-top: 10px; text-align: center; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); padding: 10px; border-radius: 8px;">
            âœ… <strong>å¼‚æ­¥ä¼˜åŠ¿ï¼š</strong> ä¸å—è¶…æ—¶é™åˆ¶ï¼Œåå°å¤„ç†ï¼Œå¯å…³é—­é¡µé¢ç­‰å¾…ï¼Œæ”¯æŒå¤æ‚éœ€æ±‚ç”Ÿæˆ
        </div>
    </form>

    <!-- ä»»åŠ¡çŠ¶æ€æ˜¾ç¤º -->
    <div id="taskStatus" style="display: none;">
        <div class="task-status" id="statusDisplay">
            <h5><i class="fas fa-tasks"></i> ä»»åŠ¡çŠ¶æ€</h5>
            <div id="statusText">å‡†å¤‡ä¸­...</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            <div id="progressText">0%</div>
            <div id="currentStep" style="margin-top: 10px; color: var(--text-secondary); font-size: 0.9rem;"></div>
        </div>
    </div>

    <!-- ç»“æœæ˜¾ç¤º -->
    <div id="resultDisplay" style="display: none;">
        <h5><i class="fas fa-check-circle"></i> ç”Ÿæˆç»“æœ</h5>
        <div id="testCaseContent" class="test-case-display"></div>
        <div class="action-buttons">
            <button class="btn-success" id="downloadBtn" style="display: none;">
                <i class="fas fa-download"></i> ä¸‹è½½æµ‹è¯•ç”¨ä¾‹
            </button>
            <button class="btn-info" id="copyBtn">
                <i class="fas fa-copy"></i> å¤åˆ¶å†…å®¹
            </button>
        </div>
        <div class="download-status" id="downloadStatus"></div>
    </div>

    <!-- ä»»åŠ¡å†å² -->
    <div class="task-history-card">
        <div class="task-history-header">
            <h5><i class="fas fa-history"></i> ä»»åŠ¡å†å²</h5>
            <button class="btn-outline-primary" id="refreshTasksBtn">
                <i class="fas fa-refresh"></i> åˆ·æ–°
            </button>
        </div>
        <div class="task-history-body">
            <div id="taskList" class="task-list">
                <div class="text-center text-muted">æš‚æ— ä»»åŠ¡</div>
            </div>
        </div>
    </div>
</div>

<!-- æ¶ˆæ¯æç¤ºå®¹å™¨ -->
<div id="messageContainer"></div>

<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script>
let currentTaskId = null;
let statusCheckInterval = null;

// é¡µé¢åŠ è½½æ—¶è·å–ä»»åŠ¡åˆ—è¡¨
document.addEventListener('DOMContentLoaded', function() {
    loadTaskList();
    loadDefaultPrompt();
});

// åŠ è½½é»˜è®¤æç¤ºè¯
function loadDefaultPrompt() {
    const defaultPrompt = `ä½œä¸ºèµ„æ·±æµ‹è¯•å·¥ç¨‹å¸ˆï¼Œè¯·æ ¹æ®ä»¥ä¸‹äº§å“éœ€æ±‚ç”Ÿæˆä¸“ä¸šçš„æµ‹è¯•ç”¨ä¾‹ï¼š

## æµ‹è¯•ç”¨ä¾‹è¦æ±‚
1. **åŠŸèƒ½æµ‹è¯•**ï¼šæ ¸å¿ƒåŠŸèƒ½ã€ä¸šåŠ¡æµç¨‹ã€æ•°æ®æµè½¬
2. **ç•Œé¢æµ‹è¯•**ï¼šUIäº¤äº’ã€å“åº”å¼å¸ƒå±€ã€ç”¨æˆ·ä½“éªŒ
3. **æ€§èƒ½æµ‹è¯•**ï¼šå“åº”æ—¶é—´ã€å¹¶å‘å¤„ç†ã€èµ„æºæ¶ˆè€—
4. **å…¼å®¹æ€§æµ‹è¯•**ï¼šå¤šè®¾å¤‡ã€å¤šæµè§ˆå™¨ã€å¤šç³»ç»Ÿç‰ˆæœ¬
5. **å®‰å…¨æµ‹è¯•**ï¼šæ•°æ®å®‰å…¨ã€æƒé™æ§åˆ¶ã€è¾“å…¥éªŒè¯
6. **å¼‚å¸¸æµ‹è¯•**ï¼šé”™è¯¯å¤„ç†ã€è¾¹ç•Œæ¡ä»¶ã€å¼‚å¸¸åœºæ™¯

## ç”¨ä¾‹ç»“æ„ï¼ˆæ¯ä¸ªç”¨ä¾‹å¿…é¡»åŒ…å«ï¼‰
- **ç”¨ä¾‹ID**ï¼šTC-æ¨¡å—-åºå·ï¼ˆå¦‚ï¼šTC-ç™»å½•-001ï¼‰
- **ç”¨ä¾‹æ ‡é¢˜**ï¼šç®€æ´æ˜ç¡®çš„åŠŸèƒ½æè¿°
- **æµ‹è¯•åœºæ™¯**ï¼šå…·ä½“çš„ä¸šåŠ¡åœºæ™¯
- **å‰ç½®æ¡ä»¶**ï¼šç³»ç»ŸçŠ¶æ€ã€æ•°æ®å‡†å¤‡
- **æµ‹è¯•æ­¥éª¤**ï¼šè¯¦ç»†çš„æ“ä½œæ­¥éª¤ï¼ˆ1.2.3...ï¼‰
- **é¢„æœŸç»“æœ**ï¼šå…·ä½“çš„éªŒè¯ç‚¹
- **ä¼˜å…ˆçº§**ï¼šP0/P1/P2ï¼ˆP0æœ€é«˜ï¼‰
- **æµ‹è¯•ç±»å‹**ï¼šåŠŸèƒ½/æ€§èƒ½/å®‰å…¨/å…¼å®¹æ€§

## è¾“å‡ºæ ¼å¼
- ä½¿ç”¨Markdownæ ¼å¼
- æŒ‰åŠŸèƒ½æ¨¡å—åˆ†ç±»ï¼ˆ## æ¨¡å—åç§°ï¼‰
- æ¯ä¸ªæ¨¡å—è‡³å°‘åŒ…å«10ä¸ªç”¨ä¾‹
- ç”¨ä¾‹åˆ†å¸ƒï¼šæ­£å‘40% + å¼‚å¸¸30% + è¾¹ç•Œ30%

äº§å“éœ€æ±‚ï¼š{requirement}

è¯·ç”Ÿæˆå®Œæ•´ã€å¯æ‰§è¡Œçš„æµ‹è¯•ç”¨ä¾‹ï¼Œç¡®ä¿è¦†ç›–å…¨é¢ä¸”ç¬¦åˆå®é™…æµ‹è¯•å·¥ä½œéœ€æ±‚ã€‚
- æ¯ä¸ªæµ‹è¯•ç»´åº¦ç»“æŸå¤„æ·»åŠ "ç»´åº¦è¦†ç›–æ€»ç»“"ï¼Œè¯´æ˜å·²è¦†ç›–çš„åœºæ™¯æ•°é‡åŠæ¯”ä¾‹`;

    document.getElementById('defaultPromptText').value = defaultPrompt;
}

// åˆ‡æ¢é»˜è®¤æç¤ºè¯æ˜¾ç¤º
function toggleDefaultPrompt() {
    const container = document.getElementById('defaultPromptContainer');
    const isVisible = container.style.display !== 'none';
    container.style.display = isVisible ? 'none' : 'block';
    
    if (!isVisible) {
        const customPrompt = document.getElementById('prompt').value.trim();
        if (!customPrompt) {
            document.getElementById('prompt').value = document.getElementById('defaultPromptText').value;
        }
    }
}

// é‡ç½®è¡¨å•
document.getElementById('resetBtn').addEventListener('click', function() {
    document.getElementById('asyncTestForm').reset();
    document.getElementById('defaultPromptContainer').style.display = 'none';
    document.getElementById('taskStatus').style.display = 'none';
    document.getElementById('resultDisplay').style.display = 'none';
    document.getElementById('testCaseContent').innerHTML = '';
    hideMessage();
});

// è¡¨å•æäº¤
document.getElementById('asyncTestForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const requirement = document.getElementById('requirement').value.trim();
    const prompt = document.getElementById('prompt').value.trim();
    
    if (!requirement) {
        showMessage('è¯·è¾“å…¥äº§å“éœ€æ±‚', 'error');
        return;
    }
    
    // ç¦ç”¨æäº¤æŒ‰é’®
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> åˆ›å»ºä»»åŠ¡ä¸­...';
    
    // åˆ›å»ºå¼‚æ­¥ä»»åŠ¡
    createAsyncTask(requirement, prompt);
});

// åˆ›å»ºå¼‚æ­¥ä»»åŠ¡
function createAsyncTask(requirement, prompt) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const finalPrompt = prompt || document.getElementById('defaultPromptText').value;
    
    axios.post('/tools/api/async/generate-testcases/', {
        requirement: requirement,
        prompt: finalPrompt
    }, {
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (response.data.success) {
            currentTaskId = response.data.task_id;
            showMessage('ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼å¼€å§‹åå°å¤„ç†...', 'success');
            showTaskStatus();
            startStatusCheck();
            loadTaskList(); // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
        } else {
            showMessage('ä»»åŠ¡åˆ›å»ºå¤±è´¥ï¼š' + (response.data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
    })
    .catch(error => {
        console.error('åˆ›å»ºä»»åŠ¡å¤±è´¥:', error);
        let errorMsg = 'åˆ›å»ºä»»åŠ¡å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
        if (error.response) {
            errorMsg = error.response.data.error || `æœåŠ¡å™¨é”™è¯¯ (${error.response.status})`;
        }
        showMessage(errorMsg, 'error');
    })
    .finally(() => {
        // æ¢å¤æäº¤æŒ‰é’®
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-rocket"></i> å¼€å§‹å¼‚æ­¥ç”Ÿæˆ';
    });
}

// æ˜¾ç¤ºä»»åŠ¡çŠ¶æ€
function showTaskStatus() {
    document.getElementById('taskStatus').style.display = 'block';
    document.getElementById('resultDisplay').style.display = 'none';
}

// å¼€å§‹çŠ¶æ€æ£€æŸ¥
function startStatusCheck() {
    if (statusCheckInterval) {
        clearInterval(statusCheckInterval);
    }
    
    statusCheckInterval = setInterval(() => {
        checkTaskStatus();
    }, 2000); // æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡
}

// æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
function checkTaskStatus() {
    if (!currentTaskId) return;
    
            axios.get(`/tools/api/async/task/${currentTaskId}/`)
    .then(response => {
        const task = response.data;
        updateTaskStatus(task);
        
        if (task.status === 'completed' || task.status === 'failed') {
            clearInterval(statusCheckInterval);
            statusCheckInterval = null;
            
            if (task.status === 'completed') {
                showResult(task.result);
                showMessage('æµ‹è¯•ç”¨ä¾‹ç”Ÿæˆå®Œæˆï¼', 'success');
            } else {
                showMessage('ä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼š' + (task.error || 'æœªçŸ¥é”™è¯¯'), 'error');
            }
        }
    })
    .catch(error => {
        console.error('æ£€æŸ¥ä»»åŠ¡çŠ¶æ€å¤±è´¥:', error);
    });
}

// æ›´æ–°ä»»åŠ¡çŠ¶æ€æ˜¾ç¤º
function updateTaskStatus(task) {
    const statusDisplay = document.getElementById('statusDisplay');
    const statusText = document.getElementById('statusText');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const currentStep = document.getElementById('currentStep');
    
    // æ›´æ–°çŠ¶æ€ç±»
    statusDisplay.className = `task-status task-${task.status}`;
    
    // æ›´æ–°çŠ¶æ€æ–‡æœ¬
    const statusMap = {
        'pending': 'ç­‰å¾…å¤„ç†...',
        'running': 'æ­£åœ¨ç”Ÿæˆä¸­...',
        'completed': 'ç”Ÿæˆå®Œæˆï¼',
        'failed': 'ç”Ÿæˆå¤±è´¥'
    };
    statusText.textContent = statusMap[task.status] || task.status;
    
    // æ›´æ–°è¿›åº¦
    const progress = task.progress || 0;
    progressFill.style.width = progress + '%';
    progressText.textContent = progress + '%';
    
    // æ›´æ–°å½“å‰æ­¥éª¤
    if (task.current_step) {
        currentStep.textContent = `å½“å‰æ­¥éª¤ï¼š${task.current_step}`;
    }
}

// æ˜¾ç¤ºç»“æœ
function showResult(result) {
    document.getElementById('resultDisplay').style.display = 'block';
    document.getElementById('taskStatus').style.display = 'none';
    
    const testCaseContent = document.getElementById('testCaseContent');
    testCaseContent.innerHTML = result
        .replace(/#{2}\s(.*?)\n/g, '<h2>$1</h2>')
        .replace(/#{3}\s(.*?)\n/g, '<h3>$1</h3>')
        .replace(/#{4}\s(.*?)\n/g, '<h4>$1</h4>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/\n/g, '<br>');
}

// åŠ è½½ä»»åŠ¡åˆ—è¡¨
function loadTaskList() {
    axios.get('/tools/api/async/tasks/')
    .then(response => {
        const tasks = response.data.tasks || [];
        const taskList = document.getElementById('taskList');
        
        if (tasks.length === 0) {
            taskList.innerHTML = '<div class="text-center text-muted">æš‚æ— ä»»åŠ¡</div>';
            return;
        }
        
        taskList.innerHTML = tasks.map(task => {
            const statusClass = `task-${task.status}`;
            const statusText = {
                'pending': 'ç­‰å¾…ä¸­',
                'running': 'è¿›è¡Œä¸­',
                'completed': 'å·²å®Œæˆ',
                'failed': 'å¤±è´¥'
            }[task.status] || task.status;
            
            const isActive = currentTaskId === task.id ? 'active' : '';
            
            return `
                <div class="task-item ${isActive}" onclick="selectTask('${task.id}')">
                    <div style="font-weight: 600; margin-bottom: 5px;">
                        ${task.requirement.substring(0, 50)}${task.requirement.length > 50 ? '...' : ''}
                    </div>
                    <div style="font-size: 0.9rem; color: var(--text-secondary);">
                        çŠ¶æ€ï¼š${statusText} | è¿›åº¦ï¼š${task.progress || 0}% | 
                        åˆ›å»ºæ—¶é—´ï¼š${new Date(task.created_at).toLocaleString()}
                    </div>
                </div>
            `;
        }).join('');
    })
    .catch(error => {
        console.error('åŠ è½½ä»»åŠ¡åˆ—è¡¨å¤±è´¥:', error);
    });
}

// é€‰æ‹©ä»»åŠ¡
function selectTask(taskId) {
    currentTaskId = taskId;
    loadTaskList(); // åˆ·æ–°åˆ—è¡¨ä»¥æ›´æ–°activeçŠ¶æ€
    
    // è·å–ä»»åŠ¡è¯¦æƒ…
            axios.get(`/tools/api/async/task/${taskId}/`)
    .then(response => {
        const task = response.data;
        if (task.status === 'completed') {
            showResult(task.result);
            document.getElementById('resultDisplay').style.display = 'block';
            document.getElementById('taskStatus').style.display = 'none';
        } else if (task.status === 'running' || task.status === 'pending') {
            showTaskStatus();
            updateTaskStatus(task);
            startStatusCheck();
        }
    })
    .catch(error => {
        console.error('è·å–ä»»åŠ¡è¯¦æƒ…å¤±è´¥:', error);
    });
}

// åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
document.getElementById('refreshTasksBtn').addEventListener('click', function() {
    loadTaskList();
});

// å¤åˆ¶å†…å®¹
document.getElementById('copyBtn').addEventListener('click', function() {
    const testCaseText = document.getElementById('testCaseContent').textContent;
    navigator.clipboard.writeText(testCaseText).then(() => {
        showMessage('å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', 'success');
    }).catch(err => {
        console.error('å¤åˆ¶å¤±è´¥:', err);
        showMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶', 'error');
    });
});

// ä¸‹è½½åŠŸèƒ½
document.getElementById('downloadBtn').addEventListener('click', function() {
    const testCaseText = document.getElementById('testCaseContent').textContent;
    const blob = new Blob([testCaseText], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `æµ‹è¯•ç”¨ä¾‹_${new Date().toISOString().slice(0, 10)}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showMessage('æµ‹è¯•ç”¨ä¾‹å·²ä¸‹è½½ï¼', 'success');
});

// æ˜¾ç¤ºæ¶ˆæ¯
function showMessage(message, type) {
    const container = document.getElementById('messageContainer');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}`;
    messageDiv.textContent = message;
    messageDiv.style.display = 'block';
    
    container.appendChild(messageDiv);
    
    // 3ç§’åè‡ªåŠ¨éšè—
    setTimeout(() => {
        messageDiv.style.display = 'none';
        container.removeChild(messageDiv);
    }, 3000);
}

// éšè—æ¶ˆæ¯
function hideMessage() {
    const container = document.getElementById('messageContainer');
    container.innerHTML = '';
}

// é¡µé¢å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
window.addEventListener('beforeunload', function() {
    if (statusCheckInterval) {
        clearInterval(statusCheckInterval);
    }
});
</script>
{% endblock %}