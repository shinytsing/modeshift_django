{% extends "base.html" %}
{% load static %}

{% block title %}å°çº¢ä¹¦ç”Ÿæˆå™¨ - QAToolBox{% endblock %}

{% block content %}
{% csrf_token %}
<style>
/* åŠ¨æ€ä¸»é¢˜é€‚é…æ ·å¼ */
.redbook-container {
  min-height: 100vh;
  transition: all 0.3s ease;
  position: relative;
  overflow-x: hidden;
}

/* ä¸»é¢˜åˆ‡æ¢æ—¶çš„è¿‡æ¸¡æ•ˆæœ */
.redbook-container.theme-transition {
  transition: all 0.5s ease;
}

/* ç¡®ä¿ä¸»é¢˜åˆ‡æ¢æ—¶é¡µé¢å…ƒç´ èƒ½å¤Ÿæ­£ç¡®å“åº” */
.redbook-card {
  transition: all 0.3s ease;
}

.redbook-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 20px 40px rgba(0,0,0,0.15);
}

/* å›¾ç‰‡åˆ—è¡¨æ ·å¼ */
.image-list {
  display: flex;
  flex-direction: column;
  gap: 15px;
  margin: 20px 0;
}

.image-item {
  display: flex;
  align-items: center;
  padding: 15px;
  background: var(--geek-bg-secondary, #f8f9fa);
  border-radius: 8px;
  border: 1px solid var(--geek-border, #e9ecef);
  transition: all 0.3s ease;
}

.image-item:hover {
  background: var(--geek-bg-hover, #e9ecef);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.image-preview {
  width: 80px;
  height: 80px;
  border-radius: 6px;
  object-fit: cover;
  margin-right: 15px;
  border: 2px solid var(--geek-border, #fff);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.image-info {
  flex: 1;
}

.image-name {
  font-weight: 600;
  color: var(--geek-text, #333);
  margin-bottom: 5px;
  font-size: 14px;
}

.image-size {
  color: var(--geek-text-muted, #666);
  font-size: 12px;
  margin-bottom: 5px;
}

.image-index {
  color: var(--geek-primary, #007bff);
  font-weight: 600;
  font-size: 12px;
}

.image-actions {
  display: flex;
  gap: 10px;
}

.remove-image-btn {
  background: var(--geek-error, #dc3545);
  color: white;
  border: none;
  border-radius: 4px;
  padding: 8px 12px;
  cursor: pointer;
  font-size: 12px;
  transition: all 0.3s ease;
}

.remove-image-btn:hover {
  background: var(--geek-error-hover, #c82333);
  transform: scale(1.05);
}

/* ç»“æœåŒºåŸŸæ ·å¼ */
.result-section {
  background: var(--geek-bg-secondary, #f8f9fa);
  border-radius: 12px;
  padding: 20px;
  margin-top: 20px;
  border: 1px solid var(--geek-border, #e9ecef);
}

.result-content {
  color: var(--geek-text, #333);
  line-height: 1.6;
}

.result-content h4 {
  color: var(--geek-primary, #007bff);
  margin-bottom: 15px;
}

.tags {
  margin-top: 15px;
}

.tag {
  display: inline-block;
  background: var(--geek-accent, #00bfff);
  color: white;
  padding: 4px 8px;
  border-radius: 4px;
  margin: 2px;
  font-size: 12px;
}

/* å°çº¢ä¹¦å‘å¸ƒåŒºåŸŸæ ·å¼ */
.redbook-section {
  margin-top: 20px;
  padding: 20px;
  background: linear-gradient(135deg, var(--geek-bg-secondary, #fff5f5) 0%, var(--geek-bg, #f8f9fa) 100%);
  border-radius: 12px;
  border: 2px solid var(--geek-accent, #ff2442);
}

.redbook-section h4 {
  color: var(--geek-accent, #ff2442);
  margin-top: 0;
  text-align: center;
  font-size: 20px;
}

.publish-guide {
  margin-top: 15px;
  background: var(--geek-bg, white);
  padding: 15px;
  border-radius: 8px;
  border-left: 4px solid var(--geek-accent, #ff2442);
}

.publish-guide h5 {
  color: var(--geek-accent, #ff2442);
  margin-top: 0;
}

.publish-guide ol {
  text-align: left;
  padding-left: 20px;
  color: var(--geek-text, #333);
}

.copy-section {
  margin-top: 15px;
  text-align: center;
}

/* çŠ¶æ€ä¿¡æ¯æ ·å¼ */
.status, .error, .loading {
  text-align: center;
  margin: 10px 0;
  padding: 10px;
  border-radius: 4px;
  font-size: 14px;
}

.error {
  background: var(--geek-error-bg, #f8d7da);
  color: var(--geek-error, #721c24);
  border: 1px solid var(--geek-error-border, #f5c6cb);
}

.loading {
  background: var(--geek-info-bg, #d1ecf1);
  color: var(--geek-info, #0c5460);
  border: 1px solid var(--geek-info-border, #bee5eb);
}

/* ä¸Šä¼ åŒºåŸŸæ ·å¼ */
.geek-upload-area {
  border: 3px dashed var(--geek-primary, #00ffe7);
  border-radius: 12px;
  background: linear-gradient(135deg, var(--geek-bg, rgba(26,31,46,0.9)) 0%, var(--geek-primary-bg, rgba(0,255,231,0.1)) 100%);
  cursor: pointer;
  transition: all 0.3s ease;
  margin-bottom: 15px;
  color: var(--geek-text, #e6e6e6);
  position: relative;
  overflow: hidden;
  padding: 40px 20px;
  text-align: center;
}

.geek-upload-area::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, var(--geek-primary-bg, rgba(0, 255, 231, 0.2)), transparent);
  transition: left 0.5s ease;
}

.geek-upload-area:hover::before {
  left: 100%;
}

.geek-upload-area:hover {
  border-color: var(--geek-accent, #00bfff);
  background: linear-gradient(135deg, var(--geek-primary-bg, rgba(0,255,231,0.1)) 0%, var(--geek-accent-bg, rgba(0,191,255,0.1)) 100%);
  transform: translateY(-2px);
  box-shadow: 0 8px 32px var(--geek-primary-shadow, rgba(0,255,231,0.2));
}

.upload-icon {
  font-size: 3rem;
  color: var(--geek-primary, #00ffe7);
  margin-bottom: 15px;
  display: block;
}

.upload-text {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
  font-size: 1.3rem;
  font-weight: 700;
  margin-bottom: 8px;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
}

.upload-hint {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
  font-size: 1rem;
  font-weight: 500;
  opacity: 0.8;
  margin-bottom: 10px;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
  line-height: 1.4;
}
</style>

<div class="redbook-container" id="redbookContainer">
  <div class="redbook-card" id="redbookCard" style="max-width: 800px; margin: 2rem auto;">
    <div class="redbook-title" id="redbookTitle" style="text-align:center;">å°çº¢ä¹¦çˆ†æ¬¾æ–‡æ¡ˆç”Ÿæˆå™¨</div>
    <div class="redbook-terminal" id="redbookTerminal" style="margin-bottom:2rem;">ä¸Šä¼ å›¾ç‰‡ï¼ŒAIè‡ªåŠ¨è¯†åˆ«å¹¶ç”Ÿæˆçˆ†æ¬¾æ–‡æ¡ˆ</div>
    
    <div class="image-upload-container">
      <div class="image-counter" id="imageCounter" style="text-align: center; margin-bottom: 10px; color: var(--geek-text-muted, #666); font-size: 14px;">
        å·²é€‰æ‹© 0/9 å¼ å›¾ç‰‡
      </div>
      
      <div class="upload-status" id="uploadStatus" style="text-align: center; margin-bottom: 10px; color: var(--geek-primary, #007bff); font-size: 12px; display: none;">
        <i class="fas fa-spinner fa-spin"></i> æ­£åœ¨å¤„ç†å›¾ç‰‡...
      </div>
      
      <!-- ä¸»è¦ä¸Šä¼ å…¥å£ -->
      <div class="geek-upload-area" id="mainUploadArea" onclick="document.getElementById('imageUpload').click()">
        <i class="fas fa-cloud-upload-alt upload-icon"></i>
        <div class="upload-text">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</div>
        <div class="upload-hint">æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„</div>
        <div style="font-size: 12px; color: var(--geek-text-muted); margin-top: 10px;">
          æ”¯æŒ JPGã€PNGã€WebPã€HEIC æ ¼å¼ï¼Œæœ€å¤§ 100MBï¼Œæœ€å¤š9å¼ å›¾ç‰‡
        </div>
      </div>
      
      <!-- å›¾ç‰‡åˆ—è¡¨ -->
      <div class="image-list" id="imageList">
        <!-- å›¾ç‰‡å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
      </div>
      
      <input type="file" id="imageUpload" accept="image/*,.heic,.heif" multiple style="display:none;">
    </div>
    
    <div class="error" id="errorMsg" style="display:none;"></div>
    <div class="loading" id="loadingMsg" style="display:none;"><i class="fas fa-spinner fa-spin"></i> æ­£åœ¨å¤„ç†å›¾ç‰‡å¹¶ç”Ÿæˆæ–‡æ¡ˆ...</div>
    
    <div class="button-group" style="text-align:center;margin:20px 0;">
      <button id="clearBtn" class="geek-auth-btn" style="background-color: var(--geek-secondary, #6c757d); margin-right: 10px; max-width:120px;">
        <i class="fas fa-trash"></i> æ¸…é™¤å›¾ç‰‡
      </button>
      <button id="generateBtn" class="geek-auth-btn" style="max-width:220px;">
        <i class="fas fa-magic"></i> ç”Ÿæˆæ–‡æ¡ˆå¹¶å‘å¸ƒ
      </button>
      <!-- éšè—çˆ†æ¬¾æ–‡æ¡ˆæŒ‰é’® -->
      <!-- <button id="viralBtn" class="geek-auth-btn" style="background-color: var(--geek-accent, #ff2442); margin-left: 10px; max-width:150px;">
        <i class="fas fa-fire"></i> çˆ†æ¬¾æ–‡æ¡ˆ
      </button> -->
    </div>
    
    <div class="result-section" id="resultSection" style="display:none;">
      <h3 style="color:var(--geek-primary);margin-top:0;">ç”Ÿæˆç»“æœ</h3>
      <div class="result-content">
        <h4 id="generatedTitle"></h4>
        <div id="generatedContent"></div>
        <div class="tags" id="generatedTags"></div>
      </div>
      
      <!-- å°çº¢ä¹¦ç™»å½•å’Œå‘å¸ƒåŒºåŸŸ -->
      <div class="redbook-section">
        <h4>
          ğŸ“± å‘å¸ƒåˆ°å°çº¢ä¹¦
        </h4>
        
        <div class="login-section" style="text-align: center; margin-bottom: 20px;">
          <p style="color: var(--geek-text-muted, #666); margin-bottom: 15px; font-size: 14px;">
            ä½¿ç”¨å°çº¢ä¹¦Appæ‰«æäºŒç»´ç å¿«é€Ÿç™»å½•
          </p>
          <a id="redbookLoginBtn" href="#" target="_blank" class="geek-auth-btn" style="display: inline-block; margin: 10px 0; background-color: var(--geek-accent, #ff2442); font-size: 16px; padding: 12px 24px;">
            <i class="fas fa-qrcode"></i> ç”µè„‘ç«¯æ‰«ç ç™»å½•
          </a>
        </div>
        
        <div class="publish-guide" id="publishGuide">
          <h5>ğŸš€ å¿«é€Ÿå‘å¸ƒæ­¥éª¤ï¼š</h5>
          <ol>
            <li>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ï¼Œæ‰“å¼€å°çº¢ä¹¦ç”µè„‘ç«¯ç™»å½•é¡µé¢</li>
            <li>ä½¿ç”¨å°çº¢ä¹¦Appæ‰«æé¡µé¢ä¸Šçš„äºŒç»´ç </li>
            <li>ç™»å½•æˆåŠŸåï¼Œç‚¹å‡»"ç›´æ¥å‘å¸ƒåˆ°å°çº¢ä¹¦"</li>
            <li>æ–‡æ¡ˆå’Œæ ‡ç­¾ä¼šè‡ªåŠ¨å¡«å……åˆ°ç¼–è¾‘å™¨ä¸­</li>
            <li>ä¸Šä¼ æ‚¨çš„å›¾ç‰‡ï¼Œç‚¹å‡»å‘å¸ƒå³å¯</li>
          </ol>
        </div>
        
        <div class="copy-section">
          <button id="copyAllBtn" class="geek-auth-btn" style="background-color: var(--geek-success, #28a745); margin: 0 10px;">
            <i class="fas fa-copy"></i> ä¸€é”®å¤åˆ¶æ–‡æ¡ˆ
          </button>
          <div id="copyStatus" style="margin-top: 10px; font-size: 14px; color: var(--geek-text-muted, #666);"></div>
        </div>
      </div>
      
      <div class="status" id="publishStatus"></div>
    </div>
  </div>
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>

<script>
// å…¨å±€å˜é‡
let uploadedImages = [];
let generatedData = null;
let currentTheme = 'work'; // é»˜è®¤ä¸»é¢˜

// DOMå…ƒç´ 
let imageUpload, imageList, imageCounter, uploadStatus, mainUploadArea, generateBtn, /* viralBtn, */ resultSection, generatedTitle, generatedContent, generatedTags, publishStatus, loadingMsg, errorMsg, redbookLoginBtn, copyAllBtn, copyStatus, clearBtn, redbookContainer, redbookCard, redbookTitle, redbookTerminal;

// ä¸»é¢˜é…ç½®
const themeConfig = {
    'work': {
        css: 'geek.css',
        title: 'å°çº¢ä¹¦çˆ†æ¬¾æ–‡æ¡ˆç”Ÿæˆå™¨',
        subtitle: 'ä¸Šä¼ å›¾ç‰‡ï¼ŒAIè‡ªåŠ¨è¯†åˆ«å¹¶ç”Ÿæˆçˆ†æ¬¾æ–‡æ¡ˆ'
    },
    'life': {
        css: 'life.css',
        title: 'å°çº¢ä¹¦çˆ†æ¬¾æ–‡æ¡ˆç”Ÿæˆå™¨',
        subtitle: 'ä¸Šä¼ å›¾ç‰‡ï¼ŒAIè‡ªåŠ¨è¯†åˆ«å¹¶ç”Ÿæˆçˆ†æ¬¾æ–‡æ¡ˆ'
    },
    'training': {
        css: 'rage.css',
        title: 'å°çº¢ä¹¦çˆ†æ¬¾æ–‡æ¡ˆç”Ÿæˆå™¨',
        subtitle: 'ä¸Šä¼ å›¾ç‰‡ï¼ŒAIè‡ªåŠ¨è¯†åˆ«å¹¶ç”Ÿæˆçˆ†æ¬¾æ–‡æ¡ˆ'
    },
    'emo': {
        css: 'emo.css',
        title: 'å°çº¢ä¹¦çˆ†æ¬¾æ–‡æ¡ˆç”Ÿæˆå™¨',
        subtitle: 'ä¸Šä¼ å›¾ç‰‡ï¼ŒAIè‡ªåŠ¨è¯†åˆ«å¹¶ç”Ÿæˆçˆ†æ¬¾æ–‡æ¡ˆ'
    }
};

// ç­‰å¾…DOMåŠ è½½å®Œæˆ
document.addEventListener('DOMContentLoaded', function() {
    // è·å–DOMå…ƒç´ 
    imageUpload = document.getElementById('imageUpload');
    imageList = document.getElementById('imageList');
    imageCounter = document.getElementById('imageCounter');
    uploadStatus = document.getElementById('uploadStatus');
    mainUploadArea = document.getElementById('mainUploadArea');
    generateBtn = document.getElementById('generateBtn');
    // viralBtn = document.getElementById('viralBtn'); // å·²éšè—çˆ†æ¬¾æ–‡æ¡ˆæŒ‰é’®
    resultSection = document.getElementById('resultSection');
    generatedTitle = document.getElementById('generatedTitle');
    generatedContent = document.getElementById('generatedContent');
    generatedTags = document.getElementById('generatedTags');
    publishStatus = document.getElementById('publishStatus');
    loadingMsg = document.getElementById('loadingMsg');
    errorMsg = document.getElementById('errorMsg');
    redbookLoginBtn = document.getElementById('redbookLoginBtn');
    copyAllBtn = document.getElementById('copyAllBtn');
    copyStatus = document.getElementById('copyStatus');
    clearBtn = document.getElementById('clearBtn');
    redbookContainer = document.getElementById('redbookContainer');
    redbookCard = document.getElementById('redbookCard');
    redbookTitle = document.getElementById('redbookTitle');
    redbookTerminal = document.getElementById('redbookTerminal');
    
    // åˆå§‹åŒ–ä¸»é¢˜
    initTheme();
    
    // åˆå§‹åŒ–å›¾ç‰‡åˆ—è¡¨
    updateImageList();
    
    // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
    bindEventListeners();
    
    // ç›‘å¬ä¸»é¢˜å˜åŒ–
    listenForThemeChanges();
});

// åˆå§‹åŒ–ä¸»é¢˜
function initTheme() {
    // ä»localStorageè·å–å½“å‰ä¸»é¢˜
    const savedTheme = localStorage.getItem('currentTheme') || 'work';
    applyTheme(savedTheme);
}

// åº”ç”¨ä¸»é¢˜
function applyTheme(theme) {
    currentTheme = theme;
    
    // æ›´æ–°CSSæ–‡ä»¶
    const themeCSS = document.getElementById('dynamic-theme-css');
    if (themeCSS && themeConfig[theme]) {
        themeCSS.href = '/static/' + themeConfig[theme].css;
    }
    
    // æ›´æ–°é¡µé¢å…ƒç´ 
    updatePageElements(theme);
    
    // ä¿å­˜ä¸»é¢˜åˆ°localStorage
    localStorage.setItem('currentTheme', theme);
}

// æ›´æ–°é¡µé¢å…ƒç´ 
function updatePageElements(theme) {
    // æ›´æ–°å®¹å™¨ç±»å
    redbookContainer.className = `redbook-container ${theme}-theme`;
    redbookCard.className = `redbook-card ${theme}-card`;
    
    // æ›´æ–°æ ‡é¢˜
    if (redbookTitle) {
        redbookTitle.className = `redbook-title ${theme}-title`;
        redbookTitle.textContent = themeConfig[theme]?.title || 'å°çº¢ä¹¦çˆ†æ¬¾æ–‡æ¡ˆç”Ÿæˆå™¨';
    }
    
    // æ›´æ–°å‰¯æ ‡é¢˜
    if (redbookTerminal) {
        redbookTerminal.className = `redbook-terminal ${theme}-terminal`;
        redbookTerminal.textContent = themeConfig[theme]?.subtitle || 'ä¸Šä¼ å›¾ç‰‡ï¼ŒAIè‡ªåŠ¨è¯†åˆ«å¹¶ç”Ÿæˆçˆ†æ¬¾æ–‡æ¡ˆ';
    }
}

// ç›‘å¬ä¸»é¢˜å˜åŒ–
function listenForThemeChanges() {
    // ç›‘å¬æ¥è‡ªbase.htmlçš„ä¸»é¢˜å˜åŒ–äº‹ä»¶
    window.addEventListener('themeChanged', function(event) {
        const newTheme = event.detail.theme;
        applyTheme(newTheme);
    });
    
    // å®šæœŸæ£€æŸ¥ä¸»é¢˜å˜åŒ–
    setInterval(() => {
        const savedTheme = localStorage.getItem('currentTheme');
        if (savedTheme && savedTheme !== currentTheme) {
            applyTheme(savedTheme);
        }
    }, 1000);
}

// æ–‡ä»¶å¤§å°æ ¼å¼åŒ–å‡½æ•°
function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

// æ›´æ–°å›¾ç‰‡è®¡æ•°
function updateImageCounter() {
    imageCounter.textContent = `å·²é€‰æ‹© ${uploadedImages.length}/9 å¼ å›¾ç‰‡`;
    if (uploadedImages.length >= 9) {
        imageCounter.style.color = '#dc3545';
        imageCounter.textContent += ' (å·²è¾¾ä¸Šé™)';
    } else {
        imageCounter.style.color = '#666';
    }
}

// æ›´æ–°å›¾ç‰‡åˆ—è¡¨æ˜¾ç¤º
function updateImageList() {

    imageList.innerHTML = '';
    
    if (uploadedImages.length === 0) {
        // ä¸æ˜¾ç¤ºä»»ä½•å†…å®¹ï¼Œä¿æŒç©ºç™½
        updateImageCounter();
        return;
    }
    
    // æ˜¾ç¤ºæ¯å¼ å›¾ç‰‡
    uploadedImages.forEach((imageData, index) => {

        const imageItem = document.createElement('div');
        imageItem.className = 'image-item';
        imageItem.innerHTML = `
            <img src="${imageData.preview}" alt="å›¾ç‰‡ ${index + 1}" class="image-preview">
            <div class="image-info">
                <div class="image-name">${imageData.file.name}</div>
                <div class="image-size">${formatFileSize(imageData.size)}</div>
                <div class="image-index">ç¬¬ ${index + 1} å¼ å›¾ç‰‡</div>
            </div>
            <div class="image-actions">
                <button class="remove-image-btn" onclick="removeImage(${index})">
                    <i class="fas fa-trash"></i> åˆ é™¤
                </button>
            </div>
        `;
        imageList.appendChild(imageItem);
    });
    
    updateImageCounter();
}

// ç§»é™¤å›¾ç‰‡
function removeImage(index) {

    uploadedImages.splice(index, 1);
    updateImageList();
    errorMsg.style.display = 'none';
    resultSection.style.display = 'none'; // æ¸…é™¤ç»“æœï¼Œå› ä¸ºå›¾ç‰‡å·²æ”¹å˜
}

// æŒ‰é¡ºåºå¤„ç†æ–‡ä»¶
function processFilesSequentially(files) {

    // æ˜¾ç¤ºä¸Šä¼ çŠ¶æ€
    uploadStatus.style.display = 'block';
    uploadStatus.innerHTML = `<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨å¤„ç† ${files.length} å¼ å›¾ç‰‡...`;
    
    let processedCount = 0;
    
    files.forEach((file, index) => {

        // å¦‚æœæ˜¯HEICæ–‡ä»¶ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†
        if (file.type === 'image/heic' || file.type === 'image/heif' || file.name.toLowerCase().endsWith('.heic') || file.name.toLowerCase().endsWith('.heif')) {

            processHeicFile(file, index, processedCount, files.length);
        } else {
            // æ™®é€šå›¾ç‰‡æ–‡ä»¶å¤„ç†
            const reader = new FileReader();
            reader.onload = function(e) {

                uploadedImages.push({
                    file: file,
                    preview: e.target.result,
                    size: file.size
                });
                
                processedCount++;

                // æ›´æ–°çŠ¶æ€
                uploadStatus.innerHTML = `<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨å¤„ç†å›¾ç‰‡ (${processedCount}/${files.length})`;
                
                // ç«‹å³æ›´æ–°å›¾ç‰‡åˆ—è¡¨æ˜¾ç¤º
                updateImageList();
                
                // å¦‚æœæ‰€æœ‰æ–‡ä»¶éƒ½å¤„ç†å®Œæˆ
                if (processedCount === files.length) {

                    uploadStatus.style.display = 'none';

                    // ç¡®ä¿inputè¢«æ¸…ç©ºï¼Œä»¥ä¾¿ä¸‹æ¬¡é€‰æ‹©
                    setTimeout(() => {
                        imageUpload.value = '';
                    }, 100);
                }
            };
            
            reader.onerror = function() {
                console.error('æ–‡ä»¶è¯»å–å¤±è´¥:', file.name);
                showError(`æ–‡ä»¶ ${file.name} è¯»å–å¤±è´¥`);
                processedCount++;
                
                if (processedCount === files.length) {
                    uploadStatus.style.display = 'none';
                    // ç¡®ä¿inputè¢«æ¸…ç©º
                    setTimeout(() => {
                        imageUpload.value = '';
                    }, 100);
                }
            };
            
            reader.readAsDataURL(file);
        }
    });
}

// å¤„ç†HEICæ–‡ä»¶çš„å‡½æ•°
function processHeicFile(file, index, processedCount, totalFiles) {

    // å¯¹äºHEICæ–‡ä»¶ï¼Œç›´æ¥æ·»åŠ åˆ°åˆ—è¡¨ä¸­ï¼Œä¸å°è¯•é¢„è§ˆ
    // å› ä¸ºæµè§ˆå™¨å¯èƒ½æ— æ³•ç›´æ¥é¢„è§ˆHEICæ–‡ä»¶
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 200;
    canvas.height = 200;
    
    // ç»˜åˆ¶HEICæ–‡ä»¶å ä½ç¬¦
    ctx.fillStyle = '#f8f9fa';
    ctx.fillRect(0, 0, 200, 200);
    ctx.fillStyle = '#007bff';
    ctx.font = '16px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('HEICæ–‡ä»¶', 100, 90);
    ctx.fillText('å·²ä¸Šä¼ ', 100, 110);
    
    const preview = canvas.toDataURL('image/png');
    
    uploadedImages.push({
        file: file,
        preview: preview,
        size: file.size,
        isHeic: true
    });
    
    processedCount++;

    // æ›´æ–°çŠ¶æ€
    uploadStatus.innerHTML = `<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨å¤„ç†å›¾ç‰‡ (${processedCount}/${totalFiles})`;
    
    // ç«‹å³æ›´æ–°å›¾ç‰‡åˆ—è¡¨æ˜¾ç¤º
    updateImageList();
    
    // å¦‚æœæ‰€æœ‰æ–‡ä»¶éƒ½å¤„ç†å®Œæˆ
    if (processedCount === totalFiles) {

        uploadStatus.style.display = 'none';

        // ç¡®ä¿inputè¢«æ¸…ç©ºï¼Œä»¥ä¾¿ä¸‹æ¬¡é€‰æ‹©
        setTimeout(() => {
            imageUpload.value = '';
        }, 100);
    }
}

// ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
function bindEventListeners() {
    // æ–‡ä»¶ä¸Šä¼ äº‹ä»¶
    imageUpload.addEventListener('change', function(e) {

        const files = Array.from(e.target.files);

        if (files.length === 0) return;
        
        // éªŒè¯æ–‡ä»¶ç±»å‹å’Œå¤§å°
        const validTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/heic', 'image/heif'];
        for (let file of files) {
            if (!validTypes.includes(file.type)) {
                showError('è¯·ä¸Šä¼ JPGã€PNGã€WebPæˆ–HEICæ ¼å¼çš„å›¾ç‰‡');
                return;
            }
            if (file.size > 100 * 1024 * 1024) { // 100MB
                showError(`å›¾ç‰‡ ${file.name} å¤§å°ä¸èƒ½è¶…è¿‡100MB`);
                return;
            }
        }

        // æ£€æŸ¥æ˜¯å¦è¶…è¿‡9å¼ å›¾ç‰‡é™åˆ¶
        if (uploadedImages.length + files.length > 9) {
            showError('æœ€å¤šåªèƒ½ä¸Šä¼ 9å¼ å›¾ç‰‡');
            return;
        }

        // æŒ‰é¡ºåºå¤„ç†æ¯ä¸ªæ–‡ä»¶
        processFilesSequentially(files);
        
        errorMsg.style.display = 'none';
        // æ¸…ç©ºinputï¼Œè®©ç”¨æˆ·å¯ä»¥ç»§ç»­é€‰æ‹©æ–‡ä»¶
        imageUpload.value = '';
    });

    // ç”ŸæˆæŒ‰é’®ç‚¹å‡»äº‹ä»¶
    generateBtn.addEventListener('click', function() {
        if (uploadedImages.length === 0) {
            showError('è¯·å…ˆä¸Šä¼ å›¾ç‰‡ï¼Œç„¶åç‚¹å‡»ç”Ÿæˆæ–‡æ¡ˆ');
            return;
        }

        // å‡†å¤‡FormData
        const formData = new FormData();
        uploadedImages.forEach(imageData => {
            formData.append('images', imageData.file);
        });

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        showLoading();
        generateBtn.disabled = true;

        // å‘é€è¯·æ±‚åˆ°åç«¯
        axios.post('/tools/api/generate-redbook/', formData, {
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'multipart/form-data'
            },
            timeout: 60000 // è¶…æ—¶æ—¶é—´60ç§’
        })
        .then(response => {
            // å¤„ç†æˆåŠŸå“åº”
            const data = response.data;
            if (data.error) {
                showError(data.error);
                return;
            }

            // ä¿å­˜ç”Ÿæˆçš„æ•°æ®
            generatedData = data;
            
            // æ˜¾ç¤ºç»“æœ
            generatedTitle.textContent = data.title;
            generatedContent.innerHTML = data.content.replace(/\n/g, '<br>');

            // å¤„ç†æ ‡ç­¾
            generatedTags.innerHTML = '';
            if (data.tags && data.tags.length > 0) {
                data.tags.forEach(tag => {
                    const tagElement = document.createElement('span');
                    tagElement.className = 'tag';
                    tagElement.textContent = tag;
                    generatedTags.appendChild(tagElement);
                });
            }

            // è®¾ç½®å°çº¢ä¹¦ç™»å½•å’Œå‘å¸ƒé“¾æ¥
            if (data.redbook_login_url) {
                redbookLoginBtn.href = data.redbook_login_url;
                
                // æ ¹æ®è®¾å¤‡ç±»å‹è®¾ç½®ä¸åŒçš„æŒ‰é’®æ–‡æœ¬å’Œè¡Œä¸º
                if (data.is_mobile) {
                    redbookLoginBtn.innerHTML = '<i class="fas fa-mobile-alt"></i> æ‰“å¼€å°çº¢ä¹¦App';
                    redbookLoginBtn.title = 'ç›´æ¥æ‰“å¼€å°çº¢ä¹¦Appå¹¶å¡«å……æ–‡æ¡ˆ';
                    redbookLoginBtn.style.backgroundColor = '#ff2442';
                    
                    // æ·»åŠ ä¸‹è½½AppæŒ‰é’®
                    const downloadBtn = document.createElement('a');
                    downloadBtn.href = 'https://www.xiaohongshu.com/download';
                    downloadBtn.target = '_blank';
                    downloadBtn.className = 'geek-auth-btn';
                    downloadBtn.style.cssText = 'background-color: #28a745; margin-left: 10px; display: inline-block; text-decoration: none;';
                    downloadBtn.innerHTML = '<i class="fas fa-download"></i> ä¸‹è½½å°çº¢ä¹¦App';
                    downloadBtn.title = 'ä¸‹è½½å°çº¢ä¹¦App';
                    
                    const loginSection = redbookLoginBtn.parentNode;
                    loginSection.appendChild(downloadBtn);
                } else {
                    redbookLoginBtn.innerHTML = '<i class="fas fa-qrcode"></i> ç”µè„‘ç«¯æ‰«ç ç™»å½•';
                    redbookLoginBtn.title = 'æ‰«ç ç™»å½•åè‡ªåŠ¨è·³è½¬åˆ°å‘å¸ƒé¡µé¢';
                }
            }
            
            // æ·»åŠ æ™ºèƒ½å‘å¸ƒæŒ‰é’®
            if (data.redbook_publish_url) {
                const publishBtn = document.createElement('a');
                publishBtn.href = data.redbook_publish_url;
                publishBtn.target = '_blank';
                publishBtn.className = 'geek-auth-btn';
                publishBtn.style.cssText = 'background-color: #ff2442; margin-left: 10px; display: inline-block; text-decoration: none;';
                
                if (data.is_mobile) {
                    publishBtn.innerHTML = '<i class="fas fa-rocket"></i> ä¸€é”®å‘å¸ƒåˆ°App';
                    publishBtn.title = 'ç›´æ¥è·³è½¬åˆ°å°çº¢ä¹¦Appå‘å¸ƒé¡µé¢';
                } else {
                    publishBtn.innerHTML = '<i class="fas fa-rocket"></i> ä¸€é”®å‘å¸ƒåˆ°å°çº¢ä¹¦';
                    publishBtn.title = 'ç›´æ¥è·³è½¬åˆ°å°çº¢ä¹¦å‘å¸ƒé¡µé¢ï¼Œæ–‡æ¡ˆè‡ªåŠ¨å¡«å……';
                }
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œæ˜¾ç¤ºå‘å¸ƒæç¤º
                publishBtn.addEventListener('click', function(e) {
                    showPublishGuide(data.is_mobile);
                });
                
                // å°†å‘å¸ƒæŒ‰é’®æ·»åŠ åˆ°ç™»å½•æŒ‰é’®çš„çˆ¶å®¹å™¨ä¸­
                const loginSection = redbookLoginBtn.parentNode;
                loginSection.appendChild(publishBtn);
                
                // æ·»åŠ è¯´æ˜æ–‡å­—
                const publishNote = document.createElement('div');
                publishNote.style.cssText = 'font-size: 12px; color: #666; margin-top: 5px;';
                if (data.is_mobile) {
                    publishNote.innerHTML = 'ğŸ’¡ ç‚¹å‡»æŒ‰é’®ç›´æ¥æ‰“å¼€å°çº¢ä¹¦Appï¼Œæ–‡æ¡ˆå°†è‡ªåŠ¨å¡«å……';
                } else {
                    publishNote.innerHTML = 'ğŸ’¡ æ‰«ç ç™»å½•åä¼šè‡ªåŠ¨è·³è½¬åˆ°å‘å¸ƒé¡µé¢ï¼Œæ–‡æ¡ˆå°†è‡ªåŠ¨å¡«å……';
                }
                loginSection.appendChild(publishNote);
            }

            // æ˜¾ç¤ºå‘å¸ƒçŠ¶æ€
            const imageCount = data.image_count || 0;
            publishStatus.textContent = `${data.message || 'æ–‡æ¡ˆç”ŸæˆæˆåŠŸï¼'} (å…±${imageCount}å¼ å›¾ç‰‡)`;

            // æ˜¾ç¤ºç»“æœåŒºåŸŸ
            showResult();
        })
        .catch(error => {
            // å¤„ç†é”™è¯¯
            const errorMessage = error.response?.data?.error || 'ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
            showError(errorMessage);
            console.error('Error:', error);
        })
        .finally(() => {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            generateBtn.disabled = false;
            loadingMsg.style.display = 'none';
        });
    });

    // çˆ†æ¬¾æ–‡æ¡ˆæŒ‰é’®ç‚¹å‡»äº‹ä»¶ - å·²éšè—
    /*
    viralBtn.addEventListener('click', function() {

        if (uploadedImages.length === 0) {
            showError('è¯·å…ˆä¸Šä¼ å›¾ç‰‡ï¼Œç„¶åç‚¹å‡»çˆ†æ¬¾æ–‡æ¡ˆæŒ‰é’®');
            return;
        }

        // æ˜¾ç¤ºç‰¹æ®Šæç¤º
        showSuccess('ğŸ”¥ æ­£åœ¨ç”Ÿæˆçˆ†æ¬¾æ–‡æ¡ˆï¼Œè¯·ç¨å€™...');
        
        // å‡†å¤‡FormData
        const formData = new FormData();
        uploadedImages.forEach(imageData => {
            formData.append('images', imageData.file);
        });

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        showLoading();
        viralBtn.disabled = true;
        generateBtn.disabled = true;

        // å‘é€è¯·æ±‚åˆ°åç«¯ï¼Œä½¿ç”¨ç‰¹æ®Šçš„çˆ†æ¬¾æ–‡æ¡ˆæç¤º
        axios.post('/tools/api/generate-redbook/', formData, {
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'multipart/form-data'
            },
            timeout: 60000 // è¶…æ—¶æ—¶é—´60ç§’
        })
        .then(response => {
            // å¤„ç†æˆåŠŸå“åº”
            const data = response.data;
            if (data.error) {
                showError(data.error);
                return;
            }

            // ä¿å­˜ç”Ÿæˆçš„æ•°æ®
            generatedData = data;
            
            // æ˜¾ç¤ºç»“æœ
            generatedTitle.textContent = data.title;
            generatedContent.innerHTML = data.content.replace(/\n/g, '<br>');

            // å¤„ç†æ ‡ç­¾
            generatedTags.innerHTML = '';
            if (data.tags && data.tags.length > 0) {
                data.tags.forEach(tag => {
                    const tagElement = document.createElement('span');
                    tagElement.className = 'tag';
                    tagElement.textContent = tag;
                    generatedTags.appendChild(tagElement);
                });
            }

            // è®¾ç½®å°çº¢ä¹¦ç™»å½•å’Œå‘å¸ƒé“¾æ¥
            if (data.redbook_login_url) {
                redbookLoginBtn.href = data.redbook_login_url;
                
                // æ ¹æ®è®¾å¤‡ç±»å‹è®¾ç½®ä¸åŒçš„æŒ‰é’®æ–‡æœ¬å’Œè¡Œä¸º
                if (data.is_mobile) {
                    redbookLoginBtn.innerHTML = '<i class="fas fa-mobile-alt"></i> æ‰“å¼€å°çº¢ä¹¦App';
                    redbookLoginBtn.title = 'ç›´æ¥æ‰“å¼€å°çº¢ä¹¦Appå¹¶å¡«å……æ–‡æ¡ˆ';
                    redbookLoginBtn.style.backgroundColor = '#ff2442';
                    
                    // æ·»åŠ ä¸‹è½½AppæŒ‰é’®
                    const downloadBtn = document.createElement('a');
                    downloadBtn.href = 'https://www.xiaohongshu.com/download';
                    downloadBtn.target = '_blank';
                    downloadBtn.className = 'geek-auth-btn';
                    downloadBtn.style.cssText = 'background-color: #28a745; margin-left: 10px; display: inline-block; text-decoration: none;';
                    downloadBtn.innerHTML = '<i class="fas fa-download"></i> ä¸‹è½½å°çº¢ä¹¦App';
                    downloadBtn.title = 'ä¸‹è½½å°çº¢ä¹¦App';
                    
                    const loginSection = redbookLoginBtn.parentNode;
                    loginSection.appendChild(downloadBtn);
                } else {
                    redbookLoginBtn.innerHTML = '<i class="fas fa-qrcode"></i> ç”µè„‘ç«¯æ‰«ç ç™»å½•';
                    redbookLoginBtn.title = 'æ‰«ç ç™»å½•åè‡ªåŠ¨è·³è½¬åˆ°å‘å¸ƒé¡µé¢';
                }
            }
            
            // æ·»åŠ æ™ºèƒ½å‘å¸ƒæŒ‰é’®
            if (data.redbook_publish_url) {
                const publishBtn = document.createElement('a');
                publishBtn.href = data.redbook_publish_url;
                publishBtn.target = '_blank';
                publishBtn.className = 'geek-auth-btn';
                publishBtn.style.cssText = 'background-color: #ff2442; margin-left: 10px; display: inline-block; text-decoration: none;';
                
                if (data.is_mobile) {
                    publishBtn.innerHTML = '<i class="fas fa-rocket"></i> ä¸€é”®å‘å¸ƒåˆ°App';
                    publishBtn.title = 'ç›´æ¥è·³è½¬åˆ°å°çº¢ä¹¦Appå‘å¸ƒé¡µé¢';
                } else {
                    publishBtn.innerHTML = '<i class="fas fa-rocket"></i> ä¸€é”®å‘å¸ƒåˆ°å°çº¢ä¹¦';
                    publishBtn.title = 'ç›´æ¥è·³è½¬åˆ°å°çº¢ä¹¦å‘å¸ƒé¡µé¢ï¼Œæ–‡æ¡ˆè‡ªåŠ¨å¡«å……';
                }
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œæ˜¾ç¤ºå‘å¸ƒæç¤º
                publishBtn.addEventListener('click', function(e) {
                    showPublishGuide(data.is_mobile);
                });
                
                // å°†å‘å¸ƒæŒ‰é’®æ·»åŠ åˆ°ç™»å½•æŒ‰é’®çš„çˆ¶å®¹å™¨ä¸­
                const loginSection = redbookLoginBtn.parentNode;
                loginSection.appendChild(publishBtn);
                
                // æ·»åŠ è¯´æ˜æ–‡å­—
                const publishNote = document.createElement('div');
                publishNote.style.cssText = 'font-size: 12px; color: #666; margin-top: 5px;';
                if (data.is_mobile) {
                    publishNote.innerHTML = 'ğŸ’¡ ç‚¹å‡»æŒ‰é’®ç›´æ¥æ‰“å¼€å°çº¢ä¹¦Appï¼Œæ–‡æ¡ˆå°†è‡ªåŠ¨å¡«å……';
                } else {
                    publishNote.innerHTML = 'ğŸ’¡ æ‰«ç ç™»å½•åä¼šè‡ªåŠ¨è·³è½¬åˆ°å‘å¸ƒé¡µé¢ï¼Œæ–‡æ¡ˆå°†è‡ªåŠ¨å¡«å……';
                }
                loginSection.appendChild(publishNote);
            }

            // æ˜¾ç¤ºå‘å¸ƒçŠ¶æ€
            const imageCount = data.image_count || 0;
            publishStatus.textContent = `ğŸ”¥ çˆ†æ¬¾æ–‡æ¡ˆç”ŸæˆæˆåŠŸï¼è¯·ç™»å½•å°çº¢ä¹¦åå‘å¸ƒ (å…±${imageCount}å¼ å›¾ç‰‡)`;

            // æ˜¾ç¤ºç»“æœåŒºåŸŸ
            showResult();
        })
        .catch(error => {
            // å¤„ç†é”™è¯¯
            const errorMessage = error.response?.data?.error || 'çˆ†æ¬¾æ–‡æ¡ˆç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
            showError(errorMessage);
            console.error('Error:', error);
        })
        .finally(() => {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            viralBtn.disabled = false;
            generateBtn.disabled = false;
            loadingMsg.style.display = 'none';
        });
    });
    */

    // æ¸…é™¤å›¾ç‰‡åŠŸèƒ½
    clearBtn.addEventListener('click', function() {
        if (uploadedImages.length === 0) {
            showError('å½“å‰æ²¡æœ‰å›¾ç‰‡éœ€è¦æ¸…é™¤ï¼Œè¯·å…ˆä¸Šä¼ å›¾ç‰‡');
            return;
        }
        
        imageUpload.value = '';
        uploadedImages = [];
        updateImageList();
        resultSection.style.display = 'none';
        errorMsg.style.display = 'none';
        generatedData = null;
        
        // æ˜¾ç¤ºæ¸…é™¤æˆåŠŸæç¤º
        showSuccess('å›¾ç‰‡å·²æ¸…é™¤ï¼Œå¯ä»¥é‡æ–°ä¸Šä¼ ');
    });

    // ä¸€é”®å¤åˆ¶æ–‡æ¡ˆåŠŸèƒ½
    copyAllBtn.addEventListener('click', function() {
        if (!generatedData) {
            copyStatus.textContent = 'æ²¡æœ‰å¯å¤åˆ¶çš„æ–‡æ¡ˆ';
            return;
        }
        
        // æ„å»ºå®Œæ•´çš„æ–‡æ¡ˆ
        const fullContent = `${generatedData.title}\n\n${generatedData.content}\n\n${generatedData.tags.join(' ')}`;
        
        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        navigator.clipboard.writeText(fullContent).then(() => {
            copyStatus.textContent = 'âœ… æ–‡æ¡ˆå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼';
            copyStatus.style.color = '#28a745';
            
            // 3ç§’åæ¸…é™¤çŠ¶æ€
            setTimeout(() => {
                copyStatus.textContent = '';
            }, 3000);
        }).catch(err => {
            copyStatus.textContent = 'âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶';
            copyStatus.style.color = '#dc3545';
            console.error('å¤åˆ¶å¤±è´¥:', err);
        });
    });

    // ä¸»ä¸Šä¼ åŒºåŸŸæ‹–æ‹½åŠŸèƒ½
    mainUploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        mainUploadArea.style.opacity = '0.7';
        mainUploadArea.style.transform = 'scale(1.02)';
    });

    mainUploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        mainUploadArea.style.opacity = '1';
        mainUploadArea.style.transform = 'scale(1)';
    });

    mainUploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        mainUploadArea.style.opacity = '1';
        mainUploadArea.style.transform = 'scale(1)';
        
        if (e.dataTransfer.files.length) {
            const imageFiles = Array.from(e.dataTransfer.files).filter(file => 
                file.type.startsWith('image/') || file.name.toLowerCase().endsWith('.heic') || file.name.toLowerCase().endsWith('.heif')
            );
            
            if (imageFiles.length === 0) {
                showError('è¯·æ‹–æ‹½å›¾ç‰‡æ–‡ä»¶ï¼ˆæ”¯æŒJPGã€PNGã€WebPã€HEICæ ¼å¼ï¼‰');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦è¶…è¿‡9å¼ å›¾ç‰‡é™åˆ¶
            if (uploadedImages.length + imageFiles.length > 9) {
                showError('æœ€å¤šåªèƒ½ä¸Šä¼ 9å¼ å›¾ç‰‡');
                return;
            }
            
            // æŒ‰é¡ºåºå¤„ç†æ‹–æ‹½çš„æ–‡ä»¶
            processFilesSequentially(imageFiles);
            
            errorMsg.style.display = 'none';
        }
    });
}

// è¾…åŠ©å‡½æ•°ï¼šæ˜¾ç¤ºåŠ è½½çŠ¶æ€
function showLoading() {
    loadingMsg.style.display = 'block';
    resultSection.style.display = 'none';
    errorMsg.style.display = 'none';
}

// è¾…åŠ©å‡½æ•°ï¼šæ˜¾ç¤ºç»“æœ
function showResult() {
    resultSection.style.display = 'block';
    loadingMsg.style.display = 'none';
    errorMsg.style.display = 'none';
}

// è¾…åŠ©å‡½æ•°ï¼šæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
function showError(message) {
    errorMsg.textContent = message;
    errorMsg.style.display = 'block';
    resultSection.style.display = 'none';
    loadingMsg.style.display = 'none';
}

// è¾…åŠ©å‡½æ•°ï¼šæ˜¾ç¤ºæˆåŠŸä¿¡æ¯
function showSuccess(message) {
    const successMsg = document.createElement('div');
    successMsg.style.cssText = 'color: #28a745; text-align: center; margin: 10px 0; font-size: 14px; background: #d4edda; padding: 10px; border-radius: 4px; border: 1px solid #c3e6cb;';
    successMsg.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
    imageList.parentNode.insertBefore(successMsg, imageList);
    
    // 3ç§’åç§»é™¤æç¤º
    setTimeout(() => {
        if (successMsg.parentNode) {
            successMsg.parentNode.removeChild(successMsg);
        }
    }, 3000);
}

// è·å–CSRF Token
function getCSRFToken() {
    // é¦–å…ˆå°è¯•ä»metaæ ‡ç­¾è·å–
    const metaToken = document.querySelector('meta[name="csrf-token"]');
    if (metaToken) {
        return metaToken.getAttribute('content');
    }
    
    // ç„¶åå°è¯•ä»cookieè·å–
    return getCookie('csrftoken');
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// æ˜¾ç¤ºå‘å¸ƒæŒ‡å—
function showPublishGuide(isMobile) {
    const mobileGuide = `
        <h3 style="color: #ff2442; margin-bottom: 20px;">
            <i class="fas fa-mobile-alt"></i> æ‰‹æœºç«¯å‘å¸ƒæŒ‡å—
        </h3>
        <div style="margin-bottom: 20px;">
            <h4 style="color: #333;">ğŸš€ ä¸€é”®å‘å¸ƒæµç¨‹ï¼š</h4>
            <ol style="color: #666; line-height: 1.6;">
                <li>ç‚¹å‡»"æ‰“å¼€å°çº¢ä¹¦App"æŒ‰é’®</li>
                <li>å¦‚æœå·²å®‰è£…å°çº¢ä¹¦Appï¼Œä¼šè‡ªåŠ¨æ‰“å¼€å¹¶å¡«å……æ–‡æ¡ˆ</li>
                <li>å¦‚æœæœªå®‰è£…ï¼Œä¼šå¼•å¯¼æ‚¨ä¸‹è½½å°çº¢ä¹¦App</li>
                <li>æ–‡æ¡ˆå’Œæ ‡ç­¾ä¼šè‡ªåŠ¨å¡«å……åˆ°ç¼–è¾‘å™¨</li>
                <li>ä¸Šä¼ æ‚¨çš„å›¾ç‰‡ï¼Œç‚¹å‡»å‘å¸ƒå³å¯</li>
            </ol>
        </div>
        <div style="margin-bottom: 20px;">
            <h4 style="color: #333;">ğŸ’¡ æ™ºèƒ½åŠŸèƒ½ï¼š</h4>
            <ul style="color: #666; line-height: 1.6;">
                <li>âœ… è‡ªåŠ¨æ£€æµ‹è®¾å¤‡ç±»å‹ï¼Œæä¾›æœ€ä½³ä½“éªŒ</li>
                <li>âœ… æ·±åº¦é“¾æ¥ç›´æ¥æ‰“å¼€å°çº¢ä¹¦App</li>
                <li>âœ… æ–‡æ¡ˆå’Œæ ‡ç­¾è‡ªåŠ¨å¡«å……ï¼Œæ— éœ€æ‰‹åŠ¨å¤åˆ¶</li>
                <li>âœ… æ”¯æŒå¤šå›¾ä¸Šä¼ ï¼Œæœ€å¤š9å¼ å›¾ç‰‡</li>
            </ul>
        </div>
    `;
    
    const desktopGuide = `
        <h3 style="color: #ff2442; margin-bottom: 20px;">
            <i class="fas fa-desktop"></i> ç”µè„‘ç«¯å‘å¸ƒæŒ‡å—
        </h3>
        <div style="margin-bottom: 20px;">
            <h4 style="color: #333;">ğŸš€ ä¸€é”®å‘å¸ƒæµç¨‹ï¼š</h4>
            <ol style="color: #666; line-height: 1.6;">
                <li>ç‚¹å‡»"ç”µè„‘ç«¯æ‰«ç ç™»å½•"æŒ‰é’®</li>
                <li>ä½¿ç”¨å°çº¢ä¹¦Appæ‰«æäºŒç»´ç </li>
                <li>ç™»å½•æˆåŠŸåè‡ªåŠ¨è·³è½¬åˆ°å‘å¸ƒé¡µé¢</li>
                <li>æ–‡æ¡ˆå’Œæ ‡ç­¾ä¼šè‡ªåŠ¨å¡«å……åˆ°ç¼–è¾‘å™¨</li>
                <li>ä¸Šä¼ æ‚¨çš„å›¾ç‰‡ï¼Œç‚¹å‡»å‘å¸ƒå³å¯</li>
            </ol>
        </div>
        <div style="margin-bottom: 20px;">
            <h4 style="color: #333;">ğŸ’¡ æ™ºèƒ½åŠŸèƒ½ï¼š</h4>
            <ul style="color: #666; line-height: 1.6;">
                <li>âœ… æ‰«ç ç™»å½•åè‡ªåŠ¨è·³è½¬åˆ°å‘å¸ƒé¡µé¢</li>
                <li>âœ… æ–‡æ¡ˆå’Œæ ‡ç­¾è‡ªåŠ¨å¡«å……ï¼Œæ— éœ€æ‰‹åŠ¨å¤åˆ¶</li>
                <li>âœ… æ”¯æŒå¤šå›¾ä¸Šä¼ ï¼Œæœ€å¤š9å¼ å›¾ç‰‡</li>
                <li>âœ… æ”¯æŒHEICæ ¼å¼å›¾ç‰‡ä¸Šä¼ </li>
            </ul>
        </div>
    `;
    
    const guideHtml = `
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;">
            <div style="background: white; padding: 30px; border-radius: 10px; max-width: 500px; max-height: 80vh; overflow-y: auto;">
                ${isMobile ? mobileGuide : desktopGuide}
                <div style="text-align: center;">
                    <button onclick="closePublishGuide()" style="background: #ff2442; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                        çŸ¥é“äº†
                    </button>
                    <button onclick="openRedbookPublish()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                        ç«‹å³å‘å¸ƒ
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', guideHtml);
}

// å…³é—­å‘å¸ƒæŒ‡å—
function closePublishGuide() {
    const guide = document.querySelector('div[style*="z-index: 10000"]');
    if (guide) {
        guide.remove();
    }
}

// æ‰“å¼€å°çº¢ä¹¦å‘å¸ƒé¡µé¢
function openRedbookPublish() {
    if (generatedData && generatedData.redbook_publish_url) {
        window.open(generatedData.redbook_publish_url, '_blank');
    }
    closePublishGuide();
}
</script>
{% endblock %}