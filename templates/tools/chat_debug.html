{% extends 'base.html' %}
{% load static %}

{% block title %}èŠå¤©å®¤è°ƒè¯•{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>ğŸ”§ èŠå¤©å®¤è°ƒè¯•é¡µé¢</h1>
    
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>è¿æ¥çŠ¶æ€</h5>
                </div>
                <div class="card-body">
                    <div id="connectionStatus" class="alert alert-warning">
                        <i class="fas fa-wifi"></i> æœªè¿æ¥
                    </div>
                    <button id="connectBtn" class="btn btn-primary">è¿æ¥WebSocket</button>
                    <button id="disconnectBtn" class="btn btn-secondary">æ–­å¼€è¿æ¥</button>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>æˆ¿é—´ä¿¡æ¯</h5>
                </div>
                <div class="card-body">
                    <p><strong>æˆ¿é—´ID:</strong> <span id="roomId">{{ room_id|default:"test-room-123" }}</span></p>
                    <p><strong>å½“å‰ç”¨æˆ·:</strong> <span id="currentUser">{{ user.username }}</span></p>
                    <p><strong>WebSocket URL:</strong> <code id="wsUrl">ws://{{ request.get_host }}/ws/chat/{{ room_id|default:"test-room-123" }}/</code></p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>å‘é€æ¶ˆæ¯</h5>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <input type="text" id="messageInput" class="form-control" placeholder="è¾“å…¥æ¶ˆæ¯...">
                    </div>
                    <button id="sendBtn" class="btn btn-success mt-2">å‘é€</button>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>æ¥æ”¶æ¶ˆæ¯</h5>
                </div>
                <div class="card-body">
                    <div id="messageLog" style="height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background: #f8f9fa;">
                        <p class="text-muted">æ¶ˆæ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>è°ƒè¯•ä¿¡æ¯</h5>
                </div>
                <div class="card-body">
                    <div id="debugLog" style="height: 150px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background: #000; color: #0f0; font-family: monospace; font-size: 12px;">
                        <p>è°ƒè¯•æ—¥å¿—å°†åœ¨è¿™é‡Œæ˜¾ç¤º...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let socket = null;
let roomId = '{{ room_id|default:"test-room-123" }}';
let currentUser = '{{ user.username }}';

function log(message) {
    const debugLog = document.getElementById('debugLog');
    const timestamp = new Date().toLocaleTimeString();
    debugLog.innerHTML += `<div>[${timestamp}] ${message}</div>`;
    debugLog.scrollTop = debugLog.scrollHeight;
}

function updateConnectionStatus(status, message) {
    const statusElement = document.getElementById('connectionStatus');
    statusElement.className = `alert alert-${status === 'connected' ? 'success' : status === 'connecting' ? 'warning' : 'danger'}`;
    statusElement.innerHTML = `<i class="fas fa-wifi"></i> ${message}`;
    log(`è¿æ¥çŠ¶æ€: ${message}`);
}

function addMessage(message, type = 'info') {
    const messageLog = document.getElementById('messageLog');
    const timestamp = new Date().toLocaleTimeString();
    const color = type === 'sent' ? 'text-primary' : type === 'received' ? 'text-success' : 'text-muted';
    messageLog.innerHTML += `<div class="${color}">[${timestamp}] ${message}</div>`;
    messageLog.scrollTop = messageLog.scrollHeight;
}

function connectWebSocket() {
    const wsUrl = `ws://${window.location.host}/ws/chat/${roomId}/`;
    log(`å°è¯•è¿æ¥åˆ°: ${wsUrl}`);
    
    updateConnectionStatus('connecting', 'è¿æ¥ä¸­...');
    
    try {
        socket = new WebSocket(wsUrl);
        
        socket.onopen = function(event) {
            updateConnectionStatus('connected', 'å·²è¿æ¥');
            log('WebSocketè¿æ¥æˆåŠŸ');
            addMessage('WebSocketè¿æ¥å·²å»ºç«‹', 'info');
        };
        
        socket.onmessage = function(event) {
            log(`æ”¶åˆ°æ¶ˆæ¯: ${event.data}`);
            try {
                const data = JSON.parse(event.data);
                addMessage(`æ”¶åˆ°: ${JSON.stringify(data)}`, 'received');
            } catch (e) {
                addMessage(`æ”¶åˆ°åŸå§‹æ•°æ®: ${event.data}`, 'received');
            }
        };
        
        socket.onclose = function(event) {
            updateConnectionStatus('disconnected', 'è¿æ¥å·²æ–­å¼€');
            log(`WebSocketè¿æ¥å·²å…³é—­: ${event.code} - ${event.reason}`);
            addMessage('WebSocketè¿æ¥å·²æ–­å¼€', 'info');
        };
        
        socket.onerror = function(error) {
            updateConnectionStatus('disconnected', 'è¿æ¥é”™è¯¯');
            log(`WebSocketé”™è¯¯: ${error}`);
            addMessage('WebSocketè¿æ¥é”™è¯¯', 'info');
        };
        
    } catch (error) {
        log(`è¿æ¥å¤±è´¥: ${error.message}`);
        updateConnectionStatus('disconnected', 'è¿æ¥å¤±è´¥');
    }
}

function disconnectWebSocket() {
    if (socket) {
        socket.close();
        socket = null;
        log('æ‰‹åŠ¨æ–­å¼€WebSocketè¿æ¥');
    }
}

function sendMessage() {
    const messageInput = document.getElementById('messageInput');
    const message = messageInput.value.trim();
    
    if (!message) {
        alert('è¯·è¾“å…¥æ¶ˆæ¯');
        return;
    }
    
    if (!socket || socket.readyState !== WebSocket.OPEN) {
        alert('WebSocketæœªè¿æ¥');
        return;
    }
    
    const data = {
        type: 'message',
        content: message,
        message_type: 'text'
    };
    
    try {
        socket.send(JSON.stringify(data));
        addMessage(`å‘é€: ${message}`, 'sent');
        messageInput.value = '';
        log(`å‘é€æ¶ˆæ¯: ${JSON.stringify(data)}`);
    } catch (error) {
        log(`å‘é€å¤±è´¥: ${error.message}`);
        alert('å‘é€å¤±è´¥');
    }
}

// äº‹ä»¶ç›‘å¬å™¨
document.getElementById('connectBtn').addEventListener('click', connectWebSocket);
document.getElementById('disconnectBtn').addEventListener('click', disconnectWebSocket);
document.getElementById('sendBtn').addEventListener('click', sendMessage);
document.getElementById('messageInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        sendMessage();
    }
});

// é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    log('é¡µé¢åŠ è½½å®Œæˆ');
    log(`æˆ¿é—´ID: ${roomId}`);
    log(`å½“å‰ç”¨æˆ·: ${currentUser}`);
    log(`WebSocket URL: ws://${window.location.host}/ws/chat/${roomId}/`);
});
</script>
{% endblock %}
