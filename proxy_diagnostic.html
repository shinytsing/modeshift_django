<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”§ ä»£ç†è¯Šæ–­å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        .title {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        .diagnostic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .diagnostic-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        .diagnostic-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        .card-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .card-content {
            line-height: 1.6;
        }
        .test-button {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 10px 10px 10px 0;
        }
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }
        .test-button.danger {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
        }
        .test-button.warning {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        }
        .status-display {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .step-list {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .step-list h3 {
            margin-top: 0;
            color: #FFD700;
        }
        .step-list ol {
            padding-left: 20px;
        }
        .step-list li {
            margin-bottom: 10px;
            line-height: 1.5;
        }
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
            overflow-x: auto;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        .info { color: #2196F3; }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            .title {
                font-size: 2rem;
            }
            .diagnostic-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">ğŸ”§ ä»£ç†è¯Šæ–­å·¥å…·</h1>
            <p class="subtitle">è§£å†³Google.comç­‰ç½‘ç«™çš„ä¹±ç æ˜¾ç¤ºé—®é¢˜</p>
        </div>

        <div class="diagnostic-grid">
            <div class="diagnostic-card">
                <h3 class="card-title">ğŸ” é—®é¢˜è¯Šæ–­</h3>
                <div class="card-content">
                    <p>æ£€æµ‹ä»£ç†è¿æ¥çŠ¶æ€å’Œç½‘ç»œç¯å¢ƒ</p>
                    <button class="test-button" onclick="testProxyConnection()">æµ‹è¯•ä»£ç†è¿æ¥</button>
                    <button class="test-button" onclick="testDirectConnection()">æµ‹è¯•ç›´è¿</button>
                    <div class="status-display" id="connectionStatus">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
                </div>
            </div>

            <div class="diagnostic-card">
                <h3 class="card-title">ğŸš€ å¯åŠ¨ä»£ç†</h3>
                <div class="card-content">
                    <p>ä½¿ç”¨æ‚¨çš„Clashé…ç½®å¯åŠ¨ä»£ç†æœåŠ¡</p>
                    <button class="test-button" onclick="showClashSetup()">Clashè®¾ç½®æŒ‡å—</button>
                    <button class="test-button warning" onclick="testGoogleAccess()">æµ‹è¯•Googleè®¿é—®</button>
                    <div class="status-display" id="proxyStatus">ç­‰å¾…æ“ä½œ...</div>
                </div>
            </div>

            <div class="diagnostic-card">
                <h3 class="card-title">ğŸ› ï¸ ä¿®å¤å»ºè®®</h3>
                <div class="card-content">
                    <p>æ ¹æ®è¯Šæ–­ç»“æœæä¾›ä¿®å¤æ–¹æ¡ˆ</p>
                    <button class="test-button" onclick="showFixSuggestions()">æŸ¥çœ‹ä¿®å¤å»ºè®®</button>
                    <button class="test-button danger" onclick="resetSettings()">é‡ç½®è®¾ç½®</button>
                    <div class="status-display" id="fixStatus">ç­‰å¾…è¯Šæ–­ç»“æœ...</div>
                </div>
            </div>
        </div>

        <div class="step-list" id="clashSetup" style="display: none;">
            <h3>ğŸ“‹ Clashä»£ç†è®¾ç½®æ­¥éª¤</h3>
            <ol>
                <li><strong>ä¸‹è½½Clashå®¢æˆ·ç«¯</strong>
                    <ul>
                        <li>macOS: <code>brew install --cask clashx</code> æˆ–ä¸‹è½½ClashX</li>
                        <li>Windows: ä¸‹è½½Clash for Windows</li>
                    </ul>
                </li>
                <li><strong>ä½¿ç”¨é…ç½®æ–‡ä»¶</strong>
                    <div class="code-block">./start_clash_proxy.sh</div>
                    æˆ–æ‰‹åŠ¨å°† <code>clash_config_youtube_optimized.yaml</code> å¯¼å…¥Clash
                </li>
                <li><strong>å¯åŠ¨ä»£ç†</strong>
                    <ul>
                        <li>HTTPä»£ç†: 127.0.0.1:7890</li>
                        <li>SOCKSä»£ç†: 127.0.0.1:7891</li>
                    </ul>
                </li>
                <li><strong>æµ‹è¯•è¿æ¥</strong>
                    <p>ç‚¹å‡»ä¸Šæ–¹"æµ‹è¯•ä»£ç†è¿æ¥"æŒ‰é’®éªŒè¯</p>
                </li>
            </ol>
        </div>

        <div class="step-list" id="fixSuggestions" style="display: none;">
            <h3>ğŸ”§ å¸¸è§é—®é¢˜ä¿®å¤</h3>
            <div id="suggestionContent">
                <p>è¯·å…ˆè¿è¡Œè¯Šæ–­æµ‹è¯•...</p>
            </div>
        </div>
    </div>

    <script>
        let diagnosticResults = {};

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type; // success, error, warning, info
            element.innerHTML += `<span class="${colorClass}">[${timestamp}] ${message}</span>\n`;
            element.scrollTop = element.scrollHeight;
        }

        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        async function testProxyConnection() {
            clearLog('connectionStatus');
            log('connectionStatus', 'ğŸ” å¼€å§‹æµ‹è¯•ä»£ç†è¿æ¥...', 'info');
            
            // æµ‹è¯•HTTPä»£ç†
            try {
                const response = await fetch('http://httpbin.org/get', {
                    method: 'GET',
                    // æ³¨æ„ï¼šæµè§ˆå™¨ä¸­æ— æ³•ç›´æ¥è®¾ç½®ä»£ç†ï¼Œè¿™é‡Œåªæ˜¯æ¨¡æ‹Ÿæµ‹è¯•
                });
                
                if (response.ok) {
                    log('connectionStatus', 'âœ… ç½‘ç»œè¿æ¥æ­£å¸¸', 'success');
                    diagnosticResults.network = 'ok';
                } else {
                    log('connectionStatus', 'âš ï¸ ç½‘ç»œå“åº”å¼‚å¸¸', 'warning');
                    diagnosticResults.network = 'warning';
                }
            } catch (error) {
                log('connectionStatus', 'âŒ ç½‘ç»œè¿æ¥å¤±è´¥: ' + error.message, 'error');
                diagnosticResults.network = 'failed';
            }

            // æ¨¡æ‹Ÿä»£ç†ç«¯å£æ£€æµ‹
            log('connectionStatus', 'ğŸ” æ£€æµ‹ä»£ç†ç«¯å£...', 'info');
            
            // ç”±äºæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼Œæ— æ³•ç›´æ¥æµ‹è¯•æœ¬åœ°ç«¯å£
            // è¿™é‡Œæä¾›æŒ‡å¯¼ä¿¡æ¯
            log('connectionStatus', 'â„¹ï¸ è¯·æ‰‹åŠ¨æ£€æŸ¥ä»¥ä¸‹ç«¯å£æ˜¯å¦å¼€æ”¾:', 'info');
            log('connectionStatus', '   - HTTPä»£ç†: 127.0.0.1:7890', 'info');
            log('connectionStatus', '   - SOCKSä»£ç†: 127.0.0.1:7891', 'info');
            log('connectionStatus', 'ğŸ’¡ å¦‚æœä»£ç†æœªå¯åŠ¨ï¼Œè¯·æŒ‰ç…§å³ä¾§æŒ‡å—æ“ä½œ', 'warning');
            
            updateFixSuggestions();
        }

        async function testDirectConnection() {
            clearLog('connectionStatus');
            log('connectionStatus', 'ğŸŒ æµ‹è¯•ç›´æ¥è¿æ¥åˆ°Google...', 'info');
            
            try {
                // æµ‹è¯•æ˜¯å¦èƒ½è®¿é—®Googleï¼ˆå¯èƒ½ä¼šå› ä¸ºç½‘ç»œç¯å¢ƒè€Œå¤±è´¥ï¼‰
                const response = await fetch('https://www.google.com/', {
                    method: 'HEAD',
                    mode: 'no-cors'
                });
                
                log('connectionStatus', 'âœ… ç›´æ¥è®¿é—®æµ‹è¯•å®Œæˆ', 'success');
                log('connectionStatus', 'â„¹ï¸ å¦‚æœGoogleæ‰“å¼€æ˜¯ä¹±ç ï¼Œè¯´æ˜éœ€è¦ä»£ç†', 'info');
                diagnosticResults.direct = 'ok';
            } catch (error) {
                log('connectionStatus', 'âŒ ç›´æ¥è®¿é—®å¤±è´¥ï¼Œéœ€è¦ä½¿ç”¨ä»£ç†', 'warning');
                log('connectionStatus', 'åŸå› : ' + error.message, 'error');
                diagnosticResults.direct = 'failed';
            }
            
            updateFixSuggestions();
        }

        async function testGoogleAccess() {
            clearLog('proxyStatus');
            log('proxyStatus', 'ğŸ§ª æµ‹è¯•Googleè®¿é—®...', 'info');
            
            try {
                // è°ƒç”¨æˆ‘ä»¬çš„ä»£ç†API
                const response = await fetch('/tools/api/proxy/web-browse/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ url: 'https://www.google.com' })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log('proxyStatus', 'âœ… Googleè®¿é—®æˆåŠŸ!', 'success');
                    log('proxyStatus', `ğŸ“Š å†…å®¹é•¿åº¦: ${data.data.content_length} å­—ç¬¦`, 'info');
                    log('proxyStatus', `ğŸ”¤ ä½¿ç”¨ç¼–ç : ${data.data.charset_used}`, 'info');
                    log('proxyStatus', `ğŸ”— ä½¿ç”¨ä»£ç†: ${data.data.proxy_used}`, 'info');
                    
                    // æ£€æŸ¥å†…å®¹è´¨é‡
                    if (data.data.content_length > 10000) {
                        log('proxyStatus', 'âœ… å†…å®¹é•¿åº¦æ­£å¸¸ï¼Œåº”è¯¥ä¸ä¼šæ˜¾ç¤ºä¹±ç ', 'success');
                        diagnosticResults.google = 'ok';
                    } else {
                        log('proxyStatus', 'âš ï¸ å†…å®¹è¾ƒçŸ­ï¼Œå¯èƒ½å­˜åœ¨é—®é¢˜', 'warning');
                        diagnosticResults.google = 'warning';
                    }
                } else {
                    log('proxyStatus', 'âŒ Googleè®¿é—®å¤±è´¥: ' + data.error, 'error');
                    log('proxyStatus', 'ğŸ’¡ è¿™å¯èƒ½æ˜¯å¯¼è‡´ä¹±ç çš„åŸå› ', 'warning');
                    diagnosticResults.google = 'failed';
                }
            } catch (error) {
                log('proxyStatus', 'âŒ æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
                diagnosticResults.google = 'failed';
            }
            
            updateFixSuggestions();
        }

        function showClashSetup() {
            const setupDiv = document.getElementById('clashSetup');
            setupDiv.style.display = setupDiv.style.display === 'none' ? 'block' : 'none';
        }

        function showFixSuggestions() {
            const suggestionsDiv = document.getElementById('fixSuggestions');
            suggestionsDiv.style.display = suggestionsDiv.style.display === 'none' ? 'block' : 'none';
            updateFixSuggestions();
        }

        function updateFixSuggestions() {
            const content = document.getElementById('suggestionContent');
            let suggestions = '<h4>ğŸ”§ æ ¹æ®è¯Šæ–­ç»“æœçš„ä¿®å¤å»ºè®®:</h4>';
            
            if (diagnosticResults.google === 'failed') {
                suggestions += `
                    <div style="background: rgba(244, 67, 54, 0.1); padding: 15px; border-radius: 8px; margin: 10px 0;">
                        <h5>âŒ Googleè®¿é—®å¤±è´¥</h5>
                        <p><strong>åŸå› :</strong> ä»£ç†æœåŠ¡æœªå¯åŠ¨æˆ–é…ç½®é”™è¯¯</p>
                        <p><strong>è§£å†³æ–¹æ¡ˆ:</strong></p>
                        <ol>
                            <li>å¯åŠ¨Clashä»£ç†å®¢æˆ·ç«¯</li>
                            <li>ç¡®ä¿ä»£ç†ç«¯å£ 7890/7891 æ­£åœ¨ç›‘å¬</li>
                            <li>æ£€æŸ¥ä»£ç†é…ç½®æ–‡ä»¶æ˜¯å¦æ­£ç¡®</li>
                        </ol>
                    </div>
                `;
            }
            
            if (diagnosticResults.network === 'failed') {
                suggestions += `
                    <div style="background: rgba(255, 152, 0, 0.1); padding: 15px; border-radius: 8px; margin: 10px 0;">
                        <h5>âš ï¸ ç½‘ç»œè¿æ¥é—®é¢˜</h5>
                        <p><strong>è§£å†³æ–¹æ¡ˆ:</strong></p>
                        <ol>
                            <li>æ£€æŸ¥ç½‘ç»œè¿æ¥</li>
                            <li>å°è¯•é‡å¯è·¯ç”±å™¨</li>
                            <li>æ£€æŸ¥é˜²ç«å¢™è®¾ç½®</li>
                        </ol>
                    </div>
                `;
            }
            
            if (diagnosticResults.google === 'ok') {
                suggestions += `
                    <div style="background: rgba(76, 175, 80, 0.1); padding: 15px; border-radius: 8px; margin: 10px 0;">
                        <h5>âœ… Googleè®¿é—®æ­£å¸¸</h5>
                        <p>ä»£ç†å·¥ä½œæ­£å¸¸ï¼Œç°åœ¨åº”è¯¥ä¸ä¼šçœ‹åˆ°ä¹±ç äº†ï¼</p>
                        <p><strong>å»ºè®®:</strong> å¯ä»¥æ­£å¸¸ä½¿ç”¨ä»£ç†æµè§ˆå™¨è®¿é—®å¤–ç½‘</p>
                    </div>
                `;
            }
            
            if (Object.keys(diagnosticResults).length === 0) {
                suggestions += '<p>è¯·å…ˆè¿è¡Œä¸Šæ–¹çš„è¯Šæ–­æµ‹è¯•...</p>';
            }
            
            content.innerHTML = suggestions;
        }

        function resetSettings() {
            clearLog('fixStatus');
            log('fixStatus', 'ğŸ”„ é‡ç½®è®¾ç½®...', 'info');
            diagnosticResults = {};
            
            ['connectionStatus', 'proxyStatus'].forEach(id => {
                document.getElementById(id).innerHTML = 'è®¾ç½®å·²é‡ç½®ï¼Œå¯ä»¥é‡æ–°å¼€å§‹æµ‹è¯•';
            });
            
            log('fixStatus', 'âœ… è®¾ç½®å·²é‡ç½®', 'success');
            updateFixSuggestions();
        }

        // è·å–CSRF Token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„æç¤º
        window.onload = function() {
            log('connectionStatus', 'ğŸ¯ ä»£ç†è¯Šæ–­å·¥å…·å·²å°±ç»ª', 'info');
            log('connectionStatus', 'ğŸ‘† ç‚¹å‡»"æµ‹è¯•ä»£ç†è¿æ¥"å¼€å§‹è¯Šæ–­', 'info');
            
            log('proxyStatus', 'ğŸ“‹ ç­‰å¾…æµ‹è¯•Googleè®¿é—®...', 'info');
            log('proxyStatus', 'ğŸ’¡ ç¡®ä¿Clashä»£ç†å·²å¯åŠ¨åå†æµ‹è¯•', 'warning');
        };
    </script>
</body>
</html>
