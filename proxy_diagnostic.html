<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔧 代理诊断工具</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        .title {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        .diagnostic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .diagnostic-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        .diagnostic-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        .card-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .card-content {
            line-height: 1.6;
        }
        .test-button {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 10px 10px 10px 0;
        }
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }
        .test-button.danger {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
        }
        .test-button.warning {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        }
        .status-display {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .step-list {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .step-list h3 {
            margin-top: 0;
            color: #FFD700;
        }
        .step-list ol {
            padding-left: 20px;
        }
        .step-list li {
            margin-bottom: 10px;
            line-height: 1.5;
        }
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
            overflow-x: auto;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        .info { color: #2196F3; }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            .title {
                font-size: 2rem;
            }
            .diagnostic-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">🔧 代理诊断工具</h1>
            <p class="subtitle">解决Google.com等网站的乱码显示问题</p>
        </div>

        <div class="diagnostic-grid">
            <div class="diagnostic-card">
                <h3 class="card-title">🔍 问题诊断</h3>
                <div class="card-content">
                    <p>检测代理连接状态和网络环境</p>
                    <button class="test-button" onclick="testProxyConnection()">测试代理连接</button>
                    <button class="test-button" onclick="testDirectConnection()">测试直连</button>
                    <div class="status-display" id="connectionStatus">点击上方按钮开始测试...</div>
                </div>
            </div>

            <div class="diagnostic-card">
                <h3 class="card-title">🚀 启动代理</h3>
                <div class="card-content">
                    <p>使用您的Clash配置启动代理服务</p>
                    <button class="test-button" onclick="showClashSetup()">Clash设置指南</button>
                    <button class="test-button warning" onclick="testGoogleAccess()">测试Google访问</button>
                    <div class="status-display" id="proxyStatus">等待操作...</div>
                </div>
            </div>

            <div class="diagnostic-card">
                <h3 class="card-title">🛠️ 修复建议</h3>
                <div class="card-content">
                    <p>根据诊断结果提供修复方案</p>
                    <button class="test-button" onclick="showFixSuggestions()">查看修复建议</button>
                    <button class="test-button danger" onclick="resetSettings()">重置设置</button>
                    <div class="status-display" id="fixStatus">等待诊断结果...</div>
                </div>
            </div>
        </div>

        <div class="step-list" id="clashSetup" style="display: none;">
            <h3>📋 Clash代理设置步骤</h3>
            <ol>
                <li><strong>下载Clash客户端</strong>
                    <ul>
                        <li>macOS: <code>brew install --cask clashx</code> 或下载ClashX</li>
                        <li>Windows: 下载Clash for Windows</li>
                    </ul>
                </li>
                <li><strong>使用配置文件</strong>
                    <div class="code-block">./start_clash_proxy.sh</div>
                    或手动将 <code>clash_config_youtube_optimized.yaml</code> 导入Clash
                </li>
                <li><strong>启动代理</strong>
                    <ul>
                        <li>HTTP代理: 127.0.0.1:7890</li>
                        <li>SOCKS代理: 127.0.0.1:7891</li>
                    </ul>
                </li>
                <li><strong>测试连接</strong>
                    <p>点击上方"测试代理连接"按钮验证</p>
                </li>
            </ol>
        </div>

        <div class="step-list" id="fixSuggestions" style="display: none;">
            <h3>🔧 常见问题修复</h3>
            <div id="suggestionContent">
                <p>请先运行诊断测试...</p>
            </div>
        </div>
    </div>

    <script>
        let diagnosticResults = {};

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type; // success, error, warning, info
            element.innerHTML += `<span class="${colorClass}">[${timestamp}] ${message}</span>\n`;
            element.scrollTop = element.scrollHeight;
        }

        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        async function testProxyConnection() {
            clearLog('connectionStatus');
            log('connectionStatus', '🔍 开始测试代理连接...', 'info');
            
            // 测试HTTP代理
            try {
                const response = await fetch('http://httpbin.org/get', {
                    method: 'GET',
                    // 注意：浏览器中无法直接设置代理，这里只是模拟测试
                });
                
                if (response.ok) {
                    log('connectionStatus', '✅ 网络连接正常', 'success');
                    diagnosticResults.network = 'ok';
                } else {
                    log('connectionStatus', '⚠️ 网络响应异常', 'warning');
                    diagnosticResults.network = 'warning';
                }
            } catch (error) {
                log('connectionStatus', '❌ 网络连接失败: ' + error.message, 'error');
                diagnosticResults.network = 'failed';
            }

            // 模拟代理端口检测
            log('connectionStatus', '🔍 检测代理端口...', 'info');
            
            // 由于浏览器安全限制，无法直接测试本地端口
            // 这里提供指导信息
            log('connectionStatus', 'ℹ️ 请手动检查以下端口是否开放:', 'info');
            log('connectionStatus', '   - HTTP代理: 127.0.0.1:7890', 'info');
            log('connectionStatus', '   - SOCKS代理: 127.0.0.1:7891', 'info');
            log('connectionStatus', '💡 如果代理未启动，请按照右侧指南操作', 'warning');
            
            updateFixSuggestions();
        }

        async function testDirectConnection() {
            clearLog('connectionStatus');
            log('connectionStatus', '🌐 测试直接连接到Google...', 'info');
            
            try {
                // 测试是否能访问Google（可能会因为网络环境而失败）
                const response = await fetch('https://www.google.com/', {
                    method: 'HEAD',
                    mode: 'no-cors'
                });
                
                log('connectionStatus', '✅ 直接访问测试完成', 'success');
                log('connectionStatus', 'ℹ️ 如果Google打开是乱码，说明需要代理', 'info');
                diagnosticResults.direct = 'ok';
            } catch (error) {
                log('connectionStatus', '❌ 直接访问失败，需要使用代理', 'warning');
                log('connectionStatus', '原因: ' + error.message, 'error');
                diagnosticResults.direct = 'failed';
            }
            
            updateFixSuggestions();
        }

        async function testGoogleAccess() {
            clearLog('proxyStatus');
            log('proxyStatus', '🧪 测试Google访问...', 'info');
            
            try {
                // 调用我们的代理API
                const response = await fetch('/tools/api/proxy/web-browse/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ url: 'https://www.google.com' })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log('proxyStatus', '✅ Google访问成功!', 'success');
                    log('proxyStatus', `📊 内容长度: ${data.data.content_length} 字符`, 'info');
                    log('proxyStatus', `🔤 使用编码: ${data.data.charset_used}`, 'info');
                    log('proxyStatus', `🔗 使用代理: ${data.data.proxy_used}`, 'info');
                    
                    // 检查内容质量
                    if (data.data.content_length > 10000) {
                        log('proxyStatus', '✅ 内容长度正常，应该不会显示乱码', 'success');
                        diagnosticResults.google = 'ok';
                    } else {
                        log('proxyStatus', '⚠️ 内容较短，可能存在问题', 'warning');
                        diagnosticResults.google = 'warning';
                    }
                } else {
                    log('proxyStatus', '❌ Google访问失败: ' + data.error, 'error');
                    log('proxyStatus', '💡 这可能是导致乱码的原因', 'warning');
                    diagnosticResults.google = 'failed';
                }
            } catch (error) {
                log('proxyStatus', '❌ 测试失败: ' + error.message, 'error');
                diagnosticResults.google = 'failed';
            }
            
            updateFixSuggestions();
        }

        function showClashSetup() {
            const setupDiv = document.getElementById('clashSetup');
            setupDiv.style.display = setupDiv.style.display === 'none' ? 'block' : 'none';
        }

        function showFixSuggestions() {
            const suggestionsDiv = document.getElementById('fixSuggestions');
            suggestionsDiv.style.display = suggestionsDiv.style.display === 'none' ? 'block' : 'none';
            updateFixSuggestions();
        }

        function updateFixSuggestions() {
            const content = document.getElementById('suggestionContent');
            let suggestions = '<h4>🔧 根据诊断结果的修复建议:</h4>';
            
            if (diagnosticResults.google === 'failed') {
                suggestions += `
                    <div style="background: rgba(244, 67, 54, 0.1); padding: 15px; border-radius: 8px; margin: 10px 0;">
                        <h5>❌ Google访问失败</h5>
                        <p><strong>原因:</strong> 代理服务未启动或配置错误</p>
                        <p><strong>解决方案:</strong></p>
                        <ol>
                            <li>启动Clash代理客户端</li>
                            <li>确保代理端口 7890/7891 正在监听</li>
                            <li>检查代理配置文件是否正确</li>
                        </ol>
                    </div>
                `;
            }
            
            if (diagnosticResults.network === 'failed') {
                suggestions += `
                    <div style="background: rgba(255, 152, 0, 0.1); padding: 15px; border-radius: 8px; margin: 10px 0;">
                        <h5>⚠️ 网络连接问题</h5>
                        <p><strong>解决方案:</strong></p>
                        <ol>
                            <li>检查网络连接</li>
                            <li>尝试重启路由器</li>
                            <li>检查防火墙设置</li>
                        </ol>
                    </div>
                `;
            }
            
            if (diagnosticResults.google === 'ok') {
                suggestions += `
                    <div style="background: rgba(76, 175, 80, 0.1); padding: 15px; border-radius: 8px; margin: 10px 0;">
                        <h5>✅ Google访问正常</h5>
                        <p>代理工作正常，现在应该不会看到乱码了！</p>
                        <p><strong>建议:</strong> 可以正常使用代理浏览器访问外网</p>
                    </div>
                `;
            }
            
            if (Object.keys(diagnosticResults).length === 0) {
                suggestions += '<p>请先运行上方的诊断测试...</p>';
            }
            
            content.innerHTML = suggestions;
        }

        function resetSettings() {
            clearLog('fixStatus');
            log('fixStatus', '🔄 重置设置...', 'info');
            diagnosticResults = {};
            
            ['connectionStatus', 'proxyStatus'].forEach(id => {
                document.getElementById(id).innerHTML = '设置已重置，可以重新开始测试';
            });
            
            log('fixStatus', '✅ 设置已重置', 'success');
            updateFixSuggestions();
        }

        // 获取CSRF Token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // 页面加载完成后的提示
        window.onload = function() {
            log('connectionStatus', '🎯 代理诊断工具已就绪', 'info');
            log('connectionStatus', '👆 点击"测试代理连接"开始诊断', 'info');
            
            log('proxyStatus', '📋 等待测试Google访问...', 'info');
            log('proxyStatus', '💡 确保Clash代理已启动后再测试', 'warning');
        };
    </script>
</body>
</html>
