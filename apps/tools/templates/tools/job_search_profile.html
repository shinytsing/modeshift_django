{% extends 'base.html' %}
{% load static %}

{% block title %}æ±‚èŒè€…èµ„æ–™ - QAToolBox{% endblock %}

{% block extra_css %}
<style>
.profile-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    color: white;
}

.profile-header {
    text-align: center;
    margin-bottom: 40px;
}

.profile-header h1 {
    font-size: 2.5rem;
    margin-bottom: 10px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.profile-header p {
    font-size: 1.1rem;
    opacity: 0.9;
}

.profile-form {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    padding: 30px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}

.form-section {
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
}

.form-section:last-child {
    border-bottom: none;
}

.section-title {
    font-size: 1.3rem;
    margin-bottom: 20px;
    color: #fff;
    display: flex;
    align-items: center;
    gap: 10px;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #fff;
}

.form-control {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.1);
    color: white;
    font-size: 14px;
    transition: all 0.3s ease;
}

.form-control:focus {
    outline: none;
    border-color: #4CAF50;
    background: rgba(255, 255, 255, 0.2);
    box-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
}

.form-control::placeholder {
    color: rgba(255, 255, 255, 0.7);
}

textarea.form-control {
    min-height: 120px;
    resize: vertical;
}

.skills-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
}

.skill-tag {
    background: rgba(76, 175, 80, 0.3);
    color: white;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.skill-tag .remove-skill {
    cursor: pointer;
    font-weight: bold;
    opacity: 0.7;
}

.skill-tag .remove-skill:hover {
    opacity: 1;
}

.add-skill-input {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

.add-skill-input input {
    flex: 1;
}

.btn-primary {
    background: linear-gradient(45deg, #4CAF50, #45a049);
    color: white;
    border: none;
    padding: 12px 30px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 100%;
    margin-top: 20px;
}

.btn-primary:hover {
    background: linear-gradient(45deg, #45a049, #4CAF50);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
}

.btn-secondary {
    background: linear-gradient(45deg, #2196F3, #1976D2);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-secondary:hover {
    background: linear-gradient(45deg, #1976D2, #2196F3);
    transform: translateY(-1px);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 30px;
}

.stat-card {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.stat-number {
    font-size: 2rem;
    font-weight: bold;
    color: #4CAF50;
    margin-bottom: 5px;
}

.stat-label {
    font-size: 14px;
    opacity: 0.8;
}

.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.alert {
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    border: 1px solid;
}

.alert-success {
    background: rgba(76, 175, 80, 0.2);
    border-color: #4CAF50;
    color: #4CAF50;
}

.alert-error {
    background: rgba(244, 67, 54, 0.2);
    border-color: #f44336;
    color: #f44336;
}

@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .profile-header h1 {
        font-size: 2rem;
    }
    
    .stats-grid {
        grid-template-columns: 1fr 1fr;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="profile-container">
    <div class="profile-header">
        <h1>ğŸ‘¤ æ±‚èŒè€…èµ„æ–™</h1>
        <p>å®Œå–„æ‚¨çš„ä¸ªäººä¿¡æ¯ï¼Œæé«˜æ±‚èŒæˆåŠŸç‡</p>
    </div>

    <form id="profileForm" class="profile-form">
        <!-- åŸºæœ¬ä¿¡æ¯ -->
        <div class="form-section">
            <h3 class="section-title">ğŸ“‹ åŸºæœ¬ä¿¡æ¯</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="name">å§“å *</label>
                    <input type="text" id="name" class="form-control" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å" required>
                </div>
                <div class="form-group">
                    <label for="phone">æ‰‹æœºå·ç </label>
                    <input type="tel" id="phone" class="form-control" placeholder="è¯·è¾“å…¥æ‰‹æœºå·ç ">
                </div>
            </div>
            <div class="form-group">
                <label for="email">é‚®ç®±åœ°å€</label>
                <input type="email" id="email" class="form-control" placeholder="è¯·è¾“å…¥é‚®ç®±åœ°å€">
            </div>
        </div>

        <!-- æ±‚èŒä¿¡æ¯ -->
        <div class="form-section">
            <h3 class="section-title">ğŸ’¼ æ±‚èŒä¿¡æ¯</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="currentPosition">å½“å‰èŒä½</label>
                    <input type="text" id="currentPosition" class="form-control" placeholder="å¦‚ï¼šPythonå¼€å‘å·¥ç¨‹å¸ˆ">
                </div>
                <div class="form-group">
                    <label for="yearsOfExperience">å·¥ä½œå¹´é™</label>
                    <select id="yearsOfExperience" class="form-control">
                        <option value="0">åº”å±Šç”Ÿ</option>
                        <option value="1">1å¹´</option>
                        <option value="2">2å¹´</option>
                        <option value="3">3å¹´</option>
                        <option value="4">4å¹´</option>
                        <option value="5">5å¹´</option>
                        <option value="6">6å¹´</option>
                        <option value="7">7å¹´</option>
                        <option value="8">8å¹´</option>
                        <option value="9">9å¹´</option>
                        <option value="10">10å¹´ä»¥ä¸Š</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="educationLevel">æœ€é«˜å­¦å†</label>
                    <select id="educationLevel" class="form-control">
                        <option value="">è¯·é€‰æ‹©</option>
                        <option value="é«˜ä¸­">é«˜ä¸­</option>
                        <option value="å¤§ä¸“">å¤§ä¸“</option>
                        <option value="æœ¬ç§‘">æœ¬ç§‘</option>
                        <option value="ç¡•å£«">ç¡•å£«</option>
                        <option value="åšå£«">åšå£«</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="school">æ¯•ä¸šé™¢æ ¡</label>
                    <input type="text" id="school" class="form-control" placeholder="è¯·è¾“å…¥æ¯•ä¸šé™¢æ ¡">
                </div>
            </div>
            <div class="form-group">
                <label for="major">ä¸“ä¸š</label>
                <input type="text" id="major" class="form-control" placeholder="è¯·è¾“å…¥ä¸“ä¸šåç§°">
            </div>
        </div>

        <!-- æŠ€èƒ½å’ŒæœŸæœ› -->
        <div class="form-section">
            <h3 class="section-title">ğŸ› ï¸ æŠ€èƒ½å’ŒæœŸæœ›</h3>
            <div class="form-group">
                <label for="skills">æŠ€èƒ½æ ‡ç­¾</label>
                <div class="add-skill-input">
                    <input type="text" id="skillInput" class="form-control" placeholder="è¾“å…¥æŠ€èƒ½æ ‡ç­¾ï¼Œå¦‚ï¼šPython">
                    <button type="button" class="btn-secondary" onclick="addSkill()">æ·»åŠ </button>
                </div>
                <div id="skillsContainer" class="skills-container"></div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="expectedSalaryMin">æœŸæœ›æœ€ä½è–ªèµ„ (K/æœˆ)</label>
                    <input type="number" id="expectedSalaryMin" class="form-control" placeholder="å¦‚ï¼š15">
                </div>
                <div class="form-group">
                    <label for="expectedSalaryMax">æœŸæœ›æœ€é«˜è–ªèµ„ (K/æœˆ)</label>
                    <input type="number" id="expectedSalaryMax" class="form-control" placeholder="å¦‚ï¼š30">
                </div>
            </div>
            <div class="form-group">
                <label for="preferredLocations">æœŸæœ›å·¥ä½œåœ°ç‚¹ (ç”¨é€—å·åˆ†éš”)</label>
                <input type="text" id="preferredLocations" class="form-control" placeholder="å¦‚ï¼šåŒ—äº¬,ä¸Šæµ·,æ·±åœ³">
            </div>
            <div class="form-group">
                <label for="preferredIndustries">æœŸæœ›è¡Œä¸š (ç”¨é€—å·åˆ†éš”)</label>
                <input type="text" id="preferredIndustries" class="form-control" placeholder="å¦‚ï¼šäº’è”ç½‘,é‡‘è,æ•™è‚²">
            </div>
        </div>

        <!-- ç®€å†ä¿¡æ¯ -->
        <div class="form-section">
            <h3 class="section-title">ğŸ“„ ç®€å†ä¿¡æ¯</h3>
            <div class="form-group">
                <label for="resumeText">ç®€å†å†…å®¹</label>
                <textarea id="resumeText" class="form-control" placeholder="è¯·ç²˜è´´æ‚¨çš„ç®€å†å†…å®¹ï¼ŒåŒ…æ‹¬å·¥ä½œç»å†ã€é¡¹ç›®ç»éªŒç­‰"></textarea>
            </div>
            <div class="form-group">
                <label for="bossAccount">Bossç›´è˜è´¦å·</label>
                <input type="text" id="bossAccount" class="form-control" placeholder="è¯·è¾“å…¥æ‚¨çš„Bossç›´è˜è´¦å·">
            </div>
        </div>

        <!-- è®¾ç½® -->
        <div class="form-section">
            <h3 class="section-title">âš™ï¸ è®¾ç½®</h3>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="autoApplyEnabled" checked>
                    å¯ç”¨è‡ªåŠ¨æŠ•é€’
                </label>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="notificationEnabled" checked>
                    å¯ç”¨é€šçŸ¥æé†’
                </label>
            </div>
        </div>

        <button type="submit" class="btn-primary" id="saveProfileBtn">
            <span id="saveProfileText">ğŸ’¾ ä¿å­˜èµ„æ–™</span>
            <span id="saveProfileLoading" class="loading-spinner" style="display: none;"></span>
        </button>
    </form>

    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number" id="totalApplications">0</div>
            <div class="stat-label">æ€»æŠ•é€’æ•°</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="totalInterviews">0</div>
            <div class="stat-label">é¢è¯•é‚€è¯·</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="totalOffers">0</div>
            <div class="stat-label">æ”¶åˆ°Offer</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="successRate">0%</div>
            <div class="stat-label">æˆåŠŸç‡</div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let skills = [];

// é¡µé¢åŠ è½½æ—¶è·å–èµ„æ–™
document.addEventListener('DOMContentLoaded', function() {
    loadProfile();
    loadStatistics();
});

// ä¿å­˜èµ„æ–™
document.getElementById('profileForm').addEventListener('submit', function(e) {
    e.preventDefault();
    saveProfile();
});

// æ·»åŠ æŠ€èƒ½æ ‡ç­¾
function addSkill() {
    const skillInput = document.getElementById('skillInput');
    const skill = skillInput.value.trim();
    
    if (skill && !skills.includes(skill)) {
        skills.push(skill);
        updateSkillsDisplay();
        skillInput.value = '';
    }
}

// ç§»é™¤æŠ€èƒ½æ ‡ç­¾
function removeSkill(skill) {
    skills = skills.filter(s => s !== skill);
    updateSkillsDisplay();
}

// æ›´æ–°æŠ€èƒ½æ ‡ç­¾æ˜¾ç¤º
function updateSkillsDisplay() {
    const container = document.getElementById('skillsContainer');
    container.innerHTML = skills.map(skill => `
        <div class="skill-tag">
            ${skill}
            <span class="remove-skill" onclick="removeSkill('${skill}')">&times;</span>
        </div>
    `).join('');
}

// åŠ è½½èµ„æ–™
async function loadProfile() {
    try {
        const response = await fetch('/tools/api/job_search/profile/');
        const result = await response.json();
        
        if (result.success && result.data) {
            const data = result.data;
            
            // å¡«å……è¡¨å•
            document.getElementById('name').value = data.name || '';
            document.getElementById('phone').value = data.phone || '';
            document.getElementById('email').value = data.email || '';
            document.getElementById('currentPosition').value = data.current_position || '';
            document.getElementById('yearsOfExperience').value = data.years_of_experience || 0;
            document.getElementById('educationLevel').value = data.education_level || '';
            document.getElementById('school').value = data.school || '';
            document.getElementById('major').value = data.major || '';
            document.getElementById('expectedSalaryMin').value = data.expected_salary_min || '';
            document.getElementById('expectedSalaryMax').value = data.expected_salary_max || '';
            document.getElementById('preferredLocations').value = data.preferred_locations ? data.preferred_locations.join(',') : '';
            document.getElementById('preferredIndustries').value = data.preferred_industries ? data.preferred_industries.join(',') : '';
            document.getElementById('resumeText').value = data.resume_text || '';
            document.getElementById('bossAccount').value = data.boss_account || '';
            document.getElementById('autoApplyEnabled').checked = data.auto_apply_enabled !== false;
            document.getElementById('notificationEnabled').checked = data.notification_enabled !== false;
            
            // è®¾ç½®æŠ€èƒ½æ ‡ç­¾
            skills = data.skills || [];
            updateSkillsDisplay();
        }
    } catch (error) {
        console.error('åŠ è½½èµ„æ–™å¤±è´¥:', error);
    }
}

// ä¿å­˜èµ„æ–™
async function saveProfile() {
    const btn = document.getElementById('saveProfileBtn');
    const text = document.getElementById('saveProfileText');
    const loading = document.getElementById('saveProfileLoading');
    
    btn.disabled = true;
    text.style.display = 'none';
    loading.style.display = 'inline-block';
    
    const formData = {
        name: document.getElementById('name').value,
        phone: document.getElementById('phone').value,
        email: document.getElementById('email').value,
        current_position: document.getElementById('currentPosition').value,
        years_of_experience: parseInt(document.getElementById('yearsOfExperience').value),
        education_level: document.getElementById('educationLevel').value,
        school: document.getElementById('school').value,
        major: document.getElementById('major').value,
        skills: skills,
        expected_salary_min: parseInt(document.getElementById('expectedSalaryMin').value) || 0,
        expected_salary_max: parseInt(document.getElementById('expectedSalaryMax').value) || 0,
        preferred_locations: document.getElementById('preferredLocations').value.split(',').map(l => l.trim()).filter(l => l),
        preferred_industries: document.getElementById('preferredIndustries').value.split(',').map(i => i.trim()).filter(i => i),
        resume_text: document.getElementById('resumeText').value,
        boss_account: document.getElementById('bossAccount').value,
        auto_apply_enabled: document.getElementById('autoApplyEnabled').checked,
        notification_enabled: document.getElementById('notificationEnabled').checked
    };
    
    try {
        const response = await fetch('/tools/api/job_search/profile/save/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('èµ„æ–™ä¿å­˜æˆåŠŸï¼', 'success');
            loadStatistics();
        } else {
            showAlert(result.message, 'error');
        }
    } catch (error) {
        showAlert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    } finally {
        btn.disabled = false;
        text.style.display = 'inline';
        loading.style.display = 'none';
    }
}

// åŠ è½½ç»Ÿè®¡ä¿¡æ¯
async function loadStatistics() {
    try {
        const response = await fetch('/tools/api/job_search/statistics/');
        const result = await response.json();
        
        if (result.success) {
            const data = result.data;
            document.getElementById('totalApplications').textContent = data.total_applications || 0;
            document.getElementById('totalInterviews').textContent = data.total_interviews || 0;
            document.getElementById('totalOffers').textContent = data.total_offers || 0;
            document.getElementById('successRate').textContent = `${data.offer_rate || 0}%`;
        }
    } catch (error) {
        console.error('åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
    }
}

// æ˜¾ç¤ºæç¤ºä¿¡æ¯
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type}`;
    alertDiv.textContent = message;
    
    const container = document.querySelector('.profile-container');
    container.insertBefore(alertDiv, container.firstChild);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// è·å–CSRF Token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// å›è½¦é”®æ·»åŠ æŠ€èƒ½
document.getElementById('skillInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        addSkill();
    }
});
</script>
{% endblock %} 