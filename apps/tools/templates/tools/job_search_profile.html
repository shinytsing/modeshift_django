{% extends 'base.html' %}
{% load static %}

{% block title %}求职者资料 - QAToolBox{% endblock %}

{% block extra_css %}
<style>
.profile-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    color: white;
}

.profile-header {
    text-align: center;
    margin-bottom: 40px;
}

.profile-header h1 {
    font-size: 2.5rem;
    margin-bottom: 10px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.profile-header p {
    font-size: 1.1rem;
    opacity: 0.9;
}

.profile-form {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    padding: 30px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}

.form-section {
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
}

.form-section:last-child {
    border-bottom: none;
}

.section-title {
    font-size: 1.3rem;
    margin-bottom: 20px;
    color: #fff;
    display: flex;
    align-items: center;
    gap: 10px;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #fff;
}

.form-control {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.1);
    color: white;
    font-size: 14px;
    transition: all 0.3s ease;
}

.form-control:focus {
    outline: none;
    border-color: #4CAF50;
    background: rgba(255, 255, 255, 0.2);
    box-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
}

.form-control::placeholder {
    color: rgba(255, 255, 255, 0.7);
}

textarea.form-control {
    min-height: 120px;
    resize: vertical;
}

.skills-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
}

.skill-tag {
    background: rgba(76, 175, 80, 0.3);
    color: white;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.skill-tag .remove-skill {
    cursor: pointer;
    font-weight: bold;
    opacity: 0.7;
}

.skill-tag .remove-skill:hover {
    opacity: 1;
}

.add-skill-input {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

.add-skill-input input {
    flex: 1;
}

.btn-primary {
    background: linear-gradient(45deg, #4CAF50, #45a049);
    color: white;
    border: none;
    padding: 12px 30px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 100%;
    margin-top: 20px;
}

.btn-primary:hover {
    background: linear-gradient(45deg, #45a049, #4CAF50);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
}

.btn-secondary {
    background: linear-gradient(45deg, #2196F3, #1976D2);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-secondary:hover {
    background: linear-gradient(45deg, #1976D2, #2196F3);
    transform: translateY(-1px);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 30px;
}

.stat-card {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.stat-number {
    font-size: 2rem;
    font-weight: bold;
    color: #4CAF50;
    margin-bottom: 5px;
}

.stat-label {
    font-size: 14px;
    opacity: 0.8;
}

.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.alert {
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    border: 1px solid;
}

.alert-success {
    background: rgba(76, 175, 80, 0.2);
    border-color: #4CAF50;
    color: #4CAF50;
}

.alert-error {
    background: rgba(244, 67, 54, 0.2);
    border-color: #f44336;
    color: #f44336;
}

@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .profile-header h1 {
        font-size: 2rem;
    }
    
    .stats-grid {
        grid-template-columns: 1fr 1fr;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="profile-container">
    <div class="profile-header">
        <h1>👤 求职者资料</h1>
        <p>完善您的个人信息，提高求职成功率</p>
    </div>

    <form id="profileForm" class="profile-form">
        <!-- 基本信息 -->
        <div class="form-section">
            <h3 class="section-title">📋 基本信息</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="name">姓名 *</label>
                    <input type="text" id="name" class="form-control" placeholder="请输入您的姓名" required>
                </div>
                <div class="form-group">
                    <label for="phone">手机号码</label>
                    <input type="tel" id="phone" class="form-control" placeholder="请输入手机号码">
                </div>
            </div>
            <div class="form-group">
                <label for="email">邮箱地址</label>
                <input type="email" id="email" class="form-control" placeholder="请输入邮箱地址">
            </div>
        </div>

        <!-- 求职信息 -->
        <div class="form-section">
            <h3 class="section-title">💼 求职信息</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="currentPosition">当前职位</label>
                    <input type="text" id="currentPosition" class="form-control" placeholder="如：Python开发工程师">
                </div>
                <div class="form-group">
                    <label for="yearsOfExperience">工作年限</label>
                    <select id="yearsOfExperience" class="form-control">
                        <option value="0">应届生</option>
                        <option value="1">1年</option>
                        <option value="2">2年</option>
                        <option value="3">3年</option>
                        <option value="4">4年</option>
                        <option value="5">5年</option>
                        <option value="6">6年</option>
                        <option value="7">7年</option>
                        <option value="8">8年</option>
                        <option value="9">9年</option>
                        <option value="10">10年以上</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="educationLevel">最高学历</label>
                    <select id="educationLevel" class="form-control">
                        <option value="">请选择</option>
                        <option value="高中">高中</option>
                        <option value="大专">大专</option>
                        <option value="本科">本科</option>
                        <option value="硕士">硕士</option>
                        <option value="博士">博士</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="school">毕业院校</label>
                    <input type="text" id="school" class="form-control" placeholder="请输入毕业院校">
                </div>
            </div>
            <div class="form-group">
                <label for="major">专业</label>
                <input type="text" id="major" class="form-control" placeholder="请输入专业名称">
            </div>
        </div>

        <!-- 技能和期望 -->
        <div class="form-section">
            <h3 class="section-title">🛠️ 技能和期望</h3>
            <div class="form-group">
                <label for="skills">技能标签</label>
                <div class="add-skill-input">
                    <input type="text" id="skillInput" class="form-control" placeholder="输入技能标签，如：Python">
                    <button type="button" class="btn-secondary" onclick="addSkill()">添加</button>
                </div>
                <div id="skillsContainer" class="skills-container"></div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="expectedSalaryMin">期望最低薪资 (K/月)</label>
                    <input type="number" id="expectedSalaryMin" class="form-control" placeholder="如：15">
                </div>
                <div class="form-group">
                    <label for="expectedSalaryMax">期望最高薪资 (K/月)</label>
                    <input type="number" id="expectedSalaryMax" class="form-control" placeholder="如：30">
                </div>
            </div>
            <div class="form-group">
                <label for="preferredLocations">期望工作地点 (用逗号分隔)</label>
                <input type="text" id="preferredLocations" class="form-control" placeholder="如：北京,上海,深圳">
            </div>
            <div class="form-group">
                <label for="preferredIndustries">期望行业 (用逗号分隔)</label>
                <input type="text" id="preferredIndustries" class="form-control" placeholder="如：互联网,金融,教育">
            </div>
        </div>

        <!-- 简历信息 -->
        <div class="form-section">
            <h3 class="section-title">📄 简历信息</h3>
            <div class="form-group">
                <label for="resumeText">简历内容</label>
                <textarea id="resumeText" class="form-control" placeholder="请粘贴您的简历内容，包括工作经历、项目经验等"></textarea>
            </div>
            <div class="form-group">
                <label for="bossAccount">Boss直聘账号</label>
                <input type="text" id="bossAccount" class="form-control" placeholder="请输入您的Boss直聘账号">
            </div>
        </div>

        <!-- 设置 -->
        <div class="form-section">
            <h3 class="section-title">⚙️ 设置</h3>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="autoApplyEnabled" checked>
                    启用自动投递
                </label>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="notificationEnabled" checked>
                    启用通知提醒
                </label>
            </div>
        </div>

        <button type="submit" class="btn-primary" id="saveProfileBtn">
            <span id="saveProfileText">💾 保存资料</span>
            <span id="saveProfileLoading" class="loading-spinner" style="display: none;"></span>
        </button>
    </form>

    <!-- 统计信息 -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number" id="totalApplications">0</div>
            <div class="stat-label">总投递数</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="totalInterviews">0</div>
            <div class="stat-label">面试邀请</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="totalOffers">0</div>
            <div class="stat-label">收到Offer</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="successRate">0%</div>
            <div class="stat-label">成功率</div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let skills = [];

// 页面加载时获取资料
document.addEventListener('DOMContentLoaded', function() {
    loadProfile();
    loadStatistics();
});

// 保存资料
document.getElementById('profileForm').addEventListener('submit', function(e) {
    e.preventDefault();
    saveProfile();
});

// 添加技能标签
function addSkill() {
    const skillInput = document.getElementById('skillInput');
    const skill = skillInput.value.trim();
    
    if (skill && !skills.includes(skill)) {
        skills.push(skill);
        updateSkillsDisplay();
        skillInput.value = '';
    }
}

// 移除技能标签
function removeSkill(skill) {
    skills = skills.filter(s => s !== skill);
    updateSkillsDisplay();
}

// 更新技能标签显示
function updateSkillsDisplay() {
    const container = document.getElementById('skillsContainer');
    container.innerHTML = skills.map(skill => `
        <div class="skill-tag">
            ${skill}
            <span class="remove-skill" onclick="removeSkill('${skill}')">&times;</span>
        </div>
    `).join('');
}

// 加载资料
async function loadProfile() {
    try {
        const response = await fetch('/tools/api/job_search/profile/');
        const result = await response.json();
        
        if (result.success && result.data) {
            const data = result.data;
            
            // 填充表单
            document.getElementById('name').value = data.name || '';
            document.getElementById('phone').value = data.phone || '';
            document.getElementById('email').value = data.email || '';
            document.getElementById('currentPosition').value = data.current_position || '';
            document.getElementById('yearsOfExperience').value = data.years_of_experience || 0;
            document.getElementById('educationLevel').value = data.education_level || '';
            document.getElementById('school').value = data.school || '';
            document.getElementById('major').value = data.major || '';
            document.getElementById('expectedSalaryMin').value = data.expected_salary_min || '';
            document.getElementById('expectedSalaryMax').value = data.expected_salary_max || '';
            document.getElementById('preferredLocations').value = data.preferred_locations ? data.preferred_locations.join(',') : '';
            document.getElementById('preferredIndustries').value = data.preferred_industries ? data.preferred_industries.join(',') : '';
            document.getElementById('resumeText').value = data.resume_text || '';
            document.getElementById('bossAccount').value = data.boss_account || '';
            document.getElementById('autoApplyEnabled').checked = data.auto_apply_enabled !== false;
            document.getElementById('notificationEnabled').checked = data.notification_enabled !== false;
            
            // 设置技能标签
            skills = data.skills || [];
            updateSkillsDisplay();
        }
    } catch (error) {
        console.error('加载资料失败:', error);
    }
}

// 保存资料
async function saveProfile() {
    const btn = document.getElementById('saveProfileBtn');
    const text = document.getElementById('saveProfileText');
    const loading = document.getElementById('saveProfileLoading');
    
    btn.disabled = true;
    text.style.display = 'none';
    loading.style.display = 'inline-block';
    
    const formData = {
        name: document.getElementById('name').value,
        phone: document.getElementById('phone').value,
        email: document.getElementById('email').value,
        current_position: document.getElementById('currentPosition').value,
        years_of_experience: parseInt(document.getElementById('yearsOfExperience').value),
        education_level: document.getElementById('educationLevel').value,
        school: document.getElementById('school').value,
        major: document.getElementById('major').value,
        skills: skills,
        expected_salary_min: parseInt(document.getElementById('expectedSalaryMin').value) || 0,
        expected_salary_max: parseInt(document.getElementById('expectedSalaryMax').value) || 0,
        preferred_locations: document.getElementById('preferredLocations').value.split(',').map(l => l.trim()).filter(l => l),
        preferred_industries: document.getElementById('preferredIndustries').value.split(',').map(i => i.trim()).filter(i => i),
        resume_text: document.getElementById('resumeText').value,
        boss_account: document.getElementById('bossAccount').value,
        auto_apply_enabled: document.getElementById('autoApplyEnabled').checked,
        notification_enabled: document.getElementById('notificationEnabled').checked
    };
    
    try {
        const response = await fetch('/tools/api/job_search/profile/save/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('资料保存成功！', 'success');
            loadStatistics();
        } else {
            showAlert(result.message, 'error');
        }
    } catch (error) {
        showAlert('保存失败，请重试', 'error');
    } finally {
        btn.disabled = false;
        text.style.display = 'inline';
        loading.style.display = 'none';
    }
}

// 加载统计信息
async function loadStatistics() {
    try {
        const response = await fetch('/tools/api/job_search/statistics/');
        const result = await response.json();
        
        if (result.success) {
            const data = result.data;
            document.getElementById('totalApplications').textContent = data.total_applications || 0;
            document.getElementById('totalInterviews').textContent = data.total_interviews || 0;
            document.getElementById('totalOffers').textContent = data.total_offers || 0;
            document.getElementById('successRate').textContent = `${data.offer_rate || 0}%`;
        }
    } catch (error) {
        console.error('加载统计信息失败:', error);
    }
}

// 显示提示信息
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type}`;
    alertDiv.textContent = message;
    
    const container = document.querySelector('.profile-container');
    container.insertBefore(alertDiv, container.firstChild);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// 获取CSRF Token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// 回车键添加技能
document.getElementById('skillInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        addSkill();
    }
});
</script>
{% endblock %} 