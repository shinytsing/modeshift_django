{% extends 'base.html' %}
{% load static %}

{% block title %}è‡ªåŠ¨æ±‚èŒæœº - QAToolBox{% endblock %}

{% block extra_css %}
<style>
    .login-container {
        display: none;
        margin: 20px 0;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
    }
    
    .login-iframe {
        width: 100%;
        height: 600px;
        border: none;
        background: #f9f9f9;
    }
    
    .login-controls {
        background: #f8f9fa;
        padding: 15px;
        border-top: 1px solid #e0e0e0;
        display: flex;
        gap: 10px;
        align-items: center;
    }
    
    .btn-embedded {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-embedded:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-secondary:hover {
        background: #5a6268;
        transform: translateY(-2px);
    }
    
    .login-status {
        margin-left: auto;
        font-weight: 600;
        color: #495057;
    }
    
    .status-success {
        color: #28a745;
    }
    
    .status-error {
        color: #dc3545;
    }
    
    .token-info {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        max-height: 200px;
        overflow-y: auto;
        white-space: pre-wrap;
        display: none;
    }
    
    .login-header {
        background: #f8f9fa;
        padding: 15px;
        border-bottom: 1px solid #e0e0e0;
    }
    
    .login-header h5 {
        margin-bottom: 10px;
        color: #495057;
    }
    
    .login-tips {
        background: #f8f9fa;
        padding: 15px;
        border-top: 1px solid #e0e0e0;
    }
    
    .login-tips .alert {
        margin-bottom: 0;
    }
    
    .login-tips ul {
        padding-left: 20px;
    }
    
    .login-tips li {
        margin-bottom: 5px;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">
                        <i class="fas fa-robot"></i> è‡ªåŠ¨æ±‚èŒæœº
                    </h3>
                </div>
                <div class="card-body">
                    <!-- Bossç›´è˜ç™»å½•çŠ¶æ€ -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fab fa-boss"></i> Bossç›´è˜ç™»å½•çŠ¶æ€
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div id="bossLoginStatus">
                                        <p class="text-muted">æœªç™»å½•</p>
                                        <button id="checkLoginBtn" class="btn btn-primary btn-sm">
                                            <i class="fas fa-sync-alt"></i> æ£€æŸ¥ç™»å½•çŠ¶æ€
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-key"></i> TokençŠ¶æ€
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div id="tokenStatus">
                                        <p class="text-muted">æœªè·å–</p>
                                        <button id="getTokenBtn" class="btn btn-success btn-sm" disabled>
                                            <i class="fas fa-download"></i> è·å–Token
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ç™»å½•æ–¹å¼é€‰æ‹© -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-sign-in-alt"></i> Bossç›´è˜ç™»å½•
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="text-center p-4">
                                        <div class="mb-3">
                                            <i class="fas fa-window-maximize fa-3x text-primary"></i>
                                        </div>
                                        <h5>ğŸ“± åµŒå…¥å¼ç™»å½•</h5>
                                        <p class="text-muted">åœ¨é¡µé¢ä¸­ç›´æ¥ç™»å½•Bossç›´è˜ï¼Œæ›´å®‰å…¨å¯é </p>
                                        <button id="embeddedLoginBtn" class="btn btn-primary btn-lg">
                                            <i class="fas fa-window-maximize"></i> å¼€å§‹ç™»å½•
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- åµŒå…¥å¼ç™»å½•å®¹å™¨ -->
                    <div id="embeddedLoginContainer" class="login-container">
                        <div class="login-header">
                            <h5><i class="fas fa-info-circle"></i> ç™»å½•è¯´æ˜</h5>
                            <p class="text-muted">è¯·åœ¨ä¸‹æ–¹iframeä¸­å®ŒæˆBossç›´è˜ç™»å½•ï¼Œç™»å½•å®Œæˆåç‚¹å‡»"æ£€æŸ¥ç™»å½•çŠ¶æ€"æŒ‰é’®</p>
                        </div>
                        <iframe id="bossLoginFrame" class="login-iframe" src="about:blank"></iframe>
                        <div class="login-controls">
                            <button class="btn-embedded" onclick="checkLoginStatus()">
                                <i class="fas fa-sync-alt"></i> æ£€æŸ¥ç™»å½•çŠ¶æ€
                            </button>
                            <button class="btn-embedded" onclick="getUserToken()">
                                <i class="fas fa-key"></i> è·å–Token
                            </button>
                            <button class="btn-secondary" onclick="hideEmbeddedLogin()">
                                <i class="fas fa-times"></i> å…³é—­
                            </button>
                            <span id="loginStatusText" class="login-status">å‡†å¤‡ç™»å½•...</span>
                        </div>
                        <div class="login-tips">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-lightbulb"></i> ç™»å½•æç¤ºï¼š</h6>
                                <ul class="mb-0">
                                    <li>å¦‚æœiframeæ— æ³•æ­£å¸¸æ˜¾ç¤ºï¼Œè¯·å°è¯•åˆ·æ–°é¡µé¢</li>
                                    <li>ç™»å½•å®Œæˆåï¼Œè¯·ç­‰å¾…å‡ ç§’é’Ÿå†ç‚¹å‡»"æ£€æŸ¥ç™»å½•çŠ¶æ€"</li>
                                    <li>å¦‚æœç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒéªŒè¯ç </li>
                                    <li>å»ºè®®ä½¿ç”¨æ‰‹æœºå·+éªŒè¯ç æ–¹å¼ç™»å½•ï¼Œæ›´ç¨³å®š</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Tokenä¿¡æ¯æ˜¾ç¤º -->
                    <div id="tokenInfo" class="token-info"></div>



                    <!-- æ±‚èŒé…ç½®è¡¨å• -->
                    <div id="jobConfigForm" style="display: none;">
                        <hr>
                        <h4><i class="fas fa-cog"></i> æ±‚èŒé…ç½®</h4>
                        <form id="jobSearchForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="jobTitle">æœŸæœ›èŒä½</label>
                                        <input type="text" class="form-control" id="jobTitle" name="jobTitle" placeholder="å¦‚ï¼šPythonå¼€å‘å·¥ç¨‹å¸ˆ" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="location">å·¥ä½œåœ°ç‚¹</label>
                                        <input type="text" class="form-control" id="location" name="location" placeholder="å¦‚ï¼šåŒ—äº¬" required>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="minSalary">æœ€ä½è–ªèµ„ï¼ˆKï¼‰</label>
                                        <input type="number" class="form-control" id="minSalary" name="minSalary" min="1" max="100" value="10" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="maxSalary">æœ€é«˜è–ªèµ„ï¼ˆKï¼‰</label>
                                        <input type="number" class="form-control" id="maxSalary" name="maxSalary" min="1" max="200" value="30" required>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="experienceLevel">å·¥ä½œç»éªŒ</label>
                                        <select class="form-control" id="experienceLevel" name="experienceLevel" required>
                                            <option value="fresh">åº”å±Šç”Ÿ</option>
                                            <option value="1-3" selected>1-3å¹´</option>
                                            <option value="3-5">3-5å¹´</option>
                                            <option value="5-10">5-10å¹´</option>
                                            <option value="10+">10å¹´ä»¥ä¸Š</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="maxApplications">æœ€å¤§æŠ•é€’æ•°é‡</label>
                                        <input type="number" class="form-control" id="maxApplications" name="maxApplications" min="1" max="100" value="20" required>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="keywords">å…³é”®è¯ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰</label>
                                <input type="text" class="form-control" id="keywords" name="keywords" placeholder="å¦‚ï¼šPython,Django,Flask">
                            </div>
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-rocket"></i> å¼€å§‹è‡ªåŠ¨æ±‚èŒ
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let loginCheckInterval = null;

// æ˜¾ç¤ºæç¤ºä¿¡æ¯
function showAlert(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="close" data-dismiss="alert">
            <span>&times;</span>
        </button>
    `;
    document.querySelector('.card-body').insertBefore(alertDiv, document.querySelector('.card-body').firstChild);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// åµŒå…¥å¼ç™»å½•åŠŸèƒ½
function showEmbeddedLogin() {
    document.getElementById('embeddedLoginContainer').style.display = 'block';
    loadLoginPage();
}

function hideEmbeddedLogin() {
    document.getElementById('embeddedLoginContainer').style.display = 'none';
}

async function loadLoginPage() {
    try {
        document.getElementById('loginStatusText').textContent = 'æ­£åœ¨åŠ è½½ç™»å½•é¡µé¢...';
        
        const response = await fetch('/tools/api/boss/login_page_url/');
        const result = await response.json();
        
        if (result.success) {
            document.getElementById('bossLoginFrame').src = result.login_url;
            document.getElementById('loginStatusText').textContent = 'ç™»å½•é¡µé¢å·²åŠ è½½ï¼Œè¯·åœ¨iframeä¸­å®Œæˆç™»å½•';
            showAlert('ç™»å½•é¡µé¢åŠ è½½æˆåŠŸï¼è¯·åœ¨iframeä¸­å®Œæˆç™»å½•', 'success');
            
            // ç›‘å¬iframeåŠ è½½å®Œæˆäº‹ä»¶
            const iframe = document.getElementById('bossLoginFrame');
            iframe.onload = function() {

                document.getElementById('loginStatusText').textContent = 'é¡µé¢å·²åŠ è½½ï¼Œè¯·å¼€å§‹ç™»å½•';
            };
            
            // ç›‘å¬iframeé”™è¯¯äº‹ä»¶
            iframe.onerror = function() {
                console.error('Bossç›´è˜ç™»å½•é¡µé¢åŠ è½½å¤±è´¥');
                document.getElementById('loginStatusText').textContent = 'é¡µé¢åŠ è½½å¤±è´¥';
                showAlert('ç™»å½•é¡µé¢åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•', 'error');
            };
            
        } else {
            document.getElementById('loginStatusText').textContent = 'åŠ è½½å¤±è´¥';
            showAlert(result.message || 'åŠ è½½ç™»å½•é¡µé¢å¤±è´¥', 'error');
        }
    } catch (error) {
        console.error('åŠ è½½ç™»å½•é¡µé¢å¤±è´¥:', error);
        document.getElementById('loginStatusText').textContent = 'åŠ è½½å¤±è´¥';
        showAlert('åŠ è½½ç™»å½•é¡µé¢å¤±è´¥: ' + error.message, 'error');
    }
}

async function checkLoginStatus() {
    try {
        document.getElementById('loginStatusText').textContent = 'æ­£åœ¨æ£€æŸ¥ç™»å½•çŠ¶æ€...';
        
        // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
        const statusText = document.getElementById('loginStatusText');
        statusText.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨æ£€æŸ¥ç™»å½•çŠ¶æ€...';
        
        const response = await fetch('/tools/api/boss/check_login_selenium/');
        const result = await response.json();
        
        if (result.success) {
            if (result.is_logged_in) {
                statusText.innerHTML = '<i class="fas fa-check-circle"></i> å·²ç™»å½•';
                statusText.className = 'login-status status-success';
                updateBossLoginStatus(true, result.user_info);
                showAlert('ç™»å½•æˆåŠŸï¼', 'success');
                
                // è‡ªåŠ¨éšè—ç™»å½•å®¹å™¨
                setTimeout(() => {
                    hideEmbeddedLogin();
                }, 2000);
                
            } else {
                statusText.innerHTML = '<i class="fas fa-times-circle"></i> æœªç™»å½•';
                statusText.className = 'login-status status-error';
                
                // æä¾›æ›´è¯¦ç»†çš„æç¤ºä¿¡æ¯
                let tipMessage = 'ç”¨æˆ·å°šæœªç™»å½•ï¼Œè¯·åœ¨iframeä¸­å®Œæˆç™»å½•';
                if (result.page_title && result.page_title.includes('ç™»å½•')) {
                    tipMessage = 'è¯·å®Œæˆç™»å½•è¡¨å•å¹¶æäº¤';
                } else if (result.current_url && result.current_url.includes('login')) {
                    tipMessage = 'è¯·å®Œæˆç™»å½•æµç¨‹';
                }
                
                showAlert(tipMessage, 'info');
            }
        } else {
            statusText.innerHTML = '<i class="fas fa-exclamation-triangle"></i> æ£€æŸ¥å¤±è´¥';
            statusText.className = 'login-status status-error';
            
            // æ ¹æ®é”™è¯¯ç±»å‹æä¾›ä¸åŒçš„æç¤º
            let errorMessage = result.message || 'æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥';
            if (errorMessage.includes('WebDriver')) {
                errorMessage = 'æµè§ˆå™¨æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•';
            } else if (errorMessage.includes('ç½‘ç»œ')) {
                errorMessage = 'ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•';
            }
            
            showAlert(errorMessage, 'error');
        }
    } catch (error) {
        console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
        const statusText = document.getElementById('loginStatusText');
        statusText.innerHTML = '<i class="fas fa-exclamation-triangle"></i> æ£€æŸ¥å¤±è´¥';
        statusText.className = 'login-status status-error';
        
        let errorMessage = 'æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥: ' + error.message;
        if (error.message.includes('fetch')) {
            errorMessage = 'ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
        }
        
        showAlert(errorMessage, 'error');
    }
}

async function getUserToken() {
    try {
        document.getElementById('loginStatusText').textContent = 'æ­£åœ¨è·å–Token...';
        
        const response = await fetch('/tools/api/boss/user_token/');
        const result = await response.json();
        
        if (result.success && result.is_logged_in) {
            document.getElementById('loginStatusText').textContent = 'Tokenå·²è·å–';
            document.getElementById('loginStatusText').className = 'login-status status-success';
            
            // æ˜¾ç¤ºtokenä¿¡æ¯
            const tokenInfo = document.getElementById('tokenInfo');
            tokenInfo.textContent = JSON.stringify(result, null, 2);
            tokenInfo.style.display = 'block';
            
            updateTokenStatus(true);
            showAlert('Tokenè·å–æˆåŠŸï¼å¯ç”¨äºåç»­æ±‚èŒè¯·æ±‚', 'success');
        } else {
            document.getElementById('loginStatusText').textContent = 'è·å–å¤±è´¥';
            showAlert(result.message || 'è·å–Tokenå¤±è´¥ï¼Œè¯·å…ˆç™»å½•', 'error');
        }
    } catch (error) {
        console.error('è·å–Tokenå¤±è´¥:', error);
        document.getElementById('loginStatusText').textContent = 'è·å–å¤±è´¥';
        showAlert('è·å–Tokenå¤±è´¥: ' + error.message, 'error');
    }
}



// æ›´æ–°Bossç™»å½•çŠ¶æ€
function updateBossLoginStatus(isLoggedIn, userInfo = {}) {
    const statusDiv = document.getElementById('bossLoginStatus');
    if (isLoggedIn) {
        statusDiv.innerHTML = `
            <p class="text-success"><i class="fas fa-check-circle"></i> å·²ç™»å½•</p>
            <p class="text-muted small">ç”¨æˆ·: ${userInfo.username || 'æœªçŸ¥ç”¨æˆ·'}</p>
            <button class="btn btn-success btn-sm" onclick="getUserToken()">
                <i class="fas fa-key"></i> è·å–Token
            </button>
        `;
        document.getElementById('getTokenBtn').disabled = false;
        document.getElementById('jobConfigForm').style.display = 'block';
    } else {
        statusDiv.innerHTML = `
            <p class="text-muted">æœªç™»å½•</p>
            <button class="btn btn-primary btn-sm" onclick="checkLoginStatus()">
                <i class="fas fa-sync-alt"></i> æ£€æŸ¥ç™»å½•çŠ¶æ€
            </button>
        `;
        document.getElementById('getTokenBtn').disabled = true;
        document.getElementById('jobConfigForm').style.display = 'none';
    }
}

// æ›´æ–°TokençŠ¶æ€
function updateTokenStatus(hasToken) {
    const statusDiv = document.getElementById('tokenStatus');
    if (hasToken) {
        statusDiv.innerHTML = `
            <p class="text-success"><i class="fas fa-check-circle"></i> Tokenå·²è·å–</p>
            <button class="btn btn-info btn-sm" onclick="showTokenInfo()">
                <i class="fas fa-eye"></i> æŸ¥çœ‹Token
            </button>
        `;
    } else {
        statusDiv.innerHTML = `
            <p class="text-muted">æœªè·å–</p>
            <button class="btn btn-success btn-sm" onclick="getUserToken()" disabled>
                <i class="fas fa-download"></i> è·å–Token
            </button>
        `;
    }
}

// æ˜¾ç¤ºTokenä¿¡æ¯
function showTokenInfo() {
    const tokenInfo = document.getElementById('tokenInfo');
    if (tokenInfo.style.display === 'none') {
        tokenInfo.style.display = 'block';
    } else {
        tokenInfo.style.display = 'none';
    }
}

// é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // ç»‘å®šæŒ‰é’®äº‹ä»¶
    document.getElementById('embeddedLoginBtn').addEventListener('click', showEmbeddedLogin);
    document.getElementById('checkLoginBtn').addEventListener('click', checkLoginStatus);
    document.getElementById('getTokenBtn').addEventListener('click', getUserToken);
    
    // æ£€æŸ¥åˆå§‹ç™»å½•çŠ¶æ€
    checkLoginStatus();
    
    // æ·»åŠ è‡ªåŠ¨é‡è¯•æœºåˆ¶
    let retryCount = 0;
    const maxRetries = 3;
    
    // ç›‘å¬ç™»å½•çŠ¶æ€æ£€æŸ¥å¤±è´¥ï¼Œè‡ªåŠ¨é‡è¯•
    window.addEventListener('loginCheckFailed', function() {
        if (retryCount < maxRetries) {
            retryCount++;

            setTimeout(() => {
                checkLoginStatus();
            }, 2000 * retryCount); // é€’å¢å»¶è¿Ÿ
        }
    });

});
</script>
{% endblock %} 