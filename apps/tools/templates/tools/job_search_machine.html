{% extends 'base.html' %}
{% load static %}

{% block title %}自动求职机 - QAToolBox{% endblock %}

{% block extra_css %}
<style>
    .login-container {
        display: none;
        margin: 20px 0;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
    }
    
    .login-iframe {
        width: 100%;
        height: 600px;
        border: none;
        background: #f9f9f9;
    }
    
    .login-controls {
        background: #f8f9fa;
        padding: 15px;
        border-top: 1px solid #e0e0e0;
        display: flex;
        gap: 10px;
        align-items: center;
    }
    
    .btn-embedded {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-embedded:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-secondary:hover {
        background: #5a6268;
        transform: translateY(-2px);
    }
    
    .login-status {
        margin-left: auto;
        font-weight: 600;
        color: #495057;
    }
    
    .status-success {
        color: #28a745;
    }
    
    .status-error {
        color: #dc3545;
    }
    
    .token-info {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        max-height: 200px;
        overflow-y: auto;
        white-space: pre-wrap;
        display: none;
    }
    
    .login-header {
        background: #f8f9fa;
        padding: 15px;
        border-bottom: 1px solid #e0e0e0;
    }
    
    .login-header h5 {
        margin-bottom: 10px;
        color: #495057;
    }
    
    .login-tips {
        background: #f8f9fa;
        padding: 15px;
        border-top: 1px solid #e0e0e0;
    }
    
    .login-tips .alert {
        margin-bottom: 0;
    }
    
    .login-tips ul {
        padding-left: 20px;
    }
    
    .login-tips li {
        margin-bottom: 5px;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">
                        <i class="fas fa-robot"></i> 自动求职机
                    </h3>
                </div>
                <div class="card-body">
                    <!-- Boss直聘登录状态 -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fab fa-boss"></i> Boss直聘登录状态
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div id="bossLoginStatus">
                                        <p class="text-muted">未登录</p>
                                        <button id="checkLoginBtn" class="btn btn-primary btn-sm">
                                            <i class="fas fa-sync-alt"></i> 检查登录状态
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-key"></i> Token状态
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div id="tokenStatus">
                                        <p class="text-muted">未获取</p>
                                        <button id="getTokenBtn" class="btn btn-success btn-sm" disabled>
                                            <i class="fas fa-download"></i> 获取Token
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 登录方式选择 -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-sign-in-alt"></i> Boss直聘登录
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="text-center p-4">
                                        <div class="mb-3">
                                            <i class="fas fa-window-maximize fa-3x text-primary"></i>
                                        </div>
                                        <h5>📱 嵌入式登录</h5>
                                        <p class="text-muted">在页面中直接登录Boss直聘，更安全可靠</p>
                                        <button id="embeddedLoginBtn" class="btn btn-primary btn-lg">
                                            <i class="fas fa-window-maximize"></i> 开始登录
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 嵌入式登录容器 -->
                    <div id="embeddedLoginContainer" class="login-container">
                        <div class="login-header">
                            <h5><i class="fas fa-info-circle"></i> 登录说明</h5>
                            <p class="text-muted">请在下方iframe中完成Boss直聘登录，登录完成后点击"检查登录状态"按钮</p>
                        </div>
                        <iframe id="bossLoginFrame" class="login-iframe" src="about:blank"></iframe>
                        <div class="login-controls">
                            <button class="btn-embedded" onclick="checkLoginStatus()">
                                <i class="fas fa-sync-alt"></i> 检查登录状态
                            </button>
                            <button class="btn-embedded" onclick="getUserToken()">
                                <i class="fas fa-key"></i> 获取Token
                            </button>
                            <button class="btn-secondary" onclick="hideEmbeddedLogin()">
                                <i class="fas fa-times"></i> 关闭
                            </button>
                            <span id="loginStatusText" class="login-status">准备登录...</span>
                        </div>
                        <div class="login-tips">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-lightbulb"></i> 登录提示：</h6>
                                <ul class="mb-0">
                                    <li>如果iframe无法正常显示，请尝试刷新页面</li>
                                    <li>登录完成后，请等待几秒钟再点击"检查登录状态"</li>
                                    <li>如果登录失败，请检查网络连接和验证码</li>
                                    <li>建议使用手机号+验证码方式登录，更稳定</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Token信息显示 -->
                    <div id="tokenInfo" class="token-info"></div>



                    <!-- 求职配置表单 -->
                    <div id="jobConfigForm" style="display: none;">
                        <hr>
                        <h4><i class="fas fa-cog"></i> 求职配置</h4>
                        <form id="jobSearchForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="jobTitle">期望职位</label>
                                        <input type="text" class="form-control" id="jobTitle" name="jobTitle" placeholder="如：Python开发工程师" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="location">工作地点</label>
                                        <input type="text" class="form-control" id="location" name="location" placeholder="如：北京" required>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="minSalary">最低薪资（K）</label>
                                        <input type="number" class="form-control" id="minSalary" name="minSalary" min="1" max="100" value="10" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="maxSalary">最高薪资（K）</label>
                                        <input type="number" class="form-control" id="maxSalary" name="maxSalary" min="1" max="200" value="30" required>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="experienceLevel">工作经验</label>
                                        <select class="form-control" id="experienceLevel" name="experienceLevel" required>
                                            <option value="fresh">应届生</option>
                                            <option value="1-3" selected>1-3年</option>
                                            <option value="3-5">3-5年</option>
                                            <option value="5-10">5-10年</option>
                                            <option value="10+">10年以上</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="maxApplications">最大投递数量</label>
                                        <input type="number" class="form-control" id="maxApplications" name="maxApplications" min="1" max="100" value="20" required>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="keywords">关键词（用逗号分隔）</label>
                                <input type="text" class="form-control" id="keywords" name="keywords" placeholder="如：Python,Django,Flask">
                            </div>
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-rocket"></i> 开始自动求职
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let loginCheckInterval = null;

// 显示提示信息
function showAlert(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="close" data-dismiss="alert">
            <span>&times;</span>
        </button>
    `;
    document.querySelector('.card-body').insertBefore(alertDiv, document.querySelector('.card-body').firstChild);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// 嵌入式登录功能
function showEmbeddedLogin() {
    document.getElementById('embeddedLoginContainer').style.display = 'block';
    loadLoginPage();
}

function hideEmbeddedLogin() {
    document.getElementById('embeddedLoginContainer').style.display = 'none';
}

async function loadLoginPage() {
    try {
        document.getElementById('loginStatusText').textContent = '正在加载登录页面...';
        
        const response = await fetch('/tools/api/boss/login_page_url/');
        const result = await response.json();
        
        if (result.success) {
            document.getElementById('bossLoginFrame').src = result.login_url;
            document.getElementById('loginStatusText').textContent = '登录页面已加载，请在iframe中完成登录';
            showAlert('登录页面加载成功！请在iframe中完成登录', 'success');
            
            // 监听iframe加载完成事件
            const iframe = document.getElementById('bossLoginFrame');
            iframe.onload = function() {

                document.getElementById('loginStatusText').textContent = '页面已加载，请开始登录';
            };
            
            // 监听iframe错误事件
            iframe.onerror = function() {
                console.error('Boss直聘登录页面加载失败');
                document.getElementById('loginStatusText').textContent = '页面加载失败';
                showAlert('登录页面加载失败，请刷新重试', 'error');
            };
            
        } else {
            document.getElementById('loginStatusText').textContent = '加载失败';
            showAlert(result.message || '加载登录页面失败', 'error');
        }
    } catch (error) {
        console.error('加载登录页面失败:', error);
        document.getElementById('loginStatusText').textContent = '加载失败';
        showAlert('加载登录页面失败: ' + error.message, 'error');
    }
}

async function checkLoginStatus() {
    try {
        document.getElementById('loginStatusText').textContent = '正在检查登录状态...';
        
        // 显示加载动画
        const statusText = document.getElementById('loginStatusText');
        statusText.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在检查登录状态...';
        
        const response = await fetch('/tools/api/boss/check_login_selenium/');
        const result = await response.json();
        
        if (result.success) {
            if (result.is_logged_in) {
                statusText.innerHTML = '<i class="fas fa-check-circle"></i> 已登录';
                statusText.className = 'login-status status-success';
                updateBossLoginStatus(true, result.user_info);
                showAlert('登录成功！', 'success');
                
                // 自动隐藏登录容器
                setTimeout(() => {
                    hideEmbeddedLogin();
                }, 2000);
                
            } else {
                statusText.innerHTML = '<i class="fas fa-times-circle"></i> 未登录';
                statusText.className = 'login-status status-error';
                
                // 提供更详细的提示信息
                let tipMessage = '用户尚未登录，请在iframe中完成登录';
                if (result.page_title && result.page_title.includes('登录')) {
                    tipMessage = '请完成登录表单并提交';
                } else if (result.current_url && result.current_url.includes('login')) {
                    tipMessage = '请完成登录流程';
                }
                
                showAlert(tipMessage, 'info');
            }
        } else {
            statusText.innerHTML = '<i class="fas fa-exclamation-triangle"></i> 检查失败';
            statusText.className = 'login-status status-error';
            
            // 根据错误类型提供不同的提示
            let errorMessage = result.message || '检查登录状态失败';
            if (errorMessage.includes('WebDriver')) {
                errorMessage = '浏览器服务暂时不可用，请稍后重试';
            } else if (errorMessage.includes('网络')) {
                errorMessage = '网络连接异常，请检查网络后重试';
            }
            
            showAlert(errorMessage, 'error');
        }
    } catch (error) {
        console.error('检查登录状态失败:', error);
        const statusText = document.getElementById('loginStatusText');
        statusText.innerHTML = '<i class="fas fa-exclamation-triangle"></i> 检查失败';
        statusText.className = 'login-status status-error';
        
        let errorMessage = '检查登录状态失败: ' + error.message;
        if (error.message.includes('fetch')) {
            errorMessage = '网络请求失败，请检查网络连接';
        }
        
        showAlert(errorMessage, 'error');
    }
}

async function getUserToken() {
    try {
        document.getElementById('loginStatusText').textContent = '正在获取Token...';
        
        const response = await fetch('/tools/api/boss/user_token/');
        const result = await response.json();
        
        if (result.success && result.is_logged_in) {
            document.getElementById('loginStatusText').textContent = 'Token已获取';
            document.getElementById('loginStatusText').className = 'login-status status-success';
            
            // 显示token信息
            const tokenInfo = document.getElementById('tokenInfo');
            tokenInfo.textContent = JSON.stringify(result, null, 2);
            tokenInfo.style.display = 'block';
            
            updateTokenStatus(true);
            showAlert('Token获取成功！可用于后续求职请求', 'success');
        } else {
            document.getElementById('loginStatusText').textContent = '获取失败';
            showAlert(result.message || '获取Token失败，请先登录', 'error');
        }
    } catch (error) {
        console.error('获取Token失败:', error);
        document.getElementById('loginStatusText').textContent = '获取失败';
        showAlert('获取Token失败: ' + error.message, 'error');
    }
}



// 更新Boss登录状态
function updateBossLoginStatus(isLoggedIn, userInfo = {}) {
    const statusDiv = document.getElementById('bossLoginStatus');
    if (isLoggedIn) {
        statusDiv.innerHTML = `
            <p class="text-success"><i class="fas fa-check-circle"></i> 已登录</p>
            <p class="text-muted small">用户: ${userInfo.username || '未知用户'}</p>
            <button class="btn btn-success btn-sm" onclick="getUserToken()">
                <i class="fas fa-key"></i> 获取Token
            </button>
        `;
        document.getElementById('getTokenBtn').disabled = false;
        document.getElementById('jobConfigForm').style.display = 'block';
    } else {
        statusDiv.innerHTML = `
            <p class="text-muted">未登录</p>
            <button class="btn btn-primary btn-sm" onclick="checkLoginStatus()">
                <i class="fas fa-sync-alt"></i> 检查登录状态
            </button>
        `;
        document.getElementById('getTokenBtn').disabled = true;
        document.getElementById('jobConfigForm').style.display = 'none';
    }
}

// 更新Token状态
function updateTokenStatus(hasToken) {
    const statusDiv = document.getElementById('tokenStatus');
    if (hasToken) {
        statusDiv.innerHTML = `
            <p class="text-success"><i class="fas fa-check-circle"></i> Token已获取</p>
            <button class="btn btn-info btn-sm" onclick="showTokenInfo()">
                <i class="fas fa-eye"></i> 查看Token
            </button>
        `;
    } else {
        statusDiv.innerHTML = `
            <p class="text-muted">未获取</p>
            <button class="btn btn-success btn-sm" onclick="getUserToken()" disabled>
                <i class="fas fa-download"></i> 获取Token
            </button>
        `;
    }
}

// 显示Token信息
function showTokenInfo() {
    const tokenInfo = document.getElementById('tokenInfo');
    if (tokenInfo.style.display === 'none') {
        tokenInfo.style.display = 'block';
    } else {
        tokenInfo.style.display = 'none';
    }
}

// 页面加载完成后的初始化
document.addEventListener('DOMContentLoaded', function() {
    // 绑定按钮事件
    document.getElementById('embeddedLoginBtn').addEventListener('click', showEmbeddedLogin);
    document.getElementById('checkLoginBtn').addEventListener('click', checkLoginStatus);
    document.getElementById('getTokenBtn').addEventListener('click', getUserToken);
    
    // 检查初始登录状态
    checkLoginStatus();
    
    // 添加自动重试机制
    let retryCount = 0;
    const maxRetries = 3;
    
    // 监听登录状态检查失败，自动重试
    window.addEventListener('loginCheckFailed', function() {
        if (retryCount < maxRetries) {
            retryCount++;

            setTimeout(() => {
                checkLoginStatus();
            }, 2000 * retryCount); // 递增延迟
        }
    });

});
</script>
{% endblock %} 