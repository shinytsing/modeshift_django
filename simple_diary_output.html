

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="">
    
    <title>简单生活日记</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="shortcut icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <!-- 本地字体回退方案，避免Google Fonts加载失败 -->
    <style>
        /* 字体回退方案 */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }
        code, pre {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
        }
        /* 确保字体加载失败时页面仍能正常显示 */
        .font-fallback {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif !important;
        }
    </style>
    <link id="dynamic-theme-css" rel="stylesheet" href="/static/geek.css">
    <link rel="stylesheet" href="/static/responsive.css">
    <link rel="stylesheet" href="/static/css/feature-recommendation.css">
    

    <style>
        /* 全局container-fluid隐藏和悬停显示 */
        .container-fluid {
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
            pointer-events: none;
        }
        
        .container-fluid:hover,
        .container-fluid.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
        
        /* 隐藏导航栏 */
        .navbar.navbar-expand-lg.navbar-dark.unified-navbar,
        .navbar.unified-navbar,
        .geek-navbar,
        .life-navbar,
        .emo-navbar,
        .cyber-navbar,
        .rage-navbar,
        .punk-navbar {
            display: none !important;
        }
        
        /* 顶部栏动画效果 */
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        
        /* 顶部固定UI - 与主页保持一致的颜色 */
        .top-ui-bar {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            z-index: 9999 !important;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%) !important;
            backdrop-filter: blur(20px) !important;
            border-bottom: 2px solid rgba(255, 255, 255, 0.15) !important;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 20px rgba(102, 126, 234, 0.2) !important;
            padding: 15px 20px !important;
            display: flex !important;
            justify-content: space-around !important;
            align-items: center !important;
            opacity: 1 !important;
            transform: translateY(0) !important;
            transition: all 0.3s ease !important;
            border-radius: 0 0 15px 15px !important;
            min-height: 70px !important;
        }
        
        /* 用户下拉菜单样式 */
        .top-ui-user-dropdown {
            position: relative;
            display: inline-block;
        }
        
        .top-ui-user-dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background: linear-gradient(135deg, rgba(10, 10, 10, 0.95) 0%, rgba(26, 26, 26, 0.95) 50%, rgba(45, 45, 45, 0.95) 100%);
            backdrop-filter: blur(20px);
            border: 2px solid #00ff41;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 255, 65, 0.3), 0 0 20px rgba(0, 255, 65, 0.1);
            min-width: 200px;
            z-index: 10000;
            margin-top: 10px;
            padding: 10px 0;
        }
        
        .top-ui-user-dropdown-content.show {
            display: block;
            animation: dropdownFadeIn 0.3s ease;
        }
        
        @keyframes dropdownFadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .top-ui-dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            color: #ffffff;
            text-decoration: none;
            transition: all 0.3s ease;
            border-bottom: 1px solid rgba(0, 255, 65, 0.2);
        }
        
        .top-ui-dropdown-item:last-child {
            border-bottom: none;
        }
        
        .top-ui-dropdown-item:hover {
            background: rgba(0, 255, 65, 0.1);
            color: #00ff41;
            text-shadow: 0 0 8px #00ff41;
        }
        
        .top-ui-dropdown-item i {
            width: 16px;
            text-align: center;
        }
        
        .top-ui-brand {
            color: #ffffff;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .top-ui-user {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #ffffff;
        }
        
        /* 按钮动画效果 */
        @keyframes buttonPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @keyframes buttonShine {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }
        
        @keyframes buttonGlow {
            0% { box-shadow: 0 2px 10px rgba(255, 255, 255, 0.3); }
            50% { box-shadow: 0 4px 20px rgba(255, 255, 255, 0.5); }
            100% { box-shadow: 0 2px 10px rgba(255, 255, 255, 0.3); }
        }
        
        @keyframes iconSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes iconBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-2px); }
        }
        
        /* 按钮悬停效果 */
        .top-ui-item:hover {
            animation: buttonPulse 0.3s ease-in-out;
            transform: translateY(-2px);
        }
        
        .top-ui-item:hover .button-shine {
            animation: buttonShine 0.6s ease-in-out;
            opacity: 1;
        }
        
        .top-ui-item:hover .fas {
            animation: iconBounce 0.6s ease-in-out;
        }
        
        /* 设置按钮特殊效果 */
        .top-ui-item[onclick*="showSettings"]:hover .fas {
            animation: iconSpin 1s linear infinite;
        }
        
        /* 隐藏按钮特殊效果 */
        .top-ui-item[onclick*="hideTopUI"]:hover {
            animation: buttonGlow 1s ease-in-out infinite;
        }
        
        /* 下拉菜单动画 */
        @keyframes dropdownSlideIn {
            from {
                opacity: 0;
                transform: translateY(-10px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        /* 用户头像悬停效果 */
        .top-ui-user:hover .top-ui-avatar {
            transform: scale(1.1);
            box-shadow: 0 0 25px rgba(255, 255, 255, 0.5);
        }
        
        /* 用户名悬停效果 */
        .top-ui-user:hover .top-ui-username {
            background: linear-gradient(45deg, #00ff88, #4ecdc4, #00ff88) !important;
            -webkit-background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            background-clip: text !important;
            text-shadow: 0 0 15px rgba(0, 255, 136, 0.8) !important;
        }
        
        /* 下拉箭头旋转效果 */
        .top-ui-user:hover .fa-chevron-down {
            transform: rotate(180deg);
        }
        
        /* 下拉菜单项悬停效果 */
        .top-ui-dropdown-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        
        .top-ui-dropdown-item:hover .item-hover-effect {
            opacity: 1;
            left: 100%;
        }
        
        /* 用户区域悬停效果 */
        .top-ui-user:hover .user-hover-effect {
            opacity: 1;
            left: 100%;
        }
        }
        
        .top-ui-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .top-ui-username {
            font-weight: 600;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
        }
        
        .top-ui-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #ffffff;
            text-decoration: none;
            min-width: 70px;
            border: 1px solid transparent;
        }
        
        .top-ui-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        .top-ui-item i {
            font-size: 1.1rem;
            margin-bottom: 2px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
        }
        
        .top-ui-item span {
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
        }
        
        .top-ui-brand {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #ffffff;
            font-weight: bold;
            font-size: 1.1rem;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
        }
        
        .top-ui-brand i {
            font-size: 1.3rem;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
        }
        
        .top-ui-badge {
            padding: 2px 8px;
            font-size: 0.7em;
            font-weight: 600;
            border-radius: 8px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.8), rgba(118, 75, 162, 0.8));
            color: #fff;
        }
        
        /* 调整页面内容，移除顶部空间 */
        body {
            padding-top: 0;
        }
        
        /* 菜单按钮悬浮显示 */
        .mobile-menu-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: #ffffff;
            padding: 12px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 20px rgba(102, 126, 234, 0.2);
            opacity: 0;
            transform: translateY(-20px);
        }
        
        .mobile-menu-btn:hover,
        .mobile-menu-btn.show {
            opacity: 1;
            transform: translateY(0);
            background: linear-gradient(135deg, #16213e 0%, #0f3460 50%, #1a1a2e 100%);
            border-color: rgba(255, 255, 255, 0.4);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6), 0 0 30px rgba(102, 126, 234, 0.3);
        }
        
        .mobile-menu-btn i {
            font-size: 1.2rem;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
        }
        
        /* 彩蛋相关样式 */
        .easter-egg-particle {
            position: fixed;
            pointer-events: none;
            z-index: 10000;
            animation: particleFloat 5s ease-in-out infinite;
        }
        
        @keyframes particleFloat {
            0% {
                opacity: 0;
                transform: translateY(0) rotate(0deg) scale(0.5);
            }
            20% {
                opacity: 1;
                transform: translateY(-20px) rotate(180deg) scale(1);
            }
            80% {
                opacity: 1;
                transform: translateY(-100px) rotate(360deg) scale(1.2);
            }
            100% {
                opacity: 0;
                transform: translateY(-150px) rotate(720deg) scale(0.8);
            }
        }
        
        @keyframes celebrationPulse {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            50% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.2);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(1);
            }
        }
        
        @keyframes messageSlideIn {
            0% {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            100% {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        
        /* 永久显示菜单按钮样式 */
        .mobile-menu-btn.permanent {
            opacity: 1 !important;
            transform: translateY(0) !important;
        }
        
        /* 下拉刷新指示器 */
        .pull-refresh-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            z-index: 9998;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .pull-refresh-indicator.show {
            transform: translateY(0);
        }
        
        /* 全局动画和特效 */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* 主题徽章样式 */
        .theme-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 4px;
            padding: 2px 8px;
            font-size: 0.65em;
            font-weight: 600;
            text-transform: uppercase;
            border-radius: 8px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.8), rgba(118, 75, 162, 0.8));
            color: #fff;
            letter-spacing: 0.2px;
            animation: themePulse 3s ease-in-out infinite;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }

        .theme-badge::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s ease;
        }

        .theme-badge:hover::before {
            left: 100%;
        }
        
        .theme-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 15px rgba(102, 126, 234, 0.4);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        @keyframes themePulse {
            0%, 100% { opacity: 0.8; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }
        
        .theme-badge.punk {
            background: linear-gradient(45deg, #ff0080, #00ff80);
            animation: punkFlash 1s ease-in-out infinite;
        }
        
        .theme-badge.rage {
            background: linear-gradient(45deg, #ff0000, #ff4500);
            animation: rageShake 0.5s ease-in-out infinite;
        }
        
        .theme-badge.emo {
            background: linear-gradient(45deg, #667eea, #764ba2);
            animation: emoGlow 3s ease-in-out infinite;
        }
        
        @keyframes punkFlash {
            0%, 100% { opacity: 0.9; }
            50% { opacity: 1; text-shadow: 0 0 10px #ff0080; }
        }
        
        @keyframes rageShake {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.05) rotate(1deg); }
            75% { transform: scale(1.05) rotate(-1deg); }
        }
        
        @keyframes emoGlow {
            0%, 100% { opacity: 0.8; box-shadow: 0 0 10px rgba(102, 126, 234, 0.5); }
            50% { opacity: 1; box-shadow: 0 0 20px rgba(102, 126, 234, 0.8); }
        }
        
        /* 里世界入口动画 */
        @keyframes glitch {
            0%, 90%, 100% { 
                transform: translate(0); 
                filter: hue-rotate(0deg) brightness(1);
            }
            5% { 
                transform: translate(-2px, 2px); 
                filter: hue-rotate(180deg) brightness(1.5);
            }
            10% { 
                transform: translate(-2px, -2px); 
                filter: hue-rotate(90deg) brightness(1.3);
            }
            15% { 
                transform: translate(2px, 2px); 
                filter: hue-rotate(270deg) brightness(1.4);
            }
            20% { 
                transform: translate(2px, -2px); 
                filter: hue-rotate(45deg) brightness(1.6);
            }
        }
        
        /* 主题切换悬停效果 */
        .theme-switch:hover {
            background: rgba(255, 255, 255, 0.1) !important;
            transform: translateX(5px);
        }
        
        /* 下拉菜单项悬停效果 */
        .dropdown-item:hover {
            background: rgba(255, 255, 255, 0.1) !important;
            transform: translateX(3px) !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2) !important;
        }
        
        /* 登出按钮特殊悬停效果 */
        .dropdown-item[href*="logout"]:hover {
            background: rgba(255, 107, 107, 0.2) !important;
            color: #ff8e8e !important;
        }
        
        /* 设置按钮悬停效果 */
        #settingsDropdown:hover {
            background: rgba(255, 255, 255, 0.1) !important;
            border-color: rgba(255, 255, 255, 0.3) !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2) !important;
        }
        
        /* 设置按钮图标旋转动画 */
        #settingsDropdown:hover i {
            animation: spin 2s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .theme-switch.active {
            background: linear-gradient(45deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3)) !important;
            border-left: 3px solid #667eea;
        }
        * {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            font-family: 'Roboto', sans-serif;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* 隐藏滚动条样式 */
        /* Webkit浏览器 (Chrome, Safari, Edge) */
        ::-webkit-scrollbar {
            width: 0px;
            height: 0px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: transparent;
        }
        
        /* Firefox浏览器 */
        html {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        /* IE和Edge */
        body {
            -ms-overflow-style: none;
        }
        
        /* 确保所有可滚动元素都隐藏滚动条 */
        * {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        *::-webkit-scrollbar {
            width: 0px;
            height: 0px;
        }

        .emo-bg .floating-element:nth-child(2) { top: 15%; right: 20%; }
        .emo-bg .floating-element:nth-child(3) { bottom: 25%; left: 25%; }
        .emo-bg .floating-element:nth-child(4) { bottom: 15%; right: 10%; }

        /* 粒子效果 */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(0, 255, 231, 0.6);
            border-radius: 50%;
            animation: particleFloat 8s linear infinite;
        }

        @keyframes particleFloat {
            0% {
                transform: translateY(100vh) translateX(0);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) translateX(100px);
                opacity: 0;
            }
        }

        /* 动态鼠标光标效果 */
        .custom-cursor {
            position: fixed;
            pointer-events: none;
            z-index: 9999;
            mix-blend-mode: difference;
        }

        .cursor-dot {
            position: absolute;
            width: 8px;
            height: 8px;
            background: linear-gradient(45deg, #00ffe7, #ff0080);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: cursorPulse 2s ease-in-out infinite;
            box-shadow: 0 0 10px rgba(0, 255, 231, 0.5);
        }

        .cursor-trail {
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(0, 255, 231, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: cursorTrail 1.5s ease-in-out infinite;
        }

        .custom-cursor.active .cursor-dot {
            transform: translate(-50%, -50%) scale(1.5);
            background: linear-gradient(45deg, #ff0080, #00ffe7);
            box-shadow: 0 0 20px rgba(255, 0, 128, 0.8);
        }

        .custom-cursor.active .cursor-trail {
            transform: translate(-50%, -50%) scale(2);
            border-color: rgba(255, 0, 128, 0.6);
        }

        .custom-cursor.hover .cursor-dot {
            transform: translate(-50%, -50%) scale(1.3);
            background: linear-gradient(45deg, #ff0080, #00ffe7);
            box-shadow: 0 0 15px rgba(255, 0, 128, 0.8);
        }

        .custom-cursor.hover .cursor-trail {
            transform: translate(-50%, -50%) scale(1.5);
            border-color: rgba(255, 0, 128, 0.6);
        }

        @keyframes cursorPulse {
            0%, 100% { 
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            50% { 
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 0.8;
            }
        }

        @keyframes cursorTrail {
            0%, 100% { 
                transform: translate(-50%, -50%) scale(1);
                opacity: 0.3;
            }
            50% { 
                transform: translate(-50%, -50%) scale(1.1);
                opacity: 0.6;
            }
        }

        /* 主题相关的鼠标光标样式 */
        body.life-theme .cursor-dot {
            background: linear-gradient(45deg, #ff0080, #00ff80);
            box-shadow: 0 0 10px rgba(255, 0, 128, 0.5);
        }

        body.life-theme .cursor-trail {
            border-color: rgba(255, 0, 128, 0.3);
        }

        body.work-theme .cursor-dot {
            background: linear-gradient(45deg, #00ffe7, #0099ff);
            box-shadow: 0 0 10px rgba(0, 255, 231, 0.5);
        }

        body.work-theme .cursor-trail {
            border-color: rgba(0, 255, 231, 0.3);
        }

        body.training-theme .cursor-dot {
            background: linear-gradient(45deg, #ff4444, #ff8844);
            box-shadow: 0 0 10px rgba(255, 68, 68, 0.5);
        }

        body.training-theme .cursor-trail {
            border-color: rgba(255, 68, 68, 0.3);
        }

        body.emo-theme .cursor-dot {
            background: linear-gradient(45deg, #667eea, #764ba2);
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.5);
        }

        body.emo-theme .cursor-trail {
            border-color: rgba(102, 126, 234, 0.3);
        }

        /* 响应式设计 - 移动设备上隐藏自定义光标 */
        @media (max-width: 768px) {
            .custom-cursor {
                display: none !important;
            }
        }

        /* 触摸设备上隐藏自定义光标 */
        @media (hover: none) and (pointer: coarse) {
            .custom-cursor {
                display: none !important;
            }
        }

        /* 减少动画 - 为偏好减少动画的用户 */
        @media (prefers-reduced-motion: reduce) {
            .custom-cursor {
                display: none !important;
            }
        }

        /* 链接和按钮悬停时的光标效果 */
        a:hover ~ .custom-cursor .cursor-dot,
        button:hover ~ .custom-cursor .cursor-dot,
        .nav-link:hover ~ .custom-cursor .cursor-dot {
            transform: translate(-50%, -50%) scale(1.3);
            background: linear-gradient(45deg, #ff0080, #00ffe7);
            box-shadow: 0 0 15px rgba(255, 0, 128, 0.8);
        }

        a:hover ~ .custom-cursor .cursor-trail,
        button:hover ~ .custom-cursor .cursor-trail,
        .nav-link:hover ~ .custom-cursor .cursor-trail {
            transform: translate(-50%, -50%) scale(1.5);
            border-color: rgba(255, 0, 128, 0.6);
        }

        /* 页面加载动画 */
        .page-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--geek-bg, #0a0e17);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: opacity 0.5s ease;
        }

        .loader-content {
            text-align: center;
            color: var(--geek-primary, #00ffe7);
        }

        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(0, 255, 231, 0.3);
            border-top: 3px solid #00ffe7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loader-text {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.2rem;
            letter-spacing: 2px;
            animation: textGlow 2s ease-in-out infinite alternate;
        }

        @keyframes textGlow {
            0% { text-shadow: 0 0 10px rgba(0, 255, 231, 0.5); }
            100% { text-shadow: 0 0 20px rgba(0, 255, 231, 0.8); }
        }



        /* 选择文本样式 */
        ::selection {
            background: rgba(0, 255, 231, 0.3);
            color: #fff;
        }

        ::-moz-selection {
            background: rgba(0, 255, 231, 0.3);
            color: #fff;
        }

        /* 响应式设计 - 全面优化 */

        /* 大屏幕 (1200px+) */
        @media (min-width: 1200px) {
            .navbar-brand {
                font-size: 1.8rem;
            }
            
            .theme-subtitle {
                font-size: 1.1rem;
            }
            
            .nav-link {
                font-size: 1.1rem;
                padding: 0.8rem 1.2rem !important;
            }
            
            .floating-element {
                font-size: 2.5rem;
            }
            
            .particle {
                width: 6px;
                height: 6px;
            }
            
            .cursor-follower {
                width: 25px;
                height: 25px;
            }
        }

        /* 中等屏幕 (768px - 1199px) */
        @media (max-width: 1199px) and (min-width: 768px) {
            .navbar-brand {
                font-size: 1.5rem;
            }
            
            .theme-subtitle {
                font-size: 1rem;
            }
            
            .nav-link {
                font-size: 1rem;
                padding: 0.6rem 1rem !important;
            }
            
            .floating-element {
                font-size: 2rem;
            }
            
            .particle {
                width: 4px;
                height: 4px;
            }
        }

        /* 平板端 (768px以下) */
        @media (max-width: 767px) {
            .navbar-brand {
                font-size: 1.3rem;
            }
            
            .theme-subtitle {
                font-size: 0.9rem;
                display: none;
            }
            
            .navbar-nav {
                margin-top: 1rem;
            }
            
            .nav-link {
                font-size: 0.95rem;
                padding: 0.5rem 0.8rem !important;
                text-align: center;
            }
            
            .dropdown-menu {
                background: rgba(0,0,0,0.95) !important;
                border: 1px solid rgba(255,255,255,0.2) !important;
                margin-top: 0.5rem;
            }
            
            .dropdown-item {
                color: #fff !important;
                padding: 0.5rem 1rem !important;
                font-size: 0.9rem;
            }
            
            .floating-element {
                font-size: 1.5rem;
            }
            
            .particle {
                width: 3px;
                height: 3px;
            }
            
            .cursor-follower {
                width: 15px;
                height: 15px;
            }
            
            /* 移动端隐藏部分浮动元素 */
            .floating-element:nth-child(3),
            .floating-element:nth-child(4) {
                display: none;
            }
        }

        /* 手机端 (480px以下) */
        @media (max-width: 480px) {
            .navbar-brand {
                font-size: 1.1rem;
            }
            
            .navbar-toggler {
                padding: 0.25rem 0.5rem;
                font-size: 0.875rem;
            }
            
            .nav-link {
                font-size: 0.9rem;
                padding: 0.4rem 0.6rem !important;
            }
            
            .dropdown-menu {
                min-width: 200px;
            }
            
            .dropdown-item {
                font-size: 0.85rem;
                padding: 0.4rem 0.8rem !important;
            }
            
            .floating-element {
                font-size: 1.2rem;
            }
            
            .particle {
                width: 2px;
                height: 2px;
            }
            
            .cursor-follower {
                width: 12px;
                height: 12px;
            }
            
            /* 小屏幕隐藏更多浮动元素 */
            .floating-element:nth-child(2) {
                display: none;
            }
        }

        /* 超小屏幕 (320px以下) */
        @media (max-width: 320px) {
            .navbar-brand {
                font-size: 1rem;
            }
            
            .nav-link {
                font-size: 0.8rem;
                padding: 0.3rem 0.5rem !important;
            }
            
            .dropdown-item {
                font-size: 0.8rem;
                padding: 0.3rem 0.6rem !important;
            }
            
            .floating-element {
                font-size: 1rem;
            }
            
            .particle {
                width: 1px;
                height: 1px;
            }
            
            .cursor-follower {
                width: 10px;
                height: 10px;
            }
        }

        /* 横屏模式优化 */
        @media (orientation: landscape) and (max-height: 500px) {
            .navbar {
                padding: 0.5rem 1rem;
            }
            
            .navbar-brand {
                font-size: 1.2rem;
            }
            
            .nav-link {
                font-size: 0.9rem;
                padding: 0.3rem 0.6rem !important;
            }
            
            .floating-element {
                font-size: 1rem;
            }
            
            .particle {
                width: 2px;
                height: 2px;
            }
        }

        /* 高分辨率屏幕优化 */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .navbar-brand {
                font-weight: 600;
            }
            
            .nav-link {
                font-weight: 500;
            }
            
            .particle {
                box-shadow: 0 0 2px rgba(0, 255, 231, 0.8);
            }
        }

        /* 触摸设备优化 */
        @media (hover: none) and (pointer: coarse) {
            .nav-link {
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .dropdown-item {
                min-height: 44px;
                display: flex;
                align-items: center;
            }
            
            .navbar-toggler {
                min-width: 44px;
                min-height: 44px;
            }
            
            /* 增加触摸反馈 */
            .nav-link:active {
                background-color: rgba(255, 255, 255, 0.1) !important;
            }
            
            .dropdown-item:active {
                background-color: rgba(255, 255, 255, 0.1) !important;
            }
        }

        /* 深色模式支持 */
        @media (prefers-color-scheme: dark) {
            .navbar {
                background-color: rgba(10, 14, 23, 0.95) !important;
            }
            
            .dropdown-menu {
                background-color: rgba(10, 14, 23, 0.95) !important;
            }
        }

        /* 打印样式 */
        @media print {
            .navbar,
            .floating-elements,
            .particles,
            .cursor-follower,
            .page-loader {
                display: none !important;
            }
            
            body {
                background: white !important;
                color: black !important;
            }
        }
        
        /* 矩阵雨效果 */
        #matrix-rain {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        /* Emo粒子效果 */
        #emo-particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        @keyframes emoParticleFloat {
            0%, 100% { 
                transform: translateY(0px) translateX(0px); 
                opacity: 0.6; 
            }
            50% { 
                transform: translateY(-30px) translateX(20px); 
                opacity: 1; 
            }
        }
        header {
            background: rgba(0, 0, 0, 0.95);
            transition: background 0.3s;
            z-index: 2;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* 统一导航栏样式 - 现代化设计 */
        html body .navbar.unified-navbar,
        html body .unified-navbar,
        .navbar.unified-navbar,
        .unified-navbar {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.95) 0%, rgba(118, 75, 162, 0.95) 100%) !important;
            backdrop-filter: blur(15px) !important;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15) !important;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15), 0 2px 8px rgba(0, 0, 0, 0.1) !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            z-index: 1000 !important;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
            padding: 0.75rem 2rem !important;
            max-width: none !important;
            margin: 0 !important;
            left: 0 !important;
            transform: none !important;
            min-height: 70px !important;
            max-height: 70px !important;
            height: 70px !important;
            display: flex !important;
            align-items: center !important;
            overflow: visible !important;
            width: 100% !important;
            position: relative !important;
        }
        
        /* 导航栏悬浮效果 */
        .unified-navbar:hover {
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2), 0 4px 12px rgba(0, 0, 0, 0.15) !important;
            transform: translateY(-1px) !important;
        }
        
        /* 导航栏背景动画 */
        .unified-navbar::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.6s ease;
            pointer-events: none;
        }
        
        .unified-navbar:hover::before {
            left: 100%;
        }
        
        /* 统一导航栏文字样式 - 最高优先级 */
        html body .unified-navbar .nav-link,
        html body .unified-navbar .navbar-brand,
        html body .unified-navbar .nav-link i,
        html body .unified-navbar .nav-link span,
        html body .unified-navbar .user-nav-link,
        .unified-navbar .nav-link,
        .unified-navbar .navbar-brand,
        .unified-navbar .nav-link i,
        .unified-navbar .nav-link span,
        .unified-navbar .user-nav-link {
            color: #ffffff !important;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8) !important;
        }
        
        /* 统一导航栏品牌样式 */
        .unified-navbar .navbar-brand {
            font-size: 1.3rem !important;
            font-weight: 700 !important;
            text-decoration: none !important;
            display: flex !important;
            align-items: center !important;
            gap: 10px !important;
            padding: 0.5rem 1rem !important;
            border-radius: 8px !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            background: rgba(255, 255, 255, 0.08) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            min-height: 45px !important;
            position: relative !important;
            overflow: hidden !important;
        }
        .unified-navbar .navbar-brand::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }
        
        .unified-navbar .navbar-brand:hover {
            color: #ffffff !important;
            background: rgba(255, 255, 255, 0.15) !important;
            border-color: rgba(255, 255, 255, 0.3) !important;
            transform: translateY(-2px) scale(1.02) !important;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2), 0 0 20px rgba(255, 255, 255, 0.2) !important;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.9), 0 0 10px rgba(255, 255, 255, 0.5) !important;
        }
        
        .unified-navbar .navbar-brand:hover::before {
            left: 100%;
        }
        
        /* 统一导航栏链接样式 */
        .unified-navbar .nav-link {
            color: #ffffff !important;
            font-weight: 600 !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 8px !important;
            line-height: 1 !important;
            padding: 0.5rem 1rem !important;
            border-radius: 8px !important;
            background: rgba(255, 255, 255, 0.08) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            position: relative !important;
            overflow: hidden !important;
            margin: 0 0.25rem !important;
        }
        
        .unified-navbar .nav-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);
            transition: left 0.4s ease;
        }
        
        .unified-navbar .nav-link:hover {
            color: #ffffff !important;
            background: rgba(255, 255, 255, 0.15) !important;
            border-color: rgba(255, 255, 255, 0.3) !important;
            transform: translateY(-2px) scale(1.05) !important;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25), 0 0 15px rgba(255, 255, 255, 0.2) !important;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.9), 0 0 10px rgba(255, 255, 255, 0.5) !important;
        }
        
        .unified-navbar .nav-link:hover::before {
            left: 100%;
        }
        
        /* 统一主题徽章样式 */
        .unified-navbar .theme-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: #ffffff !important;
            padding: 4px 12px !important;
            border-radius: 20px !important;
            font-size: 0.8rem !important;
            font-weight: 600 !important;
            margin-left: 8px !important;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3) !important;
        }
        
        /* 确保所有主题导航栏都使用统一的基础样式 */
        .geek-navbar,
        .life-navbar,
        .emo-navbar,
        .cyber-navbar,
        .punk-nav {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            z-index: 1000 !important;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
            padding: 0 !important;
            max-width: none !important;
            margin: 0 !important;
            transform: none !important;
            min-height: 64px !important;
            max-height: 64px !important;
            height: 64px !important;
            display: flex !important;
            align-items: center !important;
            overflow: visible !important;
            width: 100% !important;
        }

        /* 默认所有页面悬浮菜单 */
        .navbar .navbar-nav {
            opacity: 0 !important;
            visibility: hidden !important;
            transform: translateY(-15px) !important;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
            pointer-events: none !important;
        }

        .navbar:hover .navbar-nav {
            opacity: 1 !important;
            visibility: visible !important;
            transform: translateY(0) !important;
            pointer-events: auto !important;
        }

        /* 当navbar-nav显示时，其内部的下拉菜单也要可点击 */
        .navbar:hover .navbar-nav .dropdown,
        .navbar:hover .navbar-nav .dropdown-menu {
            pointer-events: auto !important;
        }

        /* 确保下拉菜单容器始终可点击 */
        .navbar .dropdown,
        .navbar .user-dropdown-container,
        .navbar .nav-buttons {
            pointer-events: auto !important;
            z-index: 1050 !important;
        }

        /* 确保下拉菜单元素可点击 */
        .navbar .dropdown-toggle,
        .navbar .user-nav-link,
        .navbar .btn {
            pointer-events: auto !important;
        }

        /* 下拉菜单显示时的样式 */
        .dropdown.show .dropdown-menu {
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
            transform: translateY(0) !important;
        }

        /* 默认悬浮提示 - 融入现有设计风格 */
        .navbar::after {
            content: "▲";
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.4);
            font-size: 8px;
            opacity: 0.6;
            transition: all 0.3s ease;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { 
                opacity: 0.3;
                transform: translateY(-50%) scale(1);
            }
            50% { 
                opacity: 0.7;
                transform: translateY(-50%) scale(1.1);
            }
        }

        .navbar:hover::after {
            opacity: 0;
        }

        /* 首页样式通过JavaScript动态控制 */

        /* 菜单项渐进显示 */
        .navbar .navbar-nav .nav-item:nth-child(1) { transition-delay: 0.05s; }
        .navbar .navbar-nav .nav-item:nth-child(2) { transition-delay: 0.1s; }
        .navbar .navbar-nav .nav-item:nth-child(3) { transition-delay: 0.15s; }
        .navbar .navbar-nav .nav-item:nth-child(4) { transition-delay: 0.2s; }
        .navbar .navbar-nav .nav-item:nth-child(5) { transition-delay: 0.25s; }

        /* 移动端支持 - 所有页面都正常显示菜单 */
        @media (max-width: 991.98px) {
            .navbar .navbar-nav {
                opacity: 1 !important;
                visibility: visible !important;
                transform: none !important;
                pointer-events: auto !important;
                transition: none !important;
            }
            
            .navbar::after {
                display: none !important;
            }
        }

        /* 键盘导航支持 - 所有页面 */
        .navbar:focus-within .navbar-nav {
            opacity: 1 !important;
            visibility: visible !important;
            transform: translateY(0) !important;
            pointer-events: auto !important;
        }

        /* 导航栏整体优化 - 与现有主题风格保持一致 */
        .navbar {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }

        .navbar:hover {
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15) !important;
        }

        /* 不同主题模式的悬浮提示适配 */
        .life-navbar::after {
            color: rgba(40, 167, 69, 0.6) !important;
        }

        .geek-navbar::after {
            color: rgba(0, 255, 231, 0.6) !important;
        }

        .emo-navbar::after {
            color: rgba(156, 39, 176, 0.6) !important;
        }

        .cyber-navbar::after {
            color: rgba(255, 0, 110, 0.6) !important;
        }

        .rage-navbar::after {
            color: rgba(255, 68, 68, 0.6) !important;
        }

        .punk-nav::after {
            color: rgba(255, 0, 128, 0.6) !important;
        }
        
        /* 确保所有主题导航栏文字都是白色 */
        .geek-navbar .nav-link,
        .geek-navbar .navbar-brand,
        .geek-navbar .nav-link i,
        .geek-navbar .nav-link span,
        .geek-navbar .user-nav-link,
        .life-navbar .nav-link,
        .life-navbar .navbar-brand,
        .life-navbar .nav-link i,
        .life-navbar .nav-link span,
        .life-navbar .user-nav-link,
        .emo-navbar .nav-link,
        .emo-navbar .navbar-brand,
        .emo-navbar .nav-link i,
        .emo-navbar .nav-link span,
        .emo-navbar .user-nav-link,
        .cyber-navbar .nav-link,
        .cyber-navbar .navbar-brand,
        .cyber-navbar .nav-link i,
        .cyber-navbar .nav-link span,
        .cyber-navbar .user-nav-link,
        .punk-nav .nav-link,
        .punk-nav .navbar-brand,
        .punk-nav .nav-link i,
        .punk-nav .nav-link span,
        .punk-nav .user-nav-link {
            color: #ffffff !important;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8) !important;
        }
        .navbar a {
            transition: color 0.3s;
        }
        .navbar a:hover {
            transform: translateY(-1px);
            transition: all 0.3s ease;
        }
        .nav-buttons {
            margin-left: auto;
            display: flex;
            align-items: center;
        }
        .container {
            padding: 0;
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            z-index: 1;
            min-height: calc(100vh - 120px);
            width: 100%;
            max-width: 100%;
        }
        footer {
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 20px 0;
            text-align: center;
            width: 100%;
        }
        .content-block {
            background: transparent;
            border-radius: 0;
            padding: 0;
            box-shadow: none;
            backdrop-filter: none;
            width: 100%;
            position: relative;
            z-index: 1;
        }
        .announcement-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .announcement-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .announcement-content {
            background: #fff;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: slideInDown 0.4s ease;
        }
        
        .announcement-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .announcement-header h5 {
            margin: 0;
            font-size: 16px;
        }
        
        .announcement-close {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s ease;
        }
        
        .announcement-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .announcement-body {
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .announcement-item {
            margin-bottom: 15px;
            padding: 15px;
            border-left: 4px solid #667eea;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .announcement-item.priority-high {
            border-left-color: #dc3545;
        }
        
        .announcement-item.priority-medium {
            border-left-color: #ffc107;
        }
        
        .announcement-item.priority-low {
            border-left-color: #6c757d;
        }
        
        .announcement-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        
        .announcement-text {
            color: #666;
            line-height: 1.5;
            margin-bottom: 8px;
        }
        
        .announcement-time {
            font-size: 12px;
            color: #999;
        }
        
        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .btn-custom {
            border-radius: 25px;
            padding: 8px 20px;
            font-weight: 500;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .btn-primary.btn-custom {
            background: linear-gradient(45deg, #007bff, #0056b3);
            border-color: #007bff;
        }
        .btn-primary.btn-custom:hover {
            background: linear-gradient(45deg, #0056b3, #004085);
        }
        .btn-secondary.btn-custom {
            background: linear-gradient(45deg, #6c757d, #545b62);
            border-color: #6c757d;
        }
        .btn-secondary.btn-custom:hover {
            background: linear-gradient(45deg, #545b62, #3d4449);
        }
        .btn-outline-light {
            border-radius: 50%;
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        .btn-outline-light:hover {
            transform: rotate(90deg);
            background: rgba(255,255,255,0.1);
        }
        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
            position: relative;
        }
        .navbar-brand:hover {
            transform: scale(1.05);
            transition: all 0.3s ease;
        }
        
        .theme-subtitle {
            font-size: 0.7rem;
            font-weight: normal;
            color: rgba(255, 255, 255, 0.8);
            margin-top: -5px;
            text-shadow: none;
            transition: all 0.3s ease;
            opacity: 0.8;
        }
        
        .theme-subtitle:hover {
            opacity: 1;
            transform: scale(1.05);
        }
        .nav-link {
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .user-nav-link {
            display: flex !important;
            align-items: center !important;
            gap: 8px !important;
        }
        .nav-link::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: -100%;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, #FFD700, #FFA500);
            transition: left 0.3s ease;
        }
        .nav-link:hover::after {
            left: 0;
        }
        .dropdown-menu {
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .dropdown-item:hover {
            background: rgba(255,255,255,0.1) !important;
            transform: translateX(5px);
            transition: all 0.3s ease;
        }
        .social-icons a:hover {
            color: #FFD700 !important;
        }
        
        /* 音乐信息样式 */
        .music-info {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            padding: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-width: 280px;
            max-width: 320px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        
        .music-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }
        
        .music-info-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .music-cover {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            overflow: hidden;
            flex-shrink: 0;
            background: linear-gradient(45deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .music-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .music-details {
            flex: 1;
            min-width: 0;
        }
        
        .music-title {
            color: white;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .music-artist {
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .music-controls {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }
        
        .music-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .music-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .music-btn:active {
            transform: scale(0.95);
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .music-info {
                top: 70px;
                right: 10px;
                left: 10px;
                max-width: none;
                min-width: auto;
            }
        }
    </style>
</head>
<body data-user-authenticated="false" class="">
    <!-- 页面加载动画 -->
    <div class="page-loader" id="pageLoader">
        <div class="loader-content">
            <div class="loader-spinner"></div>
            <div class="loader-text">ModeShift</div>
        </div>
    </div>

    <!-- 动态鼠标光标效果 -->
    <div class="custom-cursor" id="customCursor">
        <div class="cursor-dot"></div>
        <div class="cursor-trail"></div>
    </div>

    <!-- 粒子效果 -->
    <div class="particles" id="particles"></div>

    <!-- 网易云音乐播放器 -->
    <audio id="theme-music" loop volume="0.3">
        <source id="music-source" src="" type="audio/mpeg">
        您的浏览器不支持音频标签。
    </audio>
    
    <!-- 音乐信息显示 -->
    <div id="music-info" class="music-info" style="display: none;">
        <div class="music-info-content">
            <div class="music-cover">
                <img id="music-cover-img" src="" alt="封面">
            </div>
            <div class="music-details">
                <div class="music-title" id="music-title">加载中...</div>
                <div class="music-artist" id="music-artist">未知歌手</div>
            </div>
            <div class="music-controls">
                <button class="music-btn" onclick="nextSong()" title="下一首">
                    <i class="fas fa-forward"></i>
                </button>
                <button class="music-btn" onclick="toggleMusic()" title="播放/暂停">
                    <i class="fas fa-play" id="music-play-icon"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- 仅在 home 页显示公告弹窗 -->
    

    <!-- 下拉刷新指示器 -->
    <div class="pull-refresh-indicator" id="pullRefreshIndicator">
        <i class="fas fa-sync-alt fa-spin"></i> 正在刷新...
    </div>
    
    <!-- 移动端菜单按钮 -->
    <button class="mobile-menu-btn d-lg-none" id="mobileMenuBtn">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- 侧边栏背景 -->
    <div class="sidebar-backdrop" id="sidebarBackdrop"></div>
    
    <!-- 顶部固定UI -->
    <div class="top-ui-bar" id="topUiBar" style="position: fixed !important; top: 0 !important; left: 0 !important; right: 0 !important; z-index: 9999 !important; background: rgba(0, 0, 0, 0.05) !important; backdrop-filter: blur(10px) !important; border-bottom: 1px solid rgba(255, 255, 255, 0.05) !important; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05) !important; padding: 15px 20px !important; display: flex !important; justify-content: space-around !important; align-items: center !important; opacity: 1 !important; transform: translateY(0) !important; transition: all 0.3s ease !important; border-radius: 0 0 15px 15px !important; min-height: 70px !important; visibility: visible !important;">
        <script>
            // 立即确保顶部菜单显示
            document.getElementById('topUiBar').style.display = 'flex';
            document.getElementById('topUiBar').style.opacity = '1';
            document.getElementById('topUiBar').style.visibility = 'visible';

        </script>
        <!-- 品牌标识 -->
        <div class="top-ui-brand" onclick="window.location.href='/'" style="display: flex !important; align-items: center !important; color: white !important; text-shadow: 0 0 10px rgba(255, 255, 255, 0.5) !important; font-weight: bold !important; font-size: 1.2rem !important; cursor: pointer !important; transition: all 0.3s ease !important; padding: 8px 15px !important; border-radius: 20px !important; background: rgba(255, 255, 255, 0.1) !important; border: 1px solid rgba(255, 255, 255, 0.2) !important; position: relative !important; overflow: hidden !important;">
            <i class="fas fa-cube" style="margin-right: 8px !important; color: #00ff41 !important; animation: rotate 3s linear infinite !important;"></i>
            <span style="background: linear-gradient(45deg, #00ff41, #ff69b4, #4ecdc4, #45b7d1) !important; -webkit-background-clip: text !important; -webkit-text-fill-color: transparent !important; background-clip: text !important; animation: gradientShift 4s ease-in-out infinite !important;">MODESHIFT</span>
            <div class="brand-hover-effect" style="position: absolute !important; top: 0 !important; left: -100% !important; width: 100% !important; height: 100% !important; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent) !important; transition: left 0.5s ease !important;"></div>
        </div>
        
        <!-- 关于按钮 -->
        <div class="top-ui-item" id="aboutButton" onclick="showAboutModal()" style="color: white !important; cursor: pointer !important; padding: 15px !important; border-radius: 50% !important; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important; background: transparent !important; border: none !important; box-shadow: none !important; position: relative !important; overflow: hidden !important;">
            <i class="fas fa-user-circle" style="font-size: 1.8rem !important; position: relative; z-index: 2; text-shadow: 0 0 20px rgba(52, 152, 219, 0.8), 0 0 40px rgba(52, 152, 219, 0.6) !important; filter: drop-shadow(0 0 10px rgba(52, 152, 219, 0.8)) !important;"></i>
            <div class="button-shine" style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent, rgba(52, 152, 219, 0.6), transparent); transform: rotate(45deg); transition: all 0.6s ease; opacity: 0;"></div>
        </div>
        
        <!-- 设置按钮 -->
        <div class="top-ui-item" onclick="showSettings()" style="color: white !important; cursor: pointer !important; padding: 15px !important; border-radius: 50% !important; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important; background: transparent !important; border: none !important; box-shadow: none !important; position: relative !important; overflow: hidden !important;">
            <i class="fas fa-cog" style="font-size: 1.8rem !important; position: relative; z-index: 2; text-shadow: 0 0 20px rgba(155, 89, 182, 0.8), 0 0 40px rgba(155, 89, 182, 0.6) !important; filter: drop-shadow(0 0 10px rgba(155, 89, 182, 0.8)) !important; transition: transform 0.3s ease;"></i>
            <div class="button-shine" style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent, rgba(155, 89, 182, 0.6), transparent); transform: rotate(45deg); transition: all 0.6s ease; opacity: 0;"></div>
        </div>
        
        <!-- 菜单按钮 -->
        <div class="top-ui-item" onclick="toggleMobileMenu()" style="color: white !important; cursor: pointer !important; padding: 15px !important; border-radius: 50% !important; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important; background: transparent !important; border: none !important; box-shadow: none !important; position: relative !important; overflow: hidden !important;">
            <i class="fas fa-bars" style="font-size: 1.8rem !important; position: relative; z-index: 2; text-shadow: 0 0 20px rgba(255, 255, 255, 0.8), 0 0 40px rgba(255, 255, 255, 0.6) !important; filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.8)) !important;"></i>
            <div class="button-shine" style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.6), transparent); transform: rotate(45deg); transition: all 0.6s ease; opacity: 0;"></div>
        </div>
        
        <!-- 隐藏按钮 -->
        <div class="top-ui-item" onclick="hideTopUI()" style="color: white !important; cursor: pointer !important; padding: 15px !important; border-radius: 50% !important; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important; background: transparent !important; border: none !important; box-shadow: none !important; position: relative !important; overflow: hidden !important;">
            <i class="fas fa-eye-slash" style="font-size: 1.8rem !important; position: relative; z-index: 2; text-shadow: 0 0 20px rgba(231, 76, 60, 0.8), 0 0 40px rgba(231, 76, 60, 0.6) !important; filter: drop-shadow(0 0 10px rgba(231, 76, 60, 0.8)) !important;"></i>
            <div class="button-shine" style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent, rgba(231, 76, 60, 0.6), transparent); transform: rotate(45deg); transition: all 0.6s ease; opacity: 0;"></div>
        </div>
        
    </div>
    
    <header>
        <nav class="navbar navbar-expand-lg navbar-dark unified-navbar" aria-label="主导航" style="--navbar-text-color: rgba(255, 255, 255, 0.9) !important; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%) !important; backdrop-filter: blur(20px) !important; border-bottom: 2px solid rgba(255, 255, 255, 0.15) !important; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 20px rgba(102, 126, 234, 0.2) !important;">
            <div class="container-fluid">
                <!-- 品牌Logo区域 -->
                <a class="navbar-brand" href="/" style="color: #ffffff !important; text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8) !important;">
                    <i class="fas fa-cogs"></i> ModeShift
                    <div id="theme-subtitle" class="theme-subtitle" data-translate="专注技术，追求卓越">专注技术，追求卓越</div>
                </a>
            
            <!-- 移动端菜单按钮 -->
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <!-- 导航菜单区域 -->
            <div class="collapse navbar-collapse" id="navbarNav">
                <!-- 主导航菜单 -->
                <ul class="navbar-nav mr-auto">
                    
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showHiddenInfo()" title="双击显示隐藏信息" style="color: #ffffff !important; text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8) !important;">
                            <i class="fas fa-info-circle" style="color: #ffffff !important; text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8) !important;"></i> <span data-translate="关于" style="color: #ffffff !important; text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8) !important;">关于</span>
                        </a>
                    </li>
                    
                </ul>

                <!-- 右侧用户区域 -->
                <div class="nav-buttons">
                    
                        <a href="/users/login/" class="btn btn-primary btn-custom" onclick="stopMedia()">
                            <i class="fas fa-sign-in-alt"></i> <span data-translate="登录">登录</span>
                        </a>
                        <a href="/users/register/" class="btn btn-secondary btn-custom" onclick="stopMedia()">
                            <i class="fas fa-user-plus"></i> <span data-translate="注册">注册</span>
                        </a>
                    
                    
                    <!-- 设置按钮移到右上角 -->
                    <div class="dropdown">
                        <button class="btn btn-outline-light dropdown-toggle" type="button" id="settingsDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="border-radius: 8px; padding: 0.4rem 0.6rem; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); transition: all 0.3s ease;">
                            <i class="fas fa-cog" style="font-size: 0.8rem;"></i>
                        </button>
                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="settingsDropdown" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.95) 0%, rgba(118, 75, 162, 0.95) 50%, rgba(240, 147, 251, 0.95) 100%); border: 1px solid rgba(255,255,255,0.2); min-width: 200px; box-shadow: 0 8px 32px rgba(0,0,0,0.4), 0 0 20px rgba(102, 126, 234, 0.3); border-radius: 12px; backdrop-filter: blur(15px); margin-top: 8px;">
                            <h6 class="dropdown-header" style="color: #fff; border-bottom: 1px solid #333;" data-translate="音乐控制">音乐控制</h6>
                            <a class="dropdown-item" href="#" onclick="toggleMusic(); return false;" style="color: white;">
                                <i class="fas fa-music"></i> <span data-translate="播放/暂停音乐">播放/暂停音乐</span>
                            </a>
                            <a class="dropdown-item" href="#" onclick="nextSong(); return false;" style="color: white;">
                                <i class="fas fa-forward"></i> <span data-translate="下一首歌曲">下一首歌曲</span>
                            </a>
                            <a class="dropdown-item" href="#" onclick="toggleMusicInfo(); return false;" style="color: white;">
                                <i class="fas fa-info-circle"></i> <span data-translate="显示/隐藏音乐信息">显示/隐藏音乐信息</span>
                            </a>
                            <div class="dropdown-divider" style="border-color: #333;"></div>
                            <h6 class="dropdown-header" style="color: #fff; border-bottom: 1px solid #333;" data-translate="系统设置">系统设置</h6>
                            
                            <a class="dropdown-item" href="/users/login/" style="color: white;">
                                <i class="fas fa-sign-in-alt"></i> <span data-translate="登录后反馈">登录后反馈</span>
                            </a>
                            
                            <div class="dropdown-divider" style="border-color: #333;"></div>
                            <h6 class="dropdown-header" style="color: #fff; border-bottom: 1px solid #333;" data-translate="语言设置">语言设置</h6>
                            <a class="dropdown-item language-switch" href="#" data-lang="zh" style="color: white;">
                                <i class="fas fa-language" style="color: #4CAF50;"></i> <span data-translate="中文">中文</span>
                                <span class="language-indicator" id="zh-indicator" style="float: right; color: #4CAF50; display: inline;">✓</span>
                            </a>
                            <a class="dropdown-item language-switch" href="#" data-lang="en" style="color: white;">
                                <i class="fas fa-language" style="color: #2196F3;"></i> <span data-translate="English">English</span>
                                <span class="language-indicator" id="en-indicator" style="float: right; color: #2196F3; display: none;">✓</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </nav>
    </header>



    <div class="container">
        <div class="content-block">
            
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

<style>
:root {
    --primary-color: #667eea;
    --secondary-color: #764ba2;
    --success-color: #4CAF50;
    --warning-color: #ff9800;
    --danger-color: #f44336;
    --light-bg: #f8f9ff;
    --card-shadow: 0 8px 32px rgba(102, 126, 234, 0.1);
    --border-radius: 16px;
    --glass-bg: rgba(255, 255, 255, 0.95);
    --glass-border: rgba(255, 255, 255, 0.3);
    --text-color: #2c3e50;
    --text-secondary: #34495e;
    --text-muted: #5a6c7d;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: linear-gradient(135deg, var(--light-bg) 0%, #e3f2fd 100%);
    min-height: 100vh;
    color: var(--text-color);
}

.diary-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
    position: relative;
}

/* 顶部统计卡片 */
.stats-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-bottom: 30px;
}

/* 改进的统计卡片 */
.stat-card {
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: var(--border-radius);
    padding: 20px;
    text-align: center;
    box-shadow: var(--card-shadow);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
}

.stat-card:hover::before {
    left: 100%;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 40px rgba(102, 126, 234, 0.15);
}

.stat-number {
    font-size: 2em;
    font-weight: bold;
    color: var(--primary-color);
    margin-bottom: 5px;
}

.stat-label {
    font-size: 0.9em;
    color: var(--text-secondary);
    font-weight: 500;
}

/* 今日记录区域 */
.today-section {
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: var(--border-radius);
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: var(--card-shadow);
}

.section-title {
    font-size: 1.3em;
    font-weight: 600;
    color: var(--text-color);
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

/* 输入区域 */
.input-area {
    margin-bottom: 20px;
}

/* 改进的每日问题区域 */
.daily-question {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 20px;
    border-radius: var(--border-radius);
    margin-bottom: 20px;
    text-align: center;
    position: relative;
    overflow: hidden;
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
}

.daily-question::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    animation: float 6s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translate(-50%, -50%) rotate(0deg); }
    50% { transform: translate(-50%, -50%) rotate(180deg); }
}

.question-text {
    font-size: 1.1em;
    margin-bottom: 15px;
    position: relative;
    z-index: 2;
}

.question-answer {
    position: relative;
    z-index: 2;
}

.question-input {
    width: 100%;
    padding: 12px;
    border: none;
    border-radius: 8px;
    font-size: 1em;
    background: rgba(255,255,255,0.95);
    color: var(--text-color);
    outline: none;
    transition: all 0.3s ease;
}

.question-input:focus {
    background: white;
    box-shadow: 0 0 0 3px rgba(255,255,255,0.3);
}

.question-input::placeholder {
    color: var(--text-muted);
}

/* 记录方式按钮组 */
.record-methods {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 15px;
    margin-bottom: 25px;
}

/* 改进的按钮样式 */
.method-btn {
    background: var(--glass-bg);
    border: 2px solid transparent;
    border-radius: var(--border-radius);
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.method-btn:hover {
    border-color: var(--primary-color);
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
}

.method-btn.active {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
}

.method-btn.active .method-name,
.method-btn.active .method-desc {
    color: white;
}

.method-icon {
    font-size: 2em;
    margin-bottom: 10px;
    display: block;
}

.method-name {
    font-weight: 600;
    margin-bottom: 5px;
    color: var(--text-color);
}

.method-desc {
    font-size: 0.85em;
    color: var(--text-secondary);
}

/* 心情选择器 */
.mood-selector {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin: 20px 0;
    flex-wrap: wrap;
}

/* 改进的输入框样式 */
.diary-input {
    width: 100%;
    min-height: 120px;
    padding: 15px;
    border: 2px solid #e1e5e9;
    border-radius: var(--border-radius);
    font-size: 1em;
    font-family: inherit;
    resize: vertical;
    outline: none;
    transition: all 0.3s ease;
    background: white;
    color: var(--text-color);
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.diary-input:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1), 0 4px 8px rgba(0,0,0,0.1);
    transform: translateY(-1px);
}

.diary-input::placeholder {
    color: var(--text-muted);
    font-style: italic;
}

/* 改进的心情选择器 */
.mood-btn {
    font-size: 2.5em;
    background: none;
    border: 2px solid transparent;
    cursor: pointer;
    transition: all 0.3s ease;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.mood-btn:hover {
    background: rgba(102, 126, 234, 0.1);
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
}

.mood-btn.selected {
    background: var(--primary-color);
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    transform: scale(1.2);
    border-color: white;
}

/* 图片上传区域 */
.image-upload {
    border: 2px dashed #ccc;
    border-radius: var(--border-radius);
    padding: 30px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-bottom: 20px;
    background: rgba(255,255,255,0.5);
}

.image-upload:hover {
    border-color: var(--primary-color);
    background: rgba(102, 126, 234, 0.05);
}

.image-upload.dragover {
    border-color: var(--success-color);
    background: rgba(76, 175, 80, 0.1);
}

/* 改进的保存状态样式 */
.save-status {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 18px;
    border-radius: 25px;
    font-size: 0.9em;
    font-weight: 500;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.save-status.saving {
    background: rgba(255, 152, 0, 0.15);
    color: var(--warning-color);
    border: 1px solid rgba(255, 152, 0, 0.3);
}

.save-status.saved {
    background: rgba(76, 175, 80, 0.15);
    color: var(--success-color);
    border: 1px solid rgba(76, 175, 80, 0.3);
}

/* 漂浮的加号按钮 */
.floating-add {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    border: none;
    border-radius: 50%;
    color: white;
    font-size: 2em;
    cursor: pointer;
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    transition: all 0.3s ease;
    z-index: 1000;
}

.floating-add:hover {
    transform: scale(1.1) rotate(90deg);
    box-shadow: 0 12px 35px rgba(102, 126, 234, 0.5);
}

/* 成就提示 */
.achievement-popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0);
    background: white;
    padding: 30px;
    border-radius: var(--border-radius);
    box-shadow: 0 20px 60px rgba(0,0,0,0.2);
    text-align: center;
    z-index: 2000;
    transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

.achievement-popup.show {
    transform: translate(-50%, -50%) scale(1);
}

.achievement-icon {
    font-size: 4em;
    margin-bottom: 15px;
    display: block;
}

.achievement-title {
    font-size: 1.5em;
    font-weight: bold;
    color: var(--primary-color);
    margin-bottom: 10px;
}

.achievement-desc {
    color: #666;
    margin-bottom: 20px;
}

/* 响应式设计 */
@media (max-width: 768px) {
    .diary-container {
        padding: 15px;
    }
    
    .stats-cards {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }
    
    .stat-card {
        padding: 15px;
    }
    
    .record-methods {
        grid-template-columns: 1fr;
        gap: 10px;
    }
    
    .method-btn {
        padding: 15px;
    }
    
    .mood-selector {
        gap: 8px;
    }
    
    .mood-btn {
        width: 50px;
        height: 50px;
        font-size: 2em;
    }
    
    .floating-add {
        bottom: 20px;
        right: 20px;
        width: 50px;
        height: 50px;
        font-size: 1.5em;
    }
    
    .today-section {
        padding: 20px;
    }
    
    .daily-question {
        padding: 15px;
    }
    
    .question-input {
        padding: 10px;
        font-size: 0.9em;
    }
}

@media (max-width: 480px) {
    .stats-cards {
        grid-template-columns: 1fr;
    }
    
    .mood-selector {
        gap: 5px;
    }
    
    .mood-btn {
        width: 45px;
        height: 45px;
        font-size: 1.8em;
    }
}

/* 动画效果 */
.fade-in {
    animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.pulse {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

/* 模板选择 */
.template-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin: 20px 0;
}

/* 改进的模板卡片样式 */
.template-card {
    background: white;
    border: 2px solid #e1e5e9;
    border-radius: var(--border-radius);
    padding: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.template-card:hover {
    border-color: var(--primary-color);
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
}

.template-card.selected {
    border-color: var(--primary-color);
    background: rgba(102, 126, 234, 0.05);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
}

.template-icon {
    font-size: 2em;
    margin-bottom: 10px;
}

.template-name {
    font-weight: 600;
    margin-bottom: 5px;
    color: var(--text-color);
}

.template-desc {
    font-size: 0.85em;
    color: var(--text-secondary);
}
</style>

<div class="diary-container">
    <!-- 顶部统计 -->
    <div class="stats-cards fade-in">
        <div class="stat-card">
            <div class="stat-number">0</div>
            <div class="stat-label">连续记录天数</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">0</div>
            <div class="stat-label">本月记录</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">0</div>
            <div class="stat-label">最近成就</div>
        </div>
    </div>

    <!-- 今日记录区域 -->
    <div class="today-section fade-in">
        <h2 class="section-title">
            <i class="fas fa-calendar-day"></i>
            今天 (2024-01-01)
        </h2>

        <!-- 每日问题 -->
        <div class="daily-question">
            <div class="question-text">💭 今天最让你印象深刻的颜色是？</div>
            <div class="question-answer">
                <input type="text" class="question-input" placeholder="写下你的想法...">
            </div>
        </div>

        <!-- 记录方式选择 -->
        <div class="record-methods">
            <div class="method-btn" data-method="text">
                <span class="method-icon">✍️</span>
                <div class="method-name">文字记录</div>
                <div class="method-desc">写下今天的故事</div>
            </div>
            
            <div class="method-btn" data-method="mood">
                <span class="method-icon">😊</span>
                <div class="method-name">心情打卡</div>
                <div class="method-desc">一键记录心情</div>
            </div>
            
            <div class="method-btn" data-method="image">
                <span class="method-icon">📸</span>
                <div class="method-name">图片日记</div>
                <div class="method-desc">分享美好瞬间</div>
            </div>
            
            <div class="method-btn" data-method="template">
                <span class="method-icon">📝</span>
                <div class="method-name">模板填空</div>
                <div class="method-desc">轻松完成记录</div>
            </div>
        </div>

        <!-- 心情选择器 -->
        <div class="mood-selector">
            <button class="mood-btn" data-mood="😊" title="开心">😊</button>
            <button class="mood-btn" data-mood="😐" title="平静">😐</button>
            <button class="mood-btn" data-mood="😢" title="难过">😢</button>
            <button class="mood-btn" data-mood="🥳" title="兴奋">🥳</button>
            <button class="mood-btn" data-mood="😴" title="疲惫">😴</button>
            <button class="mood-btn" data-mood="🤔" title="思考">🤔</button>
            <button class="mood-btn" data-mood="😍" title="感动">😍</button>
            <button class="mood-btn" data-mood="😤" title="愤怒">😤</button>
        </div>

        <!-- 文字输入区域 -->
        <div class="input-area" id="textInputArea" style="display:none;">
            <textarea class="diary-input" placeholder="今天有什么想分享的吗？从一个字开始..."></textarea>
        </div>

        <!-- 图片上传区域 -->
        <div class="image-upload" id="imageUploadArea" style="display:none;">
            <i class="fas fa-cloud-upload-alt" style="font-size: 3em; color: #ccc; margin-bottom: 10px;"></i>
            <p>拖拽图片到这里，或点击上传</p>
            <input type="file" accept="image/*" style="display:none;">
        </div>

        <!-- 模板选择区域 -->
        <div id="templateArea" style="display:none;">
            <div class="template-grid" id="templateGrid">
                <!-- 模板将通过JavaScript动态加载 -->
            </div>
            <div id="templateForm" style="display:none;">
                <!-- 模板表单将动态生成 -->
            </div>
        </div>

        <!-- 保存状态 -->
        <div class="save-status" id="saveStatus" style="display:none;">
            <i class="fas fa-check-circle"></i>
            <span>已保存</span>
        </div>
    </div>
    
    <!-- 今日已有记录显示 -->
    
</div>

<!-- 漂浮的加号按钮 -->
<button class="floating-add" onclick="scrollToTop()">
    <i class="fas fa-plus"></i>
</button>

<!-- 成就弹窗 -->
<div class="achievement-popup" id="achievementPopup">
    <span class="achievement-icon">🏆</span>
    <div class="achievement-title">恭喜获得成就！</div>
    <div class="achievement-desc">继续保持下去～</div>
    <button onclick="closeAchievementPopup()" style="background: var(--primary-color); color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer;">好的</button>
</div>

<script>
let currentMethod = '';
let selectedMood = '';
let autoSaveTimer = null;
let isAutoSaving = false;

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    initializeEventListeners();
    loadTemplates();
    
    // 默认选择文字记录方式
    selectMethod('text');
});

// 初始化事件监听器
function initializeEventListeners() {
    // 记录方式选择
    document.querySelectorAll('.method-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            selectMethod(this.dataset.method);
        });
    });
    
    // 心情选择
    document.querySelectorAll('.mood-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            selectMood(this.dataset.mood);
        });
    });
    
    // 文字输入自动保存
    const textInput = document.querySelector('.diary-input');
    if (textInput) {
        textInput.addEventListener('input', function() {
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => {
                autoSaveContent();
            }, 2000); // 2秒后自动保存
        });
    }
    
    // 每日问题输入
    const questionInput = document.querySelector('.question-input');
    if (questionInput) {
        questionInput.addEventListener('input', function() {
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => {
                autoSaveQuestionAnswer();
            }, 2000);
        });
    }
    
    // 图片拖拽上传
    const imageUpload = document.getElementById('imageUploadArea');
    if (imageUpload) {
        imageUpload.addEventListener('click', function() {
            const fileInput = this.querySelector('input[type="file"]');
            fileInput.click();
        });
        
        imageUpload.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('dragover');
        });
        
        imageUpload.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
        });
        
        imageUpload.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                uploadImage(files[0]);
            }
        });
        
        const fileInput = imageUpload.querySelector('input[type="file"]');
        fileInput.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                uploadImage(e.target.files[0]);
            }
        });
    }
}

// 选择记录方式
function selectMethod(method) {
    // 移除其他按钮的选中状态
    document.querySelectorAll('.method-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // 选中当前按钮
    document.querySelector(`[data-method="${method}"]`).classList.add('active');
    
    // 隐藏所有输入区域
    document.getElementById('textInputArea').style.display = 'none';
    document.getElementById('imageUploadArea').style.display = 'none';
    document.getElementById('templateArea').style.display = 'none';
    
    // 显示对应的输入区域
    currentMethod = method;
    
    switch(method) {
        case 'text':
            document.getElementById('textInputArea').style.display = 'block';
            document.querySelector('.diary-input').focus();
            break;
        case 'mood':
            // 心情记录不需要额外输入区域，直接选择心情即可保存
            showMessage('选择一个心情来记录今天的感受！', 'info');
            break;
        case 'image':
            document.getElementById('imageUploadArea').style.display = 'block';
            break;
        case 'template':
            document.getElementById('templateArea').style.display = 'block';
            break;
    }
}

// 选择心情
function selectMood(mood) {
    // 移除其他心情按钮的选中状态
    document.querySelectorAll('.mood-btn').forEach(btn => {
        btn.classList.remove('selected');
    });
    
    // 选中当前心情
    document.querySelector(`[data-mood="${mood}"]`).classList.add('selected');
    selectedMood = mood;
    
    // 如果当前是心情记录模式，直接保存
    if (currentMethod === 'mood') {
        saveMoodEntry();
    }
}

// 自动保存内容
function autoSaveContent() {
    if (isAutoSaving) return;
    
    const textInput = document.querySelector('.diary-input');
    const content = textInput.value.trim();
    
    if (!content && !selectedMood) return;
    
    showSaveStatus('saving');
    isAutoSaving = true;
    
    fetch('/tools/api/diary/quick-save/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            content: content,
            mood: selectedMood,
            entry_type: 'text'
        })
    })
    .then(response => response.json())
    .then(data => {
        isAutoSaving = false;
        if (data.success) {
            showSaveStatus('saved');
            updateWordCount(data.word_count);
        } else {
            showMessage(data.error, 'error');
        }
    })
    .catch(error => {
        isAutoSaving = false;
        console.error('Auto save error:', error);
        showMessage('自动保存失败', 'error');
    });
}

// 自动保存问题回答
function autoSaveQuestionAnswer() {
    const questionInput = document.querySelector('.question-input');
    const answer = questionInput.value.trim();
    
    if (!answer) return;
    
    autoSaveContent(); // 复用文字保存逻辑
}

// 保存心情记录
function saveMoodEntry() {
    if (!selectedMood) {
        showMessage('请选择一个心情', 'error');
        return;
    }
    
    showSaveStatus('saving');
    
    fetch('/tools/api/diary/mood-save/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            mood: selectedMood
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSaveStatus('saved');
            showMessage(data.message, 'success');
            // 可能触发成就
            checkForAchievements();
        } else {
            showMessage(data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Mood save error:', error);
        showMessage('保存失败', 'error');
    });
}

// 上传图片
function uploadImage(file) {
    if (!file.type.startsWith('image/')) {
        showMessage('请上传图片文件', 'error');
        return;
    }
    
    const formData = new FormData();
    formData.append('image', file);
    formData.append('mood', selectedMood || '😊');
    formData.append('description', '');
    
    showSaveStatus('saving');
    
    fetch('/tools/api/diary/image-upload/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSaveStatus('saved');
            showMessage(data.message, 'success');
            
            // 显示上传的图片预览
            const imageUpload = document.getElementById('imageUploadArea');
            imageUpload.innerHTML = `
                <img src="${data.image_url}" style="max-width: 100%; max-height: 200px; border-radius: 8px; margin-bottom: 10px;">
                <p>图片上传成功！</p>
            `;
            
            checkForAchievements();
        } else {
            showMessage(data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Image upload error:', error);
        showMessage('上传失败', 'error');
    });
}

// 加载模板
function loadTemplates() {
    fetch('/tools/api/diary/templates/')
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            displayTemplates(data.templates);
        } else {
            console.error('Failed to load templates:', data.error);
            showMessage('加载模板失败', 'error');
            // 使用默认模板作为备选
            displayDefaultTemplates();
        }
    })
    .catch(error => {
        console.error('Load templates error:', error);
        showMessage('加载模板失败，使用默认模板', 'warning');
        // 使用默认模板作为备选
        displayDefaultTemplates();
    });
}

// 显示默认模板
function displayDefaultTemplates() {
    const defaultTemplates = [
        {
            id: 'default1',
            name: '今日回顾',
            description: '简单回顾今天的生活',
            icon: '📝',
            content: '今天最开心的事：{开心的事}\n今天遇到的挑战：{挑战}\n明天的计划：{计划}'
        },
        {
            id: 'default2', 
            name: '心情记录',
            description: '记录今天的心情变化',
            icon: '😊',
            content: '早上心情：{早上心情}\n中午心情：{中午心情}\n晚上心情：{晚上心情}\n心情变化原因：{原因}'
        },
        {
            id: 'default3',
            name: '生活感悟',
            description: '记录生活中的小感悟',
            icon: '💭',
            content: '今天学到的新知识：{新知识}\n对生活的感悟：{感悟}\n想要改进的地方：{改进点}'
        }
    ];
    
    displayTemplates(defaultTemplates);
}

// 显示模板
function displayTemplates(templates) {
    const templateGrid = document.getElementById('templateGrid');
    templateGrid.innerHTML = '';
    
    templates.forEach(template => {
        const templateCard = document.createElement('div');
        templateCard.className = 'template-card';
        templateCard.dataset.templateId = template.id;
        templateCard.innerHTML = `
            <div class="template-icon">${template.icon}</div>
            <div class="template-name">${template.name}</div>
            <div class="template-desc">${template.description}</div>
        `;
        
        templateCard.addEventListener('click', function() {
            selectTemplate(template);
        });
        
        templateGrid.appendChild(templateCard);
    });
}

// 选择模板
function selectTemplate(template) {
    // 移除其他模板的选中状态
    document.querySelectorAll('.template-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // 选中当前模板
    document.querySelector(`[data-template-id="${template.id}"]`).classList.add('selected');
    
    // 生成模板表单
    generateTemplateForm(template);
}

// 生成模板表单
function generateTemplateForm(template) {
    const templateForm = document.getElementById('templateForm');
    
    // 解析模板内容，提取需要填空的部分
    const content = template.content;
    const blanks = content.match(/\{([^}]+)\}/g) || [];
    
    let formHtml = `<h4 style="margin: 20px 0 15px 0; color: var(--text-color);">${template.name}</h4>`;
    formHtml += `<p style="color: var(--text-secondary); margin-bottom: 20px;">${template.description}</p>`;
    
    if (blanks.length === 0) {
        formHtml += `<p style="color: var(--text-muted); font-style: italic;">这个模板没有需要填空的内容</p>`;
    } else {
        blanks.forEach((blank, index) => {
            const fieldName = blank.replace(/[{}]/g, '');
            formHtml += `
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: var(--text-color);">${fieldName}</label>
                    <input type="text" class="diary-input" data-field="${fieldName}" 
                           style="min-height: auto; padding: 10px; margin-bottom: 5px;" 
                           placeholder="在这里填写...">
                </div>
            `;
        });
    }
    
    formHtml += `
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button onclick="saveTemplateEntry('${template.id}')" 
                    style="background: var(--primary-color); color: white; border: none; 
                           padding: 12px 24px; border-radius: 8px; cursor: pointer; 
                           font-weight: 600; flex: 1;">
                完成记录
            </button>
            <button onclick="cancelTemplateForm()" 
                    style="background: #6c757d; color: white; border: none; 
                           padding: 12px 24px; border-radius: 8px; cursor: pointer; 
                           font-weight: 600; flex: 1;">
                取消
            </button>
        </div>
    `;
    
    templateForm.innerHTML = formHtml;
    templateForm.style.display = 'block';
}

// 取消模板表单
function cancelTemplateForm() {
    document.getElementById('templateForm').style.display = 'none';
    // 移除模板选中状态
    document.querySelectorAll('.template-card').forEach(card => {
        card.classList.remove('selected');
    });
}

// 保存模板记录
function saveTemplateEntry(templateId) {
    const formInputs = document.querySelectorAll('#templateForm input[data-field]');
    const answers = {};
    
    formInputs.forEach(input => {
        answers[input.dataset.field] = input.value.trim();
    });
    
    // 检查是否所有字段都已填写
    const emptyFields = Object.values(answers).filter(value => !value);
    if (emptyFields.length > 0) {
        showMessage('请填写所有必填字段', 'error');
        return;
    }
    
    showSaveStatus('saving');
    
    // 如果是默认模板，直接保存到本地存储
    if (templateId.startsWith('default')) {
        const entry = {
            content: Object.entries(answers).map(([key, value]) => `${key}: ${value}`).join('\n'),
            mood: selectedMood || '😊',
            entry_type: 'template',
            template_name: '默认模板',
            created_at: new Date().toISOString()
        };
        
        // 保存到本地存储
        const savedEntries = JSON.parse(localStorage.getItem('diary_entries') || '[]');
        savedEntries.push(entry);
        localStorage.setItem('diary_entries', JSON.stringify(savedEntries));
        
        showSaveStatus('saved');
        showMessage('记录保存成功！', 'success');
        
        // 清空表单
        document.getElementById('templateForm').style.display = 'none';
        return;
    }
    
    // 正常API保存
    fetch('/tools/api/diary/template-save/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            template_id: templateId,
            answers: answers,
            mood: selectedMood || '😊'
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showSaveStatus('saved');
            showMessage(data.message, 'success');
            checkForAchievements();
        } else {
            showMessage(data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Template save error:', error);
        showMessage('保存失败', 'error');
    });
}

// 显示保存状态
function showSaveStatus(status) {
    const saveStatus = document.getElementById('saveStatus');
    const icon = saveStatus.querySelector('i');
    const text = saveStatus.querySelector('span');
    
    saveStatus.style.display = 'inline-flex';
    
    if (status === 'saving') {
        saveStatus.className = 'save-status saving';
        icon.className = 'fas fa-spinner fa-spin';
        text.textContent = '保存中...';
    } else if (status === 'saved') {
        saveStatus.className = 'save-status saved';
        icon.className = 'fas fa-check-circle';
        text.textContent = '已保存';
        
        // 3秒后隐藏
        setTimeout(() => {
            saveStatus.style.display = 'none';
        }, 3000);
    }
}

// 检查成就
function checkForAchievements() {
    fetch('/tools/api/diary/achievements/')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const newAchievements = data.achievements.filter(a => 
                a.is_completed && !localStorage.getItem(`achievement_${a.id}_shown`)
            );
            
            if (newAchievements.length > 0) {
                showAchievementPopup(newAchievements[0]);
                localStorage.setItem(`achievement_${newAchievements[0].id}_shown`, 'true');
            }
        }
    })
    .catch(error => {
        console.error('Check achievements error:', error);
    });
}

// 显示成就弹窗
function showAchievementPopup(achievement) {
    const popup = document.getElementById('achievementPopup');
    const icon = popup.querySelector('.achievement-icon');
    const title = popup.querySelector('.achievement-title');
    const desc = popup.querySelector('.achievement-desc');
    
    icon.textContent = achievement.icon;
    title.textContent = achievement.name;
    desc.textContent = achievement.description;
    
    popup.classList.add('show');
    
    // 添加庆祝动画
    setTimeout(() => {
        popup.classList.add('pulse');
    }, 500);
}

// 关闭成就弹窗
function closeAchievementPopup() {
    const popup = document.getElementById('achievementPopup');
    popup.classList.remove('show', 'pulse');
}

// 滚动到顶部
function scrollToTop() {
    window.scrollTo({
        top: 0,
        behavior: 'smooth'
    });
}

// 更新字数统计
function updateWordCount(count) {
    // 可以在这里更新字数显示

}

// 改进的消息提示系统
function showMessage(message, type = 'info', duration = 3000) {
    // 移除现有的消息
    const existingMessages = document.querySelectorAll('.message-toast');
    existingMessages.forEach(msg => document.body.removeChild(msg));
    
    // 创建消息提示元素
    const messageEl = document.createElement('div');
    messageEl.className = 'message-toast';
    messageEl.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 1001;
        max-width: 300px;
        word-wrap: break-word;
        animation: slideIn 0.3s ease-out;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    
    // 根据类型设置背景色和图标
    let icon = '';
    switch(type) {
        case 'success':
            messageEl.style.background = 'var(--success-color)';
            icon = '✅ ';
            break;
        case 'error':
            messageEl.style.background = 'var(--danger-color)';
            icon = '❌ ';
            break;
        case 'warning':
            messageEl.style.background = 'var(--warning-color)';
            icon = '⚠️ ';
            break;
        case 'info':
        default:
            messageEl.style.background = 'var(--primary-color)';
            icon = 'ℹ️ ';
            break;
    }
    
    messageEl.innerHTML = `<span>${icon}${message}</span>`;
    document.body.appendChild(messageEl);
    
    // 自动移除
    setTimeout(() => {
        messageEl.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => {
            if (document.body.contains(messageEl)) {
                document.body.removeChild(messageEl);
            }
        }, 300);
    }, duration);
    
    // 点击关闭
    messageEl.addEventListener('click', () => {
        messageEl.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => {
            if (document.body.contains(messageEl)) {
                document.body.removeChild(messageEl);
            }
        }, 300);
    });
}

// 获取CSRF Token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// 添加CSS动画
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(style);
</script>


        </div>
    </div>


    


    <style>
        /* 微信二维码弹窗样式 */
        .wechat-modal {
            position: fixed;
            z-index: 10001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .wechat-modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            position: relative;
            max-width: 300px;
            width: 90%;
        }
        
        .wechat-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
        
        .wechat-close:hover {
            color: #333;
        }
        
        .qr-code-placeholder {
            margin-top: 20px;
        }
        
        .qr-code-placeholder p {
            margin-top: 10px;
            color: #666;
        }
        
        /* 动画效果 */
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        

        
        @keyframes shine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* 改进的文件上传样式 */
        .geek-file-upload {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .geek-file-upload:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 255, 231, 0.3);
        }
        
        .geek-file-upload .upload-text {
            color: #ffffff !important;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
            font-weight: 600;
        }
        
        .geek-file-upload .upload-hint {
            color: #cccccc !important;
            text-shadow: 0 0 3px rgba(204, 204, 204, 0.3);
        }
        
        .geek-file-upload .upload-icon {
            color: #00ffe7 !important;
            text-shadow: 0 0 10px rgba(0, 255, 231, 0.5);
        }
        
        /* 大按钮样式 */
        .large-upload-btn:hover {
            transform: translateY(-3px) !important;
            box-shadow: 0 12px 30px rgba(0, 255, 231, 0.4) !important;
            border-color: rgba(0, 255, 231, 0.8) !important;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3) 0%, rgba(0, 255, 231, 0.2) 100%) !important;
        }
        
        .large-upload-btn:hover .upload-icon {
            transform: scale(1.1);
            transition: transform 0.3s ease;
        }
        
        /* 文件上传区域动画 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        #filePreviewArea {
            animation: fadeIn 0.3s ease;
        }
        
        /* 文件预览项动画 */
        #imagePreviewContainer > div,
        #videoPreviewContainer > div {
            animation: fadeIn 0.3s ease;
        }
        
        /* Tab切换动画 */
        #tab-content-existing,
        #tab-content-new {
            animation: fadeIn 0.3s ease;
        }
        
        /* Tab按钮悬停效果 */
        #tab-existing:hover,
        #tab-new:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 255, 231, 0.3);
        }
        
        /* 文件预览区域样式 */
        #filePreviewArea {
            background: linear-gradient(135deg, rgba(26,31,46,0.8) 0%, rgba(0,255,231,0.05) 100%);
            border: 1px solid rgba(0, 255, 231, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }
        
        /* 图片预览样式 */
        #imagePreviewContainer img {
            transition: all 0.3s ease;
        }
        
        #imagePreviewContainer img:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0, 255, 231, 0.4);
        }
        
        /* 视频预览样式 */
        #videoPreviewContainer video {
            transition: all 0.3s ease;
        }
        
        #videoPreviewContainer video:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(118, 75, 162, 0.4);
        }
        
        /* 删除按钮样式 */
        .file-remove-btn {
            transition: all 0.3s ease;
        }
        
        .file-remove-btn:hover {
            background: rgba(255, 0, 0, 1) !important;
            transform: scale(1.1);
        }
        
        /* 文件列表项样式 */
        #fileListContainer > div {
            transition: all 0.3s ease;
        }
        
        #fileListContainer > div:hover {
            background: rgba(0, 255, 231, 0.1) !important;
            border-color: rgba(0, 255, 231, 0.5) !important;
        }

    </style>
    <!-- CDN回退处理 -->
    <script>
        // ===============================
        // 核心工具函数区域 - 用于简化前端调整
        // ===============================
        
        // 导航栏样式优化函数 - 轻量级美化
        window.enhanceNavbar = function() {
            const navbar = document.querySelector('.navbar');
            if (navbar) {
                // 添加必要的类，但不强制覆盖样式
                if (!navbar.classList.contains('unified-navbar')) {
                    navbar.classList.add('unified-navbar');
                }

            }
        };
        
        // 控制首页导航栏显示函数
        window.controlHomePageNavbar = function() {
            const currentPath = window.location.pathname;
            const navbar = document.querySelector('.navbar');
            const navbarNav = document.querySelector('.navbar-nav');
            
            if (currentPath === '/' || currentPath === '') {
                // 首页：正常显示菜单，隐藏提示
                if (navbarNav) {
                    navbarNav.style.setProperty('opacity', '1', 'important');
                    navbarNav.style.setProperty('visibility', 'visible', 'important');
                    navbarNav.style.setProperty('transform', 'none', 'important');
                    navbarNav.style.setProperty('pointer-events', 'auto', 'important');
                    navbarNav.style.setProperty('transition', 'none', 'important');
                }
                if (navbar) {
                    // 隐藏提示符
                    const style = document.createElement('style');
                    style.textContent = '.navbar::after { display: none !important; }';
                    document.head.appendChild(style);
                }
            }
        };
        
        // 安全的函数调用包装器
        window.safeCall = function(funcName, ...args) {
            if (typeof window[funcName] === 'function') {
                return window[funcName](...args);
            } else {
                console.warn(`函数 ${funcName} 未定义，跳过调用`);
                return null;
            }
        };
        
        // ===============================
        // 简化主题管理器 - 易于调整
        // ===============================
        window.themeManager = {
            themes: {
                'geek': { name: '极客', navbar: 'geek-navbar' },
                'life': { name: '生活', navbar: 'life-navbar' },
                'emo': { name: 'EMO', navbar: 'emo-navbar' }, 
                'cyberpunk': { name: '赛博朋克', navbar: 'cyber-navbar' },
                'punk': { name: '朋克', navbar: 'punk-nav' }
            },
            
            // 应用主题样式
            applyTheme: function(themeName) {
                const body = document.body;
                const navbar = document.querySelector('.navbar');
                
                // 清除所有主题类
                Object.values(this.themes).forEach(theme => {
                    body.classList.remove(`${themeName}-theme`);
                    if (navbar) navbar.classList.remove(theme.navbar);
                });
                
                // 应用新主题
                if (this.themes[themeName]) {
                    body.classList.add(`${themeName}-theme`);
                    if (navbar) navbar.classList.add(this.themes[themeName].navbar);
                    
                    // 轻量级导航栏优化
                    setTimeout(() => window.safeCall('enhanceNavbar'), 50);

                    return true;
                }
                return false;
            },
            
            // 获取当前主题
            getCurrentTheme: function() {
                for (let theme in this.themes) {
                    if (document.body.classList.contains(`${theme}-theme`)) {
                        return theme;
                    }
                }
                return 'geek'; // 默认主题
            }
        };
        
        // ===============================
        // 简化UI调整工具
        // ===============================
        window.uiUtils = {
            // 显示通知
            notify: function(message, type = 'info') {
                if (typeof showNotification === 'function') {
                    showNotification(message, type);
                } else {

                }
            },
            
            // 切换元素显示
            toggle: function(selector) {
                const element = document.querySelector(selector);
                if (element) {
                    element.style.display = element.style.display === 'none' ? '' : 'none';
                }
            },
            
            // 安全设置样式
            setStyle: function(selector, property, value, important = true) {
                const elements = document.querySelectorAll(selector);
                elements.forEach(el => {
                    el.style.setProperty(property, value, important ? 'important' : '');
                });
            }
        };
        
        // 简单的CDN回退处理
        document.addEventListener('DOMContentLoaded', function() {
            // 检查Bootstrap CSS是否加载失败
            const bootstrapLinks = document.querySelectorAll('link[href*="bootstrap"]');
            if (bootstrapLinks.length === 0) {
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = 'https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.min.css';
                link.onerror = function() {
                    this.href = 'https://unpkg.com/bootstrap@4.5.2/dist/css/bootstrap.min.css';
                };
                document.head.appendChild(link);
            }
            
            // 检查Font Awesome是否加载失败
            const faLinks = document.querySelectorAll('link[href*="font-awesome"]');
            if (faLinks.length === 0) {
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = 'https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css';
                link.onerror = function() {
                    this.href = 'https://unpkg.com/@fortawesome/fontawesome-free@5.15.4/css/all.min.css';
                };
                document.head.appendChild(link);
            }
            
            // 检查JavaScript依赖 - 确保正确的加载顺序
            function loadScript(src, fallbackSrc, callback) {
                const script = document.createElement('script');
                script.src = src;
                script.onerror = function() {
                    this.src = fallbackSrc;
                };
                script.onload = callback;
                document.head.appendChild(script);
            }
            
            // 按顺序加载依赖
            if (!window.jQuery) {
                loadScript(
                    'https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.slim.min.js',
                    'https://unpkg.com/jquery@3.5.1/dist/jquery.slim.min.js',
                    function() {
                        // jQuery加载完成后加载Popper
                        if (!window.Popper) {
                            loadScript(
                                'https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.9.2/umd/popper.min.js',
                                'https://unpkg.com/@popperjs/core@2.9.2/dist/umd/popper.min.js',
                                function() {
                                    // Popper加载完成后加载Bootstrap
                                    if (!window.bootstrap) {
                                        loadScript(
                                            'https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/js/bootstrap.min.js',
                                            'https://unpkg.com/bootstrap@4.5.2/dist/js/bootstrap.min.js'
                                        );
                                    }
                                }
                            );
                        } else if (!window.bootstrap) {
                            // 如果Popper已存在，直接加载Bootstrap
                            loadScript(
                                'https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/js/bootstrap.min.js',
                                'https://unpkg.com/bootstrap@4.5.2/dist/js/bootstrap.min.js'
                            );
                        }
                    }
                );
            } else if (!window.Popper) {
                // 如果jQuery已存在，加载Popper
                loadScript(
                    'https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.9.2/umd/popper.min.js',
                    'https://unpkg.com/@popperjs/core@2.9.2/dist/umd/popper.min.js',
                    function() {
                        if (!window.bootstrap) {
                            loadScript(
                                'https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/js/bootstrap.min.js',
                                'https://unpkg.com/bootstrap@4.5.2/dist/js/bootstrap.min.js'
                            );
                        }
                    }
                );
            } else if (!window.bootstrap) {
                // 如果jQuery和Popper都已存在，只加载Bootstrap
                loadScript(
                    'https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/js/bootstrap.min.js',
                    'https://unpkg.com/bootstrap@4.5.2/dist/js/bootstrap.min.js'
                );
            }
            
            // 初始化智能色调调整
            setTimeout(() => {
                // detectAndAdjustTopBarTone(); // 已禁用，使用透明背景
            }, 1000);
            
            // 恢复保存的主题
            const savedTheme = localStorage.getItem('currentTheme');
            if (savedTheme) {
                switchTheme(savedTheme);
            } else {
                // 如果没有保存的主题，应用默认主题的按钮颜色
                const defaultThemeColors = {
                    about: 'linear-gradient(135deg, rgba(52, 152, 219, 0.9), rgba(41, 128, 185, 0.9))',
                    settings: 'linear-gradient(135deg, rgba(155, 89, 182, 0.9), rgba(142, 68, 173, 0.9))',
                    menu: 'rgba(255, 255, 255, 0.9)',
                    hide: 'linear-gradient(135deg, rgba(231, 76, 60, 0.9), rgba(192, 57, 43, 0.9))'
                };
                updateButtonColors(defaultThemeColors);
            }
        });
    </script>

    <script>
        // 网易云音乐配置
        let currentSong = null;
        let isMusicPlaying = false;
        let musicInfoVisible = false;
        
        // 主题音乐配置
        const themeMusic = {
            'life': '/static/audio/friday.mp3',
            'work': '/static/audio/keshi - 2 soon.flac',
            'training': '/static/audio/Eternxlkz - SLAY!.flac',
            'emo': '/static/audio/keshi - 2 soon.flac'
        };
        
        // 不同模式对应的歌单
        const modePlaylists = {
            'life': '14069178141',      // 生活模式歌单
            'work': '13437758534',      // Geek模式歌单
            'training': '9357916462',   // 狂暴模式歌单
            'emo': '12632193394'        // Emo模式歌单
        };

        window.onload = function () {
            // 仅在用户登录且是 home 页时显示公告弹窗
            
            
            // 初始化主题音乐
            loadUserTheme();
            
            // 滚动性能优化
            initScrollOptimization();
        };
    
    // 隐藏信息计数器
    let hiddenInfoClickCount = 0;
    let hiddenInfoTimeout;
    
    // 显示隐藏信息
    function showHiddenInfo() {
        hiddenInfoClickCount++;
        
        // 清除之前的定时器
        if (hiddenInfoTimeout) {
            clearTimeout(hiddenInfoTimeout);
        }
        
        // 设置定时器，3秒后重置计数器
        hiddenInfoTimeout = setTimeout(() => {
            hiddenInfoClickCount = 0;
        }, 3000);
        
        // 如果点击了两次，显示隐藏信息
        if (hiddenInfoClickCount >= 2) {
            hiddenInfoClickCount = 0;
            showHiddenInfoModal();
        }
    }
    
    // 显示关于弹窗（直接调用）
    function showAboutModal() {
        showHiddenInfoModal();
    }
    
    // 动态色调检测和调整功能
    function detectAndAdjustTopBarTone() {
        const body = document.body;
        const computedStyle = window.getComputedStyle(body);
        const backgroundColor = computedStyle.backgroundColor;
        
        // 解析背景色
        const rgb = backgroundColor.match(/\d+/g);
        if (!rgb || rgb.length < 3) return;
        
        const [r, g, b] = rgb.map(Number);
        
        // 计算亮度
        const brightness = (r * 299 + g * 587 + b * 114) / 1000;
        
        // 检测主色调
        const maxColor = Math.max(r, g, b);
        let dominantColor = 'neutral';
        let colorIntensity = 0;
        
        if (maxColor === r && r > g + 50 && r > b + 50) {
            dominantColor = 'red';
            colorIntensity = r / 255;
        } else if (maxColor === g && g > r + 50 && g > b + 50) {
            dominantColor = 'green';
            colorIntensity = g / 255;
        } else if (maxColor === b && b > r + 50 && b > g + 50) {
            dominantColor = 'blue';
            colorIntensity = b / 255;
        }
        
        // 根据背景色调整顶部栏（已禁用，使用透明背景）
        // adjustTopBarColors(brightness, dominantColor, colorIntensity, r, g, b);
    }
    
    // 调整顶部栏颜色
    function adjustTopBarColors(brightness, dominantColor, colorIntensity, r, g, b) {
        const topUiBar = document.querySelector('.top-ui-bar');
        if (!topUiBar) return;
        
        // 根据亮度决定是深色还是浅色主题
        const isDark = brightness < 128;
        
        if (isDark) {
            // 深色背景 - 使用较亮的顶部栏
            const lightR = Math.min(255, r + 100);
            const lightG = Math.min(255, g + 100);
            const lightB = Math.min(255, b + 100);
            
            const topBarBg = `linear-gradient(135deg, rgba(${lightR}, ${lightG}, ${lightB}, 0.9) 0%, rgba(${Math.min(255, lightR + 30)}, ${Math.min(255, lightG + 30)}, ${Math.min(255, lightB + 30)}, 0.9) 100%)`;
            
            topUiBar.style.background = topBarBg;
            topUiBar.style.borderBottom = '2px solid rgba(255, 255, 255, 0.3)';
            topUiBar.style.boxShadow = `0 8px 32px rgba(${lightR}, ${lightG}, ${lightB}, 0.4), 0 0 20px rgba(${lightR}, ${lightG}, ${lightB}, 0.3)`;
            
        } else {
            // 浅色背景 - 使用较暗的顶部栏
            const darkR = Math.max(0, r - 100);
            const darkG = Math.max(0, g - 100);
            const darkB = Math.max(0, b - 100);
            
            const topBarBg = `linear-gradient(135deg, rgba(${darkR}, ${darkG}, ${darkB}, 0.9) 0%, rgba(${Math.max(0, darkR - 30)}, ${Math.max(0, darkG - 30)}, ${Math.max(0, darkB - 30)}, 0.9) 100%)`;
            
            topUiBar.style.background = topBarBg;
            topUiBar.style.borderBottom = '2px solid rgba(0, 0, 0, 0.2)';
            topUiBar.style.boxShadow = `0 8px 32px rgba(${darkR}, ${darkG}, ${darkB}, 0.4), 0 0 20px rgba(${darkR}, ${darkG}, ${darkB}, 0.3)`;
        }

    }
    
    // 切换主题模式
    function switchTheme(theme) {
        // 关闭设置弹窗
        closeSettingsModal();
        
        // 主题名称映射
        const themeNames = {
            'work': '极客模式',
            'life': '生活模式',
            'training': '狂暴模式',
            'emo': 'Emo模式'
        };
        
        // 主题页面映射
        const themePages = {
            'work': '/tools/work_mode/',
            'life': '/tools/life_mode/',
            'training': '/tools/training_mode/',
            'emo': '/tools/emo_mode/'
        };
        
        // 更新顶部栏的主题标识
        const aboutButton = document.getElementById('aboutButton');
        if (aboutButton) {
            aboutButton.querySelector('span').textContent = themeNames[theme] || '关于';
        }
        
        // 根据主题设置页面样式
        const body = document.body;
        const topUiBar = document.querySelector('.top-ui-bar');
        
        // 移除之前的主题类
        body.classList.remove('theme-work', 'theme-life', 'theme-training', 'theme-emo');
        
        // 添加新主题类
        body.classList.add(`theme-${theme}`);
        
        // 设置主题特定的样式
        const themeStyles = {
            'work': {
                background: 'linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%)',
                topBarBg: 'linear-gradient(135deg, rgba(26, 26, 46, 0.9) 0%, rgba(22, 33, 62, 0.9) 50%, rgba(15, 52, 96, 0.9) 100%)',
                color: '#e8e8e8',
                buttonColors: {
                    about: 'linear-gradient(135deg, rgba(52, 152, 219, 0.9), rgba(41, 128, 185, 0.9))',
                    settings: 'linear-gradient(135deg, rgba(155, 89, 182, 0.9), rgba(142, 68, 173, 0.9))',
                    menu: 'rgba(255, 255, 255, 0.9)',
                    hide: 'linear-gradient(135deg, rgba(231, 76, 60, 0.9), rgba(192, 57, 43, 0.9))'
                }
            },
            'life': {
                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                topBarBg: 'linear-gradient(135deg, rgba(102, 126, 234, 0.9) 0%, rgba(118, 75, 162, 0.9) 100%)',
                color: '#ffffff',
                buttonColors: {
                    about: 'linear-gradient(135deg, rgba(102, 126, 234, 0.9), rgba(118, 75, 162, 0.9))',
                    settings: 'linear-gradient(135deg, rgba(155, 89, 182, 0.9), rgba(142, 68, 173, 0.9))',
                    menu: 'rgba(255, 255, 255, 0.9)',
                    hide: 'linear-gradient(135deg, rgba(231, 76, 60, 0.9), rgba(192, 57, 43, 0.9))'
                }
            },
            'training': {
                background: 'linear-gradient(135deg, #ff6b6b 0%, #ee5a24 50%, #ff3838 100%)',
                topBarBg: 'linear-gradient(135deg, rgba(255, 107, 107, 0.9) 0%, rgba(238, 90, 36, 0.9) 50%, rgba(255, 56, 56, 0.9) 100%)',
                color: '#ffffff',
                buttonColors: {
                    about: 'linear-gradient(135deg, rgba(255, 107, 107, 0.9), rgba(238, 90, 36, 0.9))',
                    settings: 'linear-gradient(135deg, rgba(255, 56, 56, 0.9), rgba(192, 57, 43, 0.9))',
                    menu: 'rgba(255, 255, 255, 0.9)',
                    hide: 'linear-gradient(135deg, rgba(139, 0, 0, 0.9), rgba(128, 0, 0, 0.9))'
                }
            },
            'emo': {
                background: 'linear-gradient(135deg, #2c3e50 0%, #34495e 50%, #7f8c8d 100%)',
                topBarBg: 'linear-gradient(135deg, rgba(44, 62, 80, 0.9) 0%, rgba(52, 73, 94, 0.9) 50%, rgba(127, 140, 141, 0.9) 100%)',
                color: '#ecf0f1',
                buttonColors: {
                    about: 'linear-gradient(135deg, rgba(44, 62, 80, 0.9), rgba(52, 73, 94, 0.9))',
                    settings: 'linear-gradient(135deg, rgba(127, 140, 141, 0.9), rgba(149, 165, 166, 0.9))',
                    menu: 'rgba(255, 255, 255, 0.9)',
                    hide: 'linear-gradient(135deg, rgba(149, 165, 166, 0.9), rgba(127, 140, 141, 0.9))'
                }
            }
        };
        
        const style = themeStyles[theme];
        if (style) {
            // 应用主题样式
            body.style.background = style.background;
            body.style.color = style.color;
            
            if (topUiBar) {
                // 保持透明背景，不覆盖
                // topUiBar.style.background = style.topBarBg;
            }
            
            // 更新按钮颜色
            updateButtonColors(style.buttonColors);
            
            // 保存主题到本地存储
            localStorage.setItem('currentTheme', theme);
            
            // 显示主题切换通知
            showThemeNotification(themeNames[theme] || theme);

            // 跳转到对应的主题页面
            const targetPage = themePages[theme];
            if (targetPage) {

                // 添加延迟，让用户看到切换效果
                setTimeout(() => {
                    window.location.href = targetPage;
                }, 500);
            } else {

            }
        }
    }
    
    // 切换用户下拉菜单
    function toggleUserDropdown() {
        const dropdownContent = document.getElementById('userDropdownContent');
        const chevronIcon = document.querySelector('.top-ui-user .fa-chevron-down');
        
        if (!dropdownContent) {
            console.error('用户下拉菜单元素未找到');
            return;
        }
        
        // 检查当前显示状态 - 修复逻辑
        const isVisible = dropdownContent.style.display === 'block' || 
                         dropdownContent.style.opacity === '1' ||
                         dropdownContent.classList.contains('show');

        if (isVisible) {
            // 隐藏菜单
            dropdownContent.style.display = 'none';
            dropdownContent.style.opacity = '0';
            dropdownContent.style.transform = 'scale(0.95) translateY(-10px)';
            dropdownContent.classList.remove('show');
            if (chevronIcon) {
                chevronIcon.style.transform = 'rotate(0deg)';
            }

        } else {
            // 显示菜单
            dropdownContent.style.display = 'block';
            dropdownContent.style.opacity = '1';
            dropdownContent.style.transform = 'scale(1) translateY(0)';
            dropdownContent.classList.add('show');
            if (chevronIcon) {
                chevronIcon.style.transform = 'rotate(180deg)';
            }

        }

    }
    
    // 点击其他地方关闭下拉菜单
    document.addEventListener('click', function(event) {
        const userDropdown = document.querySelector('.top-ui-user-dropdown');
        const dropdownContent = document.getElementById('userDropdownContent');
        
        if (userDropdown && !userDropdown.contains(event.target)) {
            if (dropdownContent && dropdownContent.style.display === 'block') {
                dropdownContent.style.display = 'none';
            }
            const chevronIcon = document.querySelector('.top-ui-user .fa-chevron-down');
            if (chevronIcon) {
                chevronIcon.style.transform = 'rotate(0deg)';
            }
        }
    });
    
    // 更新按钮颜色
    function updateButtonColors(colors) {
        const aboutButton = document.getElementById('aboutButton');
        const settingsButton = document.querySelector('[onclick="showSettings()"]');
        const menuButton = document.querySelector('[onclick="toggleMobileMenu()"]');
        const hideButton = document.querySelector('[onclick="hideTopUI()"]');
        
        if (aboutButton && colors.about) {
            aboutButton.style.background = 'transparent !important';
            aboutButton.style.border = 'none !important';
            aboutButton.style.boxShadow = 'none !important';
            const aboutIcon = aboutButton.querySelector('.fas');
            if (aboutIcon) {
                aboutIcon.style.textShadow = '0 0 20px rgba(52, 152, 219, 0.8), 0 0 40px rgba(52, 152, 219, 0.6) !important';
                aboutIcon.style.filter = 'drop-shadow(0 0 10px rgba(52, 152, 219, 0.8)) !important';
            }
        }
        
        if (settingsButton && colors.settings) {
            settingsButton.style.background = 'transparent !important';
            settingsButton.style.border = 'none !important';
            settingsButton.style.boxShadow = 'none !important';
            const settingsIcon = settingsButton.querySelector('.fas');
            if (settingsIcon) {
                settingsIcon.style.textShadow = '0 0 20px rgba(155, 89, 182, 0.8), 0 0 40px rgba(155, 89, 182, 0.6) !important';
                settingsIcon.style.filter = 'drop-shadow(0 0 10px rgba(155, 89, 182, 0.8)) !important';
            }
        }
        
        if (menuButton && colors.menu) {
            menuButton.style.background = 'transparent !important';
            menuButton.style.border = 'none !important';
            menuButton.style.boxShadow = 'none !important';
            const menuIcon = menuButton.querySelector('.fas');
            if (menuIcon) {
                menuIcon.style.textShadow = '0 0 20px rgba(255, 255, 255, 0.8), 0 0 40px rgba(255, 255, 255, 0.6) !important';
                menuIcon.style.filter = 'drop-shadow(0 0 10px rgba(255, 255, 255, 0.8)) !important';
            }
        }
        
        if (hideButton && colors.hide) {
            hideButton.style.background = 'transparent !important';
            hideButton.style.border = 'none !important';
            hideButton.style.boxShadow = 'none !important';
            const hideIcon = hideButton.querySelector('.fas');
            if (hideIcon) {
                hideIcon.style.textShadow = '0 0 20px rgba(231, 76, 60, 0.8), 0 0 40px rgba(231, 76, 60, 0.6) !important';
                hideIcon.style.filter = 'drop-shadow(0 0 10px rgba(231, 76, 60, 0.8)) !important';
            }
        }
    }
    
    // 显示主题切换通知
    function showThemeNotification(themeName) {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 10001;
            font-weight: 500;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transform: translateX(100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        `;
        notification.textContent = `🎨 已切换到${themeName}`;
        
        document.body.appendChild(notification);
        
        // 显示动画
        setTimeout(() => {
            notification.style.transform = 'translateX(0)';
        }, 100);
        
        // 自动隐藏
        setTimeout(() => {
            notification.style.transform = 'translateX(100%)';
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }
    
    // 显示隐藏信息弹窗
    function showHiddenInfoModal() {
        const modalHtml = `
            <div id="hiddenInfoModal" class="wechat-modal" style="display: flex;">
                <div class="wechat-modal-content" style="max-width: 600px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
                    <span class="wechat-close" onclick="closeHiddenInfoModal()" style="color: white; font-size: 28px;">&times;</span>
                    
                    <!-- 动态标题 -->
                    <div style="text-align: center; margin-bottom: 25px; position: relative;">
                        <h2 style="margin: 0; font-size: 24px; font-weight: bold; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                            <i class="fas fa-rocket" style="margin-right: 10px; animation: bounce 2s infinite;"></i>
                            关于我
                            <i class="fas fa-rocket" style="margin-left: 10px; animation: bounce 2s infinite 1s;"></i>
                        </h2>
                        <div style="position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%); width: 60px; height: 3px; background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1); border-radius: 2px;"></div>
                    </div>
                    
                    <!-- 个人信息卡片 -->
                    <div style="background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); padding: 20px; border-radius: 15px; margin-bottom: 25px; text-align: center; border: 1px solid rgba(255,255,255,0.2);">
                        <h3 style="margin: 0 0 8px 0; font-size: 22px; font-weight: bold;">高杰</h3>
                        <p style="margin: 0; opacity: 0.9; font-size: 16px;">乐此不疲</p>
                    </div>
                    
                    <!-- 联系信息网格 -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                        <!-- 微信二维码 -->
                        <div style="text-align: center; background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); padding: 20px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.2); transition: transform 0.3s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                            <h4 style="color: #00C800; margin-bottom: 15px; font-size: 18px; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">
                                <i class="fab fa-weixin" style="margin-right: 8px;"></i> 微信联系
                            </h4>
                            <div style="width: 130px; height: 130px; border: 3px solid #00C800; border-radius: 12px; background: white; display: flex; align-items: center; justify-content: center; margin: 0 auto; box-shadow: 0 8px 20px rgba(0,0,0,0.2); overflow: hidden;">
                                <img src="/media/vx.jpg" alt="微信二维码" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
                            </div>
                            <p style="color: rgba(255,255,255,0.8); font-size: 12px; margin-top: 10px;">扫一扫加我为朋友</p>
                        </div>
                        
                        <!-- 简历下载 -->
                        <div style="text-align: center; background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); padding: 20px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.2); transition: transform 0.3s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                            <h4 style="color: #4ecdc4; margin-bottom: 15px; font-size: 18px; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">
                                <i class="fas fa-file-pdf" style="margin-right: 8px;"></i> 个人简历
                            </h4>
                            <div style="width: 130px; height: 130px; border: 3px solid #4ecdc4; border-radius: 12px; background: linear-gradient(135deg, #4ecdc4, #44a08d); display: flex; align-items: center; justify-content: center; margin: 0 auto; box-shadow: 0 8px 20px rgba(0,0,0,0.2); position: relative; overflow: hidden;">
                                <i class="fas fa-download" style="color: white; font-size: 40px; z-index: 2;"></i>
                                <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.3) 50%, transparent 70%); animation: shine 2s infinite;"></div>
                            </div>
                            <a href="/media/高杰-测试工程师.pdf" target="_blank" 
                               style="display: inline-block; margin-top: 12px; padding: 10px 20px; background: linear-gradient(135deg, #4ecdc4, #44a08d); color: white; text-decoration: none; border-radius: 25px; font-size: 14px; font-weight: bold; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                <i class="fas fa-download" style="margin-right: 8px;"></i> 下载简历
                            </a>
                        </div>
                    </div>
                    
                    <!-- 更多链接 -->
                    <div style="background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); padding: 20px; border-radius: 15px; margin-bottom: 25px; border: 1px solid rgba(255,255,255,0.2);">
                        <h4 style="color: white; margin-bottom: 20px; font-size: 18px; text-align: center; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">
                            <i class="fas fa-link" style="margin-right: 8px;"></i> 更多链接
                        </h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <a href="https://github.com/shinytsing/QAToolBox" target="_blank" 
                               style="display: flex; align-items: center; padding: 15px; background: linear-gradient(135deg, #333, #555); color: white; text-decoration: none; border-radius: 12px; transition: all 0.3s ease; font-size: 14px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.2);" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
                                <i class="fab fa-github" style="margin-right: 10px; font-size: 20px;"></i>
                                GitHub 源码
                            </a>
                            <a href="https://music.163.com/#/user/home?id=555356040" target="_blank" 
                               style="display: flex; align-items: center; padding: 15px; background: linear-gradient(135deg, #ff2442, #ff6b6b); color: white; text-decoration: none; border-radius: 12px; transition: all 0.3s ease; font-size: 14px; font-weight: bold; box-shadow: 0 4px 15px rgba(255, 36, 66, 0.3);" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
                                <i class="fab fa-music" style="margin-right: 10px; font-size: 20px;"></i>
                                网易云音乐
                            </a>
                        </div>
                    </div>
                    

                    <!-- AI Link -->
                    <div style="text-align: center; margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 15px; border: 1px solid rgba(255,255,255,0.2);">
                        <h4 style="color: white; margin-bottom: 15px; font-size: 16px; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">
                            <i class="fas fa-link" style="margin-right: 8px;"></i> AI Link
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #ff6b6b; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">AI</div>
                                <div style="font-size: 12px; color: rgba(255,255,255,0.8);">智能助手</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #4ecdc4; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">Link</div>
                                <div style="font-size: 12px; color: rgba(255,255,255,0.8);">友情链接</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #45b7d1; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">∞</div>
                                <div style="font-size: 12px; color: rgba(255,255,255,0.8);">无限可能</div>
                            </div>
                        </div>
                        <div style="margin-top: 15px;">
                            <a href="/content/ai-links/" style="display: inline-block; padding: 8px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; border-radius: 20px; font-size: 14px; font-weight: 500; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);">
                                <i class="fas fa-external-link-alt" style="margin-right: 5px;"></i> 查看AI Link
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // 点击外部关闭
        const modal = document.getElementById('hiddenInfoModal');
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeHiddenInfoModal();
            }
        });
    }
    
    // 关闭隐藏信息弹窗
    function closeHiddenInfoModal() {
        const modal = document.getElementById('hiddenInfoModal');
        if (modal) {
            modal.remove();
        }
    }
    
    // 滚动性能优化函数
    function initScrollOptimization() {
        let isScrolling = false;
        let scrollTimeout;
        
        // 监听滚动事件
        window.addEventListener('scroll', function() {
            if (!isScrolling) {
                // 开始滚动时暂停动画
                pauseAnimations();
                isScrolling = true;
            }
            
            // 清除之前的定时器
            clearTimeout(scrollTimeout);
            
            // 滚动停止后恢复动画
            scrollTimeout = setTimeout(function() {
                resumeAnimations();
                isScrolling = false;
            }, 150); // 150ms后恢复
        }, { passive: true }); // 使用passive监听器提高性能
    }
    
    // 暂停所有动画
    function pauseAnimations() {
        const animatedElements = document.querySelectorAll('*');
        animatedElements.forEach(element => {
            const computedStyle = window.getComputedStyle(element);
            if (computedStyle.animationName !== 'none') {
                element.style.animationPlayState = 'paused';
            }
        });
    }
    
    // 恢复所有动画
    function resumeAnimations() {
        const animatedElements = document.querySelectorAll('*');
        animatedElements.forEach(element => {
            const computedStyle = window.getComputedStyle(element);
            if (computedStyle.animationName !== 'none') {
                element.style.animationPlayState = 'running';
            }
        });
    }
    
    // 公告相关函数
    function loadAnnouncements() {
        fetch('/content/api/announcements/')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.announcements.length > 0) {
                    // 过滤出需要弹窗显示的公告
                    const popupAnnouncements = data.announcements.filter(a => a.is_popup);
                    if (popupAnnouncements.length > 0) {
                        showAnnouncementPopup(popupAnnouncements);
                    }
                }
            })
            .catch(error => {
                console.error('Error loading announcements:', error);
            });
    }
    
    function showAnnouncementPopup(announcements) {
        const overlay = document.getElementById('announcement-overlay');
        const body = document.getElementById('announcement-body');
        
        if (!overlay || !body) return;
        
        // 渲染公告内容
        let html = '';
        announcements.forEach(announcement => {
            html += `
                <div class="announcement-item priority-${announcement.priority}">
                    <div class="announcement-title">${announcement.title}</div>
                    <div class="announcement-text">${announcement.content}</div>
                    <div class="announcement-time">${announcement.created_at}</div>
                </div>
            `;
        });
        
        body.innerHTML = html;
        
        // 显示弹窗
        overlay.classList.add('active');
        
        // 5秒后自动消失
        setTimeout(function() {
            closeAnnouncement();
        }, 5000);
    }
    
    function closeAnnouncement() {
        const overlay = document.getElementById('announcement-overlay');
        if (overlay) {
            overlay.classList.remove('active');
        }
    }
        
        // 添加点击黑幕关闭公告的功能
        document.addEventListener('DOMContentLoaded', function() {
            const overlay = document.getElementById('announcement-overlay');
            if (overlay) {
                // 点击黑幕关闭公告
                overlay.addEventListener('click', function(e) {
                    if (e.target === overlay) {
                        closeAnnouncement();
                    }
                });
                
                // 支持ESC键关闭
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && overlay.classList.contains('active')) {
                        closeAnnouncement();
                    }
                });
            }
        });
    
    // 简化的音乐控制函数
    function toggleMusic() {
        var audio = document.getElementById('theme-music');
        
        if (audio.paused) {
            audio.play();
            showNotification('音乐已开启', 'success');
        } else {
            audio.pause();
            showNotification('音乐已暂停', 'info');
        }
    }
    
    // 优化的主题音乐设置函数
    function setThemeMusic(theme) {
        var audio = document.getElementById('theme-music');
        var source = document.getElementById('music-source');
        
        if (themeMusic[theme] && source.src !== themeMusic[theme]) {
            // 只有在音乐文件不同时才切换，避免重复加载
            source.src = themeMusic[theme];
            audio.load();
            // 异步播放，不阻塞UI
            setTimeout(() => {
                audio.play().catch(function(error) {

                });
            }, 0);
        }
    }
    
    // 显示通知
    function showNotification(message, type) {
            // 创建通知元素
            var notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#28a745' : type === 'warning' ? '#ffc107' : '#17a2b8'};
                color: white;
                padding: 10px 20px;
                border-radius: 5px;
                z-index: 10000;
                font-size: 14px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // 3秒后移除通知
            setTimeout(function() {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }
        
    // 显示上传详细信息
    function showUploadDetails(uploadInfo) {
            // 移除之前的详细提示
            const existingDetails = document.querySelector('.upload-details-toast');
            if (existingDetails) {
                existingDetails.remove();
            }
            
            // 创建详细提示
            const detailsToast = document.createElement('div');
            detailsToast.className = 'upload-details-toast';
            detailsToast.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: linear-gradient(135deg, #00ffe7 0%, #00b8a9 100%);
                color: #0a0e17;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 255, 231, 0.3);
                z-index: 10001;
                max-width: 350px;
                font-family: 'JetBrains Mono', monospace;
                border: 1px solid rgba(0, 255, 231, 0.3);
            `;
            
            let fileDetailsHtml = '';
            uploadInfo.file_details.forEach(file => {
                const icon = file.type === 'image' ? '🖼️' : '🎥';
                fileDetailsHtml += `
                    <div style="margin: 5px 0; padding: 5px; background: rgba(255,255,255,0.1); border-radius: 4px;">
                        <div style="font-weight: 600;">${icon} ${file.name}</div>
                        <div style="font-size: 12px; opacity: 0.8;">大小: ${file.size}</div>
                    </div>
                `;
            });
            
            detailsToast.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div style="font-weight: 700; font-size: 14px;">
                        📁 上传详情
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 16px; cursor: pointer; color: #0a0e17; opacity: 0.7;">&times;</button>
                </div>
                <div style="font-size: 12px; margin-bottom: 10px;">
                    共上传 ${uploadInfo.total_files} 个文件 | 时间: ${uploadInfo.upload_time}
                </div>
                <div style="max-height: 200px; overflow-y: auto;">
                    ${fileDetailsHtml}
                </div>
            `;
            
            document.body.appendChild(detailsToast);
            
            // 5秒后自动移除
            setTimeout(() => {
                if (detailsToast.parentElement) {
                    detailsToast.remove();
                }
            }, 5000);
        }
        
        // 音乐初始化
        window.addEventListener('load', function() {
            var audio = document.getElementById('theme-music');
            
            // 添加音乐状态监听
            audio.addEventListener('play', function() {

            });
            
            audio.addEventListener('pause', function() {

            });
        });

    // 显示建议界面 - 极客风格
    function showSuggestions() {
            // 先获取现有建议
            fetch('/content/api/suggestions/')
                .then(response => response.json())
                .then(data => {
                    let suggestionsHtml = `
                        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10, 14, 23, 0.95); z-index: 10000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px);">
                            <div style="background: linear-gradient(135deg, rgba(26,31,46,0.95) 0%, rgba(0,255,231,0.1) 100%); border: 1px solid rgba(0, 255, 231, 0.2); border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.6); backdrop-filter: blur(10px); padding: 30px; max-width: 900px; max-height: 85vh; overflow-y: auto; width: 95%; position: relative;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 1px solid rgba(0, 255, 231, 0.2); padding-bottom: 15px;">
                                    <h3 style="color: #00ffe7; margin: 0; font-family: 'JetBrains Mono', monospace; font-weight: 700; text-shadow: 0 0 10px rgba(0, 255, 231, 0.5);">
                                        <i class="fas fa-lightbulb" style="color: #00ffe7; margin-right: 10px;"></i> 我的建议
                                    </h3>
                                    <button onclick="closeSuggestions()" style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: #ffffff; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-family: 'JetBrains Mono', monospace; font-size: 12px; transition: all 0.3s ease; display: flex; align-items: center; gap: 5px;">
                                        <i class="fas fa-times"></i> 关闭
                                    </button>
                                </div>
                                
                                <!-- Tab导航 -->
                                <div style="display: flex; margin-bottom: 25px; border-bottom: 1px solid rgba(0, 255, 231, 0.2);">
                                    <button id="tab-existing" onclick="switchTab('existing')" style="flex: 1; background: linear-gradient(135deg, #00ffe7 0%, #667eea 100%); color: #000; border: none; padding: 15px; font-family: 'JetBrains Mono', monospace; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s ease; border-radius: 8px 8px 0 0; margin-right: 2px;">
                                        <i class="fas fa-list" style="margin-right: 8px;"></i> 现有建议
                                    </button>
                                    <button id="tab-new" onclick="switchTab('new')" style="flex: 1; background: rgba(26,31,46,0.8); color: #00ffe7; border: 1px solid rgba(0, 255, 231, 0.3); padding: 15px; font-family: 'JetBrains Mono', monospace; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s ease; border-radius: 8px 8px 0 0; margin-left: 2px;">
                                        <i class="fas fa-plus-circle" style="margin-right: 8px;"></i> 添加新建议
                                    </button>
                                </div>
                                
                                <!-- 现有建议Tab -->
                                <div id="tab-content-existing" style="display: block;">
                                    <div id="existingSuggestions">`;
                    
                    if (data.suggestions && data.suggestions.length > 0) {
                        data.suggestions.forEach(suggestion => {
                            // 根据状态设置颜色
                            let statusColor = '#28a745'; // 默认绿色
                            let borderColor = '#28a745';
                            let statusIcon = '📋';
                            
                            switch(suggestion.status_code) {
                                case 'pending':
                                    statusColor = '#ffc107';
                                    borderColor = '#ffc107';
                                    statusIcon = '⏳';
                                    break;
                                case 'reviewing':
                                    statusColor = '#17a2b8';
                                    borderColor = '#17a2b8';
                                    statusIcon = '👀';
                                    break;
                                case 'implemented':
                                    statusColor = '#28a745';
                                    borderColor = '#28a745';
                                    statusIcon = '✅';
                                    break;
                                case 'rejected':
                                    statusColor = '#dc3545';
                                    borderColor = '#dc3545';
                                    statusIcon = '❌';
                                    break;
                            }
                            
                            suggestionsHtml += `
                                <div style="background: linear-gradient(135deg, rgba(26,31,46,0.8) 0%, rgba(0,255,231,0.05) 100%); border: 1px solid rgba(0, 255, 231, 0.2); padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); backdrop-filter: blur(5px);">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                        <h6 style="margin: 0; color: #00ffe7; font-family: 'JetBrains Mono', monospace; font-weight: 600; text-shadow: 0 0 5px rgba(0, 255, 231, 0.3);">${suggestion.title}</h6>
                                        <div style="text-align: right;">
                                            <span style="font-size: 12px; color: #667eea; font-family: 'JetBrains Mono', monospace;">${suggestion.created_at}</span>
                                            <br>
                                            <span style="font-size: 11px; color: #764ba2; font-family: 'JetBrains Mono', monospace;">更新: ${suggestion.updated_at}</span>
                                        </div>
                                    </div>
                                    <p style="margin: 0; color: #e6e6e6; margin-bottom: 12px; line-height: 1.6; font-family: 'JetBrains Mono', monospace;">${suggestion.content}</p>
                                    
                                    ${(suggestion.images && suggestion.images.length > 0) || (suggestion.videos && suggestion.videos.length > 0) ? `
                                    <div style="margin-bottom: 10px;">
                                        <small style="color: #00ffe7; font-family: 'JetBrains Mono', monospace;">
                                            <i class="fas fa-paperclip" style="margin-right: 5px;"></i>
                                            ${suggestion.images ? suggestion.images.length : 0} 图片, 
                                            ${suggestion.videos ? suggestion.videos.length : 0} 视频
                                        </small>
                                    </div>
                                    ` : ''}
                                    <div style="display: flex; gap: 12px; font-size: 12px; margin-bottom: 10px; flex-wrap: wrap;">
                                        <span style="color: #667eea; font-family: 'JetBrains Mono', monospace; background: rgba(102, 126, 234, 0.1); padding: 4px 8px; border-radius: 6px; border: 1px solid rgba(102, 126, 234, 0.3);">
                                            <i class="fas fa-code" style="margin-right: 4px;"></i> 类型: ${suggestion.suggestion_type}
                                        </span>
                                        <span style="color: ${statusColor}; font-weight: bold; font-family: 'JetBrains Mono', monospace; background: rgba(0, 255, 231, 0.1); padding: 4px 8px; border-radius: 6px; border: 1px solid rgba(0, 255, 231, 0.3);">
                                            ${statusIcon} 状态: ${suggestion.status}
                                        </span>
                                        <span style="color: #764ba2; font-family: 'JetBrains Mono', monospace; background: rgba(118, 75, 162, 0.1); padding: 4px 8px; border-radius: 6px; border: 1px solid rgba(118, 75, 162, 0.3);">
                                            <i class="fas fa-user" style="margin-right: 4px;"></i> 提交者: ${suggestion.user_name}
                                        </span>
                                    </div>
                                    ${suggestion.has_response ? 
                                        '<div style="margin-top: 12px; padding: 15px; background: linear-gradient(135deg, rgba(0, 255, 231, 0.1) 0%, rgba(102, 126, 234, 0.1) 100%); border-radius: 8px; border-left: 4px solid #00ffe7; border: 1px solid rgba(0, 255, 231, 0.3);"><strong style="color: #00ffe7; font-family: \'JetBrains Mono\', monospace;">管理员回复:</strong><br><span style="color: #e6e6e6; font-family: \'JetBrains Mono\', monospace; line-height: 1.5;">' + suggestion.admin_response + '</span></div>' : 
                                        '<div style="margin-top: 12px; padding: 12px; background: linear-gradient(135deg, rgba(118, 75, 162, 0.1) 0%, rgba(0, 255, 231, 0.05) 100%); border-radius: 8px; border: 1px solid rgba(118, 75, 162, 0.3); font-size: 12px; color: #764ba2; text-align: center; font-family: \'JetBrains Mono\', monospace;"><i class="fas fa-clock" style="margin-right: 5px;"></i>等待管理员处理中...</div>'
                                    }
                                </div>`;
                        });
                    } else {
                        suggestionsHtml += `<p style="color: #764ba2; text-align: center; font-family: 'JetBrains Mono', monospace; font-size: 14px; padding: 20px; background: linear-gradient(135deg, rgba(118, 75, 162, 0.1) 0%, rgba(0, 255, 231, 0.05) 100%); border-radius: 8px; border: 1px solid rgba(118, 75, 162, 0.3);"><i class="fas fa-inbox" style="margin-right: 8px;"></i>暂无建议</p>`;
                    }
                    
                    suggestionsHtml += `
                                    </div>
                                </div>
                                
                                <!-- 添加新建议Tab -->
                                <div id="tab-content-new" style="display: none;">
                                    <div style="margin-bottom: 15px;">
                                        <input type="text" id="suggestionTitle" placeholder="建议标题..." style="width: 100%; padding: 12px; background: rgba(26,31,46,0.8); border: 1px solid rgba(0, 255, 231, 0.3); border-radius: 8px; margin-bottom: 12px; color: #e6e6e6; font-family: 'JetBrains Mono', monospace; transition: all 0.3s ease;">
                                        <select id="suggestionType" style="width: 100%; padding: 12px; background: rgba(26,31,46,0.8); border: 1px solid rgba(0, 255, 231, 0.3); border-radius: 8px; margin-bottom: 12px; color: #e6e6e6; font-family: 'JetBrains Mono', monospace; transition: all 0.3s ease;">
                                            <option value="feature">功能建议</option>
                                            <option value="ui">界面改进</option>
                                            <option value="bug">Bug报告</option>
                                            <option value="other">其他</option>
                                        </select>
                                        <textarea id="newSuggestion" placeholder="请输入您的建议内容..." style="width: 100%; height: 120px; padding: 12px; background: rgba(26,31,46,0.8); border: 1px solid rgba(0, 255, 231, 0.3); border-radius: 8px; resize: vertical; color: #e6e6e6; font-family: 'JetBrains Mono', monospace; transition: all 0.3s ease;"></textarea>
                                        
                                        <!-- 文件上传区域 -->
                                        <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, rgba(26,31,46,0.6) 0%, rgba(0,255,231,0.05) 100%); border: 1px solid rgba(0, 255, 231, 0.2); border-radius: 10px;">
                                            <h6 style="color: #ffffff; margin-bottom: 12px; font-family: 'JetBrains Mono', monospace; font-weight: 600; text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);">
                                                <i class="fas fa-paperclip" style="margin-right: 8px; color: #00ffe7;"></i> 添加附件（可选）
                                            </h6>
                                            <div style="margin-bottom: 20px;">
                                                <div class="geek-file-upload large-upload-btn" onclick="document.getElementById('suggestionImages').click()" style="height: 80px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(0, 255, 231, 0.1) 100%); border: 2px dashed rgba(102, 126, 234, 0.5); border-radius: 12px; cursor: pointer; transition: all 0.3s ease;">
                                                    <i class="fas fa-image upload-icon" style="font-size: 1.5rem; color: #667eea; margin-bottom: 5px;"></i>
                                                    <div style="text-align: center;">
                                                        <div style="font-size: 11px; color: #667eea; font-family: 'JetBrains Mono', monospace; margin-bottom: 2px;">点击上传图片</div>
                                                        <div style="font-size: 9px; color: #667eea; font-family: 'JetBrains Mono', monospace;">最多3张图片</div>
                                                    </div>
                                                    <input type="file" id="suggestionImages" multiple accept=".jpg,.jpeg,.png,.gif,.webp" style="display: none;">
                                                </div>
                                                <div id="imageStatus" style="text-align: center; margin-top: 5px; font-size: 11px; color: #667eea; font-family: 'JetBrains Mono', monospace;"></div>
                                            </div>
                                            <div style="margin-bottom: 20px;">
                                                <div class="geek-file-upload large-upload-btn" onclick="document.getElementById('suggestionVideos').click()" style="height: 80px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, rgba(118, 75, 162, 0.2) 0%, rgba(0, 255, 231, 0.1) 100%); border: 2px dashed rgba(118, 75, 162, 0.5); border-radius: 12px; cursor: pointer; transition: all 0.3s ease;">
                                                    <i class="fas fa-video upload-icon" style="font-size: 1.5rem; color: #764ba2; margin-bottom: 5px;"></i>
                                                    <div style="text-align: center;">
                                                        <div style="font-size: 11px; color: #764ba2; font-family: 'JetBrains Mono', monospace; margin-bottom: 2px;">点击上传视频</div>
                                                        <div style="font-size: 9px; color: #764ba2; font-family: 'JetBrains Mono', monospace;">最多1个视频</div>
                                                    </div>
                                                    <input type="file" id="suggestionVideos" multiple accept=".mp4,.avi,.mov,.wmv,.flv,.webm" style="display: none;">
                                                </div>
                                                <div id="videoStatus" style="text-align: center; margin-top: 5px; font-size: 11px; color: #764ba2; font-family: 'JetBrains Mono', monospace;"></div>
                                            </div>
                                            <div id="uploadProgress" style="display: none; margin-top: 12px;">
                                                <div style="background: rgba(26,31,46,0.8); border-radius: 8px; height: 24px; overflow: hidden; border: 1px solid rgba(0, 255, 231, 0.3);">
                                                    <div id="progressBar" style="background: linear-gradient(90deg, #00ffe7 0%, #667eea 100%); height: 100%; width: 0%; transition: width 0.3s; box-shadow: 0 0 10px rgba(0, 255, 231, 0.5);"></div>
                                                </div>
                                                <small style="color: #00ffe7; font-family: 'JetBrains Mono', monospace; margin-top: 5px; display: block;">上传中... <span id="progressText">0%</span></small>
                                            </div>
                                            
                                            <!-- 文件预览区域 -->
                                            <div id="filePreviewArea" style="margin-top: 12px; display: none;">
                                                <h6 style="color: #ffffff; margin-bottom: 8px; font-family: 'JetBrains Mono', monospace; font-weight: 600; font-size: 13px;">
                                                    <i class="fas fa-eye" style="margin-right: 5px; color: #00ffe7;"></i> 文件预览
                                                    <span id="fileCount" style="color: #00ffe7; font-size: 11px; margin-left: 10px;"></span>
                                                </h6>
                                                <div id="imagePreviewContainer" style="margin-bottom: 10px;"></div>
                                                <div id="videoPreviewContainer" style="margin-bottom: 10px;"></div>
                                                <div id="fileListContainer" style="margin-bottom: 10px;"></div>
                                            </div>
                                            
                                            <div id="uploadedFiles" style="margin-top: 12px;"></div>
                                        </div>
                                        
                                        <div style="text-align: center; margin-top: 20px;">
                                            <button onclick="submitSuggestion()" style="background: linear-gradient(135deg, #00ffe7 0%, #667eea 100%); color: #000; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; margin-right: 15px; font-family: 'JetBrains Mono', monospace; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0, 255, 231, 0.3);">
                                                <i class="fas fa-paper-plane" style="margin-right: 8px;"></i> 提交建议
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                

                            </div>
                        </div>
                    `;
                    
                    document.body.insertAdjacentHTML('beforeend', suggestionsHtml);
                    
                    // 重新绑定文件上传事件
                    bindFileUploadEvents();
                })
                .catch(error => {
                    console.error('获取建议失败:', error);
                    showNotification('获取建议失败，请稍后重试', 'error');
                });
        }
        
    // 关闭建议界面
    function closeSuggestions() {

            const suggestions = document.querySelector('div[style*="z-index: 10000"]');
            if (suggestions) {

                suggestions.remove();
            } else {

            }
        }
        
        // 添加ESC键关闭功能
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const suggestions = document.querySelector('div[style*="z-index: 10000"]');
                if (suggestions) {
                    suggestions.remove();
                }
            }
        });
        
    // Tab切换功能
    function switchTab(tabName) {
            // 隐藏所有tab内容
            document.getElementById('tab-content-existing').style.display = 'none';
            document.getElementById('tab-content-new').style.display = 'none';
            
            // 重置所有tab按钮样式
            document.getElementById('tab-existing').style.background = 'rgba(26,31,46,0.8)';
            document.getElementById('tab-existing').style.color = '#00ffe7';
            document.getElementById('tab-existing').style.border = '1px solid rgba(0, 255, 231, 0.3)';
            document.getElementById('tab-new').style.background = 'rgba(26,31,46,0.8)';
            document.getElementById('tab-new').style.color = '#00ffe7';
            document.getElementById('tab-new').style.border = '1px solid rgba(0, 255, 231, 0.3)';
            
            // 显示选中的tab内容
            if (tabName === 'existing') {
                document.getElementById('tab-content-existing').style.display = 'block';
                document.getElementById('tab-existing').style.background = 'linear-gradient(135deg, #00ffe7 0%, #667eea 100%)';
                document.getElementById('tab-existing').style.color = '#000';
                document.getElementById('tab-existing').style.border = 'none';
            } else if (tabName === 'new') {
                document.getElementById('tab-content-new').style.display = 'block';
                document.getElementById('tab-new').style.background = 'linear-gradient(135deg, #00ffe7 0%, #667eea 100%)';
                document.getElementById('tab-new').style.color = '#000';
                document.getElementById('tab-new').style.border = 'none';
            }
        }
        
        // 文件上传事件绑定函数
        function bindFileUploadEvents() {
            // 为建议界面的输入框添加焦点效果
            document.addEventListener('focusin', function(e) {
                if (e.target.matches('#suggestionTitle, #suggestionType, #newSuggestion, #suggestionImages, #suggestionVideos')) {
                    e.target.style.borderColor = '#00ffe7';
                    e.target.style.boxShadow = '0 0 10px rgba(0, 255, 231, 0.3)';
                }
            });
            
            document.addEventListener('focusout', function(e) {
                if (e.target.matches('#suggestionTitle, #suggestionType, #newSuggestion, #suggestionImages, #suggestionVideos')) {
                    if (e.target.id === 'suggestionImages') {
                        e.target.style.borderColor = 'rgba(102, 126, 234, 0.3)';
                    } else if (e.target.id === 'suggestionVideos') {
                        e.target.style.borderColor = 'rgba(118, 75, 162, 0.3)';
                    } else {
                        e.target.style.borderColor = 'rgba(0, 255, 231, 0.3)';
                    }
                    e.target.style.boxShadow = 'none';
                }
            });
            
            // 极客风格文件上传增强功能
            const uploadAreas = document.querySelectorAll('.geek-upload-area, .geek-file-upload');
            
            uploadAreas.forEach(area => {
                const fileInput = area.querySelector('input[type="file"]');
                if (!fileInput) return;
                
                // 拖拽事件
                area.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.classList.add('dragover');
                });
                
                area.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    this.classList.remove('dragover');
                });
                
                area.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('dragover');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        // 文件数量限制检查
                        let maxFiles = 3; // 默认图片限制
                        if (fileInput.id === 'suggestionVideos') {
                            maxFiles = 1; // 视频限制为1个
                        }
                        
                        if (files.length > maxFiles) {
                            showNotification(`最多只能选择${maxFiles}个文件`, 'error');
                            return;
                        }
                        
                        fileInput.files = files;
                        fileInput.dispatchEvent(new Event('change'));
                    }
                });
                
                // 文件选择事件
                fileInput.addEventListener('change', function() {
                    const area = this.closest('.geek-upload-area, .geek-file-upload');
                    
                    // 文件数量限制检查
                    let maxFiles = 3; // 默认图片限制
                    if (this.id === 'suggestionVideos') {
                        maxFiles = 1; // 视频限制为1个
                    }
                    
                    if (this.files.length > maxFiles) {
                        showNotification(`最多只能选择${maxFiles}个文件`, 'error');
                        this.value = ''; // 清空选择
                        return;
                    }
                    
                    if (this.files.length > 0) {
                        area.classList.add('has-file');
                        
                        // 更新状态显示
                        const fileType = this.id === 'suggestionImages' ? '图片' : '视频';
                        const statusElement = document.getElementById(this.id === 'suggestionImages' ? 'imageStatus' : 'videoStatus');
                        if (statusElement) {
                            statusElement.textContent = `已选择 ${this.files.length} 个${fileType}文件`;
                            statusElement.style.color = '#00ffe7';
                        }
                        
                        // 显示上传成功提示
                        showNotification(`成功选择${this.files.length}个${fileType}文件`, 'success');
                        
                        // 显示所有文件的预览
                        showAllFilesPreview();
                    } else {
                        area.classList.remove('has-file');
                        
                        // 清空状态显示
                        const statusElement = document.getElementById(this.id === 'suggestionImages' ? 'imageStatus' : 'videoStatus');
                        if (statusElement) {
                            statusElement.textContent = '';
                        }
                        
                        // 检查是否还有其他文件，如果没有则隐藏预览
                        const imageFiles = document.getElementById('suggestionImages').files;
                        const videoFiles = document.getElementById('suggestionVideos').files;
                        if (imageFiles.length === 0 && videoFiles.length === 0) {
                            hideFilePreview();
                        } else {
                            // 重新显示预览
                            showAllFilesPreview();
                        }
                    }
                });
                
                // 保存原始文本
                const uploadText = area.querySelector('.upload-text');
                if (uploadText) {
                    uploadText.setAttribute('data-original-text', uploadText.textContent);
                }
            });
            
            // 为文件列表添加删除功能
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('file-remove')) {
                    const fileItem = e.target.closest('.geek-file-item');
                    if (fileItem) {
                        fileItem.style.animation = 'fadeOut 0.3s ease';
                        setTimeout(() => {
                            fileItem.remove();
                        }, 300);
                    }
                }
            });
        }
        
        // 添加极客风格的输入框焦点效果
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化时绑定事件
            bindFileUploadEvents();
        });
        
        // 显示所有文件的预览
        function showAllFilesPreview() {
            const imageFiles = document.getElementById('suggestionImages').files;
            const videoFiles = document.getElementById('suggestionVideos').files;
            showFilePreview([], 'all');
        }
        // 文件预览功能
        function showFilePreview(files, inputId) {

            const previewArea = document.getElementById('filePreviewArea');
            const imageContainer = document.getElementById('imagePreviewContainer');
            const videoContainer = document.getElementById('videoPreviewContainer');
            const fileListContainer = document.getElementById('fileListContainer');
            
            // 检查元素是否存在
            if (!previewArea || !imageContainer || !videoContainer || !fileListContainer) {
                console.error('预览区域元素未找到');
                return;
            }
            
            // 显示预览区域
            previewArea.style.display = 'block';
            
            // 获取所有已选择的文件
            const imageFiles = document.getElementById('suggestionImages').files;
            const videoFiles = document.getElementById('suggestionVideos').files;
            
            // 清空之前的预览
            imageContainer.innerHTML = '';
            videoContainer.innerHTML = '';
            fileListContainer.innerHTML = '';
            
            let hasImages = false;
            let hasVideos = false;
            let hasOtherFiles = false;
            
            // 处理图片文件
            if (imageFiles.length > 0) {
                hasImages = true;
                Array.from(imageFiles).forEach((file, index) => {
                    const fileType = file.type;

                    if (fileType.startsWith('image/')) {

                        const reader = new FileReader();
                        reader.onload = function(e) {

                            const imgDiv = document.createElement('div');
                            imgDiv.style.cssText = `
                                display: inline-block;
                                margin: 5px;
                                position: relative;
                                border-radius: 8px;
                                overflow: hidden;
                                border: 2px solid rgba(0, 255, 231, 0.3);
                                background: rgba(26,31,46,0.8);
                            `;
                            
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.style.cssText = `
                                width: 120px;
                                height: 120px;
                                object-fit: cover;
                                display: block;
                            `;
                            
                            // 添加图片加载错误处理
                            img.onerror = function() {
                                console.error('图片加载失败:', file.name);
                                imgDiv.style.borderColor = 'rgba(255, 0, 0, 0.5)';
                            };
                            
                            const removeBtn = document.createElement('button');
                            removeBtn.innerHTML = '×';
                            removeBtn.className = 'file-remove-btn';
                            removeBtn.style.cssText = `
                                position: absolute;
                                top: 5px;
                                right: 5px;
                                background: rgba(255, 0, 0, 0.8);
                                color: white;
                                border: none;
                                border-radius: 50%;
                                width: 20px;
                                height: 20px;
                                cursor: pointer;
                                font-size: 12px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            `;
                            removeBtn.onclick = function() {
                                imgDiv.remove();
                                removeFileFromInput('suggestionImages', index);
                            };
                            
                            const fileName = document.createElement('div');
                            fileName.textContent = file.name.length > 15 ? file.name.substring(0, 15) + '...' : file.name;
                            fileName.style.cssText = `
                                position: absolute;
                                bottom: 0;
                                left: 0;
                                right: 0;
                                background: rgba(0, 0, 0, 0.7);
                                color: white;
                                padding: 2px 5px;
                                font-size: 10px;
                                text-align: center;
                            `;
                            
                            imgDiv.appendChild(img);
                            imgDiv.appendChild(removeBtn);
                            imgDiv.appendChild(fileName);
                            imageContainer.appendChild(imgDiv);

                        };
                        
                        reader.onerror = function() {
                            console.error('图片读取失败:', file.name);
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
            
            // 处理视频文件
            if (videoFiles.length > 0) {
                hasVideos = true;
                Array.from(videoFiles).forEach((file, index) => {
                    const fileType = file.type;

                    if (fileType.startsWith('video/')) {

                        const reader = new FileReader();
                        reader.onload = function(e) {

                            const videoDiv = document.createElement('div');
                            videoDiv.style.cssText = `
                                display: inline-block;
                                margin: 5px;
                                position: relative;
                                border-radius: 8px;
                                overflow: hidden;
                                border: 2px solid rgba(118, 75, 162, 0.3);
                                background: rgba(26,31,46,0.8);
                            `;
                            
                            const video = document.createElement('video');
                            video.src = e.target.result;
                            video.style.cssText = `
                                width: 200px;
                                height: 120px;
                                object-fit: cover;
                                display: block;
                            `;
                            video.controls = true;
                            
                            // 添加视频加载错误处理
                            video.onerror = function() {
                                console.error('视频加载失败:', file.name);
                                videoDiv.style.borderColor = 'rgba(255, 0, 0, 0.5)';
                            };
                            
                            const removeBtn = document.createElement('button');
                            removeBtn.innerHTML = '×';
                            removeBtn.className = 'file-remove-btn';
                            removeBtn.style.cssText = `
                                position: absolute;
                                top: 5px;
                                right: 5px;
                                background: rgba(255, 0, 0, 0.8);
                                color: white;
                                border: none;
                                border-radius: 50%;
                                width: 20px;
                                height: 20px;
                                cursor: pointer;
                                font-size: 12px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            `;
                            removeBtn.onclick = function() {
                                videoDiv.remove();
                                removeFileFromInput('suggestionVideos', index);
                            };
                            
                            const fileName = document.createElement('div');
                            fileName.textContent = file.name.length > 20 ? file.name.substring(0, 20) + '...' : file.name;
                            fileName.style.cssText = `
                                position: absolute;
                                bottom: 0;
                                left: 0;
                                right: 0;
                                background: rgba(0, 0, 0, 0.7);
                                color: white;
                                padding: 2px 5px;
                                font-size: 10px;
                                text-align: center;
                            `;
                            
                            videoDiv.appendChild(video);
                            videoDiv.appendChild(removeBtn);
                            videoDiv.appendChild(fileName);
                            videoContainer.appendChild(videoDiv);

                        };
                        
                        reader.onerror = function() {
                            console.error('视频读取失败:', file.name);
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
            

            
            // 显示预览区域

            if (hasImages || hasVideos || hasOtherFiles) {
                previewArea.style.display = 'block';
                
                // 更新文件计数显示
                const fileCountElement = document.getElementById('fileCount');
                if (fileCountElement) {
                    const totalFiles = imageFiles.length + videoFiles.length;
                    fileCountElement.textContent = `(共${totalFiles}个文件)`;
                }
                
                // 添加标题
                if (hasImages) {
                    const imageTitle = document.createElement('div');
                    imageTitle.textContent = `图片预览 (${imageContainer.children.length}张)`;
                    imageTitle.style.cssText = `
                        color: #00ffe7;
                        font-weight: 600;
                        margin-bottom: 8px;
                        font-size: 12px;
                        font-family: 'JetBrains Mono', monospace;
                    `;
                    imageContainer.insertBefore(imageTitle, imageContainer.firstChild);
                }
                
                if (hasVideos) {
                    const videoTitle = document.createElement('div');
                    videoTitle.textContent = `视频预览 (${videoContainer.children.length}个)`;
                    videoTitle.style.cssText = `
                        color: #764ba2;
                        font-weight: 600;
                        margin-bottom: 8px;
                        font-size: 12px;
                        font-family: 'JetBrains Mono', monospace;
                    `;
                    videoContainer.insertBefore(videoTitle, videoContainer.firstChild);
                }
                
                if (hasOtherFiles) {
                    const fileTitle = document.createElement('div');
                    fileTitle.textContent = '其他文件';
                    fileTitle.style.cssText = `
                        color: #667eea;
                        font-weight: 600;
                        margin-bottom: 8px;
                        font-size: 12px;
                        font-family: 'JetBrains Mono', monospace;
                    `;
                    fileListContainer.insertBefore(fileTitle, fileListContainer.firstChild);
                }
            }
        }
        
        function hideFilePreview() {
            const previewArea = document.getElementById('filePreviewArea');
            if (previewArea) {
                previewArea.style.display = 'none';
            }
        }
        
        function removeFileFromInput(inputId, removeIndex) {
            const fileInput = document.getElementById(inputId);
            const dt = new DataTransfer();
            const currentFiles = Array.from(fileInput.files);
            
            // 重新创建文件列表，排除要删除的文件
            currentFiles.forEach((file, index) => {
                if (index !== removeIndex) {
                    dt.items.add(file);
                }
            });
            
            fileInput.files = dt.files;
            
            // 更新状态显示
            const fileType = inputId === 'suggestionImages' ? '图片' : '视频';
            const statusElement = document.getElementById(inputId === 'suggestionImages' ? 'imageStatus' : 'videoStatus');
            if (statusElement) {
                if (dt.files.length === 0) {
                    statusElement.textContent = '';
                } else {
                    statusElement.textContent = `已选择 ${dt.files.length} 个${fileType}文件`;
                    statusElement.style.color = '#00ffe7';
                }
            }
            
            // 如果没有文件了，隐藏预览区域
            if (dt.files.length === 0) {
                // 检查是否还有其他文件
                const imageFiles = document.getElementById('suggestionImages').files;
                const videoFiles = document.getElementById('suggestionVideos').files;
                if (imageFiles.length === 0 && videoFiles.length === 0) {
                    hideFilePreview();
                } else {
                    // 重新显示预览
                    showAllFilesPreview();
                }
            } else {
                // 重新显示预览
                showAllFilesPreview();
            }
        }
        
        function updateFileInput(inputId, removeIndex) {
            const fileInput = document.getElementById(inputId);
            const dt = new DataTransfer();
            const currentFiles = Array.from(fileInput.files);
            
            // 重新创建文件列表，排除要删除的文件
            currentFiles.forEach((file, index) => {
                if (index !== removeIndex) {
                    dt.items.add(file);
                }
            });
            
            fileInput.files = dt.files;
            
            // 如果没有文件了，隐藏预览区域
            if (dt.files.length === 0) {
                // 检查是否还有其他文件
                const imageFiles = document.getElementById('suggestionImages').files;
                const videoFiles = document.getElementById('suggestionVideos').files;
                if (imageFiles.length === 0 && videoFiles.length === 0) {
                    hideFilePreview();
                } else {
                    // 重新显示预览
                    showAllFilesPreview();
                }
            } else {
                // 重新显示预览
                showAllFilesPreview();
            }
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // 提交建议
        async function submitSuggestion() {
            // 检查用户是否已登录
            
            showNotification('请先登录后再提交建议', 'warning');
            closeSuggestions();
            // 跳转到登录页面
            setTimeout(() => {
                window.location.href = '/users/login/';
            }, 1500);
            return;
            
            
            const title = document.getElementById('suggestionTitle').value;
            const content = document.getElementById('newSuggestion').value;
            const suggestionType = document.getElementById('suggestionType').value;
            const imageFiles = document.getElementById('suggestionImages').files;
            const videoFiles = document.getElementById('suggestionVideos').files;
            
            if (!title.trim() || !content.trim()) {
                showNotification('请填写建议标题和内容', 'warning');
                return;
            }
            
            try {
                // 先上传文件
                let uploadedImages = [];
                let uploadedVideos = [];
                
                if (imageFiles.length > 0 || videoFiles.length > 0) {
                    const formData = new FormData();
                    
                    // 添加图片文件
                    for (let i = 0; i < imageFiles.length; i++) {
                        formData.append('images', imageFiles[i]);
                    }
                    
                    // 添加视频文件
                    for (let i = 0; i < videoFiles.length; i++) {
                        formData.append('videos', videoFiles[i]);
                    }
                    
                    // 显示上传进度
                    document.getElementById('uploadProgress').style.display = 'block';
                    document.getElementById('progressBar').style.width = '0%';
                    document.getElementById('progressText').textContent = '0%';
                    
                    const uploadResponse = await fetch('/content/api/upload-media/', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const uploadData = await uploadResponse.json();
                    
                    if (uploadData.success) {
                        uploadedImages = uploadData.files.filter(f => f.type === 'image');
                        uploadedVideos = uploadData.files.filter(f => f.type === 'video');
                        showNotification(uploadData.message, 'success');
                        
                        // 显示详细的上传信息
                        if (uploadData.upload_info) {
                            showUploadDetails(uploadData.upload_info);
                        }
                    } else {
                        showNotification('文件上传失败: ' + uploadData.error, 'error');
                        return;
                    }
                    
                    // 隐藏上传进度
                    document.getElementById('uploadProgress').style.display = 'none';
                }
                
                // 提交建议
                const suggestionData = {
                    title: title,
                    content: content,
                    suggestion_type: suggestionType,
                    images: uploadedImages,
                    videos: uploadedVideos
                };
                
                const response = await fetch('/content/api/suggestions/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify(suggestionData)
                });
                
                if (response.status === 401) {
                    // 未登录状态
                    showNotification('请先登录后再提交建议', 'warning');
                    closeSuggestions();
                    setTimeout(() => {
                        window.location.href = '/users/login/';
                    }, 1500);
                    return;
                }
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(data.message, 'success');
                    closeSuggestions();
                    // 刷新建议列表
                    setTimeout(() => {
                        showSuggestions();
                    }, 1000);
                } else {
                    showNotification(data.error || '提交失败，请重试', 'error');
                }
            } catch (error) {
                console.error('提交建议失败:', error);
                showNotification('提交失败，请重试', 'error');
                document.getElementById('uploadProgress').style.display = 'none';
            }
        }
        
        // 显示反馈界面
        function showFeedback() {
            const feedbackHtml = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; max-height: 80vh; overflow-y: auto; width: 90%;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="color: #333; margin: 0;">
                                <i class="fas fa-comment" style="color: #17a2b8;"></i> 意见反馈
                            </h3>
                            <button onclick="closeFeedback()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; color: #333;">反馈类型：</label>
                            <select id="feedbackType" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 15px;">
                                <option value="bug">Bug报告</option>
                                <option value="feature">功能建议</option>
                                <option value="ui">界面改进</option>
                                <option value="other">其他</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; color: #333;">反馈内容：</label>
                            <textarea id="feedbackContent" placeholder="请详细描述您的反馈..." style="width: 100%; height: 120px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical;"></textarea>
                        </div>
                        
                        <div style="text-align: center;">
                            <button onclick="submitFeedback()" style="background: #17a2b8; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                                <i class="fas fa-paper-plane"></i> 提交反馈
                            </button>
                            <button onclick="closeFeedback()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                                关闭
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', feedbackHtml);
        }
        
        // 关闭反馈界面
        function closeFeedback() {
            const feedback = document.querySelector('div[style*="z-index: 10000"]');
            if (feedback) {
                feedback.remove();
            }
        }
        
        // 提交反馈
        function submitFeedback() {
            // 检查用户是否已登录
            
            showNotification('请先登录后再提交反馈', 'warning');
            closeFeedback();
            // 跳转到登录页面
            setTimeout(() => {
                window.location.href = '/users/login/';
            }, 1500);
            return;
            
            
            const type = document.getElementById('feedbackType').value;
            const content = document.getElementById('feedbackContent').value;
            
            if (!content.trim()) {
                showNotification('请输入反馈内容', 'warning');
                return;
            }
            
            const feedbackData = {
                feedback_type: type,
                content: content
            };
            
            fetch('/content/api/feedback/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify(feedbackData)
            })
            .then(response => {
                if (response.status === 401) {
                    // 未登录状态
                    showNotification('请先登录后再提交反馈', 'warning');
                    closeFeedback();
                    setTimeout(() => {
                        window.location.href = '/users/login/';
                    }, 1500);
                    return response.json();
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    showNotification(data.message, 'success');
                    closeFeedback();
                } else {
                    showNotification(data.error || '提交失败，请重试', 'error');
                }
            })
            .catch(error => {
                console.error('提交反馈失败:', error);
                showNotification('提交失败，请重试', 'error');
            });
        }
        
        // 获取CSRF Token
        function getCSRFToken() {
            // 首先尝试从meta标签获取
            const metaToken = document.querySelector('meta[name="csrf-token"]');
            if (metaToken) {
                return metaToken.getAttribute('content');
            }
            
            // 然后尝试从cookie获取
            return getCookie('csrftoken');
        }
        
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        // 主题管理系统
        let currentTheme = 'work';
        
        // 主题配置
        const themeConfig = {
            'life': {
                name: '生活',
                css: 'life.css',
                badgeClass: 'punk',
                subtitle: '享受生活的美好时光'
            },
            'work': {
                name: '极客',
                css: 'geek.css',
                badgeClass: '',
                subtitle: '专注技术，追求卓越'
            },
            'cyberpunk': {
                name: '赛博哥特',
                css: 'cyberpunk.css',
                badgeClass: 'cyberpunk',
                subtitle: '赛博朋克，故障艺术'
            },
            'training': {
                name: '狂暴',
                css: 'rage.css',
                badgeClass: 'rage',
                subtitle: '突破极限，挑战自我'
            },
            'emo': {
                name: 'Emo',
                css: 'emo.css',
                badgeClass: 'emo',
                subtitle: '感受内心的情感波动'
            }
        };
        
        // 页面加载时初始化主题
        document.addEventListener('DOMContentLoaded', async function() {
            await loadUserTheme();
            
                            // 检查当前页面路径，确保主题与页面匹配
                setTimeout(function() {
                    var currentPath = window.location.pathname;
                    var pathToTheme = {
                        '/tools/life_mode/': 'life',
                        '/tools/work/': 'work',
                        '/tools/cyberpunk/': 'cyberpunk',
                        '/tools/training/': 'training',
                        '/tools/emo/': 'emo',
                        '/tools/emo_diary/': 'emo'
                    };
                    
                    var expectedTheme = pathToTheme[currentPath];
                    if (expectedTheme && expectedTheme !== currentTheme && themeConfig[expectedTheme]) {
                        // 如果当前页面路径与主题不匹配，自动切换到对应主题

                        switchGlobalTheme(expectedTheme);
                    }
                }, 100);
        });
        
        // 加载用户主题
        async function loadUserTheme() {
            try {
                const response = await fetch('/users/theme/', {
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                });
                
                if (response.ok) {
                    // 检查响应类型
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        // 如果返回的不是JSON，可能是重定向到登录页面，使用默认主题

                        currentTheme = 'work';
                        applyGlobalTheme(currentTheme);
                        updateThemeBadge(currentTheme);
                        updateActiveThemeItem(currentTheme);
                        return;
                    }
                    
                    const data = await response.json();
                    if (data.success) {
                        currentTheme = data.data.mode || 'work';
                        applyGlobalTheme(currentTheme);
                        updateThemeBadge(currentTheme);
                        updateActiveThemeItem(currentTheme);
                        
                        // 更新副标题
                        const subtitle = document.getElementById('theme-subtitle');
                        if (subtitle && data.data.subtitle) {
                            subtitle.textContent = data.data.subtitle;
                        }
                    }
                }
            } catch (error) {

                // 出错时使用默认主题
                currentTheme = 'work';
                applyGlobalTheme(currentTheme);
                updateThemeBadge(currentTheme);
                updateActiveThemeItem(currentTheme);
            }
        }
        
        // 应用全局主题
        function applyGlobalTheme(theme) {
            const themeCSS = document.getElementById('dynamic-theme-css');
            if (themeCSS) {
                themeCSS.href = '/static/' + themeConfig[theme].css;
            }
            
            // 更新body类名
            document.body.className = theme + '-theme';
            
            // 更新导航栏类名
            updateNavbarTheme(theme);
            
            // 更新副标题
            updateThemeSubtitle(theme);
            
            // 更新背景
            updateThemeBackground(theme);
            
            // 更新页面模板内容
            updatePageTemplate(theme);
        }
        
        // 更新导航栏主题
        function updateNavbarTheme(theme) {
            const navbar = document.querySelector('.navbar');
            if (navbar) {
                // 确保保留unified-navbar类
                if (!navbar.classList.contains('unified-navbar')) {
                    navbar.classList.add('unified-navbar');
                }
                
                // 移除所有主题相关的导航栏类名
                navbar.className = navbar.className.replace(/(geek|life|training|emo|cyberpunk|punk|rage)-navbar/g, '');
                navbar.className = navbar.className.replace(/\s+/g, ' ').trim();
                
                // 重新添加unified-navbar类
                navbar.classList.add('unified-navbar');
                
                // 添加新主题的导航栏类名
                const themeNavbarMap = {
                    'work': 'geek-navbar',
                    'life': 'life-navbar',
                    'training': 'rage-navbar',
                    'emo': 'emo-navbar',
                    'cyberpunk': 'cyber-navbar',
                    'punk': 'punk-navbar'
                };
                
                if (themeNavbarMap[theme]) {
                    navbar.classList.add(themeNavbarMap[theme]);
                }
                
                // 轻量级导航栏优化
                setTimeout(() => {
                    window.safeCall('enhanceNavbar');
                }, 50);
            }
        }
        
        // 更新页面模板内容
        function updatePageTemplate(theme) {
            // 获取当前页面路径
            const currentPath = window.location.pathname;
            
            // 根据当前页面和主题更新模板内容
            if (currentPath.includes('/tools/')) {
                updateToolPageTemplate(theme);
            } else if (currentPath === '/' || currentPath === '/home/') {
                updateHomePageTemplate(theme);
            } else {
                updateGenericPageTemplate(theme);
            }
        }
        
        // 更新工具页面模板
        function updateToolPageTemplate(theme) {
            const toolContainer = document.getElementById('tool-container');
            if (!toolContainer) return;
            
            // 移除所有主题相关的类名
            toolContainer.className = toolContainer.className.replace(/(geek|life|training|emo)-card/g, '');
            
            // 添加新主题的类名
            const themeClassMap = {
                'work': 'geek-card',
                'life': 'life-card', 
                'training': 'training-card',
                'emo': 'emo-card'
            };
            
            if (themeClassMap[theme]) {
                toolContainer.classList.add(themeClassMap[theme]);
            }
            
            // 更新标题
            const toolTitle = document.getElementById('tool-title');
            if (toolTitle) {
                toolTitle.className = toolTitle.className.replace(/(geek|life|training|emo)-title/g, '');
                if (themeClassMap[theme]) {
                    toolTitle.classList.add(themeClassMap[theme].replace('-card', '-title'));
                }
            }
            
            // 更新终端样式
            const terminals = ['tool-terminal', 'life-terminal', 'training-terminal', 'emo-terminal'];
            terminals.forEach(terminalId => {
                const terminal = document.getElementById(terminalId);
                if (terminal) {
                    terminal.className = terminal.className.replace(/(geek|life|training|emo)-terminal/g, '');
                }
            });
            
            // 根据主题显示对应的终端
            const themeTerminalMap = {
                'work': 'tool-terminal',
                'life': 'life-terminal',
                'training': 'training-terminal', 
                'emo': 'emo-terminal'
            };
            
            // 隐藏所有终端
            terminals.forEach(terminalId => {
                const terminal = document.getElementById(terminalId);
                if (terminal) {
                    terminal.style.display = 'none';
                }
            });
            
            // 显示当前主题的终端
            const currentTerminal = document.getElementById(themeTerminalMap[theme]);
            if (currentTerminal) {
                currentTerminal.style.display = 'block';
                currentTerminal.className = currentTerminal.className.replace(/(geek|life|training|emo)-terminal/g, '');
                currentTerminal.classList.add(themeClassMap[theme].replace('-card', '-terminal'));
            }
            
            // 更新工具网格
            const toolGrid = document.getElementById('tool-grid');
            if (toolGrid) {
                toolGrid.className = toolGrid.className.replace(/(geek|life|training|emo)-tool-grid/g, '');
                if (themeClassMap[theme]) {
                    toolGrid.classList.add(themeClassMap[theme].replace('-card', '-tool-grid'));
                }
            }
            
            // 更新页面标题
            updatePageTitle(theme);
        }
        
        // 更新主页模板
        function updateHomePageTemplate(theme) {
            const mainContainer = document.querySelector('.main-container');
            if (!mainContainer) return;
            
            // 更新容器类名
            mainContainer.className = mainContainer.className.replace(/(geek|life|training|emo)-container/g, '');
            const themeClassMap = {
                'work': 'geek-container',
                'life': 'life-container',
                'training': 'training-container',
                'emo': 'emo-container'
            };
            
            if (themeClassMap[theme]) {
                mainContainer.classList.add(themeClassMap[theme]);
            }
            
            // 更新卡片样式
            const cards = document.querySelectorAll('.geek-card, .life-card, .training-card, .emo-card');
            cards.forEach(card => {
                card.className = card.className.replace(/(geek|life|training|emo)-card/g, '');
                if (themeClassMap[theme]) {
                    card.classList.add(themeClassMap[theme].replace('-container', '-card'));
                }
            });
            
            // 更新页面标题
            updatePageTitle(theme);
        }
        
        // 更新通用页面模板
        function updateGenericPageTemplate(theme) {
            // 更新页面标题
            updatePageTitle(theme);
            
            // 更新通用容器样式
            const containers = document.querySelectorAll('.geek-container, .life-container, .training-container, .emo-container');
            containers.forEach(container => {
                container.className = container.className.replace(/(geek|life|training|emo)-container/g, '');
                const themeClassMap = {
                    'work': 'geek-container',
                    'life': 'life-container',
                    'training': 'training-container',
                    'emo': 'emo-container'
                };
                
                if (themeClassMap[theme]) {
                    container.classList.add(themeClassMap[theme]);
                }
            });
        }
        
        // 更新页面标题
        function updatePageTitle(theme) {
            const themeNames = {
                'work': '极客模式',
                'life': '生活模式', 
                'training': '狂暴模式',
                'emo': 'Emo模式'
            };
            
            const currentTitle = document.title;
            const baseTitle = currentTitle.replace(/ - (极客|生活|狂暴|Emo)模式$/, '');
            document.title = `${baseTitle} - ${themeNames[theme]}`;
        }
        
        // 更新主题背景
        function updateThemeBackground(theme) {
            const backgroundLayers = document.querySelectorAll('.background-layer');
            
            // 隐藏所有背景层
            backgroundLayers.forEach(layer => {
                layer.style.display = 'none';
            });
            
            // 显示对应主题的背景
            const targetLayer = document.querySelector(`.${theme}-bg`);
            if (targetLayer) {
                targetLayer.style.display = 'block';
                
                // 初始化特殊背景效果
                if (theme === 'geek') {
                    initMatrixRain();
                } else if (theme === 'emo') {
                    initEmoParticles();
                }
            }
        }
        
        // 矩阵雨效果（极客模式）
        function initMatrixRain() {
            const canvas = document.getElementById('matrix-rain');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            const matrix = "ABCDEFGHIJKLMNOPQRSTUVWXYZ123456789@#$%^&*()*&^%+-/~{[|`]}";
            const matrixArray = matrix.split("");
            
            const fontSize = 10;
            const columns = canvas.width / fontSize;
            const drops = [];
            
            for (let x = 0; x < columns; x++) {
                drops[x] = 1;
            }
            
            function draw() {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.04)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.fillStyle = '#0F0';
                ctx.font = fontSize + 'px monospace';
                
                for (let i = 0; i < drops.length; i++) {
                    const text = matrixArray[Math.floor(Math.random() * matrixArray.length)];
                    ctx.fillText(text, i * fontSize, drops[i] * fontSize);
                    
                    if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
                        drops[i] = 0;
                    }
                    drops[i]++;
                }
            }
            
            setInterval(draw, 35);
        }
        
        // Emo粒子效果
        function initEmoParticles() {
            const container = document.getElementById('emo-particles');
            if (!container) return;
            
            container.innerHTML = '';
            
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.className = 'emo-particle';
                particle.style.cssText = `
                    position: absolute;
                    width: 4px;
                    height: 4px;
                    background: rgba(156, 39, 176, 0.6);
                    border-radius: 50%;
                    animation: emoParticleFloat ${3 + Math.random() * 4}s ease-in-out infinite;
                    animation-delay: ${Math.random() * 2}s;
                    left: ${Math.random() * 100}%;
                    top: ${Math.random() * 100}%;
                `;
                container.appendChild(particle);
            }
        }
        
        // 更新主题徽章
        function updateThemeBadge(theme) {
            const badge = document.getElementById('theme-badge');
            if (badge) {
                const config = themeConfig[theme];
                badge.textContent = config.name;
                badge.className = 'theme-badge ' + config.badgeClass;
            }
        }
        
        // 更新副标题
        function updateThemeSubtitle(theme) {
            const subtitle = document.getElementById('theme-subtitle');
            if (subtitle) {
                const config = themeConfig[theme];
                subtitle.textContent = config.subtitle;
                subtitle.style.opacity = '0';
                setTimeout(() => {
                    subtitle.style.opacity = '0.8';
                }, 200);
            }
        }
        
        // 更新激活的主题项
        function updateActiveThemeItem(theme) {
            document.querySelectorAll('.theme-switch').forEach(item => {
                item.classList.remove('active');
            });
            
            const activeItem = document.querySelector(`[data-mode="${theme}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
            }
        }
        
        // 主题与页面对应关系
        const themePageMapping = {
            'life': '/tools/life_mode/',
'work': '/tools/work_mode/',
'cyberpunk': '/tools/cyberpunk_mode/',
'training': '/tools/training_mode/',
            'emo': '/tools/emo_mode/'
        };
        
        // 获取当前页面路径
        function getCurrentPagePath() {
            return window.location.pathname;
        }
        
        // 检查当前页面是否匹配主题
        function isCurrentPageMatchingTheme(theme) {
            const currentPath = getCurrentPagePath();
            const expectedPath = themePageMapping[theme];
            return currentPath === expectedPath;
        }
        
        // 主题切换事件
        document.addEventListener('click', function(e) {
            if (e.target.closest('.theme-switch')) {
                e.preventDefault();
                const element = e.target.closest('.theme-switch');
                const newTheme = element.dataset.mode;
                
                // 检查当前页面是否已经匹配该主题
                if (isCurrentPageMatchingTheme(newTheme)) {
                    // 如果当前页面已经匹配该主题，只切换主题样式，不跳转页面
                    if (newTheme !== currentTheme && themeConfig[newTheme]) {
                        switchGlobalTheme(newTheme);
                    } else {
                        showNotification('当前页面已经是该主题模式', 'info');
                    }
                } else {
                    // 如果当前页面不匹配该主题，先切换主题，然后跳转到对应页面
                    if (themeConfig[newTheme]) {
                        switchGlobalThemeAndNavigate(newTheme);
                    } else {
                        showNotification('无效的主题参数', 'error');
                    }
                }
            }
        });
        
        // 切换主题并跳转到对应页面
        async function switchGlobalThemeAndNavigate(theme) {
            try {
                // 验证theme参数
                if (!theme || !themeConfig[theme]) {
                    console.error('Invalid theme:', theme);
                    showNotification('无效的主题参数', 'error');
                    return;
                }
                
                // 显示加载状态
                const themeName = themeConfig[theme].name;
                showNotification(`正在切换到${themeName}模式并跳转页面...`, 'info');
                
                // 添加加载动画
                const badge = document.getElementById('theme-badge');
                if (badge) {
                    badge.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                }
                
                // 更新后端
                const response = await fetch('/users/theme/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ mode: theme })
                });
                
                if (!response.ok) {
                    throw new Error('主题切换请求失败');
                }
                
                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error || '主题切换失败');
                }
                
                currentTheme = theme;
                
                // 应用主题
                applyGlobalTheme(theme);
                updateThemeBadge(theme);
                updateActiveThemeItem(theme);
                
                // 切换对应的主题音乐
                loadThemeMusic(theme);
                
                // 显示成功通知
                showNotification(`已成功切换到${themeName}模式`, 'success');
                
                // 延迟跳转到对应页面
                setTimeout(() => {
                    const targetPage = themePageMapping[theme];
                    if (targetPage) {
                        window.location.href = targetPage;
                    }
                }, 1000); // 1秒后跳转，让用户看到切换效果
                
            } catch (error) {
                console.error('Failed to switch theme and navigate:', error);
                showNotification('主题切换失败: ' + error.message, 'error');
                
                // 恢复徽章显示
                updateThemeBadge(currentTheme);
            }
        }
        
        // 切换全局主题
        async function switchGlobalTheme(theme) {
            try {
                // 验证theme参数
                if (!theme || !themeConfig[theme]) {
                    console.error('Invalid theme:', theme);
                    showNotification('无效的主题参数', 'error');
                    return;
                }
                
                // 显示加载状态
                const themeName = themeConfig[theme].name;
                showNotification(`正在切换到${themeName}模式...`, 'info');
                
                // 添加加载动画
                const badge = document.getElementById('theme-badge');
                if (badge) {
                    badge.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                }
                
                // 更新后端
                const response = await fetch('/users/theme/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ mode: theme })
                });
                
                if (!response.ok) {
                    throw new Error('主题切换请求失败');
                }
                
                // 检查响应类型
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    // 如果返回的不是JSON，可能是重定向到登录页面
                    throw new Error('请先登录后再切换主题');
                }
                
                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error || '主题切换失败');
                }
                
                currentTheme = theme;
                
                // 应用主题
                applyGlobalTheme(theme);
                updateThemeBadge(theme);
                updateActiveThemeItem(theme);
                
                // 切换对应的主题音乐
                loadThemeMusic(theme);
                
                // 显示成功通知
                showNotification(`已成功切换到${themeName}模式`, 'success');
                
                // 添加切换动画效果
                document.body.style.transition = 'all 0.5s ease';
                document.body.style.transform = 'scale(0.98)';
                setTimeout(() => {
                    document.body.style.transform = 'scale(1)';
                }, 200);
                
                // 主题切换完成，无需刷新页面
                
            } catch (error) {
                console.error('Failed to switch theme:', error);
                showNotification('主题切换失败: ' + error.message, 'error');
                
                // 恢复徽章显示
                updateThemeBadge(currentTheme);
            }
        }
        
        // 带页面跳转的主题切换函数
        async function switchGlobalThemeWithRefresh(theme) {
            try {
                // 验证theme参数
                if (!theme || !themeConfig[theme]) {
                    console.error('Invalid theme:', theme);
                    showNotification('无效的主题参数', 'error');
                    return;
                }
                
                // 显示加载状态
                const themeName = themeConfig[theme].name;
                showNotification(`正在切换到${themeName}模式，即将跳转到对应页面...`, 'info');
                
                // 添加加载动画
                const badge = document.getElementById('theme-badge');
                if (badge) {
                    badge.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                }
                
                // 更新后端
                const response = await fetch('/users/theme/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ mode: theme })
                });
                
                if (!response.ok) {
                    throw new Error('主题切换请求失败');
                }
                
                // 检查响应类型
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    // 如果返回的不是JSON，可能是重定向到登录页面
                    throw new Error('请先登录后再切换主题');
                }
                
                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error || '主题切换失败');
                }
                
                // 主题切换成功，跳转到对应mode的主页面
                setTimeout(() => {
                        const themePages = {
      'life': '/tools/life_mode/',
      'work': '/tools/work_mode/',
      'training': '/tools/training_mode/',
      'emo': '/tools/emo_mode/'
    };
                    const targetPage = themePages[theme] || '/';
                    window.location.href = targetPage;
                }, 800); // 延迟800ms让用户看到成功提示
                
            } catch (error) {
                console.error('Failed to switch theme:', error);
                showNotification('主题切换失败: ' + error.message, 'error');
                
                // 恢复徽章显示
                updateThemeBadge(currentTheme);
            }
        }
        
        // 跳转到当前mode的工具页面
        function goToCurrentModeTools() {
            
                // 用户未登录，跳转到登录页面
                window.location.href = '/users/login/';
            
        }
        
        // 音乐相关函数
        async function loadThemeMusic(theme) {
            try {
                const response = await fetch(`/tools/api/music/?mode=${theme}&action=random`);
                const data = await response.json();
                
                if (data.success && data.data && data.data.play_url) {
                    currentSong = data.data;
                    const audio = document.getElementById('theme-music');
                    const source = document.getElementById('music-source');
                    
                    if (audio && source) {
                        source.src = currentSong.play_url;
                        audio.load();
                        
                        // 更新音乐信息显示
                        if (typeof updateMusicInfo === 'function') {
                            updateMusicInfo();
                        }
                        
                        // 如果之前正在播放，继续播放
                        if (isMusicPlaying) {
                            audio.play();
                        }
                    }
                } else {

                }
            } catch (error) {
                console.error('加载主题音乐失败:', error);
            }
        }
        
        function toggleMusic() {
            const audio = document.getElementById('theme-music');
            
            if (audio.paused) {
                audio.play();
                isMusicPlaying = true;
                document.getElementById('music-play-icon').className = 'fas fa-pause';
            } else {
                audio.pause();
                isMusicPlaying = false;
                document.getElementById('music-play-icon').className = 'fas fa-play';
            }
        }
        
        async function nextSong() {
            try {
                const response = await fetch('/tools/api/next_song/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ mode: currentTheme })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentSong = data.next_song;
                    const audio = document.getElementById('theme-music');
                    const source = document.getElementById('music-source');
                    
                    source.src = currentSong.url;
                    audio.load();
                    
                    // 更新音乐信息显示
                    updateMusicInfo();
                    
                    // 如果之前正在播放，继续播放
                    if (isMusicPlaying) {
                        audio.play();
                    }
                    
                    showNotification('已切换到下一首歌曲', 'success');
                }
            } catch (error) {
                console.error('切换歌曲失败:', error);
                showNotification('切换歌曲失败', 'error');
            }
        }
        
        function updateMusicInfo() {
            if (currentSong) {
                document.getElementById('music-title').textContent = currentSong.title || currentSong.name;
                document.getElementById('music-artist').textContent = currentSong.artist;
                
                const coverImg = document.getElementById('music-cover-img');
                if (currentSong.pic_url) {
                    coverImg.src = currentSong.pic_url;
                    coverImg.style.display = 'block';
                } else {
                    coverImg.style.display = 'none';
                }
            }
        }
        
        function toggleMusicInfo() {
            const musicInfo = document.getElementById('music-info');
            musicInfoVisible = !musicInfoVisible;
            
            if (musicInfoVisible) {
                musicInfo.style.display = 'block';
                updateMusicInfo();
            } else {
                musicInfo.style.display = 'none';
            }
        }
        
        // 页面加载时初始化音乐
        document.addEventListener('DOMContentLoaded', function() {
            // 隐藏页面加载动画
            setTimeout(() => {
                const loader = document.getElementById('pageLoader');
                if (loader) {
                    loader.style.opacity = '0';
                    setTimeout(() => {
                        loader.style.display = 'none';
                    }, 500);
                }
            }, 1000);

            // 初始化粒子效果
            initParticles();

            // 初始化鼠标跟随效果
            initCursorFollower();

            // 初始化音乐播放器
            const audio = document.getElementById('theme-music');
            
            audio.addEventListener('play', function() {
                isMusicPlaying = true;
                document.getElementById('music-play-icon').className = 'fas fa-pause';
            });
            
            audio.addEventListener('pause', function() {
                isMusicPlaying = false;
                document.getElementById('music-play-icon').className = 'fas fa-play';
            });
            
            audio.addEventListener('ended', function() {
                // 歌曲播放结束后自动下一首
                nextSong();
            });
            
            // 加载当前主题的音乐
            loadThemeMusic(currentTheme);
            
                    // 初始化主题切换快捷键
        initThemeShortcuts();
        
        // 初始化头像编辑功能
        initAvatarEdit();
        
        // 初始化语言切换功能
        initLanguageSwitch();
    });
        // 初始化粒子效果
        function initParticles() {
            const particlesContainer = document.getElementById('particles');
            if (!particlesContainer) return;

            const particleCount = 50;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 8 + 's';
                particle.style.animationDuration = (Math.random() * 4 + 4) + 's';
                particlesContainer.appendChild(particle);
            }
        }

        // 初始化动态鼠标光标效果
        function initCursorFollower() {
            const cursor = document.getElementById('customCursor');
            if (!cursor) return;

            let mouseX = 0;
            let mouseY = 0;
            let cursorX = 0;
            let cursorY = 0;
            let isVisible = false;

            // 鼠标进入页面时显示光标
            document.addEventListener('mouseenter', () => {
                isVisible = true;
                cursor.style.opacity = '1';
            });

            // 鼠标离开页面时隐藏光标
            document.addEventListener('mouseleave', () => {
                isVisible = false;
                cursor.style.opacity = '0';
            });

            document.addEventListener('mousemove', (e) => {
                mouseX = e.clientX;
                mouseY = e.clientY;
                
                if (!isVisible) {
                    isVisible = true;
                    cursor.style.opacity = '1';
                }
            });

            document.addEventListener('mousedown', () => {
                cursor.classList.add('active');
            });

            document.addEventListener('mouseup', () => {
                cursor.classList.remove('active');
            });

            // 为链接和按钮添加悬停效果
            const interactiveElements = document.querySelectorAll('a, button, .nav-link, .btn, .dropdown-item');
            interactiveElements.forEach(element => {
                element.addEventListener('mouseenter', () => {
                    cursor.classList.add('hover');
                });
                
                element.addEventListener('mouseleave', () => {
                    cursor.classList.remove('hover');
                });
            });

            // 平滑跟随动画
            function animateCursor() {
                if (isVisible) {
                    cursorX += (mouseX - cursorX) * 0.15;
                    cursorY += (mouseY - cursorY) * 0.15;
                    
                    cursor.style.left = cursorX + 'px';
                    cursor.style.top = cursorY + 'px';
                }
                
                requestAnimationFrame(animateCursor);
            }
            
            animateCursor();
        }
        
        // 主题切换快捷键
        function initThemeShortcuts() {
            document.addEventListener('keydown', function(e) {
                // 只在非输入框中响应快捷键
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    return;
                }
                
                // Ctrl/Cmd + 数字键切换主题
                if ((e.ctrlKey || e.metaKey) && !e.shiftKey && !e.altKey) {
                    switch(e.key) {
                        case '1':
                            e.preventDefault();
                            
                                showNotification('请先登录后再使用快捷键切换主题', 'warning');
                            
                            break;
                        case '2':
                            e.preventDefault();
                            
                                showNotification('请先登录后再使用快捷键切换主题', 'warning');
                            
                            break;
                        case '3':
                            e.preventDefault();
                            
                                showNotification('请先登录后再使用快捷键切换主题', 'warning');
                            
                            break;
                        case '4':
                            e.preventDefault();
                            
                                showNotification('请先登录后再使用快捷键切换主题', 'warning');
                            
                            break;
                    }
                }
            });
        }
        
        // 头像编辑功能
        function editAvatar() {
            // 创建文件输入元素
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.style.display = 'none';
            
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    uploadAvatar(file);
                }
            });
            
            document.body.appendChild(fileInput);
            fileInput.click();
            document.body.removeChild(fileInput);
        }
        
        // 上传头像
        function uploadAvatar(file) {
            const formData = new FormData();
            formData.append('avatar', file);
            formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
            
            // 显示上传进度
            showUploadProgress();
            
            fetch('/users/upload_avatar/', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                hideUploadProgress();
                if (data.success) {
                    // 更新页面上的头像显示
                    updateAvatarDisplay(data.avatar_url);
                    showMessage('头像上传成功！', 'success');
                } else {
                    showMessage(data.message || '头像上传失败', 'error');
                }
            })
            .catch(error => {
                hideUploadProgress();
                console.error('Upload error:', error);
                showMessage('头像上传失败，请重试', 'error');
            });
        }
        
        // 显示上传进度
        function showUploadProgress() {
            const progress = document.createElement('div');
            progress.id = 'upload-progress';
            progress.innerHTML = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                     background: rgba(0,0,0,0.9); color: white; padding: 20px; border-radius: 10px; 
                     z-index: 9999; text-align: center;">
                    <i class="fas fa-spinner fa-spin"></i>
                    <div style="margin-top: 10px;">正在上传头像...</div>
                </div>
            `;
            document.body.appendChild(progress);
        }
        
        // 隐藏上传进度
        function hideUploadProgress() {
            const progress = document.getElementById('upload-progress');
            if (progress) {
                document.body.removeChild(progress);
            }
        }
        
        // 更新头像显示
        function updateAvatarDisplay(avatarUrl) {
            // 更新导航栏中的头像
            const navAvatar = document.getElementById('user-avatar');
            if (navAvatar) {
                navAvatar.src = avatarUrl;
            }
            
            // 更新所有带有user-avatar类的头像
            const avatarElements = document.querySelectorAll('.user-avatar');
            avatarElements.forEach(element => {
                element.src = avatarUrl;
            });
            
            // 更新个人资料页面的头像（如果存在）
            const profileAvatar = document.getElementById('profile-avatar');
            if (profileAvatar) {
                profileAvatar.src = avatarUrl;
            }
        }
        
        // 显示消息提示
        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed; top: 20px; right: 20px; 
                background: ${type === 'success' ? '#28a745' : '#dc3545'}; 
                color: white; padding: 15px 20px; border-radius: 5px; 
                z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    document.body.removeChild(messageDiv);
                }
            }, 3000);
        }
        
        // 初始化头像编辑功能
        function initAvatarEdit() {
            const editAvatarBtn = document.getElementById('edit-avatar-btn');
            if (editAvatarBtn) {
                editAvatarBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    editAvatar();
                });
            }
        }
        
        // 初始化语言切换功能
        function initLanguageSwitch() {
            const languageSwitches = document.querySelectorAll('.language-switch');
            
            languageSwitches.forEach(switch_ => {
                switch_.addEventListener('click', function(e) {
                    e.preventDefault();
                    const lang = this.getAttribute('data-lang');
                    switchLanguage(lang);
                });
            });
            
            // 从localStorage加载保存的语言设置
            const savedLang = localStorage.getItem('preferred-language') || 'zh';
            switchLanguage(savedLang, false); // false表示不保存到localStorage
        }
        
        // 语言切换函数
        function switchLanguage(lang, saveToStorage = true) {
            // 更新指示器显示
            document.querySelectorAll('.language-indicator').forEach(indicator => {
                indicator.style.display = 'none';
            });
            
            if (lang === 'zh') {
                document.getElementById('zh-indicator').style.display = 'inline';
                translateToChinese();
            } else if (lang === 'en') {
                document.getElementById('en-indicator').style.display = 'inline';
                translateToEnglish();
            }
            
            // 保存语言设置到localStorage
            if (saveToStorage) {
                localStorage.setItem('preferred-language', lang);
            }
        }
        
        // 翻译为中文
        function translateToChinese() {
            const translations = {
                // 导航栏
                'QATOOLBOX': 'ModeShift',
                '专注技术，追求卓越': '专注技术，追求卓越',
                '工具集': '工具集',
                '我的建议': '我的建议',
                '关于': '关于',
                '管理控制台': '管理控制台',
                '仪表板': '仪表板',
                '公告管理': '公告管理',
                '建议管理': '建议管理',
                '反馈管理': '反馈管理',
                '用户管理': '用户管理',
                '用户监控': '用户监控',
                '操作日志': '操作日志',
                '编辑头像': '编辑头像',
                '个人资料': '个人资料',
                '界面模式': '界面模式',

                '生活模式': '生活模式',
                '极客模式': '极客模式',
                '狂暴模式': '狂暴模式',
                'Emo模式': 'Emo模式',
                '快速管理': '快速管理',
                '登出': '登出',
                '登录': '登录',
                '注册': '注册',
                
                // 设置菜单
                '音乐控制': '音乐控制',
                '播放/暂停音乐': '播放/暂停音乐',
                '下一首歌曲': '下一首歌曲',
                '显示/隐藏音乐信息': '显示/隐藏音乐信息',
                '系统设置': '系统设置',
                '意见反馈': '意见反馈',
                '语言设置': '语言设置',
                
                // 主页内容
                '工具箱': '工具箱',
                '君子生非异也，善假于物也。': '君子生非异也，善假于物也。',
                '工欲善其事，必先利其器。': '工欲善其事，必先利其器。',
                '学而时习之，不亦说乎。': '学而时习之，不亦说乎。',
                '知之者不如好之者，好之者不如乐之者。': '知之者不如好之者，好之者不如乐之者。',
                '进入外世界': '进入外世界'
            };
            
            applyTranslations(translations);
        }
        
        // 翻译为英文
        function translateToEnglish() {
            const translations = {
                // 导航栏
                'QATOOLBOX': 'ModeShift',
                '专注技术，追求卓越': 'Focus on Technology, Pursue Excellence',
                '工具集': 'Tools',
                '我的建议': 'My Suggestions',
                '关于': 'About',
                '管理控制台': 'Admin Console',
                '仪表板': 'Dashboard',
                '公告管理': 'Announcements',
                '建议管理': 'Suggestions',
                '反馈管理': 'Feedback',
                '用户管理': 'User Management',
                '用户监控': 'User Monitoring',
                '操作日志': 'Operation Logs',
                '编辑头像': 'Edit Avatar',
                '个人资料': 'Profile',
                '界面模式': 'Interface Mode',

                '生活模式': 'Life Mode',
                '极客模式': 'Geek Mode',
                '狂暴模式': 'Rage Mode',
                'Emo模式': 'Emo Mode',
                '快速管理': 'Quick Admin',
                '登出': 'Logout',
                '登录': 'Login',
                '注册': 'Register',
                
                // 设置菜单
                '音乐控制': 'Music Control',
                '播放/暂停音乐': 'Play/Pause Music',
                '下一首歌曲': 'Next Song',
                '显示/隐藏音乐信息': 'Show/Hide Music Info',
                '系统设置': 'System Settings',
                '意见反馈': 'Feedback',
                '语言设置': 'Language Settings',
                
                // 主页内容
                '工具箱': 'Toolbox',
                '君子生非异也，善假于物也。': 'A gentleman is not different by nature, but good at using tools.',
                '工欲善其事，必先利其器。': 'To do a good job, one must first sharpen one\'s tools.',
                '学而时习之，不亦说乎。': 'Is it not pleasant to learn and practice what you have learned?',
                '知之者不如好之者，好之者不如乐之者。': 'Those who know are not as good as those who love, and those who love are not as good as those who enjoy.',
                '进入外世界': 'Enter Outer World'
            };
            
            applyTranslations(translations);
        }
        
        // 应用翻译
        function applyTranslations(translations) {
            // 遍历所有文本节点
            function walkTextNodes(node) {
                if (node.nodeType === Node.TEXT_NODE) {
                    const text = node.textContent.trim();
                    if (translations[text]) {
                        node.textContent = translations[text];
                    }
                } else {
                    for (let child of node.childNodes) {
                        walkTextNodes(child);
                    }
                }
            }
            
            // 从body开始遍历
            walkTextNodes(document.body);
            
            // 特殊处理一些元素
            const elements = document.querySelectorAll('[data-translate]');
            elements.forEach(element => {
                const key = element.getAttribute('data-translate');
                if (translations[key]) {
                    element.textContent = translations[key];
                }
            });
        }
        
        // 获取CSRF Token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // 头像点击功能 - 查看头像和里世界入口
        document.addEventListener('DOMContentLoaded', function() {
            const userAvatar = document.getElementById('user-avatar');
            if (userAvatar) {
                let clickCount = 0;
                let clickTimer = null;
                let avatarPopup = null;
                
                userAvatar.addEventListener('click', function(e) {
                    // 阻止事件冒泡，避免触发下拉菜单
                    e.stopPropagation();
                    
                    clickCount++;
                    
                    // 清除之前的定时器
                    if (clickTimer) {
                        clearTimeout(clickTimer);
                    }
                    
                    // 设置3秒后重置点击计数
                    clickTimer = setTimeout(() => {
                        clickCount = 0;
                    }, 3000);
                    
                    // 点击反馈效果
                    this.style.transform = 'scale(1.1)';
                    setTimeout(() => {
                        this.style.transform = 'scale(1)';
                    }, 200);
                    
                    // 第一次点击显示头像弹窗
                    if (clickCount === 1) {
                        showAvatarPopup(this.src, e);
                    }
                    // 第二十次点击进入里世界
                    else if (clickCount === 20) {
                        // 重置计数
                        clickCount = 0;
                        clearTimeout(clickTimer);
                        
                        // 显示进入里世界的动画效果
                        this.style.animation = 'glitch 0.5s infinite';
                        this.style.filter = 'hue-rotate(180deg) brightness(1.5)';
                        
                        setTimeout(() => {
                            // 跳转到里世界页面
                            window.location.href = '/tools/vanity_os/';
                        }, 1000);
                    }
                });
                
                // 显示头像弹窗
                function showAvatarPopup(avatarSrc, event) {
                    // 移除之前的弹窗
                    if (avatarPopup) {
                        document.body.removeChild(avatarPopup);
                    }
                    
                    // 创建弹窗
                    avatarPopup = document.createElement('div');
                    avatarPopup.className = 'avatar-popup';
                    avatarPopup.innerHTML = `<img src="${avatarSrc}" alt="头像">`;
                    
                    // 设置弹窗位置（在点击位置附近）
                    const rect = event.target.getBoundingClientRect();
                    avatarPopup.style.left = (rect.left + rect.width + 10) + 'px';
                    avatarPopup.style.top = (rect.top - 50) + 'px';
                    
                    // 添加到页面
                    document.body.appendChild(avatarPopup);
                    
                    // 3秒后自动消失
                    setTimeout(() => {
                        if (avatarPopup && avatarPopup.parentNode) {
                            avatarPopup.parentNode.removeChild(avatarPopup);
                            avatarPopup = null;
                        }
                    }, 3000);
                }
                
                // 点击其他地方关闭弹窗
                document.addEventListener('click', function(e) {
                    if (avatarPopup && !avatarPopup.contains(e.target) && e.target !== userAvatar) {
                        avatarPopup.parentNode.removeChild(avatarPopup);
                        avatarPopup = null;
                    }
                });
            }
        });
        
        // 改进的文件上传样式
        
        // 赛博哥特故障艺术切换功能
        document.addEventListener('DOMContentLoaded', function() {
            let glitchLevel = 0;
            let glitchTimer = null;
            
            // 监听页面点击事件
            document.addEventListener('click', function(e) {
                // 如果当前是赛博哥特主题，才启用故障艺术切换
                if (document.body.classList.contains('cyberpunk-theme')) {
                    // 排除一些不需要触发故障艺术切换的元素
                    if (e.target.closest('.nav-link') || 
                        e.target.closest('.dropdown-menu') || 
                        e.target.closest('.btn') ||
                        e.target.closest('.form-control') ||
                        e.target.closest('.theme-switch')) {
                        return;
                    }
                    
                    // 清除之前的定时器
                    if (glitchTimer) {
                        clearTimeout(glitchTimer);
                    }
                    
                    // 增加故障等级
                    glitchLevel = (glitchLevel + 1) % 4; // 0, 1, 2, 3
                    
                    // 移除所有故障等级类
                    document.body.classList.remove('glitch-level-1', 'glitch-level-2', 'glitch-level-3');
                    
                    // 添加新的故障等级类
                    if (glitchLevel > 0) {
                        document.body.classList.add('glitch-level-' + glitchLevel);
                        
                        // 添加故障音效（可选）
                        playGlitchSound(glitchLevel);
                    }
                    
                    // 设置5秒后自动重置故障等级
                    glitchTimer = setTimeout(() => {
                        glitchLevel = 0;
                        document.body.classList.remove('glitch-level-1', 'glitch-level-2', 'glitch-level-3');
                    }, 5000);
                }
            });
            
            // 故障音效函数（可选）
            function playGlitchSound(level) {
                // 这里可以添加故障音效
                // 由于浏览器限制，需要用户交互才能播放音频

            }
            
            // 主题切换时重置故障等级
            const originalApplyGlobalTheme = window.applyGlobalTheme;
            window.applyGlobalTheme = function(theme) {
                if (originalApplyGlobalTheme) {
                    originalApplyGlobalTheme(theme);
                }
                
                // 如果切换到非赛博哥特主题，重置故障等级
                if (!document.body.classList.contains('cyberpunk-theme')) {
                    glitchLevel = 0;
                    document.body.classList.remove('glitch-level-1', 'glitch-level-2', 'glitch-level-3');
                }
            };
        });
        // 导航栏优化功能
        document.addEventListener('DOMContentLoaded', function() {
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const sidebarBackdrop = document.getElementById('sidebarBackdrop');
            const navbar = document.querySelector('.navbar-collapse');
            const navbarElement = document.querySelector('.navbar');
            
            // 导航栏滚动效果
            function handleNavbarScroll() {
                if (window.scrollY > 50) {
                    navbarElement.classList.add('scrolled');
                } else {
                    navbarElement.classList.remove('scrolled');
                }
            }
            
            // 监听滚动事件
            window.addEventListener('scroll', handleNavbarScroll);
            
            // 导航链接激活状态
            function setActiveNavLink() {
                const currentPath = window.location.pathname;
                const navLinks = document.querySelectorAll('.nav-link');
                
                navLinks.forEach(link => {
                    link.classList.remove('active');
                    if (link.getAttribute('href') === currentPath || 
                        (currentPath === '/' && link.getAttribute('href') === '/')) {
                        link.classList.add('active');
                    }
                });
            }
            
            // 设置当前页面激活状态
            setActiveNavLink();
            
            // 初始化Bootstrap下拉菜单
            function initBootstrapDropdowns() {
                if (typeof window.$ !== 'undefined') {
                    // 让Bootstrap处理下拉菜单
                    $('.dropdown-toggle').dropdown();
                    
                    // 确保dropdown事件正常工作
                    $('.dropdown-toggle').on('click', function(e) {
                        e.stopPropagation();
                        const $dropdown = $(this).closest('.dropdown');
                        
                        // 关闭其他下拉菜单
                        $('.dropdown').not($dropdown).removeClass('show').find('.dropdown-menu').removeClass('show');
                        
                        // 切换当前下拉菜单
                        $dropdown.toggleClass('show');
                        $dropdown.find('.dropdown-menu').toggleClass('show');
                    });
                } else {

                }
            }
            
            // DOM内容加载完成后初始化
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initBootstrapDropdowns);
            } else {
                initBootstrapDropdowns();
            }
            
            // 如果Bootstrap不可用，使用备用方案
            if (typeof window.bootstrap === 'undefined' && typeof window.$ === 'undefined') {
                const dropdowns = document.querySelectorAll('.dropdown');
                dropdowns.forEach(dropdown => {
                    const toggle = dropdown.querySelector('.dropdown-toggle');
                    const menu = dropdown.querySelector('.dropdown-menu');
                    
                    if (toggle && menu) {
                        toggle.addEventListener('click', (e) => {
                            e.stopPropagation();
                            
                            // 关闭其他下拉菜单
                            dropdowns.forEach(otherDropdown => {
                                if (otherDropdown !== dropdown) {
                                    otherDropdown.classList.remove('show');
                                    const otherMenu = otherDropdown.querySelector('.dropdown-menu');
                                    if (otherMenu) otherMenu.classList.remove('show');
                                }
                            });
                            
                            // 切换当前下拉菜单
                            dropdown.classList.toggle('show');
                            menu.classList.toggle('show');
                        });
                    }
                });
                
                // 点击外部关闭下拉菜单
                document.addEventListener('click', () => {
                    dropdowns.forEach(dropdown => {
                        dropdown.classList.remove('show');
                        const menu = dropdown.querySelector('.dropdown-menu');
                        if (menu) menu.classList.remove('show');
                    });
                });
            }
            
            if (mobileMenuBtn && navbar) {
                // 移动端菜单按钮点击事件
                mobileMenuBtn.addEventListener('click', function() {
                    navbar.classList.toggle('show');
                    sidebarBackdrop.classList.toggle('show');
                    document.body.style.overflow = navbar.classList.contains('show') ? 'hidden' : '';
                    
                    // 添加按钮动画
                    const icon = mobileMenuBtn.querySelector('i');
                    if (icon) {
                        icon.style.transform = navbar.classList.contains('show') ? 'rotate(90deg)' : 'rotate(0deg)';
                    }
                });
                
                // 背景点击关闭菜单
                sidebarBackdrop.addEventListener('click', function() {
                    navbar.classList.remove('show');
                    sidebarBackdrop.classList.remove('show');
                    document.body.style.overflow = '';
                    
                    // 重置按钮动画
                    const icon = mobileMenuBtn.querySelector('i');
                    if (icon) {
                        icon.style.transform = 'rotate(0deg)';
                    }
                });
                
                // 菜单项点击后关闭菜单
                const navLinks = navbar.querySelectorAll('.nav-link');
                navLinks.forEach(link => {
                    link.addEventListener('click', function() {
                        if (window.innerWidth <= 768) {
                            navbar.classList.remove('show');
                            sidebarBackdrop.classList.remove('show');
                            document.body.style.overflow = '';
                            
                            // 重置按钮动画
                            const icon = mobileMenuBtn.querySelector('i');
                            if (icon) {
                                icon.style.transform = 'rotate(0deg)';
                            }
                        }
                    });
                });
                
                // 窗口大小改变时处理菜单状态
                window.addEventListener('resize', function() {
                    if (window.innerWidth > 768) {
                        navbar.classList.remove('show');
                        sidebarBackdrop.classList.remove('show');
                        document.body.style.overflow = '';
                        
                        // 重置按钮动画
                        const icon = mobileMenuBtn.querySelector('i');
                        if (icon) {
                            icon.style.transform = 'rotate(0deg)';
                        }
                    }
                });
            }
            
            // 键盘快捷键支持
            document.addEventListener('keydown', function(e) {
                // ESC键关闭移动端菜单
                if (e.key === 'Escape' && navbar && navbar.classList.contains('show')) {
                    navbar.classList.remove('show');
                    sidebarBackdrop.classList.remove('show');
                    document.body.style.overflow = '';
                }
                
                // Ctrl+M 切换移动端菜单
                if (e.ctrlKey && e.key === 'm' && mobileMenuBtn) {
                    e.preventDefault();
                    mobileMenuBtn.click();
                }
            });
        });
    </script>
    
    <!-- WebSocket连接修复脚本 -->
    <script>
    // WebSocket连接修复脚本
    // 解决WebSocket连接到错误端口的问题
    (function() {
        'use strict';

        // 创建URL修复函数
        function fixWebSocketUrl(url) {
            if (url && typeof url === 'string') {
                // 如果URL包含8001端口，替换为8000端口
                if (url.includes('localhost:8001') || url.includes('127.0.0.1:8001')) {
                    const fixedUrl = url.replace(/localhost:8001|127\.0\.0\.1:8001/g, 'localhost:8000');

                    return fixedUrl;
                }
                
                // 如果URL包含8001端口但没有localhost，也进行修复
                if (url.includes(':8001/')) {
                    const fixedUrl = url.replace(/:8001\//g, ':8000/');

                    return fixedUrl;
                }
            }
            return url;
        }
        
        // 保存原始的WebSocket构造函数
        const OriginalWebSocket = window.WebSocket;
        
        // 创建新的WebSocket构造函数
        function FixedWebSocket(url, protocols) {

            // 修复URL
            const fixedUrl = fixWebSocketUrl(url);
            
            // 创建WebSocket连接
            const ws = new OriginalWebSocket(fixedUrl, protocols);
            
            // 添加连接状态日志
            ws.addEventListener('open', function(event) {

            });
            
            ws.addEventListener('error', function(error) {
                console.error('❌ WebSocket连接错误:', fixedUrl, error);
            });
            
            ws.addEventListener('close', function(event) {

            });
            
            return ws;
        }
        
        // 设置原型链
        FixedWebSocket.prototype = OriginalWebSocket.prototype;
        
        // 复制静态属性（只读属性，使用Object.defineProperty）
        Object.defineProperty(FixedWebSocket, 'CONNECTING', {
            value: OriginalWebSocket.CONNECTING,
            writable: false,
            enumerable: true,
            configurable: false
        });
        
        Object.defineProperty(FixedWebSocket, 'OPEN', {
            value: OriginalWebSocket.OPEN,
            writable: false,
            enumerable: true,
            configurable: false
        });
        
        Object.defineProperty(FixedWebSocket, 'CLOSING', {
            value: OriginalWebSocket.CLOSING,
            writable: false,
            enumerable: true,
            configurable: false
        });
        
        Object.defineProperty(FixedWebSocket, 'CLOSED', {
            value: OriginalWebSocket.CLOSED,
            writable: false,
            enumerable: true,
            configurable: false
        });
        
        // 替换全局WebSocket
        window.WebSocket = FixedWebSocket;

        // forceApplyNavbarStyles 函数已在文件开头定义，这里删除重复定义
        
        // 页面加载完成后优化导航栏
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => window.safeCall('enhanceNavbar'), 100);
            setTimeout(() => window.safeCall('enhanceNavbar'), 500);
            
            // 控制首页菜单显示
            window.safeCall('controlHomePageNavbar');
        });

        // controlHomePageNavbar 函数已在文件开头定义，删除重复定义
        
        // 监听主题切换事件，优化导航栏
        document.addEventListener('themeChanged', function() {
            setTimeout(() => window.safeCall('enhanceNavbar'), 100);
            setTimeout(() => window.safeCall('enhanceNavbar'), 500);
            setTimeout(() => window.safeCall('controlHomePageNavbar'), 100);
        });
        
        // 监听窗口加载完成事件
        window.addEventListener('load', function() {
            setTimeout(() => window.safeCall('enhanceNavbar'), 100);
            setTimeout(() => window.safeCall('enhanceNavbar'), 500);
            setTimeout(() => window.safeCall('controlHomePageNavbar'), 100);
        });
        
        // 定期检查并优化导航栏（轻量级）
        setInterval(function() {
            const navbar = document.querySelector('.navbar');
            if (navbar && !navbar.classList.contains('unified-navbar')) {
                window.safeCall('enhanceNavbar');
            }
        }, 5000);
        
        // 顶部UI和container-fluid控制
        function initTopUIControl() {
            const topUiBar = document.getElementById('topUiBar');
            const containers = document.querySelectorAll('.container-fluid');
            
            // 顶部UI始终显示，不需要自动隐藏
            if (topUiBar) {
                topUiBar.style.opacity = '1';
                topUiBar.style.transform = 'translateY(0)';
            }
            
            // container-fluid悬停显示
            containers.forEach(container => {
                container.addEventListener('mouseenter', function() {
                    this.classList.add('show');
                });
                
                container.addEventListener('mouseleave', function() {
                    this.classList.remove('show');
                });
            });
            
            // 菜单按钮悬浮显示控制
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            let menuBtnTimeout;
            
            // 鼠标进入页面顶部区域时显示菜单按钮
            document.addEventListener('mouseenter', function(e) {
                if (e.clientY <= 80) {
                    mobileMenuBtn.classList.add('show');
                    clearTimeout(menuBtnTimeout);
                }
            });
            
            // 鼠标离开页面顶部区域时隐藏菜单按钮
            document.addEventListener('mouseleave', function(e) {
                if (e.clientY <= 0) {
                    menuBtnTimeout = setTimeout(() => {
                        mobileMenuBtn.classList.remove('show');
                    }, 1500);
                }
            });
            
            // 鼠标在菜单按钮上时保持显示
            if (mobileMenuBtn) {
                mobileMenuBtn.addEventListener('mouseenter', function() {
                    this.classList.add('show');
                    clearTimeout(menuBtnTimeout);
                });
                
                mobileMenuBtn.addEventListener('mouseleave', function() {
                    menuBtnTimeout = setTimeout(() => {
                        this.classList.remove('show');
                    }, 1000);
                });
            }
            
            // 更新顶部UI徽章
            function updateTopUIBadge() {
                const badge = document.getElementById('topUiBadge');
                const currentMode = localStorage.getItem('currentMode') || 'work';
                const modeNames = {
                    'work': '极客',
                    'life': '生活',
                    'training': '狂暴',
                    'emo': 'Emo'
                };
                if (badge) {
                    badge.textContent = modeNames[currentMode] || '极客';
                }
            }
            
            // 初始化徽章
            updateTopUIBadge();
            
            // 监听主题切换事件
            document.addEventListener('themeChanged', updateTopUIBadge);
            
            // 彩蛋和下拉刷新功能
            function initEasterEggsAndPullRefresh() {
                let startY = 0;
                let currentY = 0;
                let isPulling = false;
                let pullDistance = 0;
                let userInput = '';
                let inputTimeout;
                const pullRefreshIndicator = document.getElementById('pullRefreshIndicator');
                const mobileMenuBtn = document.getElementById('mobileMenuBtn');
                
                // 下拉/上拉彩蛋
                function createEasterEggParticles(type = 'down') {
                    const particles = type === 'down' 
                        ? ['🚀', '⭐', '💫', '✨', '🌟', '🎉', '🎊', '💎', '🔥', '⚡']
                        : ['🌙', '☁️', '🌈', '🌸', '🍀', '🎈', '🎪', '🎭', '🎨', '🎵'];
                    
                    for (let i = 0; i < 15; i++) {
                        const particle = document.createElement('div');
                        particle.className = 'easter-egg-particle';
                        particle.innerHTML = particles[Math.floor(Math.random() * particles.length)];
                        particle.style.left = Math.random() * window.innerWidth + 'px';
                        particle.style.top = type === 'down' ? '0px' : window.innerHeight + 'px';
                        particle.style.fontSize = (Math.random() * 1.5 + 1) + 'rem';
                        particle.style.animationDelay = Math.random() * 2 + 's';
                        
                        document.body.appendChild(particle);
                        
                        setTimeout(() => {
                            if (particle.parentNode) {
                                particle.parentNode.removeChild(particle);
                            }
                        }, 5000);
                    }
                    
                    // 显示彩蛋消息
                    const messages = type === 'down' 
                        ? ['🎉 发现彩蛋！', '🚀 向下探索！', '✨ 惊喜不断！', '🌟 继续发现！']
                        : ['🌙 向上飞翔！', '☁️ 云端漫步！', '🌈 彩虹之路！', '🌸 美好时光！'];
                    
                    showEasterEggMessage(messages[Math.floor(Math.random() * messages.length)]);
                }
                
                // 显示彩蛋消息
                function showEasterEggMessage(message) {
                    const messageDiv = document.createElement('div');
                    messageDiv.style.cssText = `
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: linear-gradient(135deg, rgba(102, 126, 234, 0.9), rgba(118, 75, 162, 0.9));
                        color: white;
                        padding: 20px 30px;
                        border-radius: 15px;
                        font-size: 1.2rem;
                        font-weight: bold;
                        z-index: 10001;
                        backdrop-filter: blur(10px);
                        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
                        animation: messageSlideIn 0.5s ease-out;
                    `;
                    messageDiv.textContent = message;
                    
                    document.body.appendChild(messageDiv);
                    
                    setTimeout(() => {
                        if (messageDiv.parentNode) {
                            messageDiv.parentNode.removeChild(messageDiv);
                        }
                    }, 2000);
                }
                
                // 下拉刷新功能
                function handlePullRefresh() {
                    pullRefreshIndicator.classList.add('show');
                    
                    setTimeout(() => {
                        pullRefreshIndicator.classList.remove('show');
                        location.reload();
                    }, 1500);
                }
                
                // 触摸事件处理
                document.addEventListener('touchstart', function(e) {
                    startY = e.touches[0].clientY;
                    isPulling = false;
                });
                
                document.addEventListener('touchmove', function(e) {
                    currentY = e.touches[0].clientY;
                    pullDistance = currentY - startY;
                    
                    // 下拉检测
                    if (pullDistance > 100 && window.scrollY === 0 && !isPulling) {
                        isPulling = true;
                        createEasterEggParticles('down');
                        
                        // 如果下拉距离足够大，触发刷新
                        if (pullDistance > 200) {
                            handlePullRefresh();
                        }
                    }
                    
                    // 上拉检测（在页面底部）
                    if (pullDistance < -100 && 
                        window.scrollY + window.innerHeight >= document.body.scrollHeight - 10 && 
                        !isPulling) {
                        isPulling = true;
                        createEasterEggParticles('up');
                    }
                });
                
                // 键盘输入检测
                document.addEventListener('keydown', function(e) {
                    userInput += e.key.toLowerCase();
                    
                    // 清除之前的超时
                    clearTimeout(inputTimeout);
                    
                    // 检查是否输入了"menu"
                    if (userInput.includes('menu')) {
                        if (mobileMenuBtn) {
                            mobileMenuBtn.classList.add('permanent');
                            showEasterEggMessage('🎯 菜单已永久显示！');
                        }
                        userInput = '';
                    }
                    
                    // 3秒后清除输入
                    inputTimeout = setTimeout(() => {
                        userInput = '';
                    }, 3000);
                });
                
                // 鼠标滚轮事件（桌面端彩蛋）
                let wheelCount = 0;
                let wheelTimeout;
                
                document.addEventListener('wheel', function(e) {
                    wheelCount++;
                    
                    clearTimeout(wheelTimeout);
                    wheelTimeout = setTimeout(() => {
                        if (wheelCount >= 10) {
                            createEasterEggParticles(e.deltaY > 0 ? 'down' : 'up');
                            wheelCount = 0;
                        }
                    }, 1000);
                });

            }
        
        // 初始化彩蛋和下拉刷新功能
        initEasterEggsAndPullRefresh();
        
        // 底部UI功能函数 - 已移至全局函数定义
    }
    
    // 全局函数定义
        function toggleMobileMenu() {
        // 显示菜单面板
        const menuModal = document.getElementById('menuModal');
        if (menuModal) {
            menuModal.style.display = 'block';
        } else {
            // 如果菜单模态框不存在，创建一个
            createMenuModal();
            }
        }
        
        function showSettings() {

            // 显示设置面板
            const settingsModal = document.getElementById('settingsModal');
            if (settingsModal) {
                settingsModal.style.display = 'block';

            } else {
                // 如果模态框不存在，创建一个

                createSettingsModal();
            }
        }
        
        // 这些函数现在在 top_ui_functions.js 中定义
    
    // 创建设置模态框
    function createSettingsModal() {
        const modal = document.createElement('div');
        modal.id = 'settingsModal';
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
        `;
        
        modal.innerHTML = `
            <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); 
                        border-radius: 15px; 
                        padding: 30px; 
                        max-width: 500px; 
                        width: 90%; 
                        color: white;
                        border: 2px solid rgba(255, 255, 255, 0.15);
                        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h3 style="margin: 0; font-size: 1.5rem;">⚙️ 设置</h3>
                    <button onclick="closeSettingsModal()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;">×</button>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">🎨 主题模式</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button onclick="switchTheme('work')" class="theme-btn" data-theme="work" style="padding: 12px; border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.3); cursor: pointer; transition: all 0.3s ease;">
                            <div style="font-weight: 600;">极客模式</div>
                            <div style="font-size: 0.8rem; opacity: 0.8;">专注技术</div>
                        </button>
                        <button onclick="switchTheme('life')" class="theme-btn" data-theme="life" style="padding: 12px; border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.3); cursor: pointer; transition: all 0.3s ease;">
                            <div style="font-weight: 600;">生活模式</div>
                            <div style="font-size: 0.8rem; opacity: 0.8;">轻松愉悦</div>
                        </button>
                        <button onclick="switchTheme('training')" class="theme-btn" data-theme="training" style="padding: 12px; border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.3); cursor: pointer; transition: all 0.3s ease;">
                            <div style="font-weight: 600;">狂暴模式</div>
                            <div style="font-size: 0.8rem; opacity: 0.8;">激情四射</div>
                        </button>
                        <button onclick="switchTheme('emo')" class="theme-btn" data-theme="emo" style="padding: 12px; border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.3); cursor: pointer; transition: all 0.3s ease;">
                            <div style="font-weight: 600;">Emo模式</div>
                            <div style="font-size: 0.8rem; opacity: 0.8;">情感表达</div>
                        </button>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">🎵 音乐控制</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button onclick="toggleMusic()" style="padding: 12px; border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.3); cursor: pointer; transition: all 0.3s ease;">
                            <i class="fas fa-play" style="margin-right: 8px;"></i>播放/暂停
                        </button>
                        <button onclick="nextSong()" style="padding: 12px; border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.3); cursor: pointer; transition: all 0.3s ease;">
                            <i class="fas fa-forward" style="margin-right: 8px;"></i>下一首
                        </button>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 25px;">
                    <button onclick="closeSettingsModal()" style="padding: 12px 30px; border-radius: 8px; background: rgba(255, 255, 255, 0.2); color: white; border: 1px solid rgba(255, 255, 255, 0.3); cursor: pointer; transition: all 0.3s ease; font-weight: 600;">完成</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    }
    // 创建菜单模态框
    function createMenuModal() {
        const modal = document.createElement('div');
        modal.id = 'menuModal';
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
        `;
        
        modal.innerHTML = `
            <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); 
                        border-radius: 15px; 
                        padding: 30px; 
                        max-width: 600px; 
                        width: 90%; 
                        color: white;
                        border: 2px solid rgba(255, 255, 255, 0.15);
                        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h3 style="margin: 0; font-size: 1.5rem;">🧭 导航菜单</h3>
                    <button onclick="closeMenuModal()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;">×</button>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px;">
                    <button onclick="window.location.href='/'" class="menu-item" style="padding: 20px; border-radius: 12px; background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.3); transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; cursor: pointer;">
                        <i class="fas fa-home" style="font-size: 1.5rem; margin-bottom: 8px;"></i>
                        <div style="font-weight: 600;">首页</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;">返回主页</div>
                    </button>
                    <button onclick="goToCurrentModeTools()" class="menu-item" style="padding: 20px; border-radius: 12px; background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.3); transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; cursor: pointer;">
                        <i class="fas fa-tools" style="font-size: 1.5rem; margin-bottom: 8px;"></i>
                        <div style="font-weight: 600;">工具集</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;">实用工具</div>
                    </button>
                    <button onclick="showSuggestions()" class="menu-item" style="padding: 20px; border-radius: 12px; background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.3); transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; cursor: pointer;">
                        <i class="fas fa-lightbulb" style="font-size: 1.5rem; margin-bottom: 8px;"></i>
                        <div style="font-weight: 600;">我的建议</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;">功能建议</div>
                    </button>
                    <button onclick="showHiddenInfo()" class="menu-item" style="padding: 20px; border-radius: 12px; background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.3); transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; cursor: pointer;">
                        <i class="fas fa-info-circle" style="font-size: 1.5rem; margin-bottom: 8px;"></i>
                        <div style="font-weight: 600;">关于</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;">系统信息</div>
                    </button>
                    <button onclick="window.location.href='/tools/chat/'" class="menu-item" style="padding: 20px; border-radius: 12px; background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.3); transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; cursor: pointer;">
                        <i class="fas fa-comments" style="font-size: 1.5rem; margin-bottom: 8px;"></i>
                        <div style="font-weight: 600;">聊天室</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;">实时交流</div>
                    </button>
                    <button onclick="window.location.href='/tools/heart_link/'" class="menu-item" style="padding: 20px; border-radius: 12px; background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.3); transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; cursor: pointer;">
                        <i class="fas fa-heart" style="font-size: 1.5rem; margin-bottom: 8px;"></i>
                        <div style="font-weight: 600;">心链匹配</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;">寻找伙伴</div>
                    </button>
                </div>
                
                <div style="text-align: center; margin-top: 25px;">
                    <button onclick="closeMenuModal()" style="padding: 12px 30px; border-radius: 8px; background: rgba(255, 255, 255, 0.2); color: white; border: 1px solid rgba(255, 255, 255, 0.3); cursor: pointer; transition: all 0.3s ease; font-weight: 600;">关闭</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    }
    
    // 关闭设置模态框
    function closeSettingsModal() {
        const modal = document.getElementById('settingsModal');
        if (modal) {
            modal.style.display = 'none';
        }
    }
    
    // 关闭菜单模态框
    function closeMenuModal() {
        const modal = document.getElementById('menuModal');
        if (modal) {
            modal.style.display = 'none';
        }
    }
    
    // 获取CSRF Token
    function getCSRFToken() {
        const token = document.querySelector('meta[name="csrf-token"]');
        return token ? token.getAttribute('content') : '';
    }
    
    // 点击其他地方关闭下拉菜单和模态框
    document.addEventListener('click', function(event) {
        const userDropdown = document.querySelector('.top-ui-user-dropdown');
        const dropdownContent = document.getElementById('userDropdownContent');
        
        if (userDropdown && dropdownContent) {
            if (!userDropdown.contains(event.target)) {
                dropdownContent.classList.remove('show');
            }
        }
        
        // 关闭设置模态框
        const settingsModal = document.getElementById('settingsModal');
        if (settingsModal && event.target === settingsModal) {
            settingsModal.style.display = 'none';
        }
        
        // 关闭菜单模态框
        const menuModal = document.getElementById('menuModal');
        if (menuModal && event.target === menuModal) {
            menuModal.style.display = 'none';
        }
    });
        
            // 添加模态框按钮悬停效果
    document.addEventListener('mouseover', function(e) {
        if (e.target.classList.contains('menu-item') || e.target.classList.contains('theme-btn')) {
            e.target.style.transform = 'translateY(-2px)';
            e.target.style.boxShadow = '0 8px 25px rgba(255, 255, 255, 0.2)';
            e.target.style.background = 'rgba(255, 255, 255, 0.15)';
        }
    });
    
    document.addEventListener('mouseout', function(e) {
        if (e.target.classList.contains('menu-item') || e.target.classList.contains('theme-btn')) {
            e.target.style.transform = 'translateY(0)';
            e.target.style.boxShadow = 'none';
            e.target.style.background = 'rgba(255, 255, 255, 0.1)';
        }
    });
        
            // 顶部栏悬停效果
    document.addEventListener('DOMContentLoaded', function() {
        // 品牌标识悬停效果
        const brandElement = document.querySelector('.top-ui-brand');
        if (brandElement) {
            brandElement.addEventListener('mouseenter', function() {
                const hoverEffect = this.querySelector('.brand-hover-effect');
                if (hoverEffect) {
                    hoverEffect.style.left = '100%';
                }
                this.style.transform = 'scale(1.05)';
            });
            
            brandElement.addEventListener('mouseleave', function() {
                const hoverEffect = this.querySelector('.brand-hover-effect');
                if (hoverEffect) {
                    hoverEffect.style.left = '-100%';
                }
                this.style.transform = 'scale(1)';
            });
        }
        
        // 主题标识悬停效果
        const themeBadge = document.getElementById('topUiBadge');
        if (themeBadge) {
            themeBadge.addEventListener('mouseenter', function() {
                const hoverEffect = this.querySelector('.theme-hover-effect');
                if (hoverEffect) {
                    hoverEffect.style.opacity = '0.3';
                }
                this.style.transform = 'scale(1.1)';
            });
            
            themeBadge.addEventListener('mouseleave', function() {
                const hoverEffect = this.querySelector('.theme-hover-effect');
                if (hoverEffect) {
                    hoverEffect.style.opacity = '0';
                }
                this.style.transform = 'scale(1)';
            });
        }
        
        // 设置按钮悬停效果
        const settingsButton = document.querySelector('.top-ui-item[onclick*="showSettings"]');
        if (settingsButton) {
            settingsButton.addEventListener('mouseenter', function() {
                const icon = this.querySelector('i');
                const hoverEffect = this.querySelector('.button-hover-effect');
                if (icon) {
                    icon.style.animationPlayState = 'running';
                }
                if (hoverEffect) {
                    hoverEffect.style.opacity = '1';
                }
                this.style.transform = 'scale(1.1)';
            });
            
            settingsButton.addEventListener('mouseleave', function() {
                const icon = this.querySelector('i');
                const hoverEffect = this.querySelector('.button-hover-effect');
                if (icon) {
                    icon.style.animationPlayState = 'paused';
                }
                if (hoverEffect) {
                    hoverEffect.style.opacity = '0';
                }
                this.style.transform = 'scale(1)';
            });
        }
        
        // 菜单按钮悬停效果
        const menuButton = document.querySelector('.top-ui-item[onclick*="toggleMobileMenu"]');
        if (menuButton) {
            menuButton.addEventListener('mouseenter', function() {
                this.style.transform = 'scale(1.1) rotate(5deg)';
                this.style.background = 'rgba(255, 255, 255, 0.2)';
            });
            
            menuButton.addEventListener('mouseleave', function() {
                this.style.transform = 'scale(1) rotate(0deg)';
                this.style.background = 'rgba(255, 255, 255, 0.1)';
            });
        }
        
        // 隐藏按钮悬停效果
        const hideButton = document.querySelector('.top-ui-item[onclick*="hideTopUI"]');
        if (hideButton) {
            hideButton.addEventListener('mouseenter', function() {
                this.style.transform = 'scale(1.1)';
                this.style.background = 'rgba(255, 255, 255, 0.2)';
                const icon = this.querySelector('i');
                if (icon) {
                    icon.style.animation = 'pulse 1s ease-in-out infinite';
                }
            });
            
            hideButton.addEventListener('mouseleave', function() {
                this.style.transform = 'scale(1)';
                this.style.background = 'rgba(255, 255, 255, 0.1)';
                const icon = this.querySelector('i');
                if (icon) {
                    icon.style.animation = 'none';
                }
            });
        }
    });
        
            // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {

        // 添加点击外部关闭菜单的功能
        document.addEventListener('click', function(event) {
            const dropdownContent = document.getElementById('userDropdownContent');
            const userButton = document.querySelector('.top-ui-user');
            
            if (dropdownContent && userButton) {
                // 如果点击的不是用户按钮或其子元素，且菜单是显示的，则关闭菜单
                if (!userButton.contains(event.target) && 
                    dropdownContent.style.display === 'block') {
                    toggleUserDropdown();
                }
            }
        });
        setTimeout(initTopUIControl, 100);
        
        // 检查全局隐藏状态
        const isTopUIBarHidden = localStorage.getItem('topUIBarHidden') === 'true';
        const topUiBar = document.getElementById('topUiBar');
        if (topUiBar) {
            if (isTopUIBarHidden) {
                // 如果全局设置为隐藏，则隐藏顶部栏
                topUiBar.style.display = 'none';
                topUiBar.style.visibility = 'hidden';
                topUiBar.style.opacity = '0';
                topUiBar.style.transform = 'translateY(-100%)';
                topUiBar.style.pointerEvents = 'none';

                // 显示恢复按钮
                showRestoreButton();
            } else {
                // 否则显示顶部栏
                topUiBar.style.display = 'flex';
                topUiBar.style.visibility = 'visible';
                topUiBar.style.opacity = '1';
                topUiBar.style.transform = 'translateY(0)';
                topUiBar.style.pointerEvents = 'auto';

            }
        } else {
            console.error('❌ 找不到顶部菜单元素');
        }
    });
    
    // 页面完全加载后检查状态
    window.addEventListener('load', function() {
        const topUiBar = document.getElementById('topUiBar');
        if (topUiBar) {
            // 不要强制显示，让隐藏功能正常工作

        }
    });
        


        
    })();
    </script>
    
    <!-- 顶部栏功能JavaScript -->
    <script src="/static/js/top_ui_functions.js"></script>
    
    <!-- 主题管理器 -->
    <script src="/static/js/theme_manager.js"></script>
    
    <!-- 强制修复用户菜单脚本 -->
    <script>
    // 强制修复用户菜单问题

    // 等待页面完全加载
    window.addEventListener('load', function() {

        // 强制修复用户菜单
        forceFixUserMenu();
        

    });
    
    // 强制修复用户菜单
    function forceFixUserMenu() {

        const dropdownContent = document.getElementById('userDropdownContent');
        const userButton = document.querySelector('.top-ui-user');
        
        if (!dropdownContent) {
            console.error('❌ 用户下拉菜单元素未找到');
            return;
        }
        
        if (!userButton) {
            console.error('❌ 用户头像按钮未找到');
            return;
        }

        // 强制设置初始状态
        dropdownContent.style.display = 'none';
        dropdownContent.style.opacity = '0';
        dropdownContent.style.transform = 'scale(0.95) translateY(-10px)';
        dropdownContent.classList.remove('show');
        
        // 移除可能冲突的事件监听器
        const newUserButton = userButton.cloneNode(true);
        userButton.parentNode.replaceChild(newUserButton, userButton);
        
        // 重新绑定点击事件
        newUserButton.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();

            forceToggleUserDropdown();
        });

    }
    
    // 强制切换用户菜单
    function forceToggleUserDropdown() {

        const dropdownContent = document.getElementById('userDropdownContent');
        const chevronIcon = document.querySelector('.top-ui-user .fa-chevron-down');
        
        if (!dropdownContent) {
            console.error('❌ 用户下拉菜单元素未找到');
            return;
        }
        
        // 检查当前显示状态
        const isVisible = dropdownContent.style.display === 'block' || 
                         dropdownContent.style.opacity === '1' ||
                         dropdownContent.classList.contains('show');

        if (isVisible) {
            // 隐藏菜单
            dropdownContent.style.display = 'none';
            dropdownContent.style.opacity = '0';
            dropdownContent.style.transform = 'scale(0.95) translateY(-10px)';
            dropdownContent.classList.remove('show');
            
            if (chevronIcon) {
                chevronIcon.style.transform = 'rotate(0deg)';
            }

        } else {
            // 显示菜单
            dropdownContent.style.display = 'block';
            dropdownContent.style.opacity = '1';
            dropdownContent.style.transform = 'scale(1) translateY(0)';
            dropdownContent.classList.add('show');
            
            if (chevronIcon) {
                chevronIcon.style.transform = 'rotate(180deg)';
            }

        }
    }
    
    // 添加调试按钮

    
    // 导出函数到全局作用域
    window.forceToggleUserDropdown = forceToggleUserDropdown;

    </script>
    
    <!-- 用户认证相关JavaScript -->
    <script src="/static/js/auth.js"></script>
    <script src="/static/js/feature-recommendation.js"></script>
    <script src="/static/js/session_manager.js"></script>
    
    
    
    <!-- 全局分享按钮 -->
    <!-- 全局分享按钮组件 -->
<div class="share-button-container" id="shareButtonContainer" style="display: block;">
    <div class="share-button-wrapper">
        <button class="share-button" id="shareButton" onclick="toggleShareMenu()">
            <i class="fas fa-share-alt"></i>
            <span class="share-text">分享</span>
        </button>
        
        <div class="share-menu" id="shareMenu">
            <div class="share-menu-header">
                <h4>分享到</h4>
                <button class="close-share-menu" onclick="toggleShareMenu()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="share-options">
                <button class="share-option" onclick="shareTo('wechat')">
                    <i class="fab fa-weixin"></i>
                    <span>微信</span>
                </button>
                
                <button class="share-option" onclick="shareTo('weibo')">
                    <i class="fab fa-weibo"></i>
                    <span>微博</span>
                </button>
                
                <button class="share-option" onclick="shareTo('douyin')">
                    <i class="fab fa-tiktok"></i>
                    <span>抖音</span>
                </button>
                
                <button class="share-option" onclick="shareTo('qq')">
                    <i class="fab fa-qq"></i>
                    <span>QQ</span>
                </button>
                
                <button class="share-option" onclick="shareTo('copy')">
                    <i class="fas fa-link"></i>
                    <span>复制链接</span>
                </button>
                
                <button class="share-option" onclick="shareTo('qrcode')">
                    <i class="fas fa-qrcode"></i>
                    <span>二维码</span>
                </button>
            </div>
        </div>
    </div>
</div>
<!-- 二维码弹窗 -->
<div class="qrcode-modal" id="qrcodeModal" style="display: none;">
    <div class="qrcode-content">
        <div class="qrcode-header">
            <h4>扫描二维码分享</h4>
            <button class="close-qrcode" onclick="closeQRCode()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="qrcode-body">
            <div id="qrcodeContainer"></div>
            <p class="qrcode-tip">使用微信或支付宝扫描二维码</p>
        </div>
    </div>
</div>
<style>
.share-button-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 9999;
    pointer-events: auto;
}
.share-button-wrapper {
    position: relative;
}
.share-button {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 50px;
    padding: 12px 20px;
    font-size: 14px;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    pointer-events: auto;
    z-index: 10000;
}
.share-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
}
.share-button i {
    font-size: 16px;
}
.share-menu {
    position: absolute;
    bottom: 100%;
    right: 0;
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    margin-bottom: 10px;
    min-width: 200px;
    opacity: 0;
    visibility: hidden;
    transform: translateY(10px);
    transition: all 0.3s ease;
}
.share-menu.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}
.share-menu-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 1px solid #f0f0f0;
}
.share-menu-header h4 {
    margin: 0;
    font-size: 16px;
    color: #333;
}
.close-share-menu {
    background: none;
    border: none;
    color: #666;
    cursor: pointer;
    padding: 5px;
    border-radius: 4px;
    transition: background-color 0.2s ease;
}
.close-share-menu:hover {
    background-color: #f5f5f5;
}
.share-options {
    padding: 10px;
}
.share-option {
    display: flex;
    align-items: center;
    gap: 12px;
    width: 100%;
    padding: 12px 15px;
    border: none;
    background: none;
    cursor: pointer;
    border-radius: 8px;
    transition: background-color 0.2s ease;
    color: #333;
    font-size: 14px;
}
.share-option:hover {
    background-color: #f8f9fa;
}
.share-option i {
    font-size: 18px;
    width: 20px;
    text-align: center;
}
.share-option:nth-child(1) i { color: #07C160; } /* 微信 */
.share-option:nth-child(2) i { color: #E6162D; } /* 微博 */
.share-option:nth-child(3) i { color: #000000; } /* 抖音 */
.share-option:nth-child(4) i { color: #12B7F5; } /* QQ */
.share-option:nth-child(5) i { color: #007bff; } /* 复制链接 */
.share-option:nth-child(6) i { color: #28a745; } /* 二维码 */
.qrcode-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
}
.qrcode-content {
    background: white;
    border-radius: 16px;
    padding: 30px;
    max-width: 400px;
    width: 90%;
    text-align: center;
}
.qrcode-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}
.qrcode-header h4 {
    margin: 0;
    font-size: 18px;
    color: #333;
}
.close-qrcode {
    background: none;
    border: none;
    color: #666;
    cursor: pointer;
    padding: 5px;
    border-radius: 4px;
    transition: background-color 0.2s ease;
}
.close-qrcode:hover {
    background-color: #f5f5f5;
}
.qrcode-body {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
}
#qrcodeContainer {
    width: 200px;
    height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f8f9fa;
    border-radius: 8px;
}
.qrcode-tip {
    margin: 0;
    color: #666;
    font-size: 14px;
}
/* 移动端适配 */
@media (max-width: 768px) {
    .share-button-container {
        bottom: 15px;
        right: 15px;
    }
    
    .share-button {
        padding: 10px 16px;
        font-size: 13px;
    }
    
    .share-menu {
        min-width: 180px;
        right: -10px;
    }
    
    .qrcode-content {
        padding: 20px;
        margin: 20px;
    }
    
    #qrcodeContainer {
        width: 180px;
        height: 180px;
    }
}
/* 深色主题适配 */
@media (prefers-color-scheme: dark) {
    .share-menu {
        background: #2d3748;
        border: 1px solid #4a5568;
    }
    
    .share-menu-header {
        border-bottom-color: #4a5568;
    }
    
    .share-menu-header h4 {
        color: #e2e8f0;
    }
    
    .share-option {
        color: #e2e8f0;
    }
    
    .share-option:hover {
        background-color: #4a5568;
    }
    
    .qrcode-content {
        background: #2d3748;
        color: #e2e8f0;
    }
    
    .qrcode-header h4 {
        color: #e2e8f0;
    }
    
    #qrcodeContainer {
        background: #4a5568;
    }
}
</style>
<script>
// 分享功能JavaScript
let shareManager = null;
// 初始化分享管理器
function initShareManager() {
    if (typeof ShareManager !== 'undefined') {
        shareManager = new ShareManager();
    }
}
// 切换分享菜单
function toggleShareMenu() {
    const menu = document.getElementById('shareMenu');
    if (menu) {
        menu.classList.toggle('show');
    }
}
// 分享到指定平台
function shareTo(platform) {
    const currentUrl = window.location.href;
    const title = document.title;
    const description = getMetaDescription();
    
    if (shareManager) {
        shareManager.shareTo(platform, currentUrl, title, description);
    } else {
        // 备用分享逻辑
        fallbackShare(platform, currentUrl, title, description);
    }
    
    // 关闭分享菜单
    toggleShareMenu();
}
// 获取页面描述
function getMetaDescription() {
    const metaDesc = document.querySelector('meta[name="description"]');
    return metaDesc ? metaDesc.getAttribute('content') : document.title;
}
// 备用分享逻辑
function fallbackShare(platform, url, title, description) {
    const encodedUrl = encodeURIComponent(url);
    const encodedTitle = encodeURIComponent(title);
    const encodedDesc = encodeURIComponent(description);
    
    switch (platform) {
        case 'wechat':
        case 'qrcode':
            showQRCode(url);
            break;
        case 'weibo':
            window.open(`https://service.weibo.com/share/share.php?url=${encodedUrl}&title=${encodedTitle}`, '_blank');
            break;
        case 'douyin':
            window.open(`https://www.douyin.com/share?url=${encodedUrl}&title=${encodedTitle}`, '_blank');
            break;
        case 'qq':
            window.open(`https://connect.qq.com/widget/shareqq/index.html?url=${encodedUrl}&title=${encodedTitle}&desc=${encodedDesc}`, '_blank');
            break;
        case 'copy':
            copyToClipboard(url);
            break;
    }
}
// 显示二维码
function showQRCode(url) {
    const modal = document.getElementById('qrcodeModal');
    const container = document.getElementById('qrcodeContainer');
    
    if (modal && container) {
        // 生成二维码
        generateQRCode(url, container);
        modal.style.display = 'flex';
    }
}
// 关闭二维码弹窗
function closeQRCode() {
    const modal = document.getElementById('qrcodeModal');
    if (modal) {
        modal.style.display = 'none';
    }
}
// 生成二维码
function generateQRCode(text, container) {
    // 使用QRCode.js库生成二维码
    if (typeof QRCode !== 'undefined') {
        container.innerHTML = '';
        new QRCode(container, {
            text: text,
            width: 180,
            height: 180,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H
        });
    } else {
        // 备用方案：使用在线API
        container.innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encodeURIComponent(text)}" alt="QR Code">`;
    }
}
// 复制到剪贴板
function copyToClipboard(text) {
    if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => {
            showToast('链接已复制到剪贴板');
        }).catch(() => {
            fallbackCopyToClipboard(text);
        });
    } else {
        fallbackCopyToClipboard(text);
    }
}
// 备用复制方法
function fallbackCopyToClipboard(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        document.execCommand('copy');
        showToast('链接已复制到剪贴板');
    } catch (err) {
        showToast('复制失败，请手动复制');
    }
    
    document.body.removeChild(textArea);
}
// 显示提示消息
function showToast(message, duration = 2000) {
    // 创建toast元素
    const toast = document.createElement('div');
    toast.className = 'share-toast';
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        font-size: 14px;
        z-index: 3000;
        opacity: 0;
        transition: opacity 0.3s ease;
    `;
    
    document.body.appendChild(toast);
    
    // 显示动画
    setTimeout(() => {
        toast.style.opacity = '1';
    }, 100);
    
    // 自动隐藏
    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => {
            if (document.body.contains(toast)) {
                document.body.removeChild(toast);
            }
        }, 300);
    }, duration);
}
// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    initShareManager();
    
    // 点击二维码弹窗背景关闭
    const qrcodeModal = document.getElementById('qrcodeModal');
    if (qrcodeModal) {
        qrcodeModal.addEventListener('click', function(e) {
            if (e.target === qrcodeModal) {
                closeQRCode();
            }
        });
    }
    
    // ESC键关闭弹窗
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const shareMenu = document.getElementById('shareMenu');
            const qrcodeModal = document.getElementById('qrcodeModal');
            
            if (shareMenu && shareMenu.classList.contains('show')) {
                toggleShareMenu();
            }
            
            if (qrcodeModal && qrcodeModal.style.display === 'flex') {
                closeQRCode();
            }
        }
    });
});
// 显示分享按钮（可选：根据页面内容决定是否显示）
function showShareButton() {
    const container = document.getElementById('shareButtonContainer');
    if (container) {
        container.style.display = 'block';
    }
}
// 隐藏分享按钮
function hideShareButton() {
    const container = document.getElementById('shareButtonContainer');
    if (container) {
        container.style.display = 'none';
    }
}
</script>

    <script>
    // 全局隐藏顶部栏功能
    function hideTopUI() {
        // 保存隐藏状态到localStorage，实现全局隐藏
        localStorage.setItem('topUIBarHidden', 'true');
        
        const topUiBar = document.getElementById('topUiBar');
        if (topUiBar) {
            // 完全隐藏顶部栏
            topUiBar.style.display = 'none';
            topUiBar.style.visibility = 'hidden';
            topUiBar.style.opacity = '0';
            topUiBar.style.transform = 'translateY(-100%)';
            topUiBar.style.pointerEvents = 'none';
            
            // 显示恢复按钮
            showRestoreButton();

        }
    }
    
    // 显示恢复按钮
    function showRestoreButton() {
        // 移除已存在的恢复按钮
        const existingRestore = document.getElementById('restoreTopUIButton');
        if (existingRestore) {
            existingRestore.remove();
        }
        
        // 创建恢复按钮
        const restoreButton = document.createElement('div');
        restoreButton.id = 'restoreTopUIButton';
        restoreButton.innerHTML = '<i class="fas fa-eye"></i>';
        restoreButton.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 9999;
            transition: all 0.3s ease;
            opacity: 0;
            transform: scale(0.8);
        `;
        
        restoreButton.onclick = function() {
            restoreTopUI();
        };
        
        restoreButton.onmouseenter = function() {
            this.style.transform = 'scale(1.1)';
            this.style.boxShadow = '0 6px 20px rgba(0, 0, 0, 0.4)';
        };
        
        restoreButton.onmouseleave = function() {
            this.style.transform = 'scale(1)';
            this.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.3)';
        };
        
        document.body.appendChild(restoreButton);
        
        // 显示动画
        setTimeout(() => {
            restoreButton.style.opacity = '1';
            restoreButton.style.transform = 'scale(1)';
        }, 100);
    }
    
    // 恢复顶部栏
    function restoreTopUI() {
        // 清除localStorage中的隐藏状态
        localStorage.removeItem('topUIBarHidden');
        
        const topUiBar = document.getElementById('topUiBar');
        const restoreButton = document.getElementById('restoreTopUIButton');
        
        if (topUiBar) {
            // 完全恢复顶部栏
            topUiBar.style.display = 'flex';
            topUiBar.style.visibility = 'visible';
            topUiBar.style.opacity = '1';
            topUiBar.style.transform = 'translateY(0)';
            topUiBar.style.pointerEvents = 'auto';

        }
        
        if (restoreButton) {
            restoreButton.style.opacity = '0';
            restoreButton.style.transform = 'scale(0.8)';
            setTimeout(() => {
                if (document.body.contains(restoreButton)) {
                    restoreButton.remove();
                }
            }, 300);
        }
    }
    
    // 从菜单调起分享功能
    function openShareFromMenu() {
        // 关闭用户菜单
        const userDropdown = document.querySelector('.user-dropdown');
        if (userDropdown) {
            userDropdown.classList.remove('show');
        }
        
        // 直接显示分享菜单
        if (typeof toggleShareMenu === 'function') {
            toggleShareMenu();
        } else {
            // 如果分享功能未加载，显示备用分享选项
            showFallbackShareOptions();
        }
    }
    
    // 备用分享选项
    function showFallbackShareOptions() {
        const currentUrl = window.location.href;
        const title = document.title;
        
        const shareModal = document.createElement('div');
        shareModal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        `;
        
        const shareContent = document.createElement('div');
        shareContent.style.cssText = `
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        `;
        
        shareContent.innerHTML = `
            <h3 style="margin: 0 0 20px 0; color: #333; font-size: 18px;">分享当前页面</h3>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                <button onclick="shareToPlatform('wechat')" style="
                    background: #07C160;
                    color: white;
                    border: none;
                    padding: 12px;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 14px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 8px;
                ">
                    <i class="fab fa-weixin"></i>
                    微信
                </button>
                <button onclick="shareToPlatform('weibo')" style="
                    background: #E6162D;
                    color: white;
                    border: none;
                    padding: 12px;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 14px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 8px;
                ">
                    <i class="fab fa-weibo"></i>
                    微博
                </button>
                <button onclick="shareToPlatform('qq')" style="
                    background: #12B7F5;
                    color: white;
                    border: none;
                    padding: 12px;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 14px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 8px;
                ">
                    <i class="fab fa-qq"></i>
                    QQ
                </button>
                <button onclick="shareToPlatform('copy')" style="
                    background: #007bff;
                    color: white;
                    border: none;
                    padding: 12px;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 14px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 8px;
                ">
                    <i class="fas fa-link"></i>
                    复制链接
                </button>
            </div>
            <button onclick="closeShareModal()" style="
                background: #6c757d;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
            ">关闭</button>
        `;
        
        shareModal.appendChild(shareContent);
        document.body.appendChild(shareModal);
        
        // 点击背景关闭
        shareModal.onclick = function(e) {
            if (e.target === shareModal) {
                closeShareModal();
            }
        };
    }
    
    // 分享到指定平台
    function shareToPlatform(platform) {
        const currentUrl = window.location.href;
        const title = document.title;
        const encodedUrl = encodeURIComponent(currentUrl);
        const encodedTitle = encodeURIComponent(title);
        
        switch (platform) {
            case 'wechat':
                // 显示二维码
                showQRCodeForShare(currentUrl);
                break;
            case 'weibo':
                window.open(`https://service.weibo.com/share/share.php?url=${encodedUrl}&title=${encodedTitle}`, '_blank');
                closeShareModal();
                break;
            case 'qq':
                window.open(`https://connect.qq.com/widget/shareqq/index.html?url=${encodedUrl}&title=${encodedTitle}`, '_blank');
                closeShareModal();
                break;
            case 'copy':
                copyToClipboard(currentUrl);
                closeShareModal();
                break;
        }
    }
    
    // 显示分享二维码
    function showQRCodeForShare(url) {
        const qrModal = document.createElement('div');
        qrModal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        `;
        
        const qrContent = document.createElement('div');
        qrContent.style.cssText = `
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        `;
        
        qrContent.innerHTML = `
            <h3 style="margin: 0 0 20px 0; color: #333; font-size: 18px;">扫码分享</h3>
            <div style="
                width: 200px;
                height: 200px;
                margin: 0 auto 20px;
                background: #f8f9fa;
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 14px;
                color: #666;
            ">
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encodeURIComponent(url)}" alt="QR Code" style="max-width: 100%; height: auto;">
            </div>
            <p style="margin: 0 0 20px 0; color: #666; font-size: 14px;">使用微信或支付宝扫描二维码</p>
            <button onclick="closeQRModal()" style="
                background: #6c757d;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
            ">关闭</button>
        `;
        
        qrModal.appendChild(qrContent);
        document.body.appendChild(qrModal);
        
        // 点击背景关闭
        qrModal.onclick = function(e) {
            if (e.target === qrModal) {
                closeQRModal();
            }
        };
    }
    
    // 关闭分享模态框
    function closeShareModal() {
        const shareModal = document.querySelector('div[style*="z-index: 2000"]');
        if (shareModal) {
            shareModal.remove();
        }
    }
    
    // 关闭二维码模态框
    function closeQRModal() {
        const qrModal = document.querySelector('div[style*="z-index: 3000"]');
        if (qrModal) {
            qrModal.remove();
        }
    }
    
    // 复制到剪贴板
    function copyToClipboard(text) {
        if (navigator.clipboard) {
            navigator.clipboard.writeText(text).then(() => {
                showShareToast('链接已复制到剪贴板');
            }).catch(() => {
                fallbackCopyToClipboard(text);
            });
        } else {
            fallbackCopyToClipboard(text);
        }
    }
    
    // 备用复制方法
    function fallbackCopyToClipboard(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
            document.execCommand('copy');
            showShareToast('链接已复制到剪贴板');
        } catch (err) {
            showShareToast('复制失败，请手动复制');
        }
        
        document.body.removeChild(textArea);
    }
    
    // 显示分享提示消息
    function showShareToast(message, duration = 2000) {
        const toast = document.createElement('div');
        toast.textContent = message;
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 14px;
            z-index: 4000;
            opacity: 0;
            transition: opacity 0.3s ease;
        `;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.opacity = '1';
        }, 100);
        
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => {
                if (document.body.contains(toast)) {
                    document.body.removeChild(toast);
                }
            }, 300);
        }, duration);
    }
    </script>
</body>
</html>